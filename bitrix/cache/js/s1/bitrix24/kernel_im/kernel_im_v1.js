; /* /bitrix/js/im/common.min.js?1557756404339421*/
; /* /bitrix/js/im/window.min.js?155775640417163*/
; /* /bitrix/js/im/im.js?1557756405806595*/
; /* /bitrix/js/im/v1/call/simple_vad.min.js?15577564042434*/
; /* /bitrix/js/im/v1/call/controller.min.js?155775640421082*/
; /* /bitrix/js/im/v1/call/engine.min.js?15577564046362*/
; /* /bitrix/js/im/v1/call/hardware_dialog.min.js?15577564041614*/
; /* /bitrix/js/im/v1/call/abstract_call.min.js?15577564042925*/
; /* /bitrix/js/im/v1/call/plain_call.min.js?155775640431680*/
; /* /bitrix/js/im/v1/call/voximplant_call.min.js?155775640420147*/
; /* /bitrix/js/im/v1/call/util.min.js?15577564042668*/
; /* /bitrix/js/im/v1/call/view.min.js?155775640438288*/
; /* /bitrix/js/im/v1/call/notification.min.js?15577564046006*/
; /* /bitrix/js/im/v1/call/invite_popup.min.js?15577564048105*/
; /* /bitrix/js/im/v1/call/floating_video.min.js?15577564048584*/
; /* /bitrix/js/pull/protobuf/protobuf.min.min.js?155775644220692*/
; /* /bitrix/js/pull/protobuf/model.min.js?155775644213978*/
; /* /bitrix/js/pull/client/pull.client.min.js?155775644239145*/

; /* Start:"a:4:{s:4:"full";s:44:"/bitrix/js/im/common.min.js?1557756404339421";s:6:"source";s:23:"/bitrix/js/im/common.js";s:3:"min";s:27:"/bitrix/js/im/common.min.js";s:3:"map";s:27:"/bitrix/js/im/common.map.js";}"*/
(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;var t=function(){this.BXIM={};this.sendBotCommand=false;this.sendBotCommandBlock={};this.tryCheckConnect={}};t.prototype.setBxIm=function(e){this.BXIM=e};t.prototype.isPage=function(){return typeof s.MessengerWindow!="undefined"&&!(this.BXIM.context=="POPUP-FULLSCREEN"&&s.browser.IsMobile())};t.prototype.isDesktop=function(){return typeof s.desktop!="undefined"&&s.desktop.apiReady};t.prototype.isSliderEnable=function(){return typeof s.SidePanel!=="undefined"};t.prototype.isSliderSupport=function(){return this.isSliderEnable()&&(!this.isDesktop()||this.isDesktop()&&s.desktop.enableInVersion(44))};t.prototype.isSliderBindingsEnable=function(){return this.isSliderSupport()&&typeof s.SidePanel.Instance.isAnchorBinding!=="undefined"};t.prototype.isMobile=function(){return this.BXIM.mobileVersion};t.prototype.isMobileNative=function(){return false};t.prototype.isLinesOperator=function(){return this.BXIM.messenger.openlines&&this.BXIM.messenger.openlines.queue&&this.BXIM.messenger.openlines.queue.length>0};t.prototype.isBot=function(e){return typeof this.BXIM.messenger.bot[e]!="undefined"};t.prototype.isBirthday=function(e){var s=new Date;var t=("0"+s.getDate().toString()).substr(-2)+"-"+("0"+(s.getMonth()+1).toString()).substr(-2);return e==t};t.prototype.getDebugInfo=function(){return{context:this.BXIM.context,design:this.BXIM.design,isDesktop:this.isDesktop()?"Y":"N",isPage:this.isPage()?"Y":"N",isMobile:this.isMobile()?"Y":"N",vInitedCall:s.localStorage.get("vInitedCall")?"Y":"N",desktopStatus:this.BXIM.desktopStatus?"Y":"N",callInit:this.BXIM.webrtc.callInit?"Y":"N",callActive:this.BXIM.webrtc.callActive?"Y":"N",appVersion:navigator.appVersion}};t.prototype.checkInternetConnection=function(e,t,r,i){if(typeof e!="function"){e=function(){if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("online",false)}}}if(typeof t!="function")t=function(){};if(typeof r!="number")r=1;if(!i&&r>1)i=+new Date;if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}s.ajax({url:"//www.bitrixsoft.com/200.ok."+ +new Date,method:"GET",dataType:"html",skipAuthCheck:true,skipBxHeader:true,timeout:1,onsuccess:function(a){if(a=="OK"){console.log("Checking internet connection... success!");delete s.MessengerCommon.tryCheckConnect[i];e()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("offline")}console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}},onfailure:function(){console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}});return true};t.prototype.pinDialog=function(e,t){this.recentListElementPin(e,t);s.rest.callMethod("im.recent.pin",{DIALOG_ID:e,ACTION:t?"Y":"N"})};t.prototype.muteMessageChat=function(e,t,r){var i=0;if(e.toString().substr(0,4)=="chat"){i=e.toString().substr(4);if(!this.BXIM.messenger.chat[i])return false}else{i=this.BXIM.messenger.userChat[e];if(!i)return false}r=r!=false;if(!this.BXIM.messenger.userChatBlockStatus[i])this.BXIM.messenger.userChatBlockStatus[i]={};if(typeof t=="undefined"){if(typeof this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=="undefined"){t=true}else{t=!this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]}}else{t=Boolean(t)}this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=t;this.BXIM.messenger.chat[i].mute_list[this.BXIM.userId]=t;this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();var a=this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]?"Y":"N";if(r){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.chat.mute",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+i),data:{timMuteAction:a}}),method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:i,MUTE:a,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}};t.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};t.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};t.prototype.isScrollMax=function(s,t){if(!s)return true;t=typeof t=="number"?t:0;if(this.isMobile()){var r=e.orientation==0?screen.height-125:screen.width-113;return document.body.scrollHeight-r-r/2<=s.scrollTop}else{return s.scrollHeight-s.offsetHeight-t<=s.scrollTop}};t.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};t.prototype.enableScroll=function(e,t,r){if(!e)return false;if(this.BXIM.messenger.isBodyScroll)return false;r=r!==false;t=400;var i=this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]?s("im-message-"+this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]):null;if(i){var a=i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling?i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling:i.parentNode.parentNode.parentNode.parentNode.parentNode;var n=this.isElementVisibleOnScreen(a,e,true);if(!n.top){s.scrollToNode(i.parentNode.parentNode.parentNode.parentNode.parentNode);return false}}return r&&this.isScrollMax(e,t)};t.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};t.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};t.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var a=i.top>=t;var n=i.bottom>t;if(r){return{top:a,bottom:n,coords:i}}else{return a||n}};t.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.Utils.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var a=i+s.clientHeight;var n=r.top>=0&&r.top<a;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{result:n||o,top:n,bottom:o,coords:r}}else{return n||o}};t.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.Utils.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};t.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else if(e=="RECENT_OL_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};t.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}if(!s.type.isDate(e)){if(typeof e=="string"){e=new Date(e)}console.log(e,t);console.trace()}return s.Main.Date.format(t,Math.round(e.getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),Math.round((new Date).getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),true)};t.prototype.getNowDate=function(e){var s=new Date;if(e===true){s=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0)}return s};t.prototype.formatUrl=function(e){if(this.isMobile()&&this.BXIM.webComponent&&currentDomain){if(e&&e.indexOf("/")===0){e=currentDomain+e;return encodeURI(e)}}return e};t.prototype.isBlankAvatar=function(e){return e==""||e.toString().indexOf(this.BXIM.pathToBlankImage)>=0};t.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};t.prototype.hideErrorImage=function(e,t){if(t){s.remove(e.parentNode);return true}var r=e.src;if(e.parentNode&&e.parentNode.parentNode){e.parentNode.parentNode.className="";e.parentNode.parentNode.innerHTML='<a href="'+r+'" target="_blank">'+r+"</a>"}return true};t.prototype.prepareText=function(e,t,r,i,a,n){var o=e;t=t==true;r=r==true;i=i==true;a=a?a:false;o=s.util.trim(o);if(o.indexOf("/me")==0){o=o.substr(4);o="<i>"+o+"</i>"}else if(o.indexOf("/loud")==0){o=o.substr(6);o="<b>"+o+"</b>"}var l="&gt;&gt;";if(r&&o.indexOf(l)>=0){var h=false;var m=o.split("<br />");for(var g=0;g<m.length;g++){if(m[g].substring(0,l.length)==l){m[g]=m[g].replace(l,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++g<m.length&&m[g].substring(0,l.length)==l){m[g]=m[g].replace(l,"")}m[g-1]+="</div></div>";h=true}}o=m.join("<br />")}if(t){o=s.util.htmlspecialchars(o)}o=this.decodeBbCode(o,r);if(r){o=o.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i,a){return(a>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"});o=o.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"})}if(t){o=o.replace(/\n/gi,"<br />")}o=o.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){var I=false;o=o.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,r,i){if(!r.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){I=true;return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{I=true;var a=typeof this.BXIM.messenger.getChatId!="undefined"?this.BXIM.messenger.getChatId():this.BXIM.messenger.currentTab;return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+t+' target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" data-viewer="null" data-viewer-group-by="'+a+'" data-title="'+s.util.jsencode(r)+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span>'}});if(I){o=o.replace(/<\/span>(\n?)<br(\s\/?)>/gi,"</span>").replace(/<br(\s\/?)>(\n?)<br(\s\/?)>(\n?)<span/gi,"<br /><span")}}if(a){o=o.replace(new RegExp("("+a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(this.BXIM.settings.enableBigSmile){var p=false;o=o.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,function e(s,t,r,i,a,n){p=true;return t+parseInt(r,10)*2+i+parseInt(a,10)*2+n});if(n&&p){n.oneSmileInMessage=true}}if(o.substr(-6)=="<br />"){o=o.substr(0,o.length-6)}o=o.replace(/<br><br \/>/gi,"<br />");o=o.replace(/<br \/><br>/gi,"<br />");return o};t.prototype.trimText=function(e){return s.util.trim(e)};t.prototype.purifyText=function(e,t){if(!e){return""}e=e.toString();e=this.trimText(e);if(e.indexOf("/me")==0){e=e.substr(4)}else if(e.indexOf("/loud")==0){e=e.substr(6)}if(e.substr(-6)=="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[[buis]\](.*?)\[\/[buis]\]/gi,"$1");e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gi,"$1");e=e.replace(/\[url\](.*?)\[\/url\]/gi,"$1");e=e.replace(/\[RATING=([1-5]{1})\]/gi,function(e,t){return"["+s.message("IM_F_RATING")+"] "});e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t){return"["+s.message("IM_F_ATTACH")+"] "});e=e.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,"$2");e=e.replace(/\[CHAT=([0-9]{1,})\](.*?)\[\/CHAT\]/gi,"$2");e=e.replace(/\[SEND=([0-9]{1,})\](.*?)\[\/SEND\]/gi,"$2");e=e.replace(/\[PUT=([0-9]{1,})\](.*?)\[\/PUT\]/gi,"$2");e=e.replace(/\[CALL=([0-9]{1,})\](.*?)\[\/CALL\]/gi,"$2");e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,"$2");e=e.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");e=e.replace(/<span.*?title="([^"]*)".*?>.*?<\/span>/gi,"($1)");e=e.replace(/<img.*?title="([^"]*)".*?>/gi,"($1)");e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t,r){return t==1e4?"":"["+s.message("IM_F_ATTACH")+"] "});e=e.replace(/<s>([^"]*)<\/s>/gi," ");e=e.replace(/\[s\]([^"]*)\[\/s\]/gi," ");e=e.replace(/\[icon\=([^\]]*)\]/gi,function(e){var t=e.match(/title\=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.indexOf("width=")>-1){t=t.substr(0,t.indexOf("width="))}if(t.indexOf("height=")>-1){t=t.substr(0,t.indexOf("height="))}if(t.indexOf("size=")>-1){t=t.substr(0,t.indexOf("size="))}if(t){t="("+this.trimText(t)+")"}}else{t="("+s.message("IM_M_ICON")+")"}return t}.bind(this));e=e.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ");e=this.trimText(e);if(e.length<=0){if(t&&t.FILE_ID&&t.FILE_ID.length>0){e="["+s.message("IM_F_FILE")+"]"}else if(t&&t.ATTACH&&t.ATTACH.length>0){e="["+s.message("IM_F_ATTACH")+"]"}else{e=s.message("IM_M_DELETED")}}return e};t.prototype.decodeBbCode=function(e,t,r){t=typeof t?false:t;var i=[];e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gi,function(e,s){var t=i.length;i.push(s);return"####REPLACEMENT_MARK_"+t+"####"});e=e.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>');e=e.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>');e=e.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,s.delegate(function(e,s,r){var i="";if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat")return r;s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax '+(s==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+r+"</span>";else i=r;return i},this));e=e.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,s,r,i){var a="";r=parseInt(r);if(!t&&i&&r>0&&typeof BXIM!="undefined"){if(s){a='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+r+'">'+i+"</span>"}else{a='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+r+'">'+i+"</span>"}}else{a=i}return a});e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,s,r){var i="";s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+r+"</span>";else i=r;return i});e=e.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,r,i){var a="";i=i?i:r;r=r?r:i;if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);a='<span class="bx-messenger-command" data-entity="send" title="'+s.message("IM_BB_SEND")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a});e=e.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,r,i){var a="";i=i?i:r;r=r?r:i;if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);a='<span class="bx-messenger-command" data-entity="put" title="'+s.message("IM_BB_PUT")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a});e=e.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,r,i){var a="";i=i?i:r;r=r?r:i;if(!t&&i)a='<span class="bx-messenger-command" data-entity="call" data-command="'+s.util.htmlspecialchars(r)+'">'+i+"</span>";else a=i;return a});var a=0;if(this.BXIM.settings.enableBigSmile){a=s.util.trim(e.replace(/\[icon\=([^\]]*)\]/gi,"")).length}e=e.replace(/\[icon\=([^\]]*)\]/gi,s.delegate(function(e){var t=e.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(t&&t[1]){t=t[1]}else{return""}var r={src:t,border:0};var i=e.match(/size\=(\d+)/i);if(i&&i[1]){r["width"]=i[1];r["height"]=i[1]}else{var n=e.match(/width\=(\d+)/i);if(n&&n[1]){r["width"]=n[1]}var o=e.match(/height\=(\d+)/i);if(o&&o[1]){r["height"]=o[1]}if(r["width"]&&!r["height"]){r["height"]=r["width"]}else if(r["height"]&&!r["width"]){r["width"]=r["height"]}else if(r["height"]&&r["width"]){}else{r["width"]=20;r["height"]=20}}r["width"]=r["width"]>100?100:r["width"];r["height"]=r["height"]>100?100:r["height"];if(this.BXIM.settings.enableBigSmile&&a==0&&r["width"]==r["height"]&&r["width"]==20){r["width"]=40;r["height"]=40}var l=e.match(/title\=(.*[^\s\]])/i);if(l&&l[1]){l=l[1];if(l.indexOf("width=")>-1){l=l.substr(0,l.indexOf("width="))}if(l.indexOf("height=")>-1){l=l.substr(0,l.indexOf("height="))}if(l.indexOf("size=")>-1){l=l.substr(0,l.indexOf("size="))}if(l){l=s.util.trim(l);r["title"]=l;r["alt"]=l}}else{r["title"]=s.message("IM_M_ICON");r["alt"]=r["title"]}return s.create("img",{attrs:r,props:{className:"bx-smile bx-icon"}}).outerHTML},this));e=e.replace(/\[RATING\=([1-5]{1})\]/gi,s.delegate(function(e,s){return this.linesVoteHeadNodes(0,s,false).outerHTML},this));if(i.length>0){for(var n=0;n<i.length;n++){e=e.replace("####REPLACEMENT_MARK_"+n+"####",!t?'<div class="bx-messenger-code">'+i[n]+"</div>":i[n])}}return e};t.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/\[CODE\]\n?([\0-\uFFFF]*?)(<br\/?>)?\[\/CODE\]/gi,"["+s.message("IM_M_CODE_BLOCK")+"]");r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("\t");r=r.split("&nbsp;").join(" ");r=r.split("<br />").join("\n");return r};t.prototype.addMentionList=function(e,s,t){if(!e||!s)return false;if(!this.BXIM.messenger.mentionList[e])this.BXIM.messenger.mentionList[e]={};this.BXIM.messenger.mentionList[e][s]=t};t.prototype.prepareMention=function(e,s){if(!this.BXIM.messenger.mentionList[e])return s;for(var t in this.BXIM.messenger.mentionList[e]){var r=this.BXIM.messenger.mentionList[e][t];if(!r){continue}if(r.toString().substr(0,4)=="chat"){s=s.split(t).join("[CHAT="+r.toString().substr(4)+"]"+t+"[/CHAT]")}else{s=s.split(t).join("[USER="+r+"]"+t+"[/USER]")}}this.clearMentionList(e);return s};t.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};t.prototype.getRecipientByChatId=function(e){var s=0;if(this.BXIM.messenger.chat[e]){s="chat"+e}else{for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}}return s};t.prototype.getUserIdByChatId=function(e){var s=0;for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}return s};t.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e.toString().substr(0,4)=="chat"||e.toString().substr(0,2)=="sg"||e.toString().substr(0,3)=="crm"){var r=e.toString().substr(0,4)=="chat"?e.toString().substr(4):e;if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,work_position:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",fake:true,date_create:false};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){var i=parseInt(e)?this.BXIM.path.profileTemplate.replace("#user_id#",e):"";this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:i,status:"guest",work_position:"",extranet:false,network:false,color:"#556574",fake:true,last_activity_date:new Date(0),mobile_last_date:new Date(0),absent:false,idle:false};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v3.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};t.prototype.userInChat=function(e,s){if(!this.BXIM.messenger.userInChat[e])return false;if(typeof s=="undefined"){s=this.BXIM.userId}else{s=parseInt(s)}var t=false;if(typeof this.BXIM.messenger.userInChat[e].indexOf!="undefined"){if(this.BXIM.messenger.userInChat[e].indexOf(s.toString())>-1||this.BXIM.messenger.userInChat[e].indexOf(parseInt(s))>-1){t=true}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(parseInt(this.BXIM.messenger.userInChat[e][r])==parseInt(s)){t=true;break}}}return t};t.prototype.onOnlineStatusCallback=function(e,s,t,r,i){console.log("Run callback for",i,e,s,t,r)};t.prototype.getUserStatus=function(e,t){t=t!==false;var r=this.getOnlineData(e);var i="offline";var a="";var n="";var o="";if(!e){i="guest";a=s.message("IM_STATUS_GUEST")}else if(e.network){i="network";a=s.message("IM_STATUS_NETWORK")}else if(e.bot){i="bot";a=s.message("IM_STATUS_BOT")}else if(e.connector){i=e.status=="offline"?"lines":"lines-online";a=s.message("IM_CL_USER_LINES")}else if(e.status=="guest"){i="guest";a=s.message("IM_STATUS_GUEST")}else if(this.getCurrentUser()==e.id){i=e.status?e.status.toString():"";a=i?s.message("IM_STATUS_"+i.toUpperCase()):""}else if(!r.isOnline){i="offline";a=s.message("IM_STATUS_OFFLINE")}else if(this.getUserMobileStatus(e)){i="mobile";a=s.message("IM_STATUS_MOBILE")}else if(this.getUserIdleStatus(e,r)){i="idle";a=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else{i=e.status?e.status.toString():"";a=s.message("IM_STATUS_"+i.toUpperCase())}if(e&&this.isBirthday(e.birthday)&&(e.status=="online"||!r.isOnline)){n=i;o=a;i="birthday";if(r.isOnline){a=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}else{a=s.message("IM_STATUS_OFFLINE")}}else if(e&&e.absent){n=i;o=a;i="vacation";if(r.isOnline){a=s.message("IM_STATUS_ONLINE")}else{a=s.message("IM_STATUS_VACATION")}}return t?i:{status:i,statusText:a,originStatus:n?n:i,originStatusText:o?o:a}};t.prototype.getOnlineData=function(e){var t={};if(e){if(e.id==this.getCurrentUser()){e.last_activity_date=new Date;e.mobile_last_date=new Date(0);e.idle=false}t=s.user.getOnlineStatus(e.last_activity_date)}return t};t.prototype.getUserIdle=function(e){if(!e){return""}var s="";if(e.idle){var t=((new Date).getTime()-e.idle.getTime())/1e3>=3600?"Hdiff":"idiff";s=this.formatDate(e.idle,t)}return s};t.prototype.getUserMobileStatus=function(e){if(!e)return false;var t=false;var r=e.mobile_last_date;var i=e.last_activity_date;if(new Date-r<s.user.getSecondsForLimitOnline()*1e3&&i-r<300*1e3){t=true}return t};t.prototype.getUserIdleStatus=function(e,t){if(!e)return"";t=t?t:s.user.getOnlineStatus(e.last_activity_date);return e.idle&&t.isOnline};t.prototype.getUserPosition=function(e,t){t=t===true;if(!e)return"";var r="";if(t&&e.last_activity_date&&!(e.bot||e.network)){r=this.getUserLastDate(e);if(r){return r}}if(e.work_position){r=e.work_position}else if(e.extranet||e.network){r=s.message("IM_CL_USER_EXTRANET")}else if(e.bot){r=s.message("IM_CL_BOT")}else{r=this.isIntranet()?s.message("IM_CL_USER"):s.message("IM_CL_USER_B24")}return r};t.prototype.getUserLastDate=function(e){if(!e){return""}var t="";var r={};if(e.bot||e.network){t=""}else if(e.absent&&!this.getUserMobileStatus(e)){r=this.getOnlineData(e);t=s.message("IM_STATUS_VACATION_TITLE").replace("#DATE#",s.Main.Date.format(s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATE")),e.absent.getTime()/1e3));if(r.isOnline&&e.idle){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){t=s.message("IM_STATUS_ONLINE")+". "+t}else if(r.lastSeenText){t=s.message("IM_LS_"+(e.gender=="F"?"F":"M")).replace("#POSITION#",t).replace("#LAST_SEEN#",r.lastSeenText)}}else if(e.last_activity_date){r=this.getOnlineData(e);if(r.isOnline&&e.idle&&!this.getUserMobileStatus(e)){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){if(this.isMobile()&&this.getUserMobileStatus(e)){t=s.message("IM_STATUS_MOBILE")}else{t=s.message("IM_STATUS_ONLINE")}}else if(r.lastSeenText){t=s.message("IM_LS_SHORT_"+(e.gender=="F"?"F":"M")).replace("#LAST_SEEN#",r.lastSeenText)}}return t};t.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};t.prototype.getCurrentUser=function(){return this.BXIM.userId};t.prototype.getDialogId=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){return this.BXIM.messenger.currentTab}return parseInt(this.BXIM.messenger.currentTab)};t.prototype.getLogTrackingParams=function(e){if(typeof e!=="object"||!e){e={}}var t=e.name||"tracking";var r=e.data||[];var i=e.dialog||null;var a=e.message||null;var n=e.files||null;var o=[];t=encodeURIComponent(t);if(r&&!s.type.isArray(r)&&typeof r==="object"){var l=[];for(var h in r){if(r.hasOwnProperty(h)){l.push(encodeURIComponent(h)+"="+encodeURIComponent(r[h]))}}r=l}else if(!s.type.isArray(r)){r=[]}if(i){o.push("timType="+i.type);if(i.type==="lines"){o.push("timLinesType="+i.entityId.split("|")[0])}}if(n){var m="file";if(s.type.isArray(n)&&n[0]){m=n[0].type}else{m=n.type}o.push("timMessageType="+m)}else if(a){o.push("timMessageType=text")}if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixmobile")>-1){o.push("timDevice=bitrixMobile")}else if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixdesktop")>-1){o.push("timDevice=bitrixDesktop")}else if(navigator.userAgent.toLowerCase().indexOf("iphone")>-1||navigator.userAgent.toLowerCase().indexOf("ipad")>-1||navigator.userAgent.toLowerCase().indexOf("android")>-1){o.push("timDevice=mobile")}else{o.push("timDevice=web")}return t+(r.length?"&"+r.join("&"):"")+(o.length?"&"+o.join("&"):"")};t.prototype.getDialogDataForTracking=function(e){var s={type:"private",entityId:"",entityTypeId:""};if(e.toString().indexOf("chat")===0){s.type="chat";var t=e.toString().substr(4);if(this.BXIM.messenger.chat[t]){s.type=this.BXIM.messenger.chat[t].type;s.entityTypeId=this.BXIM.messenger.chat[t].entity_type_id;s.entityId=this.BXIM.messenger.chat[t].entity_id}}return s};t.prototype.getChatUsers=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)!="chat"){return[].push(parseInt(this.BXIM.messenger.currentTab))}var e=this.BXIM.messenger.currentTab.toString().substr(4);var s=[];if(this.BXIM.messenger.userInChat[e]){s=this.BXIM.messenger.userInChat[e].map(function(e){return parseInt(e)})}return s};t.prototype.setColor=function(e,t){if(!this.BXIM.init&&this.isDesktop()){s.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:t}]);return false}if(typeof e!="string"){return false}else{e=e.toUpperCase()}if(typeof t!="undefined"){if(typeof this.BXIM.messenger.chat[t]=="undefined"){return false}}else{t=0;if(this.BXIM.userColor==e){return false}}s.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:t,sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(parseInt(e.CHAT_ID)==0){this.BXIM.userColor=e.COLOR;if(this.isPage()){setTimeout(function(){s.MessengerWindow.setUserInfo(s.MessengerCommon.getUserParam())},500)}}}},this)})};t.prototype.checkRestriction=function(e,s){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return false;var t=this.BXIM.messenger.chat[e].entity_type;if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined"||typeof this.BXIM.messenger.userChatOptions[t][s]=="undefined")return false;if(!this.BXIM.messenger.userChatOptions[t][s])return true;return false};t.prototype.getEntityTypePath=function(e){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return null;var t=this.BXIM.messenger.chat[e].entity_type;if(t=="CRM"){var r=this.BXIM.messenger.chat[e].entity_id.toString().split("|");return{PATH:this.BXIM.path.crm[r[0]].replace("#ID#",r[1]),TITLE:s.message("IM_M_OL_GOTO_CRM")}}else{if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined")return null;if(!this.BXIM.messenger.userChatOptions[t]["PATH"])return null;return{PATH:this.BXIM.messenger.userChatOptions[t]["PATH"].replace("#ID#",this.BXIM.messenger.chat[e].entity_id),TITLE:this.BXIM.messenger.userChatOptions[t]["PATH_TITLE"]}}};t.prototype.renameChat=function(e,t){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!t||e<=0)return false;t=s.util.trim(t);if(t.length<=0||this.BXIM.messenger.chat[e].name==s.util.htmlspecialchars(t))return false;var r=this.BXIM.messenger.chat[e].name;this.BXIM.messenger.chat[e].name=s.util.htmlspecialchars(t);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(s){if(s.ERROR){if(this.BXIM.messenger.popupMessengerPanelChatTitle){this.BXIM.messenger.popupMessengerPanelChatTitle.innerHTML=r}this.BXIM.messenger.chat[e].name=r}},this)});return true};t.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e)}else if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e);if(this.BXIM.messenger.recentListExternal){this.recentListRedraw(e)}}};t.prototype.contactListRedraw=function(e){if(this.BXIM.messenger.popupMessenger==null)return false;e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.contactListPrepare());if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){s.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};t.prototype.contactListPrepareSearch=function(e,t,r,i){if(!t)return false;if(this.BXIM.messenger.openLinesFlag&&(e=="popupChatDialogContactListElements"&&this.BXIM.messenger.popupChatDialogDestType=="CHAT_EXTEND"||e=="popupTransferDialogContactListElements")){i.viewOffline=true;i.viewOnlyIntranet=true;i.viewOnlyBusiness=true;i.viewChat=false;i.viewOfflineWithPhones=false}var a={listName:e,groupOpen:true,viewSelf:e=="contactList",viewOffline:true,viewOnlyBusiness:false,viewGroup:true,viewChat:true,viewBot:true,viewTransferViQueue:false,viewTransferOlQueue:false,viewOpenChat:true,viewOfflineWithPhones:false,extra:false,searchText:r,callback:{empty:function(){}}};if(i!=false){for(var n in i){if(n=="timeout"||n=="params")continue;a[n]=i[n]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate(function(){t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),o)}else{t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};t.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};return this.chatListPrepare(e)};t.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();var t=s.proxy_context.getAttribute("data-userId");if(t.toString().substr(0,9)=="structure"){var r=t.toString().substr(9);var i=this.BXIM.messenger.groups[r].name.split(" / ")[0];this.BXIM.messenger.popupContactListSearchInput.value=i;this.BXIM.messenger.contactListSearchText=t;this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,{});return s.PreventDefault(e)}if(this.BXIM.messenger.contactList){s.MessengerCommon.recentListElementToTop(s.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"));if(this.BXIM.callController.hasActiveCall()){this.BXIM.callController.fold()}}return s.PreventDefault(e)};t.prototype.contactListGetFromServer=function(t){if(this.BXIM.messenger.contactListLoad)return false;if(!s.type.isFunction(t))t=s.DoNothing;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:this.isDesktop()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.USERS){r.USERS[i].last_activity_date=new Date(r.USERS[i].last_activity_date);r.USERS[i].mobile_last_date=new Date(r.USERS[i].mobile_last_date);r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.GROUPS)this.BXIM.messenger.groups[i]=r.GROUPS[i];for(var i in r.CHATS){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)r.CHATS[i].fake=true;else if(!this.BXIM.messenger.chat[i])r.CHATS[i].fake=true;r.CHATS[i].date_create=new Date(r.CHATS[i].date_create);this.BXIM.messenger.chat[i]=r.CHATS[i]}for(var i in r.PHONES){this.BXIM.messenger.phones[i]={};for(var a in r.PHONES[i]){this.BXIM.messenger.phones[i][a]=s.util.htmlspecialcharsback(r.PHONES[i][a])}}for(var i in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=r.USER_IN_GROUP[i]}else{for(var a=0;a<r.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(r.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.BXIM.messenger.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.messenger.popupTransferDialogContactListElements,this.BXIM.messenger.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}}t()}else{this.BXIM.messenger.contactListLoad=false;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};t.prototype.contactListRealSearch=function(e,t){if(!this.BXIM.messenger.realSearch)return false;this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate(function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};for(var s in e.USERS){if(this.BXIM.messenger.users[s]){continue}e.USERS[s].last_activity_date=new Date(e.USERS[s].mobile_last_date);e.USERS[s].mobile_last_date=new Date(e.USERS[s].mobile_last_date);e.USERS[s].idle=e.USERS[s].idle?new Date(e.USERS[s].idle):false;e.USERS[s].absent=e.USERS[s].absent?new Date(e.USERS[s].absent):false;this.BXIM.messenger.users[s]=e.USERS[s];this.BXIM.messenger.userInGroup["search"]["users"].push(s);if(e.USERS[s].bot&&e.USERS[s].network){this.BXIM.messenger.bot[s]={type:"network"};this.BXIM.messenger.users[s].extranet=false}}if(typeof t!="undefined"){t()}else if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}},this),onfailure:s.delegate(function(){this.BXIM.messenger.realSearchFound=true},this)})},this),1500)};t.prototype.contactListSearchClear=function(e){if(!this.BXIM.messenger.popupContactListSearchInput)return;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.userListRedraw()};t.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==38||e.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(e.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.messenger.webrtc.callInit){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(e.keyCode==13){var t=true;var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(r){this.recentListElementToTop(r.getAttribute("data-userId"));this.BXIM.messenger.openMessenger(r.getAttribute("data-userid"))}else{var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-chatlist-search-button");if(r){t=false;this.BXIM.messenger.chatListSearchAction(r);return true}}if(t){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.popupContactListSearchInput.value=""}}}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.contactListRealSearch(this.BXIM.messenger.contactListSearchText)}this.userListRedraw()};t.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT"))return false;if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}if(this.BXIM.messenger.popupContactListActive){s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";if(this.isPage()&&s.MessengerWindow.currentTab=="im-ol"){s.addClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentLinesListPrepare(e))}else{s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentListPrepare(e))}if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML=this.BXIM.messenger.popupContactListElementsWrap.innerHTML}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}else if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML="";this.BXIM.messenger.recentListExternal.appendChild(this.recentListPrepare(e))}};t.prototype.recentListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}for(var a in this.BXIM.messenger.unreadMessage){if(this.inRecentList(a))continue;if(a.toString().substr(0,4)=="chat"){var n=this.BXIM.messenger.chat[a.toString().substr(4)];if(n&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable){continue}}else{var n=this.BXIM.messenger.users[a]}if(typeof n=="undefined"||typeof n.name=="undefined"){this.readMessage(a,true,true);continue}var o=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[a]);if(this.BXIM.messenger.message[o]){this.BXIM.messenger.recent.push({chatId:this.BXIM.messenger.message[o].chatId,date:this.BXIM.messenger.message[o].date,id:o,params:{},recipientId:a.toString().substr(0,4)=="chat"?a:this.BXIM.userId,senderId:this.BXIM.messenger.message[o].senderId,text:this.BXIM.messenger.message[o].text,userId:a,userIsChat:a.toString().substr(0,4)=="chat"})}}this.BXIM.messenger.recent.sort(function(e,s){var t=e.date.getTime();var r=s.date.getTime();if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});this.BXIM.messenger.recentListIndex=[];var l=this.isMobile()?49:999999;var h={};for(var m=0;m<this.BXIM.messenger.recent.length;m++){if(!this.BXIM.messenger.recent[m].pinned){continue}if(typeof this.BXIM.messenger.recent[m].userIsChat=="undefined"){this.BXIM.messenger.recent[m].userIsChat=this.BXIM.messenger.recent[m].recipientId.toString().substr(0,4)=="chat"}var g=s.clone(this.BXIM.messenger.recent[m]);if(m>l){if(!this.BXIM.messenger.unreadMessage[g.userId]||this.BXIM.messenger.unreadMessage[g.userId]&&this.BXIM.messenger.unreadMessage[g.userId].length==0){continue}}var I="";if(g.userIsChat){var n=this.BXIM.messenger.chat[g.userId.toString().substr(4)];if(typeof n=="undefined"||typeof n.name=="undefined"||this.isPage()&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator())continue;var p="chat"+n.id}else if(!i){var n=this.BXIM.messenger.users[g.userId];if(typeof n=="undefined"||typeof n.name=="undefined")continue;if(typeof n.active!="undefined"&&!n.active&&!this.BXIM.messenger.unreadMessage[n.id])continue;var p=n.id}else{continue}h[p]=true;if(!r["favorites"]){r["favorites"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-pinned"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RECENT_PINNED")})]}))}t.appendChild(this.drawContactListElement({id:p,data:n,text:g.text,textSenderId:g.senderId,textParams:g.params,pinned:g.pinned}));this.BXIM.messenger.recentListIndex.push(p)}var r={};for(var m=0;m<this.BXIM.messenger.recent.length;m++){if(this.BXIM.messenger.recent[m].pinned){continue}if(typeof this.BXIM.messenger.recent[m].userIsChat=="undefined"){this.BXIM.messenger.recent[m].userIsChat=this.BXIM.messenger.recent[m].recipientId.toString().substr(0,4)=="chat"}var g=s.clone(this.BXIM.messenger.recent[m]);if(m>l){if(!this.BXIM.messenger.unreadMessage[g.userId]||this.BXIM.messenger.unreadMessage[g.userId]&&this.BXIM.messenger.unreadMessage[g.userId].length==0){continue}}var I="";if(g.userIsChat){var n=this.BXIM.messenger.chat[g.userId.toString().substr(4)];if(typeof n=="undefined"||typeof n.name=="undefined"||this.isPage()&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator())continue;var p="chat"+n.id}else if(!i){var n=this.BXIM.messenger.users[g.userId];if(typeof n=="undefined"||typeof n.name=="undefined")continue;if(typeof n.active!="undefined"&&!n.active&&!this.BXIM.messenger.unreadMessage[n.id])continue;var p=n.id}else{continue}h[p]=true;if(g.date){g.date=this.formatDate(g.date,this.getDateFormatType("RECENT_TITLE"));if(!r[g.date]){r[g.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:g.date})]}))}}else{if(!r["never"]){r["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:p,data:n,text:g.text,textSenderId:g.senderId,textParams:g.params}));this.BXIM.messenger.recentListIndex.push(p)}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};t.prototype.recentLinesListPrepare=function(e){var t=document.createDocumentFragment();e=typeof e=="object"?e:{};if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var r={};var i=false;for(var a=0;a<this.BXIM.messenger.openlines.queue.length;a++){r[this.BXIM.messenger.openlines.queue[a].id]=parseInt(this.BXIM.messenger.openlines.queue[a].priority);if(!i&&r[this.BXIM.messenger.openlines.queue[a].id]>0){i=true}}var n={};var o=this.isMobile()?49:999999;var l=[];this.BXIM.messenger.recentListIndex=[];var h={};for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(typeof this.BXIM.messenger.recent[a].userIsChat=="undefined"){this.BXIM.messenger.recent[a].userIsChat=this.BXIM.messenger.recent[a].recipientId.toString().substr(0,4)=="chat"}var m=this.BXIM.messenger.recent[a];if(a>o){if(!this.BXIM.messenger.unreadMessage[m.userId]||this.BXIM.messenger.unreadMessage[m.userId]&&this.BXIM.messenger.unreadMessage[m.userId].length==0){continue}}var g="";if(typeof m.userIsChat=="undefined"){m.userIsChat=m.recipientId.toString().substr(0,4)=="chat"}if(m.userIsChat){var I=this.BXIM.messenger.chat[m.userId.toString().substr(4)];if(typeof I=="undefined"||typeof I.name=="undefined"||I.entity_type!="LINES")continue;m.chatId=I.id;var p="chat"+I.id}else{continue}h[p]=true;if(i&&!n[m.chatId]){var c=I.entity_id.toString().split("|");n[m.chatId]=r[c[1]]?r[c[1]]:0}var d=I.entity_data_1.toString().split("|");if(typeof d[6]!="undefined"){d=parseInt(d[6])-(i?n[m.chatId]:0);m.dateStart=new Date(d*1e3)}else{d=typeof d[5]!="undefined"?parseInt(d[5]):0;m.dateStart=new Date(d*1e3)}l.push(m)}l.sort(s.delegate(function(e,s){if(!this.BXIM.messenger.chat[e.chatId])return-1;if(!this.BXIM.messenger.chat[s.chatId])return 1;var t=e.dateStart.getTime();var r=s.dateStart.getTime();if(t<r){return-1}else if(t>r){return 1}else{return 0}},this));var M={};var u={};for(var f in this.BXIM.messenger.unreadMessage){if(h[f])continue;u[f]=true}for(var f in u){if(f.toString().substr(0,4)=="chat"){var B=this.BXIM.messenger.chat[f.toString().substr(4)];if(!B||B.entity_type!="LINES"){continue}}else{continue}if(!M["30days"]){M["30days"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:""})]}))}var m={text:"",textSenderId:0,textParams:{}};var X=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[f]);if(this.BXIM.messenger.message[X]){m.text=this.BXIM.messenger.message[X].text;m.textSenderId=this.BXIM.messenger.message[X].senderId;m.textParams=this.BXIM.messenger.message[X].params}t.appendChild(this.drawContactListElement({id:f,data:B,text:m.text,textSenderId:m.senderId,textParams:m.params,showLastMessage:m.text!=""}));this.BXIM.messenger.recentListIndex.push(B.id)}if(this.BXIM.settings.linesNewGroupEnable){for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[m.userId]||this.BXIM.messenger.unreadMessage[m.userId]&&this.BXIM.messenger.unreadMessage[m.userId].length==0){continue}}var m=s.clone(l[a]);var g="";if(m.userIsChat){var I=this.BXIM.messenger.chat[m.userId.toString().substr(4)];if(typeof I=="undefined"||typeof I.name=="undefined"||I.entity_type!="LINES"||parseInt(I.owner)!=0){continue}if(m.senderId!=0&&this.BXIM.messenger.users[m.senderId]&&!this.BXIM.messenger.users[m.senderId].connector&&!this.BXIM.messenger.users[m.senderId].bot&&!(m.params&&m.params.CLASS=="bx-messenger-content-item-system")){continue}var p="chat"+I.id}else{continue}if(!M["groupNew"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red-2"},html:s.message("IM_OL_LIST_NEW")})]}));M["groupNew"]=true}if(m.date){m.date=this.formatDate(m.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[m.date]){M[m.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:m.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:p,data:I,text:m.text,textSenderId:m.senderId,textParams:m.params}))}}var M={};for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[m.userId]||this.BXIM.messenger.unreadMessage[m.userId]&&this.BXIM.messenger.unreadMessage[m.userId].length==0){continue}}var m=s.clone(l[a]);var g="";if(m.userIsChat){var I=this.BXIM.messenger.chat[m.userId.toString().substr(4)];if(typeof I=="undefined"||typeof I.name=="undefined"||I.entity_type!="LINES"||parseInt(I.owner)==0&&this.BXIM.settings.linesNewGroupEnable){continue}if(m.senderId!=0&&this.BXIM.messenger.users[m.senderId]&&!this.BXIM.messenger.users[m.senderId].connector&&!this.BXIM.messenger.users[m.senderId].bot&&!(m.params&&m.params.CLASS=="bx-messenger-content-item-system")){continue}var p="chat"+I.id}else{continue}if(!M["groupUnanswered"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red"},html:s.message("IM_OL_LIST_UNANSWERED")})]}));M["groupUnanswered"]=true}if(m.date){m.date=this.formatDate(m.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[m.date]){M[m.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:m.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:p,data:I,text:m.text,textSenderId:m.senderId,textParams:m.params}))}l.sort(function(e,s){var t=e.date.getTime();var r=s.date.getTime();if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});var M={};for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[m.userId]||this.BXIM.messenger.unreadMessage[m.userId]&&this.BXIM.messenger.unreadMessage[m.userId].length==0){continue}}var m=s.clone(l[a]);var g="";if(m.userIsChat){var I=this.BXIM.messenger.chat[m.userId.toString().substr(4)];if(typeof I=="undefined"||typeof I.name=="undefined"||I.entity_type!="LINES")continue;if(m.senderId==0||!this.BXIM.messenger.users[m.senderId]||this.BXIM.messenger.users[m.senderId]&&(this.BXIM.messenger.users[m.senderId].connector||this.BXIM.messenger.users[m.senderId].bot)||m.params&&m.params.CLASS=="bx-messenger-content-item-system"){continue}var p="chat"+I.id}else{continue}if(!M["groupAnswered"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-green"},html:s.message("IM_OL_LIST_ANSWERED")})]}));M["groupAnswered"]=true}if(m.date){m.date=this.formatDate(m.date,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[m.date]){M[m.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:m.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:p,data:I,text:m.text,textSenderId:m.senderId,textParams:m.params}))}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_OL_EMPTY")}))}return t};t.prototype.recentListAdd=function(e){e.date=e.date?e.date:new Date;if(!e.skipDateCheck){for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId&&Math.floor(this.BXIM.messenger.recent[t].date.getTime()/1e3)>Math.floor(e.date.getTime()/1e3)){return false}}}var r=[];r.push(e);for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId)e.pinned=this.BXIM.messenger.recent[t].pinned===true;else r.push(this.BXIM.messenger.recent[t])}this.BXIM.messenger.recent=r;if(!e.skipRedraw&&this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(s.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};t.prototype.inRecentList=function(e){if(!e)return false;var s=false;for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e){s=true;break}}return s};t.prototype.recentListHide=function(e,t){if(!e)return false;var r=[];var i=false;for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(!i&&this.BXIM.messenger.recent[a].userId==e){i=true;continue}r.push(this.BXIM.messenger.recent[a])}this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5);t=t!=false;if(t){s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",DIALOG_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}this.readMessage(e,t,false);if(e.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+e.substr(4)})}else{s.PULL.clearWatch("IM_PUBLIC_"+e.substr(4))}}delete this.BXIM.messenger.showMessage[e];delete this.BXIM.messenger.history[e];if(this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(s.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:s.message("IM_M_EMPTY")}))}};t.prototype.recentListElementUpdate=function(e,s,t){if(e.toString().substr(0,4)=="chat"){for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].recipientId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}else{for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(!this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].userId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}};t.prototype.recentListElementToTop=function(e){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;this.BXIM.messenger.recent[r].date=new Date;break}}if(!t){var i="";var a=this.getLastMessageInDialog(e);if(a){if(a.text){i=a.text}else if(a.params&&a.params.FILE_ID&&a.params.FILE_ID.length>1){i="["+s.message("IM_F_FILE")+"]"}else if(a.params&&a.params.ATTACH&&a.params.ATTACH.length>1){item.text="["+s.message("IM_F_ATTACH")+"]"}}if(!i){var n=this.getUserParam(e);if(n.type=="chat"){i=s.message("IM_CL_CHAT_2")}else if(n.type=="open"){i=s.message("IM_CL_OPEN_CHAT")}else if(n.type=="call"){i=s.message("IM_CL_PHONE")}else if(n.type=="lines"){i=s.message("IM_CL_LINES")}else{i=s.util.htmlspecialcharsback(this.getUserPosition(this.BXIM.messenger.users[e],true))}}this.BXIM.messenger.recent.push({id:"tempSort"+ +new Date,date:new Date,skipDateCheck:true,recipientId:e,senderId:e,text:s.MessengerCommon.prepareText(i,true),userId:e,params:{}})}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5)};t.prototype.recentListElementPin=function(e,s){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;if(this.BXIM.messenger.recent[r].pinned==s){return true}this.BXIM.messenger.recent[r].pinned=s;break}}if(t&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw();return true};t.prototype.recentListGetSortIndex=function(){var e={};var s=0;if(this.BXIM.messenger.recent.length<=0){this.recentListGetFromServer()}for(var t=0;t<this.BXIM.messenger.recent.length;t++){s=this.BXIM.messenger.recent.length-t;e[this.BXIM.messenger.recent[t].userId]=s}return e};t.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad)return false;this.BXIM.messenger.recentListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.recent=[];for(var r in t.RECENT){t.RECENT[r].date=new Date(t.RECENT[r].date);this.BXIM.messenger.recent.push(t.RECENT[r])}var i=false;for(var r in this.BXIM.messenger.unreadMessage){for(var a=0;a<this.BXIM.messenger.unreadMessage[r].length;a++){if(!i||this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]]&&i.SEND_DATE.getTime()<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date.getTime()){i={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].params}}}}if(i){this.recentListAdd({userId:i.RECIPIENT_ID.toString().substr(0,4)=="chat"?i.RECIPIENT_ID:i.USER_ID,id:i.ID,date:i.SEND_DATE,recipientId:i.RECIPIENT_ID,senderId:i.SENDER_ID,text:i.SEND_MESSAGE,userIsChat:i.RECIPIENT_ID.toString().substr(0,4)=="chat",params:i.PARAMS},true)}for(var r in t.CHAT){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHAT[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHAT[r].fake=true;t.CHAT[r].date_create=new Date(t.CHAT[r].date_create);this.BXIM.messenger.chat[r]=t.CHAT[r]}for(var r in t.USERS){t.USERS[r].last_activity_date=new Date(t.USERS[r].last_activity_date);t.USERS[r].mobile_last_date=new Date(t.USERS[r].mobile_last_date);t.USERS[r].idle=t.USERS[r].idle?new Date(t.USERS[r].idle):false;t.USERS[r].absent=t.USERS[r].absent?new Date(t.USERS[r].absent):false;this.BXIM.messenger.users[r]=t.USERS[r]}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();this.BXIM.messenger.smile=t.SMILE;this.BXIM.messenger.smileSet=t.SMILE_SET;this.BXIM.settingsNotifyBlocked=t.NOTIFY_BLOCKED;if(!this.isMobile())this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recent.length==0){this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare())}}else{this.BXIM.messenger.recentListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.recentListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(this.recentListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};t.prototype.drawContactListElement=function(e){if(!e||!e.id)return null;e.userIsChat=e.id.toString().substr(0,4)=="chat";e.userIsQueue=e.id.toString().substr(0,5)=="queue";e.userIsStructure=e.id.toString().substr(0,9)=="structure";e.extraClass=e.extraClass||"";e.showLastMessage=e.showLastMessage===false?false:true;e.showCounter=e.showCounter===false?false:true;e.data=e.data?e.data:{};var t="";var r="";var i="";var a="";if(e.showCounter){if(this.BXIM.messenger.unreadMessage[e.id]&&this.BXIM.messenger.unreadMessage[e.id].length>0){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[e.id].length<100?this.BXIM.messenger.unreadMessage[e.id].length:"99+")+"</span>"}if(this.countWriting(e.id))a="bx-messenger-cl-status-writing"}if(e.userIsQueue){e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}else if(e.userIsStructure){e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}if(!e.data.avatar)e.data.avatar=this.BXIM.pathToBlankImage;var n="";var o=e.data.avatar;var l="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==e.id){l="bx-messenger-cl-item-active "}var h="mobile-rc-avatar-id-"+e.data.id;n='id="'+h+'" data-src="'+e.data.avatar+'"';o=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(h,function(e){return!e.node.parentNode.parentNode.classList.contains("bx-messenger-hide")||e.node.parentNode.parentNode.parentNode.classList.contains("bx-messenger-chatlist-show-all")})}var m="";var g=false;if(this.BXIM.settings.viewLastMessage&&e.showLastMessage){if(this.BXIM.messenger.message[e.id]&&this.BXIM.messenger.message[e.id].text){e.text=this.BXIM.messenger.message[e.id].text}var I="";if(e.textSenderId==this.BXIM.userId)I='<span class="bx-messenger-cl-user-reply"></span>';e.text=this.purifyText(e.text,e.textParams);m=I+""+e.text}else{if(e.userIsChat){if(e.data.type=="call"){m=s.message("IM_CL_PHONE")}else if(e.data.type=="lines"){m=s.message("IM_CL_LINES")}else if(e.data.type=="open"){m=s.message("IM_CL_OPEN_CHAT")}else{m=s.message("IM_CL_CHAT_2")}}else if(e.userIsQueue){if(e.data.type=="olQueue"){m=s.message("IM_CL_OL_QUEUE")}else if(e.data.type=="viQueue"){m=s.message("IM_CL_VI_QUEUE")}}else if(e.userIsStructure){m=s.message("IM_CL_STRUCTURE")}else{m=this.getUserPosition(this.BXIM.messenger.users[e.id],true)}}if(e.userIsChat){if(e.data.type=="lines"){var p=this.linesGetSession(this.BXIM.messenger.chat[e.id.substr(4)]);g=p.crm=="Y";t+=" bx-messenger-cl-avatar-"+this.linesGetSource(this.BXIM.messenger.chat[e.id.substr(4)])}else if(e.data.entity_type=="CRM"){g=true;t+=" bx-messenger-cl-avatar-type-crm"}else{t="bx-messenger-cl-item-chat-"+e.data.type}}else if(e.userIsQueue){if(e.data.type=="olQueue"){t=" bx-messenger-cl-avatar-lines"}else if(e.data.type=="viQueue"){t=" bx-messenger-cl-avatar-call"}}else if(e.userIsStructure){t=" bx-messenger-cl-avatar-structure"}var c=this.isBlankAvatar(e.data.avatar)?'style="background-color: '+e.data.color+'"':"";var d=e.userIsChat&&c?"bx-messenger-cl-avatar-status-hide":"";var M=e.data.name;if(!e.userIsChat&&!e.userIsQueue&&!e.userIsStructure&&this.BXIM.userId==e.data.id){M=M+" (<b><i>"+s.message("IM_YOU")+"</i></b>)"}var u="";var f="bx-messenger-cl-item  bx-messenger-cl-id-"+(e.userIsChat?"chat":"")+(e.userIsQueue?"queue":"")+e.data.id+" "+l;if(e.userIsChat){u="bx-messenger-cl-avatar-"+e.data.type+" "+(this.BXIM.messenger.generalChatId==e.data.id?" bx-messenger-cl-item-chat-general":"");f+="bx-messenger-cl-item-chat "+r+" "+a+" "+t+" "+(this.BXIM.messenger.generalChatId==e.data.id?"bx-messenger-cl-item-chat-general":"")}else if(e.userIsQueue){f+=t}else if(e.userIsStructure){f+=t}else{f+="bx-messenger-cl-status-"+this.getUserStatus(this.BXIM.messenger.users[e.data.id])+" "+r+" "+a}f+=" "+e.extraClass;if(e.pinned){f+=" bx-messenger-cl-item-pinned"}return s.create("span",{props:{className:f},attrs:{"data-userId":e.id,"data-name":s.util.htmlspecialcharsback(e.data.name),"data-status":this.getUserStatus(this.BXIM.messenger.users[e.data.id]),"data-avatar":e.data.avatar,"data-userIsChat":e.userIsChat,"data-isPinned":e.pinned,"data-userIsQueue":e.userIsQueue},html:'<span class="bx-messenger-cl-count">'+i+"</span>"+'<span title="'+e.data.name+'" class="bx-messenger-cl-avatar '+u+" "+d+'">'+'<img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(e.data.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+o+'" '+n+" "+c+">"+(g?'<span class="bx-messenger-cl-crm"></span>':"")+(!e.userIsQueue&&!e.userIsStructure?'<span class="bx-messenger-cl-status"></span>':"")+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(e.data.extranet&&e.data.type!="lines"?" bx-messenger-user-extranet":"")+'" title="'+e.data.name+'">'+M+"</div>"+'<div class="bx-messenger-cl-user-desc">'+m+"</div>"+"</span>"})};t.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT")||this.BXIM.messenger.popupMessenger==null)return false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}if(this.BXIM.messenger.popupContactListElementsWrap){s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare(e))}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};t.prototype.chatListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=typeof e.listName!="undefined"?e.listName:"contactList";var a=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var n=!(a!=null&&a.length==0);var o=n&&a.substr(0,9)=="structure"?a.substr(9):0;var l=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var h=typeof e.viewOnlyIntranet!="undefined"?e.viewOnlyIntranet:false;var m=typeof e.viewOnlyBusiness!="undefined"?e.viewOnlyBusiness:false;var g=typeof e.extra!="undefined"?e.extra:true;var I=typeof e.viewOffline!="undefined"?e.viewOffline:n||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var p=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;var c=typeof e.viewChat!="undefined"?e.viewChat:true;var d=typeof e.viewOpenChat!="undefined"?e.viewOpenChat:true;var M=typeof e.viewSelf!="undefined"?e.viewSelf:true;var u=typeof e.viewTransferViQueue!="undefined"?e.viewTransferViQueue:false;var f=typeof e.viewTransferOlQueue!="undefined"?e.viewTransferOlQueue:false;var B=typeof e.viewBot!="undefined"?e.viewBot:true;var X=typeof e.callback!="undefined"?e.callback:{};var b=n&&a.length>=3&&this.BXIM.messenger.realSearchAvailable&&!this.BXIM.messenger.realSearch&&!h;var E=i=="contactList"||i=="popupChatDialogContactListElements"&&(this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_ADD"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_EXTEND"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_CREATE"&&this.BXIM.messenger.chatCreateType!="private");var C=i=="contactList";if(typeof X.empty!="function"){X.empty=function(){}}if(!this.BXIM.messenger.contactListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var _=this.BXIM.messenger.popupContactListElementsSize;var S=46;var T=29;var v=26;var A=0;var y=n?5:3;var L=[];if(f){L.push({id:"olQueue",name:s.message("IM_CTL_CHAT_OL_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}else if(u){L.push({id:"viQueue",name:s.message("IM_CTL_CHAT_VI_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}var N=this.BXIM.messenger.users;if(n&&o){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});N={};if(this.BXIM.messenger.userInGroup[o]){for(var x=0;x<this.BXIM.messenger.userInGroup[o].users.length;x++){N[this.BXIM.messenger.userInGroup[o].users[x]]=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[o].users[x]]}}}else if(n){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN"),title:s.message("IM_CL_CREATE_OPEN"),more:s.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT"),title:s.message("IM_CL_CREATE_CHAT"),more:s.message("IM_CL_MORE_CHAT")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_EXTRANET")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CL_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!E});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET")})}else{L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN"),title:s.message("IM_CL_CREATE_OPEN"),more:s.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT"),title:s.message("IM_CL_CREATE_CHAT"),more:s.message("IM_CL_MORE_CHAT")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_EXTRANET")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CTL_CHAT_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!E});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET")})}for(var x=0;x<L.length;x++){if(L[x].skip)continue;A++}var R=_-T*A;var D=parseInt(R/S);var w=Math.max(parseInt(R/A/S),y);var O=0;var k=0;for(var x=0;x<L.length;x++){L[x].countElement=0;if(L[x].skip)continue;L[x].countElement=w}var P=[];if(n){a=a+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var U=s.correctText(a);if(U!=a){a=a+" "+U}}P=a.split(" ")}var H=this.recentListGetSortIndex();var G={};var F=[];for(var x=0;x<L.length;x++){G[x]=[];if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"){if(!B&&L[x].id=="bot")L[x].skip=true;if(h&&L[x].id=="extranet")L[x].skip=true;if(!c&&L[x].id=="ol")L[x].skip=true;if(L[x].skip)continue;for(var j in N){if(!N.hasOwnProperty(j))continue;if(!M&&j==this.BXIM.userId)continue;if(typeof this.BXIM.messenger.users[j].active!="undefined"&&!this.BXIM.messenger.users[j].active)continue;if(m&&this.BXIM.messenger.businessUsers&&!this.BXIM.messenger.users[j].bot&&this.BXIM.messenger.businessUsers.indexOf(j.toString())==-1)continue;if(!I){var V=this.getUserStatus(this.BXIM.messenger.users[j]);if(p&&this.userHasPhone(j)){}else if(V=="offline"){continue}}var Y=this.BXIM.messenger.userChat[j];if(L[x].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[Y]||!this.BXIM.messenger.userChatBlockStatus[Y][this.BXIM.userId]){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[Y]&&this.BXIM.messenger.userChatBlockStatus[Y][this.BXIM.userId]){continue}}if(L[x].id=="extranet"){if(!this.BXIM.messenger.users[j].extranet)continue}else{if(this.BXIM.messenger.users[j].extranet)continue}if(L[x].id=="ol"){if(!this.BXIM.messenger.users[j].bot)continue;if(!this.BXIM.messenger.bot[j]||this.BXIM.messenger.bot[j].type!="network")continue}else if(L[x].id=="bot"){if(!this.BXIM.messenger.users[j].bot||!this.BXIM.messenger.bot[j])continue;if(this.BXIM.messenger.bot[j]&&this.BXIM.messenger.bot[j].type=="network")continue;if(this.BXIM.messenger.popupChatDialogDestType=="CALL_INVITE_USER"){continue}if(this.BXIM.messenger.openChatFlag){var W=this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)];if(W&&W.entity_type!="LINES"&&this.BXIM.messenger.bot[j].type=="openline"){continue}else if(W&&W.entity_type=="LINES"&&!this.BXIM.messenger.bot[j].openline){continue}else if(this.BXIM.messenger.bot[j].type=="network"){continue}}else{if(this.BXIM.messenger.bot[j].type=="network"||this.BXIM.messenger.bot[j].type=="openline"){continue}}}else{if(this.BXIM.messenger.users[j].bot)continue}if(n&&o){}else if(n){var K=this.BXIM.messenger.users[j];if(!K){continue}var J=K.name.toLowerCase()+(K.search_mark?" "+K.search_mark:"");var q=K.work_position?(" "+K.work_position).toLowerCase():"";var Q=true;if(!H[j]){H[j]=0}for(var z=0;z<P.length;z++){if(J.indexOf(P[z].toLowerCase())>=0){H[j]+=100+P[z].length;Q=false}if(q.indexOf(P[z].toLowerCase())>=0){H[j]+=50+P[z].length;Q=false}}if(Q){continue}}if(L[x].id=="bot"){G[x].push(this.BXIM.messenger.users[j])}else if(L[x].id=="ol"){G[x].push(this.BXIM.messenger.users[j])}else{G[x].push(this.BXIM.messenger.users[j])}}if(L[x].id=="bot"){G[x].sort(s.delegate(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id]["code"]=="marta"){t=1e7}if(this.BXIM.messenger.bot[s.id]&&this.BXIM.messenger.bot[s.id]["code"]=="marta"){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(n){G[x].sort(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}})}else{G[x].sort(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(BXIM&&e.id==BXIM.userId){t=1e7}if(BXIM&&s.id==BXIM.userId){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}})}}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){if(!c&&L[x].id!="open")L[x].skip=true;if(!d&&L[x].id=="open")L[x].skip=true;if(L[x].skip)continue;for(var Y in this.BXIM.messenger.chat){if(!this.BXIM.messenger.chat.hasOwnProperty(Y)){continue}if(this.BXIM.messenger.chat[Y].type=="chat"||this.BXIM.messenger.chat[Y].type=="open"||this.BXIM.messenger.chat[Y].type=="call"||this.BXIM.messenger.chat[Y].type=="lines"){if(this.BXIM.messenger.chat[Y].type!=L[x].id){continue}}else if(L[x].id!="chat"){continue}if(this.BXIM.messenger.generalChatId==Y&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}if(n){var $=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.chat[Y].name.toLowerCase().indexOf(P[z].toLowerCase())>=0){$=false;break}}if($){continue}}G[x].push(this.BXIM.messenger.chat[Y])}G[x].sort(s.delegate(function(e,s){var t=H["chat"+e.id]?H["chat"+e.id]:0;var r=H["chat"+s.id]?H["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==e.id){t=1e7}else if(this.BXIM.messenger.userChatBlockStatus[e.id]&&this.BXIM.messenger.userChatBlockStatus[e.id][this.BXIM.userId]){t=-1}if(this.BXIM.messenger.generalChatId==s.id){r=1e7}else if(this.BXIM.messenger.userChatBlockStatus[r.id]&&this.BXIM.messenger.userChatBlockStatus[r.id][this.BXIM.userId]){r=-1}if(t>r){return-1}else if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(L[x].id=="olQueue"){if(!this.BXIM.messenger.openlines)continue;if(!this.BXIM.messenger.openlines.queue)continue;this.BXIM.messenger.openlines.queue.sort(function(e,s){if(e.transfer_count>s.transfer_count){return-1}else if(e.transfer_count<s.transfer_count){return 1}else{if(e.id>s.id){return 1}else if(e.id<s.id){return-1}else{return 0}}});for(var Z=0;Z<this.BXIM.messenger.openlines.queue.length;Z++){if(n){var ee=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.openlines.queue[Z].name.toLowerCase().indexOf(P[z].toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[x].push(s.clone(this.BXIM.messenger.openlines.queue[Z]))}}else if(L[x].id=="structure"){if(L[x].skip){continue}for(var se in this.BXIM.messenger.groups){if(!this.BXIM.messenger.userInGroup[se]||this.BXIM.messenger.userInGroup[se].length<=0)continue;if(i=="popupChatDialogContactListElements"&&this.BXIM.messenger.userInGroup[se].length>200)continue;if(!C&&se.toString().substr(0,2)=="SG")continue;if(n){var ee=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.groups[se].name.toLowerCase().indexOf(P[z].toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[x].push(this.BXIM.messenger.groups[se])}G[x].sort(s.delegate(function(e,s){var t=e.id;var r=s.id;if(this.BXIM.messenger.userInGroup[t]&&this.BXIM.messenger.userInGroup[t].users.indexOf(this.BXIM.userId.toString())>-1){t=-1}if(this.BXIM.messenger.userInGroup[r]&&this.BXIM.messenger.userInGroup[r].users.indexOf(this.BXIM.userId.toString())>-1){r=-1}if(t>r){return 1}else if(t<r){return-1}else{return 0}},this))}if(L[x].countElement>G[x].length){O+=G[x].length;k+=L[x].countElement-G[x].length}else{F.push(x);O+=L[x].countElement}}if(O<D){var te=0;var re=F.length;for(var x=0;x<k;x++){if(F[te]&&L[F[te]]){L[F[te]].countElement=L[F[te]].countElement+1}te=te==re-1?0:te+1}}for(var x=0;x<L.length;x++){if(L[x].skip)continue;if(n&&G[x].length<=0){if(!b||L[x].id!="extranet"){continue}}if(G[x].length<=0&&!(L[x].id=="private"||L[x].id=="open"||L[x].id=="chat"||b&&L[x].id=="extranet"))continue;t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[!g||L[x].id=="lines"||L[x].id=="call"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"?null:s.create("span",{attrs:{"data-type":L[x].id},props:{title:L[x].title,className:"bx-messenger-chatlist-group-add"}}),s.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:L[x].name})]}));if(G[x].length<=0){if(b&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:this.BXIM.bitrixIntranet?s.message("IM_SEARCH_B24"):s.message("IM_SEARCH_SITE")})]}))}continue}var ie=[];var ae=1;for(var ne=0;ne<G[x].length;ne++){var oe=ae<=L[x].countElement;ae++;if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="bot"||L[x].id=="ol"){var K=G[x][ne];ie.push(this.drawContactListElement({id:K.id,data:K,showLastMessage:false,showCounter:g,extraClass:oe?"":"bx-messenger-hide"}))}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){var le=G[x][ne];ie.push(this.drawContactListElement({id:"chat"+le.id,data:le,showLastMessage:false,showCounter:g,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else if(L[x].id=="olQueue"||L[x].id=="viQueue"){var he=G[x][ne];he.type=L[x].id;ie.push(this.drawContactListElement({id:"queue"+he.id,data:he,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else if(L[x].id=="structure"){var me=G[x][ne];ie.push(this.drawContactListElement({id:"structure"+me.id,data:me,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}}if(L[x].countElement<G[x].length){ie.push(s.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[s.create("span",{attrs:{"data-id":L[x].id,"data-text":s.message("IM_CL_MORE").replace("#COUNT#",G[x].length-L[x].countElement),"data-title":L[x].more},props:{title:L[x].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[L[x].id]?s.message("IM_CL_HIDE"):s.message("IM_CL_MORE").replace("#COUNT#",G[x].length-L[x].countElement)})]}))}if(ie.length>0){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[L[x].id]?" bx-messenger-chatlist-show-all":"")},children:ie}));if(b&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:s.message("IM_SEARCH_B24")})]}))}}}if(l){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-search"},html:s.message("IM_M_CL_SEARCH")}))}else if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}));X.empty()}return t};t.prototype.userHasPhone=function(e){return this.BXIM.messenger.users.hasOwnProperty(e)&&this.BXIM.messenger.users[e].phone_device||this.BXIM.messenger.phones.hasOwnProperty(e)&&(this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_MOBILE")||this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_PHONE")||this.BXIM.messenger.phones[e].hasOwnProperty("WORK_PHONE"))};t.prototype.prepareCommandList=function(e){e=typeof e=="string"?e:"";var t=s.clone(this.BXIM.messenger.command);var r=[];var i=[];for(var a=0;a<t.length;a++){if(this.BXIM.messenger.openChatFlag){if(s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}else{if(this.BXIM.messenger.currentTab==parseInt(t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}}for(var a=0;a<i.length;a++){r.push(i[a])}var n=[];var o="";for(var a=0;a<r.length;a++){if(e==""||r[a].command.indexOf(e)===1){if(this.BXIM.userExtranet&&!r[a].extranet)continue;if(!r[a].common){if(this.BXIM.messenger.openChatFlag){if(!s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),r[a].bot_id)){continue}}else if(this.BXIM.messenger.currentTab!=parseInt(r[a].bot_id)){continue}}if(r[a].context!=""){if(r[a].context=="chat"){if(!this.BXIM.messenger.openChatFlag){continue}}else if(r[a].context=="user"){if(this.BXIM.messenger.openChatFlag){continue}}else if(e==""){continue}}if(o!=r[a].category){o=r[a].category;n.push({type:"category",title:o})}if(r[a].command=="/>>"){r[a].command=">>"}r[a].type="item";n.push(r[a])}}return n};t.prototype.drawMessage=function(t,r,i,a){if(typeof r!="object"||this.BXIM.messenger.popupMessenger==null)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap;var o="default";var l=false;var h=true;var m=true;if(typeof t=="object"){l=true;o=t.placeholderName||"custom";n=t.placeholder;h=t.showKeyboard==false?false:true;m=t.showReply==false?false:true}else if(t!=this.BXIM.messenger.currentTab||t==0||!this.MobileActionEqual("DIALOG")){return false}if(r.dropDuplicate){var g=s.findChildByClassName(n,"bx-messenger-content-item-id-"+r.id);if(g){s.remove(g)}r.dropDuplicate=false}a=a==true;i=a?false:i;var I=false;var p=false;var c=r.params&&r.params.IS_EDITED=="Y";var d=r.params&&r.params.IS_DELETED=="Y";var M=d?s.message("IM_M_DELETED"):r.text;var u=r.id.toString().indexOf("temp")==0;var f=u&&r.retry;var B=r.senderId==0;var X=this.BXIM.ppServerStatus;var b=r.params&&r.params.MENU;if(u){M=this.decodeBbCode(M);M=M.replace(/(^https|^http|[^"]https|[^"]http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?/gi,function(e){if(!e.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||e.toLowerCase().indexOf("/docs/pub/")>0||e.toLowerCase().indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){return'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+e+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{return'<span class="bx-messenger-file-image"><a href="'+e+'" target="_blank" class="bx-messenger-file-image-src"><img src="'+e+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span>'}})}if(l){I=r.chatId&&this.BXIM.messenger.chat[r.chatId]?true:false;p=I&&r.chatId==this.BXIM.messenger.generalChatId;if(I&&this.BXIM.messenger.chat[r.chatId].type=="call"){X=false}else if(I&&this.BXIM.messenger.chat[r.chatId].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[r.chatId]);if(!(E=="livechat")){X=false}}else if(!I&&this.BXIM.messenger.bot[r.recipientId]&&this.BXIM.messenger.bot[r.recipientId].type=="network"){X=false}}else{if(r.senderId==this.BXIM.userId){if(this.BXIM.messenger.popupMessengerLastMessage>0&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage]&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage].recipientId==this.BXIM.messenger.currentTab){if(this.BXIM.messenger.popupMessengerLastMessage<r.id){this.BXIM.messenger.popupMessengerLastMessage=r.id}}else{this.BXIM.messenger.popupMessengerLastMessage=r.id}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat";I=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");p=I&&r.chatId==this.BXIM.messenger.generalChatId;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){X=false}else if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]);if(!(E=="livechat")){X=false}}else if(!this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="network"){X=false}}if(typeof r.params!="object"){r.params={}}if(r.params.DATE_TEXT){for(var C=0;C<r.params.DATE_TEXT.length;C++){if(r.params.DATE_TS&&r.params.DATE_TS[C]){M=M.split(r.params.DATE_TEXT[C]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[C]+'">'+r.params.DATE_TEXT[C]+"</span>")}}}var _=X&&typeof r.params.LIKE=="object"&&r.params.LIKE.length>0?r.params.LIKE.length:"";var S=X&&typeof r.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,r.params.LIKE);var T=this.diskDrawFiles(r.chatId,r.params.FILE_ID);if(T.length>0){T=s.create("div",{props:{className:"bx-messenger-file-box"+(M!=""?" bx-messenger-file-box-with-message":"")},children:T})}else{T=null}var v=m?this.drawMessageReply(r.id):null;var A=null;var y=[];if(r.params.ATTACH){for(var C=0;C<r.params.ATTACH.length;C++){y[C]=r.params.ATTACH[C]}var L=/\[ATTACH=([0-9]{1,})\]/gm;var N=[];while((N=L.exec(M))!==null){for(var C=0;C<y.length;C++){if(r.params.ATTACH[C].ID==N[1]){A=s.create("div",{props:{className:"bx-messenger-attach-box"},children:s.MessengerCommon.drawAttach(r.id,r.chatId,[y[C]])});M=M.replace("[ATTACH="+N[1]+"]",A.innerHTML);delete y[C]}}}}if(r.params.LINK_ACTIVE&&r.params.LINK_ACTIVE.length>0&&r.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString())<0){M=M.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}var x="";if(r.params.CLASS){x=r.params.CLASS}var R=null;if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){R=s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)})}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var D=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var w=D?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=w){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.popupMessengerLiveChatDelayedForm=D?w:null;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(w)},this),D?3e4:5e3)}}A=s.MessengerCommon.drawAttach(r.id,r.chatId,y);if(A.length>0){A=s.create("div",{props:{className:"bx-messenger-attach-box"},children:A})}else{A=null}var O=null;if(h&&r.params.KEYBOARD){O=this.drawKeyboard(r.recipientId,r.id,r.params.KEYBOARD)}var k=false;if(!T&&!A&&M.length<=0){k=true}if(r.system&&r.system=="Y"){B=true;r.senderId=0}var P=false;var U=this.BXIM.messenger.users[r.senderId];if(!B&&(typeof U=="undefined"||U.id<=0)){P=true;k=true}if(r.params&&U&&U.id>0&&(r.params.AVATAR||r.params.NAME||r.params.USER_ID)){U=s.clone(U);if(r.params.AVATAR){U.avatar=r.params.AVATAR}if(r.params.NAME){U.name=r.params.NAME;U.first_name=r.params.NAME.split(" ")[0]}r=s.clone(r);if(parseInt(r.params.USER_ID)){r.senderId="network"+r.params.USER_ID}}var H=this.linesVoteDraw(r.id);if(H){M=H;r.system="Y"}else{x=x.replace("bx-messenger-content-item-vote","");var G=this.linesVoteResultDraw(r.id,M);if(G){M=G}}if(!l){if(!this.BXIM.messenger.history[t])this.BXIM.messenger.history[t]=[];if(parseInt(r.id)>0&&this.BXIM.messenger.history[t].indexOf(r.id.toString())==-1)this.BXIM.messenger.history[t].push(r.id);var F=0;if(!P){var j=false;if(this.BXIM.messenger.unreadMessage[t]&&s.util.in_array(r.id,this.BXIM.messenger.unreadMessage[t]))j=true}}var V=false;var Y=null;if(a){Y=n.firstChild;if(Y){if(s.hasClass(Y,"bx-messenger-content-empty")||s.hasClass(Y,"bx-messenger-content-load")){s.remove(Y)}else if(s.hasClass(Y,"bx-messenger-content-group")){Y=Y.nextSibling}}}else{Y=n.lastChild;if(Y&&(s.hasClass(Y,"bx-messenger-content-empty")||s.hasClass(Y,"bx-messenger-content-load"))){s.remove(Y)}else if(Y&&s.hasClass(Y,"bx-messenger-content-item-notify")){if(r.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(Y);V=false;Y=n.lastChild}else{V=true;Y=n.lastChild.previousSibling}}}if(!P){var W=this.formatDate(r.date,this.getDateFormatType("MESSAGE_TITLE"));var K=typeof s.translit!="undefined"?s.translit(W):W;if(typeof this.messageGroup!="object"){this.messageGroup={}}if(typeof this.messageGroup[o]!="object"){this.messageGroup[o]={}}if(!this.messageGroup[o][K]){this.messageGroup[o][K]=true;var J=[];if(this.BXIM.desktop&&this.isPage()){J=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+K,href:"#bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:W})]}else{J=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+K},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:W})]}var q=s.create("div",{props:{className:"bx-messenger-content-group"+(W==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:J});if(a){n.insertBefore(q,n.firstChild);Y=q.nextSibling}else{if(V&&Y.nextElementSibling){n.insertBefore(q,Y.nextElementSibling);Y=q}else{n.appendChild(q)}}}}var Q=false;var z=false;var $=null;if(typeof M=="string"){if(M.length>0){var Z=M.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1").replace(/<\/?[^>]+>/gi," ").replace(/(https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?/gi,function(e){return""}).trim();if(!Z){Q=true}}if(this.BXIM.settings.enableRichLink&&r.params.URL_ONLY=="Y"&&r.params.URL_ID&&r.params.URL_ID.length>0&&r.params.ATTACH&&r.params.ATTACH.length>0){z=true}var ee={oneSmileInMessage:false};$=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},html:this.prepareText(M,false,true,true,!this.BXIM.messenger.openChatFlag||r.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name,ee)});var se=ee.oneSmileInMessage}else{$=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},children:[M]});var se=false}if(!k){if(Y)F=Y.getAttribute("data-messageId");if(B){var te=s.create("div",{attrs:{"data-type":"system","data-senderId":"0","data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-notice "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+(z&&!d?" bx-messenger-content-item-content-rich-link":"")+(d||c?" bx-messenger-message-edited":"")},children:[!p?[]:s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),typeof U=="undefined"||U.id<=0?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(d?" bx-messenger-message-deleted":" ")},children:[T,$,A]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]});if(r.system&&r.system=="Y"&&j)s.addClass(te,"bx-messenger-content-item-new")}else if(r.senderId==this.BXIM.userId){var te=s.create("div",{attrs:{"data-type":"self","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-1 "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+(z&&!d?" bx-messenger-content-item-content-rich-link":"")+(d||c?" bx-messenger-message-edited":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),f?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":r.id,"data-chat":parseInt(r.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:u?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(d?" bx-messenger-message-deleted":" ")},children:[T,$,A]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:f?s.message("IM_M_NOT_DELIVERED"):this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]})}else{var te=s.create("div",{attrs:{"data-type":"other","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-2"+(j?" bx-messenger-content-item-new":"")+" "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+(z&&!d?" bx-messenger-content-item-content-rich-link":"")+(d||c?" bx-messenger-message-edited":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),s.create("span",{attrs:{title:s.util.htmlspecialcharsback(U.name)},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag||U.bot?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(d?" bx-messenger-message-deleted":" ")},children:[T,$,A]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]})}}else if(P){te=s.create("div",{attrs:{id:"im-message-"+r.id,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(te&&(!k||P)){var re=null;if(Y&&Y.getAttribute("data-senderId")!=r.senderId){re=s.create("div",{props:{className:"bx-messenger-item-delimiter"}})}if(a){n.insertBefore(te,Y);if(re){n.insertBefore(re,Y)}}else if(V&&Y&&Y.nextElementSibling){n.insertBefore(te,Y.nextElementSibling);if(re){n.insertBefore(re,Y.nextElementSibling)}}else{if(re){n.appendChild(re)}n.appendChild(te)}}if(!l&&!P&&i!==false&&this.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}if(r.params.SENDING=="Y"||r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}return F};t.prototype.drawMessageReply=function(e){var t=null;if(!(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.CHAT_ID>0)){return t}var r=this.BXIM.messenger.message[e].params.CHAT_ID;var i=this.BXIM.messenger.message[e].chatId;var a=[];var n=this.BXIM.messenger.message[e].params.CHAT_USER||[];var o=0;for(var l=n.length-1;l>=0;l--){if(!this.BXIM.messenger.users[n[l]]||!this.BXIM.messenger.userInChat[i]||this.BXIM.messenger.userInChat[i].indexOf(n[l])==-1&&this.BXIM.messenger.userInChat[i].indexOf(n[l].toString())==-1){continue}var h=this.isBlankAvatar(this.BXIM.messenger.users[n[l]].avatar)?this.BXIM.messenger.users[n[l]].color:"transparent";a.push(s.create("span",{props:{className:"bx-messenger-panel-chat-user"},children:[s.create("span",{props:{className:"bx-notifier-popup-avatar"},children:[s.create("img",{props:{className:"bx-notifier-popup-avatar-img"+(this.isBlankAvatar(this.BXIM.messenger.users[n[l]].avatar)?" bx-notifier-popup-avatar-img-default":"")},attrs:{src:this.formatUrl(this.BXIM.messenger.users[n[l]].avatar)},style:{backgroundColor:h}})]})]}));o++;if(o==5){break}}var m=this.BXIM.messenger.message[e].params.CHAT_LAST_DATE?new Date(this.BXIM.messenger.message[e].params.CHAT_LAST_DATE):"";var g=this.BXIM.messenger.message[e].params.CHAT_MESSAGE||0;t=s.create("div",{props:{className:"bx-messenger-content-reply"},attrs:{id:"im-message-content-reply-"+e,"data-messageId":e,"data-chatid":r},children:[s.create("span",{props:{className:"bx-messenger-content-reply-block"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-comment"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-answer"},events:{click:s.delegate(function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":e,"data-chatId":r},html:g+" "+this.getMessagePlural("IM_R_COMMENT",g)}),s.create("span",{props:{className:"bx-messenger-content-reply-date"},html:m?", "+this.formatDate(m):""})]}),s.create("span",{props:{className:"bx-messenger-content-reply-users"},children:a}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]}),s.create("span",{props:{className:"bx-messenger-content-reply-join"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-join-button"},html:s.message("IM_M_OPEN"),events:{click:s.delegate(function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":e,"data-chatId":r}})]}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]});return t};t.prototype.joinParentChat=function(e,t){if(!e||!t)return false;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)}else{this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?PARENT_CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_PARENT_CHAT_JOIN:"Y",CHAT_ID:t,MESSAGE_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)})}};t.prototype.openReplyDialog=function(e){if(this.isMobile()){alert(s.message("IM_AV_NEXT_VERSION"));return false}this.BXIM.messenger.openMessengerPanel();this.BXIM.messenger.popupMessengerBodyPanelTitleName.innerHTML=s.message("IM_R_DIALOG_TITLE");var t=this.drawMessageReply(e);if(t){this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML="";this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.appendChild(t)}else{this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML=s.message("IM_R_COMMENT_ZERO")}this.BXIM.messenger.popupMessengerBodyPanelWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyPanelWrap,{children:[this.BXIM.messenger.popupMessengerBodyPanelWrapMessage=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message"}}),this.BXIM.messenger.popupMessengerBodyPanelWrapMessages=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-list"}}),s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-textarea"},children:[this.popupMessengerTextareaPlace=s.create("div",{props:{className:"bx-messenger-textarea-place"},children:[s.create("div",{props:{className:"bx-messenger-textarea-send"},children:[s.create("a",{attrs:{href:"#send"},props:{className:"bx-messenger-textarea-send-button"},events:{click:s.delegate(this.sendMessage,this)}})]}),this.popupMessengerBodyPanelSmileButton=s.create("div",{attrs:{title:s.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:s.delegate(function(e){this.openSmileMenu();return s.PreventDefault(e)},this)}}),s.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerPanelTextarea=s.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"}}),this.popupMessengerPanelTextareaPlaceholder=s.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:s.message("IM_M_TA_TEXT")})]}),s.create("div",{props:{className:"bx-messenger-textarea-clear"}})]})]})]});if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["reply"]={};this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessage,placeholderName:"reply",showKeyboard:false,showReply:false},this.BXIM.messenger.message[e]);if(t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_LOAD_COMMENT")+"</span></div>"}else{this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_NO_COMMENT")+"</span></div>"}this.messageGroup["replyMessages"]={};if(t){setTimeout(s.delegate(function(){if(!this.BXIM.messenger.message[e]||this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.CHAT_ID<=0){return false}var t="chat"+this.BXIM.messenger.message[e].params.CHAT_ID;this.loadLastMessage(t,s.delegate(function(e,t,r){if(!t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_F_ERROR")+"</span></div>";return false}this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML="";var i=s.util.shuffle(this.BXIM.messenger.showMessage[e]);for(var a=0;a<i.length;a++){this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessages,placeholderName:"replyMessages",showKeyboard:false,showReply:false},this.BXIM.messenger.message[i[a]])}},this))},this),1e3)}return true};t.prototype.checkProgessMessage=function(){for(messageId in this.BXIM.messenger.popupMessengerSendingTimeout){if(!this.BXIM.messenger.message[messageId]||!this.BXIM.messenger.message[messageId].params||!this.BXIM.messenger.message[messageId].params.SENDING_TS){delete this.BXIM.messenger.popupMessengerSendingTimeout[messageId]}else if(parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+86400<(new Date).getTime()/1e3){this.drawProgessMessage(messageId)}}};t.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.MessengerTimer.start("progressMessage",e,5e3,function(e){var t=s("im-message-"+e);if(!t)return false;s.addClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start")});r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";var i=true;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+86400<(new Date).getTime()/1e3||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];this.BXIM.messenger.message[e].params.IS_DELIVERED="N";this.BXIM.messenger.message[e].params.SENDING="N";this.BXIM.messenger.message[e].params.SENDING_TS=0;i=false;var a=s.findChildByClassName(r.parentNode.parentNode.parentNode,"bx-messenger-content-item-date");if(a)a.innerHTML=s.message("IM_M_NOT_DELIVERED")}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.SENDING=="Y"){this.BXIM.messenger.popupMessengerSendingTimeout[e]=this.BXIM.messenger.message[e].params.SENDING_TS}if(!i){if(this.BXIM.messenger.message[e]){s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerTimer.stop("progressMessage",e,true)}}else if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerTimer.stop("progressMessage",e,true);t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};t.prototype.clearProgessMessage=function(e){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];var t=s("im-message-"+e);if(!t)return false;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){return false}s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};t.prototype.startWriting=function(e,t,r){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate(function(){this.endWriting(e)},this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate(function(){this.endWriting(e,t)},this),29500)}};t.prototype.drawWriting=function(t,r,i){i=typeof i=="undefined"?true:i;if(r==this.BXIM.userId)return false;if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)>0){var a=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||r&&this.BXIM.messenger.currentTab==r)){if(r){var o=[];for(var n in this.BXIM.messenger.writingList[r]){if(this.BXIM.messenger.writingList[r].hasOwnProperty(n)&&this.BXIM.messenger.users[n]){o.push(this.BXIM.messenger.users[n].name)}}this.drawNotifyMessage(r,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",o.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[t].name))}}}else if(!this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)==0){var a=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||this.BXIM.messenger.currentTab==r)){if(!r){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(this.BXIM.messenger.users[t])}var l=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(l&&s.hasClass(l,"bx-messenger-content-item-notify")&&this.BXIM.messenger.popupMessengerBody){if(!r&&this.BXIM.messenger.readedList[t]){this.drawReadMessage(t,this.BXIM.messenger.readedList[t].messageId,this.BXIM.messenger.readedList[t].date,false)}else if(r&&this.BXIM.messenger.readedList[r]){this.drawReadMessageChat(r,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this),complete:s.delegate(function(){s.remove(l)},this)})).animate()}else if(i){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}}}}};t.prototype.endWriting=function(e,s,t){t=typeof t=="undefined"?true:t;if(s.toString().substr(0,4)=="chat"){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s,t)};t.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus||t=="create"||t==this.BXIM.userId)return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;var r="N";if(t.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t.toString().substr(4)]){r="Y"}s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,OL_SILENT:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}},this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate(function(){this.endSendWriting(t)},this),3e4)}};t.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};t.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};t.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){if(this.BXIM.messenger.chat[e].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e]}this.recentListHide("chat"+e,false);this.userListRedraw();this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}else{s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.readMessage("chat"+e.CHAT_ID,true,false);if(this.BXIM.messenger.chat[e.CHAT_ID].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.showMessage[e.CHAT_ID];delete this.BXIM.messenger.userInChat[e.CHAT_ID];delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];delete this.BXIM.messenger.chat[e.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var t=0;t<this.BXIM.messenger.userInChat[e.CHAT_ID].length;t++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e.CHAT_ID][t])){delete this.BXIM.messenger.userInChat[e.CHAT_ID][t];break}}delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}this.recentListHide("chat"+e.CHAT_ID,false);this.userListRedraw();s.localStorage.set("mcl",e.CHAT_ID,5);this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}},this)})}};t.prototype.isSlider=function(){return location.href.toString().indexOf("SIDE_SLIDER")>0};t.prototype.closeSlider=function(){if(!this.isSlider()){return false}s.SidePanel.Instance.close();return true};t.prototype.dialogCloseCurrent=function(e){if(this.closeSlider()){return true}this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()};t.prototype.pullEvent=function(){var t=s.delegate(function(t,r,i){if(this.isMobile()){if(this.BXIM.webComponent&&!this.BXIM.checkRevision(i.revision_im_mobile)){return false}}else if(!this.BXIM.checkRevision(i.revision_im_web)){return false}if(t=="generalChatId"){this.BXIM.messenger.generalChatId=r.id}else if(t=="updateSettings"){for(var a in r){this.BXIM.settings[a]=r[a]}}else if(t=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&r.status=="blocked"){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}else if(this.isDesktop()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}}else if(t=="desktopOffline"){this.BXIM.desktopStatus=false}else if(t=="desktopOnline"){this.BXIM.desktopStatus=true}else if(t=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(r.userId,false,false,true)}else if(t=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage("chat"+r.chatId,false,false,true)}else if(t=="readMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}this.BXIM.messenger.readedList["chat"+r.chatId][r.userId]={messageId:r.lastId,date:new Date(r.date)};this.drawReadMessageChat("chat"+r.chatId)}else if(t=="readMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.drawReadMessage(r.userId,r.lastId,new Date(r.date));if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="unreadMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;var o=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(o&&s.hasClass(o,"bx-messenger-content-item-notify")){if(r.userId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(o)}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="unreadMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}delete this.BXIM.messenger.readedList["chat"+r.chatId][r.userId];this.drawReadMessageChat("chat"+r.chatId);if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.isBot(r.userId)&&!r.DEFERRED&&this.BXIM.messenger.showMessage[r.dialogId]&&this.BXIM.messenger.showMessage[r.dialogId].length){var l=this.BXIM.messenger.bot[r.userId];if(l.type=="human"){var h=s.clone({command:t,params:r,extra:i});setTimeout(s.delegate(function(){h.params.DEFERRED=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[h])}else{s.onCustomEvent(e,"onPullEvent-im",[h.command,h.params,h.extra])}},this),1e3);return false}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}this.startWriting(r.userId,r.dialogId,r.userName)}else if(t=="addBot"||t=="updateBot"){if(this.BXIM.userExtranet)return false;this.BXIM.messenger.bot[r.bot.id]=r.bot;r.user.last_activity_date=new Date(r.user.last_activity_date);r.user.mobile_last_date=new Date(r.user.mobile_last_date);r.user.idle=r.user.idle?new Date(r.user.idle):false;r.user.absent=r.user.absent?new Date(r.user.absent):false;this.BXIM.messenger.users[r.user.id]=r.user;if(typeof r.userInGroup!="undefined"){for(var a in r.userInGroup){if(typeof this.BXIM.messenger.userInGroup[a]=="undefined"||typeof this.BXIM.messenger.userInGroup[a].users=="undefined"||!this.BXIM.messenger.userInGroup[a].users.length){this.BXIM.messenger.userInGroup[a]=r.userInGroup[a]}else{for(var m=0;m<r.userInGroup[a].users.length;m++)this.BXIM.messenger.userInGroup[a].users.push(r.userInGroup[a].users[m]);this.BXIM.messenger.userInGroup[a].users=s.util.array_unique(this.BXIM.messenger.userInGroup[a].users)}}}}else if(t=="updateUser"){r.user.last_activity_date=new Date(r.user.last_activity_date);r.user.mobile_last_date=new Date(r.user.mobile_last_date);r.users[a].idle=r.users[a].idle?new Date(r.users[a].idle):false;r.users[a].absent=r.users[a].absent?new Date(r.users[a].absent):false;this.BXIM.messenger.users[r.user.id]=r.user;this.BXIM.messenger.redrawChatHeader()}else if(t=="deleteBot"){if(this.BXIM.messenger.bot[r.botId]){delete this.BXIM.messenger.bot[r.botId]}if(this.BXIM.messenger.users[r.botId]){delete this.BXIM.messenger.users[r.botId]}this.recentListHide(r.botId,false);if(this.BXIM.messenger.currentTab==r.botId){this.BXIM.messenger.openMessenger("general")}}else if(t=="chatMuteNotify"){this.muteMessageChat(r.dialogId,r.mute,false)}else if(t=="message"||t=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!r.deferred&&this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){return false}if(r.message.senderId!=this.BXIM.userId){s.onCustomEvent("onImMessageReceive",[{command:t,params:r}])}var g=r.message.senderId;if(r.message.recipientId.toString().substr(0,4)=="chat"){g=r.message.recipientId}if(this.sendBotCommandBlock[r.message.senderId]){for(var I in this.sendBotCommandBlock[r.message.senderId]){delete this.sendBotCommandBlock[r.message.senderId][I];var p=s("im-message-keyboard-"+I);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}if(this.isBot(r.message.senderId)&&!r.deferred&&this.BXIM.messenger.showMessage[g]&&this.BXIM.messenger.showMessage[g].length){var l=this.BXIM.messenger.bot[r.message.senderId];if(l.type=="human"){if(r.chat[g]&&r.chat[g].entity_type=="LINES"){d=1e3}else{var d=r.message.text.split(" ").length*300+1e3;if(d>5e3){d=5e3}}var h=s.clone({command:t,params:r,extra:i,waitTime:d});setTimeout(s.delegate(function(){h.params.deferred=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[h])}else{s.onCustomEvent(e,"onPullEvent-im",[h.command,h.params,h.extra])}},this),d);return false}}var M={};M.MESSAGE={};M.USERS_MESSAGE={};r.message.date=new Date(r.message.date);for(var a in r.chat){r.chat[a].date_create=new Date(r.chat[a].date_create);this.BXIM.messenger.chat[a]=r.chat[a]}for(var a in r.userInChat){this.BXIM.messenger.userInChat[a]=r.userInChat[a]}for(var a in r.userBlockChat){this.BXIM.messenger.userChatBlockStatus[a]=r.userBlockChat[a]}var u={};for(var a in r.users){if(this.BXIM.messenger.users[a]&&this.BXIM.messenger.users[a].status!=r.users[a].status&&Math.round(r.message.date.getTime()/1e3)+180>Math.round(new Date/1e3)){u[a]=this.BXIM.messenger.users[a].status;this.BXIM.messenger.users[a].status=r.users[a].status}}if(this.MobileActionEqual("RECENT")){for(var a in u){if(!this.BXIM.messenger.users[a])continue;var f=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+a);if(f!=null){for(var m=0;m<f.length;m++){var B=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(f[m],"bx-messenger-cl-status-"+u[a]);s.addClass(f[m],"bx-messenger-cl-status-"+B);f[m].setAttribute("data-status",B)}}var f=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+a);if(f!=null){for(var m=0;m<f.length;m++){var B=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(f[m],"bx-messenger-cl-status-"+u[a]);s.addClass(f[m],"bx-messenger-cl-status-"+B);f[m].setAttribute("data-status",B)}}}}f=null;M.USERS=r.users;if(this.MobileActionEqual("DIALOG")){for(var a in r.files){if(!this.BXIM.disk.files[r.chatId])this.BXIM.disk.files[r.chatId]={};if(this.BXIM.disk.files[r.chatId][a])continue;r.files[a].date=new Date(r.files[a].date);this.BXIM.disk.files[r.chatId][a]=r.files[a]}}M.MESSAGE[r.message.id]=r.message;this.BXIM.lastRecordId=parseInt(r.message.id)>this.BXIM.lastRecordId?parseInt(r.message.id):this.BXIM.lastRecordId;var X=r.message.text;if(!X||X.length<=0){if(r.message.params&&r.message.params.FILE_ID&&r.message.params.FILE_ID.length>0){X="["+s.message("IM_F_FILE")+"]"}else if(r.message.params&&r.message.params.ATTACH&&r.message.params.ATTACH.length>0){X="["+s.message("IM_F_ATTACH")+"]"}else{X=s.message("IM_M_DELETED")}}if(r.message.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0&&r.message.system!="Y"||this.BXIM.messenger.message[r.message.id]){return}if(this.isMobile()){if(r.message.params["FILE_ID"]&&r.message.params["FILE_ID"].length>0){var b=false;r.message.params["FILE_ID"].forEach(function(e){if(this.BXIM.disk.messageBlock[e]){delete this.BXIM.disk.messageBlock[e];b=true}}.bind(this));if(b){return}}}this.readMessage(r.message.recipientId,false,false);M.USERS_MESSAGE[r.message.recipientId]=[r.message.id];this.updateStateVar(M);s.MessengerCommon.recentListAdd({userId:r.message.recipientId,id:r.message.id,date:r.message.date,recipientId:r.message.recipientId,senderId:r.message.system=="Y"?0:r.message.senderId,text:X,userIsChat:t=="messageChat",params:r.message.params},true)}else{M.UNREAD_MESSAGE={};if(r.notify===true||r.notify.indexOf(parseInt(this.BXIM.userId))>-1){M.UNREAD_MESSAGE[t=="messageChat"?r.message.recipientId:r.message.senderId]=[r.message.id]}M.USERS_MESSAGE[t=="messageChat"?r.message.recipientId:r.message.senderId]=[r.message.id];if(t=="message")this.endWriting(r.message.senderId,0,false);else this.endWriting(r.message.senderId,r.message.recipientId,false);if(t=="messageChat"&&!s.MessengerCommon.userInChat(r.message.chatId)){this.updateStateVar(M);return}else{this.updateStateVar(M);var E=r.notify!==true&&r.notify.indexOf(parseInt(this.BXIM.userId))==-1?this.inRecentList(t=="messageChat"?r.message.recipientId:r.message.senderId):true;if(E){this.recentListAdd({userId:t=="messageChat"?r.message.recipientId:r.message.senderId,id:r.message.id,date:r.message.date,recipientId:r.message.recipientId,senderId:r.message.senderId,text:X,userIsChat:t=="messageChat",params:r.message.params},true)}}}s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else if(t=="messageDeleteComplete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.message[r.id])return false;var g=0;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(g,0,false)}else{g="chat"+r.chatId;this.endWriting(r.senderId,g,false)}if(this.BXIM.messenger.currentTab==g&&s("im-message-"+r.id)){var C=s("im-message-"+r.id).parentNode.parentNode.parentNode.parentNode.parentNode;if(C.getAttribute("data-messageId")==C.getAttribute("data-blockMessageId")){s.remove(C)}else{C=s("im-message-"+r.id).parentNode;if(C.nextSibling&&s.hasClass(C.nextSibling,"bx-messenger-hr")){s.remove(C.nextSibling)}else if(!C.nextSibling&&s.hasClass(C.previousSibling,"bx-messenger-hr")){s.remove(C.previousSibling)}s.remove(C)}}this.recentListElementUpdate(g,r.id,r.text);if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();delete this.BXIM.messenger.message[r.id];this.BXIM.messenger.showMessage[g].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this))}else if(t=="messageUpdate"||t=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var _ in this.sendBotCommandBlock){if(this.sendBotCommandBlock[_][r.id]){delete this.sendBotCommandBlock[_][r.id];var p=s("im-message-keyboard-"+r.id);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}if(this.BXIM.messenger.message[r.id]){if(!this.BXIM.messenger.message[r.id].params)this.BXIM.messenger.message[r.id].params={};var g=0;if(t=="messageDelete"){r.text=s.message("IM_M_DELETED");if(!this.BXIM.messenger.message[r.id].params){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.IS_DELETED="Y"}else if(t=="messageUpdate"){this.BXIM.messenger.message[r.id].params=r.params}this.BXIM.messenger.message[r.id].text=r.text;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(g,0,false)}else{g="chat"+r.chatId;this.endWriting(r.senderId,g,false)}this.recentListElementUpdate(g,r.id,r.text);if(this.BXIM.messenger.currentTab==g&&s("im-message-"+r.id)){var S=s("im-message-"+r.id);if(r.params&&r.params.IS_EDITED=="Y"){s.addClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited")}var T=false;if(t=="messageDelete"){s.addClass(S.parentNode,"bx-messenger-message-deleted");var v=s("im-message-keyboard-"+r.id);s.remove(v);s.removeClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(t=="messageUpdate"){if(r.params){if(r.params.DATE_TEXT){var A=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var a=0;a<r.params.DATE_TEXT.length;a++){A=A.split(r.params.DATE_TEXT[a]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[a]+'">'+r.params.DATE_TEXT[a]+"</span>")}S.innerHTML=A;T=true}if(r.params.IS_EDITED=="Y"){s.removeClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding")}if(r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{s.removeClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params.ATTACH){var y=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(S.nextElementSibling&&s.hasClass(S.nextElementSibling,"bx-messenger-attach-box")){S.nextElementSibling.innerHTML="";if(y.length>0){s.adjust(S.nextElementSibling,{children:y})}}else if(y.length>0){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:y});if(S.nextElementSibling){S.parentNode.insertBefore(y,S.nextElementSibling)}else{S.parentNode.appendChild(y)}}}if(r.params.KEYBOARD){var p=s("im-message-keyboard-"+r.id);var L=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(p){p.innerHTML=L?L.innerHTML:""}}}else if(typeof r.params!="undefined"&&r.params==""){if(S.nextElementSibling&&s.hasClass(S.nextElementSibling,"bx-messenger-attach-box")){s.remove(S.nextElementSibling)}}}if(!T){S.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true)}s.addClass(S,"bx-messenger-message-edited-anim");if(S.previousSibling&&s.hasClass(S.previousSibling,"bx-messenger-file-box")){s.addClass(S.previousSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(S,"bx-messenger-message-edited-anim")},this),1e3)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw()}}else if(t==="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG"))return false;if(!this.BXIM.messenger.message[r.id])return false;if(this.BXIM.messenger.message[r.id].params&&this.BXIM.messenger.message[r.id].params.IS_DELETED=="Y")return false;var N=typeof r.animation=="undefined"?null:r.animation;for(var _ in this.sendBotCommandBlock){if(this.sendBotCommandBlock[_][r.id]){delete this.sendBotCommandBlock[_][r.id];var p=s("im-message-keyboard-"+r.id);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}this.BXIM.messenger.message[r.id].params=r.params;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId?r.toUserId:r.fromUserId}else{g="chat"+r.chatId}var S=s("im-message-"+r.id);if(this.BXIM.messenger.currentTab==g&&S){var x=S.parentNode.parentNode.parentNode.parentNode.parentNode;if(r.params){if(r.params.DATE_TEXT){var A=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var a=0;a<r.params.DATE_TEXT.length;a++){A=A.split(r.params.DATE_TEXT[a]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[a]+'">'+r.params.DATE_TEXT[a]+"</span>")}S.innerHTML=A}if(r.params.FILE_ID){var R=s.MessengerCommon.diskDrawFiles(this.BXIM.messenger.message[r.id].chatId,r.params.FILE_ID);if(S.previousElementSibling&&s.hasClass(S.previousElementSibling,"bx-messenger-file-box")){S.previousElementSibling.innerHTML="";if(R.length>0){s.adjust(S.previousElementSibling,{children:R})}}else if(R.length>0){R=s.create("div",{props:{className:"bx-messenger-file-box"+(r.text!=""?" bx-messenger-file-box-with-message":"")},children:R});if(S.previousElementSibling){S.parentNode.insertBefore(R,S.previousElementSibling)}else{S.parentNode.insertBefore(R,S)}}if(S.innerHTML!=""&&S.previousElementSibling&&s.hasClass(S.previousElementSibling,"bx-messenger-file-box")){s.addClass(S.previousElementSibling,"bx-messenger-file-box-with-message")}}if(r.params.ATTACH){var y=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(S.nextElementSibling&&s.hasClass(S.nextElementSibling,"bx-messenger-attach-box")){S.nextElementSibling.innerHTML="";if(y.length>0){s.adjust(S.nextElementSibling,{children:y})}}else if(y.length>0){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:y});if(S.nextElementSibling){S.parentNode.insertBefore(y,S.nextElementSibling)}else{S.parentNode.appendChild(y)}}if(N!="N"){N="Y"}}if(r.params.KEYBOARD){var p=s("im-message-keyboard-"+r.id);var L=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(p){p.innerHTML=L?L.innerHTML:""}if(N!="N"){N="Y"}}if(r.params.CHAT_USER||r.params.CHAT_ID||r.params.CHAT_MESSAGE||r.params.CHAT_LAST_DATE){var D=s("im-message-content-reply-"+r.id);var w=s.MessengerCommon.drawMessageReply(r.id);if(D){D.innerHTML=w?w.innerHTML:""}}if(r.params&&r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(r.params&&r.params.URL_ONLY=="N"){s.removeClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params&&r.params.IS_EDITED=="Y"){s.removeClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding");s.addClass(S.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited");if(N!="N"){N="Y"}}}else if(typeof r.params!="undefined"&&r.params==""){if(S.nextElementSibling&&s.hasClass(S.nextElementSibling,"bx-messenger-attach-box")){s.remove(S.nextElementSibling);if(N!="N"){N="Y"}}}if(r.params&&typeof r.params.CLASS!="undefined"){var O=s.findParent(S,{className:"bx-messenger-content-item"});s.addClass(O,r.params.CLASS)}if(r.params&&typeof r.params.MENU!="undefined"){var O=s.findParent(S,{className:"bx-messenger-content-item"});var k=s.findChildByClassName(O,"bx-messenger-content-item-menu");if(!r.params.MENU||r.params.MENU=="N"||r.params.MENU.length<=0){s.removeClass(k,"bx-messenger-content-item-menu-with-apps")}else{s.addClass(k,"bx-messenger-content-item-menu-with-apps")}}if(r.params&&r.params.IS_DELIVERED){if(r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params&&r.params.SENDING){if(r.params.SENDING=="Y"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){var P=s.findChildByClassName(x,"bx-messenger-message-extra");if(!P){x.insertBefore(s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)}),x.firstChild);if(this.isElementVisibleOnScreen(x,BXIM.messenger.popupMessengerBody)){this.linesBodyScroll()}}}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var U=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var H=U?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=H){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(H)},this),U?3e4:5e3)}}if(r.params.IMOL_VOTE&&S){var G=this.linesVoteDraw(r.id);if(G){s.cleanNode(S);S.appendChild(G)}if(N!="N"){N="Y"}}else if(typeof r.params.IMOL_VOTE_SID!="undefined"&&S){var X=s.findChildByClassName(S,"bx-messenger-content-item-vote-message-text");if(X){var G=this.linesVoteResultDraw(r.id,X.innerHTML);if(G){s.cleanNode(S);S.appendChild(G)}}}if(N=="Y"){s.addClass(S,"bx-messenger-message-edited-anim");setTimeout(s.delegate(function(){s.removeClass(S,"bx-messenger-message-edited-anim")},this),1e3)}}}else if(t=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var F=s.util.in_array(this.BXIM.userId,r.users);var j=r.users.length>0?r.users.length:"";if(!this.BXIM.messenger.message[r.id]){return false}if(typeof this.BXIM.messenger.message[r.id].params!="object"){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.LIKE=r.users;if(s("im-message-"+r.id)){var V=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.id+""}},false);if(V){var Y=s.findChildByClassName(V,"bx-messenger-content-item-like");if(Y){var W=s.findChildByClassName(Y,"bx-messenger-content-like-digit",false);var K=s.findChildByClassName(Y,"bx-messenger-content-like-button",false);if(F){s.addClass(Y,"bx-messenger-content-item-liked")}else{s.removeClass(Y,"bx-messenger-content-item-liked")}if(j>0){W.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(W.parentNode,"bx-messenger-content-like-digit-off")}else{W.setAttribute("title","");s.addClass(W.parentNode,"bx-messenger-content-like-digit-off")}if(W.innerHTML<j){var J=s.findChildByClassName(V,"bx-messenger-content-item-content",false);s.addClass(J,"bx-messenger-content-item-plus-like");setTimeout(function(){s.removeClass(J,"bx-messenger-content-item-plus-like")},500)}W.innerHTML=j}}}}else if(t=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[r.fileTmpId])return false;r.fileParams.date=new Date(r.fileParams.date);if(this.BXIM.disk.files[r.fileChatId]&&this.BXIM.disk.files[r.fileChatId][r.fileId]){r.fileParams["preview"]=this.BXIM.disk.files[r.fileChatId][r.fileId]["preview"]}if(!this.BXIM.disk.files[r.fileChatId])this.BXIM.disk.files[r.fileChatId]={};this.BXIM.disk.files[r.fileChatId][r.fileId]=r.fileParams;this.diskRedrawFile(r.fileChatId,r.fileId);if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else if(this.BXIM.messenger.popupMessengerBody){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(t=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var q in r.files){if(this.BXIM.disk.filesRegister[r.chatId]){delete this.BXIM.disk.filesRegister[r.chatId][r.files[q]]}if(this.BXIM.disk.files[r.chatId]&&this.BXIM.disk.files[r.chatId][r.files[q]]){this.BXIM.disk.files[r.chatId][r.files[q]].status="error";s.MessengerCommon.diskRedrawFile(r.chatId,r.files[q])}delete this.BXIM.disk.filesProgress[q]}this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="fileDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;delete this.BXIM.disk.files[r.chatId][r.fileId];this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].name=s.util.htmlspecialchars(r.name);this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(r.chatId,r.avatar)}else if(t=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].color=r.color;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatHide"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.recentListHide(r.dialogId,false);if(!this.isMobile()&&r.dialogId==this.currentTab){s.MessengerCommon.dialogCloseCurrent()}}else if(t=="chatPin"){if(this.MobileActionNotEqual("RECENT"))return false;this.recentListElementPin(r.dialogId,r.active)}else if(t=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var a in r.users){r.users[a].last_activity_date=new Date(r.users[a].last_activity_date);r.users[a].mobile_last_date=new Date(r.users[a].mobile_last_date);r.users[a].idle=r.users[a].idle?new Date(r.users[a].idle):false;r.users[a].absent=r.users[a].absent?new Date(r.users[a].absent):false;this.BXIM.messenger.users[a]=r.users[a]}if(!this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId]={id:r.chatId,name:r.chatId,owner:r.chatOwner,extranet:r.chatExtranet,fake:true,date_create:""}}else{this.BXIM.messenger.chat[r.chatId].extranet=r.chatExtranet;if(this.BXIM.messenger.userInChat[r.chatId]){for(a=0;a<r.newUsers.length;a++)this.BXIM.messenger.userInChat[r.chatId].push(r.newUsers[a])}else this.BXIM.messenger.userInChat[r.chatId]=r.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatOwner"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[r.chatId])return false;this.BXIM.messenger.chat[r.chatId].owner=r.userId;if(!this.isMobile()&&this.BXIM.messenger.currentTab=="chat"+r.chatId){this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(r.userId==this.BXIM.userId){this.readMessage("chat"+r.chatId,true,false,true);this.leaveFromChat(r.chatId,false);if(r.message.length>0)this.BXIM.openConfirm({title:s.util.htmlspecialchars(r.chatTitle),message:r.message})}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[r.chatId]||!this.BXIM.messenger.userInChat[r.chatId])return false;var Q=[];for(var a=0;a<this.BXIM.messenger.userInChat[r.chatId].length;a++)if(this.BXIM.messenger.userInChat[r.chatId][a]!=r.userId)Q.push(this.BXIM.messenger.userInChat[r.chatId][a]);this.BXIM.messenger.userInChat[r.chatId]=Q;this.BXIM.messenger.redrawChatHeader()}}else if(t=="deleteNotifies"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.skipMassDelete){return true}for(var a in r.id){if(r.id[a]>0){delete this.BXIM.notify.notify[a];delete this.BXIM.notify.flashNotify[a];delete this.BXIM.notify.unreadNotify[a]}}this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="notify"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.date=new Date(r.date);var M={};M.UNREAD_NOTIFY={};M.UNREAD_NOTIFY[r.id]=[r.id];this.BXIM.messenger.notify.notify[r.id]=r;if(this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){this.BXIM.messenger.notify.flashNotify[r.id]=false}else{this.BXIM.messenger.notify.flashNotify[r.id]=r.silent!="Y"}if(r.settingName=="im|like"&&r.originalTag.substr(0,10)=="RATING|IM|"){var z=r.originalTag.split("|");if(this.BXIM.messenger.message[z[4]]&&this.BXIM.messenger.message[z[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete M.UNREAD_NOTIFY[r.id];this.BXIM.notify.flashNotify[r.id]=false;this.BXIM.notify.viewNotify(r.id)}}if(r.silent=="N")this.BXIM.notify.changeUnreadNotify(M.UNREAD_NOTIFY);s.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=parseInt(r.id)>this.BXIM.lastRecordId?parseInt(r.id):this.BXIM.lastRecordId}else if(t=="readNotifyList"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=r.counter;r.list.forEach(function(e){delete this.BXIM.notify.unreadNotify[e]}.bind(this));this.BXIM.notify.viewNotifyMarkupUpdate();this.BXIM.notify.updateNotifyCount(false)}else if(t=="massReadNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(!s.type.isArray(r.idList))return false;var $=r.idList;this.BXIM.notify.initNotifyCount=0;for(var a in this.BXIM.notify.unreadNotify){var Z=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[a]];if(Z&&Z.type!=1&&$.indexOf(Z.id)>=0){delete this.BXIM.notify.unreadNotify[a]}}this.BXIM.notify.updateNotifyCount(false)}else if(t=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;var ee=parseInt(r.id);if(this.BXIM.notify.notify[ee]){if(this.isMobile()){delete this.BXIM.notify.notify[ee]}else{this.BXIM.notify.notify[ee].confirmMessages=r.confirmMessages}}delete this.BXIM.notify.unreadNotify[ee];delete this.BXIM.notify.flashNotify[ee];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.unreadNotify[r.id]){this.BXIM.notify.viewNotify(r.id,true,false)}}else if(t=="unreadNotifyList"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.list.forEach(function(e){this.BXIM.notify.viewNotify(e,false,false)}.bind(this))}else if(t=="deleteCommand"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.command.length;a++){if(!this.BXIM.messenger.command[a]||this.BXIM.messenger.command[a].id!=r.commandId){continue}delete this.BXIM.messenger.command[a];if(this.commandPopup!=null){this.commandPopup.destroy()}break}}else if(t=="deleteAppIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}delete this.BXIM.messenger.textareaIcon[a];if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}var V=s.findChildByClassName(this.BXIM.messenger.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-marketplace-"+r.iconId,true);if(V){s.remove(V)}break}}else if(t=="updateAppIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}if(r.context){this.BXIM.messenger.textareaIcon[a].context=r.context}if(r.js){this.BXIM.messenger.textareaIcon[a].js=r.js}if(r.iframe){this.BXIM.messenger.textareaIcon[a].iframe=r.iframe}if(r.iframeWidth){this.BXIM.messenger.textareaIcon[a].iframeWidth=r.iframeWidth}if(r.iframeHeight){this.BXIM.messenger.textareaIcon[a].iframeHeight=r.iframeHeight}if(r.userId!=this.BXIM.userId&&this.popupSmileMenu!=null){this.popupIframeMenu.destroy()}break}}else if(t=="chatUpdateParam"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){if(r.name=="name"){r.value=s.util.htmlspecialchars(r.value)}this.BXIM.messenger.chat[r.chatId][r.name]=r.value;if(this.BXIM.messenger.currentTab.toString().substr(4)==r.chatId){this.BXIM.messenger.redrawChatHeader();if(this.isMobile()){this.BXIM.messenger.dialogStatusRedraw()}}if(this.BXIM.messenger.chat[r.chatId].type=="livechat"&&r.fieldName=="entity_data_1"){var se=this.livechatGetSession(r.chatId);se.readedTime=se.readedTime?new Date(se.readedTime):false;this.drawReadMessage("chat"+r.chatId,se.readedId,se.readedTime);if(se.showForm=="N"){if(!this.BXIM.messenger.popupMessengerLiveChatLastSend||this.BXIM.messenger.popupMessengerLiveChatLastSend+1e3<+new Date){this.BXIM.messenger.linesLivechatFormHide()}}}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}}},this);var r=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="list"||e=="userStatus"){var r=false;var i=false;for(var a in t.users){if(typeof this.BXIM.messenger.users[a]=="undefined"){continue}if(this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){r=true}if(this.BXIM.messenger.currentTab.toString()==a.toString()){i=true}this.BXIM.messenger.users[a].status=t.users[a].status;this.BXIM.messenger.users[a].color=t.users[a].color;this.BXIM.messenger.users[a].idle=t.users[a].idle?new Date(t.users[a].idle):false;this.BXIM.messenger.users[a].mobile_last_date=new Date(t.users[a].mobile_last_date);this.BXIM.messenger.users[a].last_activity_date=new Date(t.users[a].last_activity_date)}if(r){s.MessengerCommon.userListRedraw()}if(i){this.BXIM.messenger.dialogStatusRedraw()}}},this);var i=s.delegate(function(e,s){if(this.isMobile()){s=e.params;e=e.command}if(e=="linesAnswer"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[s.chatId])return false;this.BXIM.messenger.chat[s.chatId].owner=this.BXIM.userId;this.BXIM.messenger.redrawChatHeader();if(this.BXIM.messenger.popupMessengerTextarea){this.BXIM.messenger.popupMessengerTextarea.focus()}}else if(e=="queueItemUpdate"){if(typeof this.BXIM.messenger.openlines=="undefined"){this.BXIM.messenger.openlines.queue=[s]}else{var t=true;for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id==s.id){this.BXIM.messenger.openlines.queue[r].name=s.name;this.BXIM.messenger.openlines.queue[r].priority=s.priority;t=false;break}}if(t){this.BXIM.messenger.openlines.queue.push(s)}}}else if(e=="queueItemDelete"){if(typeof this.BXIM.messenger.openlines=="undefined"||this.BXIM.messenger.openlines.queue.length<=0)return true;var a=[];for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id!=s.id){a.push(this.BXIM.messenger.openlines.queue[r])}}this.BXIM.messenger.openlines.queue=a}},this);if(this.isMobile()){console.warn("MOBILE!");BXMobileApp.addCustomEvent("onPull-im",s.delegate(function(e){console.log(e);var s=e.data;if(typeof s=="undefined"){t(e["command"],e["params"],e["extra"])}else{for(var r=0;r<s.length;r++){t(s[r]["command"],s[r]["params"],s[r]["extra"])}}},this));BXMobileApp.addCustomEvent("onPullOnline",r);BXMobileApp.addCustomEvent("onPull-imopenlines",i)}else{s.addCustomEvent("onPullOnlineEvent",r);s.addCustomEvent("onPullEvent-im",t);s.addCustomEvent("onPullEvent-imopenlines",i)}};t.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){e.CHAT[i].date_create=new Date(e.CHAT[i].date_create);this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){e.USERS[i].last_activity_date=new Date(e.USERS[i].last_activity_date);e.USERS[i].mobile_last_date=new Date(e.USERS[i].mobile_last_date);e.USERS[i].idle=e.USERS[i].idle?new Date(e.USERS[i].idle):false;e.USERS[i].absent=e.USERS[i].absent?new Date(e.USERS[i].absent):false;this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var a=0;a<e.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){e.MESSAGE[i].date=new Date(e.MESSAGE[i].date);if(this.BXIM.messenger.message[i]&&this.BXIM.messenger.message[i].dropDuplicate){e.MESSAGE[i].dropDuplicate=true}this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,t);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate(function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));for(var a=0;a<e.USERS_MESSAGE[i].length;a++){if(this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]].dropDuplicate||!this.BXIM.messenger.showMessage[i]||!s.util.in_array(e.USERS_MESSAGE[i][a],this.BXIM.messenger.showMessage[i])){if(!this.BXIM.messenger.showMessage[i]){this.BXIM.messenger.showMessage[i]=[]}this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][a]);if(this.BXIM.messenger.history[i])this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);else this.BXIM.messenger.history[i]=e.USERS_MESSAGE[i];if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG"))this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]])}}}}};t.prototype.changeUnreadMessage=function(e,t){if(s.type.isArray(e)){return}t=t!=false;var r=false;var i=false;var a=true;var n=this.isMobile()?"online":this.BXIM.settings.status;for(var o in e){if(o.toString().substr(0,4)=="chat"){if(!s.MessengerCommon.userInChat(o.toString().substr(4))){continue}}var l=false;if(this.BXIM.xmppStatus&&o.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus())){i=true;if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}l=true}if(!l){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus()){if(typeof this.BXIM.messenger.flashMessage[o]=="undefined")this.BXIM.messenger.flashMessage[o]={};for(var h=0;h<e[o].length;h++){if(this.BXIM.isFocus())this.BXIM.messenger.flashMessage[o][e[o][h]]=false;if(this.BXIM.messenger.message[e[o][h]]&&this.BXIM.messenger.message[e[o][h]].senderId==this.BXIM.messenger.currentTab)r=true}this.readMessage(o,true,true,true)}else if(this.isMobile()&&this.BXIM.messenger.currentTab==o){var m=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate(function(e){if(e){s.MessengerCommon.readMessage(m,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[m])this.BXIM.messenger.unreadMessage[m]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[m],e[m]));else this.BXIM.messenger.unreadMessage[m]=e[m]}else{i=true;if(typeof this.BXIM.messenger.flashMessage[o]=="undefined"){this.BXIM.messenger.flashMessage[o]={};var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var h=0;h<e[o].length;h++){if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var I=this.BXIM.messenger.message[e[o][h]].senderId;if(I==0||this.BXIM.messenger.users[I].extranet){this.BXIM.messenger.flashMessage[o][e[o][h]]=false;continue}}var p=this.BXIM.messenger.message[e[o][h]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||p){this.BXIM.messenger.flashMessage[o][e[o][h]]=t}}}else{var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var h=0;h<e[o].length;h++){var p=this.BXIM.messenger.message[e[o][h]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||p){if(!t&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[o][e[o][h]]=false}else{if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var I=this.BXIM.messenger.message[e[o][h]].senderId;if(I==0||this.BXIM.messenger.users[I].extranet){this.BXIM.messenger.flashMessage[o][e[o][h]]=false;continue}}if(typeof this.BXIM.messenger.flashMessage[o][e[o][h]]=="undefined"){this.BXIM.messenger.flashMessage[o][e[o][h]]=true}}}}}if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o){a=true}}if(a){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&i)s.MessengerCommon.userListRedraw();if(this.isMobile()&&this.MobileActionEqual("RECENT")&&app.enableInVersion(13)){clearTimeout(this.newMessageTimeout);this.newMessageTimeout=setTimeout(s.proxy(function(){this.BXIM.messenger.newMessage()},this),1e3)}else if(!this.isMobile()){this.BXIM.messenger.newMessage(t);this.BXIM.messenger.updateMessageCount(t);if(t&&r&&n!="dnd"){this.BXIM.playSound("newMessage2")}}};t.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;if(typeof this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName=="undefined")return false;var e={};var t=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var r=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var i=0;i<t.length;i++){e=s.MessengerCommon.isElementCoordsBelow(t[i],this.BXIM.messenger.popupMessengerBody,33,true);if(t[i].className!="bx-messenger-content-group bx-messenger-content-group-today"){t[i].className="bx-messenger-content-group "+(e.top?"":"bx-messenger-content-group-float");t[i].firstChild.nextSibling.style.marginLeft=e.top?"":Math.round(t[i].offsetWidth/2-t[i].firstChild.nextSibling.offsetWidth/2)+"px";t[i].firstChild.nextSibling.style.marginTop=e.top?"":-e.coords.top+14+"px"}if(!e.top&&t[i-1]){t[i-1].className="bx-messenger-content-group";t[i-1].firstChild.nextSibling.style.marginLeft="";t[i-1].firstChild.nextSibling.style.marginTop=""}}};t.prototype.unreadMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e];var r="";if(t.recipientId.toString().substr(0,4)=="chat"){r=t.recipientId}else{r=t.senderId}s.rest.callMethod("im.dialog.unread",{DIALOG_ID:r,MESSAGE_ID:e});showMessage=this.BXIM.messenger.showMessage[r];showMessage.sort(function(e,s){if(e<s){return-1}else if(e>s){return 1}else{return 0}});this.BXIM.messenger.unreadMessage[r]=[];for(var i=0;i<showMessage.length;i++){if(parseInt(showMessage[i])>=parseInt(e)){if(!this.BXIM.messenger.unreadMessage[r])this.BXIM.messenger.unreadMessage[r]=[];this.BXIM.messenger.unreadMessage[r].push(showMessage[i])}}this.skipReadMessage=true;this.drawTab();this.userListRedraw();setTimeout(s.delegate(function(){this.skipReadMessage=false},this),1e3)};t.prototype.readMessage=function(t,r,i,a){if(!t||this.skipReadMessage)return false;a=a==true||this.isMobile();if(!a&&(!this.BXIM.messenger.unreadMessage[t]||this.BXIM.messenger.unreadMessage[t].length<=0))return false;if(t.toString().substring(0,4)=="chat"){var n=t.toString().substring(4);if(this.BXIM.messenger.chat[n]&&this.BXIM.messenger.chat[n].type=="lines"&&this.BXIM.messenger.chat[n].owner==0){return false}}if(s.SidePanel&&s.SidePanel.Instance.isOpen()&&s.SidePanel.Instance.isOnTop()){return false}r=r!=false;i=i!==false;var o={};for(var l in this.BXIM.messenger.unreadMessage){if(t==l)continue;o[l]=true}if(this.BXIM.messenger.recentListExternal){var h=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-status-new-message");if(h!=null){for(var l=0;l<h.length;l++){var m=h[l].getAttribute("data-userId");if(!o[m]){h[l].firstChild.innerHTML="";s.removeClass(h[l],"bx-messenger-cl-status-new-message")}}}}if(this.BXIM.messenger.popupMessenger!=null){var h=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-status-new-message");if(h!=null){for(var l=0;l<h.length;l++){var m=h[l].getAttribute("data-userId");if(!o[m]){h[l].firstChild.innerHTML="";s.removeClass(h[l],"bx-messenger-cl-status-new-message")}}}h=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(h!=null)for(var l=0;l<h.length;l++)if(h[l].getAttribute("data-notifyType")!=1)s.removeClass(h[l],"bx-messenger-content-item-new")}var g=0;if(Math&&this.BXIM.messenger.unreadMessage[t])g=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t]){var I=s.clone(this.BXIM.messenger.unreadMessage[t]);delete this.BXIM.messenger.unreadMessage[t]}if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r);this.BXIM.updateCounter()}if(i){var p={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(g)>0)p["LAST_ID"]=g;var c=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:p,onsuccess:s.delegate(function(r){if(r){if(r.BITRIX_SESSID)s.message({bitrix_sessid:r.BITRIX_SESSID});if(r.ERROR==""){s.onCustomEvent(e,"onImMessageRead",[t]);this.BXIM.messenger.setUpdateStateStep()}else{this.BXIM.messenger.unreadMessage[t]=I;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}}else{this.BXIM.messenger.unreadMessage[t]=I}},this),onfailure:s.delegate(function(){this.BXIM.messenger.unreadMessage[t]=I;this.BXIM.messenger.sendAjaxTry=0;try{if(typeof c=="object"&&c.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}},this)})}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};t.prototype.drawReadMessageChat=function(e,t){if(!this.BXIM.messenger.readedList[e]){return false}var r=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);var i=0;var a={};var n=0;var o=false;for(var l in this.BXIM.messenger.readedList[e]){if(l==this.BXIM.userId)continue;if(this.BXIM.messenger.message[r]&&this.BXIM.messenger.message[r].senderId==l)continue;if(this.BXIM.messenger.readedList[e][l].messageId>=r){if(!a[l]){a[l]={}}if(!o||o.getTime()>this.BXIM.messenger.readedList[e][l].date.getTime()){n=l;o=this.BXIM.messenger.readedList[e][l].date}a[l]=this.BXIM.messenger.readedList[e][l];i++}}if(i>0){this.BXIM.messenger.readedList[e]=a}else{this.BXIM.messenger.readedList[e]=false;var h=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(h&&s.hasClass(h,"bx-messenger-content-item-notify")){if(!this.countWriting(e)){s.remove(h)}}return false}if(!this.countWriting(e)){var m=this.getUserParam(n);var g='<span title="'+this.formatDate(o)+'">'+m.name+"</span>";if(i>1){if(this.isMobile()){g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#","<b>").replace("#LINK_END#","</b>").replace("#COUNT#",i-1)}else{g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#",'<span class="bx-messenger-ajax" data-entity="readedList">').replace("#LINK_END#","</span>").replace("#COUNT#",i-1)}}t=t!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED_CHAT").replace("#USERS#",g),t)}};t.prototype.drawReadMessage=function(e,t,r,i){var a=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(a!=t||this.BXIM.messenger.message[a].senderId==e||!r){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};t.prototype.drawNotifyMessage=function(t,r,i,a){if(this.BXIM.messenger.popupMessenger==null||t!=this.BXIM.messenger.currentTab||typeof i=="undefined"||typeof r=="undefined"||t==0)return false;if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!n||s.hasClass(n,"bx-messenger-content-empty"))return false;var o=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+r+'"></span>'+this.prepareText(i,false,true,true)})]})]})]});var l=true;if(s.hasClass(n,"bx-messenger-content-item-notify")){l=false;s.remove(n)}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(o);a=a!=false;if(l&&this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport&&a){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};t.prototype.loadHistory=function(e,t,r){t=typeof t=="undefined"?true:t;r=typeof r=="undefined"?false:r;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0&&this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var i=[];if(t){i=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item-text")}else{i=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&i.length<20&&!r){return false}if(i.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(i.length/20)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var a=null;if(!this.isMobile()&&!r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(a)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}else if(r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});var n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(n){n.innerHTML="";n.appendChild(a)}else{n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history-empty");this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,n);s.remove(n)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE&&r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(i){i.appendChild(s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_NO_MESSAGE")}))}return}for(var n in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][n])continue;r.FILES[n].date=new Date(r.FILES[n].date);this.BXIM.disk.files[r.CHAT_ID][n]=r.FILES[n]}var o=0;for(var n in r.MESSAGE){r.MESSAGE[n].date=new Date(r.MESSAGE[n].date);this.BXIM.messenger.message[n]=r.MESSAGE[n];o++}if(o<20){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var n in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[n])this.BXIM.messenger.history[n]=s.util.array_merge(this.BXIM.messenger.history[n],r.USERS_MESSAGE[n]);else this.BXIM.messenger.history[n]=r.USERS_MESSAGE[n]}else{if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=r.USERS_MESSAGE[n]}}if(t){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var l=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(l){if(s("im-message-history-"+l.id))continue;var h=s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var m=typeof s.translit!="undefined"?s.translit(h):h;if(!s("bx-im-history-"+m)){var g=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+m},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:h})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(g)}var l=this.BXIM.messenger.drawMessageHistory(l);if(l)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(l)}}}else{var I=this.BXIM.messenger.popupMessengerBodyWrap.firstChild?this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling:null;if(I){I=s("im-message-"+I.getAttribute("data-blockmessageid"))}if(r.USERS_MESSAGE[e]){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var l=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(l){if(s("im-message-"+l.id))continue;s.MessengerCommon.drawMessage(e,l,false,true)}}}if(I){s.scrollToNode(I.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}},this),onfailure:s.delegate(function(){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop()},this)})}};t.prototype.loadMessageByDate=function(t,r,i){s.ajax({url:this.BXIM.pathToAjax+"?LOAD_MESSAGE_BY_DATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_MESSAGE_BY_DATE:"Y",CHAT_ID:t,LAST_LOAD:r,FIRST_MESSAGE_ID:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(a){if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){var n=a.DIALOG_ID;this.BXIM.messenger.sendAjaxTry=0;for(var o in a.USERS){a.USERS[o].last_activity_date=new Date(a.USERS[o].last_activity_date);a.USERS[o].mobile_last_date=new Date(a.USERS[o].mobile_last_date);a.USERS[o].idle=a.USERS[o].idle?new Date(a.USERS[o].idle):false;a.USERS[o].absent=a.USERS[o].absent?new Date(a.USERS[o].absent):false;this.BXIM.messenger.users[o]=a.USERS[o]}for(var o in a.PHONES){this.BXIM.messenger.phones[o]={};for(var l in a.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(a.PHONES[o][l])}}for(var o in a.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=a.USER_IN_GROUP[o]}else{for(var l=0;l<a.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(a.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}for(var o in a.FILES){if(!this.BXIM.messenger.disk.files[a.CHAT_ID])this.BXIM.messenger.disk.files[a.CHAT_ID]={};a.FILES[o].date=new Date(a.FILES[o].date);this.BXIM.messenger.disk.files[a.CHAT_ID][o]=a.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var h=0;for(var o in a.MESSAGE){h++;a.MESSAGE[o].date=new Date(a.MESSAGE[o].date);this.BXIM.messenger.message[o]=a.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}for(var o in a.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(a.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=a.USERS_MESSAGE[o]}for(var o in a.DELETE_MESSAGE){delete this.BXIM.messenger.message[o];if(this.BXIM.messenger.currentTab==a.DIALOG_ID&&s("im-message-"+o)){var m=s("im-message-"+o).parentNode.parentNode.parentNode.parentNode.parentNode;if(m.getAttribute("data-messageId")==m.getAttribute("data-blockMessageId")){s.remove(m)}else{m=s("im-message-"+o).parentNode;if(m.nextSibling&&s.hasClass(m.nextSibling,"bx-messenger-hr")){s.remove(m.nextSibling)}else if(!m.nextSibling&&s.hasClass(m.previousSibling,"bx-messenger-hr")){s.remove(m.previousSibling)}s.remove(m)}}}for(var o in a.CHAT){a.CHAT[o].date_create=new Date(a.CHAT[o].date_create);this.BXIM.messenger.chat[o]=a.CHAT[o]}for(var o in a.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=a.USER_IN_CHAT[o]}for(var o in a.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=a.USER_BLOCK_CHAT[o]}this.changeUnreadMessage(a.UNREAD_MESSAGE)}else{if(a.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(s.MessengerCommon.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}}},this),onfailure:s.delegate(function(){this.sendAjaxTry=0},this)})};t.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){t.USERS[r].last_activity_date=new Date(t.USERS[r].last_activity_date);t.USERS[r].mobile_last_date=new Date(t.USERS[r].mobile_last_date);t.USERS[r].idle=t.USERS[r].idle?new Date(t.USERS[r].idle):false;t.USERS[r].absent=t.USERS[r].absent?new Date(t.USERS[r].absent):false;this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"||typeof this.BXIM.messenger.userInGroup[r].users=="undefined"||!this.BXIM.messenger.userInGroup[r].users.length){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}},this)})};t.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){e.CHAT[t].date_create=new Date(e.CHAT[t].date_create);this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}for(var t in e.USERS){e.USERS[t].last_activity_date=new Date(e.USERS[t].last_activity_date);e.USERS[t].mobile_last_date=new Date(e.USERS[t].mobile_last_date);e.USERS[t].idle=e.USERS[t].idle?new Date(e.USERS[t].idle):false;e.USERS[t].absent=e.USERS[t].absent?new Date(e.USERS[t].absent):false;this.BXIM.messenger.users[t]=e.USERS[t]}for(var t in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[t]=="undefined"||typeof this.BXIM.messenger.userInGroup[t].users=="undefined"||!this.BXIM.messenger.userInGroup[t].users.length){this.BXIM.messenger.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var r=0;r<e.USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[r]);this.BXIM.messenger.userInGroup[t].users=s.util.array_unique(this.BXIM.messenger.userInGroup[t].users)}}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}else if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="lines"){this.BXIM.messenger.openLinesFlag=true}this.drawTab(this.BXIM.messenger.currentTab)}}},this)})};t.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;r=typeof r=="function"?r:function(e,s,t){};var i=0;var a=false;if(t.toString().substr(0,4)=="chat"){i=t.toString().substr(4);a=true}else if(t.toString().substr(0,2)=="sg"){i=t.toString().substr(2);a=true}else if(t.toString().substr(0,3)=="crm"){i=t.toString().substr(4);a=true}this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[t];this.BXIM.messenger.loadLastMessageTimeout[t]=true;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){if(a&&(!this.BXIM.messenger.chat[i]||this.BXIM.messenger.chat[i].fake)||!a&&(!this.BXIM.messenger.users[t]||this.BXIM.messenger.users[t].fake)){s.addClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}}var n=s.delegate(function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;r(t,false,{});if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;clearTimeout(this.BXIM.messenger.loadLastMessageTimeout);this.BXIM.messenger.loadLastMessageTimeout=setTimeout(s.delegate(function(){s.MessengerCommon.loadLastMessage(t)},this),2e3);return true}this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.redrawTab[t]=true;if(!this.BXIM.messenger.showMessage[t]||this.BXIM.messenger.showMessage[t].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var e=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:e});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(s.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}}else{this.BXIM.messenger.tooltip(this.BXIM.messenger.popupMessengerBody,s.message("IM_M_LOAD_ERROR"),{offsetTop:-10,offsetLeft:50,bindOptions:{position:"top"}});var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history");if(i){s.remove(i)}}},this);var o=s.delegate(function(i){this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==i.USER_ID){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(!this.BXIM.checkRevision(this.isMobile()?i.MOBILE_REVISION:i.REVISION))return false;if(!i){n();return false}if(i&&i.BITRIX_SESSID){s.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){if(this.isMobile()){this.BXIM.disk.setChatParams(parseInt(i.CHAT_ID),parseInt(i.DISK_FOLDER_ID))}if(a){if(i.USER_ID.toString().substr(0,2)=="sg"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}else if(i.USER_ID.toString().substr(0,3)=="crm"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}}else{this.BXIM.messenger.userChat[t]=i.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.USERS){i.USERS[o].last_activity_date=new Date(i.USERS[o].last_activity_date);i.USERS[o].mobile_last_date=new Date(i.USERS[o].mobile_last_date);i.USERS[o].idle=i.USERS[o].idle?new Date(i.USERS[o].idle):false;i.USERS[o].absent=i.USERS[o].absent?new Date(i.USERS[o].absent):false;this.BXIM.messenger.users[o]=i.USERS[o]}for(var o in i.PHONES){this.BXIM.messenger.phones[o]={};for(var l in i.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(i.PHONES[o][l])}}for(var o in i.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=i.USER_IN_GROUP[o]}else{for(var l=0;l<i.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(i.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}if(!a&&i.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var o in i.FILES){if(!this.BXIM.messenger.disk.files[i.CHAT_ID])this.BXIM.messenger.disk.files[i.CHAT_ID]={};i.FILES[o].date=new Date(i.FILES[o].date);this.BXIM.messenger.disk.files[i.CHAT_ID][o]=i.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var h=0;for(var o in i.MESSAGE){h++;i.MESSAGE[o].date=new Date(i.MESSAGE[o].date);this.BXIM.messenger.message[o]=i.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}if(h<=0){delete this.BXIM.messenger.redrawTab[i.USER_ID]}for(var o in i.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(i.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=i.USERS_MESSAGE[o]}if(a&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)]&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].fake){this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.CHAT){i.CHAT[o].date_create=new Date(i.CHAT[o].date_create);this.BXIM.messenger.chat[o]=i.CHAT[o]}for(var o in i.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=i.USER_IN_CHAT[o]}for(var o in i.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=i.USER_BLOCK_CHAT[o]}if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imOpenDialog",{});if(i.CHAT&&i.CHAT[i.CHAT_ID]){if(i.CHAT[i.CHAT_ID].type=="lines")fabric.Answers.sendCustomEvent("imOpenDialogLines",{});else fabric.Answers.sendCustomEvent("imOpenDialogChat",{})}else{fabric.Answers.sendCustomEvent("imOpenDialogPrivate",{})}}if(i.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var o in i.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[o]=i.OPENLINES.canVoteAsHead[o]}}if(this.BXIM.messenger.currentTab==i.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(i.NETWORK_ID!=""){this.BXIM.messenger.currentTab=i.USER_ID?i.USER_ID:0;delete this.BXIM.messenger.users[i.NETWORK_ID];if(!this.BXIM.messenger.bot[i.USER_ID]){this.BXIM.messenger.bot[i.USER_ID]=this.BXIM.messenger.bot[i.NETWORK_ID]}delete this.BXIM.messenger.bot[i.NETWORK_ID];if(this.MobileActionEqual("RECENT")){var m=0;for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].userId==i.NETWORK_ID){m++;this.BXIM.messenger.recent[o].userId=i.USER_ID;this.BXIM.messenger.recent[o].recipientId=i.USER_ID;this.BXIM.messenger.recent[o].senderId=i.USER_ID}else if(this.BXIM.messenger.recent[o].userId==i.USER_ID){m++}}if(m>1){for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].userId==i.USER_ID){this.recentListHide(i.USER_ID,false);break}}}s.MessengerCommon.userListRedraw()}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:i.NETWORK_ID,USER_ID:i.USER_ID,USER:this.BXIM.messenger.users[i.USER_ID]})}}if(a){for(var o in i.READED_LIST){for(var g in i.READED_LIST[o]){i.READED_LIST[o][g].date=new Date(i.READED_LIST[o][g].date)}this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}else{for(var o in i.READED_LIST){i.READED_LIST[o].date=new Date(i.READED_LIST[o].date);this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}if(a&&this.BXIM.messenger.chat[i.CHAT_ID]&&this.BXIM.messenger.chat[i.CHAT_ID].type=="livechat"){var I=this.livechatGetSession(i.CHAT_ID);if(I.readed=="Y"){I.readedTime=I.readedTime?new Date(I.readedTime):new Date;this.BXIM.messenger.readedList["chat"+i.CHAT_ID]={messageId:I.readedId,date:I.readedTime}}}this.changeUnreadMessage(i.UNREAD_MESSAGE);this.drawTab(i.USER_ID,this.BXIM.messenger.currentTab==i.USER_ID,h);if(this.BXIM.messenger.currentTab==i.USER_ID&&this.BXIM.messenger.readedList[i.USER_ID]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(i.USER_ID,false)}else{this.drawReadMessage(i.USER_ID,this.BXIM.messenger.readedList[i.USER_ID].messageId,this.BXIM.messenger.readedList[i.USER_ID].date,false)}}this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(i.USER_ID,true,false)}if(this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}s.onCustomEvent(e,"onImLoadLastMessage",[t,true,i]);r(t,true,i)}else{this.BXIM.messenger.redrawTab[t]=true;if(i.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else if(i.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),2e3);s.onCustomEvent(e,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),1e4)}s.onCustomEvent(e,"onImError",[i.ERROR])}r(t,false,i)}},this);var l=this.isMobile()||this.BXIM.isFocus();if(a&&this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].owner==0&&this.BXIM.messenger.chat[i].type=="lines"){l=false}var h=s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&D="+t+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:a?"Y":"N",USER_ID:t,USER_LOAD:"Y",TAB:this.BXIM.messenger.currentTab,READ:l?"Y":"N",MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!a&&this.BXIM.messenger.users[t]&&this.BXIM.messenger.users[t].search_mark?this.BXIM.messenger.users[t].search_mark:"",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:o,onprogress:function(e){if(e.position==0&&e.totalSize==0){n()}},onfailure:n})};t.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;this.BXIM.messenger.currentTab=e?e:0;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="call")this.BXIM.messenger.openCallFlag=true;else if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="lines")this.BXIM.messenger.openLinesFlag=true}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanelChat.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanelCall.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r!=false;var a=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.showMessage[e].length!=0&&this.BXIM.messenger.showMessage[e].length==this.BXIM.messenger.unreadMessage[e].length){this.drawTab(e,true);s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");var n=s.create("div",{props:{className:"bx-notifier-content-link-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});this.BXIM.messenger.redrawTab[e]=true;this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(n,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);if(this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}}else if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){if(this.isMobile()&&this.BXIM.webComponent){this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}else{this.BXIM.messenger.redrawTab[e]=false}}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{var o="";if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")}s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o})]})]}if(a.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:a})}if(t)this.BXIM.messenger.extraClose();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){if(this.BXIM.settings.loadLastMessage){this.loadLastMessage(e)}else{if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.loadChatData(e.toString().substr(4));else s.MessengerCommon.loadUserData(e);delete this.BXIM.messenger.redrawTab[e];this.drawTab(e,true)}}else{this.drawTab(e,true)}if(!this.BXIM.messenger.redrawTab[e]){if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate(function(t){if(t){s.MessengerCommon.readMessage(e)}},this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){BXMobileApp.onCustomEvent("onImDialogOpen",{id:e},true)}};t.prototype.drawTab=function(e,t,r,i){r=r||0;i=i!==false;if(!e){e=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["default"]={};var a=true;if(this.BXIM.messenger.openChatFlag){var n=e.toString().substr(4);if(this.BXIM.messenger.chat[n]){if(this.BXIM.messenger.chat[n].type=="open"){if(!s.MessengerCommon.userInChat(n)){if(this.isMobile()){BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+n,force:this.BXIM.messenger.redrawTab[e]?false:true},true)}else{s.PULL.extendWatch("IM_PUBLIC_"+n,this.BXIM.messenger.redrawTab[e]?false:true)}}}else if(this.BXIM.messenger.chat[n].type=="lines"){a=false}}}if(this.isPage()&&i){if(a){if(s.MessengerWindow.currentTab!="im"){s.MessengerWindow.changeTab("im")}}else if(this.BXIM.settings.linesTabEnable){if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){var o="";var l=null;if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE");l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}})}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o}),l]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));else this.BXIM.messenger.showMessage[e]=[];for(var h=0;h<this.BXIM.messenger.showMessage[e].length;h++){if(this.isMobile()&&this.BXIM.webComponent&&this.BXIM.messenger.showMessage[e][h].toString().indexOf("temp")==0){continue}s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][h]],false)}if(r>0&&r<20){if(!this.BXIM.messenger.openChatFlag||this.BXIM.messenger.chat[e.toString().substr(4)]){var m=false;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[e.toString().substr(4)].date_create){if(this.BXIM.messenger.chat[e.toString().substr(4)].date_create.getTime()/1e3+25e5>(new Date).getTime()/1e3){m=true}}if(!m){var l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}});this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(l,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}}t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var g=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(g&&g.parentNode.parentNode.parentNode.parentNode.parentNode){s.scrollToNode(g.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}s.onCustomEvent("onImDrawTab",[{id:e,hasMessage:this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0}]);delete this.BXIM.messenger.redrawTab[e]};t.prototype.sendMessageAjax=function(t,r,i,a){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;a=a==true;this.BXIM.messenger.sendMessageFlag++;var n="N";if(a&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.toString().substr(4)]){n="Y"}this.recentListAdd({id:"temp"+t,date:new Date,skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:i,userId:r,userIsChat:a,params:{CLASS:n=="Y"?"bx-messenger-content-item-system":""}},true);s.onCustomEvent("onImBeforeMessageSend",[{recipientId:r,messageText:i}]);var o=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.add",dialog:s.MessengerCommon.getDialogDataForTracking(r)}),method:"POST",dataType:"json",skipAuthCheck:true,timeout:120,data:{IM_SEND_MESSAGE:"Y",CHAT:a?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,OL_SILENT:n,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(n){if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imMessageSend",{})}this.BXIM.messenger.sendMessageFlag--;if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n&&n.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[n.TMP_ID].text=n.SEND_MESSAGE;this.BXIM.messenger.message[n.TMP_ID].id=n.ID;this.BXIM.messenger.message[n.TMP_ID].date=new Date(n.SEND_DATE);if(n.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[n.TMP_ID].params=n.SEND_MESSAGE_PARAMS}for(var o in n.SEND_MESSAGE_FILES){if(!this.BXIM.messenger.disk.files[n.CHAT_ID])this.BXIM.messenger.disk.files[n.CHAT_ID]={};if(this.BXIM.messenger.disk.files[n.CHAT_ID][o])continue;n.SEND_MESSAGE_FILES[o].date=new Date(n.SEND_MESSAGE_FILES[o].date);this.BXIM.messenger.disk.files[n.CHAT_ID][o]=n.SEND_MESSAGE_FILES[o]}this.BXIM.messenger.message[n.ID]=this.BXIM.messenger.message[n.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==n.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=n.ID;delete this.BXIM.messenger.message[n.TMP_ID];var l=this.BXIM.messenger.message[n.ID];var h=s.util.array_search(""+n.TMP_ID+"",this.BXIM.messenger.showMessage[n.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[n.RECIPIENT_ID][h])this.BXIM.messenger.showMessage[n.RECIPIENT_ID][h]=""+n.ID+"";for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].id==n.TMP_ID){this.BXIM.messenger.recent[o].id=""+n.ID+"";break}}if(n.RECIPIENT_ID==this.BXIM.messenger.currentTab){var m=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(m){m.setAttribute("data-messageid",""+n.ID+"");if(m.getAttribute("data-blockmessageid")==""+n.TMP_ID+""){m.setAttribute("data-blockmessageid",""+n.ID+"")}else{var g=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+n.TMP_ID+""}},true);if(g){g.setAttribute("data-blockmessageid",""+n.ID+"")}}var I=s.findChild(m,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(I){I.setAttribute("data-messageid",""+n.ID+"")}}var p=s("im-message-"+n.TMP_ID);if(p){p.id="im-message-"+n.ID;var c={oneSmileInMessage:false};p.innerHTML=s.MessengerCommon.prepareText(n.SEND_MESSAGE,false,true,true,null,c);if(c.oneSmileInMessage){var d=s.findChildByClassName(m,"bx-messenger-content-item-content");if(d){s.addClass(d,"bx-messenger-content-item-content-transparent")}}}var M=s.findChildByClassName(m,"bx-messenger-content-item-date");if(M)M.innerHTML=s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE"));s.MessengerCommon.clearProgessMessage(n.ID)}if(this.BXIM.messenger.history[n.RECIPIENT_ID])this.BXIM.messenger.history[n.RECIPIENT_ID].push(l.id);else this.BXIM.messenger.history[n.RECIPIENT_ID]=[l.id];this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(n.SEND_MESSAGE_PARAMS){if(n.SEND_MESSAGE_PARAMS.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(m.firstElementChild,"bx-messenger-content-item-content-rich-link")}if(n.RECIPIENT_ID.toString().substr(0,4)=="chat"){if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}else{if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}}s.MessengerCommon.updateStateVar(n,true,true);s.localStorage.set("msm",{id:n.ID,recipientId:n.RECIPIENT_ID,date:n.SEND_DATE,text:n.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:n.MESSAGE,USERS_MESSAGE:n.USERS_MESSAGE,USERS:n.USERS,USER_IN_GROUP:n.USER_IN_GROUP},5);if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw()}else{if(n&&n.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),2e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n&&n.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var m=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var M=s.findChildByClassName(m,"bx-messenger-content-item-date");if(M){if(n.ERROR=="SESSION_ERROR"||n.ERROR=="AUTHORIZE_ERROR"||n.ERROR=="UNKNOWN_ERROR"||n.ERROR=="IM_MODULE_NOT_INSTALLED")M.innerHTML=s.message("IM_M_NOT_DELIVERED");else M.innerHTML=n.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",n.ERROR,n.TMP_ID,n.SEND_DATE,n.SEND_MESSAGE,n.RECIPIENT_ID]);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof o=="object"&&o.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true},this)})};t.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var t=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++){var i=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]];if(!i||i.id.toString().indexOf("temp")!=0)continue;i.text=s.MessengerCommon.prepareTextBack(i.text);t.push(i)}if(t.length<=0)return false;t.sort(function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}});for(var r=0;r<t.length;r++){this.sendMessageRetryTimeout(t[r],100*r)}};t.prototype.sendMessageRetryTimeout=function(e,t){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate(function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),t)};t.prototype.getLastMessageInDialog=function(e){var s=false;if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0){var t=this.BXIM.messenger.showMessage[e][this.BXIM.messenger.showMessage[e].length-1];s=this.BXIM.messenger.message[t]}return s};t.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].type!="open")return false;if(s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.messageUrlAttachDelete=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.ATTACH||!this.BXIM.messenger.message[e].params.URL_ID||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(t))==-1&&this.BXIM.messenger.message[e].params.URL_ID.indexOf(t.toString())==-1){return false}for(var r=0;r<this.BXIM.messenger.message[e].params.ATTACH.length;r++){if(!this.BXIM.messenger.message[e].params.ATTACH[r])continue;if(this.BXIM.messenger.message[e].params.ATTACH[r].ID==t){delete this.BXIM.messenger.message[e].params.ATTACH[r];break}}for(var r=0;r<this.BXIM.messenger.message[e].params.URL_ID.length;r++){if(!this.BXIM.messenger.message[e].params.URL_ID[r])continue;if(this.BXIM.messenger.message[e].params.URL_ID[r]==t){delete this.BXIM.messenger.message[e].params.URL_ID[r];break}}var i=s("im-message-"+e);var a=s.MessengerCommon.drawAttach(e,this.BXIM.messenger.message[e].chatId,this.BXIM.messenger.message[e].params.ATTACH);i.nextElementSibling.innerHTML="";if(a.length>0){s.adjust(i.nextElementSibling,{children:a})}if(a.length<=0){s.removeClass(i.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}s.ajax({url:this.BXIM.pathToAjax+"?URL_ATTACH_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_URL_ATTACH_DELETE:"Y",ID:e,ATTACH_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};t.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e]){return false}t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var a=[];for(var n=0;n<this.BXIM.messenger.message[e].params.LIKE.length;n++){if(this.BXIM.messenger.message[e].params.LIKE[n]!=this.BXIM.userId){a.push(this.BXIM.messenger.message[e].params.LIKE[n])}}this.BXIM.messenger.message[e].params.LIKE=a;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var h=s.findChildByClassName(l,"bx-messenger-content-item-like");var m=s.findChildByClassName(l,"bx-messenger-content-like-digit",false);if(r){s.addClass(h,"bx-messenger-content-item-liked")}else{s.removeClass(h,"bx-messenger-content-item-liked")}if(o>0){m.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(m.parentNode,"bx-messenger-content-like-digit-off")}else{m.setAttribute("title","");s.addClass(m.parentNode,"bx-messenger-content-like-digit-off")}m.innerHTML=o}if(this.isMobile()){app.exec("callVibration")}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)},this),onfailure:s.delegate(function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false},this)})},this),1e3)}return true};t.prototype.messageIsLike=function(e){return this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};t.prototype.checkEditMessage=function(e,t){t=t||"list";if(this.BXIM.messenger.openLinesFlag){var r=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)])}var i=false;if(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return i}if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].date.getTime()/1e3+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){if(this.BXIM.messenger.openLinesFlag){if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){if(t=="edit"){i=this.BXIM.messenger.openlines.canUpdateOwnMessage.indexOf(r)>-1}else if(t=="delete"){i=this.BXIM.messenger.openlines.canDeleteOwnMessage.indexOf(r)>-1}}else if(this.BXIM.messenger.openlines.canDeleteMessage.indexOf(r)>-1&&t=="delete"){i=true}if(i&&r!="network"){if(!this.BXIM.messenger.message[e].params||typeof this.BXIM.messenger.message[e].params.CONNECTOR_MID=="undefined"||this.BXIM.messenger.message[e].params.CONNECTOR_MID.length<=0){i=false}}}else if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){i=true}}return i};t.prototype.editMessageAjax=function(e,t){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e,"edit"))return false;if(t==s.MessengerCommon.prepareTextBack(this.BXIM.messenger.message[e].text,true))return false;t=t.replace("    ","\t");t=s.util.trim(t);if(t.length<=0){s.MessengerCommon.deleteMessageAjax(e);return false}t=s.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,t);s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.update",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:e,MESSAGE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)})};t.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(this.BXIM.isAdmin&&this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.message[e].chatId&&this.BXIM.messenger.generalChatId==this.BXIM.messenger.message[e].chatId){}else if(!s.MessengerCommon.checkEditMessage(e,"delete")){return false}s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.delete",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;if(this.BXIM.messenger.message[e]){this.BXIM.messenger.message[e].isNowDeleted=true}s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};t.prototype.shareMessageAjax=function(e,t,r){s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SHARE&TYPE="+t+"&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.share",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId),data:{timShareType:t.toString().toLowerCase()}}),method:"POST",dataType:"json",timeout:30,data:{IM_SHARE_MESSAGE:"Y",ID:e,TYPE:t,DATE:r?r:0,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};t.prototype.drawKeyboard=function(e,t,r){if(!r||r=="N")return null;var i=null;var a=[];var n=null;var o=null;for(var l=0;l<r.length;l++){if(r[l].TYPE=="NEWLINE"){n=s.create("div",{props:{className:"bx-messenger-keyboard-new-line"}})}else{if(r[l].CONTEXT&&(this.isMobile()&&r[l].CONTEXT=="DESKTOP"||!this.isMobile()&&r[l].CONTEXT=="MOBILE")){continue}var h="";if(r[l].WIDTH){h=h+"width: "+r[l].WIDTH+"px;"}else if(r[l].DISPLAY=="BLOCK"){h=h+"width: 225px;"}if(r[l].BG_COLOR){h=h+"background-color: "+r[l].BG_COLOR+";"}if(r[l].TEXT_COLOR){h=h+"color: "+r[l].TEXT_COLOR+";"}if(r[l].DISABLED&&r[l].DISABLED=="Y"){o='<span class="bx-messenger-keyboard-button-text" data-disabled="Y" style="'+h+'">'+r[l].TEXT+"</span>"}else{if(r[l].LINK){o='<a href="'+r[l].LINK+'" target="_blank" class="bx-messenger-keyboard-button-text" style="'+h+'">'+r[l].TEXT+"</a>"}else if(r[l].FUNCTION){var m=r[l].FUNCTION.toString().replace("#MESSAGE_ID#",t).replace("#DIALOG_ID#",e).replace("#USER_ID#",this.BXIM.userId);o='<a href="javascript:void(1);" onclick="'+m+'; BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+h+'">'+r[l].TEXT+"</a>"}else if(r[l].APP_ID){r[l].APP_PARAMS=r[l].APP_PARAMS?r[l].APP_PARAMS:"";o='<a href="javascript:void(1);" onclick="BXIM.messenger.textareaIconDialogClick('+parseInt(r[l].APP_ID)+", "+t+", '"+s.util.htmlspecialchars(r[l].APP_PARAMS)+'\'); BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+h+'">'+r[l].TEXT+"</a>"}else{o='<span class="bx-messenger-keyboard-button-text" data-dialogId="'+e+'" data-messageId="'+t+'" data-blockAfterClick="'+r[l].BLOCK+'" data-command="'+s.util.htmlspecialchars(r[l].COMMAND)+'" data-commandParams="'+s.util.htmlspecialchars(r[l].COMMAND_PARAMS)+'" data-botId="'+r[l].BOT_ID+'" style="'+h+'">'+r[l].TEXT+"</span>"}}n=s.create("span",{props:{className:"bx-messenger-keyboard-button bx-messenger-keyboard-button-"+r[l].DISPLAY.toLowerCase()},children:[o]})}a.push(n)}if(a.length>0){i=s.create("div",{attrs:{id:"im-message-keyboard-"+t},props:{className:"bx-messenger-keyboard"},children:a})}return i};t.prototype.clickButtonKeyboard=function(){if(s.proxy_context.tagName=="A")return true;if(this.sendBotCommand)return true;var e=s.proxy_context.getAttribute("data-dialogId");var t=s.proxy_context.getAttribute("data-messageId");var r=s.proxy_context.getAttribute("data-botId");var i=s.proxy_context.getAttribute("data-command");var a=s.proxy_context.getAttribute("data-commandParams");var n=s.proxy_context.getAttribute("data-disabled");var o=s.proxy_context.getAttribute("data-blockAfterClick");if(n=="Y"||s.hasClass(s.proxy_context,"bx-messenger-keyboard-button-block"))return true;this.sendBotCommand=true;if(!this.sendBotCommandBlock[r]){this.sendBotCommandBlock[r]={}}this.sendBotCommandBlock[r][t]=true;if(o=="Y"){var l=s("im-message-keyboard-"+t);if(l){var h=s.findChildrenByClassName(l,"bx-messenger-keyboard-button-text",false);for(var m=0;m<h.length;m++){s.addClass(h[m],"bx-messenger-keyboard-button-block")}}}s.addClass(s.proxy_context,"bx-messenger-keyboard-button-progress bx-messenger-keyboard-button-block");s.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:r,COMMAND:i,COMMAND_PARAMS:a,DIALOG_ID:e,MESSAGE_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.sendBotCommand=false},this),onfailure:s.delegate(function(){this.sendBotCommand=false},this)});return true};t.prototype.drawAttach=function(e,t,r,i){if(!r||r.length==0)return[];var a=[];if(typeof r!="object"){a.push(r)}else{a=r}i=i||{};var n=this.getUserIdByChatId(t);var o=[];for(var l=0;l<a.length;l++){var h=a[l];if(!h)continue;var m="";if(typeof h.COLOR!="undefined"){m=h.COLOR}else if(n&&this.BXIM.messenger.users[n]){m=this.BXIM.messenger.users[n].color}else if(this.BXIM.messenger.chat[t]){m=this.BXIM.messenger.chat[t].color}else if(this.BXIM.messenger.users[this.BXIM.userId]){m=this.BXIM.messenger.users[this.BXIM.userId].color}if(typeof h["BLOCKS"]!="object"){continue}var g=typeof h["ID"]!="undefined"?h["ID"]:0;var I=[];var p=false;if(g&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.URL_ID&&(this.BXIM.messenger.message[e].params.URL_ID.indexOf(g)>-1||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(g))>-1)){if(!this.BXIM.settings.enableRichLink){continue}if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){p=true}}if(p){I.push(s.create("span",{props:{className:"bx-messenger-attach-delete"},attrs:{"data-attachId":g,"data-messageId":e,"data-action":"url"}}))}for(var c=0;c<h["BLOCKS"].length;c++){var d=h["BLOCKS"][c];var M=null;if(d.USER&&d.USER.length>0){var u=[];for(var f=0;f<d.USER.length;f++){var B=null;if(d.USER[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":d.USER[f].NETWORK_ID},html:d.USER[f].NAME})}else if(d.USER[f].BOT_ID){if(this.BXIM.messenger.users[d.USER[f].BOT_ID]){d.USER[f].NAME=this.BXIM.messenger.users[d.USER[f].BOT_ID].name;d.USER[f].AVATAR=this.BXIM.messenger.users[d.USER[f].BOT_ID].avatar}else if(!this.BXIM.messenger.bot[d.USER[f].BOT_ID]){d.USER[f].AVATAR=""}B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"user","data-userId":d.USER[f].BOT_ID},html:d.USER[f].NAME})}else if(d.USER[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(d.USER[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":d.USER[f].USER_ID},html:d.USER[f].NAME});if(this.BXIM.messenger.users[d.USER[f].USER_ID]){d.USER[f].AVATAR=this.BXIM.messenger.users[d.USER[f].USER_ID].avatar}}else if(d.USER[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":d.USER[f].CHAT_ID},html:d.USER[f].NAME})}else if(d.USER[f].LINK){B=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.USER[f].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},html:d.USER[f].NAME})}else{B=s.create("span",{props:{className:"bx-messenger-attach-user-name"},html:d.USER[f].NAME})}var X="user";if(d.USER[f].AVATAR_TYPE=="CHAT"){X="chat"}else if(d.USER[f].AVATAR_TYPE=="BOT"){X="bot"}var b=s.create("span",{props:{className:"bx-messenger-attach-user"},children:[s.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[d.USER[f].AVATAR?s.create("img",{attrs:{src:s.util.htmlspecialcharsback(this.formatUrl(d.USER[f].AVATAR))},props:{className:"bx-messenger-attach-user-avatar-img"}}):s.create("span",{attrs:{style:"background-color: "+m},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+X+"-avatar-default "}})]}),B]});u.push(b)}M=s.create("span",{props:{className:"bx-messenger-attach-users"},children:u})}else if(d.LINK&&d.LINK.length>0){var E=[];for(var f=0;f<d.LINK.length;f++){var B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},html:d.LINK[f].NAME?d.LINK[f].NAME:d.LINK[f].LINK});if(d.LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":d.LINK[f].NETWORK_ID},children:[B]})}else if(d.LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(d.LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":d.LINK[f].USER_ID},children:[B]})}else if(d.LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":d.LINK[f].CHAT_ID},children:[B]})}else{B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.LINK[f].LINK),target:"_blank"},html:d.LINK[f].NAME?d.LINK[f].NAME:d.LINK[f].LINK})]})}var C=null;if(d.LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:d.LINK[f].DESC})}var _=null;if(d.LINK[f].HTML){_=s.create("div",{props:{className:"bx-messenger-attach-link-html"},html:d.LINK[f].HTML});var S=s.create("span",{props:{className:"bx-messenger-attach-link"+(d.LINK[f].PREVIEW?" bx-messenger-attach-link-with-preview":"")},children:[B,C,_]})}else if(d.LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(d.LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("div",{children:[B,C,_]})}else{var S=s.create("div",{children:[B,C]})}E.push(S)}M=s.create("span",{props:{className:"bx-messenger-attach-links"},children:E})}else if(d.RICH_LINK&&d.RICH_LINK.length>0){var E=[];for(var f=0;f<d.RICH_LINK.length;f++){var T=null;var B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},html:d.RICH_LINK[f].NAME?d.RICH_LINK[f].NAME:d.RICH_LINK[f].LINK});if(d.RICH_LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":d.RICH_LINK[f].NETWORK_ID},children:[B]})}else if(d.RICH_LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(d.RICH_LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":d.RICH_LINK[f].USER_ID},children:[B]})}else if(d.RICH_LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":d.RICH_LINK[f].CHAT_ID},children:[B]})}else{if(d.RICH_LINK[f].HTML){B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.RICH_LINK[f].LINK),target:"_blank"},html:d.RICH_LINK[f].NAME?d.RICH_LINK[f].NAME:d.RICH_LINK[f].LINK})]})}T=s.create("div",{props:{className:"bx-messenger-attach-rich-link-source"},html:s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.RICH_LINK[f].LINK)}}).hostname})}var C=null;if(d.RICH_LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-rich-link-desc"},html:d.RICH_LINK[f].DESC})}var _=null;if(d.RICH_LINK[f].HTML){_=s.create("div",{props:{className:"bx-messenger-attach-rich-link-html"},html:d.RICH_LINK[f].HTML});var S=s.create("span",{props:{className:"bx-messenger-attach-rich-link"+(d.RICH_LINK[f].PREVIEW?" bx-messenger-attach-rich-link-with-preview":"")},children:[B,C,_]})}else if(d.RICH_LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(d.RICH_LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image"},children:[_,s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,T]})]})}else{var S=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image bx-messenger-file-image-without-preview"},children:[s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,T]})]})}E.push(S)}M=s.create("span",{props:{className:"bx-messenger-attach-rich-links"},children:E})}else if(d.MESSAGE&&d.MESSAGE.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:this.decodeBbCode(d.MESSAGE)})}else if(d.HTML&&d.HTML.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:d.HTML})}else if(d.GRID&&d.GRID.length>0){var v=[];for(var f=0;f<d.GRID.length;f++){var A=this.decodeBbCode(d.GRID[f].VALUE);if(d.GRID[f].USER_ID){A='<span class="bx-messenger-ajax '+(d.GRID[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+d.GRID[f].USER_ID+'">'+A+"</span>"}else if(d.GRID[f].CHAT_ID){A='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+d.GRID[f].CHAT_ID+'">'+A+"</span>"}else if(d.GRID[f].LINK){A='<a href="'+d.GRID[f].LINK+'" target="_blank">'+A+"</a>"}var y=d.GRID[f].WIDTH?"width: "+d.GRID[f].WIDTH+"px":"";var L=d.GRID[f].HEIGHT?"max-height: "+d.GRID[f].HEIGHT+"px;":"";var N=0;var x=null;var R=null;if(L){R=s.create("div",{props:{className:"bx-messenger-attach bx-messenger-attach-block-name"},attrs:{style:"position: absolute; left: -1000px;"+(d.GRID[f].DISPLAY=="ROW"?y:"")},html:A});document.body.appendChild(R);if(d.GRID[f].HEIGHT>=R.offsetHeight){L=""}else{N=R.offsetHeight}s.remove(R)}if(L){x=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+d.GRID[f].DISPLAY.toLowerCase()+" bx-messenger-attach-block-spoiler"},attrs:{style:d.GRID[f].DISPLAY=="LINE"?y:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:d.GRID[f].DISPLAY=="ROW"?y:""},children:[s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-name"},html:d.GRID[f].NAME}),s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-icon"}})]}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:L+(d.GRID[f].COLOR?"color: "+d.GRID[f].COLOR:""),"data-min-height":d.GRID[f].HEIGHT,"data-max-height":N},children:[s.create("span",{html:A})]})]})}else{x=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+d.GRID[f].DISPLAY.toLowerCase()},attrs:{style:d.GRID[f].DISPLAY=="LINE"?y:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:d.GRID[f].DISPLAY=="ROW"?y:""},html:d.GRID[f].NAME}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:d.GRID[f].COLOR?"color: "+d.GRID[f].COLOR:""},html:A})]})}v.push(x)}M=s.create("span",{props:{className:"bx-messenger-attach-blocks"},children:v})}else if(d.DELIMITER){var D="";if(d.DELIMITER.SIZE){D+="width: "+d.DELIMITER.SIZE+"px;"}if(d.DELIMITER.COLOR){D+="background-color: "+d.DELIMITER.COLOR}if(D){D={style:D}}M=s.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:D})}else if(d.IMAGE&&d.IMAGE.length>0){var w=[];for(var f=0;f<d.IMAGE.length;f++){if(!d.IMAGE[f].NAME){d.IMAGE[f].NAME=""}if(!d.IMAGE[f].PREVIEW){d.IMAGE[f].PREVIEW=d.IMAGE[f].LINK}var O=s.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:s.util.htmlspecialcharsback(d.IMAGE[f].LINK),target:"_blank",title:d.IMAGE[f].NAME},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(d.IMAGE[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});w.push(O)}M=s.create("span",{props:{className:"bx-messenger-attach-images"},children:w})}else if(d.FILE&&d.FILE.length>0){var k=[];for(var f=0;f<d.FILE.length;f++){var P=d.FILE[f].NAME?d.FILE[f].NAME:d.FILE[f].LINK;if(this.isMobile()){if(P.length>20){P=P.substr(0,7)+"..."+P.substr(P.length-10,P.length)}}else{if(P.length>43){P=P.substr(0,20)+"..."+P.substr(P.length-20,P.length)}}P=s.create("span",{attrs:{title:d.FILE[f].NAME},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:P})]});var U=s.create("div",{props:{className:"bx-messenger-file"},children:[s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:s.util.htmlspecialcharsback(d.FILE[f].LINK),target:"_blank"},children:[P]}),d.FILE[f].SIZE?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(d.FILE[f].SIZE)}):null]}),s.create("div",{props:{className:"bx-messenger-file-download"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(d.FILE[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})]})]});k.push(U)}M=s.create("span",{props:{className:"bx-messenger-attach-files"},children:k})}I.push(M)}if(I.length>0){o.push(s.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:m=="transparent"?"border: 0; padding-left: 0;":"border-color: "+m},children:I}))}}return o};t.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable||!e||!t)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var a=true;var n=[];for(var o=0;o<i.length;o++){var l=this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][i[o]];if(!l){var l={id:i[o],chatId:e};var h=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:h+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":h},props:{className:"bx-messenger-file"},children:[s.create("span",{props:{className:"bx-messenger-file-deleted"},html:s.message("IM_F_DELETED")})]}));continue}if(this.isDesktop()){if(!this.BXIM.desktop.enableInVersion(43)){if(l.type=="audio"){l.viewerAttrs=null}}if(!this.BXIM.desktop.enableInVersion(99)){if(l.type=="video"){l.viewerAttrs=null}}}if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(l.status,r.status)){continue}}var m=null;var g=false;if(l.preview||l.urlPreview){var I=null;if(l.preview&&typeof l.preview!="string"){I=l.preview;if(l.urlPreview){l.preview=""}}else{I=s.create("img",{attrs:{src:this.formatUrl(l.urlPreview?l.urlPreview:l.preview),height:l.image?l.image.height>400?"400":l.image.height:"auto"},props:{className:"bx-messenger-file-image-text bx-messenger-file-image-type-"+l.type},events:{load:function(){this.parentNode.style.background="#fff";this.removeAttribute("height")}}})}if(a){var p=null;if(l.type=="video"){if(this.isMobile()){p=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{events:{click:s.delegate(function(e){s.localStorage.set("impmh",true,1);app.openDocument({url:this.formatUrl(l.urlDownload),filename:l.name.toString().toLowerCase()});return s.PreventDefault(e)},this)},props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}else{p=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{props:{className:"bx-messenger-file-image-type-video-button-download-1"}}),s.create("div",{props:{className:"bx-messenger-file-image-type-video-button-download-2"}})]})}}if(l.type=="video"&&l.urlDownload||l.type!="video"&&l.urlPreview&&l.urlShow){if(this.isMobile()){m=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate(function(){var e=this.BXIM.disk.files[s.proxy_context.dataset.chatid][s.proxy_context.dataset.diskid];var t=s.findParent(s.proxy_context,{className:"bx-messenger-content-item"});if(t&&t.getAttribute("data-messageid").indexOf("temp")==0){return false}if(e.type=="image"){this.BXIM.messenger.openPhotoGallery(e.urlShow);s.localStorage.set("impmh",true,1)}else{s.localStorage.set("impmh",true,1);app.openDocument({url:e.urlShow,filename:e.name.toString().toLowerCase()})}},this)},attrs:{"data-chatId":l.chatId,"data-diskId":l.id},props:{className:"bx-messenger-file-image-src"},children:[p,I]})]})]})}else{m=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{dataset:l.viewerAttrs,attrs:{href:this.formatUrl(l.urlShow),target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[p,I]})]})]});g=true}}else{m=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[I]})]})]})}}else{m=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[I]})]})]})}}var c=l.name;if(this.isMobile()){if(c.length>20){c=c.substr(0,7)+"..."+c.substr(c.length-10,c.length)}}else{if(c.length>43){c=c.substr(0,20)+"..."+c.substr(c.length-20,c.length)}}var d=s.create("span",{attrs:{title:l.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:c})]});if(a&&(l.urlShow||l.urlDownload)){if(this.isMobile())d=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:l.urlDownload,filename:l.name.toString().toLowerCase()})}},children:[d]});else d=s.create("a",{dataset:g?null:l.viewerAttrs,props:{className:"bx-messenger-file-title-href"},attrs:{href:this.formatUrl(l.urlShow?l.urlShow:l.urlDownload),target:"_blank"},children:[d]})}d=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[d,s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(l.size)})]});var M=null;if(l.status=="done"){if(!this.isMobile()){M=s.create("div",{props:{className:"bx-messenger-file-download"},children:[!l.urlDownload||!a?null:s.create("a",{attrs:{href:this.formatUrl(l.urlDownload),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")}),!l.urlDownload||!this.BXIM.disk.enable||this.BXIM.context=="LINES"?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate(function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})},this)}})]})}else{M=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(l.status=="upload"){var u={};var f="";var B=null;var X="";var b="";if(l.authorId==this.BXIM.userId&&l.progress>=0){b=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",l.progress);u={width:l.progress+"%"};B=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{b=s.message("IM_F_UPLOAD");X=" bx-messenger-file-progress-infinite"}M=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:b},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+X},style:u})]}),B]})}else if(l.status=="error"){M=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:l.errorText?l.errorText:s.message("IM_F_ERROR")})}if(!M)return false;if(i.length==1&&r.showInner=="Y"){n=[m,d,M]}else{var h=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:h+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":h},props:{className:"bx-messenger-file"},children:[m,d,M]}))}}return n};t.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var a=s(i+"-"+t);if(a){var n=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(n){a.innerHTML="";s.adjust(a,{children:n})}}};t.prototype.diskChatDialogFileInited=function(e,s,t){t.messageText=t.messageText||"";var r=t.form.CHAT_ID.value;if(!this.BXIM.disk.files[r])this.BXIM.disk.files[r]={};this.BXIM.disk.files[r][e]={id:e,tempId:e,chatId:r,date:new Date,type:s.isImage?"image":"file",preview:s.isImage?s.canvas:"",name:s.name,size:s.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.BXIM.disk.filesRegister[r])this.BXIM.disk.filesRegister[r]={};this.BXIM.disk.filesRegister[r][e]={id:e,type:this.BXIM.disk.files[r][e].type,mimeType:s.file.type,name:this.BXIM.disk.files[r][e].name,size:this.BXIM.disk.files[r][e].size};this.diskChatDialogFileRegister(r,t.messageText);t.messageText=""};t.prototype.diskChatDialogFileRegister=function(t,r){r=r||"";clearTimeout(this.BXIM.disk.timeout[t]);this.BXIM.disk.timeout[t]=setTimeout(s.delegate(function(){var i=0;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].type!="private"){i="chat"+t}else{for(var a in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[a]==t){i=a;break}}}if(!i)return false;var n="N";if(i.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t]){n="Y"}var o=[];var l="file";for(var h in this.BXIM.disk.filesRegister[t]){l=this.BXIM.disk.filesRegister[t][h].type;o.push(h)}var m="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[m]={id:m,chatId:t,senderId:this.BXIM.userId,recipientId:i,date:new Date,text:s.MessengerCommon.prepareText(r,true),params:{FILE_ID:o,CLASS:n=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=[];this.BXIM.messenger.showMessage[i].push(m);s.MessengerCommon.drawMessage(i,this.BXIM.messenger.message[m]);s.MessengerCommon.drawProgessMessage(m);this.recentListAdd({id:m,date:new Date,skipDateCheck:true,recipientId:i,senderId:this.BXIM.userId,text:r?r:"["+s.message("IM_F_FILE")+"]",userId:i,userIsChat:i.toString().substr(0,4)=="chat",params:{}},true);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){return s.message("IM_F_EFP")};s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.file.register",dialog:s.MessengerCommon.getDialogDataForTracking(i),data:{timFileType:l}}),method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:t,RECIPIENT_ID:i,TEXT:r,MESSAGE_TMP_ID:m,FILES:JSON.stringify(this.BXIM.disk.filesRegister[t]),OL_SILENT:n,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[m];s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[t]={};if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear();return false}this.BXIM.messenger.sendMessageFlag--;var a=[];var n={};for(var o in r.FILE_ID){var l=r.FILE_ID[o];delete this.BXIM.disk.filesRegister[r.CHAT_ID][l.TMP_ID];if(parseInt(l.FILE_ID)>0){n[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesProgress[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesMessage[l.TMP_ID]=r.MESSAGE_ID;this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]={};for(var h in this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID])this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID][h]=this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID][h];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["id"]=l.FILE_ID;delete this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["name"]=l.FILE_NAME;if(s("im-file-"+l.TMP_ID)){s("im-file-"+l.TMP_ID).setAttribute("data-fileId",l.FILE_ID);s("im-file-"+l.TMP_ID).id="im-file-"+l.FILE_ID;s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.FILE_ID)}a.push(l.FILE_ID)}else{this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID]["status"]="error";s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.TMP_ID)}}this.BXIM.messenger.message[r.MESSAGE_ID]=s.clone(this.BXIM.messenger.message[r.MESSAGE_TMP_ID]);this.BXIM.messenger.message[r.MESSAGE_ID]["id"]=r.MESSAGE_ID;this.BXIM.messenger.message[r.MESSAGE_ID]["params"]["FILE_ID"]=a;if(r.MESSAGE_TEXT){this.BXIM.messenger.message[r.MESSAGE_ID]["text"]=r.MESSAGE_TEXT}if(this.BXIM.messenger.popupMessengerLastMessage==r.MESSAGE_TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=r.MESSAGE_ID;delete this.BXIM.messenger.message[r.MESSAGE_TMP_ID];var g=s.util.array_search(""+r.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[r.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g])this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g]=""+r.MESSAGE_ID+"";if(s("im-message-"+r.MESSAGE_TMP_ID)){if(r.MESSAGE_TEXT){s("im-message-"+r.MESSAGE_TMP_ID).innerHTML=r.MESSAGE_TEXT}s("im-message-"+r.MESSAGE_TMP_ID).id="im-message-"+r.MESSAGE_ID;var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+r.MESSAGE_TMP_ID}},true);if(I){I.setAttribute("data-messageid",""+r.MESSAGE_ID+"");if(I.getAttribute("data-blockmessageid")==""+r.MESSAGE_TMP_ID)I.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}else{var p=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.MESSAGE_TMP_ID}},true);if(p){p.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}}var c=s.findChildByClassName(I,"bx-messenger-content-item-date");if(c)c.innerHTML=s.MessengerCommon.formatDate(this.BXIM.messenger.message[r.MESSAGE_ID].date,s.MessengerCommon.getDateFormatType("MESSAGE"))}s.MessengerCommon.clearProgessMessage(r.MESSAGE_ID);if(this.BXIM.messenger.history[r.RECIPIENT_ID])this.BXIM.messenger.history[r.RECIPIENT_ID].push(r.MESSAGE_ID);else this.BXIM.messenger.history[r.RECIPIENT_ID]=[r.MESSAGE_ID];var d="N";if(r.RECIPIENT_ID.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.CHAT_ID]){d="Y"}this.BXIM.messenger.popupMessengerFileFormRegChatId.value=r.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=r.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=d;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(n);this.BXIM.disk.formAgents["imDialog"].submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[m];this.BXIM.disk.filesRegister[t]={};s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear()},this)});this.BXIM.disk.fileTmpId++},this),500)};t.prototype.diskChatDialogFileStart=function(e,t,r,i){var a=this.BXIM.disk.filesProgress[e.id];var n=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[n.REG_CHAT_ID][a])return false;this.BXIM.disk.files[n.REG_CHAT_ID][a].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n.REG_CHAT_ID,a)};t.prototype.diskChatDialogFileProgress=function(e,t,r,i){var a=this.BXIM.disk.filesProgress[e.id];var n=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[n.REG_CHAT_ID][a])return false;this.BXIM.disk.files[n.REG_CHAT_ID][a].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n.REG_CHAT_ID,a)};t.prototype.diskChatDialogFileDone=function(t,r,i,a){if(!this.BXIM.disk.files[r.file.fileChatId][r.file.fileId])return false;if(this.BXIM.disk.files[r.file.fileChatId]&&this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]){r.file.fileParams["preview"]=this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]["preview"]}if(!this.BXIM.disk.files[r.file.fileChatId])this.BXIM.disk.files[r.file.fileChatId]={};r.file.fileParams.date=new Date(r.file.fileParams.date);this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]=r.file.fileParams;s.MessengerCommon.diskRedrawFile(r.file.fileChatId,r.file.fileId);delete this.BXIM.disk.filesMessage[r.file.fileTmpId];e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogFileError=function(t,r,i,a){var n=this.BXIM.disk.filesProgress[t.id];var o=i.streams.packages.getItem(a).data;if(!this.BXIM.disk.files[o.REG_CHAT_ID][n])return false;t.deleteFile();this.BXIM.disk.files[o.REG_CHAT_ID][n].status="error";this.BXIM.disk.files[o.REG_CHAT_ID][n].errorText=r.error;s.MessengerCommon.diskRedrawFile(o.REG_CHAT_ID,n);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogUploadError=function(t,r,i){var a=t.post.REG_PARAMS?JSON.parse(t.post.REG_PARAMS):{};var n={};for(var o in a){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID]){delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][o];delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][a[o]]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,a[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UNREGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t.post.REG_CHAT_ID,FILES:t.post.REG_PARAMS,MESSAGES:JSON.stringify(n),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.getRecipientByChatId(t.post.REG_CHAT_ID))};t.prototype.phoneCheckDesktop=function(e){e=e===true;var t=new s.Promise;if(e&&this.isMobile()){t.resolve();return t}s.desktopUtils.runningCheck(function(){t.reject()},function(){t.resolve()});return t};t.prototype.pullPhoneEvent=function(){if(this.BXIM.options.frameMode){return false}var e=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command;console.info("pull info: ",e,t)}if(e=="invite"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(!this.BXIM.webrtc.phoneSupport())return false;if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive){return false}if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop(true).then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&t.portalCallData){for(var e in t.portalCallData.users){t.portalCallData.users[e].last_activity_date=new Date(t.portalCallData.users[e].last_activity_date);t.portalCallData.users[e].mobile_last_date=new Date(t.portalCallData.users[e].mobile_last_date);t.portalCallData.users[e].idle=t.portalCallData.users[e].idle?new Date(t.portalCallData.users[e].idle):false;t.portalCallData.users[e].absent=t.portalCallData.users[e].absent?new Date(t.portalCallData.users[e].absent):false;this.BXIM.messenger.users[e]=t.portalCallData.users[e]}for(var e in t.portalCallData.hrphoto)this.BXIM.messenger.hrphoto[e]=t.portalCallData.hrphoto[e];t.callerId=this.BXIM.messenger.users[t.portalCallUserId].name;t.phoneNumber="";if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5e3);if(this.isPage()){s.MessengerWindow.changeTab("im")}s.MessengerCommon.phoneCommand("wait",{CALL_ID:t.callId,DEBUG_INFO:this.getDebugInfo()});if(t.isTransfer){this.BXIM.webrtc.phoneTransferEnabled=true}this.BXIM.webrtc.phoneIncomingWait({chatId:t.chatId,callId:t.callId,callerId:t.callerId,lineNumber:t.lineNumber,companyPhoneNumber:t.phoneNumber,isCallback:t.isCallback,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,config:t.config})}.bind(this))}else if(e=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile()){this.BXIM.webrtc.callOverlayClose()}else{this.BXIM.webrtc.phoneCallView.close()}this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=t.callId}else if(e=="timeout"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){return this.BXIM.webrtc.errorInviteTransfer(t.failedCode,t.failedReason)}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");var r=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var i=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle,{failedCode:t.failedCode})}if(r&&t.failedCode==486){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.CALLBACK)}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("offline");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else if(r&&t.failedCode==480){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("error");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else{if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_DECLINE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else if(this.BXIM.webrtc.phoneCallView){if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setStatusText("");this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}}else if(e=="outgoing"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==t.phoneNumber||t.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;this.BXIM.webrtc.phoneNumber=t.phoneNumber;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setProgress("connect");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_WAIT_ANSWER"))}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else if(this.BXIM.webrtc.phoneCallView){if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.setConfig(t.config);this.BXIM.webrtc.phoneCallView.setCallId(t.callId);if(t.lineNumber)this.BXIM.webrtc.phoneCallView.setLineNumber(t.lineNumber);if(t.lineName)this.BXIM.webrtc.phoneCallView.setCompanyPhoneNumber(t.lineName);this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}if(this.BXIM.webrtc.phonePortalCall&&this.BXIM.messenger.users[t.portalCallUserId]){if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(t.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(t.portalCallUserId)}}}else if(!this.BXIM.webrtc.callInit&&!this.BXIM.webrtc.callActive&&t.callDevice=="PHONE"){this.phoneCheckDesktop(true).then(function(){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.phoneDisplayExternal({callId:t.callId,config:t.config?t.config:{},phoneNumber:t.phoneNumber,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId})}.bind(this))}}else if(e=="start"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_M_CALL_ST_TRANSFER_CONNECTED"));return}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return}this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==t.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else if(this.BXIM.webrtc.phoneCallId==t.callId&&t.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){this.BXIM.webrtc.phoneCallDevice="PHONE";if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else if(e=="hold"||e=="unhold"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.phoneHolded=e=="hold"}}else if(e=="update_crm"){if(this.BXIM.webrtc.phoneCallId==t.callId&&t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}this.BXIM.webrtc.phoneCallId=t.newCallId;this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;s.localStorage.set("vite",false,1);this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";if(this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneCallView.setTransfer(false);this.BXIM.webrtc.phoneOnCallConnected()}else if(e=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=t.active=="Y"}else if(e=="changeDefaultLineId"){this.BXIM.webrtc.phoneDefaultLineId=t.defaultLineId}else if(e=="replaceCallerId"){var a=s.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",t.callerId);this.BXIM.webrtc.setCallOverlayTitle(a);if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e=="showExternalCall"){if(this.isMobile())return false;if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive)return false;if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop().then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.showExternalCall({callId:t.callId,fromUserId:t.fromUserId,toUserId:t.toUserId,isCallback:t.isCallback,phoneNumber:t.phoneNumber,lineNumber:t.lineNumber,companyPhoneNumber:t.companyPhoneNumber,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,config:t.config,portalCall:t.portalCall,portalCallData:t.portalCallData,portalCallUserId:t.portalCallUserId})}.bind(this))}else if(e=="hideExternalCall"){if(this.isMobile())return false;if(this.BXIM.webrtc.callActive&&this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.hideExternalCall()}}},this);if(this.isMobile()){BXMobileApp.addCustomEvent("onPull-voximplant",e)}else{s.addCustomEvent("onPullEvent-voximplant",e)}};t.prototype.phoneCommand=function(e,t,r,i){var a=!s.type.isFunction(i);var n;if(a){n=new s.Promise}if(!this.BXIM.webrtc.phoneSupport()){if(a){n.reject();return n}else{return false}}r=r!=false;t=typeof t=="object"?t:{};s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:r,data:{IM_PHONE:"Y",COMMAND:e,PARAMS:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:function(e){if(a){n.resolve(e)}else{i(e)}}});return a?n:true};t.prototype.phoneCorrect=function(e){e=s.util.trim(e.toString());if(e.substr(0,2)=="+8"&&e.length>10){e="008"+e.substr(2)}e=e.replace(/[^0-9#*;,]/g,"");if(e.substr(0,2)=="80"||e.substr(0,2)=="81"||e.substr(0,2)=="82"){}else if(e.substr(0,2)=="00"&&e.length>=9){e=e.substr(2)}else if(e.substr(0,3)=="011"&&e.length>=10){e=e.substr(3)}else if(e.substr(0,1)=="8"&&e.length>=11){e="7"+e.substr(1)}else if(e.substr(0,1)=="0"&&e.length>=8){e=e.substr(1)}return e};t.prototype.phoneOnIncomingCall=function(e){if(this.BXIM.webrtc.phoneCurrentCall)return false;var t={};if(this.isMobile()){t=s.MobileVoximplantCall.events}else{t=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=e.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};t.prototype.phoneGetCallParams=function(){var e=s.type.isPlainObject(this.BXIM.webrtc.phoneParams)?s.clone(this.BXIM.webrtc.phoneParams):{};if(this.BXIM.webrtc.phoneFullNumber!=this.BXIM.webrtc.phoneNumber){e["FULL_NUMBER"]=this.BXIM.webrtc.phoneFullNumber}return JSON.stringify(e)};t.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams["CALLER_ID"]="";this.BXIM.webrtc.phoneParams["USER_ID"]=this.BXIM.userId;this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=s.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,this.phoneGetCallParams());this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:s.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(!(e.HR_PHOTO.length==0)){for(var s in e.HR_PHOTO)this.BXIM.messenger.hrphoto[s]=e.HR_PHOTO[s];this.BXIM.webrtc.callOverlayUserId=e.DIALOG_ID}else{this.BXIM.webrtc.callOverlayChatId=e.DIALOG_ID.substr(4)}}},this)})};t.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup({"X-Disconnect-Code":200,"X-Disconnect-Reason":"Normal hangup"})}catch(e){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad)this.BXIM.webrtc.popupKeyPad.close();if(this.BXIM.webrtc.popupTransferDialog)this.BXIM.webrtc.popupTransferDialog.close();s.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.callSelfDisabled=false;this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferTargetType="";this.BXIM.webrtc.phoneTransferTargetId=0;this.BXIM.webrtc.phoneTransferCallId="";this.BXIM.webrtc.phoneTransferEnabled=false};t.prototype.phoneAuthorize=function(){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(t.HR_PHOTO){for(var r in t.HR_PHOTO)this.BXIM.messenger.hrphoto[r]=t.HR_PHOTO[r]}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);s.MobileVoximplant.loginWithOneTimeKey(t.LOGIN+"@"+t.SERVER,t.HASH)}else{this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER}this.BXIM.webrtc.phoneCallerID=t.CALLERID;this.BXIM.webrtc.phoneApiInit()}else if(t.ERROR=="AUTHORIZE_ERROR"&&(this.isDesktop()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),5e3);s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",t.ERROR,t.CODE);if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR]);this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(t.ERROR+(this.BXIM.webrtc.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+t.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))},this)})};t.prototype.phoneOnAuthResult=function(e){if(e.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE")return false;this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand("ready",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){s.MessengerCommon.phoneCallStart()}}else if(!this.isMobile()&&e.code==302){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:e.key,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE)this.BXIM.webrtc.callAbort(s.message("IM_PHONE_ERROR_CONNECT"));else this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+e.CODE+")":""));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()},this)})}else{if(e.code==401||e.code==400||e.code==403||e.code==404||e.code==302){this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;s.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("Authorize result","failed",e.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}};t.prototype.phoneOnCallFailed=function(e){var t=e.headers||{};this.BXIM.webrtc.phoneLog("Call failed",e.code,e.reason);var r=s.message("IM_PHONE_END");if(e.code==603){r=s.message("IM_PHONE_DECLINE")}else if(e.code==380){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){r=s.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){r=s.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){r=s.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){r=s.message("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_INCOMPLETED")}}else if(e.code==402){if(t.hasOwnProperty("X-Reason")&&t["X-Reason"]==="SIP_PAYMENT_REQUIRED"){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else{r=s.message("IM_PHONE_NO_MONEY")+(this.BXIM.isAdmin?" "+s.message("IM_PHONE_PAY_URL_NEW"):"")}}else if(e.code==486&&this.BXIM.webrtc.phoneRinging>1){r=s.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){r=s.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){r=s.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}this.BXIM.webrtc.phoneCallFinish();if(e.code==408||e.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(r);if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}};t.prototype.phoneOnCallDisconnected=function(e){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_END"));if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.playSound("stop");this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle);if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}};t.prototype.phoneOnProgressToneStart=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.phoneRinging++;this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"))};t.prototype.phoneOnProgressToneStop=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};t.prototype.phoneOnConnectionEstablished=function(e){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};t.prototype.phoneOnConnectionFailed=function(e){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))};t.prototype.phoneOnConnectionClosed=function(e){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};t.prototype.phoneOnMicResult=function(e){this.BXIM.webrtc.phoneMicAccess=e.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",e.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow)this.BXIM.webrtc.callDialogAllow.close()}if(e.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}};t.prototype.phoneOnNetStatsReceived=function(e){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED")return false;var s=100-parseInt(e.stats.packetLoss);var t=this.BXIM.webrtc.callPhoneOverlayMeter(s);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:e.stats.packetLoss,PERCENT:s,GRADE:t}))};t.prototype.phoneHold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=true;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneUnhold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=false;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;if(typeof e!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};t.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};t.prototype.phoneStartCallViaRestApp=function(e,t,r){s.rest.callMethod("voximplant.call.startViaRest",{NUMBER:e,LINE_ID:t,PARAMS:r,SHOW:"Y"})};t.prototype.phoneGetCallFields=function(e){if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="call")return{crm:false};var s=this.BXIM.messenger.chat[e];var t=s.entity_data_1.toString().split("|");if(t.length<3||t[0]!=="Y"){return{crm:false}}else{return{crm:true,crmEntityType:t[1],crmEntityId:t[2],crmShowUrl:this.BXIM.path.crm[t[1]].replace("#ID#",t[2])}}};t.prototype.getUser=function(e){return this.BXIM.messenger.users[e]||false};t.prototype.getHrPhoto=function(e,s){var t="";if(s===undefined){s=this.BXIM.messenger.users[e].color||""}if(e=="phone"){t="/bitrix/js/im/images/hidef-phone-v3.png"}else if(this.BXIM.messenger.hrphoto[e]){t=this.BXIM.messenger.hrphoto[e];if(this.BXIM.messenger.hrphoto[e]!="/bitrix/js/im/images/hidef-avatar-v3.png"){s=""}}else if(!this.BXIM.messenger.users[e]||this.BXIM.messenger.users[e].avatar==this.BXIM.pathToBlankImage){t="/bitrix/js/im/images/hidef-avatar-v3.png"}else{t=this.BXIM.messenger.users[e].avatar;s=""}return{src:t,color:s}};t.prototype.linesBodyScroll=function(){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0;return false}if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();s.defer(function(){(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:600,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()},this)()}else{s.defer(function(){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},this)()}};t.prototype.linesGetSessionHistory=function(r){s.ajax({url:this.BXIM.pathToAjax+"?SESSION_GET_HISTORY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionGetHistory",SESSION_ID:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.FILES){if(!this.BXIM.messenger.disk.files[r.CHAT_ID])this.BXIM.messenger.disk.files[r.CHAT_ID]={};if(this.BXIM.messenger.disk.files[r.CHAT_ID][i])continue;r.FILES[i].date=new Date(r.FILES[i].date);this.BXIM.messenger.disk.files[r.CHAT_ID][i]=r.FILES[i]}this.BXIM.messenger.sendAjaxTry=0;for(var i in r.MESSAGE){r.MESSAGE[i].date=new Date(r.MESSAGE[i].date);this.BXIM.messenger.message[i]=r.MESSAGE[i]}for(var i in r.USERS){r.USERS[i].last_activity_date=new Date(r.USERS[i].last_activity_date);r.USERS[i].mobile_last_date=new Date(r.USERS[i].mobile_last_date);r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.CHAT){if(!this.BXIM.messenger.chat[i]){r.CHAT[i].date_create=new Date(r.CHAT[i].date_create);this.BXIM.messenger.chat[i]=r.CHAT[i]}}if(r.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var i in r.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[i]=r.OPENLINES.canVoteAsHead[i]}}this.BXIM.messenger.linesShowHistory(r.CHAT_ID,{HISTORY:r.USERS_MESSAGE,FILES:r.FILES,CAN_JOIN:r.CAN_JOIN,CAN_VOTE_HEAD:r.CAN_VOTE_HEAD,SESSION_VOTE_HEAD:r.SESSION_VOTE_HEAD,SESSION_COMMENT_HEAD:r.SESSION_COMMENT_HEAD,SESSION_ID:r.SESSION_ID})}else{if(r.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(r.ERROR)}else if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(function(){t.prototype.linesGetSessionHistory(sessionID)},1e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0},this)})};t.prototype.linesJoinSession=function(e){s.ajax({url:this.BXIM.pathToAjax+"?JOIN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"joinSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesStartSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_CHAT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesStartSessionByMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSessionByMessage",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)})};t.prototype.linesOpenSession=function(e,t){t=t||{};s.ajax({url:this.BXIM.pathToAjax+"?OPEN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"openSession",USER_CODE:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(t.SLIDER=="Y"){this.BXIM.messenger.openMessengerSlider("chat"+e.CHAT_ID,t)}else{this.BXIM.messenger.openMessenger("chat"+e.CHAT_ID,t)}}else{if(e.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(e.ERROR)}}},this)})};t.prototype.linesVoteDraw=function(e){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE){return null}var t=this.BXIM.messenger.message[e];var r=false;if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){var i=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.message[e].chatId]);if(!i){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(i=="livechat"||i=="network")){return null}r=!this.BXIM.messenger.users[this.BXIM.userId].connector}else if(!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return null}var a="";var n=false;if(t.params.IMOL_VOTE=="like"){n=true;a=t.params.IMOL_VOTE_LIKE}else if(t.params.IMOL_VOTE=="dislike"){n=true;a=t.params.IMOL_VOTE_DISLIKE}else{a=t.params.IMOL_VOTE_TEXT}return s.create("div",{attrs:{"data-messageId":e},props:{className:"bx-messenger-content-item-vote-block"+(n?" bx-messenger-content-item-vote-block-done":"")},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-block-text"},html:s.util.htmlspecialchars(a)}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-buttons"},children:[s.create("span",{attrs:{title:s.message("IM_OL_VOTE_LIKE")},props:{className:"bx-messenger-content-item-vote-block-like"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"like")},this)}}),s.create("span",{attrs:{title:s.message("IM_OL_VOTE_DISLIKE")},props:{className:"bx-messenger-content-item-vote-block-dislike"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"dislike")},this)}})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-final"},children:[s.create("span",{props:{className:t.params.IMOL_VOTE=="dislike"?"bx-messenger-content-item-vote-block-smile-dislike":"bx-messenger-content-item-vote-block-smile-like"}})]})]})};t.prototype.linesVoteResultDraw=function(e,t){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE_SID){return t}var r=this.BXIM.messenger.message[e];var i="";if(typeof r.params.IMOL_VOTE_USER=="undefined"||r.params.IMOL_VOTE_USER==0){i=s.message("IM_OL_VOTE_WO")}else if(r.params.IMOL_VOTE_USER==5){i='<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>'}else{i='<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>'}var a=this.linesGetSession(this.BXIM.messenger.chat[r.chatId]);var n=this.linesVoteHeadNodes(r.params.IMOL_VOTE_SID,r.params.IMOL_VOTE_HEAD,a.canVoteHead);if(typeof r.params.IMOL_COMMENT_HEAD=="object"&&r.params.IMOL_COMMENT_HEAD){var o=r.params.IMOL_COMMENT_HEAD["text"]}else{var o=r.params.IMOL_COMMENT_HEAD}var l=this.linesCommentHeadNodes(r.params.IMOL_VOTE_SID,o,a.canVoteHead);return s.create("div",{attrs:{"data-messageId":e},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-message-text"},html:t}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result"},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_USER")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},html:i})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[n]})]}),l?s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_COMMENT_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[l]})]}):null]})]})};t.prototype.linesVoteSend=function(e,t,r){if(!this.BXIM.messenger.message[t]||!this.BXIM.messenger.message[t].params||!this.BXIM.messenger.message[t].params.IMOL_VOTE){return false}if(this.BXIM.messenger.message[t].date.getTime()/1e3+86400<(new Date).getTime()/1e3){this.BXIM.openConfirm(s.message("IM_OL_VOTE_END"));return false}if(e.toString().substr(0,4)=="chat"){if(!this.BXIM.messenger.users[this.BXIM.userId].connector){return false}}else if(!this.BXIM.messenger.bot[e]||this.BXIM.messenger.bot[e].type!="network"){return null}this.BXIM.messenger.message[t].params.IMOL_VOTE=r;var i=s("im-message-"+t);if(i){i.innerHTML="";i.appendChild(this.linesVoteDraw(t))}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_LINES_VOTE_SEND:"Y",DIALOG_ID:e,MESSAGE_ID:t,RATING:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(this.BXIM.messenger.popupMessengerLiveChatDelayedForm){clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(this.BXIM.messenger.popupMessengerLiveChatDelayedForm);this.BXIM.messenger.popupMessengerLiveChatDelayedForm=null},this),1e3)}},this)})};t.prototype.linesSaveToQuickAnswers=function(e,t){if(!this.BXIM.messenger.message[e]){return false}var r=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;this.BXIM.messenger.blockJoinChat[r]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SAVE_TO_QUICK_ANSWERS&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.message.saveToQuickAnswers",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+r)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"saveToQuickAnswers",CHAT_ID:r,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(i){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){if(i.ERROR){this.BXIM.openConfirm(i.ERROR)}else{this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_SUCCESS"));this.BXIM.messenger.message[e].quick_saved=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_ERROR"))}},this)})};t.prototype.linesVoteHeadNodes=function(e,t,r,i){t=t||0;r=r||false;var a=s.delegate(function(){var e=s.proxy_context.getAttribute("data-rating");var t=s.proxy_context.getAttribute("data-sessionId");s.proxy_context.parentNode.previousSibling.style.width=e*20+"%";if(i)i.setAttribute("data-rating",e);this.linesVoteHeadSend(t,e);if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()},this);return s.create("div",{props:{className:"bx-lines-rating-box"},children:[s.create("div",{props:{className:"bx-lines-rating-box-current"},attrs:{style:"width:"+t*20+"%"}}),r?s.create("div",{props:{className:"bx-lines-rating-box-live"},children:[s.create("span",{attrs:{"data-rating":1,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":2,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":3,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":4,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":5,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}})]}):null]})};t.prototype.linesCommentHeadNodes=function(e,t,r,i){var a=null;if(!i){i="im"}if(typeof t==="undefined"||t===null||t==="")t="";r=r||false;var n=s.delegate(function(){if(this.BXIM.messenger.linesCommentHeadAdd){this.BXIM.messenger.linesCommentHeadAdd(null,t)}if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()},this);if(t===""){if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-add"},html:s.message("IM_OL_COMMENT_HEAD_ADD"),events:{click:n}})}}else{var o=t.replace(/\n/gi,"<br />");if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-edit"},html:o,events:{click:n}})}else{a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-not-edit"},html:o})}}return a};t.prototype.linesVoteHeadSend=function(e,t,r){var i=false;if(!t){t=null}if(!r){r=null}e=parseInt(e);t=parseInt(t);if(t<=0||t>5||isNaN(t)){t=null}if(e>0&&(t!=null||r!=null)){if(t!=null){if(!this.BXIM.messenger.openlines["voteRatingHead"]){this.BXIM.messenger.openlines["voteRatingHead"]={}}this.BXIM.messenger.openlines["voteRatingHead"][e]=t}if(r!=null){if(!this.BXIM.messenger.openlines["voteCommentHead"]){this.BXIM.messenger.openlines["voteCommentHead"]={}}this.BXIM.messenger.openlines["voteCommentHead"][e]=r}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"voteHead",SESSION_ID:e,RATING:t,COMMENT:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});i=true}return i};t.prototype.linesCanVoteAsHead=function(e){if(!this.BXIM.messenger.openlines||!this.BXIM.messenger.openlines.canVoteAsHead||!this.BXIM.messenger.openlines.canVoteAsHead[e]){return false}return true};t.prototype.linesGetCrmPath=function(e,s){if(!this.BXIM.path.crm[e])return"";return this.BXIM.path.crm[e].replace("#ID#",s)};t.prototype.linesGetSession=function(e){var s=null;if(!e||e.type!="lines")return s;s={};s.source=this.linesGetSource(e);var t=e.entity_id.toString().split("|");s.connector=t[0];s.lineId=t[1];s.canVoteHead=this.linesCanVoteAsHead(t[1]);var r=e.entity_data_1.toString().split("|");var i=e.entity_data_2.toString().split("|");s.crm=typeof r[0]!="undefined"&&r[0]=="Y"?"Y":"N";s.crmEntityType=typeof r[1]!="undefined"?r[1]:"NONE";s.crmEntityId=typeof r[2]!="undefined"?r[2]:0;s.crmLink="";s.pin=typeof r[3]!="undefined"&&r[3]=="Y"?"Y":"N";s.wait=typeof r[4]!="undefined"&&r[4]=="Y"?"Y":"N";s.id=typeof r[5]!="undefined"?parseInt(r[5]):Math.round(new Date/1e3)+e.id;s.dateCreate=typeof r[6]!="undefined"||r[6]>0?parseInt(r[6]):s.id;s.crmLinkLead="";s.crmLead=0;s.crmLinkCompany="";s.crmCompany=0;s.crmLinkContact="";s.crmContact=0;s.crmLinkDeal="";s.crmDeal=0;if(i){var a;for(a=0;a<i.length;a=a+2){if(i[a]=="LEAD"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkLead=this.linesGetCrmPath("LEAD",i[a+1]);s.crmLead=i[a+1]}if(i[a]=="COMPANY"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkCompany=this.linesGetCrmPath("COMPANY",i[a+1]);s.crmCompany=i[a+1]}if(i[a]=="CONTACT"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkContact=this.linesGetCrmPath("CONTACT",i[a+1]);s.crmContact=i[a+1]}if(i[a]=="DEAL"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkDeal=this.linesGetCrmPath("DEAL",i[a+1]);s.crmDeal=i[a+1]}else{s.crmDeal=0}}}if(s.crmEntityType!="NONE"){s.crmLink=this.linesGetCrmPath(s.crmEntityType,s.crmEntityId)}return s};t.prototype.linesSetSession=function(e,s){var t=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines")return t;t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(typeof s.crm!="undefined"){t.crm=s.crm}if(typeof s.crmEntityType!="undefined"){t.crmEntityType=s.crmEntityType}if(typeof s.crmEntityId!="undefined"){t.crmEntityId=s.crmEntityId}if(typeof s.pin!="undefined"){t.pin=s.pin}if(typeof s.wait!="undefined"){t.wait=s.wait}if(typeof s.id!="undefined"){t.id=s.id}if(typeof s.dateCreate!="undefined"){t.dateCreate=s.dateCreate}if(typeof s.crmLead!="undefined"){t.crmLead=s.crmLead}if(typeof s.crmCompany!="undefined"){t.crmCompany=s.crmCompany}if(typeof s.crmContact!="undefined"){t.crmContact=s.crmContact}if(typeof s.crmDeal!="undefined"){t.crmDeal=s.crmDeal}this.BXIM.messenger.chat[e].entity_data_1=[t.crm,t.crmEntityType,t.crmEntityId,t.pin,t.wait,t.id,t.dateCreate].join("|");this.BXIM.messenger.chat[e].entity_data_2="LEAD|"+t.crmLead+"|COMPANY|"+t.crmCompany+"|CONTACT|"+t.crmContact+"|DEAL|"+t.crmDeal;return t};t.prototype.livechatGetSession=function(e){var s=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="livechat")return s;s={};var t=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");s.readed=typeof t[0]!="undefined"&&t[0]=="Y"?"Y":"N";s.readedId=typeof t[1]!="undefined"?t[1]:0;s.readedTime=typeof t[2]!="undefined"?t[2]:false;s.sessionId=typeof t[3]!="undefined"?t[3]:0;s.showForm=typeof t[4]!="undefined"?t[4]:"Y";return s};t.prototype.linesGetSource=function(e){var s="";if(!e||!(e.type=="livechat"||e.type=="lines")){return s}if(e.type=="livechat"){s="livechat"}else{s=e.entity_id.toString().split("|")[0]}if(s=="skypebot"){s="skype"}else{s=s.replace(".","_")}return s};t.prototype.linesAnswer=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ANSWER&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.answer",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"answer",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesSkip=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SKIP&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.skip",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"skip",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(this.closeSlider()){return true}this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesActivateSilentMode=function(e,t,r){if(!r)return false;if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"";if(this.BXIM.messenger.chat[e].entity_data_3==t)return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_SILENT_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"silentMode",ACTIVATE:t?"Y":"N",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.chat[e].entity_data_3=t},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesActivatePinMode=function(e,t){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"N";this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_PIN_MODE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.pin",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e),data:{timLinesPinAction:t}}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"pinMode",ACTIVATE:t,CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{pin:t})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesCloseDialog=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.MessengerCommon.dialogCloseCurrent();s.ajax({url:this.BXIM.pathToAjax+"?LINES_CLOSE_DIALOG&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.finish",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"closeDialog",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesMarkAsSpam=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_MARK_SPAM&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.spam",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"markSpam",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.linesSetSession(e,{id:0,wait:"Y"});this.dialogCloseCurrent();this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesInterceptSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_INTERCEPT_SESSION&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.session.intercept",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"interceptSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesCreateLead=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;var t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(t.crm=="Y")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CREATE_LEAD&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.create",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"createLead",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesChangeCrmEntity=function(t){if(!this.BXIM.messenger.message[t])return false;var r=this.BXIM.messenger.message[t].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;var i=this.linesGetSession(this.BXIM.messenger.chat[r]);if(i.crm=="N")return false;this.linesChangeCrmEntityMessageId=t;if(e.obCrm&&e.obCrm.olCrmSelector){e.obCrm.olCrmSelector.Open()}else{s.ajax({url:BXIM.pathToAjax+"?CRM_SELECTOR&V="+BXIM.revision,method:"POST",timeout:30,data:{IM_CRM_SELECTOR:"Y",sessid:s.bitrix_sessid()}});s.addCustomEvent("onCrmSelectorInit",function(t,r,i){if(r!="olCrmSelector")return true;setTimeout(function(){e.obCrm[r].Open();e.obCrm[r].AddOnSaveListener(function(e){s.MessengerCommon.linesChangeCrmEntityAjax(e)})},200)})}};t.prototype.linesChangeCrmEntityAjax=function(e){var t=false;for(var r in e["company"]){t=e["company"][r]}if(!t){for(var r in e["contact"]){t=e["contact"][r]}}if(!t){for(var r in e["lead"]){t=e["lead"][r]}}if(!t){return false}var i=this.linesChangeCrmEntityMessageId;if(!this.BXIM.messenger.message[i])return false;var a=this.BXIM.messenger.message[i].chatId;if(this.BXIM.messenger.blockJoinChat[a])return false;if(this.BXIM.messenger.chat[a]&&this.BXIM.messenger.chat[a].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(a))return false;var n=t.id.split("_")[1];var o=t.type;this.BXIM.messenger.blockJoinChat[a]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CHANGE_CRM_ENTITY&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.change",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+a)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"changeCrmEntity",CHAT_ID:a,MESSAGE_ID:i,ENTITY_TYPE:o,ENTITY_ID:n,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[a]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[a]=false},this)})};t.prototype.linesCancelCrmExtend=function(e){if(!this.BXIM.messenger.message[e])return false;var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CANCEL_CRM_EXTEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.cancel",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+t)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"cancelCrmExtend",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)});s.remove(s("im-message-keyboard-"+e))};t.prototype.getMessagePlural=function(e,t){var r,i;i=s.message("LANGUAGE_ID")||"en";t=parseInt(t);if(t<0){t=-1*t}if(i){switch(i){case"de":case"en":r=t!==1?1:0;break;case"ru":case"ua":r=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;default:r=1;break}}else{r=1}return s.message(e+"_PLURAL_"+r)};t.prototype.openStore=function(){if(!s.MessengerCommon.isSliderSupport()){this.BXIM.openConfirm(s.message("IM_FUNCTION_FOR_BROWSER"));return false}var e=this.getDialogId();var t=this.linesGetSession(this.BXIM.messenger.chat[e.substr(4)]);s.SidePanel.Instance.open(s.util.add_url_param("/salescenter/app/",{dialogId:this.getDialogId()}))};t.prototype.openRenamePortal=function(e){if(e&&s.hasClass(e,"bx-messenger-keyboard-button-block")){return false}if(this.isMobile()){app.alert({text:s.message("IM_FUNCTION_FOR_BROWSER")})}if(this.isDesktop()){s.desktop.browse(this.BXIM.path.profile+"?b24renameform=1","desktopApp")}else if(typeof s.Bitrix24!="undefined"){s.Bitrix24.renamePortal()}else{this.BXIM.openConfirm(s.message("IM_UNKNOWN_ERROR"))}return true};t.prototype.updateUserData=function(e){var t;if(s.type.isPlainObject(e.users)){for(t in e.users){e.users[t].last_activity_date=new Date(e.users[t].last_activity_date);e.users[t].mobile_last_date=new Date(e.users[t].mobile_last_date);e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.BXIM.messenger.users[t]=e.users[t]}}if(s.type.isPlainObject(e.hrphoto)){for(t in e.hrphoto){this.BXIM.messenger.hrphoto[t]=e.hrphoto[t]}}if(s.type.isPlainObject(e.chat)){for(t in e.chat){e.chat[t].date_create=new Date(e.chat[t].date_create);this.BXIM.messenger.chat[t]=e.chat[t]}}if(s.type.isPlainObject(e.userInChat)){for(t in e.userInChat){this.BXIM.messenger.userInChat[t]=e.userInChat[t]}}};s.MessengerCommon=new t;var r=function(){this.list={};this.updateInterval=1e3;clearInterval(this.updateIntervalId);this.updateIntervalId=setInterval(this.worker.bind(this),this.updateInterval)};r.prototype.start=function(e,s,t,r,i){s=s===null?"default":s;t=parseInt(t);if(t<=0||s.toString().length<=0){return false}if(typeof this.list[e]=="undefined"){this.list[e]={}}this.list[e][s]={dateStop:(new Date).getTime()+t,callback:typeof r=="function"?r:function(){},callbackParams:typeof i=="undefined"?{}:i};return true};r.prototype.stop=function(e,s,t){s=s===null?"default":s;if(s.toString().length<=0||typeof this.list[e]=="undefined"){return false}if(!this.list[e][s]){return true}if(t!==true){this.list[e][s]["callback"](s,this.list[e][s]["callbackParams"])}delete this.list[e][s];return true};r.prototype.stopAll=function(e){for(var s in this.list){if(this.list.hasOwnProperty(s)){for(var t in this.list[s]){if(this.list[s].hasOwnProperty(t)){this.stop(s,t,e)}}}}return true};r.prototype.worker=function(){for(var e in this.list){if(!this.list.hasOwnProperty(e)){continue}for(var s in this.list[e]){if(!this.list[e].hasOwnProperty(s)||this.list[e][s]["dateStop"]>new Date){continue}this.stop(e,s)}}return true};r.prototype.destroy=function(){clearInterval(this.updateIntervalId);this.stopAll(true);return true};s.MessengerTimer=new r})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:43:"/bitrix/js/im/window.min.js?155775640417163";s:6:"source";s:23:"/bitrix/js/im/window.js";s:3:"min";s:27:"/bitrix/js/im/window.min.js";s:3:"map";s:27:"/bitrix/js/im/window.map.js";}"*/
(function(t){if(t.BX.MessengerWindow)return;var e=t.BX;var s=function(){this.popupConfirm=null;this.BXIM={};this.popup=null;this.backgroundSelector=null;this.content=null;this.contentFullWindow=true;this.contentBodyWindow=false;this.contentMenu=null;this.contentAvatar=null;this.contentTab=null;this.contentTabContent=null;this.currentTab="";this.currentTabTarget="";this.lastTab="";this.lastTabTarget="";this.tabItems={};this.tabRedrawTimeout=null;this.userInfo={id:0,name:"",gender:"M",avatar:"",profile:""};this.inited=false;this.width=914;this.height=454;this.initWidth=914;this.initHeight=454;this.minWidth=515;this.minHeight=384};s.prototype.init=function(s){s=s||{};if(this.inited){return true}this.inited=true;this.BXIM=s.bxim||{};this.context=s.context||"DESKTOP";this.design=s.design||"DESKTOP";if(this.context=="FULLSCREEN"||this.context=="POPUP-FULLSCREEN"||this.context=="PAGE"||this.context=="DIALOG"||this.context=="LINES"){if(this.context=="FULLSCREEN"||this.context=="PAGE"||this.context=="POPUP-FULLSCREEN"){this.contentBodyWindow=true}this.popup=e("im-workarea-popup");this.popupBackground=this.popup;this.content=e("im-workarea-content");this.apps=e("im-workarea-apps");this.backgroundSelector=e("im-workarea-backgound-selector");if(!this.content){this.popup=e("workarea-popup");this.content=e("workarea-content")}if(this.popup){e.addClass(this.popup,"bx-im-fullscreen-closed");e.bind(this.popup,"click",e.delegate(this.closePopup,this))}else{this.popupBackground=e("im-workarea-popup-bg")}if(this.context=="PAGE"){var i=t.innerWidth-document.documentElement.clientWidth;e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,i]);e.addClass(document.body,"bx-im-fullscreen-block-scroll")}if(this.backgroundSelector){e.bind(this.backgroundSelector.parentNode,"click",e.delegate(e.PreventDefault,this));e.bind(this.backgroundSelector,"change",e.delegate(function(t){this.backgroundChange();e.localStorage.set("imFullscreenBackground",this.backgroundSelector.value,3e6);return e.PreventDefault(t)},this));var n=e.localStorage.get("imFullscreenBackground");if(n!==null){this.backgroundSelector.value=n}this.backgroundChange()}if(!this.content){this.content=e.create("div",{attrs:{className:"bx-desktop"}});document.body.insertBefore(this.content,document.body.firstChild)}if(this.apps){e.bind(this.apps,"click",e.delegate(e.MessengerCommon.preventDefault,this))}e.bind(this.content,"click",e.delegate(e.MessengerCommon.preventDefault,this));if(!e.hasClass(this.content,"bx-desktop")){e.addClass(this.content,"bx-desktop")}if(this.context=="LINES"||this.context=="DIALOG"){this.contentFullWindow=false}else if(this.context!="POPUP-FULLSCREEN"){if(this.content.offsetWidth<this.minWidth){e.style(this.content,"width",this.minWidth+"px")}}}else{this.content=e.create("div");document.body.insertBefore(this.content,document.body.firstChild)}if(e.desktop&&e.desktop.apiReady&&(navigator.userAgent.toLowerCase().indexOf("linux")>0&&!e.desktop.enableInVersion(29)||navigator.userAgent.toLowerCase().indexOf("linux")<0&&!e.desktop.enableInVersion(37))){e.PULL.tryConnectSet(null,false);e.desktop.notSupported();e.desktop.apiReady=false;e.desktop.disableLogin=true;return false}if(e.browser.SupportLocalStorage()){e.addCustomEvent(t,"onLocalStorageSet",e.delegate(this.storageSet,this))}if(e.MessengerCommon.isDesktop()){e.MessengerWindow.addTab({id:"exit",title:e.message("BXD_LOGOUT"),order:1100,target:false,events:{open:e.delegate(function(){this.logout(false,"exit_tab")},this)}})}e.bind(t,"resize",e.delegate(function(){this.adjustSize()},this))};s.prototype.browse=function(s){if(e.MessengerCommon.isDesktop()){e.desktop.browse(s)}else if(this.context=="POPUP-FULLSCREEN"){location.href=s}else{t.open(s,"_blank")}};s.prototype.getCurrentUrl=function(){return document.location.protocol+"//"+document.location.hostname+(document.location.port==""?"":":"+document.location.port)};s.prototype.windowReload=function(){location.reload()};s.prototype.logout=function(t,s,i){if(typeof BXDesktopSystem=="undefined"||typeof BXDesktopWindow=="undefined"){location.href="/?logout=yes";return true}if(e.desktop&&e.desktop.apiReady){e.desktop.logout(t,s,i)}return true};s.prototype.adjustSize=function(s,i){if(this.context=="POPUP-FULLSCREEN"&&e.hasClass(this.popup,"bx-im-fullscreen-closed")){return false}var n=0;var o=0;var a=false;if(this.contentBodyWindow){if(!this.popupFullscreenSizeTop&&!this.popupFullscreenSizeBottom){var r=e.pos(e.MessengerWindow.content.parentNode);this.popupFullscreenSizeTop=r.top;this.popupFullscreenSizeBottom=t.innerHeight-r.top-r.height}o=Math.max(t.innerHeight-this.popupFullscreenSizeTop-this.popupFullscreenSizeBottom,this.initHeight);n=e.MessengerWindow.content.offsetWidth}else if(this.contentFullWindow){n=t.innerWidth;o=t.innerHeight}else{try{e.style(document.body,"height",t.innerHeight+"px")}catch(t){setTimeout(function(){e.MessengerWindow.adjustSize(s,i)},500)}n=Math.max(this.content.offsetWidth,this.minWidth);o=Math.max(this.content.offsetHeight,this.minHeight)}if(e.desktop&&e.desktop.apiReady&&(!s||!i)&&(o<this.minHeight||n<this.minWidth)){BXDesktopWindow.SetProperty("clientSize",{Width:this.width,Height:this.height});return false}if(this.context=="POPUP-FULLSCREEN"&&e.browser.IsMobile()){this.height=this.initHeight;this.width=this.initWidth}else{e.addClass(this.content,"bx-im-fullscreen-adaptive");this.width=s?s:n;this.height=i?i:o}e.style(this.contentMenu,"height",this.height+"px");e.style(this.contentTabContent,"height",this.height+"px");e.style(this.content,"max-width",t.innerWidth+"px");return true};s.prototype.openConfirm=function(t,s,i){if(this.popupConfirm!=null)this.popupConfirm.destroy();if(typeof t=="object")t='<div class="bx-desktop-confirm-title">'+t.title+"</div>"+t.message;i=i!==false;if(typeof s=="undefined"||typeof s=="object"&&s.length<=0){s=[new e.PopupWindowButton({text:e.message("BXD_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:function(t){this.popupWindow.close();e.PreventDefault(t)}}})]}this.popupConfirm=new e.PopupWindow("bx-desktop-confirm",null,{zIndex:200,autoHide:s===false,buttons:s,closeByEsc:s===false,overlay:i,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:e.delegate(function(){this.popupConfirm=null},this)},content:e.create("div",{props:{className:s===false?" bx-desktop-confirm-without-buttons":"bx-desktop-confirm"},html:t})});this.popupConfirm.show();e.bind(this.popupConfirm.popupContainer,"click",e.PreventDefault);e.bind(this.popupConfirm.contentContainer,"click",e.PreventDefault);e.bind(this.popupConfirm.overlay.element,"click",e.PreventDefault);return true};s.prototype.addSeparator=function(t){t.type="separator";t.id="sep"+ +new Date;this.tabItems[t.id]=t;this.drawTabs()};s.prototype.addTab=function(t){if(!t||!t.id||!t.title)return false;if(!t.order)t.order=500;t.hide=t.hide?true:false;if(parseInt(t.badge)>0){t.badge=parseInt(t.badge)}else{t.badge=0}if(!t.initContent||!e.type.isDomNode(t.initContent))t.initContent=null;if(!t.events)t.events={};if(typeof t.target=="undefined")t.target=t.id;if(!t.events.open)t.events.open=function(){};if(!t.events.close)t.events.close=function(){};if(!t.events.init)t.events.init=function(){};t.type="item";this.tabItems[t.id]=t;this.drawTabs()};s.prototype.hideTab=function(t){if(!t||!this.tabItems[t])return false;this.tabItems[t].hide=true;this.drawTabs()};s.prototype.showTab=function(t){if(!t||!this.tabItems[t])return false;this.tabItems[t].hide=false;this.drawTabs()};s.prototype.existsTab=function(t){return this.tabItems[t]};s.prototype.drawTabs=function(t){if(!t){clearTimeout(this.tabRedrawTimeout);this.tabRedrawTimeout=setTimeout(e.delegate(function(){this.drawTabs(true)},this),100);return true}if(!this.contentTabContent){if(!this.drawAppearance())return false}this.contentTab.innerHTML="";var s=e.util.objectSort(this.tabItems,"order","asc");for(var i=0;i<s.length;i++){this.drawTab(s[i])}e.onCustomEvent(this,"OnDesktopTabsInit");if(this.currentTab==""){if(s[0].id=="exit"){if(typeof s[1]!="undefined"){this.changeTab(s[1].id)}}else{this.changeTab(s[0].id)}}if(e.desktop&&e.desktop.apiReady){e.desktop.updateTabBadge()}return true};s.prototype.drawTab=function(t){if(t.type=="separator"){this.contentTab.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-sep-"+t.id},props:{className:"bx-desktop-separator"}}))}else{this.contentTab.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-tab-"+t.id,title:t.title},props:{className:"bx-desktop-tab bx-desktop-tab-"+t.id+(this.currentTab==t.id?" bx-desktop-tab-active":"")+(t.hide?" bx-desktop-tab-hide":"")},children:[e.create("span",{props:{className:"bx-desktop-tab-counter"},html:t.badge>0?'<span class="bx-desktop-tab-counter-digit">'+(t.badge>50?"50+":t.badge)+"</span>":""}),e.create("div",{props:{className:"bx-desktop-tab-icon bx-desktop-tab-icon-"+t.id}})]}));if(!e("bx-desktop-tab-content-"+t.id)&&t.id==t.target){var s=false;if(this.currentTab==t.id||this.tabItems[this.currentTab]&&this.tabItems[this.currentTab].target==t.id){s=true}this.contentTabContent.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-tab-content-"+t.id},props:{className:"bx-desktop-tab-content bx-desktop-tab-content-"+t.id+(s?" bx-desktop-tab-content-active":"")},children:t.initContent?[t.initContent]:[]}));t.events.init()}}return true};s.prototype.drawAppearance=function(){if(!this.content)return false;this.content.innerHTML="";this.content.appendChild(this.contentBox=e.create("div",{props:{className:"bx-desktop-appearance"},style:{minHeight:this.minHeight+"px"},children:[this.contentMenu=e.create("div",{props:{className:"bx-desktop-appearance-menu"},children:[this.contentAvatar=e.create("div",{props:{className:"bx-desktop-appearance-avatar"}}),this.contentTab=e.create("div",{props:{className:"bx-desktop-appearance-tab"}})]}),this.contentTabContent=e.create("div",{props:{className:"bx-desktop-appearance-content"}})]}));e.bindDelegate(this.contentTab,"click",{className:"bx-desktop-tab"},e.delegate(function(t){this.changeTab(t,false);e.PreventDefault(t)},this));this.adjustSize();e.onCustomEvent(t,"onMessengerWindowInit",[this,this.BXIM]);return true};s.prototype.changeTab=function(t,s,i){s=typeof s=="undefined"?true:s;i=typeof i=="undefined"?false:i;if(typeof t=="object"){if(!e.proxy_context){return false}t=e.proxy_context.getAttribute("data-id")}if(!this.tabItems[t])return false;if(this.tabItems[t].target){var n=false;if(!s||this.currentTab!=t){this.lastTab=this.currentTab;this.lastTabTarget=this.currentTabTarget;this.currentTab=this.tabItems[t].id;this.currentTabTarget=this.tabItems[t].target;n=true}if(e("bx-desktop-tab-"+this.lastTab))e.removeClass(e("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active");if(e("bx-desktop-tab-"+t))e.addClass(e("bx-desktop-tab-"+t),"bx-desktop-tab-active");if(e("bx-desktop-tab-content-"+this.lastTab)){e.removeClass(e("bx-desktop-tab-content-"+this.lastTab),"bx-desktop-tab-content-active")}else if(e("bx-desktop-tab-content-"+this.lastTabTarget)){e.removeClass(e("bx-desktop-tab-content-"+this.lastTabTarget),"bx-desktop-tab-content-active")}if(e("bx-desktop-tab-content-"+this.currentTab)){e.addClass(e("bx-desktop-tab-content-"+this.currentTab),"bx-desktop-tab-content-active")}else if(e("bx-desktop-tab-content-"+this.currentTabTarget)){e.addClass(e("bx-desktop-tab-content-"+this.currentTabTarget),"bx-desktop-tab-content-active")}if(n&&!i){if(this.tabItems[this.lastTab]){this.tabItems[this.lastTab].events.close()}if(this.tabItems[this.currentTab]){e.onCustomEvent(this,"OnDesktopTabChange",[this.currentTab,this.lastTab]);this.tabItems[this.currentTab].events.open()}}}else if(!i){this.tabItems[t].events.open()}return true};s.prototype.closeTab=function(t){t=t||this.getCurrentTab();if(!this.tabItems[t]||this.getCurrentTab()!=t)return false;if(this.tabItems[t].target!=this.currentTabTarget){this.changeTab(t,false)}else{if(e("bx-desktop-tab-"+this.currentTab))e.removeClass(e("bx-desktop-tab-"+this.currentTab),"bx-desktop-tab-active");if(e("bx-desktop-tab-"+this.lastTab))e.addClass(e("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active");var s=this.lastTab;this.lastTab=this.currentTab;this.currentTab=s}};s.prototype.setTabBadge=function(t,s){if(!this.tabItems[t])return false;s=parseInt(s);this.tabItems[t].badge=s>0?s:0;if(s>50)s="50+";if(e("bx-desktop-tab-"+t)){var i=e.findChild(e("bx-desktop-tab-"+t),{className:"bx-desktop-tab-counter"},true);if(i)i.innerHTML=s?'<span class="bx-desktop-tab-counter-digit">'+s+"</span>":""}if(e.desktop&&e.desktop.apiReady){e.desktop.updateTabBadge()}};s.prototype.setTabContent=function(t,s){if(!this.tabItems[t])return false;if(e("bx-desktop-tab-content-"+t)){if(e.type.isDomNode(s)){e("bx-desktop-tab-content-"+t).innerHTML="";e("bx-desktop-tab-content-"+t).appendChild(s)}else{e("bx-desktop-tab-content-"+t).innerHTML=s}}else{this.tabItems[t].initContent=s}return true};s.prototype.getCurrentTab=function(){return this.currentTab};s.prototype.getCurrentTabTarget=function(){return this.currentTabTarget};s.prototype.setUserInfo=function(t){if(!this.userInfo){if(!t||!t.id||!t.name)return false}if(t){if(!t.gender)t.gender="M";if(!t.avatar||!t.profile)t.avatar="";this.userInfo=t}if(!this.contentAvatar){if(!this.drawAppearance())return false}var s={};s.click=function(t){BXIM.openMessenger(BXIM.userId);return e.PreventDefault(t)};this.contentAvatar.innerHTML="";this.contentAvatar.appendChild(e.create("a",{attrs:{href:this.userInfo.profile,title:e.util.htmlspecialcharsback(this.userInfo.name),target:"_blank"},props:{className:"bx-desktop-avatar"},events:s,children:[e.create("img",{attrs:{src:this.userInfo.avatar,style:e.MessengerCommon.isBlankAvatar(this.userInfo.avatar)?"background-color: "+this.userInfo.color:""},props:{className:"bx-desktop-avatar-img bx-desktop-avatar-img-default"}})]}));return true};s.prototype.updateUserInfo=function(t){for(var e in t){this.userInfo[e]=t[e]}return this.setUserInfo(this.userInfo)};s.prototype.getUserInfo=function(){return this.userInfo};s.prototype.isPopupShow=function(){if(this.context=="DESKTOP")return true;else if(this.context=="PAGE")return true;else if(this.context=="POPUP-FULLSCREEN"&&!e.hasClass(this.popup,"bx-im-fullscreen-closed"))return true;return false};s.prototype.backgroundChange=function(){var t=this.backgroundSelector.value;if(t=="transparent"){e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.addClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.style(this.popupBackground,"background","");e.style(this.popupBackground,"backgroundSize","")}else if(t>0){e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.style(this.popupBackground,"background","url(/bitrix/js/im/images/bg-image-"+t+".jpg) #ccc");e.style(this.popupBackground,"backgroundSize","cover")}else{e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.addClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.style(this.popupBackground,"background","");e.style(this.popupBackground,"backgroundSize","")}};s.prototype.showPopup=function(s){if(this.isPopupShow())return false;this.popupTimestart=+new Date;clearTimeout(this.popupTimeout);var i=t.innerWidth-document.documentElement.clientWidth;e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,i]);e.addClass(document.body,"bx-im-fullscreen-block-scroll");e.addClass(this.popup,"bx-im-fullscreen-opening");e.removeClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-closed");this.adjustSize();this.BXIM.desktop.initHeight=e.MessengerWindow.content.offsetHeight;this.popupTimeout=setTimeout(e.delegate(function(){e.removeClass(this.popup,"bx-im-fullscreen-opening");e.addClass(this.popup,"bx-im-fullscreen-open")},this),400);if(e.SidePanel&&e.SidePanel.Instance.getTopSlider()){var n=e.SidePanel.Instance.getTopSlider().getZindex();e.style(this.popup,"z-index",n+1)}e.onCustomEvent(this,"OnMessengerWindowShowPopup",[s]);return true};s.prototype.closePopup=function(s){if(!e.type.isPlainObject(s)){s={}}if(!this.isPopupShow()||this.BXIM.callController.hasActiveCall()||this.redirectFlag)return false;if(this.popupTimestart+400>+new Date)return false;if(s.redirect){this.redirectFlag=true;document.location.href=s.redirect;return true}clearTimeout(this.popupTimeout);e.removeClass(document.body,"bx-im-fullscreen-block-scroll");e.onCustomEvent(this,"OnMessengerWindowClosePopup",[]);e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,0]);e.addClass(this.popup,"bx-im-fullscreen-open");e.addClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-opening");this.popupTimeout=setTimeout(e.delegate(function(){e.removeClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-open");e.addClass(this.popup,"bx-im-fullscreen-closed");e.style(this.popup,"z-index","")},this),400);return true};s.prototype.storageSet=function(t){if(t.key=="imFullscreenBackground"){this.backgroundSelector.value=t.value;this.backgroundChange()}};e.MessengerWindow=new s})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:36:"/bitrix/js/im/im.js?1557756405806595";s:6:"source";s:19:"/bitrix/js/im/im.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function() {

if (BX.IM)
	return;

BX.IM = function(domNode, params)
{
	if(typeof(BX.message("USER_TZ_OFFSET")) === 'undefined' || BX.message("USER_TZ_AUTO") == 'Y')
		BX.message({"USER_TZ_OFFSET": -(new Date).getTimezoneOffset()*60-parseInt(BX.message("SERVER_TZ_OFFSET"))});

	if (typeof(BX.MessengerCommon) != 'undefined')
		BX.MessengerCommon.setBxIm(this);

	this.mobileVersion = false;
	this.mobileAction = 'none';

	this.revision = 122; // api version - im/lib/revision.php
	this.ieVersion = BX.browser.DetectIeVersion();
	this.errorMessage = '';
	this.animationSupport = true;
	this.context = params.context;
	this.design = params.design;
	this.bitrixNetwork = params.bitrixNetwork;
	this.bitrixNetwork2 = params.bitrixNetwork2;
	this.bitrixOpenLines = params.bitrixOpenLines;
	this.bitrix24 = params.bitrix24;
	this.isAdmin = params.isAdmin;
	this.bitrixIntranet = params.bitrixIntranet;
	this.bitrix24net = params.bitrix24net;
	this.bitrixXmpp = params.bitrixXmpp;
	this.bitrixMobile = params.bitrixMobile;
	this.colors = params.colors;
	this.colorsHex = params.colorsHex;
	this.ppStatus = params.ppStatus;
	this.ppServerStatus = this.ppStatus? params.ppServerStatus: false;
	this.updateStateInterval = params.updateStateInterval;
	this.desktopStatus = params.desktopStatus || false;
	this.desktopVersion = params.desktopVersion;
	this.desktopProtocolVersion = 2;
	this.xmppStatus = params.xmppStatus;
	this.lastRecordId = 0;
	this.userId = params.userId;
	this.userEmail = params.userEmail;
	this.userColor = params.userColor;
	this.userGender = params.userGender;
	this.userExtranet = params.userExtranet;
	this.options = params.options || {};
	this.path = params.path;
	this.language = params.language || 'en';
	this.init = typeof(params.init) != 'undefined'? params.init: true;
	this.windowFocus = true;
	this.windowFocusTimeout = null;
	this.extraBind = null;
	this.extraOpen = false;
	this.dialogOpen = false;
	this.notifyOpen = false;
	this.adjustSizeTimeout = null;
	this.tryConnect = true;
	this.openSettingsFlag =  typeof(params.openSettings) != 'undefined'? params.openSettings: false;
	this.popupConfirm = null;

	this.settings = params.settings;
	this.settingsDisabled = {};
	this.settingsView = params.settingsView || {common:{}, notify:{}, privacy:{}};
	this.settingsNotifyBlocked = params.settingsNotifyBlocked || {};
	this.settingsTableConfig = {};
	this.settingsSaveCallback = {};
	this.settingsCameraTestMediaStream = null;
	this.micTestMediaStream = null;
	this.settingsLevelMeter = null;
	this.saveSettingsTimeout = {};
	this.popupSettings = null;
	if (params.users && params.users[this.userId])
		params.users[this.userId].status = this.settings.status;

	this.pathToAjax = params.path.im? params.path.im: '/bitrix/components/bitrix/im.messenger/im.ajax.php';
	this.pathToCallAjax = params.path.call? params.path.call: '/bitrix/components/bitrix/im.messenger/call.ajax.php';
	this.pathToFileAjax = params.path.file? params.path.file: '/bitrix/components/bitrix/im.messenger/file.ajax.php';
	this.pathToBlankImage = '/bitrix/js/im/images/blank.gif';

	this.audio = {};
	this.audio.reminder = null;
	this.audio.newMessage1 = null;
	this.audio.newMessage2 = null;
	this.audio.send = null;
	this.audio.dialtone = null;
	this.audio.ringtone = null;
	this.audio.start = null;
	this.audio.stop = null;
	this.audio.current = null;
	this.audio.timeout = {};

	this.mailCount = params.mailCount;
	this.notifyCount = params.notifyCount || 0;
	this.messageCount = params.messageCount || 0;
	this.linesCount = params.linesCount || 0;

	this.quirksMode = (BX.browser.IsIE() && !BX.browser.IsDoctype() && (/MSIE 8/.test(navigator.userAgent) || /MSIE 9/.test(navigator.userAgent)));
	this.platformName = BX.browser.IsMac()? 'OS X': (/windows/.test(navigator.userAgent.toLowerCase())? 'Windows': '');

	if (BX.browser.IsIE() && !BX.browser.IsIE9() && (/MSIE 7/i.test(navigator.userAgent)))
		this.errorMessage = BX.message('IM_M_OLD_BROWSER');

	if (this.context == 'POPUP-FULLSCREEN' && BX.browser.IsMobile())
	{
		this.design = 'POPUP';
	}

	if (this.context == 'DESKTOP' || this.context == 'FULLSCREEN'  || this.context == 'PAGE' || this.context == 'DIALOG' || this.context == 'LINES' || this.context == 'POPUP-FULLSCREEN')
	{
		if (this.context == 'DESKTOP')
		{
			BX.desktop.init({context: this.context, design: this.design, bxim: this});
		}
		if (BX.MessengerCommon.isPage())
		{
			BX.MessengerWindow.init({context: this.context, design: this.design, bxim: this});
		}
	}

	this.desktop = new BX.IM.Desktop(this, {
		'desktop': params.desktop
	});

	this.webrtc = new BX.IM.WebRTC(this, {
		'desktopClass': this.desktop,
		'phoneEnabled': params.webrtc && params.webrtc.phoneEnabled || false,
		'phoneCanPerformCalls': params.webrtc && params.webrtc.phoneCanPerformCalls == 'Y' || false,
		'phoneCanCallUserNumber': params.webrtc && params.webrtc.phoneCanCallUserNumber || false,
		'phoneDeviceActive': params.webrtc && params.webrtc.phoneDeviceActive || 'N',
		'phoneDeviceCall': params.webrtc && params.webrtc.phoneDeviceCall || 'Y',
		'phoneCrm': params.phoneCrm && params.phoneCrm || {},
		'phoneLines': params.webrtc && params.webrtc.phoneLines || {},
		'phoneDefaultLineId': params.webrtc && params.webrtc.phoneDefaultLineId || '',
		'phoneAvailableLines': params.webrtc && params.webrtc.availableLines || [],
		'turnServer': params.webrtc && params.webrtc.turnServer || '',
		'turnServerFirefox': params.webrtc && params.webrtc.turnServerFirefox || '',
		'turnServerLogin': params.webrtc && params.webrtc.turnServerLogin || '',
		'turnServerPassword': params.webrtc && params.webrtc.turnServerPassword || '',
		'panel': domNode != null? domNode: BX.create('div')
	});

	//this.telephonyController = new BX.IM.TelephonyController()

	this.callController = new BX.Call.Controller({

	});


	BX.PhoneCallView.setDefaults({
		restApps: params.webrtc && params.webrtc.phoneCallCardRestApps || [],
		callInterceptAllowed: params.webrtc && params.webrtc.phoneCanInterceptCall || false
	});

	this.desktop.webrtc = this.webrtc;

	if (this.init)
	{
		if (BX.MessengerCommon.isDesktop())
		{
			this.windowTitle = this.bitrixIntranet? (!BX.browser.IsMac()? BX.message('IM_DESKTOP_B24_TITLE'): BX.message('IM_DESKTOP_B24_OSX_TITLE')): BX.message('IM_WM');
			BX.desktop.setWindowTitle(this.windowTitle);

			if (!BX.MessengerCommon.isSliderBindingsEnable())
			{
				BX.SidePanel.Instance.anchorRules = [];
			}

		}
		else
		{
			this.windowTitle = document.title;
		}
	}

	for (var i in params.notify)
	{
		params.notify[i].date = new Date(params.notify[i].date);
		if (parseInt(i) > this.lastRecordId)
			this.lastRecordId = parseInt(i);
	}
	for (var i in params.message)
	{
		params.message[i].date = new Date(params.message[i].date);
		if (parseInt(i) > this.lastRecordId)
			this.lastRecordId = parseInt(i);
	}
	for (var i in params.recent)
	{
		params.recent[i].date = new Date(params.recent[i].date);
	}
	if (BX.browser.SupportLocalStorage())
	{
		BX.addCustomEvent(window, "onLocalStorageSet", BX.proxy(this.storageSet, this));

		var lri = BX.localStorage.get('lri');
		if (parseInt(lri) > this.lastRecordId)
			this.lastRecordId = parseInt(lri);

		BX.garbage(function(){
			BX.localStorage.set('lri', this.lastRecordId, 60);
		}, this);
	}

	this.notifyManager = new BX.IM.NotifyManager(this, {});
	this.notify = new BX.MessengerNotify(this, {
		'desktopClass': this.desktop,
		'webrtcClass': this.webrtc,
		'domNode': domNode,
		'counters': params.counters || {},
		'mailCount': params.mailCount || 0,
		'notify': params.notify || {},
		'unreadNotify' : params.unreadNotify || {},
		'flashNotify' : params.flashNotify || {},
		'countNotify' : params.countNotify || 0,
		'loadNotify' : params.loadNotify
	});
	this.webrtc.notify = this.notify;
	this.desktop.notify = this.notify;

	this.disk = new BX.IM.DiskManager(this, {
		notifyClass: this.notify,
		desktopClass: this.desktop,
		files: params.files || {},
		enable: params.disk && params.disk.enable,
		enableExternal: params.disk && params.disk.external
	});
	this.notify.disk = this.disk;
	this.webrtc.disk = this.disk;
	this.desktop.disk = this.disk;

	this.messenger = new BX.MessengerChat(this, {
		'openChatEnable': params.openChatEnable,
		'updateStateInterval': params.updateStateInterval,
		'notifyClass': this.notify,
		'webrtcClass': this.webrtc,
		'desktopClass': this.desktop,
		'diskClass': this.disk,
		'externalRecentList': params.externalRecentList,
		'recent': params.recent,
		'users': params.users || {},
		'businessUsers': params.businessUsers || false,
		'openlines': params.openlines || false,
		'groups': params.groups || {},
		'userChatBlockStatus': params.userChatBlockStatus || {},
		'userChatOptions': params.userChatOptions || {},
		'userInGroup': params.userInGroup || {},
		'currentTab' : params.currentTab || 0,
		'generalChatId' : params.generalChatId || 0,
		'canSendMessageGeneralChat' : params.canSendMessageGeneralChat || false,
		'chat' : params.chat || {},
		'userInChat' : params.userInChat || {},
		'userChat' : params.userChat || {},
		'hrphoto' : params.hrphoto || {},
		'message' : params.message || {},
		'showMessage' : params.showMessage || {},
		'unreadMessage' : params.unreadMessage || {},
		'flashMessage' : params.flashMessage || {},
		'countMessage' : params.countMessage || 0,
		'tooltipShowed' : params.tooltipShowed || {},
		'bot' : params.bot || {},
		'command' : params.command || [],
		'textareaIcon' : params.textareaIcon || [],
		'smile' : params.smile || false,
		'smileSet' : params.smileSet || false,
		'history' : params.history || {},
		'openMessenger' : typeof(params.openMessenger) != 'undefined'? params.openMessenger: false,
		'openHistory' : typeof(params.openHistory) != 'undefined'? params.openHistory: false,
		'openNotify' : typeof(params.openNotify) != 'undefined'? params.openNotify: false
	});
	this.webrtc.messenger = this.messenger;
	this.callController.messenger = this.messenger;
	this.notify.messenger = this.messenger;
	this.desktop.messenger = this.messenger;
	this.disk.messenger = this.messenger;

	if (this.init)
	{
		BX.addCustomEvent(window, "onImUpdateCounterNotify", BX.proxy(this.updateCounter, this));
		BX.addCustomEvent(window, "onImUpdateCounterMessage", BX.proxy(this.updateCounter, this));
		BX.addCustomEvent(window, "onImUpdateCounterMail", BX.proxy(this.updateCounter, this));
		BX.addCustomEvent(window, "onImUpdateCounter", BX.proxy(this.updateCounter, this));

		BX.bind(window, "blur", BX.delegate(function(){ this.changeFocus(false);}, this));
		BX.bind(window, "focus", this.setFocusFunction = BX.delegate(function(){
			if (this.windowFocus)
				return false;

			if (BX.MessengerCommon.isDesktop() && !BX.desktop.isActiveWindow())
				return false;

			this.changeFocus(true);
			if (this.isFocus() && this.messenger.unreadMessage[this.messenger.currentTab] && this.messenger.unreadMessage[this.messenger.currentTab].length>0)
				BX.MessengerCommon.readMessage(this.messenger.currentTab);

			if (this.isFocus('notify'))
			{
				if (this.notify.unreadNotifyLoad)
					this.notify.loadNotify();
				else if (this.notify.notifyUpdateCount > 0)
					this.notify.viewNotifyAll();
			}
		}, this));

		if (BX.MessengerCommon.isDesktop())
			BX.bind(window, "click", this.setFocusFunction);

		BX.addCustomEvent("onPullEvent-xmpp", BX.delegate(function(command, params)
		{
			if (command == 'lastActivityDate')
			{
				this.xmppStatus = params.timestamp > 0;
			}
		}, this));

		this.updateCounter();
		BX.onCustomEvent(window, 'onImInit', [this]);
	}

	if (this.openSettingsFlag !== false)
		this.openSettings(this.openSettingsFlag == 'true'? {}: {'onlyPanel': this.openSettingsFlag.toString().toLowerCase()});
};

BX.IM.prototype.isFocus = function(context)
{
	context = typeof(context) == 'undefined'? 'dialog': context;
	if (!BX.MessengerCommon.isPage() && (this.messenger == null || this.messenger.popupMessenger == null))
		return false;

	if (context == 'dialog')
	{
		if (BX.MessengerCommon.isPage() && BX.MessengerWindow.getCurrentTab() != 'im' && BX.MessengerWindow.getCurrentTab() != 'im-phone' && BX.MessengerWindow.getCurrentTab() != 'im-ol')
			return false;
		if (this.messenger && !BX.MessengerCommon.isScrollMax(this.messenger.popupMessengerBody, 200))
			return false;
		if (this.dialogOpen == false)
			return false;
	}
	else if (context == 'notify')
	{
		if (BX.MessengerCommon.isPage() && BX.MessengerWindow.getCurrentTab() != 'notify' && BX.MessengerWindow.getCurrentTab() != 'im-phone')
			return false;
		if (this.notifyOpen == false)
			return false;
	}

	if (this.quirksMode || (BX.browser.IsIE() && !BX.browser.IsIE9()))
		return true;

	return this.windowFocus;
};

BX.IM.prototype.changeFocus = function (focus)
{
	this.windowFocus = typeof(focus) == "boolean"? focus: false;
	return this.windowFocus;
};

BX.IM.prototype.playSound = function(sound, force)
{
	force = force? true: false;
	if (!force && (!this.init || this.webrtc.callActive))
		return false;

	var whiteList = {'start': true, 'dialtone': true, 'ringtone': true};
	if (!this.settings.enableSound && !whiteList[sound])
		return false;

	BX.localStorage.set('mps', true, 1);

	try{
		this.stopSound();
		this.audio.current = this.audio[sound];
		var result = this.audio[sound].play();
		if(window.Promise && result instanceof Promise)
		{
			result.catch(function(e)
			{
				BXIM.audio.current = null;
			});
		}
	}
	catch(e)
	{
		this.audio.current = null
	}

};

BX.IM.prototype.repeatSound = function(sound, time)
{
	time = parseInt(time) || 1000;
	time = time >= 1000? time: 1000;

	if (this.audio.timeout[sound])
		clearTimeout(this.audio.timeout[sound]);

	if (BX.MessengerCommon.isDesktop() || !this.desktopStatus)
		this.playSound(sound);

	this.audio.timeout[sound] = setTimeout(BX.delegate(function(){
		this.repeatSound(sound, time);
	}, this), time);
};

BX.IM.prototype.stopRepeatSound = function(sound, send)
{
	send = send != false;
	if (send)
		BX.localStorage.set('mrss', {sound: sound}, 1);

	if (this.audio.timeout[sound])
		clearTimeout(this.audio.timeout[sound]);

	if (!this.audio[sound])
		return false;

	this.audio[sound].pause();
	this.audio[sound].currentTime = 0;
};

BX.IM.prototype.stopSound = function()
{
	if (this.audio.current)
	{
		this.audio.current.pause();
		this.audio.current.currentTime = 0;
	}
};

BX.IM.prototype.autoHide = function(e)
{
	if (this.autoHideDisable)
		return true;

	e = e||window.event;
	if (e.which == 1)
	{
		if (this.popupSettings != null)
			this.popupSettings.destroy();
		else if (this.messenger.popupHistory != null)
			this.messenger.popupHistory.destroy();
		else if (BX.DiskFileDialog && BX.DiskFileDialog.popupWindow != null)
			BX.DiskFileDialog.popupWindow.destroy();
		else if (!this.callController.hasActiveCall() && this.messenger.popupMessenger != null)
			this.messenger.popupMessenger.destroy();
	}
};

BX.IM.prototype.updateCounter = function(count, type)
{
	if (type == 'MESSAGE')
		this.messageCount = count;
	else if (type == 'NOTIFY')
		this.notifyCount = count;
	else if (type == 'MAIL')
		this.mailCount = count;

	var sumCount = 0;
	if (this.notifyCount > 0)
		sumCount += parseInt(this.notifyCount);
	if (this.messageCount > 0)
		sumCount += parseInt(this.messageCount);
	if (this.linesCount > 0)
		sumCount += parseInt(this.linesCount);

	if (BX.MessengerCommon.isPage())
	{
		var sumLabel = '';
		if (sumCount > 99)
			sumLabel = '99+';
		else if (sumCount > 0)
			sumLabel = sumCount;

		var iconTitle = BX.message('IM_DESKTOP_UNREAD_EMPTY');
		if (this.notifyCount > 0 && this.messageCount+this.linesCount > 0)
			iconTitle = BX.message('IM_DESKTOP_UNREAD_MESSAGES_NOTIFY');
		else if (this.notifyCount > 0)
			iconTitle = BX.message('IM_DESKTOP_UNREAD_NOTIFY');
		else if (this.messageCount+this.linesCount > 0)
			iconTitle = BX.message('IM_DESKTOP_UNREAD_MESSAGES');
		else if (this.notify != null && this.notify.getCounter('**') > 0)
			iconTitle = BX.message('IM_DESKTOP_UNREAD_LF');

		if (BX.MessengerCommon.isDesktop())
		{
			BX.desktop.setIconTooltip(iconTitle);
			BX.desktop.setIconBadge(sumLabel, this.messageCount+this.linesCount > 0);
		}
	}
	if (BX.MessengerCommon.isPage() && this.notify && !this.userExtranet)
	{
		var lfCounter = this.notify.getCounter('**');
		BX.MessengerWindow.setTabBadge('im-lf', lfCounter);
	}
	BX.onCustomEvent(window, 'onImUpdateSumCounters', [sumCount, 'SUM']);

	if (this.settings.status != 'dnd' && !this.desktopStatus && sumCount > 0)
	{
		if (!BX.MessengerCommon.isDesktop() && document.title != '('+sumCount+') '+this.windowTitle)
			document.title = '('+sumCount+') '+this.windowTitle;

		if (this.notify.panelButtonMessage)
		{
			if (this.messageCount > 0)
				BX.addClass(this.notify.panelButtonMessage, 'bx-notifier-message-new');
			else
				BX.removeClass(this.notify.panelButtonMessage, 'bx-notifier-message-new');
		}
	}
	else
	{
		if (!BX.MessengerCommon.isDesktop() && document.title != this.windowTitle)
			document.title = this.windowTitle;

		if (this.notify.panelButtonMessage)
		{
			if (this.messageCount <= 0 || this.settings.status == 'dnd' || this.desktopStatus)
			{
				BX.removeClass(this.notify.panelButtonMessage, 'bx-notifier-message-new');
			}
		}
	}
};

BX.IM.prototype.openNotify = function(params)
{
	force = params && params.force == true;

	if (!this.settings.openDesktopFromPanel)
	{
		BX.defer(function() {
			if (BX.MessengerCommon.isPage())
			{
				if (BX.MessengerWindow.currentTab != 'notify')
				{
					BX.MessengerWindow.changeTab('im', true);
				}
				this.notify.openNotify(false, true);
				setTimeout(function(){
					BX.MessengerWindow.changeTab('notify', true);
				},100)
			}
			else
			{
				this.notify.openNotify(false, true);
			}
		}, this)();

		return false;
	}

	BX.desktopUtils.runningCheck(function() {
		BX.desktopUtils.goToBx("bx://notify");
	}, BX.defer(function() {
		if (BX.MessengerCommon.isPage())
		{
			if (BX.MessengerWindow.currentTab != 'notify')
			{
				BX.MessengerWindow.changeTab('im', true);
			}
			this.notify.openNotify(false, true);

			setTimeout(function(){
				BX.MessengerWindow.changeTab('notify', true);
			},100)
		}
		else
		{
			this.notify.openNotify(false, true);
		}
	}, this));
};

BX.IM.prototype.closeNotify = function()
{
	BX.onCustomEvent(window, 'onImNotifyWindowClose', []);
	if (this.messenger.popupMessenger != null && !this.callController.hasActiveCall())
		this.messenger.popupMessenger.destroy();
};

BX.IM.prototype.toggleNotify = function()
{
	if (this.isOpenNotify())
		this.closeNotify();
	else
		this.openNotify();
};

BX.IM.prototype.isOpenNotify = function()
{
	return this.notifyOpen;
};

BX.IM.prototype.callTo = function(dialogId, video)
{
	video = !(typeof(video) != 'undefined' && !video);

	BX.desktopUtils.runningCheck(
		function()
		{
			BX.desktopUtils.goToBx("bx://callto/" + (video? 'video': 'audio') + "/" + dialogId);
		},
		function()
		{
			this.callController.startCall(dialogId, video);
		}.bind(this)
	);
};

BX.IM.prototype.sendMessage = function(dialogId, message)
{
	if (!message && !dialogId)
		return false;

	if (!message)
	{
		message = dialogId;
		dialogId = this.messenger.currentTab;
	}

	var previousMessage = this.messenger.popupMessengerTextarea.value;
	this.messenger.popupMessengerTextarea.value = message;
	this.messenger.sendMessage(dialogId);

	setTimeout(BX.delegate(function(){
		this.messenger.popupMessengerTextarea.value = previousMessage;
		this.messenger.textareaCheckText();
	}, this), 10);

	return true;
}

BX.IM.prototype.putMessage = function(message)
{
	BX.addClass(this.messenger.popupMessengerTextarea.parentNode, 'bx-messenger-textarea-focus');

	this.messenger.popupMessengerTextarea.focus();
	this.messenger.insertTextareaText(this.messenger.popupMessengerTextarea, message+' ', false);
	this.messenger.textareaHistory[this.messenger.currentTab] = message+' ';

	return true;
}

BX.IM.prototype.phoneTo = function(number, params)
{
	params = params? params: {};
	var lineId = params['LINE_ID'] ? params['LINE_ID'] : this.webrtc.phoneDefaultLineId;
	if (typeof(params) != 'object')
	{
		try { params = JSON.parse(params); } catch(e) { params = {} }
	}

	if(this.webrtc.isRestLine(lineId))
	{
		BX.MessengerCommon.phoneStartCallViaRestApp(number, lineId, params);
		return true;
	}

	if (!BX.MessengerCommon.isDesktop() && this.desktopStatus && this.desktopVersion >= 18)
	{
		var stringParams = '';
		if (params)
		{
			for (var i in params)
			{
				stringParams = stringParams+'!!'+i+'!!'+params[i];
			}
			stringParams = '/params/'+stringParams.substr(2);
		}
		if (this.webrtc.popupKeyPad)
			this.webrtc.popupKeyPad.close();

		BX.desktopUtils.runningCheck(function(){
			BX.desktopUtils.goToBx("bx://callto/phone/"+escape(number)+stringParams)
		}, BX.delegate(function(){
			this.webrtc.phoneCall(number, params);
		}, this));
	}
	else
	{
		this.webrtc.phoneCall(number, params);
	}
	return true;
};

/**
 * Starts Call List mode
 * @param callListId int
 * @param params object: {webformId (int) }
 * @returns {boolean}
 */
BX.IM.prototype.startCallList = function(callListId, params)
{
	params = params? params: {};
	callListId = parseInt(callListId);
	if(callListId == 0)
		return;

	if (!this.desktop.ready() && this.desktopStatus && this.desktopVersion >= 18)
	{
		BX.desktopUtils.runningCheck(
			function()
			{
				BX.desktopUtils.goToBx("bx://calllist/id/"+callListId+/params/+BX.desktopUtils.encodeParams(params))
			},
			BX.delegate(function()
			{
				this.webrtc.startCallList(callListId, params);
			}, this)
		);
	}
	else
	{
		this.webrtc.startCallList(callListId, params);
	}
	return true;

};

BX.IM.prototype.checkCallSupport = function(dialogId)
{
	var userCheck = true;
	if (typeof(dialogId) != 'undefined')
	{
		if (parseInt(dialogId)>0)
		{
			userCheck = this.messenger.users[dialogId] && this.messenger.users[dialogId].status != 'guest' && !this.messenger.users[dialogId].bot && !this.messenger.users[dialogId].network;
		}
		else
		{
			if (this.messenger.chat[dialogId.toString().substr(4)] && this.messenger.chat[dialogId.toString().substr(4)].type == 'open')
			{
				userCheck = false;
			}
			else
			{
				userCheck = (this.messenger.userInChat[dialogId.toString().substr(4)]);
				if (userCheck)
				{
					var count = 0;

					this.messenger.userInChat[dialogId.toString().substr(4)].forEach(function(userId){
						if (this.messenger.users[userId] && this.messenger.users[userId].active)
						{
							count++;
						}
					}.bind(this));

					userCheck = count <= this.callController.getUserLimit();
				}
			}
		}
	}

	return this.ppServerStatus && this.callController.isWebRTCSupported() && userCheck;
};

BX.IM.prototype.addPopupMenuModifier = function(func)
{
	this.messenger.popupPopupMenuModifyFunction.push(func);
	return true;
}

BX.IM.prototype.openMessengerSlider = function(dialogId, params)
{
	params = params || {};
	params.SLIDER = 'Y';

	BX.defer(function() {
		if (dialogId && dialogId.toString().substr(0,4) == 'imol')
		{
			this.messenger.linesOpenMessenger(dialogId.toString().substr(5), params);
		}
		else
		{
			this.messenger.openMessengerSlider(dialogId, params);
		}
	}, this)();
};

BX.IM.prototype.openMessenger = function(userId, tab, openThis)
{
	userId = userId === false? false: userId;
	openThis = openThis? true: false;

	if (!this.settings.openDesktopFromPanel || openThis)
	{
		BX.defer(function() {
			if (userId && userId.toString().substr(0,4) == 'imol')
			{
				this.messenger.linesOpenMessenger(userId.toString().substr(5));
			}
			else
			{
				this.messenger.openMessenger(userId);
				if (tab)
				{
					BX.MessengerWindow.changeTab(tab, true);
				}
			}
		}, this)();

		return false;
	}

	BX.desktopUtils.runningCheck(function() {
		BX.desktopUtils.goToBx(userId === false? "bx://messenger": "bx://messenger/dialog/"+encodeURIComponent(userId)+"/tab/"+tab);
	}, BX.defer(function() {
		if (userId && userId.toString().substr(0,4) == 'imol')
		{
			this.messenger.linesOpenMessenger(userId.toString().substr(5));
		}
		else
		{
			this.messenger.openMessenger(userId);
			if (tab)
			{
				BX.MessengerWindow.changeTab(tab, true);
			}
		}
	}, this));

	return false;
};

BX.IM.prototype.closeMessenger = function()
{
	this.messenger.popupMessenger.close();
};

BX.IM.prototype.isOpenMessenger = function()
{
	return this.dialogOpen;
};

BX.IM.prototype.toggleMessenger = function()
{
	if (this.isOpenMessenger())
		this.closeMessenger();
	else if (this.extraOpen && !this.isOpenNotify())
		this.closeMessenger();
	else
		this.openMessenger(this.messenger.currentTab);
};

BX.IM.prototype.openHistory = function(userId)
{
	if (userId && userId.toString().substr(0,4) == 'imol')
	{
		setTimeout(BX.delegate(function(){
			this.messenger.linesOpenHistory(userId.toString().substr(5));
		},this), 300);
	}
	else
	{
		setTimeout(BX.delegate(function(){
			this.messenger.openHistory(userId)
		},this), 10);
	}
};

BX.IM.prototype.openContactList = function()
{
	this.messenger.openMessenger(false);
	setTimeout(BX.delegate(function(){
		this.messenger.popupContactListSearchInput.focus();
	},this), 200);
	return false;
};

BX.IM.prototype.closeContactList = function()
{
	return false;
};

BX.IM.prototype.isOpenContactList = function()
{
	return false;
};

BX.IM.prototype.checkRevision = function(revision)
{
	if (typeof(revision) == "number" && this.revision < revision)
	{
		if (BX.MessengerCommon.isDesktop() || this.context == 'PAGE')
		{
			console.log('NOTICE: Window reload, because REVISION UP ('+this.revision+' -> '+revision+')');
			BX.MessengerWindow.windowReload();
		}
		else
		{
			if (this.isOpenMessenger())
			{
				this.closeMessenger();
				this.openMessenger();
			}
			this.errorMessage = BX.message('IM_M_OLD_REVISION').replace('#WM_NAME#', BX.message('IM_WM'));
			this.tryConnect = false;
		}
		return false;
	}
	return true;
};

BX.IM.prototype.openSettings = function(params)
{
	if (this.messenger && this.messenger.popupMessengerConnectionStatusState != 'online')
		return false;

	params = typeof(params) == 'object'? params: {};
	if (this.popupSettings != null || !this.messenger)
		return false;

	if (!BX.MessengerCommon.isPage())
		this.messenger.setClosingByEsc(false);

	this.settingsSaveCallback = {};
	this.settingsTableConfig = {};

	var colors = [];
	if (this.colors)
	{
		for (var color in this.colors)
		{
			colors.push({'title': this.colors[color], 'value': color});
		}
	}

	var linesTabEnable = BX.MessengerCommon.isPage() && this.bitrixOpenLines? true: false;


	var notifyPositionEnable = false;
	if (BX.MessengerCommon.isDesktop() && this.desktopVersion >= 42 && /windows/.test(navigator.userAgent.toLowerCase()) && BXDesktopSystem.GetNotifyPosition)
	{
		notifyPositionEnable = true;

		notifyPositionValue = BXDesktopSystem.GetNotifyPosition();
		notifyPositionValue = notifyPositionValue? notifyPositionValue: "RB";

		notifyPositionValues = [
			{'title': BX.message('IM_M_NOTIFY_POSITION_LT'), 'value': 'LT'},
			{'title': BX.message('IM_M_NOTIFY_POSITION_RT'), 'value': 'RT'},
			{'title': BX.message('IM_M_NOTIFY_POSITION_LB'), 'value': 'LB'},
			{'title': BX.message('IM_M_NOTIFY_POSITION_RB'), 'value': 'RB'},
		];
	}

	this.settingsView.common = {
		'title' : BX.message('IM_SETTINGS_COMMON'),
		'settings': [
			{'title': BX.message('IM_M_VIEW_LAST_MESSAGE_OFF'), 'type': 'checkbox', 'name':'viewLastMessage',  'checked': !this.settings.viewLastMessage, 'saveCallback': BX.delegate(function(element) { BX.MessengerCommon.recentListRedraw(); return !element.checked; }, this)},
			{'title': BX.message('IM_M_VIEW_OFFLINE_OFF'), 'type': 'checkbox', 'name':'viewOffline',  'checked': !this.settings.viewOffline, 'saveCallback': BX.delegate(function(element) { return !element.checked; }, this)},
			{'type': 'space'},
			linesTabEnable? {'title': BX.message('IM_M_VIEW_OL_LIST'), 'type': 'checkbox', 'name':'linesTabEnable',  'checked': this.settings.linesTabEnable, 'saveCallback': BX.delegate(function(element) { this.messenger.toggleLinesTab(element.checked); return element.checked; }, this)}: null,
			linesTabEnable? {'title': BX.message('IM_M_VIEW_OL_NEW'), 'type': 'checkbox', 'name':'linesNewGroupEnable',  'checked': this.settings.linesNewGroupEnable, 'saveCallback': BX.delegate(function(element) { this.messenger.toggleLinesNewGroup(element.checked); return element.checked; }, this)}: null,
			linesTabEnable? {'type': 'space'}: null,
			{'title': BX.message('IM_M_LLM'), 'type': 'checkbox', 'name':'loadLastMessage', 'checked': this.settings.loadLastMessage},
			{'title': BX.message('IM_M_LLN'), 'type': 'checkbox', 'name':'loadLastNotify', 'checked': this.settings.loadLastNotify},
			{'title': BX.message('IM_M_NAR'), 'type': 'checkbox', 'name':'notifyAutoRead', 'checked': this.settings.notifyAutoRead},
			{'type': 'space'},
			{'title': BX.message('IM_M_DESKTOP_BIG_SMILE_ON'), 'type': 'checkbox', 'name':'enableBigSmile', 'checked': this.settings.enableBigSmile},
			{'title': BX.message('IM_M_RICH_LINK_ON'), 'type': 'checkbox', 'name':'enableRichLink', 'checked': this.settings.enableRichLink},
			{'title': BX.message('IM_M_ENABLE_SOUND'), 'type': 'checkbox', 'name':'enableSound', 'checked': this.settings.enableSound},
			BX.MessengerCommon.isDesktop()? {'title': BX.message('IM_M_ENABLE_BIRTHDAY'), 'type': 'checkbox', 'checked': this.desktop.birthdayStatus(), 'callback': BX.delegate(function(){ this.desktop.birthdayStatus(!this.desktop.birthdayStatus()); }, this)}: null,
			{'title': BX.message('IM_M_KEY_SEND'), 'type': 'select', 'name':'sendByEnter', 'value': this.settings.sendByEnter?'Y':'N', items: [{title: (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter"), value: 'N'}, {title: 'Enter', value: 'Y'}], 'saveCallback': BX.delegate(function(element) { return element[element.selectedIndex].value == 'Y'; }, this)},
			//this.language=='ru' && BX.correctText? {'title': BX.message('IM_M_AUTO_CORRECT'), 'type': 'checkbox', 'name':'correctText', 'checked': this.settings.correctText }: null,
			{'type': 'space'},
			notifyPositionEnable? {'title': BX.message('IM_M_NOTIFY_POSITION'), 'name': 'notifyPosition', 'type': 'select', 'value': notifyPositionValue, items: notifyPositionValues, skipSave: 'Y', 'saveCallback': BX.delegate(function(element){ BXDesktopSystem.SetNotifyPosition(element.options[element.selectedIndex].value); }, this)}: null,
			this.colors? {'title': BX.message('IM_M_USER_COLOR'), 'name': 'userColor', 'type': 'select', 'value': this.userColor, items: colors, skipSave: 'Y', 'saveCallback': BX.delegate(function(element){ BX.MessengerCommon.setColor(element.options[element.selectedIndex].value) }, this)}: null,
			this.desktopVersion? {'title': BX.message('IM_M_OPEN_DESKTOP_FROM_PANEL'), 'type': 'checkbox', 'name':'openDesktopFromPanel',  'checked': this.settings.openDesktopFromPanel}: null,
			BX.MessengerCommon.isDesktop()? {'title': BX.message('IM_M_DESKTOP_AUTORUN_ON'), 'type': 'checkbox', 'checked': BX.desktop.autorunStatus(), 'callback': BX.delegate(function(){ BX.desktop.autorunStatus(!BX.desktop.autorunStatus()); }, this)}: null
		]
	};
	this.settingsView.notify = {
		'title' : BX.message('IM_SETTINGS_NOTIFY'),
		'settings': [
			{'type': 'notifyControl'},
			{'type': 'table', name: 'notify', show: this.settings.notifyScheme == 'expert'},
			{'type': 'table', name: 'simpleNotify', show: this.settings.notifyScheme == 'simple'}
		]
	};

	this.settingsTableConfig['notify'] = {
		'condition': BX.delegate(function(){ return this.settingsTableConfig['notify'].rows.length > 0 }, this),
		'headers' : [
			'',
			BX.message('IM_SETTINGS_NOTIFY_SITE'),
			this.bitrixXmpp? BX.message('IM_SETTINGS_NOTIFY_XMPP'): false,
			BX.message('IM_SETTINGS_NOTIFY_EMAIL'),
			this.bitrixMobile? BX.message('IM_SETTINGS_NOTIFY_PUSH'): false
		],
		'rows' : [],
		'error_rows': BX.create("div", {children: [
			BX.create("div", {props: {className: "bx-messenger-content-item-progress"}}),
			BX.create("span", {props: {className: "bx-messenger-content-item-progress-with-text"}, html: BX.message('IM_SETTINGS_LOAD')}),
		]})
	};

	this.settingsTableConfig['simpleNotify'] = {
		'condition': BX.delegate(function(){  return this.settingsTableConfig['simpleNotify'].rows.length > 0 }, this),
		'headers' : [BX.message('IM_SETTINGS_SNOTIFY'), ''],
		'rows' : []
	};

	this.settingsView.privacy = {
		'title' : BX.message('IM_SETTINGS_PRIVACY'),
		'condition': BX.delegate(function(){ return !this.bitrixIntranet}, this),
		'settings': [
			{'title': BX.message('IM_SETTINGS_PRIVACY_MESS'), name: 'privacyMessage', 'type': 'select', items: [{title: BX.message('IM_SETTINGS_SELECT_1'), value: 'all'}, {title: BX.message('IM_SETTINGS_SELECT_2'), value: 'contact'}], 'value': this.settings.privacyMessage},
			{'title': BX.message('IM_SETTINGS_PRIVACY_CALL'), name: 'privacyCall', 'type': 'select', items: [{title: BX.message('IM_SETTINGS_SELECT_1'), value: 'all'}, {title: BX.message('IM_SETTINGS_SELECT_2'), value: 'contact'}], 'value': this.settings.privacyCall},
			{'title': BX.message('IM_SETTINGS_PRIVACY_CHAT'), name: 'privacyChat', 'type': 'select', items: [{title: BX.message('IM_SETTINGS_SELECT_1_2'), value: 'all'}, {title: BX.message('IM_SETTINGS_SELECT_2_2'), value: 'contact'}], 'value': this.settings.privacyChat},
			{'title': BX.message('IM_SETTINGS_PRIVACY_SEARCH'), name: 'privacySearch', 'type': 'select', items: [{title: BX.message('IM_SETTINGS_SELECT_1_3'), value: 'all'}, {title: BX.message('IM_SETTINGS_SELECT_2_3'), value: 'contact'}], 'value': this.settings.privacySearch},
			this.bitrix24net? {'title': BX.message('IM_SETTINGS_PRIVACY_PROFILE'), name: 'privacyProfile', 'type': 'select', items: [{title: BX.message('IM_SETTINGS_SELECT_1_3'), value: 'all'}, {title: BX.message('IM_SETTINGS_SELECT_2_3'), value: 'contact'}, {title: BX.message('IM_SETTINGS_SELECT_3_3'), value: 'nobody'}], 'value': this.settings.privacyProfile}: null
		]
	};
	this.settingsView.hardware = {
		'title' : BX.message('IM_SETTINGS_HARDWARE'),
		'settings': [
			{'title': 'hardwareError', 'type': 'html', 'value': '<div id="bx-messenger-settings-hardware-error"></div>'},
			{'title': BX.message('IM_SETTINGS_HARDWARE_MICROPHONE'), 'type': 'select', 'name':'defaultMicrophone', 'items': {}, 'callback': this.changeHardwareSettings.bind(this), 'saveCallback': function(e){if(!localStorage) return e.value; localStorage.setItem('bx-im-settings-default-microphone', e.value);} },
			{'type': 'space'},
			{'title': 'microphoneLevel', 'type': 'html', 'value': '<div id="bx-messenger-settings-hardware-microphone-level" class="bx-messenger-settings-level-meter-container"></div>'},
			{'title': BX.message('IM_SETTINGS_HARDWARE_AUTO_PARAMETERS_MICROPHONE'), 'type': 'checkbox', 'name': 'enableMicAutoParameters', 'checked': this.webrtc.enableMicAutoParameters, 'saveCallback': function(e){if(!localStorage) return e.checked; localStorage.setItem('bx-im-settings-enable-mic-auto-parameters', (e.checked ? 'Y' : 'N'));} },
			{'type': 'space'},
			{'title': BX.message('IM_SETTINGS_HARDWARE_SPEAKER'), 'type': 'select', 'name':'defaultSpeaker', 'items': {}, 'saveCallback': function(e){if(!localStorage) return e.value; localStorage.setItem('bx-im-settings-default-speaker', e.value);} },
			{'type': 'space'},
			{'title': BX.message('IM_SETTINGS_HARDWARE_CAMERA'), 'type': 'select', 'name':'defaultCamera', 'items': {}, 'callback': this.changeHardwareSettings.bind(this), 'saveCallback': function(e){if(!localStorage) return e.value; localStorage.setItem('bx-im-settings-default-camera', e.value);} },
			{'type': 'space'},
			{'title': 'cameraImage', 'type': 'html', 'value': '<div id="bx-messenger-settings-hardware-camera-image"></div>'}
		],
		'click': BX.delegate(this.showHardwareSettings, this)
	};

	BX.onCustomEvent(this, "prepareSettingsView", []);

	if (params.onlyPanel && !this.settingsView[params.onlyPanel])
		return false;

	this.popupSettingsButtonSave = new BX.PopupWindowButton({
		text : BX.message('IM_SETTINGS_SAVE'),
		className : "popup-window-button-accept",
		events : { click : BX.delegate(function() {
			this.popupSettingsButtonSave.setClassName('popup-window-button');
			this.popupSettingsButtonSave.setName(BX.message('IM_SETTINGS_WAIT'));
			BX.hide(this.popupSettingsButtonClose.buttonNode);
			this.saveFormSettings();
			this.closeHardwareSettings();
		}, this) }
	});
	this.popupSettingsButtonClose = new BX.PopupWindowButton({
		text : BX.message('IM_SETTINGS_CLOSE'),
		className : "popup-window-button-close",
		events : { click : BX.delegate(function() { this.popupSettings.close(); BX.hide(this.popupSettingsButtonSave.buttonNode); BX.hide(this.popupSettingsButtonClose.buttonNode); this.closeHardwareSettings();}, this) }
	});
	this.popupSettingsBody = BX.create("div", { props : { className : "bx-messenger-settings"+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: this.prepareSettings({onlyPanel: params.onlyPanel? params.onlyPanel: false, active: params.active? params.active: false})});

	if (BX.MessengerCommon.isDesktop())
	{
		if (this.init)
		{
			this.desktop.openSettings(this.popupSettingsBody, "BXIM.openSettings("+JSON.stringify(params)+"); BX.desktop.resize(); ", params);
			return false;
		}
		else
		{
			this.popupSettings = new BX.PopupWindowDesktop();
			BX.addClass(this.popupSettingsBody, "bx-messenger-mark");
			this.desktop.drawOnPlaceholder(this.popupSettingsBody);
		}
	}
	else
	{
		this.popupSettings = new BX.PopupWindow('bx-messenger-popup-settings', null, {
			//parentPopup: this.messenger.popupMessenger,
			autoHide: false,
			zIndex: 200,
			overlay: {opacity: 50, backgroundColor: "#000000"},
			buttons: [this.popupSettingsButtonSave, this.popupSettingsButtonClose],
			draggable: {restrict: true},
			closeByEsc: true,
			events : {
				onPopupClose : function() { this.destroy(); },
				onPopupDestroy : BX.delegate(function() {
					this.popupSettings = null;
					if (!BX.MessengerCommon.isPage() && this.messenger.popupMesseger == null)
						BX.bind(document, "click", BX.proxy(this.autoHide, this));

					this.closeHardwareSettings();
					this.messenger.setClosingByEsc(true)
				}, this)
			},
			//titleBar: {content: BX.create('span', {props : { className : "bx-messenger-title" }, html: params.onlyPanel? this.settingsView[params.onlyPanel].title: BX.message('IM_SETTINGS')})},
			titleBar: params.onlyPanel? this.settingsView[params.onlyPanel].title: BX.message('IM_SETTINGS'),
			closeIcon : true,
			contentNoPaddings : true,
			contentColor : "white",
			content : this.popupSettingsBody
		});
		this.popupSettings.show();
		BX.addClass(this.popupSettings.popupContainer, "bx-messenger-mark");
		BX.bind(this.popupSettings.popupContainer, "click", BX.MessengerCommon.preventDefault);
	}

	BX.bindDelegate(this.popupSettingsBody, 'click', {className: 'bx-messenger-settings-tab'}, BX.delegate(function() {
		BX.onCustomEvent(window, 'onImSettingsTabShow', [BX.proxy_context.getAttribute('data-name')]);

		var elements = BX.findChildrenByClassName(BX.proxy_context.parentNode, "bx-messenger-settings-tab", false);
		for (var i = 0; i < elements.length; i++)
			BX.removeClass(elements[i], 'bx-messenger-settings-tab-active');
		BX.addClass(BX.proxy_context, 'bx-messenger-settings-tab-active');

		var elements = BX.findChildrenByClassName(BX.proxy_context.parentNode.nextSibling, "bx-messenger-settings-content", false);
		for (var i = 0; i < elements.length; i++)
		{
			if (parseInt(BX.proxy_context.getAttribute('data-id')) == i)
				BX.addClass(elements[i], 'bx-messenger-settings-content-active');
			else
				BX.removeClass(elements[i], 'bx-messenger-settings-content-active');
		}
		if (BX.MessengerCommon.isDesktop())
			this.desktop.autoResize();

	}, this));

	if (this.settings.notifyScheme == 'simple')
		this.GetSimpleNotifySettings();
	else
		this.GetNotifySettings();

	if (!BX.MessengerCommon.isDesktop())
		BX.bind(document, "click", BX.proxy(this.autoHide, this));
};

BX.IM.prototype.prepareSettings = function(params)
{
	params = typeof(params) == "object"? params: {};

	var items = [];

	var tabs = [];
	var tabActive = true;
	var i = 0;

	for (var tab in this.settingsView)
	{
		if (this.settingsView[tab].condition && !this.settingsView[tab].condition())
			continue;
		var events = {};
		if (this.settingsView[tab].click)
			events = {click: BX.delegate(this.settingsView[tab].click, this)};

		if (params.active && this.settingsView[params.active])
		{
			if (params.active == tab)
				tabActive = true;
			else
				tabActive = false;
		}
		if (tabActive)
		{
			BX.onCustomEvent(window, 'onImSettingsTabShow', [tab]);
		}

		tabs.push(BX.create('div', {attrs: {'data-id': i+"", 'data-name': tab}, props : { className : "bx-messenger-settings-tab"+(tabActive ? " bx-messenger-settings-tab-active": "") }, html: this.settingsView[tab].title, events: events}));
		tabActive = false;
		i++;
	}
	items.push(BX.create("div", {style: {display: !params.onlyPanel? 'block': 'none' }, props : { className: "bx-messenger-settings-tabs"}, children : tabs}));

	var tabs = [];
	var tabActive = true;
	for (var tab in this.settingsView)
	{
		if (this.settingsView[tab].condition && !this.settingsView[tab].condition())
			continue;

		if (params.active && this.settingsView[params.active])
		{
			if (params.active == tab)
				tabActive = true;
			else
				tabActive = false;
		}

		var table = [];
		if (this.settingsView[tab].settings)
		{
			var tableItems = [];
			for (var item = 0; item < this.settingsView[tab].settings.length; item++)
			{
				if (typeof(this.settingsView[tab].settings[item]) != 'object' || this.settingsView[tab].settings[item] === null)
					continue;

				if (this.settingsView[tab].settings[item].condition && !this.settingsView[tab].settings[item].condition())
					continue;

				if (this.settingsView[tab].settings[item].type == 'notifyControl' || this.settingsView[tab].settings[item].type == 'table' || this.settingsView[tab].settings[item].type == 'space')
				{
					tableItems.push(BX.create("tr", {children : [
						BX.create("td", {attrs: {'colspan': 2}, children: this.prepareSettingsItem(this.settingsView[tab].settings[item])})
					]}));
				}
				else if(this.settingsView[tab].settings[item].type === 'html')
				{
					tableItems.push(BX.create("tr", {children : [
						BX.create("td", {attrs: {colspan: 2}, children: this.prepareSettingsItem(this.settingsView[tab].settings[item])})
					]}));
				}
				else
				{
					tableItems.push(BX.create("tr", {children : [
						BX.create("td", {attrs: {'width': '55%'}, html: this.settingsView[tab].settings[item].title}),
						BX.create("td", {attrs: {'width': '45%'}, children: this.prepareSettingsItem(this.settingsView[tab].settings[item])})
					]}));
				}
			}
			if (tableItems.length > 0)
				table.push(BX.create("table", {attrs : {'cellpadding': '0', 'cellspacing': '0', 'border': '0', 'width': '100%'}, props : { className: "bx-messenger-settings-table bx-messenger-settings-table-style-"+tab}, children: tableItems}));
		}

		tabs.push(BX.create("div", {style: {display: params.onlyPanel? (params.onlyPanel == tab? 'block': 'none'): '' }, props : { id: 'bx-messenger-settings-content-'+tab, className: "bx-messenger-settings-content"+(tabActive? " bx-messenger-settings-content-active": "")}, children: table}));
		tabActive = false;
	}
	items.push(BX.create("div", {props : { className: "bx-messenger-settings-contents"}, children : tabs}));
	if (BX.MessengerCommon.isDesktop())
	{
		items.push(BX.create("div", {props : { className: "popup-window-buttons"}, children : [this.popupSettingsButtonSave.buttonNode, this.popupSettingsButtonClose.buttonNode]}));
	}

	return items;
};

BX.IM.prototype.prepareSettingsTable = function(tab)
{
	var config = this.settingsTableConfig[tab];

	if (!config.error_rows && config.condition && !BX.delegate(config.condition, this)())
		return null;

	var tableNotify = [];
	var tableHeaders = [];
	for (var item = 0; item < config.headers.length; item++)
	{
		if (typeof(config.headers[item]) == 'boolean')
			continue;
		tableHeaders.push(BX.create("th", {html: config.headers[item]}));
	}

	if (tableHeaders.length > 0)
		tableNotify.push(BX.create("tr", {children : tableHeaders}));

	if (config.error_rows && config.condition && !config.condition())
	{
		tableNotify.push(BX.create("tr", {children: [
			BX.create("td", {attrs: {'colspan': config.headers.length}, style: {textAlign: 'center'}, children: [config.error_rows]})
		]}));
		config.rows = [];
	}

	for (var item = 0; item < config.rows.length; item++)
	{
		var tableRows = [];
		for (var column = 0; column < config.rows[item].length; column++)
		{
			if (typeof(config.rows[item][column]) != 'object' || config.rows[item][column] === null)
				continue;

			var attrs = {};
			var props = {};
			if (config.rows[item][column].type == 'separator')
			{
				attrs = {'colspan': config.headers.length};
				props = {className: "bx-messenger-settings-table-sep"};
			}
			else if (config.rows[item][column].type == 'error')
			{
				attrs = {'colspan': config.headers.length};
				props = {className: "bx-messenger-settings-table-error"};
			}
			if (typeof(this.settingsDisabled[config.rows[item][column].name]) != 'undefined')
			{
				config.rows[item][column].disabled = this.settingsDisabled[config.rows[item][column].name];
			}
			tableRows.push(BX.create("td", {attrs: attrs, props:props, children: this.prepareSettingsItem(config.rows[item][column])}));
		}
		if (tableRows.length > 0)
			tableNotify.push(BX.create("tr", {children : tableRows}));
	}
	var currentTable = null;
	if (tableNotify.length > 0)
		currentTable = BX.create("table", {attrs : {'cellpadding': '0', 'cellspacing': '0', 'border': '0'}, props : { className: "bx-messenger-settings-table-extra bx-messenger-settings-table-extra-"+tab}, children: tableNotify});

	return currentTable;
};

BX.IM.prototype.prepareSettingsItem = function(params)
{
	var items = [];
	var config = BX.clone(params);

	var tooltipNode = null;
	if (config.tooltip)
	{
		tooltipNode = BX.create("span", {props: {className: "bx-messenger-settings-tooltip"}, attrs: {'data-tooltip': config.tooltip}, html: 'i', events: {
			'click': BX.delegate(function(e){
				this.messenger.tooltip(BX.proxy_context, BX.proxy_context.getAttribute('data-tooltip'), {angle: false, width: 300});
				BX.PreventDefault(e);
			}, this)
		}});
	}

	if (config.type == 'space')
	{
		items.push(BX.create("span", {props: {className: "bx-messenger-settings-space"}}));
	}
	if (config.type == 'text' || config.type == 'separator' || config.type == 'error')
	{
		items.push(BX.create("span", {html: config.title }))
	}
	if (config.type == 'html')
	{
		items.push(BX.create("div", { html: config.value }));
	}
	if (config.type == 'link')
	{
		if (config.callback)
			var events = { click: config.callback };

		items.push(BX.create("span", {props: {className: "bx-messenger-settings-link"}, attrs: config.attrs, html: config.title, events: events }))
	}
	if (config.type == 'checkbox')
	{
		if (config.callback)
			var events = { change: config.callback };

		if (typeof(config.checked) == 'undefined')
			config.checked = this.settings[config.name] != false;

		var attrs = { type: "checkbox", name: config.name? config.name: false, id: config.id? config.id: '', checked: config.checked == true? "true": false, disabled: config.disabled == true? "true": false};
		if (!config.skipSave && config.name)
			attrs['data-save'] = 1;

		var element = BX.create("input", {attrs: attrs, events: events });
		items.push(BX.create("div", {style: {whiteSpace: 'nowrap'}, children: [element, tooltipNode]}));

		if (config.saveCallback)
			this.settingsSaveCallback[config.name] = config.saveCallback;
	}
	else if (config.type == 'select')
	{
		if (config.callback)
			var events = { change: config.callback };

		var options = [];
		for (var i = 0; i < config.items.length; i++)
		{
			options.push(BX.create("option", {attrs : { value: config.items[i].value, selected: config.value == config.items[i].value? "true": false}, html: config.items[i].title}));
		}
		var attrs = { name: config.name};
		if (config.name)
			attrs['data-save'] = 1;
		var element = BX.create("select", {attrs : attrs, events: events, children: options});
		items.push(BX.create("div", {style: {whiteSpace: 'nowrap'}, children: [element, tooltipNode]}));

		if (config.saveCallback)
			this.settingsSaveCallback[config.name] = config.saveCallback;
	}
	else if (config.type == 'table')
	{
		items.push(BX.create("div", {attrs: {id: 'bx-messenger-settings-table-'+config.name, className: 'bx-messenger-settings-table-'+config.name}, style: {'display': config.show? 'block':'none'}, children: [this.prepareSettingsTable(config.name)]}));
	}
	else if (config.type == 'notifyControl')
	{
		var onChangeNotifyScheme = BX.delegate(function(){
			if (BX.proxy_context.value == 'simple')
			{
				BX.hide(BX('bx-messenger-settings-table-notify'));
				BX.show(BX('bx-messenger-settings-table-simpleNotify'));
				BX.show(BX('bx-messenger-settings-notify-clients'));

				this.GetSimpleNotifySettings();
			}
			else
			{
				BX.show(BX('bx-messenger-settings-table-notify'));
				BX.hide(BX('bx-messenger-settings-table-simpleNotify'));
				BX.hide(BX('bx-messenger-settings-notify-clients'));

				this.GetNotifySettings();
			}
		}, this);
		items.push(BX.create("div", {props : { className: "bx-messenger-settings-notify-type"}, children : [
			BX.create("input", {attrs : { id: 'notifySchemeSimpleValue', 'data-save': 1,  type: "radio", name: "notifyScheme", value: 'simple', checked: this.settings.notifyScheme == 'simple'}, events: {change: onChangeNotifyScheme}}),
			BX.create("label", {attrs : { 'for': 'notifySchemeSimpleValue'}, html: ' '+BX.message('IM_SETTINGS_NS_1')+' '}),
			BX.create("input", {attrs : { id: 'notifySchemeExpertValue', 'data-save': 1,  type: "radio", name: "notifyScheme", value: 'expert', checked: this.settings.notifyScheme == 'expert'}, events: {change: onChangeNotifyScheme}}),
			BX.create("label", {attrs : { 'for': 'notifySchemeExpertValue'}, html: ' '+BX.message('IM_SETTINGS_NS_2')+' '})
		]}));
		/*
		items.push(BX.create("div", {attrs: {id: "bx-messenger-settings-notify-important"}, style : {display: this.settings.notifyScheme == 'simple'? 'block':'none'}, props : { className: "bx-messenger-settings-notify-important"}, children : [
			BX.create("input", {attrs : { id: 'notifySchemeLevelImportantValue', 'data-save': 1,  type: "radio", name: "notifySchemeLevel", value: 'important', checked: this.settings.notifySchemeLevel == 'important'}}),
			BX.create("label", {attrs : { 'for': 'notifySchemeLevelImportantValue'}, html: ' '+BX.message('IM_SETTINGS_NSL_1')+' '}),
			BX.create("input", {attrs : { id: 'notifySchemeLevelNormalValue', 'data-save': 1,  type: "radio", name: "notifySchemeLevel", value: 'normal', checked: this.settings.notifySchemeLevel == 'normal'}}),
			BX.create("label", {attrs : { 'for': 'notifySchemeLevelNormalValue'}, html: ' '+BX.message('IM_SETTINGS_NSL_2')+' '})
		]}));
		*/
		items.push(BX.create("div", {attrs: {id: "bx-messenger-settings-notify-clients"}, style : {display: this.settings.notifyScheme == 'simple'? 'block':'none'}, props : { className: "bx-messenger-settings-notify-clients"}, children : [
			BX.create("div", {props: {className: 'bx-messenger-settings-notify-clients-title'}, html: BX.message('IM_SETTINGS_NC_1_NEW')}),
			BX.create("div", {props: {className: 'bx-messenger-settings-notify-clients-item'}, children: [
				BX.create("input", {
					attrs : { 'data-save': 1,  type: "checkbox", id: "notifySchemeSendSite", name: "notifySchemeSendSite", value: 'Y', checked: this.settings.notifySchemeSendSite},
					events : { change : function(e) {if (!this.checked) {BX('notifySchemeSendEmail').checked = false;} else {BX('notifySchemeSendEmail').checked = true;}}}
				}),
				BX.create("label", {attrs : {'for': "notifySchemeSendSite"}, html: ' '+BX.message('IM_SETTINGS_NC_2')+'<br />'})
			]}),
			this.bitrixXmpp? BX.create("div", {props: {className: 'bx-messenger-settings-notify-clients-item'}, children: [
				BX.create("input", {attrs : { 'data-save': 1,  type: "checkbox", id: "notifySchemeSendXmpp", name: "notifySchemeSendXmpp", value: 'Y', checked: this.settings.notifySchemeSendXmpp}}),
				BX.create("label", {attrs : {'for': "notifySchemeSendXmpp"}, html: ' '+BX.message('IM_SETTINGS_NC_3')+'<br />'})
			]}): null,
			BX.create("div", {props: {className: 'bx-messenger-settings-notify-clients-item'}, children: [
				BX.create("input", {
					attrs : { 'data-save': 1,  type: "checkbox", id: "notifySchemeSendEmail", name: "notifySchemeSendEmail", value: 'Y', checked: this.settings.notifySchemeSendEmail},
					events : { change : function(e) {if (this.checked) {BX('notifySchemeSendSite').checked = true;}}}
				}),
				BX.create("label", {attrs : {'for': "notifySchemeSendEmail"}, html: ' '+BX.message('IM_SETTINGS_NC_4').replace('#MAIL#', this.userEmail)+''})
			]}),
			this.bitrixMobile? BX.create("div", {props: {className: 'bx-messenger-settings-notify-clients-item'}, children: [
				BX.create("input", {attrs : { 'data-save': 1,  type: "checkbox", id: "notifySchemeSendPush", name: "notifySchemeSendPush", value: 'Y', checked: this.settings.notifySchemeSendPush}}),
				BX.create("label", {attrs : {'for': "notifySchemeSendPush"}, html: ' '+BX.message('IM_SETTINGS_NC_5')+'<br />'})
			]}): null
		]}));
	}

	return items;
};

BX.IM.prototype.showHardwareSettings = function()
{
	var self = this;

	var elements = {
		micSelect: document.querySelector('[name=defaultMicrophone]'),
		camSelect: document.querySelector('[name=defaultCamera]'),
		speakerSelect: document.querySelector('[name=defaultSpeaker]'),
		audioLevel: BX('bx-messenger-settings-hardware-microphone-level'),
		cameraImage: BX('bx-messenger-settings-hardware-camera-image'),
		video: BX('bx-messenger-settings-hardware-camera-image-video'),
		error: BX('bx-messenger-settings-hardware-error'),
	};

	if(this.settingsCameraTestMediaStream)
	{
		return;
	}

	if(!elements.micSelect || !elements.camSelect)
	{
		return;
	}

	elements.micSelect.style.minWidth = '200px';
	elements.camSelect.style.minWidth = '200px';

	if(!elements.video)
	{
		elements.video = BX.create('video', {attrs: {id: 'bx-messenger-settings-hardware-camera-image-video'}});
		elements.cameraImage.appendChild(elements.video);
		elements.video.addEventListener('loadedmetadata', function()
		{
			if(BX.MessengerCommon.isDesktop())
			{
				BX.desktop.resize();
			}
		});
	}

	if(!this.callController.isWebRTCSupported())
	{
		console.log('webrtc is not supported');
		return;
	}

	var constraints = {
		audio: false,
		video: false
	};

	var supportedDevices = {
		audioInput: false,
		videoInput: false,
		audioOutput: false
	};

	var foundDevices = {
		audioInput: false,
		videoInput: false,
		audioOutput: false
	};

	var isHttps = window.location.protocol === "https:";

	navigator.mediaDevices.enumerateDevices().then(function(devices)
	{
		devices.forEach(function(mediaDevice)
		{
			if(mediaDevice.kind == 'audioinput')
			{
				supportedDevices.audioInput = true;
				if(self.webrtc.defaultMicrophone === mediaDevice.deviceId)
				{
					foundDevices.audioInput = true;
				}
			}
			else if(mediaDevice.kind == 'videoinput')
			{
				supportedDevices.videoInput = true;
				if(self.webrtc.defaultCamera === mediaDevice.deviceId)
				{
					foundDevices.videoInput = true;
				}
			}
			else if(mediaDevice.kind == 'audiooutput')
			{
				supportedDevices.audioOutput = true;
				if(self.webrtc.defaultSpeaker === mediaDevice.deviceId)
				{
					foundDevices.audioOutput = true;
				}
			}
		});

		if(!foundDevices.audioInput)
		{
			window.localStorage.removeItem('bx-im-settings-default-microphone');
			self.webrtc.defaultMicrophone = '';
		}
		if(!foundDevices.videoInput)
		{
			window.localStorage.removeItem('bx-im-settings-default-camera');
			self.webrtc.defaultCamera = '';
		}
		if(!foundDevices.audioOutput)
		{
			window.localStorage.removeItem('bx-im-settings-default-speaker');
			self.webrtc.defaultSpeaker = '';
		}

		if(supportedDevices.audioInput)
		{
			if(self.webrtc.defaultMicrophone)
				constraints.audio = {deviceId: {exact: self.webrtc.defaultMicrophone}};
			else
				constraints.audio = true;
		}
		if(supportedDevices.videoInput)
		{
			if(self.webrtc.defaultCamera)
				constraints.video = {deviceId: {exact: self.webrtc.defaultCamera}};
			else
				constraints.video = true;
		}

		return navigator.mediaDevices.getUserMedia(constraints);
	}).then(function(mediaStream)
	{
		self.settingsCameraTestMediaStream = mediaStream;
		self.settingsLevelMeter = new BX.IM.LevelMeter(elements.audioLevel);
		if(self.settingsLevelMeter.supported)
			self.settingsLevelMeter.attachMediaStream(mediaStream);

		elements.video.srcObject = mediaStream;
		elements.video.play();
		elements.video.muted = true;
		if(BX.MessengerCommon.isDesktop())
		{
			BX.desktop.resize();
		}
		return navigator.mediaDevices.enumerateDevices();
	}).then(function(devices)
	{
		var videoTrackLabel = (function()
		{
			var videoTracks = self.settingsCameraTestMediaStream.getVideoTracks();
			if(videoTracks.length > 0 && videoTracks[0].label)
				return videoTracks[0].label;
			else
				return '';
		})();
		var audioTrackLabel = (function()
		{
			var audioTracks = self.settingsCameraTestMediaStream.getAudioTracks();
			if(audioTracks.length > 0 && audioTracks[0].label)
				return audioTracks[0].label;
			else
				return '';
		})();

		return new Promise(function(resolve, reject)
		{
			if(devices && elements.micSelect.options.length == 0 && elements.camSelect.options.length == 0)
			{
				devices.forEach(function(device)
				{
					var option;
					var hasAudioInputDevices = false;
					var hasAudioOutputDevices = false;
					var hasVideoInputDevices = false;

					var deviceLabel = device.label == '' ? BX.message('IM_SETTINGS_HARDWARE_DEFAULT_MICROPHONE') : device.label;

					if(device.kind == 'audioinput')
					{
						hasAudioInputDevices = true;
						option = BX.create('option', {text: deviceLabel, attrs:{value: device.deviceId}});

						if(device.label === audioTrackLabel || device.deviceId === self.webrtc.defaultMicrophone)
						{
							option.selected = true;
						}
						elements.micSelect.options.add(option);
					}
					else if(device.kind == 'videoinput')
					{
						hasVideoInputDevices = true;
						option = BX.create('option', {text: deviceLabel, attrs:{value: device.deviceId}});
						if(device.label === videoTrackLabel || device.deviceId === self.webrtc.defaultCamera)
						{
							option.selected = true;
						}
						elements.camSelect.options.add(option);
					}
					else if(device.kind == 'audiooutput')
					{
						hasAudioOutputDevices = true;
						option = BX.create('option', {text: deviceLabel, attrs:{value: device.deviceId}});
						if(device.deviceId === self.webrtc.defaultSpeaker)
						{
							option.selected = true;
						}
						elements.speakerSelect.options.add(option);
					}
				});
				resolve();
			}
			else
			{
				reject();
			}
		});
	}).catch(function(e)
	{
		console.log('could not access user hardware. constraints were: ', constraints);
		console.log(e);

		elements.error.appendChild(BX.create("div", {
			props: {className: "ui-alert ui-alert-icon-danger"},
			children: [
				BX.create("span", {
					props: {className: "ui-alert-message"},
					text: BX.message("IM_SETTINGS_HARDWARE_ERROR") + (isHttps ? "" : " " + BX.message("IM_SETTINGS_HARDWARE_USE_HTTPS"))
				})
			]
		}))
	});
};

BX.IM.prototype.changeHardwareSettings = function()
{
	var self = this;
	var elements = {
		micSelect: document.querySelector('[name=defaultMicrophone]'),
		camSelect: document.querySelector('[name=defaultCamera]'),
		audioLevel: BX('bx-messenger-settings-hardware-microphone-level'),
		cameraImage: BX('bx-messenger-settings-hardware-camera-image'),
		video: BX('bx-messenger-settings-hardware-camera-image-video')
	};

	if(this.settingsCameraTestMediaStream)
	{
		BX.webrtc.stopMediaStream(this.settingsCameraTestMediaStream);
		this.settingsCameraTestMediaStream = null;
	}

	if(this.settingsLevelMeter)
	{
		this.settingsLevelMeter.stop();
	}

	var constraints = {
		audio: {
			deviceId: elements.micSelect.value ? {exact: elements.micSelect.value} : undefined
		},
		video: {
			deviceId: elements.camSelect.value ? {exact: elements.camSelect.value} : undefined
		}
	};

	navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream)
	{
		self.settingsCameraTestMediaStream = mediaStream;
		if(self.settingsLevelMeter.supported)
			self.settingsLevelMeter.attachMediaStream(mediaStream);

		elements.video.srcObject = mediaStream;
		elements.video.play();
		if(BX.MessengerCommon.isDesktop())
		{
			BX.desktop.resize();
		}
	}).catch(function(e)
	{
		console.log('could not access user hardware', e);
	});
};

BX.IM.prototype.closeHardwareSettings = function()
{
	if(this.settingsCameraTestMediaStream)
		BX.webrtc.stopMediaStream(this.settingsCameraTestMediaStream);

	if(this.settingsLevelMeter)
		this.settingsLevelMeter.stop();

	this.settingsCameraTestMediaStream = null;
	this.webrtc.readDefaults();
};

BX.IM.prototype.saveSetting = function(name, value)
{
	this.settings[name] = value;

	var settings = {};
	settings[name] = value;

	this.saveSettings(settings);

	return true;
}

BX.IM.prototype.saveSettings = function(settings)
{
	var timeoutKey = '';
	for (var config in settings)
	{
		this.settings[config] = settings[config];
		timeoutKey = timeoutKey+config;
	}
	BX.localStorage.set('ims', JSON.stringify(this.settings), 5);

	if (this.saveSettingsTimeout[timeoutKey])
		clearTimeout(this.saveSettingsTimeout[timeoutKey]);

	this.saveSettingsTimeout[timeoutKey] = setTimeout(BX.delegate(function(){
		BX.ajax({
			url: this.pathToAjax+'?SETTINGS_SAVE&V='+this.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: {'IM_SETTING_SAVE' : 'Y', 'IM_AJAX_CALL' : 'Y', SETTINGS: JSON.stringify(settings), 'sessid': BX.bitrix_sessid()}
		});
		delete this.saveSettingsTimeout[timeoutKey];
	}, this), 700);
};

BX.IM.prototype.saveFormSettings = function()
{
	var inputs = BX.findChildren(this.popupSettingsBody, {attribute : "data-save"}, true);
	for (var i = 0; i < inputs.length; i++)
	{
		if (inputs[i].tagName == 'INPUT' && inputs[i].type == 'checkbox')
		{
			if (typeof(this.settingsSaveCallback[inputs[i].name]) == 'function')
				this.settings[inputs[i].name] = this.settingsSaveCallback[inputs[i].name](inputs[i]);
			else
				this.settings[inputs[i].name] = inputs[i].checked;
		}
		else if (inputs[i].tagName == 'INPUT' && inputs[i].type == 'radio' && inputs[i].checked)
		{
			if (typeof(this.settingsSaveCallback[inputs[i].name]) == 'function')
				this.settings[inputs[i].name] = this.settingsSaveCallback[inputs[i].name](inputs[i]);
			else
				this.settings[inputs[i].name] = inputs[i].value;
		}
		else if (inputs[i].tagName == 'SELECT')
		{
			if (typeof(this.settingsSaveCallback[inputs[i].name]) == 'function')
				this.settings[inputs[i].name] = this.settingsSaveCallback[inputs[i].name](inputs[i]);
			else
				this.settings[inputs[i].name] = inputs[i][inputs[i].selectedIndex].value;
		}
	}

	var values = this.settings['notifyScheme'] == 'simple'? {}: {notify: {}};
	for (var config in this.settings)
	{
		if (config.substr(0,7) == 'notify|')
		{
			if (this.settingsDisabled[config])
				continue;
			if (values['notify'])
				values['notify'][config.substr(7)] = this.settings[config];
		}
		else
		{
			values[config] = this.settings[config];
		}
	}

	if (BX.MessengerCommon.isDesktop())
	{
		BX.desktop.onCustomEvent("bxSaveSettings", [this.settings]);
	}
	else
	{
		BX.localStorage.set('ims', JSON.stringify(this.settings), 5);
	}

	if (this.messenger != null)
	{
		BX.MessengerCommon.userListRedraw(true);
		if (this.messenger.popupMessengerTextareaSendType)
			this.messenger.popupMessengerTextareaSendType.innerHTML = this.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");
	}

	BX.ajax({
		url: this.pathToAjax+'?SETTINGS_FORM_SAVE&V='+this.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SETTINGS_SAVE' : 'Y', 'IM_AJAX_CALL' : 'Y', SETTINGS: JSON.stringify(values), 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function() {
			BX.MessengerCommon.drawTab(this.messenger.currentTab, true);
			this.popupSettings.close();
		}, this),
		onfailure: BX.delegate(function() {
			this.popupSettingsButtonSave.setClassName('popup-window-button popup-window-button-accept');
			this.popupSettingsButtonSave.setName(BX.message('IM_SETTINGS_SAVE'));
			BX.show(this.popupSettingsButtonClose.buttonNode);
		}, this)
	});
};

BX.IM.prototype.GetNotifySettings = function()
{
	BX.ajax({
		url: this.pathToAjax+'?SETTINGS_NOTIFY_LOAD&V='+this.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SETTINGS_NOTIFY_LOAD' : 'Y', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			if (data.ERROR == "")
			{
				if (this.settings.notifyScheme == 'simple')
				{
					for (var configName in data.VALUES)
					{
						if (configName.substr(0,10) == 'important|')
						{
							continue;
						}
						if (configName.substr(0,9) == 'disabled|')
						{
							this.settingsDisabled['notify|'+configName.substr(9)] = data.VALUES[configName];
							continue;
						}

						if (!BX('notifySchemeSendSite').checked && configName.substr(0,5) == 'site|')
							data.VALUES[configName] = false;
						else if (this.bitrixXmpp && !BX('notifySchemeSendXmpp').checked && configName.substr(0,5) == 'xmpp|')
							data.VALUES[configName] = false;
						else if (!BX('notifySchemeSendEmail').checked && configName.substr(0,6) == 'email|')
							data.VALUES[configName] = false;
						else if (this.bitrixMobile && !BX('notifySchemeSendPush').checked && configName.substr(0,5) == 'push|')
							data.VALUES[configName] = false;

						this.settings['notify|'+configName] = data.VALUES[configName];
					}
				}
				else
				{
					for (var configName in data.VALUES)
					{
						if (configName.substr(0,10) == 'important|')
						{
							continue;
						}
						if (configName.substr(0,9) == 'disabled|')
						{
							this.settingsDisabled['notify|'+configName.substr(9)] = data.VALUES[configName];
							continue;
						}
						this.settings['notify|'+configName] = data.VALUES[configName];
					}
				}

				var rows = [];
				if (data.NAMES['im'])
				{
					rows.push([{'type': 'separator', title: data.NAMES['im'].NAME}]);
					for (var notifyId in data.NAMES['im']['NOTIFY'])
					{
						var notifyName = data.NAMES['im']['NOTIFY'][notifyId];
						rows.push([
							{'type': 'text', title: notifyName},
							{'type': 'checkbox', id: 'notifyId|site|im|'+notifyId, name: 'notify|site|im|'+notifyId, callback : function(e) {if (BX(this.id.replace('|site|', '|email|')).disabled) { return true; } if (!this.checked) { BX(this.id.replace('|site|', '|email|')).checked = false;} else {BX(this.id.replace('|site|', '|email|')).checked = true;}}},
							this.bitrixXmpp? {'type': 'checkbox', name: 'notify|xmpp|im|'+notifyId}: false,
							{'type': 'checkbox', id: 'notifyId|email|im|'+notifyId, name: 'notify|email|im|'+notifyId, callback : function(e) {if (BX(this.id.replace('|email|', '|site|')).disabled) { return true; } if (this.checked) { BX(this.id.replace('|email|', '|site|')).checked = true;}}},
							this.bitrixMobile? {'type': 'checkbox', name: 'notify|push|im|'+notifyId}: false
						]);
					}
				}

				for (var moduleId in data.NAMES)
				{
					if (moduleId == 'im')
						continue;

					rows.push([{'type': 'separator', title: data.NAMES[moduleId].NAME}]);
					for (var notifyId in data.NAMES[moduleId]['NOTIFY'])
					{
						var notifyName = data.NAMES[moduleId]['NOTIFY'][notifyId];
						rows.push([
							{'type': 'text', title: notifyName},
							{'type': 'checkbox',  id: 'notifyId|site|'+moduleId+'|'+notifyId, name: 'notify|site|'+moduleId+'|'+notifyId, callback : function(e) {if (BX(this.id.replace('|site|', '|email|')).disabled) { return true; } if (!this.checked) {BX(this.id.replace('|site|', '|email|')).checked = false;} else {BX(this.id.replace('|site|', '|email|')).checked = true;}}},
							this.bitrixXmpp? {'type': 'checkbox', name: 'notify|xmpp|'+moduleId+'|'+notifyId}: false,
							{'type': 'checkbox', id: 'notifyId|email|'+moduleId+'|'+notifyId, name: 'notify|email|'+moduleId+'|'+notifyId, callback : function(e) {if (BX(this.id.replace('|email|', '|site|')).disabled) { return true; } if (this.checked) {BX(this.id.replace('|email|', '|site|')).checked = true;}}},
							this.bitrixMobile? {'type': 'checkbox', name: 'notify|push|'+moduleId+'|'+notifyId}: false
						]);
					}
				}

				this.settingsTableConfig['notify'].rows = rows;
			}
			else
			{
				this.settingsTableConfig['notify'].rows = [
					[{'type': 'error', title: BX.message('IM_M_ERROR')}]
				];
			}
			BX('bx-messenger-settings-table-notify').innerHTML = '';
			BX.adjust(BX('bx-messenger-settings-table-notify'), {children: [this.prepareSettingsTable('notify')]});
			if (data.ERROR != "")
				this.settingsTableConfig['notify'].rows = [];
			if (BX.MessengerCommon.isDesktop())
				this.desktop.autoResize();
		}, this),
		onfailure: BX.delegate(function() {
			this.settingsTableConfig['notify'].rows = [
				[{'type': 'error', title: BX.message('IM_M_ERROR')}]
			];
			BX('bx-messenger-settings-table-notify').innerHTML = '';
			BX.adjust(BX('bx-messenger-settings-table-notify'), {children: [this.prepareSettingsTable('notify')]});
			this.settingsTableConfig['notify'].rows = [];
			if (BX.MessengerCommon.isDesktop())
				this.desktop.autoResize()
		}, this)
	});
};

BX.IM.prototype.GetSimpleNotifySettings = function()
{
	BX.ajax({
		url: this.pathToAjax+'?SETTINGS_SIMPLE_NOTIFY_LOAD&V='+this.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SETTINGS_SIMPLE_NOTIFY_LOAD' : 'Y', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			if (data.ERROR == "")
			{
				var rows = [];
				for (var moduleId in data.VALUES)
				{
					rows.push([{'type': 'separator', title: data.NAMES[moduleId]? data.NAMES[moduleId].NAME: '-'}]);
					for (var notifyId in data.VALUES[moduleId])
					{
						var notifyName = data.NAMES[moduleId]? data.NAMES[moduleId]['NOTIFY'][notifyId]: '-';
						rows.push([
							{'type': 'text', title: notifyName},
							{'type': 'link', title: BX.message('IM_SETTINGS_SNOTIFY_ENABLE'), attrs: { 'data-settingName': moduleId+'|'+notifyId}, callback: BX.delegate(function(){ this.removeSimpleNotify(BX.proxy_context)}, this)}
						]);
						this.settingsNotifyBlocked[moduleId+"|"+notifyId] = true;
					}
				}
				this.settingsTableConfig['simpleNotify'].rows = rows;
			}
			else
			{
				this.settingsTableConfig['simpleNotify'].rows = [
					[{'type': 'error', title: BX.message('IM_M_ERROR')}]
				];
			}
			BX('bx-messenger-settings-table-simpleNotify').innerHTML = '';
			BX.adjust(BX('bx-messenger-settings-table-simpleNotify'), {children: [this.prepareSettingsTable('simpleNotify')]});
			if (data.ERROR != "")
				this.settingsTableConfig['simpleNotify'].rows = [];
			if (BX.MessengerCommon.isDesktop())
				this.desktop.autoResize();
		}, this),
		onfailure: BX.delegate(function() {
			this.settingsTableConfig['simpleNotify'].rows = [
				[{'type': 'error', title: BX.message('IM_M_ERROR')}]
			];
			if (BX('bx-messenger-settings-table-simpleNotify'))
			{
				BX('bx-messenger-settings-table-simpleNotify').innerHTML = '';
				BX.adjust(BX('bx-messenger-settings-table-simpleNotify'), {children: [this.prepareSettingsTable('simpleNotify')]});
			}
			this.settingsTableConfig['simpleNotify'].rows = [];
			if (BX.MessengerCommon.isDesktop())
				this.desktop.autoResize();
		}, this)
	});
};

BX.IM.prototype.removeSimpleNotify = function(element)
{
	var table = element.parentNode.parentNode.parentNode;
	if (!element.parentNode.parentNode.nextSibling && element.parentNode.parentNode.previousSibling.childNodes[0].className != "bx-messenger-settings-table-sep")
	{
		BX.remove(element.parentNode.parentNode);
	}
	else if (element.parentNode.parentNode.previousSibling && element.parentNode.parentNode.previousSibling.childNodes[0].className != "bx-messenger-settings-table-sep")
	{
		BX.remove(element.parentNode.parentNode);
	}
	else if (element.parentNode.parentNode.nextSibling && element.parentNode.parentNode.nextSibling.childNodes[0].className != "bx-messenger-settings-table-sep")
	{
		BX.remove(element.parentNode.parentNode);
	}
	else if (element.parentNode.parentNode.previousSibling.childNodes[0].className == "bx-messenger-settings-table-sep" && !element.parentNode.parentNode.nextSibling)
	{
		BX.remove(element.parentNode.parentNode.previousSibling);
		BX.remove(element.parentNode.parentNode);
	}
	else if (element.parentNode.parentNode.previousSibling.childNodes[0].className == "bx-messenger-settings-table-sep" && element.parentNode.parentNode.nextSibling.childNodes[0].className == "bx-messenger-settings-table-sep")
	{
		BX.remove(element.parentNode.parentNode.previousSibling);
		BX.remove(element.parentNode.parentNode);
	}
	if (table.childNodes.length <= 1)
		BX.remove(table);

	this.notify.blockNotifyType(element.getAttribute('data-settingName'));

	if (BX.MessengerCommon.isDesktop())
		this.desktop.autoResize();
};

BX.IM.prototype.openConfirm = function(text, buttons, modal)
{
	if (this.popupConfirm != null)
		this.popupConfirm.destroy();

	if (typeof(text) == "object")
		text = '<div class="bx-messenger-confirm-title">'+text.title+'</div>'+text.message;

	modal = modal !== false;
	var autohide = (buttons === false);
	if (typeof(buttons) == "undefined" || typeof(buttons) == "object" && buttons.length <= 0 || buttons === false)
	{
		buttons = [new BX.PopupWindowButton({
			text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
			className : "popup-window-button-decline",
			events : { click : function(e) { this.popupWindow.close(); BX.PreventDefault(e) } }
		})];
	}
	this.popupConfirm = new BX.PopupWindow('bx-notifier-popup-confirm', null, {
		//parentPopup: this.messenger.popupMessenger,
		zIndex: 15000,
		autoHide: buttons === false,
		buttons : buttons,
		closeByEsc: buttons === false,
		overlay : modal,
		events : { onPopupClose : function() { this.destroy() }, onPopupDestroy : BX.delegate(function() { this.popupConfirm = null }, this)},
		content : BX.create("div", { props : { className : (buttons === false? " bx-messenger-confirm-without-buttons": "bx-messenger-confirm") }, html: text})
	});
	BX.addClass(this.popupConfirm.popupContainer, "bx-messenger-mark");
	this.popupConfirm.show();
	BX.bind(this.popupConfirm.popupContainer, "click", BX.MessengerCommon.preventDefault);
	BX.bind(this.popupConfirm.contentContainer, "click", BX.PreventDefault);
	BX.bind(this.popupConfirm.overlay.element, "click", BX.PreventDefault);
	if(autohide === true)
	{
		setTimeout(BX.delegate(function()
		{
			this.close();
		}, this.popupConfirm), 2000);
	}
};

BX.IM.prototype.setBackground = function(value)
{
	var classNode = null;
	var mainNode = null;

	if (BX.MessengerCommon.isPage())
	{
		mainNode = BX.MessengerWindow.contentBox;
	}
	else
	{
		mainNode = this.messenger.popupMessengerContent;
	}

	var isChanged = false;
	if (typeof(value) == 'undefined')
	{
		value = this.settings.backgroundImage;
	}
	else
	{
		if (value == "on")
		{
			value = true;
		}
		else if (value == "off")
		{
			value = false;
		}
		else if (this.colorsHex[value.toString().toUpperCase()])
		{
			value = this.colorsHex[value.toString().toUpperCase()];
		}
		else
		{
			var colors = {};
			for (var color in this.colors)
			{
				colors[this.colors[color].toUpperCase()] = color;
			}
			if (colors[value.toString().toUpperCase()])
			{
				var color = colors[value.toString().toUpperCase()];
				if (this.colorsHex[color])
				{
					value = this.colorsHex[color];
				}
			}
		}

		isChanged = this.settings.backgroundImage != value;
	}

	if (value === false)
	{
		BX.removeClass(mainNode, "bx-messenger-image");
		BX.removeClass(mainNode, "bx-messenger-image-link");
		BX.style(mainNode, "background-image", "");
		BX.style(mainNode, "background-color", "");
	}
	else if (value === true)
	{
		BX.addClass(mainNode, "bx-messenger-image");
		BX.removeClass(mainNode, "bx-messenger-image-link");
		BX.style(mainNode, "background-image", "");
		BX.style(mainNode, "background-color", "");
	}
	else if (value.toString().length > 0)
	{
		BX.addClass(mainNode, "bx-messenger-image");
		if (value.toString().substr(0,1) == '#')
		{
			BX.style(mainNode, "background-color", value);
			BX.style(mainNode, "background-image", "");
		}
		else if (value.toString().substr(0,4) == 'http')
		{
			BX.addClass(mainNode, "bx-messenger-image-link");
			BX.style(mainNode, "background-image", "url("+value+")");
			BX.style(mainNode, "background-color", "");
		}
		else
		{
			return false;
		}
	}
	else
	{
		return false;
	}

	if (isChanged)
	{
		this.saveSettings({'backgroundImage': value});
	}
}

BX.IM.getSelectionText = function()
{
	var selected = '';

	if (window.getSelection)
	{
		selected = window.getSelection().toString();
	}
	else
	{
		selected = document.selection.createRange().text;
	}

	return selected;
}

BX.IM.prototype.getLocalConfig = function(name, def)
{
	if (BX.MessengerCommon.isDesktop())
	{
		return BX.desktop.getLocalConfig(name, def);
	}

	def = typeof(def) == 'undefined'? null: def;

	if (!BX.browser.SupportLocalStorage())
	{
		return def;
	}

	if (BX.MessengerCommon.isPage() && !BX.MessengerCommon.isDesktop())
		name = 'full-'+name;

	var result = BX.localStorage.get(name);
	if (result == null)
	{
		return def;
	}

	if (typeof(result) == 'string' && result.length > 0)
	{
		try {
			result = JSON.parse(result);
		}
		catch(e) { result = def; }
	}

	return result;
};

BX.IM.prototype.setLocalConfig = function(name, value, ttl)
{
	if (BX.MessengerCommon.isDesktop())
	{
		return BX.desktop.setLocalConfig(name, value);
	}

	ttl = ttl || 86400;

	if (typeof(value) == 'object')
		value = JSON.stringify(value);
	else if (typeof(value) == 'boolean')
		value = value? 'true': 'false';
	else if (typeof(value) == 'undefined')
		value = '';
	else if (typeof(value) != 'string')
		value = value+'';

	if (!BX.browser.SupportLocalStorage())
		return false;

	if (BX.MessengerCommon.isPage() && !BX.MessengerCommon.isDesktop())
		name = 'full-'+name;

	BX.localStorage.set(name, value, ttl);

	return true;
};

BX.IM.prototype.removeLocalConfig = function(name)
{
	if (BX.MessengerCommon.isDesktop())
	{
		return BX.desktop.removeLocalConfig(name);
	}

	if (!BX.browser.SupportLocalStorage())
		return false;

	if (BX.MessengerCommon.isPage() && !BX.MessengerCommon.isDesktop())
		name = 'full-'+name;

	BX.localStorage.remove(name);

	return true;
};

BX.IM.prototype.storageSet = function(params)
{
	if (params.key == 'mps')
	{
		this.stopSound();
	}
	else if (params.key == 'mrss')
	{
		this.stopRepeatSound(params.value.sound, false);
	}
};
})();


/* IM notify class */

(function() {

if (BX.MessengerNotify)
	return;

BX.MessengerNotify = function(BXIM, params)
{
	this.BXIM = BXIM;
	this.settings = {};
	this.params = params || {};
	this.windowInnerSize = {};
	this.windowScrollPos = {};
	this.sendAjaxTry = 0;

	this.webrtc = params.webrtcClass;
	this.desktop = params.desktopClass;

	this.notifyCount = params.countNotify;
	this.notifyUpdateCount = params.countNotify;
	this.counters = params.counters;
	this.mailCount = params.mailCount;

	this.notifyAnswerBlock = {};
	this.notifyAnswerText = {};

	this.notifyHistoryPage = 0;
	this.notifyHistoryLoad = false;

	this.notifyBody = null;
	this.notify = params.notify;
	for (var notifyId in this.notify)
	{
		this.notify[notifyId].date = new Date(this.notify[notifyId].date);
	}

	this.notifyLoad = false;
	this.unreadNotify = params.unreadNotify;
	this.unreadNotifyLoad = params.loadNotify;
	this.flashNotify = params.flashNotify;
	this.initNotifyCount = params.countNotify;
	this.confirmDisabledButtons = false;

	if (this.unreadNotifyLoad)
	{
		for (var i in this.notify)
			this.initNotifyCount--;
	}

	if (params.domNode)
	{
		this.panel = params.domNode;
		this.panelEnabled = true;
		BX.bind(this.panel, 'click', BX.PreventDefault);
	}
	else
	{
		this.panel = BX.create('span', {props: { className: "bx-messenger-hide"}});
		this.panelEnabled = false;
	}

	if (this.panelEnabled)
	{
		if (BX.browser.IsDoctype())
			BX.addClass(this.panel, 'bx-notifier-panel-doc');
		else
			BX.addClass(document.body, 'bx-no-doctype');

		this.panelButtonCall = BX.findChildByClassName(this.panel, "bx-notifier-call");
		if (!this.webrtc.phoneEnabled || !this.webrtc.phoneCanPerformCalls)
		{
			BX.style(this.panelButtonCall, 'display', 'none');
		}

		this.panelButtonNetwork = BX.findChildByClassName(this.panel, "bx-notifier-network");
		if (this.panelButtonNetwork)
		{
			this.panelButtonNetworkCount = BX.findChildByClassName(this.panelButtonNetwork, "bx-notifier-indicator-count");
			if (this.BXIM.bitrixNetwork)
			{
				this.panelButtonNetwork.href = "https://www.bitrix24.net/";
				this.panelButtonNetwork.setAttribute('target', '_blank');
				if (this.panelButtonNetworkCount != null)
					this.panelButtonNetworkCount.innerHTML = '';
			}
			else
			{
				BX.style(this.panelButtonNetwork, 'display', 'none');
				this.panelButtonNetworkCount.innerHTML = '';
			}
		}

		this.panelButtonNotify = BX.findChildByClassName(this.panel, "bx-notifier-notify");
		if (this.panelButtonNotify)
		{
			this.panelButtonNotifyCount = BX.findChildByClassName(this.panelButtonNotify, "bx-notifier-indicator-count");
			if (this.panelButtonNotifyCount)
				this.panelButtonNotifyCount.innerHTML = '';
		}

		this.panelButtonMessage = BX.findChildByClassName(this.panel, "bx-notifier-message");
		if (this.panelButtonMessage)
		{
			this.panelButtonMessageCount = BX.findChildByClassName(this.panelButtonMessage, "bx-notifier-indicator-count");
			if (this.panelButtonMessageCount)
				this.panelButtonMessageCount.innerHTML = '';
		}

		this.panelButtonMail = BX.findChildByClassName(this.panel, "bx-notifier-mail");
		if (this.panelButtonMail)
		{
			this.panelButtonMailCount = BX.findChildByClassName(this.panelButtonMail, "bx-notifier-indicator-count");
			if (this.panelButtonMailCount)
			{
				this.panelButtonMail.href = this.BXIM.path.mail;
				this.panelButtonMail.setAttribute('target', '_blank');
				if (this.panelButtonMailCount != null)
					this.panelButtonMailCount.innerHTML = '';
			}
		}
		this.panelDragLabel = BX.findChildByClassName(this.panel, "bx-notifier-drag");
		if (this.panelDragLabel)
		{
			BX.bind(this.panelDragLabel, "mousedown", BX.delegate(this._startDrag, this));
			BX.bind(this.panelDragLabel, "dobleclick", BX.delegate(this._stopDrag, this));
		}
	}

	if (BX.browser.IsAndroid() || BX.browser.IsIOS())
		BX.addClass(document.body, 'bx-im-mobile');

	this.messenger = null;
	this.messengerNotifyButton = null;
	this.messengerNotifyButtonCount = null;

	/* full window notify */
	this.popupNotifyItem = null;
	this.popupNotifySize = 387;
	this.popupNotifySizeMin = 317;

	this.popupNotifyButtonFilter = null;
	this.popupNotifyButtonFilterBox = null;
	this.popupHistoryFilterVisible = false;
	/* more users from notify */
	this.popupNotifyMore = null;

	this.dragged = false;
	this.dragPageX = 0;
	this.dragPageY = 0;

	if (this.BXIM.init)
	{
		if (BX.MessengerCommon.isPage())
		{
			BX.MessengerWindow.addTab({
				id: 'notify',
				title: BX.message('IM_SETTINGS_NOTIFY'),
				order: 110,
				target: 'im',
				events: {
					open: BX.delegate(function(){
						this.openNotify(false, true)
					}, this)
				}
			});
		}

		this.panel.appendChild(this.BXIM.audio.reminder = BX.create("audio", { props : { className : "bx-notify-audio" }, children : [
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/reminder.ogg", type : "audio/ogg; codecs=vorbis" }}),
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/reminder.mp3", type : "audio/mpeg" }})
		]}));
		if (typeof(this.BXIM.audio.reminder.play) == 'undefined')
		{
			this.BXIM.settings.enableSound = false;
		}

		if (BX.browser.SupportLocalStorage())
		{
			BX.addCustomEvent(window, "onLocalStorageSet", BX.proxy(this.storageSet, this));
			var panelPosition = BX.localStorage.get('npp');
			this.BXIM.settings.panelPositionHorizontal = !!panelPosition? panelPosition.h: this.BXIM.settings.panelPositionHorizontal;
			this.BXIM.settings.panelPositionVertical = !!panelPosition? panelPosition.v: this.BXIM.settings.panelPositionVertical;

			var mfn = BX.localStorage.get('mfn');
			if (mfn)
			{
				for (var i in this.flashNotify)
					if (this.flashNotify[i] != mfn[i] && mfn[i] == false)
						this.flashNotify[i] = false;
			}

			BX.garbage(function(){
				BX.localStorage.set('mfn', this.flashNotify, 15);
			}, this);
		}

		if (this.panelButtonNotify)
		{
			BX.bind(this.panelButtonNotify, "click", BX.proxy(function(){
				this.toggleNotify()
			}, this.BXIM));
		}

		if (this.webrtc.phoneEnabled && this.webrtc.phoneCanPerformCalls)
		{
			if (this.panelButtonCall)
			{
				BX.bind(this.panelButtonCall, "click", BX.delegate(this.webrtc.openKeyPad, this.webrtc));
			}
			BX.bind(window, 'scroll', BX.delegate(function(){
				if (this.webrtc.popupKeyPad)
					this.webrtc.popupKeyPad.close();
			}, this));
		}

		if (this.panelDragLabel)
		{
			BX.bind(this.panelDragLabel, "mousedown", BX.proxy(this._startDrag, this));
			BX.bind(this.panelDragLabel, "dobleclick", BX.proxy(this._stopDrag, this));
		}

		this.updateNotifyMailCount();

		if (!BX.MessengerCommon.isPage())
		{
			this.adjustPosition({resize: true});
			BX.bind(window, "resize", BX.proxy(function(){
				this.closePopup();
				this.adjustPosition({resize: true});
			}, this));
			if (!BX.browser.IsDoctype())
				BX.bind(window, "scroll", BX.proxy(function(){ this.adjustPosition({scroll: true});}, this));
		}

		setTimeout(BX.delegate(function(){
			this.newNotify();
			this.updateNotifyCounters();
			this.updateNotifyCount();
		}, this), 500);
	}

	BX.addCustomEvent(window, "onSonetLogCounterClear", BX.proxy(function(counter){
		var sendObject = {};
		sendObject[counter] = 0;
		this.updateNotifyCounters(sendObject);
	}, this));
};

BX.MessengerNotify.prototype.getCounter = function(type)
{
	if (typeof(type) != 'string')
		return false;

	type = type.toString();

	if (type == 'im_notify')
		return this.notifyCount;
	if (type == 'im_message')
		return this.BXIM.messageCount;

	return this.counters[type]? this.counters[type]: 0;
};

BX.MessengerNotify.prototype.updateNotifyCounters = function(arCounter, send)
{
	send = send != false;
	if (typeof(arCounter) == "object")
	{
		for (var i in arCounter)
			this.counters[i] = arCounter[i];
	}
	BX.onCustomEvent(window, 'onImUpdateCounter', [this.counters]);
	if (send)
		BX.localStorage.set('nuc', this.counters, 5);
};

BX.MessengerNotify.prototype.updateNotifyMailCount = function(count, send)
{
	send = send != false;

	if (typeof(count) != "undefined" || parseInt(count)>0)
		this.mailCount = parseInt(count);

	var mailCountLabel = '';
	if (this.mailCount > 99)
		mailCountLabel = '99+';
	else if (this.mailCount > 0)
		mailCountLabel = this.mailCount;

	if (this.panelButtonMail)
	{
		if (this.mailCount > 0)
			BX.removeClass(this.panelButtonMail, 'bx-notifier-hide');
		else
			BX.addClass(this.panelButtonMail, 'bx-notifier-hide');

		if (this.panelButtonMailCount != null)
		{
			this.panelButtonMailCount.innerHTML = mailCountLabel;
			this.adjustPosition({"resize": true, "timeout": 500});
		}
	}

	BX.onCustomEvent(window, 'onImUpdateCounterMail', [this.mailCount, 'MAIL']);

	if (send)
		BX.localStorage.set('numc', this.mailCount, 5);
};

BX.MessengerNotify.prototype.updateNotifyCount = function(send)
{
	send = send != false;

	var count = 0;
	var updateCount = 0;

	if (this.unreadNotifyLoad)
		count = this.initNotifyCount;

	for (var i in this.unreadNotify)
	{
		if (this.unreadNotify[i] == null)
			continue;

		var notify = this.notify[this.unreadNotify[i]];
		if (!notify)
			continue;

		if (notify.type != 1)
			updateCount++;

		count++;
	}

	var notifyCountLabel = '';
	if (count > 99)
		notifyCountLabel = '99+';
	else if (count > 0)
		notifyCountLabel = count;

	if (this.panelButtonNotifyCount)
	{
		this.panelButtonNotifyCount.innerHTML = notifyCountLabel;
		this.adjustPosition({"resize": true, "timeout": 500});
	}

	if (this.messengerNotifyButtonCount)
		this.messengerNotifyButtonCount.innerHTML = parseInt(notifyCountLabel)>0? '<span class="bx-messenger-cl-count-digit">'+notifyCountLabel+'</span>':'';

	if (BX.MessengerCommon.isPage())
	{
		BX.MessengerWindow.setTabBadge('notify', count)
	}

	this.notifyCount = parseInt(count);
	this.notifyUpdateCount = parseInt(updateCount);

	BX.onCustomEvent(window, 'onImUpdateCounterNotify', [this.notifyCount, 'NOTIFY']);

	if (send)
		BX.localStorage.set('nunc', {'unread': this.unreadNotify, 'flash': this.flashNotify}, 5);
};

BX.MessengerNotify.prototype.changeUnreadNotify = function(unreadNotify, send)
{
	send = send != false;
	var redraw = false;
	for (var i in unreadNotify)
	{
		if (!this.BXIM.xmppStatus && this.BXIM.settings.status != 'dnd')
			this.flashNotify[unreadNotify[i]] = true;
		else
			this.flashNotify[unreadNotify[i]] = false;

		this.unreadNotify[unreadNotify[i]] = unreadNotify[i];
		redraw = true;
	}
	this.newNotify(send);

	if (redraw && this.BXIM.notifyOpen)
		this.openNotify(true);

	this.updateNotifyCount(send);
};

BX.MessengerNotify.prototype.viewNotify = function(id, read, send)
{
	if (parseInt(id) <= 0)
		return false;

	read = read === false? false: true;
	send = send === false? false: true;

	var notify = this.notify[id];
	if (notify && notify.type != 1)
	{
		if (read)
		{
			delete this.unreadNotify[id];
		}
		else
		{
			this.unreadNotify[id] = id;
		}
	}

	delete this.flashNotify[id];

	BX.localStorage.set('mfn', this.flashNotify, 80);

	if (send)
	{
		BX.ajax({
			url: this.BXIM.pathToAjax+'?NOTIFY_VIEW&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 60,
			data: {'IM_NOTIFY_VIEW' : 'Y', 'ID' : parseInt(id), 'READ': (read? 'Y':'N'), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
		});
	}

	if (this.BXIM.notifyOpen)
	{
		var notify = BX.findChildByClassName(document.body, "bx-notifier-item-"+id);
		if (read)
		{
			BX.removeClass(notify, 'bx-notifier-item-new');
		}
		else
		{
			BX.addClass(notify, 'bx-notifier-item-new');
		}
	}

	this.updateNotifyCount(false);

	return true;
};

BX.MessengerNotify.prototype.viewNotifyMarkupUpdate = function()
{
	if (this.BXIM.notifyOpen)
	{
		var elements = BX.findChildrenByClassName(this.popupNotifyItem, "bx-notifier-item-new", false);
		if (elements != null)
		{
			for (var i = 0; i < elements.length; i++)
			{
				if (elements[i].getAttribute('data-notifyType') == 1)
				{
					continue;
				}
				if (!this.unreadNotify[elements[i].getAttribute('data-notifyId')])
				{
					BX.removeClass(elements[i], 'bx-notifier-item-new');
				}
			}
		}
		for (var i in this.unreadNotify)
		{
			var element = BX.findChildByClassName(this.popupNotifyItem, "bx-notifier-item-"+i, false);
			if (element != null)
			{
				BX.addClass(element, 'bx-notifier-item-new');
			}
		}
	}
}

BX.MessengerNotify.prototype.viewNotifyAll = function(send)
{
	send = send !== false;
	if (this.BXIM.settings.notifyAutoRead)
	{
		var id = null;
		for (var i in this.unreadNotify)
		{
			if (this.notify[i] && this.notify[i].type != 1)
			{
				delete this.unreadNotify[i];
				if (id === null || id > i)
				{
					id = i;
				}
			}

			delete this.flashNotify[i];
		}
		if (!id)
		{
			return false;
		}

		if (send)
		{
			BX.ajax({
				url: this.BXIM.pathToAjax+'?NOTIFY_READ&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 60,
				data: {'IM_NOTIFY_READ' : 'Y', 'ID' : id, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
			});
		}

		setTimeout(this.viewNotifyMarkupUpdate, 500);

		this.updateNotifyCount(false);
	}
	else
	{
		for (var i in this.unreadNotify)
		{
			delete this.flashNotify[i];
		}
	}

	BX.localStorage.set('mfn', this.flashNotify, 80);

	return true;
};

BX.MessengerNotify.prototype.newNotify = function(send)
{
	send = send != false;

	var arNotify = [];
	var arNotifyText = [];
	var arNotifySort = [];
	for (var i in this.flashNotify)
	{
		if (this.flashNotify[i] === true)
		{
			arNotifySort.push(parseInt(i));
			this.flashNotify[i] = false;
		}
	}
	var flashNames = {};
	arNotifySort.sort(BX.delegate(function(a, b) {if (!this.notify[a] || !this.notify[b]){return 0;}var i1 = this.notify[a].date.getTime(); var i2 = this.notify[b].date.getTime();var t1 = parseInt(this.notify[a].type); var t2 = parseInt(this.notify[b].type);if (t1 == 1 && t2 != 1) { return -1;}else if (t2 == 1 && t1 != 1) { return 1;}else if (i2 > i1) { return 1; }else if (i2 < i1) { return -1;}else{ return 0;}}, this));
	for (var i = 0; i < arNotifySort.length; i++)
	{
		var notify = BX.clone(this.notify[arNotifySort[i]]);
		if (notify && notify.userId && notify.userName)
			flashNames[notify.userId] = notify.userName;

		notify.text = notify.text.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, function (whole, imol, chatId, text)
		{
			return text;
		});

		notify = this.createNotify(notify, true);
		if (notify !== false)
		{
			arNotify.push(notify);

			notify = this.notify[arNotifySort[i]];
			arNotifyText.push({
				'title':  notify.userName? BX.util.htmlspecialcharsback(notify.userName): BX.message('IM_NOTIFY_WINDOW_NEW_TITLE'),
				'text':  BX.util.htmlspecialcharsback(notify.text).split('<br />').join("\n").replace(/<\/?[^>]+>/gi, ''),
				'icon':  notify.userAvatar? notify.userAvatar: '',
				'tag':  'im-notify-'+notify.tag
			});
		}
	}
	if (arNotify.length > 5)
	{
		var names = '';
		for (var i in flashNames)
			names += ', <i>'+flashNames[i]+'</i>';

		var notify = {
			id: 0, type: 4,date: new Date(), tag: '', originalTag: '',
			title: BX.message('IM_NM_NOTIFY_1').replace('#COUNT#', arNotify.length),
			text: names.length>0? BX.message('IM_NM_NOTIFY_2').replace('#USERS#', names.substr(2)): BX.message('IM_NM_NOTIFY_3')
		};
		notify = this.createNotify(notify, true);
		BX.style(notify, 'cursor', 'pointer');
		arNotify = [notify];

		arNotifyText = [{
			'id': '',
			'title':  BX.message('IM_NM_NOTIFY_1').replace('#COUNT#', arNotify.length),
			'text': names.length>0? BX.message('IM_NM_NOTIFY_2').replace('#USERS#', BX.util.htmlspecialcharsback(names.substr(2))).replace(/<\/?[^>]+>/gi, ''): BX.message('IM_NM_NOTIFY_3')
		}];
	}
	if (arNotify.length == 0)
		return false;

	if (BX.MessengerCommon.isDesktop())
		BX.desktop.flashIcon(false);

	this.closePopup();

	if (this.BXIM.context == "LINES" || this.BXIM.context == "DIALOG")
	{
		return false;
	}

	if (
		this.BXIM.settings.status == 'dnd'
		|| BX.MessengerCommon.isSlider()
		|| !BX.MessengerCommon.isDesktop()
		&& this.BXIM.desktopStatus
	)
	{
		return false;
	}


	if (send && !this.BXIM.xmppStatus)
		this.BXIM.playSound("reminder");

	if (send && BX.MessengerCommon.isDesktop())
	{
		for (var i = 0; i < arNotify.length; i++)
		{
			var dataNotifyId = arNotify[i].getAttribute("data-notifyId");
			var messsageJs =
				'var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+
				'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ if (this.getAttribute("data-notifyType") != 1) { BX.desktop.onCustomEvent("main", "bxImClickCloseNotify", [this.getAttribute("data-notifyId")]); } BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+
				(arNotify[i].id>0? '': 'BX.bind(notify, "click", function(event){ BX.desktop.onCustomEvent("main", "bxImClickNotify", []); BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });')+
				'BX.bindDelegate(notify, "click", {className: "bx-notifier-item-button"}, BX.delegate(function(){ '+
					'BX.desktop.windowCommand("freeze");'+
					'notifyId = BX.proxy_context.getAttribute("data-id");'+
					'BXIM.notify.confirmRequest({'+
						'"notifyId": notifyId,'+
						'"notifyValue": BX.proxy_context.getAttribute("data-value"),'+
						'"notifyURL": BX.proxy_context.getAttribute("data-url"),'+
						'"notifyTag": BXIM.notify.notify[notifyId] && BXIM.notify.notify[notifyId].tag? BXIM.notify.notify[notifyId].tag: null,'+
						'"groupDelete": BX.proxy_context.getAttribute("data-group") == null? false: true,'+
					'}, true);'+
					'BX.desktop.onCustomEvent("main", "bxImClickConfirmNotify", [notifyId]); '+
				'}, BXIM.notify));'+
				'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';
			this.desktop.openNewNotify(dataNotifyId, arNotify[i], messsageJs);
		}
	}
	else if(send && !this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
	{
		for (var i = 0; i < arNotifyText.length; i++)
		{
			var notify = arNotifyText[i];
			notify.onshow = function() {
				var notify = this;
				setTimeout(function(){
					notify.close();
				}, 5000)
			}
			notify.onclick = function() {
				window.focus();
				top.BXIM.openNotify();
				this.close();
			}
			this.BXIM.notifyManager.nativeNotify(notify)
		}
	}
	else
	{
		if (this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
		{
			BX.localStorage.set('mnnb', true, 1);
		}
		for (var i = 0; i < arNotify.length; i++)
		{
			this.BXIM.notifyManager.add({
				'html': arNotify[i],
				'tag': arNotify[i].id>0? 'im-notify-'+this.notify[arNotify[i].getAttribute("data-notifyId")].tag:'',
				'originalTag': arNotify[i].id>0? this.notify[arNotify[i].getAttribute("data-notifyId")].originalTag:'',
				'notifyId': arNotify[i].getAttribute("data-notifyId"),
				'notifyType': arNotify[i].getAttribute("data-notifyType"),
				'click': arNotify[i].id > 0? null: BX.delegate(function(popup) {
					this.BXIM.openNotify();
					popup.close();
				}, this),
				'close': BX.delegate(function(popup) {
					if (popup.notifyParams.notifyType != 1 && popup.notifyParams.notifyId)
						this.viewNotify(popup.notifyParams.notifyId);
				}, this)
			});
		}
	}
	return true;
};

BX.MessengerNotify.prototype.confirmRequest = function(params, popup)
{
	if (this.confirmDisabledButtons)
		return false;

	popup = popup == true;

	params.notifyOriginTag = this.notify[params.notifyId]? this.notify[params.notifyId].originalTag: '';

	if (BX.MessengerCommon.isMobile())
	{
		if (params.groupDelete && params.notifyTag != null)
		{
			for (var i in this.notify)
			{
				if (this.notify[i].tag == params.notifyTag)
					delete this.notify[i];
			}
		}
		else
		{
			delete this.notify[params.notifyId];
		}
	}
	this.updateNotifyCount();

	if (popup && BX.MessengerCommon.isDesktop())
		BX.desktop.windowCommand("freeze");
	else
		BX.hide(BX.proxy_context.parentNode.parentNode.parentNode);

	BX.ajax({
		url: this.BXIM.pathToAjax+'?NOTIFY_CONFIRM&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_NOTIFY_CONFIRM' : 'Y', 'NOTIFY_ID' : params.notifyId, 'NOTIFY_VALUE' : params.notifyValue, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			if (params.notifyURL != null)
			{
				if (popup && BX.MessengerCommon.isDesktop())
					BX.desktop.browse(params.notifyURL);
				else
					location.href = params.notifyURL;

				this.confirmDisabledButtons = true;
			}
			if (!BX.MessengerCommon.isMobile() && this.notify[params.notifyId] && data.MESSAGES)
			{
				this.notify[params.notifyId].confirmMessages = data.MESSAGES;
			}
			BX.onCustomEvent(window, 'onImConfirmNotify', [{'NOTIFY_ID' : params.notifyId, 'NOTIFY_TAG' : params.notifyOriginTag, 'NOTIFY_VALUE' : params.notifyValue, 'NOTIFY_MESSAGES': data.MESSAGES}]);
			if (popup && BX.MessengerCommon.isDesktop())
				BX.desktop.windowCommand("close");
		}, this),
		onfailure: BX.delegate(function() {
			if (popup && BX.MessengerCommon.isDesktop())
				BX.desktop.windowCommand("close");
		}, this)
	});

	if (params.groupDelete)
		BX.localStorage.set('nrgn', params.notifyTag, 5);
	else
		BX.localStorage.set('nrn', params.notifyId, 5);

	return false;
};

BX.MessengerNotify.prototype.drawNotify = function(arItemsNotify, loadMore)
{
	loadMore = loadMore == true;
	var itemsNotify = typeof(arItemsNotify) == 'object'? arItemsNotify: BX.clone(this.notify);

	var arGroupedNotify = {};
	var arGroupedNotifyByUser = {};
	for (var i in itemsNotify)
	{
		if (!itemsNotify.hasOwnProperty(i))
		{
			continue;
		}
		if (
			itemsNotify[i].tag != '' &&
			(!itemsNotify[i].params || itemsNotify[i].params.CAN_ANSWER != 'Y')
		)
		{
			if (!arGroupedNotifyByUser[itemsNotify[i].tag] || !arGroupedNotifyByUser[itemsNotify[i].tag][itemsNotify[i].userId])
			{
				if (arGroupedNotifyByUser[itemsNotify[i].tag])
				{
					if (!arGroupedNotifyByUser[itemsNotify[i].tag][itemsNotify[i].userId])
						arGroupedNotifyByUser[itemsNotify[i].tag][itemsNotify[i].userId] = itemsNotify[i].id;

					if (parseInt(arGroupedNotify[itemsNotify[i].tag].date) <= parseInt(itemsNotify[i].date))
					{
						itemsNotify[i].groupped = true;
						delete itemsNotify[arGroupedNotify[itemsNotify[i].tag].id];
						arGroupedNotify[itemsNotify[i].tag] = itemsNotify[i];
					}
					else
					{
						itemsNotify[arGroupedNotify[itemsNotify[i].tag].id].groupped = true;
						delete itemsNotify[i];
					}
				}
				else
				{
					arGroupedNotifyByUser[itemsNotify[i].tag] = {};
					arGroupedNotifyByUser[itemsNotify[i].tag][itemsNotify[i].userId] = itemsNotify[i].id;
					arGroupedNotify[itemsNotify[i].tag] = itemsNotify[i];
				}
			}
			else
			{
				if (parseInt(arGroupedNotify[itemsNotify[i].tag].date) <= parseInt(itemsNotify[i].date))
				{
					itemsNotify[i].groupped = true;
					delete itemsNotify[arGroupedNotify[itemsNotify[i].tag].id];
					arGroupedNotify[itemsNotify[i].tag] = itemsNotify[i];
				}
				else
				{
					itemsNotify[arGroupedNotify[itemsNotify[i].tag].id].groupped = true;
					delete itemsNotify[i];
				}
			}
		}
	}

	var arNotify = [];
	var arNotifySort = [];
	for (var i in itemsNotify)
	{
		if (!itemsNotify.hasOwnProperty(i))
		{
			continue;
		}
		arNotifySort.push(parseInt(i));
	}

	arNotifySort.sort(function(a, b) {
		if (!itemsNotify[a] || !itemsNotify[b]){return 0;}
		var i1 = itemsNotify[a].date.getTime();
		var i2 = itemsNotify[b].date.getTime();
		var t1 = typeof(itemsNotify[a].confirmMessages) == 'undefined'? parseInt(itemsNotify[a].type): 2;
		var t2 = typeof(itemsNotify[b].confirmMessages) == 'undefined'? parseInt(itemsNotify[b].type): 2;
		if (t1 == 1 && t2 != 1) { return -1;}
		else if (t2 == 1 && t1 != 1) { return 1;}
		else if (i2 > i1) { return 1; }
		else if (i2 < i1) { return -1;}
		else{ return 0;}
	});
	for (var i = 0; i < arNotifySort.length; i++)
	{
		var notify = itemsNotify[arNotifySort[i]];
		if (!notify)
		{
			continue;
		}
		if (notify.groupped)
		{
			notify.otherCount = 0;
			if (this.notify[notify.id])
			{
				this.notify[notify.id].otherItems = [];
				for (var userId in arGroupedNotifyByUser[notify.tag])
				{
					if (this.notify[notify.id].userId != userId)
						this.notify[notify.id].otherItems.push(arGroupedNotifyByUser[notify.tag][userId]);
				}
				notify.otherCount = this.notify[notify.id].otherItems.length;
			}
			if (notify.otherCount > 0 && notify.type == 2)
				notify.type = 3;
		}
		notify = this.createNotify(notify);
		if (notify !== false)
			arNotify.push(notify);
	}

	if (arNotify.length == 0)
	{
		if (this.messenger.popupMessengerConnectionStatusState != 'online')
		{
			arNotify.push(BX.create("div", { attrs : { style : "padding-top: 231px; margin-bottom: 45px;"}, props : { className : "bx-messenger-box-empty bx-notifier-content-empty", id : "bx-notifier-content-empty"}, html: BX.message('IM_NOTIFY_ERROR')}));
			arNotify.push(
				BX.create('a', { attrs : { href : "#notifyHistory", id : "bx-notifier-content-link-history"}, props : { className : "bx-notifier-content-link-history bx-notifier-content-link-history-empty" }, children: [
					BX.create('span', {props : { className : "bx-notifier-item-button bx-notifier-item-button-white" }, html: BX.message('IM_NOTIFY_HISTORY_2')})
				]})
			);
			this.notifyLoad = false;
		}
		else if (this.BXIM.settings.loadLastNotify && !this.notifyLoad || this.unreadNotifyLoad)
		{
			arNotify.push(BX.create("div", { attrs : { style : "padding-top: 162px;"}, props : { className: "bx-notifier-content-load", id : "bx-notifier-content-load"}, children : [
				BX.create("div", {props : { className: "bx-notifier-content-load-block bx-notifier-item"}, children : [
					BX.create('span', { props : { className : "bx-notifier-content-load-block-img" }}),
					BX.create('span', {props : { className : "bx-notifier-content-load-block-text"}, html: BX.message('IM_NOTIFY_LOAD_NOTIFY')})
				]})
			]}));
		}
		else if (!loadMore && !this.BXIM.settings.loadLastNotify)
		{
			arNotify.push(BX.create("div", { attrs : { style : "padding-top: 231px; margin-bottom: 45px;"}, props : { className : "bx-messenger-box-empty bx-notifier-content-empty", id : "bx-notifier-content-empty"}, html: BX.message('IM_NOTIFY_EMPTY_2')}));
			arNotify.push(
				BX.create('a', { attrs : { href : "#notifyHistory", id : "bx-notifier-content-link-history"}, props : { className : "bx-notifier-content-link-history bx-notifier-content-link-history-empty" }, children: [
					BX.create('span', {props : { className : "bx-notifier-item-button bx-notifier-item-button-white" }, html: BX.message('IM_NOTIFY_HISTORY')})
				]})
			);
		}
		else if (!loadMore)
		{
			arNotify.push(BX.create("div", { attrs : { style : "padding-top: 231px; margin-bottom: 45px;"}, props : { className : "bx-messenger-box-empty bx-notifier-content-empty", id : "bx-notifier-content-empty"}, html: BX.message('IM_NOTIFY_EMPTY_3')}));
			arNotify.push(BX.create('a', { attrs : { href : "#notifyHistory", id : "bx-notifier-content-link-history"}, props : { className : "bx-notifier-content-link-history bx-notifier-content-link-history-empty" }, children: [
				BX.create('span', {props : { className : "bx-notifier-item-button bx-notifier-item-button-white" }, html: BX.message('IM_NOTIFY_HISTORY_LATE')})
			]}));
		}
		if (this.BXIM.settings.loadLastNotify)
			return arNotify;
	}
	else if (!loadMore)
	{
		arNotify.push(
			BX.create('a', { attrs : { href : "#notifyHistory", id : "bx-notifier-content-link-history"}, props : { className : "bx-notifier-content-link-history bx-notifier-content-link-history-empty" }, children: [
				BX.create('span', {props : { className : "bx-notifier-item-button bx-notifier-item-button-white" }, html: BX.message('IM_NOTIFY_HISTORY_LATE')})
			]})
		);
	}

	return arNotify;
};

BX.MessengerNotify.prototype.openNotify = function(reOpen, force)
{
	reOpen = reOpen == true;
	force = force == true;

	if (this.messenger.popupMessenger == null)
	{
		this.messenger.openMessenger(false);
	}

	if (this.BXIM.notifyOpen && !force)
	{
		if (!reOpen)
		{
			this.messenger.extraClose(true);
			return false;
		}
	}
	else
	{
		this.BXIM.dialogOpen = false;
		this.BXIM.notifyOpen = true;
		if (!BX.MessengerCommon.isPage())
		{
			this.messengerNotifyButton.className = "bx-messenger-cl-notify-button bx-messenger-cl-notify-button-active";
		}
	}

	this.messenger.closeMenuPopup();

	var arNotify = this.drawNotify();
	this.notifyBody = BX.create("div", { props : { className : "bx-notifier-wrap" }, children : [
		BX.create("div", { props : { className : "bx-messenger-panel" }, children : [
			BX.create('span', { props : { className : "bx-messenger-panel-avatar bx-messenger-avatar-notify"}}),
			BX.create("span", { props : { className : "bx-messenger-panel-title bx-messenger-panel-title-middle"}, html: BX.message('IM_NOTIFY_WINDOW_TITLE')})
		]}),
		this.popupNotifyButtonFilterBox = BX.create("div", { props : { className : "bx-messenger-panel-filter-box" }, style : {display: 'none'}, children : [
			BX.create('div', {props : { className : "bx-messenger-filter-name" }, html: BX.message('IM_PANEL_FILTER_NAME')}),
			this.popupHistorySearchDateWrap = BX.create('div', {props : { className : "bx-messenger-filter-date bx-messenger-input-wrap bx-messenger-filter-date-notify" }, html: '<span class="bx-messenger-input-date"></span><a class="bx-messenger-input-close" href="#close"></a><input type="text" class="bx-messenger-input" value="" tabindex="1002" placeholder="'+BX.message('IM_PANEL_FILTER_DATE')+'" />'})
		]}),
		this.popupNotifyItem = BX.create("div", { props : { className : "bx-notifier-item-wrap" }, style : {height: this.popupNotifySize+'px'}, children : arNotify})
	]});
	this.messenger.extraOpen(this.notifyBody);

	/*
	clearTimeout(this.popupMessengerTopLineTimeout);
	this.popupMessengerTopLineTimeout = setTimeout(BX.delegate(function(){
		this.BXIM.notifyManager.nativeNotifyAccessForm();
	}, this), 10000);
	 */

	if (this.unreadNotifyLoad)
		this.loadNotify();
	else if (!this.notifyLoad && this.BXIM.settings.loadLastNotify)
		this.notifyHistory();

	if (!reOpen && this.BXIM.isFocus('notify') && this.notifyUpdateCount > 0)
		this.viewNotifyAll();

	BX.bind(this.popupNotifyItem, "scroll", BX.delegate(function() {
		if (this.messenger.popupPopupMenu != null)
		{
			if (BX.util.in_array(this.messenger.popupPopupMenu.uniquePopupId.replace('bx-messenger-popup-', ''), ["copypaste", "copylink", "notifyDelete", "notify", "external-data"]))
			{
				this.messenger.popupPopupMenu.close();
			}
		}
	}, this));

	BX.bind(BX('bx-notifier-content-link-history'), "click", BX.delegate(this.notifyHistory, this));

	BX.bind(this.popupNotifyItem, "click", BX.delegate(this.closePopup, this));

	BX.bind(this.notifyBody, "click",  BX.delegate(function(e){
		BX.MessengerCommon.contactListSearchClear(e);
	}, BX.MessengerCommon));

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-messenger-ajax'}, BX.delegate(function() {
		if (BX.proxy_context.getAttribute('data-entity') == 'user')
		{
			this.messenger.openPopupExternalData(BX.proxy_context, 'user', true, {'ID': BX.proxy_context.getAttribute('data-userId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'chat')
		{
			this.messenger.openPopupExternalData(BX.proxy_context, 'chat', true, {'ID': BX.proxy_context.getAttribute('data-chatId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'openlines')
		{
			this.messenger.linesOpenHistory(BX.proxy_context.getAttribute('data-sessionId'));
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'network')
		{
			this.messenger.openMessenger('network'+BX.proxy_context.getAttribute('data-networkId'))
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'date')
		{
			this.messenger.openPopupMenu(BX.proxy_context, 'shareMenu');
		}
	}, this));

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-item-help'}, BX.proxy(function(e) {
		if (this.popupNotifyMore != null)
			this.popupNotifyMore.destroy();
		else
		{
			var notifyHelp = this.notify[BX.proxy_context.getAttribute('data-help')];
			if (!notifyHelp.otherItems)
				return false;

			var htmlElement = '<span class="bx-notifier-item-help-popup">';
				for (var i = 0; i < notifyHelp.otherItems.length; i++)
				{
					var avatarColor = BX.MessengerCommon.isBlankAvatar(this.notify[notifyHelp.otherItems[i]].userAvatar)? 'style="background-color: '+this.notify[notifyHelp.otherItems[i]].userColor+'"': '';
					var user = BX.MessengerCommon.getUserParam(this.notify[notifyHelp.otherItems[i]].userId);
					htmlElement += '<a class="bx-notifier-item-help-popup-img" href="'+this.notify[notifyHelp.otherItems[i]].userLink+'"  onclick="BXIM.openMessenger('+this.notify[notifyHelp.otherItems[i]].userId+'); return false;" target="_blank">' +
						'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+user.status+'">' +
							'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.notify[notifyHelp.otherItems[i]].userAvatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+this.notify[notifyHelp.otherItems[i]].userAvatar+'" '+avatarColor+'>' +
						'</span>' +
						'<span class="bx-notifier-item-help-popup-name '+(user.extranet? ' bx-notifier-popup-avatar-extranet':'')+'">'+BX.MessengerCommon.prepareText(this.notify[notifyHelp.otherItems[i]].userName)+'</span>' +
					'</a>';
				}
			htmlElement += '</span>';

			this.popupNotifyMore = new BX.PopupWindow('bx-notifier-other-window', BX.proxy_context, {
				//parentPopup: this.messenger.popupMessenger,
				zIndex: 200,
				lightShadow : true,
				offsetTop: -2,
				offsetLeft: 3,
				autoHide: true,
				closeByEsc: true,
				bindOptions: {position: "top"},
				events : {
					onPopupClose : function() { this.destroy() },
					onPopupDestroy : BX.proxy(function() { this.popupNotifyMore = null; }, this)
				},
				content : BX.create("div", { props : { className : "bx-messenger-popup-menu" }, html: htmlElement})
			});
			this.popupNotifyMore.setAngle({});
			this.popupNotifyMore.show();
			BX.bind(this.popupNotifyMore.popupContainer, "click", BX.MessengerCommon.preventDefault);
		}

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-answer-reply'}, BX.proxy(function(e) {
		if (!BX.proxy_context) return;

		if (!this.toggleNotifyAnswer(BX.proxy_context.parentNode))
			return true;

		return BX.PreventDefault(e);
	}, this));

	var item = BX.findChildByClassName(this.popupNotifyItem, "bx-notifier-answer-box-open");
	if (item)
	{
		var itemInput = item.firstChild.nextSibling.firstChild;
		itemInput.focus();
		itemInput.selectionStart = itemInput.value.length+1;
		itemInput.selectionEnd = itemInput.value.length+1;
	}

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-answer-button'}, BX.proxy(function(e) {
		if (!BX.proxy_context) return;

		this.sendNotifyAnswer(BX.proxy_context.parentNode);

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-item-delete'}, BX.proxy(function(e) {
		if (!BX.proxy_context) return;

		BX.proxy_context.setAttribute('id', 'bx-notifier-item-delete-'+BX.proxy_context.getAttribute('data-notifyId'));
		this.deleteNotify(BX.proxy_context.getAttribute('data-notifyId'));

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-item-button-confirm'}, BX.proxy(function(e) {
		if (this.messenger.popupMessengerConnectionStatusState != 'online')
			return false;

		var notifyId = BX.proxy_context.getAttribute('data-id');
		this.confirmRequest({
			'notifyId': notifyId,
			'notifyValue': BX.proxy_context.getAttribute('data-value'),
			'notifyURL': BX.proxy_context.getAttribute('data-url'),
			'notifyTag': this.notify[notifyId] && this.notify[notifyId].tag? this.notify[notifyId].tag: null,
			'groupDelete': BX.proxy_context.getAttribute('data-group') != null
		});
		this.openNotify(true);

		if (BX.MessengerCommon.isMobile())
		{
			if (BX.proxy_context.parentNode.parentNode.parentNode.previousSibling == null && BX.proxy_context.parentNode.parentNode.parentNode.nextSibling == null)
				this.openNotify(true);
			else if (BX.proxy_context.parentNode.parentNode.parentNode.previousSibling == null && BX.proxy_context.parentNode.parentNode.parentNode.nextSibling.tagName.toUpperCase() == 'A')
				this.openNotify(true);
			else
				BX.remove(BX.proxy_context.parentNode.parentNode.parentNode);
		}

		return BX.PreventDefault(e);
	}, this));

	if (BX.MessengerCommon.isDesktop())
	{
		BX.bindDelegate(this.popupNotifyItem, 'contextmenu', {className: 'bx-notifier-item-content'}, BX.delegate(function(e) {
			if (!BX.proxy_context) return;

			BX.proxy_context.parentNode.setAttribute('id', 'bx-notifier-item-delete-'+BX.proxy_context.parentNode.getAttribute('data-notifyId'));
			this.messenger.openPopupMenu(e, 'notify', false);

			return BX.PreventDefault(e);
		}, this));
	}
	else
	{
		BX.bindDelegate(this.popupNotifyItem, 'contextmenu', {className: 'bx-notifier-item-delete'}, BX.proxy(function(e) {
			if (!BX.proxy_context) return;

			BX.proxy_context.setAttribute('id', 'bx-notifier-item-delete-'+BX.proxy_context.getAttribute('data-notifyId'));
			this.messenger.openPopupMenu(BX.proxy_context, 'notifyDelete');

			return BX.PreventDefault(e);
		}, this));
	}

	BX.bindDelegate(this.popupNotifyItem, 'dblclick', {className: 'bx-notifier-item'}, BX.delegate(function(e) {
		if (!BX.proxy_context) return;

		var notifyId = BX.proxy_context.getAttribute('data-notifyId');
		if (this.unreadNotify[notifyId])
		{
			this.viewNotify(notifyId, true);
		}
		else
		{
			this.viewNotify(notifyId, false);
		}

		return BX.PreventDefault(e);
	}, this));

	if (false && !this.BXIM.settings.notifyAutoRead) // TODO read after click
	{
		BX.bindDelegate(this.popupNotifyItem, 'click', {className: 'bx-notifier-item-text-link'}, BX.delegate(function(e) {
			var notifyId = BX.proxy_context.parentNode.parentNode.parentNode.getAttribute('data-notifyId');
			if (this.unreadNotify[notifyId])
			{
				this.viewNotify(notifyId, true);
			}
		}, this));
	}

	return false;
};


BX.MessengerNotify.prototype.deleteNotify = function(notifyId)
{
	var notifyDiv = BX('bx-notifier-item-delete-'+notifyId);
	var sendRequest = false;

	if (this.notify[notifyId])
	{
		sendRequest = true;
		var notifyTag = null;
		if (this.notify[notifyId].tag)
		{
			notifyTag = this.notify[notifyId].tag;
		}

		if (this.notify[notifyId].type == 1)
		{
			sendRequest = false;
		}

		var groupDelete = !(!notifyDiv || notifyDiv.getAttribute('data-group') == null || notifyTag == null);
		if (groupDelete)
		{
			for (var i in this.notify)
			{
				if (this.notify[i].tag == notifyTag)
					delete this.notify[i];
			}
		}
		else
		{
			delete this.notify[notifyId];
		}
	}
	this.updateNotifyCount();

	if (sendRequest)
	{
		this.skipMassDelete = true;
		var DATA = {};
		if (groupDelete)
			DATA = {'IM_NOTIFY_GROUP_REMOVE' : 'Y', 'NOTIFY_ID' : notifyId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()};
		else
			DATA = {'IM_NOTIFY_REMOVE' : 'Y', 'NOTIFY_ID' : notifyId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()};

		BX.ajax({
			url: this.BXIM.pathToAjax+'?NOTIFY_REMOVE&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: DATA,
			onsuccess: BX.delegate(function(data) {
				setTimeout(BX.delegate(function() {
					this.skipMassDelete = false;
				}, this), 2000);
			}, this)
		});

		if (groupDelete)
			BX.localStorage.set('nrgn', notifyTag, 5);
		else
			BX.localStorage.set('nrn', notifyId, 5);
	}

	if (notifyDiv.parentNode.parentNode.previousSibling == null && notifyDiv.parentNode.parentNode.nextSibling == null)
	{
		this.openNotify(true);
	}
	else if (notifyDiv.parentNode.parentNode.previousSibling == null && notifyDiv.parentNode.parentNode.nextSibling.tagName.toUpperCase() == 'A')
	{
		this.notifyLoad = false;
		this.notifyHistoryPage = 0;
		this.openNotify(true);
	}
	else
	{
		BX.remove(notifyDiv.parentNode.parentNode);
	}

	return true;
};

BX.MessengerNotify.prototype.blockNotifyType = function(settingName)
{
	var blockResult = typeof(this.BXIM.settingsNotifyBlocked[settingName]) == 'undefined';
	BX.ajax({
		url: this.BXIM.pathToAjax+'?NOTIFY_BLOCK_TYPE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_NOTIFY_BLOCK_TYPE' : 'Y', 'BLOCK_TYPE' : settingName, 'BLOCK_RESULT' : (blockResult? 'Y': 'N'), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
	});

	if (blockResult)
	{
		this.BXIM.settingsNotifyBlocked[settingName] = true;
		this.BXIM.settings['site|'.settingName] = false;
		this.BXIM.settings['xmpp|'.settingName] = false;
		this.BXIM.settings['email|'.settingName] = false;
	}
	else
	{
		delete this.BXIM.settingsNotifyBlocked[settingName];
		this.BXIM.settings['site|'.settingName] = true;
		this.BXIM.settings['xmpp|'.settingName] = true;
		this.BXIM.settings['email|'.settingName] = true;
	}

	return true;
};

BX.MessengerNotify.prototype.closeNotify = function()
{
	if (!BX.MessengerCommon.isPage())
	{
		this.messengerNotifyButton.className = "bx-messenger-cl-notify-button";
	}

	this.BXIM.notifyOpen = false;
	this.popupNotifyItem = null;
	BX.unbindAll(this.popupNotifyButtonFilter);
	BX.unbindAll(this.popupNotifyItem);
};

BX.MessengerNotify.prototype.loadNotify = function(send)
{
	if (this.loadNotityBlock)
		return false;

	send = send != false;
	this.loadNotityBlock = true;
	BX.ajax({
		url: this.BXIM.pathToAjax+'?NOTIFY_LOAD&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		lsId: 'IM_NOTIFY_LOAD',
		lsTimeout: 5,
		timeout: 30,
		data: {'IM_NOTIFY_LOAD' : 'Y', 'IM_AUTO_READ' : (this.BXIM.settings.notifyAutoRead? 'Y': 'N'), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			this.loadNotityBlock = false;
			this.unreadNotifyLoad = false;
			this.notifyLoad = true;
			var arNotify = {};

			if (typeof(data.NOTIFY) == 'object')
			{
				for (var i in data.NOTIFY)
				{
					data.NOTIFY[i].date = new Date(data.NOTIFY[i].date);
					arNotify[i] = this.notify[i] = data.NOTIFY[i];
					this.BXIM.lastRecordId = parseInt(i) > this.BXIM.lastRecordId? parseInt(i): this.BXIM.lastRecordId;

					if (this.BXIM.settings.notifyAutoRead)
					{
						if (data.NOTIFY[i].type != '1')
						{
							delete this.unreadNotify[i];
						}
						else
						{
							this.unreadNotify[i] = i
						}
					}
					else
					{
						this.unreadNotify[i] = i;
					}
				}
			}
			if (send)
			{
				this.openNotify(true);
				if (this.BXIM.settings.loadLastNotify)
					this.notifyHistory();

				BX.localStorage.set('nln', true, 5);
			}

			this.updateNotifyCount();

		}, this),
		onfailure: BX.delegate(function() {
			this.loadNotityBlock = false;
		}, this)
	});
};

BX.MessengerNotify.prototype.notifyHistory = function(event)
{
	event = event || window.event;
	if (this.notifyHistoryLoad)
		return false;

	if (this.messenger && this.messenger.popupMessengerConnectionStatusState != 'online')
		return false;

	if (BX('bx-notifier-content-link-history'))
	{
		BX('bx-notifier-content-link-history').innerHTML = '<span class="bx-notifier-item-button bx-notifier-item-button-white">'+BX.message('IM_NOTIFY_LOAD_NOTIFY')+'...'+'</span>';
	}

	this.notifyHistoryLoad = true;
	BX.ajax({
		url: this.BXIM.pathToAjax+'?NOTIFY_HISTORY_LOAD_MORE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_NOTIFY_HISTORY_LOAD_MORE' : 'Y', 'PAGE' : !this.BXIM.settings.loadLastNotify && this.notifyHistoryPage == 0? 1: this.notifyHistoryPage, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data)
		{
			if (data && data.BITRIX_SESSID)
			{
				BX.message({'bitrix_sessid': data.BITRIX_SESSID});
			}
			if (data.ERROR == '')
			{
				this.notifyLoad = true;
				BX.remove(BX('bx-notifier-content-load'));

				this.sendAjaxTry = 0;
				var arNotify = {};
				var count = 0;
				if (typeof(data.NOTIFY) == 'object')
				{
					for (var i in data.NOTIFY)
					{
						data.NOTIFY[i].date = new Date(data.NOTIFY[i].date);
						if (!this.notify[i])
							arNotify[i] = data.NOTIFY[i];

						if (!this.notify[i])
						{
							this.notify[i] = BX.clone(data.NOTIFY[i]);
						}
						count++;
					}
				}
				if (this.popupNotifyItem)
				{
					if (BX('bx-notifier-content-link-history'))
						BX.remove(BX('bx-notifier-content-link-history'));

					if (count > 0)
					{
						if (BX('bx-notifier-content-empty'))
							BX.remove(BX('bx-notifier-content-empty'));

						var arNotify = this.drawNotify(arNotify, true);
						for (var i = 0; i < arNotify.length; i++)
						{
							this.popupNotifyItem.appendChild(arNotify[i]);
						}
						if (count < 20 && this.notifyHistoryPage > 0)
						{
							BX.remove(BX('bx-notifier-content-link-history'));
						}
						else
						{
							this.popupNotifyItem.appendChild(
								BX.create('a', {
									attrs : {href : "#notifyHistory", id : "bx-notifier-content-link-history"},
									events : {'click' : BX.delegate(this.notifyHistory, this)},
									props : {className : "bx-notifier-content-link-history"},
									children : [
										BX.create('span', {
											props : {className : "bx-notifier-item-button bx-notifier-item-button-white"},
											html : BX.message('IM_NOTIFY_HISTORY_LATE')
										})
									]
								})
							);
							if (count >= 20 && this.notifyHistoryPage == 0)
								this.notifyHistoryPage = 1;
						}
					}
					else if (count <= 0 && this.notifyHistoryPage == 0)
					{
						if (BX('bx-notifier-content-link-history'))
							BX.remove(BX('bx-notifier-content-link-history'));
						this.popupNotifyItem.innerHTML = '';
						this.popupNotifyItem.appendChild(BX.create("div", {
							attrs : {style : "padding-top: 210px; margin-bottom: 20px;"},
							props : {
								className : "bx-messenger-box-empty bx-notifier-content-empty",
								id : "bx-notifier-content-empty"
							},
							html : BX.message('IM_NOTIFY_EMPTY_3')
						}));
						this.popupNotifyItem.appendChild(
							BX.create('a', {
								attrs : {href : "#notifyHistory", id : "bx-notifier-content-link-history"},
								events : {'click' : BX.delegate(this.notifyHistory, this)},
								props : {className : "bx-notifier-content-link-history bx-notifier-content-link-history-empty"},
								children : [
									BX.create('span', {
										props : {className : "bx-notifier-item-button bx-notifier-item-button-white"},
										html : BX.message('IM_NOTIFY_HISTORY_LATE')
									})
								]
							})
						);
					}
					else
					{
						if (this.popupNotifyItem.innerHTML == '')
						{
							this.popupNotifyItem.appendChild(BX.create("div", {
								attrs : {style : "padding-top: 210px; margin-bottom: 20px;"},
								props : {
									className : "bx-messenger-box-empty bx-notifier-content-empty",
									id : "bx-notifier-content-empty"
								},
								html : BX.message('IM_NOTIFY_EMPTY_3')
							}));
						}
					}
				}
				this.notifyHistoryLoad = false;
				this.notifyHistoryPage++;
			}
			else
			{
				if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry < 2)
				{
					this.sendAjaxTry++;
					BX.message({'bitrix_sessid': data.BITRIX_SESSID});
					setTimeout(BX.delegate(function(){
						this.notifyHistoryLoad = false;
						this.notifyHistory();
					}, this), 2000);
					BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
				}
				else if (data.ERROR == 'AUTHORIZE_ERROR')
				{
					this.sendAjaxTry++;
					if (BX.MessengerCommon.isDesktop())
					{
						setTimeout(BX.delegate(function (){
							this.notifyHistoryLoad = false;
							this.notifyHistory();
						}, this), 10000);
					}
					BX.onCustomEvent(window, 'onImError', [data.ERROR]);
				}
			}
		}, this),
		onfailure: BX.delegate(function(){
			this.notifyHistoryLoad = false;
			this.sendAjaxTry = 0;
		}, this)
	});

	if (event)
		return BX.PreventDefault(event);
	else
		return true;
};

BX.MessengerNotify.prototype.adjustPosition = function(params)
{
	if (BX.MessengerCommon.isDesktop())
		return false;

	params = params || {};
	params.timeout = typeof(params.timeout) == "number"? parseInt(params.timeout): 0;

	clearTimeout(this.adjustPositionTimeout);
	this.adjustPositionTimeout = setTimeout(BX.delegate(function(){
		params.scroll = params.scroll || !BX.browser.IsDoctype();
		params.resize = params.resize || false;

		if (!this.windowScrollPos.scrollLeft)
			this.windowScrollPos = {scrollLeft : 0, scrollTop : 0};
		if (params.scroll)
			this.windowScrollPos = BX.GetWindowScrollPos();

		if (params.resize || !this.windowInnerSize.innerWidth)
		{
			this.windowInnerSize = BX.GetWindowInnerSize();

			if (this.BXIM.settings.panelPositionVertical == 'bottom' && typeof(window.scroll) == 'function' && !(BX.browser.IsAndroid() || BX.browser.IsIOS()))
			{
				if (typeof(window.scrollX) != 'undefined' && typeof(window.scrollY) != 'undefined')
				{
					var originalScrollLeft = window.scrollX;
					window.scroll(1, window.scrollY);
					this.windowInnerSize.innerHeight += window.scrollX == 1? -16: 0;
					window.scroll(originalScrollLeft, window.scrollY);
				}
				else
				{
					var scrollX = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft;
					var scrollY = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop;
					var originalScrollLeft = scrollX;
					window.scroll(1, scrollY);
					scrollX = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft;
					this.windowInnerSize.innerHeight += scrollX == 1? -16: 0;
					window.scroll(originalScrollLeft, scrollY);
				}
			}
		}

		if (params.scroll || params.resize)
		{
			if (this.BXIM.settings.panelPositionHorizontal == 'left')
				this.panel.style.left = (this.windowScrollPos.scrollLeft+25)+'px';
			else if (this.BXIM.settings.panelPositionHorizontal == 'center')
				this.panel.style.left = (this.windowScrollPos.scrollLeft+this.windowInnerSize.innerWidth-this.panel.offsetWidth)/2+'px';
			else if (this.BXIM.settings.panelPositionHorizontal == 'right')
				this.panel.style.left = (this.windowScrollPos.scrollLeft+this.windowInnerSize.innerWidth-this.panel.offsetWidth-35)+'px';

			if (this.BXIM.settings.panelPositionVertical == 'top')
			{
				this.panel.style.top = (this.windowScrollPos.scrollTop)+'px';
				if (BX.hasClass(this.panel, 'bx-notifier-panel-doc'))
					this.panel.className = 'bx-notifier-panel bx-notifier-panel-top bx-notifier-panel-doc';
				else
					this.panel.className = 'bx-notifier-panel bx-notifier-panel-top';
			}
			else if (this.BXIM.settings.panelPositionVertical == 'bottom')
			{
				if (BX.hasClass(this.panel, 'bx-notifier-panel-doc'))
					this.panel.className = 'bx-notifier-panel bx-notifier-panel-bottom bx-notifier-panel-doc';
				else
					this.panel.className = 'bx-notifier-panel bx-notifier-panel-bottom';

				this.panel.style.top = (this.windowScrollPos.scrollTop+this.windowInnerSize.innerHeight-this.panel.offsetHeight)+'px';
			}
		}
	},this), params.timeout);
};

BX.MessengerNotify.prototype.move = function(offsetX, offsetY)
{
	var left = parseInt(this.panel.style.left) + offsetX;
	var top = parseInt(this.panel.style.top) + offsetY;

	if (left < 0)
		left = 0;

	var scrollSize = BX.GetWindowScrollSize();
	var floatWidth = this.panel.offsetWidth;
	var floatHeight = this.panel.offsetHeight;

	if (left > (scrollSize.scrollWidth - floatWidth))
		left = scrollSize.scrollWidth - floatWidth;

	if (top > (scrollSize.scrollHeight - floatHeight))
		top = scrollSize.scrollHeight - floatHeight;

	if (top < 0)
		top = 0;

	this.panel.style.left = left + "px";
	this.panel.style.top = top + "px";
};

BX.MessengerNotify.prototype._startDrag = function(event)
{
	event = event || window.event;
	BX.fixEventPageXY(event);

	this.dragPageX = event.pageX;
	this.dragPageY = event.pageY;
	this.dragged = false;

	this.closePopup();

	BX.bind(document, "mousemove", BX.proxy(this._moveDrag, this));
	BX.bind(document, "mouseup", BX.proxy(this._stopDrag, this));

	if (document.body.setCapture)
		document.body.setCapture();

	document.body.ondrag = BX.False;
	document.body.onselectstart = BX.False;
	document.body.style.cursor = "move";
	document.body.style.MozUserSelect = "none";
	this.panel.style.MozUserSelect = "none";
	BX.addClass(this.panel, "bx-notifier-panel-drag-"+(this.BXIM.settings.panelPositionVertical == 'top'? 'top': 'bottom'));

	return BX.PreventDefault(event);
};

BX.MessengerNotify.prototype._moveDrag = function(event)
{
	event = event || window.event;
	BX.fixEventPageXY(event);

	if(this.dragPageX == event.pageX && this.dragPageY == event.pageY)
		return;

	this.move((event.pageX - this.dragPageX), (event.pageY - this.dragPageY));
	this.dragPageX = event.pageX;
	this.dragPageY = event.pageY;

	if (!this.dragged)
	{
		BX.onCustomEvent(this, "onPopupDragStart");
		this.dragged = true;
	}

	BX.onCustomEvent(this, "onPopupDrag");
};

BX.MessengerNotify.prototype._stopDrag = function(event)
{
	if(document.body.releaseCapture)
		document.body.releaseCapture();

	BX.unbind(document, "mousemove", BX.proxy(this._moveDrag, this));
	BX.unbind(document, "mouseup", BX.proxy(this._stopDrag, this));

	document.body.ondrag = null;
	document.body.onselectstart = null;
	document.body.style.cursor = "";
	document.body.style.MozUserSelect = "";
	this.panel.style.MozUserSelect = "";
	BX.removeClass(this.panel, "bx-notifier-panel-drag-"+(this.BXIM.settings.panelPositionVertical == 'top'? 'top': 'bottom'));
	BX.onCustomEvent(this, "onPopupDragEnd");

	var windowScrollPos = BX.GetWindowScrollPos();
	this.BXIM.settings.panelPositionVertical = (this.windowInnerSize.innerHeight/2 > (event.pageY - windowScrollPos.scrollTop||event.y))? 'top' : 'bottom';
	if (this.windowInnerSize.innerWidth/3 > (event.pageX- windowScrollPos.scrollLeft||event.x))
		this.BXIM.settings.panelPositionHorizontal = 'left';
	else if (this.windowInnerSize.innerWidth/3*2 < (event.pageX - windowScrollPos.scrollLeft||event.x))
		this.BXIM.settings.panelPositionHorizontal = 'right';
	else
		this.BXIM.settings.panelPositionHorizontal = 'center';

	this.BXIM.saveSettings({'panelPositionVertical': this.BXIM.settings.panelPositionVertical, 'panelPositionHorizontal': this.BXIM.settings.panelPositionHorizontal});

	BX.localStorage.set('npp', {v: this.BXIM.settings.panelPositionVertical, h: this.BXIM.settings.panelPositionHorizontal});

	this.adjustPosition({resize: true});

	this.dragged = false;

	return BX.PreventDefault(event);
};

BX.MessengerNotify.prototype.closePopup = function()
{
	if (this.popupNotifyMore != null)
		this.popupNotifyMore.destroy();
	if (this.messenger != null && this.messenger.popupPopupMenu != null)
		this.messenger.popupPopupMenu.destroy();
};

BX.MessengerNotify.prototype.createNotify = function(notify, popup)
{
	var element = false;
	if (!notify)
		return false;

	popup = popup == true;

	notify.text = notify.text.replace(/\[like\]/ig, '<span class="bx-smile bx-im-smile-like" title="'+BX.message('IM_MESSAGE_LIKE')+'"></span>');
	notify.text = notify.text.replace(/\[dislike\]/ig, '<span class="bx-smile bx-im-smile-dislike" title="'+BX.message('IM_MESSAGE_DISLIKE')+'"></span>');

	notify.text = notify.text.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, function(whole, userId, text)
	{
		var html = '';

		userId = parseInt(userId);
		if (userId > 0 && typeof(BXIM) != 'undefined')
			html = '<span class="bx-messenger-ajax '+(userId == BXIM.userId? 'bx-messenger-ajax-self': '')+'" data-entity="user" data-userId="'+userId+'">'+text+'</span>';
		else
			html = text;

		return html;
	});

	notify.text = notify.text.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, function(whole, openlines, chatId, text)
	{
		var html = '';

		chatId = parseInt(chatId);

		if (chatId > 0)
		{
			if (openlines)
			{
				html = '<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+chatId+'">'+text+'</span>';
			}
			else
			{
				html = '<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+chatId+'">'+text+'</span>';
			}
		}
		else
		{
			html = text;
		}

		return html;
	});

	notify.text = notify.text.replace(/\[RATING\=([1-5]{1})\]/ig, BX.delegate(function(whole, rating)
	{
		return BX.MessengerCommon.linesVoteHeadNodes(0, rating, false).outerHTML;
	}, this));

	if (BX.MessengerCommon.isDesktop() || this.BXIM.context == "FULLSCREEN" || this.BXIM.context == "PAGE")
	{
		notify.text = notify.text.replace(/<a(.*?)>(.*?)<\/a>/ig, BX.delegate(function(whole, aInner, text)
		{
			return '<a'+aInner.replace('target="_self"', 'target="_blank"')+' class="bx-notifier-item-text-link">'+text+'</a>';
		}, this));
	}

	var itemNew = (this.unreadNotify[notify.id] && !popup? " bx-notifier-item-new": "");
	notify.userAvatar = notify.userAvatar? notify.userAvatar: this.BXIM.pathToBlankImage;

	var attachNode = notify.params && notify.params.ATTACH? BX.MessengerCommon.drawAttach(0, 0, notify.params.ATTACH): [];
	if (attachNode.length > 0)
	{
		attachNode = BX.create("div", { props : { className : "bx-messenger-attach-box" }, children: attachNode});
	}
	else
	{
		attachNode = null;
	}

	if (notify.type == 1 && typeof(notify.buttons) != "undefined" && notify.buttons.length > 0)
	{
		var arButtons = [];
		var canConfirmDelete = false;
		if (typeof(notify.confirmMessages) != 'undefined')
		{
			canConfirmDelete = true;
			for (var i = 0; i < notify.confirmMessages.length; i++)
			{
				arButtons.push(BX.create('div', {props : { className : "bx-notifier-item-confirm-message"}, html: notify.confirmMessages[i]}));
			}
		}
		else
		{
			for (var i = 0; i < notify.buttons.length; i++)
			{
				var type = notify.buttons[i].TYPE == 'accept'? 'accept': (notify.buttons[i].TYPE == 'cancel'? 'cancel': 'default');
				var arAttr = { 'data-id' : notify.id, 'data-value' : notify.buttons[i].VALUE};
				if (notify.grouped)
					arAttr['data-group'] = 'Y';

				if (notify.buttons[i].URL)
					arAttr['data-url'] = notify.buttons[i].URL;

				arButtons.push(BX.create('span', {props : { className : "bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-"+type }, attrs : arAttr, html: notify.buttons[i].TITLE}));
			}
		}
		element = BX.create("div", {attrs : {'data-notifyId' : notify.id, 'data-notifyType' : notify.type}, props : { className: "bx-notifier-item bx-notifier-item-"+notify.id+" "+itemNew}, children : [
			BX.create('span', {props : { className : "bx-notifier-item-content" }, children : [
				BX.create('span', {props : { className : "bx-notifier-item-avatar" }, children : [
					BX.create('img', {props : { className : "bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? " bx-notifier-item-avatar-img-default": "") }, attrs : {src : notify.userAvatar, style: (BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? 'background-color: '+notify.userColor: '')}})
				]}),
				!canConfirmDelete? BX.create("span", {props : { className: "bx-notifier-item-delete bx-notifier-item-delete-fake"}}): BX.create("a", {attrs : {href : '#', 'data-notifyId' : notify.id, 'data-notifyType' : notify.type, title: BX.message('IM_NOTIFY_DELETE_1')}, props : { className: "bx-notifier-item-delete"}}),
				BX.create('span', {props : { className : "bx-notifier-item-date" }, html: BX.MessengerCommon.formatDate(notify.date)}),
				notify.userName? BX.create('span', {props : { className : "bx-notifier-item-name" }, html: '<a href="'+notify.userLink+'" onclick="if (BXIM.init) { BXIM.openMessenger('+notify.userId+'); return false; } ">'+BX.MessengerCommon.prepareText(notify.userName)+'</a>'}): null,
				BX.create('span', {props : { className : "bx-notifier-item-text" }, html: notify.text}),
				attachNode,
				BX.create('span', {props : { className : "bx-notifier-item-button-wrap" }, children : arButtons})
			]})
		]});
	}
	else if (notify.type == 2 || (notify.type == 1 && typeof(notify.buttons) != "undefined" && notify.buttons.length <= 0))
	{
		element = BX.create("div", {attrs : {'data-notifyId' : notify.id, 'data-notifyType' : notify.type}, props : { className: "bx-notifier-item bx-notifier-item-"+notify.id+" "+itemNew}, children : [
			BX.create('span', {props : { className : "bx-notifier-item-content" }, children : [
				BX.create('span', {props : { className : "bx-notifier-item-avatar" }, children : [
					BX.create('img', {props : { className : "bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? " bx-notifier-item-avatar-img-default": "") },attrs : {src : notify.userAvatar, style: (BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? 'background-color: '+notify.userColor: '')}})
				]}),
				BX.create("a", {attrs : {href : '#', 'data-notifyId' : notify.id, 'data-notifyType' : notify.type, title: BX.message('IM_NOTIFY_DELETE_1')}, props : { className: "bx-notifier-item-delete"}}),
				BX.create('span', {props : { className : "bx-notifier-item-date" }, html: BX.MessengerCommon.formatDate(notify.date)}),
				BX.create('span', {props : { className : "bx-notifier-item-name" }, html: '<a href="'+notify.userLink+'" onclick="if (BXIM.init) { BXIM.openMessenger('+notify.userId+'); return false; } ">'+BX.MessengerCommon.prepareText(notify.userName)+'</a>'}),
				BX.create('span', {props : { className : "bx-notifier-item-text" }, html: notify.text}),
				attachNode,
				this.drawNotifyAnswer(notify)
			]})
		]});
	}
	else if (notify.type == 3)
	{
		element = BX.create("div", {attrs : {'data-notifyId' : notify.id, 'data-notifyType' : notify.type}, props : { className: "bx-notifier-item bx-notifier-item-"+notify.id+" "+itemNew}, children : [
			BX.create('span', {props : { className : "bx-notifier-item-content" }, children : [
				BX.create('span', {props : { className : "bx-notifier-item-avatar-group" }, children : [
					BX.create('span', {props : { className : "bx-notifier-item-avatar" }, children : [
						BX.create('img', {props : { className : "bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? " bx-notifier-item-avatar-img-default": "") },attrs : {src : notify.userAvatar, style: (BX.MessengerCommon.isBlankAvatar(notify.userAvatar)? 'background-color: '+notify.userColor: '')}})
					]})
				]}),
				BX.create("a", {attrs : {href : '#', 'data-notifyId' : notify.id, 'data-group' : 'Y', 'data-notifyType' : notify.type, title: BX.message('IM_NOTIFY_DELETE_1')}, props : { className: "bx-notifier-item-delete"}}),
				BX.create('span', {props : { className : "bx-notifier-item-date" }, html: BX.MessengerCommon.formatDate(notify.date)}),
				BX.create('span', {props : { className : "bx-notifier-item-name" }, html: BX.message('IM_NOTIFY_GROUP_NOTIFY').replace('#USER_NAME#', '<a href="'+notify.userLink+'" onclick="if (BXIM.init) { BXIM.openMessenger('+notify.userId+'); return false;} ">'+BX.MessengerCommon.prepareText(notify.userName)+'</a>').replace('#U_START#', '<span class="bx-notifier-item-help" data-help="'+notify.id+'">').replace('#U_END#', '</span>').replace('#COUNT#', notify.otherCount)}),
				BX.create('span', {props : { className : "bx-notifier-item-text" }, html: notify.text}),
				attachNode,
				this.drawNotifyAnswer(notify)
			]})
		]});
	}
	else
	{
		element = BX.create("div", {attrs : {'data-notifyId' : notify.id, 'data-notifyType' : notify.type}, props : { className: "bx-notifier-item bx-notifier-item-"+notify.id+" "+itemNew}, children : [
			BX.create('span', {props : { className : "bx-notifier-item-content" }, children : [
				BX.create('span', {props : { className : "bx-notifier-item-avatar" }, children : [
					BX.create('img', {props : { className : "bx-notifier-item-avatar-img bx-notifier-item-avatar-img-default-2" },attrs : {src : notify.userAvatar}})
				]}),
				BX.create("a", {attrs : {href : '#', 'data-notifyId' : notify.id, 'data-notifyType' : notify.type, title: BX.message('IM_NOTIFY_DELETE_1')}, props : { className: "bx-notifier-item-delete"}}),
				BX.create('span', {props : { className : "bx-notifier-item-date" }, html: BX.MessengerCommon.formatDate(notify.date)}),
				notify.title && notify.title.length>0? BX.create('span', {props : { className : "bx-notifier-item-name" }, html: BX.MessengerCommon.prepareText(notify.title)}): null,
				BX.create('span', {props : { className : "bx-notifier-item-text" }, html: notify.text}),
				attachNode,
				this.drawNotifyAnswer(notify)
			]})
		]});
	}
	return element;
};

BX.MessengerNotify.prototype.drawNotifyAnswer = function(notify)
{
	var node = null;
	if (typeof(notify.params) == 'object' && notify.params.CAN_ANSWER != 'Y')
		return node;

	value = this.notifyAnswerText[notify.id]? this.notifyAnswerText[notify.id]: "";

	node = BX.create('div', {props : { className : "bx-notifier-item-text" }, children : [
		BX.create('div', {props : { className : "bx-notifier-answer-link" }, children : [
			BX.create("span", {props : { className : "bx-notifier-answer-reply bx-messenger-ajax" }, html: BX.message('IM_N_REPLY')})
		]}),
		BX.create('div', {attrs: {'data-id': notify.id}, props : { className : "bx-notifier-answer-box"+(value? ' bx-notifier-answer-box-open': '') }, children : [
			BX.create("span", {props : { className : "bx-notifier-answer-progress" }}),
			BX.create('span', {props : { className : "bx-notifier-answer-input" }, children : [
				BX.create("input", {attrs: {type: "text", value: value, 'data-id': notify.id}, events: { 'keydown': BX.delegate(function(event){
					if (event.keyCode == 13)
					{
						this.sendNotifyAnswer(BX.proxy_context.parentNode.parentNode);
					}
					else if (event.keyCode == 27)
					{
						if (BX.proxy_context.value != "")
						{
							BX.proxy_context.value = "";
							this.notifyAnswerText[BX.proxy_context.getAttribute('data-id')] = "";
						}
						else
						{
							this.toggleNotifyAnswer(BX.proxy_context.parentNode.parentNode.previousSibling);
						}
						return BX.MessengerCommon.preventDefault(event);
					}
				}, this), 'keyup': BX.delegate(function(event){
					this.notifyAnswerText[BX.proxy_context.getAttribute('data-id')] = BX.proxy_context.value;
				}, this)}, props : { className : "bx-messenger-input" }})
			]}),
			BX.create("a", {attrs: {href: "#send"}, props : { className : "bx-notifier-answer-button" }})
		]}),
		BX.create('div', {props : { className : "bx-notifier-answer-text" }, html: BX.message('IM_N_REPLY_TEXT')})
	]});

	return node;
}
BX.MessengerNotify.prototype.toggleNotifyAnswer = function(notifyAnswer)
{
	var id = notifyAnswer.nextSibling.getAttribute('data-id');
	if (this.notifyAnswerBlock[id])
		return false;

	BX.toggleClass(notifyAnswer.nextSibling, 'bx-notifier-answer-box-open');
	BX.removeClass(notifyAnswer.nextSibling.nextSibling, 'bx-notifier-answer-text-show');

	var item = BX.findChildByClassName(notifyAnswer.nextSibling, "bx-messenger-input");
	if (item)
	{
		item.focus();
	}

	return true;
}
BX.MessengerNotify.prototype.sendNotifyAnswer = function(notifyAnswer, popup)
{
	var id = notifyAnswer.getAttribute('data-id');
	if (this.notifyAnswerBlock[id])
		return true;

	var input = BX.findChildByClassName(notifyAnswer, "bx-messenger-input");
	if (!input)
		return false;

	input.value = BX.util.trim(input.value);
	if (input.value == "")
	{
		return true;
	}

	if (!this.BXIM.init && BX.MessengerCommon.isDesktop())
		BX.desktop.windowCommand("freeze");

	this.notifyAnswerBlock[id] = true;
	this.notifyAnswerText[id] = input.value;

	input.disabled = true;

	BX.addClass(notifyAnswer, 'bx-notifier-answer-box-send');

	BX.ajax({
		url: this.BXIM.pathToAjax+'?NOTIFY_ANSWER&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_NOTIFY_ANSWER' : 'Y', 'NOTIFY_ID' : id, 'NOTIFY_ANSWER' : input.value, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			BX.removeClass(notifyAnswer, 'bx-notifier-answer-box-error');
			BX.removeClass(notifyAnswer, 'bx-notifier-answer-box-send');
			this.notifyAnswerBlock[id] = false;
			this.notifyAnswerText[id] = "";
			var input = BX.findChildByClassName(notifyAnswer, "bx-messenger-input");
			if (input)
			{
				input.disabled = false;
			}

			if (data.ERROR == "")
			{
				BX.removeClass(notifyAnswer, 'bx-notifier-answer-box-open');
				BX.addClass(notifyAnswer.nextSibling, 'bx-notifier-answer-text-show');

				if (data.MESSAGES && data.MESSAGES.length > 0)
				{
					notifyAnswer.nextSibling.innerHTML = data.MESSAGES.join("<br/>");
				}

				if (input)
				{
					input.value = "";
				}

				if (!this.BXIM.init && BX.MessengerCommon.isDesktop())
					BX.desktop.windowCommand("close");
			}
			else
			{
				BX.addClass(notifyAnswer, 'bx-notifier-answer-box-error');
			}
		}, this),
		onfailure: BX.delegate(function() {
			BX.addClass(notifyAnswer, 'bx-notifier-answer-box-error');
			BX.removeClass(notifyAnswer, 'bx-notifier-answer-box-send');
			this.notifyAnswerBlock[id] = false;

			var input = BX.findChildByClassName(notifyAnswer, "bx-messenger-input");
			if (input)
			{
				input.disabled = false;
			}
		}, this)
	});

	return true;
}


BX.MessengerNotify.prototype.storageSet = function(params)
{
	if (params.key == 'npp')
	{
		var panelPosition = BX.localStorage.get(params.key);
		this.BXIM.settings.panelPositionHorizontal = !!panelPosition? panelPosition.h: this.BXIM.settings.panelPositionHorizontal;
		this.BXIM.settings.panelPositionVertical = !!panelPosition? panelPosition.v: this.BXIM.settings.panelPositionVertical;
		this.adjustPosition({resize: true});
	}
	else if (params.key == 'nun')
	{
		this.notify = params.value;
	}
	else if (params.key == 'nrn')
	{
		delete this.notify[params.value];
		this.updateNotifyCount(false);
	}
	else if (params.key == 'nrgn')
	{
		for (var i in this.notify)
		{
			if (this.notify[i].tag == params.value)
				delete this.notify[i];
		}
		this.updateNotifyCount();
	}
	else if (params.key == 'numc')
	{
		this.updateNotifyMailCount(params.value, false);
	}
	else if (params.key == 'nuc')
	{
		this.updateNotifyCounters(params.value, false);
	}
	else if (params.key == 'nunc')
	{
		setTimeout(BX.delegate(function(){
			this.unreadNotify = params.value.unread;
			this.flashNotify = params.value.flash;

			this.updateNotifyCount(false);
		},this), 500);
	}
	else if (params.key == 'nln')
	{
		this.loadNotify(false);
	}
};

})();

/* IM messenger class */
(function() {

if (BX.MessengerChat)
	return;

BX.MessengerChat = function(BXIM, params)
{
	this.BXIM = BXIM;
	this.BXIM.messenger = this;

	this.settings = {};
	this.params = params || {};

	this.realSearchAvailable = !this.BXIM.userExtranet || !this.BXIM.bitrixIntranet && !this.BXIM.bitrix24net;
	this.realSearch = !this.BXIM.options.contactListLoad;
	this.realSearchFound = true;

	this.updateStateCount = 1;
	this.sendAjaxTry = 0;
	this.updateStateVeryFastCount = 0;
	this.updateStateFastCount = 0;
	this.updateStateStepDefault = this.BXIM.ppServerStatus? parseInt(params.updateStateInterval): 60;
	this.updateStateStep = this.updateStateStepDefault;
	this.updateStateTimeout = null;
	this.redrawContactListTimeout = {};
	this.redrawRecentListTimeout = null;
	this.floatDateTimeout = null;
	this.readMessageTimeout = {};
	this.readMessageTimeoutSend = null;

	this.sendFrameTokenCollection = {};
	this.sendFrameTokenTimeout = 500;

	this.webrtc = params.webrtcClass;
	this.notify = params.notifyClass;
	this.desktop = params.desktopClass;

	this.bot = params.bot;
	this.command = params.command;
	this.commandPopup = null;
	this.commandListen = false;
	this.commandList = [];
	this.commandSelect = '';
	this.commandSelectIndex = 1;
	this.textareaIcon = params.textareaIcon;

	this.smile = params.smile;
	this.smileSet = params.smileSet;
	this.smileCurrentSet = this.BXIM.getLocalConfig('smiles-current-set', 0) || [];
	this.smileRecentId = 1;
	this.getRecentSmiles();

	this.recentListIndex = [];
	if (params.recent)
	{
		this.recent = params.recent;
		this.recentListLoad = true;
	}
	else
	{
		this.recent = [];
		this.recentListLoad = false;
	}

	this.recentListExternal = null;
	if (params.externalRecentList)
	{
		this.recentListExternal = BX(params.externalRecentList);
	}

	this.popupTooltip = null;

	this.users = params.users;
	for (var userId in this.users)
	{
		this.users[userId].absent = this.users[userId].absent? new Date(this.users[userId].absent): false;
		this.users[userId].idle = this.users[userId].idle? new Date(this.users[userId].idle): false;
		this.users[userId].last_activity_date = new Date(this.users[userId].last_activity_date);
		this.users[userId].mobile_last_date = new Date(this.users[userId].mobile_last_date);
	}

	this.businessUsers = params.businessUsers;
	this.openlines = params.openlines;
	this.groups = params.groups;
	this.userInGroup = params.userInGroup;
	this.currentTab = 0;
	this.generalChatId = params.generalChatId;
	this.canSendMessageGeneralChat = params.canSendMessageGeneralChat;
	this.redrawTab = {};
	this.loadLastMessageTimeout = {};
	this.loadLastMessageClassTimeout = {};
	this.showMessage = params.showMessage;
	this.unreadMessage = params.unreadMessage;
	this.flashMessage = params.flashMessage;
	this.tooltipShowed = params.tooltipShowed || {};

	this.disk = params.diskClass;
	this.disk.messenger = this;
	this.popupMessengerFileForm = null;
	this.popupMessengerFileDropZone = null;
	this.popupMessengerFileButton = null;
	this.popupMessengerFileFormChatId = null;
	this.popupMessengerFileFormInput = null;

	this.openChatEnable = params.openChatEnable;
	this.chat = params.chat;
	for (var chatId in this.chat)
	{
		this.chat[chatId].date_create = new Date(this.chat[chatId].date_create);
	}

	this.userChat = params.userChat;
	this.userInChat = params.userInChat;
	this.userChatBlockStatus = params.userChatBlockStatus;
	this.userChatOptions = params.userChatOptions;
	this.blockJoinChat = {};
	this.hrphoto = params.hrphoto;

	this.chatPublicWatch = 0;
	this.chatPublicWatchAdd = false;

	this.popupIframeBind = true;
	this.popupIframeMenu = null;

	this.popupMessengerLiveChatDelayedFormMid = 0;
	this.popupMessengerLiveChatActionTimeout = null;
	this.popupMessengerLiveChatDelayedForm = null;
	this.popupMessengerLiveChatFormStage = null;

	this.phones = {};

	this.errorMessage = {};
	this.message = params.message;
	for (var messageId in this.message)
	{
		this.message[messageId].date = new Date(this.message[messageId].date);
	}

	this.messageTmpIndex = 0;
	this.history = params.history;
	this.textareaHistory = {};
	this.textareaHistoryTimeout = null;
	this.messageCount = params.countMessage;
	this.sendMessageFlag = 0;
	this.sendMessageTmp = {};
	this.sendMessageTmpTimeout = {};

	this.popupSettings = null;
	this.popupSettingsBody = null;

	this.popupChatDialog = null;
	this.popupChatDialogContactListElements = null;
	this.popupChatDialogContactListSearch = null;
	this.popupChatDialogContactListElementsType = '';
	this.popupChatDialogContactListSearchLastText = '';
	this.popupChatDialogDestElements = null;
	this.popupChatDialogUsers = {};
	this.popupChatDialogSendBlock = false;
	this.renameChatDialogFlag = false;
	this.renameChatDialogInput = null;

	this.popupHistory = null;
	this.popupHistoryElements = null;
	this.popupHistoryItems = null;
	this.popupHistoryItemsSize = 475;
	this.popupHistorySearchDateWrap = null;
	this.popupHistorySearchWrap = null;
	this.popupHistoryFilesSearchWrap = null;
	this.popupHistoryButtonDeleteAll = null;
	this.popupHistoryButtonFilter = null;
	this.popupHistoryButtonFilterBox = null;
	this.popupHistoryFilterVisible = true;
	this.popupHistoryBodyWrap = null;
	this.popupHistoryFilesItems = null;
	this.popupHistoryFilesBodyWrap = null;
	this.popupHistorySearchInput = null;
	this.historyUserId = 0;
	this.historyChatId = 0;
	this.historyDateSearch = '';
	this.historySearch = '';
	this.historyLastSearch = {};
	this.historySearchBegin = false;
	this.historySearchTimeout = null;
	this.historyFilesSearch = '';
	this.historyFilesLastSearch = {};
	this.historyFilesSearchBegin = false;
	this.historyFilesSearchTimeout = null;
	this.historyWindowBlock = false;
	this.historyMessageSplit = '------------------------------------------------------';
	this.historyOpenPage = {};
	this.historyLoadFlag = {};
	this.historyEndOfList = {};
	this.historyFilesOpenPage = {};
	this.historyFilesLoadFlag = {};
	this.historyFilesEndOfList = {};

	this.popupMessenger = null;
	this.popupMessengerWindow = {};
	this.popupMessengerExtra = null;
	this.popupMessengerTopLine = null;
	this.popupMessengerDesktopTimeout = null;
	this.popupMessengerFullWidth = 864;
	this.popupMessengerMinWidth = 864;
	this.popupMessengerFullHeight = 454;
	this.popupMessengerMinHeight = 384;
	this.popupMessengerDialog = null;
	this.popupMessengerBody = null;
	this.popupMessengerBodyDialog = null;
	this.popupMessengerBodyAnimation = null;
	this.popupMessengerBodySize = 316;
	this.popupMessengerBodySizeMin = 246;
	this.popupMessengerBodyWrap = null;

	this.popupMessengerLikeBlock = {};
	this.popupMessengerLikeBlockTimeout = {};

	this.popupMessengerSendingTimeout = {};

	this.popupMessengerConnectionStatusState = "online";
	this.popupMessengerConnectionStatusStateText = "online";
	this.popupMessengerConnectionStatus = null;
	this.popupMessengerConnectionStatusText = null;
	this.popupMessengerConnectionStatusTimeout = null;

	this.popupMessengerEditForm = null;
	this.popupMessengerEditFormTimeout = null;
	this.popupMessengerEditTextarea = null;
	this.popupMessengerEditMessageId = 0;

	this.popupMessengerPanel = null;
	this.popupMessengerPanelBotIcons = false;
	this.popupMessengerPanelAvatar = null;
	this.popupMessengerPanelButtonCall1 = null;
	this.popupMessengerPanelButtonCall2 = null;
	this.popupMessengerPanelButtonCall3 = null;
	this.popupMessengerPanelTitle = null;
	this.popupMessengerPanelStatus = null;

	this.popupMessengerPanelChat = null;
	this.popupMessengerPanelCall = null;
	this.popupMessengerPanelChatTitle = null;
	this.popupMessengerPanelUsers = null;

	this.popupMessengerTextareaPlace = null;
	this.popupMessengerTextarea = null;
	this.popupMessengerTextareaSendType = null;
	this.popupMessengerTextareaResize = {};
	this.popupMessengerTextareaSize = 30;
	this.popupMessengerLastMessage = 0;

	this.mentionList = {};
	this.mentionListen = false;
	this.mentionDelimiter = '';

	this.readedList = {};
	this.writingList = {};
	this.writingListTimeout = {};
	this.writingSendList = {};
	this.writingSendListTimeout = {};

	this.contactListPanelStatus = null;
	this.contactListSearchText = '';
	this.contactListSearchLastText = '';

	this.popupPopupMenu = null;
	this.popupPopupMenuModifyFunction = [];
	this.popupPopupMenuDateCreate = 0;

	this.popupSmileMenu = null;
	this.popupSmileMenuGallery = null;
	this.popupSmileMenuSet = null;

	this.chatList = false;
	this.recentList = true;
	this.contactList = false;
	this.contactListShowed = {};

	this.openMessengerFlag = false;
	this.openChatFlag = false;
	this.openNetworkFlag = false;
	this.openBotFlag = false;
	this.openCallFlag = false;

	this.contactListLoad = !this.BXIM.options.contactListLoad;
	this.popupContactListSize = 254;
	this.popupContactListSearchInput = null;
	this.popupContactListSearchClose = null;
	this.popupContactListWrap = null;
	this.popupContactListElements = null;
	this.popupContactListElementsSize = this.BXIM.design == 'DESKTOP'? 368: 334;
	this.popupContactListElementsSizeMin = this.BXIM.design == 'DESKTOP'? 298: 264;
	this.popupContactListElementsWrap = null;
	this.contactListPanelSettings = null;

	this.linesTransferUser = 0;
	this.linesSilentMode = {};
	this.linesLiveChatVote = false;

	this.enableGroupChat = this.BXIM.ppServerStatus? true: false;

	if (this.BXIM.init)
	{
		if (BX.MessengerCommon.isPage())
		{
			BX.MessengerWindow.setUserInfo(BX.MessengerCommon.getUserParam());

			BX.MessengerWindow.addTab({
				id: 'im',
				title: BX.message('IM_DESKTOP_OPEN_MESSENGER').replace('#COUNTER#', ''),
				order: 100,
				events: {
					open: BX.delegate(function(){
						if (BX.MessengerCommon.isPage() && this.BXIM.context == 'POPUP-FULLSCREEN' && !this.popupMessenger)
						{
							return false;
						}
						if (!this.BXIM.dialogOpen)
						{
							this.openMessenger(this.currentTab);
						}
					}, this)
				}
			});
			if (this.webrtc.phoneSupport() && this.webrtc.phoneCanPerformCalls)
			{
				BX.MessengerWindow.addTab({
					id: 'im-phone',
					title: BX.message('IM_PHONE_DESC'),
					order: 120,
					target: 'im',
					events: {
						open: BX.delegate(this.webrtc.openKeyPad, this.webrtc),
						close: BX.delegate(function(){
							if (this.webrtc.popupKeyPad)
								this.webrtc.popupKeyPad.close();
						}, this)
					}
				});
			}
			if (this.BXIM.settings.linesTabEnable && BX.MessengerCommon.isLinesOperator())
			{
				BX.MessengerWindow.addTab({
					id: 'im-ol',
					title: BX.message('IM_CTL_CHAT_OL'),
					order: 105,
					target: 'im',
					events: {
						open: BX.delegate(function(){
							if (BX.MessengerCommon.isPage() && this.BXIM.context == 'POPUP-FULLSCREEN' && !this.popupMessenger)
							{
								return false;
							}
							if (!this.BXIM.dialogOpen)
							{
								this.openMessenger(this.currentTab);
							}
							BX.MessengerCommon.userListRedraw();
						}, this),
						close: BX.delegate(function(){
							BX.MessengerCommon.userListRedraw();
						}, this)
					}
				});
			}
		}

		BX.addCustomEvent("onPullError", BX.delegate(function(error, code) {
			if (error == 'AUTHORIZE_ERROR')
			{
				if (BX.MessengerCommon.isDesktop())
				{
					this.connectionStatus('connecting');
				}
				else
				{
					this.connectionStatus('offline');
				}
			}
			else if (error == 'RECONNECT' && (code == 1008 || code == 1006))
			{
				this.connectionStatus('connecting');
			}
		}, this));

		BX.addCustomEvent("OnDesktopTabChange", BX.delegate(function() {
			if (this.BXIM.messenger.chatList)
			{
				BX.MessengerCommon.contactListSearchClear();
			}
			this.closeMenuPopup();
		}, this));
		BX.addCustomEvent("OnMessengerWindowShowPopup", BX.delegate(function(dialogId) {
			this.openMessenger(dialogId);
		}, this));
		BX.addCustomEvent("OnMessengerWindowClosePopup", BX.delegate(function() {
			this.closeMessenger();
		}, this));

		BX.addCustomEvent("onImError", BX.delegate(function(error, sendErrorCode) {
			if (error == 'AUTHORIZE_ERROR' || error == 'SEND_ERROR' && sendErrorCode == 'AUTHORIZE_ERROR')
			{
				if (BX.MessengerCommon.isDesktop())
				{
					this.connectionStatus('connecting');
				}
				else
				{
					this.connectionStatus('offline');
				}
			}
		}, this));

		BX.addCustomEvent("onPullStatus", BX.delegate(function(status){
			this.connectionStatus(status == 'offline'? 'offline': 'online');
		}, this));

		BX.bind(window, "online", BX.delegate(function(){
			this.connectionStatus('online');
		}, this));

		BX.bind(window, "offline", BX.delegate(function(){
			this.connectionStatus('offline')
		}, this));

		this.notify.panel.appendChild(this.BXIM.audio.newMessage1 = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/new-message-1.ogg", type : "audio/ogg; codecs=vorbis" }}),
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/new-message-1.mp3", type : "audio/mpeg" }})
		]}));
		this.notify.panel.appendChild(this.BXIM.audio.newMessage2 = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/new-message-2.ogg", type : "audio/ogg; codecs=vorbis" }}),
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/new-message-2.mp3", type : "audio/mpeg" }})
		]}));
		this.notify.panel.appendChild(this.BXIM.audio.send = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/send.ogg", type : "audio/ogg; codecs=vorbis" }}),
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/send.mp3", type : "audio/mpeg" }})
		]}));
		if (typeof(this.BXIM.audio.send.play) == 'undefined')
		{
			this.BXIM.settings.enableSound = false;
		}

		for (var i in this.unreadMessage)
		{
			if (typeof (this.flashMessage[i]) == 'undefined')
				this.flashMessage[i] = {};
			for (var k = this.unreadMessage[i].length - 1; k >= 0; k--)
			{
				BX.localStorage.set('mum', {'userId': i, 'message': this.message[this.unreadMessage[i][k]]}, 5);
			}
		}
		BX.localStorage.set('muum', this.unreadMessage, 5);

		if (this.notify.panelButtonMessage)
		{
			BX.bind(this.notify.panelButtonMessage, "click", BX.delegate(function(e){
				this.BXIM.openMessenger(true);
			}, this));
		}

		var mcesh = this.BXIM.getLocalConfig('mcesh', null);
		if (mcesh !== null)
		{
			this.BXIM.options.chatExtendShowHistory = mcesh;
		}

		var mtabs = this.BXIM.getLocalConfig('global_msz_v2', false);
		if (!mtabs && BX.MessengerCommon.isPage())
		{
			this.desktop.initHeight = BX.MessengerWindow.initHeight;

			if (BX.MessengerCommon.isDesktop())
			{
				if (!BX.browser.IsMac() && !this.desktop.enableInVersion(37))
				{
					BXDesktopWindow.SetProperty("clientSize", {Width: window.innerWidth, Height: window.innerHeight});
				}
				this.tmpTextareaResize = BX.delegate(function(){
					var textareaSize = this.BXIM.getLocalConfig('global_tas', this.popupMessengerTextareaSize);
					this.setTextareaSize(textareaSize);
					BX.unbind(window, "resize", this.tmpTextareaResize);
				}, this)
				BX.bind(window, "resize", this.tmpTextareaResize);
			}
			else
			{
				BX.addCustomEvent('onImInit', BX.delegate(function(){
					var textareaSize = this.BXIM.getLocalConfig('global_tas', this.BXIM.context == 'POPUP-FULLSCREEN'? 60: this.popupMessengerTextareaSize);
					this.setTextareaSize(textareaSize);
				}, this));
			}
		}
		else if (mtabs && (!BX.MessengerCommon.isPage() || BX.MessengerCommon.isDesktop()))
		{
			this.popupMessengerFullWidth = parseInt(mtabs.wz);
			this.popupMessengerTextareaSize = parseInt(mtabs.ta2);
			this.popupMessengerBodySize = parseInt(mtabs.b) > 0? parseInt(mtabs.b): this.popupMessengerBodySize;
			this.popupHistoryItemsSize = parseInt(mtabs.hi);
			this.popupMessengerFullHeight = parseInt(mtabs.fz);
			this.popupContactListElementsSize = parseInt(mtabs.ez);
			this.notify.popupNotifySize = parseInt(mtabs.nz);
			this.popupHistoryFilterVisible = mtabs.hf;
			if (BX.MessengerCommon.isDesktop())
			{
				BX.desktop.setWindowSize({ Width: parseInt(mtabs.dw), Height: parseInt(mtabs.dh) })
				this.desktop.initHeight = parseInt(mtabs.dh);
			}
		}
		else
		{
			if (BX.MessengerCommon.isDesktop())
			{
				BX.desktop.setWindowSize({ Width: BX.MessengerWindow.initWidth, Height: BX.MessengerWindow.initHeight });
				this.desktop.initHeight = BX.MessengerWindow.initHeight;
			}
			else if (BX.MessengerCommon.isPage())
			{
				this.desktop.initHeight = BX.MessengerWindow.initHeight;
			}
			BX.addCustomEvent('onImInit', BX.delegate(function(){
				var textareaSize = this.BXIM.getLocalConfig('global_tas', this.BXIM.context == 'POPUP-FULLSCREEN'? 60: this.popupMessengerTextareaSize);
				this.setTextareaSize(textareaSize);
			}, this));
		}
		if (BX.MessengerCommon.isPage())
		{
			this.desktop.adjustSize()
			BX.MessengerCommon.redrawDateMarks();
			BX.bind(window, "resize", BX.delegate(function(){
				this.adjustSize()
				BX.MessengerCommon.redrawDateMarks();
			}, this.desktop));
		}

		if (BX.browser.SupportLocalStorage())
		{
			BX.addCustomEvent(window, "onLocalStorageSet", BX.delegate(this.storageSet, this));
			this.textareaHistory = BX.localStorage.get('mtah') || {};
			this.mentionList = BX.localStorage.get('mtam') || {};
			this.currentTab = this.currentTab || BX.localStorage.get('mct');
			this.currentTab = this.currentTab? this.currentTab: 0;

			this.messageTmpIndex = BX.localStorage.get('mti') || 0;
			var mfm = BX.localStorage.get('mfm');
			if (mfm)
			{
				for (var i in this.flashMessage)
					for (var j in this.flashMessage[i])
						if (mfm[i] && this.flashMessage[i][j] != mfm[i][j] && mfm[i][j] == false)
							this.flashMessage[i][j] = false;
			}

			BX.garbage(function(){
				BX.localStorage.set('mti', this.messageTmpIndex, 15);
				BX.localStorage.set('mtah', this.textareaHistory, 15);
				BX.localStorage.set('mtam', this.mentionList, 15);
				BX.localStorage.set('mct', this.currentTab, 15);
				BX.localStorage.set('mfm', this.flashMessage, 15);
				BX.localStorage.set('mcls', this.contactListSearchText+'', 15);

				if (BX.MessengerCommon.isDesktop() && (window.innerWidth < BX.desktop.minWidth || window.innerHeight < BX.desktop.minHeight))
					return false;

				this.BXIM.setLocalConfig('global_msz_v2', {
					'wz': this.popupMessengerFullWidth,
					'ta2': this.popupMessengerTextareaSize,
					'b': this.popupMessengerBodySize,
					'cl': this.popupContactListSize,
					'hi': this.popupHistoryItemsSize,
					'fz': this.popupMessengerFullHeight,
					'ez': this.popupContactListElementsSize,
					'nz': this.notify.popupNotifySize,
					'hf': this.popupHistoryFilterVisible,
					'dw': window.innerWidth,
					'dh': window.innerHeight,
					'place': 'garbage'
				});

			}, this);
		}
		else
		{
			var mtah = this.BXIM.getLocalConfig('mtah', false);
			if (mtah)
			{
				this.textareaHistory = mtah;
				this.BXIM.removeLocalConfig('mtah');
			}
			var mtam = this.BXIM.getLocalConfig('mtam', false);
			if (mtam)
			{
				this.textareaHistory = mtam;
				this.BXIM.removeLocalConfig('mtam');
			}

			BX.garbage(function(){
				this.BXIM.setLocalConfig('mtah', this.textareaHistory);
				this.BXIM.setLocalConfig('mtam', this.mentionList);

				if (BX.MessengerCommon.isDesktop() && (window.innerWidth < BX.desktop.minWidth || window.innerHeight < BX.desktop.minHeight))
					return false;

				this.BXIM.setLocalConfig('global_msz_v2', {
					'wz': this.popupMessengerFullWidth,
					'ta2': this.popupMessengerTextareaSize,
					'b': this.popupMessengerBodySize,
					'cl': this.popupContactListSize,
					'hi': this.popupHistoryItemsSize,
					'fz': this.popupMessengerFullHeight,
					'ez': this.popupContactListElementsSize,
					'nz': this.notify.popupNotifySize,
					'hf': this.popupHistoryFilterVisible,
					'dw': window.innerWidth,
					'dh': window.innerHeight,
					'place': 'garbage'
				});
			}, this);
		}
		BX.MessengerCommon.pullEvent();

		BX.addCustomEvent("onPullError", BX.delegate(function(error) {
			if (error == 'AUTHORIZE_ERROR')
				this.sendAjaxTry++;
		}, this));

		var i = 0;
		var today = BX.Main.Date.format('d-m');
		for(var userId in this.users)
		{
			if (this.users[userId].birthday == today && userId != this.BXIM.userId)
			{
				this.message[userId+'birthday'] = {'id' : userId+'birthday', 'senderId' : 0, 'recipientId' : userId, 'date' : BX.MessengerCommon.getNowDate(true), 'text' : BX.message('IM_M_BIRTHDAY_MESSAGE').replace('#USER_NAME#', '<img src="/bitrix/js/im/images/blank.gif" class="bx-messenger-birthday-icon"><strong>'+this.users[userId].name+'</strong>') };
				if (!this.showMessage[userId])
					this.showMessage[userId] = [];
				this.showMessage[userId].push(userId+'birthday');
				this.showMessage[userId].sort(BX.delegate(function(i, ii) {if (!this.message[i] || !this.message[ii]){return 0;} var i1 = this.message[i].date.getTime(); var i2 = this.message[ii].date.getTime(); if (i1 < i2) { return -1; } else if (i1 > i2) { return 1;} else{ if (i < ii) { return -1; } else if (i > ii) { return 1;}else{ return 0;}}}, this));

				var messageLastId = this.showMessage[userId][this.showMessage[userId].length-1];
				BX.MessengerCommon.recentListAdd({
					'userId': userId,
					'userIsChat': false,
					'id': this.message[messageLastId].id,
					'date': this.message[messageLastId].date,
					'recipientId': this.message[messageLastId].recipientId,
					'senderId': this.message[messageLastId].senderId,
					'text': messageLastId == userId+'birthday'? BX.message('IM_M_BIRTHDAY_MESSAGE_SHORT').replace('#USER_NAME#', this.users[userId].name): this.message[messageLastId].text,
					'params': {}
				}, true);
				this.recent.sort(BX.delegate(function(i, ii) {if (!this.message[i.id] || !this.message[ii.id]){return 0;} var i1 = this.message[i.id].date.getTime(); var i2 = this.message[ii.id].date.getTime(); if (i1 > i2) { return -1; } else if (i1 < i2) { return 1;} else{ if (i > ii) { return -1; } else if (i < ii) { return 1;}else{ return 0;}}}, this));

				var birthdayList = this.BXIM.getLocalConfig('birthdayPopup'+((new Date).getFullYear()), {});
				if (this.desktop.birthdayStatus() && !birthdayList[userId])
				{
					this.message[userId+'birthdayPopup'] = {'id' : userId+'birthdayPopup', 'senderId' : 0, 'recipientId' : userId, 'date' : BX.MessengerCommon.getNowDate(true), 'text' : BX.message('IM_M_BIRTHDAY_MESSAGE_SHORT').replace('#USER_NAME#', this.users[userId].name) };
					if (BX.MessengerCommon.isDesktop())
					{
						if (!this.unreadMessage[userId])
							this.unreadMessage[userId] = [];
						this.unreadMessage[userId].push(userId+'birthdayPopup');

						if (!this.flashMessage[userId])
							this.flashMessage[userId] = {};
						this.flashMessage[userId][userId+'birthdayPopup'] = true;
					}
					birthdayList[userId] = true;
					this.BXIM.removeLocalConfig('birthdayPopup'+((new Date).getFullYear()-1));
					this.BXIM.setLocalConfig('birthdayPopup'+((new Date).getFullYear()), birthdayList);
				}
			}
			i++;
		}

		this.updateState();
		if (params.openMessenger !== false)
			this.openMessenger(params.openMessenger);
		else if (this.openMessengerFlag)
			this.openMessenger(this.currentTab);

		if (params.openHistory !== false)
		{
			this.BXIM.openHistory(params.openHistory);
		}
		if (params.openNotify !== false)
			this.BXIM.openNotify();

		if (this.BXIM.settings.status != 'dnd')
			this.newMessage();

		this.updateMessageCount();

		setInterval(BX.delegate(function(){
			BX.MessengerCommon.checkProgessMessage();
			this.expireFrameToken();
		}, this), 1000);

		BX.bind(window, 'message', BX.delegate(function(event){
			if(event && event.origin == this.openFrameDialogFrameSourceDomain)
			{
				this.openFrameDialogPostMessage(event.data);
			}
		}, this));
	}
	else
	{
		if (params.openMessenger !== false)
			this.BXIM.openMessenger(params.openMessenger);
		if (params.openHistory !== false)
			this.BXIM.openHistory(params.openHistory);
	}
};

BX.MessengerChat.prototype.openMessengerSlider = function(dialogId, params)
{
	params = params || {};

	requestParams = {};
	requestParams.IFRAME = 'Y';
	requestParams.IM_DIALOG = dialogId;
	requestParams.IM_RECENT = params.RECENT == 'N'? 'N': 'Y';
	requestParams.IM_MENU = params.MENU == 'N'? 'N': 'Y';

	var options = {
		cacheable: false,
		allowChangeHistory: false,
		requestMethod: "post",
		requestParams: requestParams,
	};

	if (params.RECENT == 'N' || params.MENU == 'N')
	{
		options.width = 800 + (params.RECENT == 'N'? 0: 50) + (params.MENU == 'N'? 0: 20);
	}

	BX.SidePanel.Instance.open("/desktop_app/", options);
}

BX.MessengerChat.prototype.openMessenger = function(userId, params)
{
	if (BX.MessengerCommon.isPage() && this.BXIM.context == 'POPUP-FULLSCREEN' && !BX.MessengerWindow.isPopupShow())
	{
		BX.MessengerWindow.showPopup(userId);
		return false;
	}

	if (this.popupImageUploader)
	{
		this.popupImageUploader.close();
	}

	if (this.BXIM.errorMessage != '')
	{
		this.BXIM.openConfirm(this.BXIM.errorMessage, [new BX.PopupWindowButton({
			text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
			className : "popup-window-button-decline",
			events : { click : BX.delegate(function(e) { BX.proxy_context.popupWindow.close(); if (BX.MessengerWindow){ BX.MessengerWindow.closePopup() } BX.PreventDefault(e) }, this) }
		})]);
		return false;
	}
	if (this.BXIM.popupSettings != null && !BX.MessengerCommon.isDesktop())
		this.BXIM.popupSettings.close();

	if (this.popupMessenger != null && this.dialogOpen && this.currentTab == userId && userId != 0)
		return false;

	if (userId !== false && BX.MessengerCommon.isPage() && BX.MessengerWindow.currentTab != 'im' && BX.MessengerWindow.currentTab != 'im-ol')
	{
		BX.MessengerWindow.changeTab('im', false, true);
	}

	if (this.popupMessengerEditForm)
		this.editMessageCancel();

	if (userId && userId.toString().toLowerCase() == 'general')
	{
		this.currentTab = 'chat'+this.generalChatId;
		userId = this.currentTab;
	}

	BX.localStorage.set('mcam', true, 5);
	if (typeof(userId) == "undefined" || userId == null)
	{
		userId = 0;
	}

	if (this.currentTab == null)
		this.currentTab = 0;

	this.openChatFlag = false;
	this.openNetworkFlag = false;
	this.openBotFlag = false;
	this.openLinesFlag = false;
	this.openCallFlag = false;

	if (typeof(userId) == "boolean")
	{
		userId = 0;
	}
	else if (userId == 0)
	{
		if (userId == 0 && this.currentTab != null)
		{
			if (this.users[this.currentTab] && this.users[this.currentTab].id)
				userId = this.currentTab;
			else if (this.chat[this.getChatId()] && this.chat[this.getChatId()].id)
				userId = this.currentTab;
		}
		if (userId.toString().substr(0,4) == 'chat')
		{
			BX.MessengerCommon.getUserParam(userId);
			this.openChatFlag = true;
			if (this.chat[userId.toString().substr(4)].type == 'call')
				this.openCallFlag = true;
			else if (this.chat[userId.toString().substr(4)].type == 'lines')
				this.openLinesFlag = true;
		}
		else
		{
			userId = parseInt(userId);
		}
	}
	else if (
		userId.toString().substr(0,4) == 'chat'
		|| userId.toString().substr(0,2) == 'sg'
		|| userId.toString().substr(0,3) == 'crm'
	)
	{
		BX.MessengerCommon.getUserParam(userId);
		this.openChatFlag = true;

		if (userId.toString().substr(0,4) == 'chat')
		{
			if (this.chat[userId.toString().substr(4)].type == 'call')
				this.openCallFlag = true;
			else if (this.chat[userId.toString().substr(4)].type == 'lines')
				this.openLinesFlag = true;
		}
	}
	else if (userId.toString().substr(0,7) == 'network')
	{
		BX.MessengerCommon.getUserParam(userId);
		this.openNetworkFlag = true;
	}
	else if (this.users[userId] && this.users[userId].id)
	{
		userId = parseInt(userId);
	}
	else
	{
		userId = parseInt(userId);
		if (isNaN(userId))
		{
			userId = 0;
		}
		else
		{
			BX.MessengerCommon.getUserParam(userId);
		}
	}
	if (this.openNetworkFlag)
	{}
	else if (!this.openChatFlag && typeof(userId) != 'number')
	{
		userId = 0;
	}
	if (this.openChatFlag || userId > 0)
	{
		this.currentTab = userId;
		this.BXIM.notifyManager.closeByTag('im-message-'+userId);
		BX.localStorage.set('mct', this.currentTab, 15);

		if (!this.openChatFlag && this.users[userId] && this.users[userId].bot)
		{
			this.openBotFlag = true;
		}
	}

	if (this.popupMessenger != null)
	{
		BX.MessengerCommon.openDialog(userId, this.BXIM.dialogOpen? false: true);
		if (!(BX.browser.IsAndroid() || BX.browser.IsIOS() || window != window.top))
		{
			if (this.popupMessengerTextarea)
				this.popupMessengerTextarea.focus();
		}
		return false;
	}

	// TODO remove this
	var styleOfContent = {};
	if (!BX.browser.IsMobile() && BX.MessengerCommon.isPage())
	{
		var newHeight = BX.MessengerWindow.content.offsetHeight - this.popupMessengerFullHeight;
		this.popupContactListElementsSize = this.popupContactListElementsSize + newHeight;
		this.popupMessengerBodySize = this.popupMessengerBodySize + newHeight;
		this.popupMessengerFullHeight = this.popupMessengerFullHeight + newHeight;
		this.notify.popupNotifySize = this.notify.popupNotifySize + newHeight;
	}
	else
	{
		styleOfContent = {width: this.popupMessengerFullWidth+'px'};
	}

	if (BX.MessengerWindow && BX.MessengerWindow.contentMenu)
	{
		if (this.BXIM.options.showMenu)
		{
			BX.removeClass(BX.MessengerWindow.contentBox, 'bx-desktop-appearance-hide-menu');
		}
		else
		{
			BX.addClass(BX.MessengerWindow.contentBox, 'bx-desktop-appearance-hide-menu');
		}
	}

	var userStatus = BX.MessengerCommon.getUserStatus(this.users[this.BXIM.userId]);

	this.popupMessengerContent = BX.create("div", { props : { className : "bx-messenger-box bx-messenger-mark bx-messenger-global-context-"+this.BXIM.context.toLowerCase()+" "+(this.BXIM.callController.hasActiveCall()? ' bx-messenger-call'+(this.callOverlayMinimize? '': ' bx-messenger-call-maxi'): '')+(BX.MessengerCommon.isPage()? ' bx-messenger-box-desktop': '')+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll')+(this.BXIM.options.showRecent? '': ' bx-messenger-hide-recent') }, style: styleOfContent, children : [
		/* CL */
		this.popupContactListWrap = BX.create("div", { props : { className : "bx-messenger-box-contact bx-messenger-box-contact-normal" }, style : {width: this.popupContactListSize+'px'},  children : [
			BX.create("div", { props : { className : "bx-messenger-cl-search" }, children : [
				this.popupContactListCreateChat = BX.create("span", {props : { className : "bx-messenger-input-search-create" }}),
				BX.create("div", { props : { className : "bx-messenger-input-wrap bx-messenger-cl-search-wrap" }, children : [
					this.popupContactListSearchClose = BX.create("a", {attrs: {href: "#close"}, props : { className : "bx-messenger-input-close" }}),
					this.popupContactListSearchInput = BX.create("input", {attrs: {type: "text", placeholder: BX.message('IM_M_SEARCH'), value: this.contactListSearchText}, props : { className : "bx-messenger-input" }})
				]})
			]}),
			this.popupContactListElements = BX.create("div", { props : { className : "bx-messenger-cl" }, style : {height: this.popupContactListElementsSize+'px'}, children : [
				this.popupContactListElementsWrap = BX.create("div", { props : { className : "bx-messenger-cl-wrap bx-messenger-recent-wrap" }})
			]}),
			this.BXIM.design == 'DESKTOP'? null: BX.create('div', {props : { className : "bx-messenger-cl-notify-wrap" }, children : [
				this.notify.messengerNotifyButton = BX.create("div", { props : { className : "bx-messenger-cl-notify-button"}, events : { click : BX.delegate(this.notify.openNotify, this.notify)}, children : [
					BX.create('span', {props : { className : "bx-messenger-cl-notify-text"}, html: BX.message('IM_NOTIFY_BUTTON_TITLE')}),
					this.notify.messengerNotifyButtonCount = BX.create('span', { props : { className : "bx-messenger-cl-count" }, html: parseInt(this.notify.notifyCount)>0? '<span class="bx-messenger-cl-count-digit">'+this.notify.notifyCount+'</span>':''})
				]}),
				this.popupContactListSearchCall = !this.webrtc.phoneSupport() || !this.webrtc.phoneCanPerformCalls? null: BX.create("div", { props : { className : "bx-messenger-cl-phone-button"}, children : [
					BX.create('span', {props : { className : "bx-messenger-cl-phone-text"}, html: BX.message('IM_PHONE_BUTTON_TITLE')}),
				]})
			]}),
			BX.create('div', {props : { className : "bx-messenger-cl-panel" }, children : [
				BX.create('div', {props : { className : "bx-messenger-cl-panel-wrap" }, children : [
					this.contactListPanelStatus = BX.create("span", { props : { className : "bx-messenger-cl-panel-status-wrap bx-messenger-cl-panel-status-"+BX.MessengerCommon.getUserStatus(this.users[this.BXIM.userId]) }, html: '<span class="bx-messenger-cl-panel-status"></span><span class="bx-messenger-cl-panel-status-text">'+BX.message("IM_STATUS_"+(userStatus == 'birthday'? 'online': userStatus ).toUpperCase())+'</span><span class="bx-messenger-cl-panel-status-arrow"></span>'}),
					BX.create('span', {props : { className : "bx-messenger-cl-panel-right-wrap" }, children : [
						//this.contactListPanelFull = BX.MessengerCommon.isPage()? null: BX.create("span", { props : { title : BX.message("IM_FULLSCREEN"), className : "bx-messenger-cl-panel-fullscreen-wrap"}}),
						this.contactListPanelSettings = this.BXIM.design == 'DESKTOP'? null: BX.create("span", { props : { title : BX.message("IM_SETTINGS"), className : "bx-messenger-cl-panel-settings-wrap"}})
					]})
				]})
			]})
		]}),
		/* DIALOG */
		this.popupMessengerDialog = BX.create("div", { props : { className : "bx-messenger-box-dialog"+(this.BXIM.isAdmin? ' bx-messenger-user-admin': '') }, style : {marginLeft: this.popupContactListSize+'px'},  children : [
			this.popupMessengerPanel = BX.create("div", { props : { className : "bx-messenger-panel bx-messenger-context-user "+(this.openChatFlag? ' bx-messenger-hide': '') }, children : [
				BX.create('a', { attrs : { href : this.users[this.currentTab]? this.users[this.currentTab].profile: BX.MessengerCommon.getUserParam().profile}, props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[this.currentTab]) }, children: [
					this.popupMessengerPanelAvatar = BX.create('img', { attrs : { src : this.BXIM.pathToBlankImage }, props : { className : "bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default" }}),
					BX.create('span', {  props : { className : "bx-messenger-panel-avatar-status" }})
				], events : {
					mouseover: BX.delegate(function(e){
						if (this.users[this.currentTab])
						{
							BX.proxy_context.title = BX.MessengerCommon.getUserStatus(this.users[this.currentTab], true);
						}
					}, this)
				}}),
				BX.create("a", {attrs: {href: "#history", title: BX.message("IM_M_OPEN_HISTORY_2")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-history"}, events : { click: BX.delegate(function(e){ this.openHistory(this.currentTab); BX.PreventDefault(e)}, this)}}),
				this.popupMessengerPanelMute = BX.create("a", {attrs: {href: "#block", title: this.muteButtonStatus(this.currentTab)? BX.message("IM_M_USER_BLOCK_ON"): BX.message("IM_M_USER_BLOCK_OFF")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-mute"}, events : { click: BX.delegate(function(e){BX.MessengerCommon.muteMessageChat(this.currentTab);BX.PreventDefault(e);}, this)}}),
				this.enableGroupChat? BX.create("a", {attrs: {href: "#chat", title: BX.message("IM_M_CHAT_TITLE")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-chat"}, html: BX.message("IM_M_CHAT_BTN_JOIN"), events : { click: BX.delegate(function(e){ this.openChatDialog({'type': 'CHAT_ADD', 'bind': BX.proxy_context}); BX.PreventDefault(e)}, this)}}): null,
				this.popupMessengerPanelButtonCall1 = this.callButton(),
				BX.create("span", { props : { className : "bx-messenger-panel-title"}, children: [
					this.popupMessengerPanelTitle = BX.create('a', { props : { className : "bx-messenger-panel-title-link"+(this.users[this.currentTab] && this.users[this.currentTab].extranet? " bx-messenger-user-extranet": (this.users[this.currentTab] && this.users[this.currentTab].bot? (this.bot[this.currentTab] && this.bot[this.currentTab].type == 'network'? " bx-messenger-user-network": " bx-messenger-user-bot"): ""))}, attrs : { href : this.users[this.currentTab]? this.users[this.currentTab].profile: BX.MessengerCommon.getUserParam().profile}, html: this.users[this.currentTab]? this.users[this.currentTab].name: ''}),
					this.popupMessengerPanelLastDate = BX.create("span", { props : { className : "bx-messenger-panel-title-position"}, html: ''})
				]}),
				this.popupMessengerPanelStatus = BX.create("span", { props : { className : "bx-messenger-panel-desc"}, html: BX.MessengerCommon.getUserPosition(this.users[this.currentTab], false, true)})
			]}),
			this.popupMessengerPanelChat = BX.create("div", { props : { className : "bx-messenger-panel bx-messenger-context-chat "+(this.openChatFlag && !this.openCallFlag? '': ' bx-messenger-hide') }, children : [
				this.popupMessengerPanelAvatarForm2 = BX.create('form', { attrs : { action : this.BXIM.pathToFileAjax}, props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-chat" }, children: [
					BX.create('div', { props : { className : "bx-messenger-panel-avatar-progress"}, html: '<div class="bx-messenger-panel-avatar-progress-image"></div>'}),
					BX.create('input', { attrs : { type : 'hidden', name: 'IM_AVATAR_UPDATE', value: 'Y'}}),
					this.popupMessengerPanelAvatarId2 = BX.create('input', { attrs : { type : 'hidden', name: 'CHAT_ID', value: this.getChatId()}}),
					BX.create('input', { attrs : { type : 'hidden', name: 'IM_AJAX_CALL', value: 'Y'}}),
					this.popupMessengerPanelAvatarUpload2 = this.disk.lightVersion || !this.BXIM.ppServerStatus? null: BX.create('input', { attrs : { type : 'file', title: BX.message('IM_M_AVATAR_UPLOAD')}, props : { className : "bx-messenger-panel-avatar-upload"}}),
					this.popupMessengerPanelAvatar2 = BX.create('img', { attrs : { src : this.BXIM.pathToBlankImage}, props : { className : "bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default" }}),
					this.popupMessengerPanelCrm = BX.create('span', {  props : { className : "bx-messenger-panel-avatar-crm" }}),
					this.popupMessengerPanelStatus2 = BX.create('span', {  props : { className : "bx-messenger-panel-avatar-status" }})
					/*this.popupMessengerPanelLoader = BX.create('span', {  props : { className : "bx-messenger-loader" }, children: [
						BX.create('span', {  props : { className : "bx-messenger-loader-default bx-messenger-loader-first" }}),
						BX.create('span', {  props : { className : "bx-messenger-loader-default bx-messenger-loader-second" }}),
						BX.create('span', {  props : { className : "bx-messenger-loader-mask" }})
					]})*/
				]}),
				BX.create("span", {attrs: {title: BX.message('IM_P_MENU')}, props : { className : "bx-messenger-panel-button bx-messenger-panel-menu"}, events : { click: BX.delegate(function(e){ this.openPopupMenu(BX.proxy_context, this.chat[this.getChatId()].entity_type == "LINES"? 'openLinesMenu': 'pathMenu'); BX.PreventDefault(e); }, this)}}),
				BX.create("a", {attrs: {href: "#history", title: BX.message("IM_M_OPEN_HISTORY_2")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-history"}, events : { click: BX.delegate(function(e){ this.openHistory(this.currentTab); BX.PreventDefault(e)}, this)}}),
				this.popupMessengerPanelMute2 = BX.create("a", {attrs: {href: "#mute", title: this.muteButtonStatus(this.currentTab)? BX.message("IM_M_CHAT_MUTE_ON_2"): BX.message("IM_M_CHAT_MUTE_OFF_2")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)? ' bx-messenger-panel-unmute': '')}, events : { click: BX.delegate(function(e){BX.MessengerCommon.muteMessageChat(this.currentTab);BX.PreventDefault(e);}, this)}}),
				this.popupOpenLinesSpam = BX.create("span", {attrs: {title: BX.message('IM_M_OL_FORCE_CLOSE')? BX.message('IM_M_OL_FORCE_CLOSE').replace('<br>', ''): BX.message('IM_M_OL_SPAM')}, props : { className : "bx-messenger-panel-button bx-messenger-panel-spam"}, events : { click: BX.delegate(function(e){ this.linesMarkAsSpam(); BX.PreventDefault(e); }, this)}}),
				this.popupOpenLinesClose = BX.create("span", {attrs: {title: BX.message('IM_M_OL_CLOSE')}, props : { className : "bx-messenger-panel-button bx-messenger-panel-close"}, events : { click: BX.delegate(function(e){ this.linesCloseDialog(); BX.PreventDefault(e); }, this)}}),
				this.popupOpenLinesTransfer = BX.create("span", {attrs: {title: BX.message('IM_P_TRANSFER')}, props : { className : "bx-messenger-panel-button bx-messenger-panel-transfer"}, events : { click: BX.delegate(function(e){ this.linesOpenTransferDialog({'bind': BX.proxy_context}); BX.PreventDefault(e); }, this)}}),
				this.popupMessengerPanelButtonExtend = this.enableGroupChat? BX.create("a", {attrs: {href: "#chat", title: BX.message("IM_M_CHAT_TITLE")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-chat"}, html: BX.message("IM_M_CHAT_BTN_JOIN"), events : { click: BX.delegate(function(e){ this.openChatDialog({'chatId': this.getChatId(),'type': 'CHAT_EXTEND', 'bind': BX.proxy_context}); BX.PreventDefault(e)}, this)}}): null,
				this.popupMessengerPanelButtonCall2 = this.callButton(),
				BX.create("span", { props : { className : "bx-messenger-panel-title bx-messenger-panel-title-chat"}, children: [
					this.popupMessengerPanelChatTitle = BX.create('span', { props : { className : ""}, html: this.chat[this.getChatId()]? this.chat[this.getChatId()].name: BX.message('IM_CL_LOAD')})
				]}),
				BX.create("span", { props : { className : "bx-messenger-panel-desc"}, children : [
					this.popupMessengerPanelUsers = BX.create('div', { props : { className : "bx-messenger-panel-chat-users"}, html: BX.message('IM_CL_LOAD')})
				]})
			]}),
			this.popupMessengerPanelCall = BX.create("div", { props : { className : "bx-messenger-panel bx-messenger-context-call "+(this.openChatFlag && this.openCallFlag? '': ' bx-messenger-hide') }, children : [
				this.popupMessengerPanelAvatarForm3 = BX.create('form', { attrs : { action : this.BXIM.pathToFileAjax}, props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-call" }, children: [
					BX.create('div', { props : { className : "bx-messenger-panel-avatar-progress"}, html: '<div class="bx-messenger-panel-avatar-progress-image"></div>'}),
					BX.create('input', { attrs : { type : 'hidden', name: 'IM_AVATAR_UPDATE', value: 'Y'}}),
					this.popupMessengerPanelAvatarId3 = BX.create('input', { attrs : { type : 'hidden', name: 'CHAT_ID', value: this.getChatId()}}),
					BX.create('input', { attrs : { type : 'hidden', name: 'IM_AJAX_CALL', value: 'Y'}}),
					this.popupMessengerPanelAvatarUpload3 = this.disk.lightVersion || !this.BXIM.ppServerStatus? null: BX.create('input', { attrs : { type : 'file', title: BX.message('IM_M_AVATAR_UPLOAD_2')}, props : { className : "bx-messenger-panel-avatar-upload"}}),
					this.popupMessengerPanelAvatar3 = BX.create('img', { attrs : { src : this.BXIM.pathToBlankImage}, props : { className : "bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default" }}),
					this.popupMessengerPanelStatus3 = BX.create('span', {  props : { className : "bx-messenger-panel-avatar-status bx-messenger-panel-avatar-status-chat" }})
				]}),
				BX.create("span", {attrs: {title: BX.message('IM_P_MENU')}, props : { className : "bx-messenger-panel-button bx-messenger-panel-menu"}, events : { click: BX.delegate(function(e){ this.openPopupMenu(BX.proxy_context, 'callContextMenu'); BX.PreventDefault(e); }, this)}}),
				BX.create("a", {attrs: {href: "#history", title: BX.message("IM_M_OPEN_HISTORY_2")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-history"}, events : { click: BX.delegate(function(e){ this.openHistory(this.currentTab); BX.PreventDefault(e)}, this)}}),
				this.popupMessengerPanelMute3 = BX.create("a", {attrs: {href: "#mute", title: this.muteButtonStatus(this.currentTab)? BX.message("IM_M_CHAT_MUTE_ON_2"): BX.message("IM_M_CHAT_MUTE_OFF_2")}, props : { className : "bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)? ' bx-messenger-panel-unmute': '')}, events : { click: BX.delegate(function(e){ BX.MessengerCommon.muteMessageChat(this.currentTab); BX.PreventDefault(e)}, this)}}),
				this.popupMessengerPanelButtonCall3 = this.callButton('call'),
				this.popupMessengerPanelCallTitle = BX.create("span", { props : { className : "bx-messenger-panel-title"}, html: this.chat[this.getChatId()]? this.chat[this.getChatId()].name: BX.message('IM_CL_LOAD')}),
				this.popupMessengerPanelCallDescription = BX.create("span", { props : { className : "bx-messenger-panel-desc"}, text: this.chat[this.getChatId()] && this.chat[this.getChatId()].entity_data_1 && this.chat[this.getChatId()].entity_data_1.toString().charAt(0) === "Y" ? this.chat[this.getChatId()].call_number : BX.message('IM_PHONE_DESC')})
			]}),
			this.popupMessengerConnectionStatus = BX.create("div", { props : { className : "bx-messenger-connection-status "+(this.popupMessengerConnectionStatusState == 'online'? "bx-messenger-connection-status-hide": "bx-messenger-connection-status-show bx-messenger-connection-status-"+this.popupMessengerConnectionStatusState) }, children : [
				BX.create("div", { props : { className : "bx-messenger-connection-status-wrap" }, children : [
					this.popupMessengerConnectionStatusText = BX.create("span", { props : { className : "bx-messenger-connection-status-text"}, html: this.popupMessengerConnectionStatusStateText}),
					BX.create("span", { props : { className : "bx-messenger-connection-status-text-reload"}, children : [
						BX.create("span", { props : { className : "bx-messenger-connection-status-text-reload-title"}, html: BX.message('IM_CS_RELOAD')}),
						BX.create("span", { props : { className : "bx-messenger-connection-status-text-reload-hotkey"}, html: (BX.browser.IsMac()? "&#8984;+R": "Ctrl+R")})
					], events: {
						'click': function(){ location.reload() }
					}})
				]})
			]}),
			this.popupMessengerEditForm = BX.create("div", { props : { className : "bx-messenger-editform bx-messenger-editform-disable" }, children : [
				BX.create("div", { props : { className : "bx-messenger-editform-wrap" }, children : [
					BX.create("div", { props : { className : "bx-messenger-editform-textarea" }, children : [
						this.popupMessengerEditTextarea = BX.create("textarea", { props : { value: '', className : "bx-messenger-editform-textarea-input" }, style : {height: '70px'}})
					]}),
					BX.create("div", { props : { className : "bx-messenger-editform-buttons" }, children : [
						BX.create("span", { props : { className : "popup-window-button popup-window-button-accept" }, children : [
							BX.create("span", { props : { className : "popup-window-button-left"}}),
							BX.create("span", { props : { className : "popup-window-button-text"}, html: BX.message('IM_M_CHAT_BTN_EDIT')}),
							BX.create("span", { props : { className : "popup-window-button-right"}})
						], events : {
							click: BX.delegate(function(e){
								var editedMessageId = this.popupMessengerEditMessageId;
								BX.MessengerCommon.editMessageAjax(this.popupMessengerEditMessageId, this.popupMessengerEditTextarea.value);
								if(this.message[editedMessageId].quick_saved)
								{
									BX.MessengerCommon.linesSaveToQuickAnswers(editedMessageId, true);
								}
							}, this)
						}}),
						BX.create("span", { props : { className : "popup-window-button" }, children : [
							BX.create("span", { props : { className : "popup-window-button-left"}}),
							BX.create("span", { props : { className : "popup-window-button-text"}, html: BX.message('IM_M_CHAT_BTN_CANCEL')}),
							BX.create("span", { props : { className : "popup-window-button-right"}})
						], events : {
							click: BX.delegate(function(e){
								this.editMessageCancel();
							}, this)
						}}),
						BX.create("span", { props : { className : "bx-messenger-editform-progress"}, html: BX.message('IM_MESSAGE_EDIT_TEXT') })
					]})
				]})
			]}),
			this.popupMessengerBodyDialog = BX.create("div", { props : { className : "bx-messenger-body-dialog bxu-file-input-over" }, children: [
				this.popupMessengerFileDropZone = !this.disk.enable? null: BX.create("div", { props : { className : "bx-messenger-file-dropzone" }, children : [
					BX.create("div", { props : { className : "bx-messenger-file-dropzone-wrap" }, children: [
						BX.create("div", { props : { className : "bx-messenger-file-dropzone-icon" }}),
						BX.create("div", { props : { className : "bx-messenger-file-dropzone-text" }, html: BX.message('IM_F_DND_TEXT')}),
					]})
				]}),
				this.popupMessengerBodyPanel = BX.create("div", { props : { className : "bx-messenger-body-panel" }, style : {height: this.popupMessengerBodySize+'px'}, children: [
					BX.create("div", { props : { className : "bx-messenger-body-panel-title" }, children: [
						this.popupMessengerBodyPanelTitleName = BX.create("div", { props : { className : "bx-messenger-body-panel-title-name" }}),
						this.popupMessengerBodyPanelTitleDesc = BX.create("div", { props : { className : "bx-messenger-body-panel-title-desc" }}),
						BX.create("div", { props : { className : "bx-messenger-body-panel-title-close" }, events: {click: BX.delegate(function(){
							this.closeMessengerPanel();
						}, this)}})
					]}),
					this.popupMessengerBodyPanelWrap = BX.create("div", { props : { className : "bx-messenger-body-panel-wrap" }})
				]}),
				this.popupMessengerBody = BX.create("div", { props : { className : "bx-messenger-body" }, style : {height: this.popupMessengerBodySize+'px'}, children: [
					BX.create("div", { props : { className : "bx-messenger-body-bg" }, children: [
						this.popupMessengerBodyWrap = BX.create("div", { props : { className : "bx-messenger-body-wrap" }})
					]}),
				]}),
				this.popupMessengerBodyLiveChatForm = BX.create("div", { props : { className : "bx-messenger-livechat-form" }}),
				this.popupMessengerTextareaPlace = BX.create("div", { props : { className : "bx-messenger-textarea-place"}, children : [
					BX.create("div", { props : { className : "bx-messenger-textarea-open-lines" }, children : [
						BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box" }, children: [
							BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box-element" }, children: [
								this.popupMessengerTextareaOpenLinesText = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text" }, html: BX.message('IM_OL_INVITE_TEXT')})
							]})
						]}),
						BX.create("div", { props: { className : "bx-messenger-textarea-open-invite-join-box"}, children: [
							this.popupMessengerTextareaOpenLinesAnswer = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-answer bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept" }, html: BX.message('IM_OL_INVITE_ANSWER')}),
							this.popupMessengerTextareaOpenLinesSkip = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-skip bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-cancel" }, html: BX.message('IM_OL_INVITE_SKIP')}),
							this.popupMessengerTextareaOpenLinesTransfer = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-transfer bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-transfer" }, html: BX.message('IM_OL_INVITE_TRANSFER'), events : { click: BX.delegate(function(e){ this.linesOpenTransferDialog({'bind': BX.proxy_context}); BX.PreventDefault(e); }, this)}})
						]})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea-open-invite" }, children : [
						BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box" }, children: [
							BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box-element" }, children: [
								this.popupMessengerTextareaOpenText = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text" }, html: BX.message(this.BXIM.bitrixIntranet? 'IM_O_INVITE_TEXT': 'IM_O_INVITE_TEXT_SITE')})
							]})
						]}),
						this.popupMessengerTextareaOpenJoin = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-join bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept" }, html: BX.message('IM_O_INVITE_JOIN')})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea-general-invite" }, children : [
						BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box" }, children: [
							BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text-box-element" }, children: [
								this.popupMessengerTextareaGeneralText = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-text" }})
							]})
						]}),
						this.popupMessengerTextareaGeneralJoin = BX.create("div", { props : { className : "bx-messenger-textarea-open-invite-join bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept" }, html: BX.message('IM_G_JOIN_'+this.BXIM.userGender)})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea-resize" }, events : { mousedown : BX.delegate(this.resizeTextareaStart, this)}}),
					BX.create("div", { props : { className : "bx-messenger-textarea-send" }, children : [
						BX.create("a", {attrs: {href: "#send"}, props : { className : "bx-messenger-textarea-send-button" }, events : { click : BX.delegate(this.sendMessage, this)}}),
						this.popupMessengerTextareaSendType = BX.browser.IsMobile()? BX.create("span"): BX.create("span", {attrs : {title : BX.message('IM_M_SEND_TYPE_TITLE')}, props : { className : "bx-messenger-textarea-cntr-enter"}, html: this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter"), events: {
							click: BX.delegate(function() {
								if (this.popupMessengerTextareaPlace && this.popupMessengerTextareaPlace.className.indexOf('bx-messenger-textarea-with-text') == -1)
								{
									return false;
								}

								this.BXIM.settings.sendByEnter = this.BXIM.settings.sendByEnter? false: true;
								this.BXIM.saveSettings({'sendByEnter': this.BXIM.settings.sendByEnter});
								BX.proxy_context.innerHTML = this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");
							}, this)
						}})
					]}),
					this.popupMessengerTextareaIcons = BX.create("div", {props : { className : "bx-messenger-textarea-icons" }, children: [
						this.popupMessengerFileButton = this.disk.getFileMenuIcon(),
						this.BXIM.context == "LINES"? null: BX.create("div", {attrs : { title: BX.message('IM_MENTION_MENU')},  props : { className : "bx-messenger-textarea-mention" }, events : { click : BX.delegate(function(e){ this.openMentionDialog({delay: 0}); return BX.PreventDefault(e);}, this)}}),
						this.BXIM.context == "LINES"? null: BX.create("div", {attrs : { title: BX.message('IM_COMMAND_MENU')},  props : { className : "bx-messenger-textarea-command" }, events : { click : BX.delegate(function(e){ this.openCommandDialog(); return BX.PreventDefault(e);}, this)}}),
						this.popupMessengerSmileButton = BX.create("div", {attrs : { title: BX.message('IM_SMILE_MENU')},  props : { className : "bx-messenger-textarea-smile" }, events : { click : BX.delegate(function(e){this.openSmileMenu(); return BX.PreventDefault(e);}, this)}}),
						this.BXIM.context == "LINES"? null: BX.create("div", {attrs : { title: BX.message('IM_FORMS_MENU')},  props : { className : "bx-messenger-textarea-forms" }, events : { click : BX.delegate(function(e){this.openFormsMenu(); return BX.PreventDefault(e);}, this)}}),
						this.BXIM.context == "LINES"? null: BX.create("div", {attrs : { title: BX.message('IM_ANSWERS_MENU')},  props : { className : "bx-messenger-textarea-answers" }, events : { click : BX.delegate(function(e){this.openAnswersMenu(); return BX.PreventDefault(e);}, this)}}),
						this.popupMessengerHiddenModeButton = BX.create("div", {attrs : { title: BX.message('IM_HIDDEN_MODE_MENU')},  props : { className : "bx-messenger-textarea-hidden" }, events : { click : BX.delegate(function(e){ this.linesToggleSilentMode(); return BX.PreventDefault(e);}, this)}}),
						this.popupMessengerTextareaIconBox = BX.create("div", { props : { className : "bx-messenger-textarea-icon-box" }})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea" }, children : [
						this.popupMessengerTextarea = BX.create("textarea", { props : { value: (this.textareaHistory[userId]? this.textareaHistory[userId]: ''), className : "bx-messenger-textarea-input"}, style : {height: this.popupMessengerTextareaSize+'px'}}),
						this.popupMessengerTextareaPlaceholder = BX.create("div", { props : {className : "bx-messenger-textarea-placeholder"}, html : BX.message('IM_M_TA_TEXT')})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea-clear" }}),
					BX.MessengerCommon.isPage() && !BX.MessengerCommon.isDesktop()? null: BX.create("span", { props : { className : "bx-messenger-resize" }, events : BX.MessengerCommon.isPage()? {}: { mousedown : BX.delegate(this.resizeWindowStart, this)}})
				]})
			]})
		]}),
		/* EXTRA PANEL */
		this.popupMessengerExtra = BX.create("div", { props : { className : "bx-messenger-box-extra"}, style : {marginLeft: this.popupContactListSize+'px', height: this.popupMessengerFullHeight+'px'}})
	]});
	this.textareaCheckText();

	this.BXIM.dialogOpen = true;
	if (BX.MessengerCommon.isPage())
	{
		this.popupMessenger = new BX.PopupWindowDesktop(this.BXIM);
		BX.MessengerWindow.setTabContent('im', this.popupMessengerContent);
		BX.bind(this.popupMessengerContent, 'click', BX.delegate(this.closePopupFileMenu, this));
		this.disk.chatDialogInit();
		this.disk.chatAvatarInit();
	}
	else
	{
		this.popupMessenger = new BX.PopupWindow('bx-messenger-popup-messenger', null, {
			lightShadow : true,
			autoHide: false,
			closeByEsc: true,
			overlay: {opacity: 50, backgroundColor: "#000000"},
			draggable: {restrict: true},
			events : {
				onPopupShow : BX.delegate(function() {
					this.disk.chatDialogInit();
					this.disk.chatAvatarInit();
				}, this),
				onPopupClose : function() { this.destroy(); },
				onPopupDestroy : BX.delegate(function() {
					this.closeMessenger();
				}, this)
			},
			titleBar: {content: BX.create('div')},
			closeIcon : {'top': '10px', 'right': '13px'},
			content : this.popupMessengerContent,
			noAllPaddings : true,
			contentColor : "white"
		});
		this.popupMessenger.show();

		BX.bind(this.popupMessenger.popupContainer, "click", BX.MessengerCommon.preventDefault);
		if (this.webrtc.ready())
		{
			BX.addCustomEvent(this.popupMessenger, "onPopupDragStart", BX.delegate(function(){
				if (this.webrtc.callDialogAllow != null)
					this.webrtc.callDialogAllow.destroy();
			}, this));
		}
		BX.bind(document, "click", BX.proxy(this.BXIM.autoHide, this.BXIM));
		BX.bind(window, "keydown", BX.proxy(this.closePopupFileMenuKeydown, this));

		BX.addCustomEvent(this.popupMessenger, "onPopupFullscreenEnter", BX.delegate(function(){
			BX.addClass(this.popupMessengerContent, 'bx-messenger-fullscreen');

			this.messengerFullscreenStatus = true;
			this.resizeMainWindow();
			if (BX.browser.IsChrome())
			{
				setTimeout(BX.delegate(function(){
					this.resizeMainWindow();
				}, this), 100);
			}

			this.popupMessengerBody.scrollTop = this.popupMessengerBody.scrollHeight - this.popupMessengerBody.offsetHeight;

		}, this));

		BX.addCustomEvent(this.popupMessenger, "onPopupFullscreenLeave", BX.delegate(function(){

			BX.removeClass(this.popupMessengerContent, 'bx-messenger-fullscreen');
			if (BX.browser.IsChrome())
			{
				BX.addClass(this.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
				setTimeout(BX.delegate(function(){
					BX.removeClass(this.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
				}, this), 100);
			}
			this.resizeMainWindow();

			this.popupMessengerBody.scrollTop = this.popupMessengerBody.scrollHeight - this.popupMessengerBody.offsetHeight;
		}, this));
	}

	this.BXIM.setBackground();

	this.popupMessengerTopLine = BX.create("div", { props : { className : "bx-messenger-box-topline"}});
	this.popupMessengerContent.insertBefore(this.popupMessengerTopLine, this.popupMessengerContent.firstChild);

	if (!BX.MessengerCommon.isDesktop() && this.BXIM.bitrixIntranet && this.BXIM.platformName != '' && this.BXIM.settings.bxdNotify)
	{
		clearTimeout(this.popupMessengerDesktopTimeout);
		this.popupMessengerDesktopTimeout = setTimeout(BX.delegate(function(){
			var acceptButton = BX.delegate(function(){
				window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp");
				this.BXIM.settings.bxdNotify = false;
				this.BXIM.saveSettings({'bxdNotify': this.BXIM.settings.bxdNotify});
				this.hideTopLine();
			}, this);
			var declineButton = BX.delegate(function(){
				this.BXIM.settings.bxdNotify = false;
				this.BXIM.saveSettings({'bxdNotify': this.BXIM.settings.bxdNotify});
				this.hideTopLine();
			}, this);
			this.showTopLine(BX.message('IM_DESKTOP_INSTALL').replace('#WM_NAME#', BX.message('IM_WM')).replace('#OS#', this.BXIM.platformName), [
				{title: BX.message('IM_DESKTOP_INSTALL_Y'), callback: acceptButton},
				{title: BX.message('IM_DESKTOP_INSTALL_N'), callback: declineButton}
			], false);
		}, this), 15000);
	}

	this.textareaIconPrepare();

	BX.MessengerCommon.userListRedraw();
	if (this.BXIM.quirksMode)
	{
		this.popupContactListWrap.style.position = "absolute";
		this.popupContactListWrap.style.display = "block";
	}
	this.setUpdateStateStep();
	if (!(BX.browser.IsAndroid() || BX.browser.IsIOS() || window != window.top) && this.popupMessenger != null)
	{
		setTimeout(BX.delegate(function(){
			this.popupMessengerTextarea.focus();
		}, this), 50);
	}

	/* CL */
	if (this.webrtc.phoneEnabled && this.BXIM.design != 'DESKTOP')
	{
		BX.bind(this.popupContactListSearchCall, "click", BX.delegate(this.webrtc.openKeyPad, this.webrtc));
	}
	BX.bind(this.popupContactListWrap, "mouseover", BX.delegate(function(e) {
		if (this.popupContactListHovered || this.popupContactListActive)
			return false;

		clearTimeout(this.popupContactListWrapAnimation);
		this.popupContactListWrapAnimation = setTimeout(BX.delegate(function(){
			BX.addClass(this.popupContactListWrap, 'bx-messenger-box-contact-hover');
			clearTimeout(this.popupContactListWrapAnimation);
			this.popupContactListWrapAnimation = setTimeout(BX.delegate(function(){
				BX.removeClass(this.popupContactListWrap, 'bx-messenger-box-contact-normal');
			}, this), 100);
		}, this), 2000);

		this.popupContactListHovered = true;
	}, this));

	BX.bind(this.popupContactListWrap, "mouseout", BX.delegate(function(e) {
		if (!this.popupContactListHovered || this.popupContactListActive)
			return false;

		clearTimeout(this.popupContactListWrapAnimation);
		this.popupContactListWrapAnimation = setTimeout(BX.delegate(function(){
			BX.addClass(this.popupContactListWrap, 'bx-messenger-box-contact-normal');
			clearTimeout(this.popupContactListWrapAnimation);
			this.popupContactListWrapAnimation = setTimeout(BX.delegate(function(){
				BX.removeClass(this.popupContactListWrap, 'bx-messenger-box-contact-hover');
			}, this), 50);
		}, this), 400);

		this.popupContactListHovered = false;

	}, this));

	BX.bind(this.popupContactListCreateChat, "click",  BX.delegate(function(e) {
		if (!this.recentList)
		{
			this.recentList = true;
			BX.MessengerCommon.recentListRedraw();
		}
		this.openPopupMenu(e.currentTarget, 'createChat');
		return BX.PreventDefault(e);
	}, this));
	BX.bind(this.popupContactListSearchClose.parentNode, "click",  BX.delegate(function(){
		this.popupContactListSearchInput.focus();
	}, this));
	BX.bind(this.popupMessengerDialog, "click",  BX.delegate(function(e){
		if (this.recentList && !this.chatList && !this.contactList)
		{
			return false;
		}
		BX.MessengerCommon.contactListSearchClear(e);
	}, this));
	BX.bind(this.popupContactListSearchClose, "click",  BX.delegate(function(e){
		BX.MessengerCommon.contactListSearchClear(e);
		return BX.PreventDefault(e);
	}, BX.MessengerCommon));
	/*
	BX.bind(this.popupContactListSearchInput, "click", BX.delegate(function(e) {
		if (this.contactListSearchText.length == 0 && !this.contactList && e.altKey == true)
		{
			clearTimeout(this.BXIM.messenger.redrawChatListTimeout);
			BX.MessengerCommon.contactListPrepareOld();
		}
	}, this));
	*/
	BX.bind(this.popupContactListSearchInput, "focus", BX.delegate(function(e) {
		clearTimeout(this.BXIM.messenger.redrawChatListTimeout);
		this.BXIM.messenger.redrawChatListTimeout = setTimeout(BX.delegate(function(){
			if (this.contactListSearchText.length == 0 && !this.chatList && !this.contactList)
			{
				BX.MessengerCommon.chatListRedraw();
			}
		}, this), 100);
		this.setClosingByEsc(false);
	}, this));
	BX.bind(this.popupContactListSearchInput, "blur", BX.delegate(function(){
		if (this.contactListSearchText.length == 0 && !this.popupContactListHovered && !this.recentList)
		{
			this.setClosingByEsc(true);
		}
	}, this));
	if (BX.MessengerCommon.isDesktop())
	{
		BX.bind(this.popupContactListSearchInput, "contextmenu", BX.delegate(function(e) {
			this.openPopupMenu(e, 'copypaste', false, {'spell': true});
			return BX.PreventDefault(e);
		}, this));
	}
	BX.bind(this.popupContactListSearchInput, "keyup", BX.delegate(BX.MessengerCommon.contactListSearch, BX.MessengerCommon));

	BX.bind(this.popupMessengerPanelChatTitle, "click",  BX.delegate(this.renameChatDialog, this));

	BX.bindDelegate(this.popupMessengerPanelUsers, "click", {className: 'bx-messenger-panel-chat-user'}, BX.delegate(function(e){this.openPopupMenu(BX.proxy_context, 'chatUser'); return BX.PreventDefault(e);}, this));

	BX.bindDelegate(this.popupMessengerPanelUsers, "click", {className: 'bx-notifier-popup-user-more'}, BX.delegate(function(e) {
		if (this.popupChatUsers != null)
		{
			this.popupChatUsers.destroy();
			return false;
		}

		var chatId = this.getChatId();

		var userInChat = [];
		for (var i = 0; i < this.userInChat[chatId].length; i++)
		{
			var user = this.users[this.userInChat[chatId][i]];
			if (!user || !user.active)
			{
				continue;
			}

			if (this.chat[chatId].entity_type == "LINES" && this.chat[chatId].owner == 0 && user.id != this.BXIM.userId && !(user.bot || user.connector))
			{
				continue;
			}

			userInChat.push(this.userInChat[chatId][i]);
		}

		var htmlElement = '<span class="bx-notifier-item-help-popup">';
		for (var i = parseInt(BX.proxy_context.getAttribute('data-last-item')); i < userInChat.length; i++)
		{
			var user = this.users[userInChat[i]];
			var avatarColor = BX.MessengerCommon.isBlankAvatar(user.avatar)? 'style="background-color: '+user.color+'"': '';
			htmlElement += '<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+user.id+'">' +
				'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(user)+'">' +
					'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(user.avatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+user.avatar+'" '+avatarColor+'>' +
				'</span>' +
				'<span class="bx-notifier-item-help-popup-name  '+(user.extranet? ' bx-notifier-popup-avatar-extranet':'')+'">'+user.name+'</span>' +
			'</span>';
		}
		htmlElement += '</span>';

		this.popupChatUsers = new BX.PopupWindow('bx-messenger-popup-chat-users', BX.proxy_context, {
			//parentPopup: this.popupMessenger,
			zIndex: 200,
			lightShadow : true,
			offsetTop: -2,
			offsetLeft: 3,
			autoHide: true,
			closeByEsc: true,
			events : {
				onPopupClose : function() { this.destroy() },
				onPopupDestroy : BX.proxy(function() { this.popupChatUsers = null; }, this)
			},
			content : BX.create("div", { props : { className : "bx-messenger-popup-menu"+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, html: htmlElement})
		});
		this.popupChatUsers.setAngle({offset: BX.proxy_context.offsetWidth});
		this.popupChatUsers.show();

		BX.bindDelegate(this.popupChatUsers.popupContainer, "click", {className: 'bx-messenger-panel-chat-user'}, BX.delegate(function(e){this.openPopupMenu(BX.proxy_context, 'chatUser'); return BX.PreventDefault(e);}, this));

		return BX.PreventDefault(e);
	}, this));
	BX.bindDelegate(this.popupContactListElements, "contextmenu", {className: 'bx-messenger-cl-item'}, BX.delegate(function(e) {
		this.openPopupMenu(BX.proxy_context, 'contactList');
		return BX.PreventDefault(e);
	}, this));
	BX.bindDelegate(this.popupContactListElements, "click", {className: 'bx-messenger-cl-item'}, BX.delegate(BX.MessengerCommon.contactListClickItem, BX.MessengerCommon));
	BX.bindDelegate(this.popupContactListElements, "click", {className: 'bx-messenger-chatlist-group-add'}, BX.delegate(function(e){
		if (!this.recentList)
		{
			this.recentList = true;
			BX.MessengerCommon.recentListRedraw();
		}
		this.openChatCreateForm(BX.proxy_context.getAttribute('data-type'));
	}, this));

	BX.bindDelegate(this.popupContactListElements, "click", {className: 'bx-messenger-chatlist-more'}, BX.delegate(this.toggleChatListGroup, this));
	BX.bindDelegate(this.popupContactListElements, "click", {className: 'bx-messenger-chatlist-search-button'}, BX.delegate(function(){
		this.BXIM.messenger.chatListSearchAction(BX.proxy_context.parentNode);
	}, this));

	BX.bind(this.popupContactListElements, "scroll", BX.delegate(function() {
		if (this.popupPopupMenu != null && this.popupPopupMenuDateCreate+500 < (+new Date()) && this.popupPopupMenu.uniquePopupId.replace('bx-messenger-popup-','') == 'contactList')
		{
			this.popupPopupMenu.close();
		}
	}, this));

	BX.bind(this.contactListPanelStatus, "click", BX.delegate(function(e){this.openPopupMenu(this.contactListPanelStatus, 'status');  return BX.PreventDefault(e);}, this));
	if (this.contactListPanelSettings)
	{
		BX.bind(this.contactListPanelSettings, "click", BX.delegate(function(e){this.BXIM.openSettings(); BX.PreventDefault(e)}, this));
	}
	if (this.contactListPanelFull)
	{
		BX.bind(this.contactListPanelFull, "click", BX.delegate(function(e){
			this.popupMessenger.enterFullScreen(); BX.PreventDefault(e)
		}, this));
	}

	/* EDIT FORM */
	BX.bind(this.popupMessengerEditTextarea, "focus", BX.delegate(function() {
		this.setClosingByEsc(false);
	}, this));
	BX.bind(this.popupMessengerEditTextarea, "blur", BX.delegate(function() {
		this.setClosingByEsc(true);
	}, this));
	BX.bind(this.popupMessengerEditTextarea, "keydown", BX.delegate(function(event){
		this.textareaPrepareText(BX.proxy_context, event, BX.delegate(function(){
			BX.MessengerCommon.editMessageAjax(this.popupMessengerEditMessageId, this.popupMessengerEditTextarea.value);
		}, this), BX.delegate(function(){
			this.editMessageCancel();
		}, this));
	}, this));

	if (BX.MessengerCommon.isDesktop())
	{
		BX.bind(this.popupMessengerEditTextarea, "contextmenu", BX.delegate(function(e) {
			this.openPopupMenu(e, 'copypaste', false, {'spell': true});
			return BX.PreventDefault(e);
		}, this));
		BX.bind(this.popupMessengerTextarea, "contextmenu", BX.delegate(function(e) {
			this.openPopupMenu(e, 'copypaste', false, {'spell': true});
			return BX.PreventDefault(e);
		}, this));
		BX.bind(this.popupMessengerEditTextarea, "click", BX.delegate(function(e) {
			if (!(e.metaKey || e.ctrlKey) || !this.desktop.enableInVersion(34))
				return false;

			var selectedText = BX.desktop.clipboardSelected(this.popupMessengerEditTextarea, true);
			if (!selectedText.text)
				return false;

			BXDesktopSystem.SpellCheckWord(selectedText.text, BX.delegate(function(isCorrect, suggest){
				if (isCorrect || suggest.length <= 0)
					return false;

				var selectedText = BX.desktop.clipboardSelected(this.popupMessengerEditTextarea, true);
				BX.desktop.clipboardReplaceText(this.popupMessengerEditTextarea, selectedText.selectionStart, selectedText.selectionEnd, suggest[0]);
			}, this));
		}, this));
		BX.bind(this.popupMessengerTextarea, "click", BX.delegate(function(e) {
			if (!(e.metaKey || e.ctrlKey) || !this.desktop.enableInVersion(34))
				return false;

			var selectedText = BX.desktop.clipboardSelected(this.popupMessengerTextarea, true);
			if (!selectedText.text)
				return false;

			BXDesktopSystem.SpellCheckWord(selectedText.text, BX.delegate(function(isCorrect, suggest){
				if (isCorrect || suggest.length <= 0)
					return false
				var selectedText = BX.desktop.clipboardSelected(this.popupMessengerTextarea, true);
				BX.desktop.clipboardReplaceText(this.popupMessengerTextarea, selectedText.selectionStart, selectedText.selectionEnd, suggest[0]);
			}, this));
		}, this));
	}
	BX.bind(this.popupMessengerTextarea, "paste", BX.delegate(this.onPaste, this));
	BX.bind(this.popupMessengerTextarea, "focus", BX.delegate(function() {
		this.textareaCheckText();
		this.setClosingByEsc(false);
		BX.addClass(this.popupMessengerTextarea.parentNode, 'bx-messenger-textarea-focus');
		BX.onCustomEvent(window, 'onImTextareaFocus', [true]);
	}, this));
	BX.bind(this.popupMessengerTextarea, "blur", BX.delegate(function() {
		this.textareaCheckText();
		this.setClosingByEsc(true);
		BX.removeClass(this.popupMessengerTextarea.parentNode, 'bx-messenger-textarea-focus');
		BX.onCustomEvent(window, 'onImTextareaFocus', [false]);
	}, this));

	BX.bind(this.popupMessengerTextarea, "keydown", BX.delegate(function(event){
		this.textareaPrepareText(BX.proxy_context, event, BX.delegate(this.sendMessage, this), BX.delegate(function(){
			if (BX.util.trim(this.popupMessengerEditTextarea.value).length <= 0)
			{
				this.popupMessengerEditTextarea.value = "";
				if (this.popupMessenger && !this.BXIM.callController.hasActiveCall() && this.popupMessengerEditTextarea.value.length <= 0)
					this.popupMessenger.destroy();
			}
			else
			{
				this.popupMessengerEditTextarea.value = "";
			}
		},this));
	}, this));

	BX.bind(this.popupMessengerTextarea, "keyup", BX.delegate(this.textareaCheckText, this));

	if (BX.MessengerCommon.isDesktop())
	{
		BX.bindDelegate(this.popupMessengerBodyWrap, "contextmenu", {className: 'bx-messenger-content-item-content'}, BX.delegate(function(e) {
			this.openPopupMenu(e, 'dialogContext', false);
			return BX.PreventDefault(e);
		}, this));
	}

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-item-avatar-button'}, BX.delegate(function(e)
	{
		var userId = BX.proxy_context.parentNode.parentNode.getAttribute('data-senderId');
		if (!this.users[userId] || this.users[userId].fake)
			return false;

		var userName =  BX.util.htmlspecialcharsback(this.users[userId].name);
		if (e.metaKey || e.ctrlKey)
		{
			userName = '[USER='+userId+']'+userName+'[/USER]';
		}
		else
		{
			BX.MessengerCommon.addMentionList(this.currentTab, userName, userId);
		}

		this.insertTextareaText(this.popupMessengerTextarea, ' '+userName+' ', false);
		this.popupMessengerTextarea.focus();

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-attach-block-spoiler'}, BX.delegate(function(e) {
		var item = BX.findChildByClassName(BX.proxy_context, "bx-messenger-attach-block-value");
		if (BX.hasClass(BX.proxy_context, 'bx-messenger-attach-block-spoiler-show'))
		{
			height = item.getAttribute('data-min-height');
			BX.removeClass(BX.proxy_context, 'bx-messenger-attach-block-spoiler-show');
		}
		else
		{
			BX.addClass(BX.proxy_context, 'bx-messenger-attach-block-spoiler-show');
			height = item.getAttribute('data-max-height');
		}

		item.style.maxHeight = height+'px';
	}, this));


	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-item-menu'}, BX.delegate(function(e) {
		if (e.metaKey || e.ctrlKey)
		{
			var messageId = BX.proxy_context.parentNode.parentNode.getAttribute('data-blockmessageid');
			if (this.message[messageId] && this.users[this.message[messageId].senderId].name)
			{
				var arQuote = [];

				if (this.message[messageId].text)
				{
					arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
				}
				if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
				{
					for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
					{
						var fileId = this.message[messageId].params.FILE_ID[j];
						var chatId = this.message[messageId].chatId;
						if (this.disk.files[chatId][fileId])
						{
							arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
						}
					}
				}

				if (arQuote.length > 0)
				{
					this.insertQuoteText(this.users[this.message[messageId].senderId].name, this.message[messageId].date, arQuote.join("\n"));
				}
			}
		}
		else
		{
			this.openPopupMenu(BX.proxy_context, 'dialogMenu');
		}
		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-like-digit'}, BX.delegate(function(e)
	{
		BX.localStorage.set('implc', true, 1);

		var messageId = BX.proxy_context.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute('data-blockmessageid');
		if (messageId.substr(0,4) == 'temp' || !this.message[messageId].params || !this.message[messageId].params['LIKE'] || this.message[messageId].params['LIKE'].length <= 0)
			return false;

		if (this.popupChatUsers != null)
		{
			this.popupChatUsers.destroy();
			return false;
		}

		var htmlElement = '<span class="bx-notifier-item-help-popup">';
		for (var i = 0; i < this.message[messageId].params['LIKE'].length; i++)
		{
			if (this.users[this.message[messageId].params['LIKE'][i]])
			{
				var avatarColor = BX.MessengerCommon.isBlankAvatar(this.users[this.message[messageId].params['LIKE'][i]].avatar)? 'style="background-color: '+this.users[this.message[messageId].params['LIKE'][i]].color+'"': '';
				htmlElement += '<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+this.message[messageId].params['LIKE'][i]+'">' +
					'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(this.users[this.message[messageId].params['LIKE'][i]])+'">' +
						'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.users[this.message[messageId].params['LIKE'][i]].avatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+this.users[this.message[messageId].params['LIKE'][i]].avatar+'" '+avatarColor+'>' +
					'</span>' +
					'<span class="bx-notifier-item-help-popup-name  '+(this.users[this.message[messageId].params['LIKE'][i]].extranet? ' bx-notifier-popup-avatar-extranet':'')+'">'+this.users[this.message[messageId].params['LIKE'][i]].name+'</span>' +
				'</span>';
			}
		}
		htmlElement += '</span>';

		this.popupChatUsers = new BX.PopupWindow('bx-messenger-popup-like-users', BX.proxy_context, {
			//parentPopup: this.popupMessenger,
			zIndex: 200,
			lightShadow : true,
			offsetTop: 5,
			offsetLeft: 12,
			autoHide: true,
			closeByEsc: true,
			bindOptions: {position: "top"},
			events : {
				onPopupClose : function() { this.destroy() },
				onPopupDestroy : BX.proxy(function() { this.popupChatUsers = null; }, this)
			},
			content : BX.create("div", { props : { className : "bx-messenger-popup-menu"+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, html: htmlElement})
		});
		this.popupChatUsers.setAngle({offset: BX.proxy_context.offsetWidth});
		this.popupChatUsers.show();

		BX.bindDelegate(this.popupChatUsers.popupContainer, "click", {className: 'bx-messenger-panel-chat-user'}, BX.delegate(function(e){this.openPopupMenu(BX.proxy_context, 'chatUser'); return BX.PreventDefault(e);}, this));

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-keyboard-button-text'}, BX.delegate(BX.MessengerCommon.clickButtonKeyboard, BX.MessengerCommon));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-like-button'}, BX.delegate(function(e) {
		var chatId = this.getChatId();
		if (this.openChatFlag && !BX.MessengerCommon.userInChat(chatId))
		{
			return false;
		}
		if (BX.localStorage.get('implc', true, 1))
		{
			return false;
		}
		var messageId = BX.proxy_context.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute('data-blockmessageid');
		BX.MessengerCommon.messageLike(messageId);

		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-attach-delete'}, BX.delegate(function(e) {
		var messageId = BX.proxy_context.getAttribute('data-messageId');
		var attachId = BX.proxy_context.getAttribute('data-attachId');
		var action = BX.proxy_context.getAttribute('data-action');

		if (action == 'url')
		{
			BX.MessengerCommon.messageUrlAttachDelete(messageId, attachId);
		}

		return BX.PreventDefault(e);
	}, this));

	BX.bind(this.popupMessengerTextareaOpenJoin, 'click', BX.delegate(function() {
		if (this.currentTab.substr(0, 4) != 'chat')
			return false;

		if (this.BXIM.messenger.popupMessengerDialog && BX.hasClass(this.BXIM.messenger.popupMessengerDialog, "bx-messenger-chat-load-last-message"))
		{
			return false;
		}

		var chatId = this.currentTab.substr(4);
		BX.MessengerCommon.joinToChat(chatId);

		return true;
	}, this));

	BX.bind(this.popupMessengerTextareaGeneralJoin, 'click', BX.delegate(function() {
		if (this.BXIM.messenger.popupMessengerDialog && BX.hasClass(this.BXIM.messenger.popupMessengerDialog, "bx-messenger-chat-load-last-message"))
		{
			return false;
		}

		this.BXIM.settings.generalNotify = false;

		this.BXIM.saveSettings({'generalNotify': this.BXIM.settings.generalNotify});
		this.redrawChatHeader({userRedraw: false});

		this.popupMessengerTextarea.focus();

		return true;
	}, this));

	BX.bind(this.popupMessengerTextareaOpenLinesAnswer, 'click', BX.delegate(function() {
		if (this.currentTab.substr(0, 4) != 'chat')
			return false;

		if (this.BXIM.messenger.popupMessengerDialog && BX.hasClass(this.BXIM.messenger.popupMessengerDialog, "bx-messenger-chat-load-last-message"))
		{
			return false;
		}

		var chatId = this.currentTab.substr(4);
		if (!BX.MessengerCommon.userInChat(chatId))
		{
			var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);
			if (parseInt(session.id) <= 0)
			{
				BX.MessengerCommon.linesStartSession(chatId);
			}
			else if (parseInt(this.chat[chatId].owner) == 0)
			{
				BX.MessengerCommon.linesAnswer(chatId);
			}
			else
			{
				BX.MessengerCommon.linesJoinSession(chatId);
			}
		}
		else
		{
			BX.MessengerCommon.linesAnswer(chatId);
		}

		return true;
	}, this));

	BX.bind(this.popupMessengerTextareaOpenLinesSkip, 'click', BX.delegate(function() {
		if (this.currentTab.substr(0, 4) != 'chat')
			return false;

		if (this.BXIM.messenger.popupMessengerDialog && BX.hasClass(this.BXIM.messenger.popupMessengerDialog, "bx-messenger-chat-load-last-message"))
		{
			return false;
		}

		var chatId = this.currentTab.substr(4);
		if (!BX.MessengerCommon.userInChat(chatId))
			BX.MessengerCommon.dialogCloseCurrent(true);
		else
			BX.MessengerCommon.linesSkip(chatId);

		return true;
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-ajax'}, BX.delegate(function() {
		if (BX.proxy_context.getAttribute('data-entity') == 'readedList')
		{
			this.openPopupExternalData(BX.proxy_context, 'readedList', true, {'TAB': this.BXIM.messenger.currentTab})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'user')
		{
			this.openPopupExternalData(BX.proxy_context, 'user', true, {'ID': BX.proxy_context.getAttribute('data-userId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'openlines')
		{
			this.linesOpenHistory(BX.proxy_context.getAttribute('data-sessionId'));
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'chat')
		{
			this.openPopupExternalData(BX.proxy_context, 'chat', true, {'ID': BX.proxy_context.getAttribute('data-chatId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'network')
		{
			this.openMessenger('network'+BX.proxy_context.getAttribute('data-networkId'))
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'date')
		{
			this.openPopupMenu(BX.proxy_context, 'shareMenu');
		}
		else if (this.webrtc.phoneSupport() && BX.proxy_context.getAttribute('data-entity') == 'phoneCallHistory')
		{
			this.openPopupExternalData(BX.proxy_context, 'phoneCallHistory', true, {'ID': BX.proxy_context.getAttribute('data-historyID')})
		}
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-command'}, BX.delegate(function() {
		if (BX.proxy_context.getAttribute('data-entity') == 'send')
		{
			this.BXIM.sendMessage(this.currentTab, BX.proxy_context.nextSibling.innerHTML);
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'put')
		{
			this.BXIM.putMessage(BX.proxy_context.nextSibling.innerHTML);
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'call')
		{
			this.BXIM.phoneTo(BX.proxy_context.getAttribute('data-command'));
		}
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-item-date'}, BX.delegate(function(e) {
		if (this.openLinesFlag &&
			//TODO: FIX 0109478
			BX.hasClass(BX.proxy_context.parentNode.parentNode.parentNode.parentNode, 'bx-messenger-content-item-system'))
		{
			this.tooltip(BX.proxy_context, BX.message('IM_TIP_OL_SYSTEM'), {offsetLeft: 48});
		}
		BX.PreventDefault(e);
	}, this));

	BX.bind(this.popupMessengerBody, "scroll", BX.delegate(function(e) {
		if (this.unreadMessage[this.currentTab] && this.unreadMessage[this.currentTab].length > 0 && BX.MessengerCommon.isScrollMax(this.popupMessengerBody, 200) && this.BXIM.isFocus())
		{
			clearTimeout(this.readMessageTimeout);
			this.readMessageTimeout = setTimeout(BX.delegate(function ()
			{
				BX.MessengerCommon.readMessage(this.currentTab);
			}, this), 100);
		}

		BX.MessengerCommon.redrawDateMarks();
		BX.MessengerCommon.loadHistory(this.currentTab, false);

		if (this.popupPopupMenu != null)
		{
			if (this.popupPopupMenuDateCreate+500 < (+new Date()) && BX.util.in_array(this.popupPopupMenu.uniquePopupId.replace('bx-messenger-popup-',''), ["copypaste", "copylink", "dialogContext", "dialogMenu", "external-data"]))
			{
				this.popupPopupMenu.close();
			}
			else if (false && BX.util.in_array(this.popupPopupMenu.uniquePopupId.replace('bx-messenger-popup-',''), ["dialogMenu", "external-data"]))
			{
				this.popupPopupMenu.adjustPosition();
			}
		}
		if (this.popupChatUsers != null && this.popupChatUsers.uniquePopupId.replace('bx-messenger-popup-','') == 'like-users')
		{
			this.popupChatUsers.close();
		}
		if (this.popupTooltip != null)
		{
			this.popupTooltip.close();
		}
	}, this));

	BX.bindDelegate(this.popupMessengerBodyWrap, 'click', {className: 'bx-messenger-content-item-error'}, BX.delegate(BX.MessengerCommon.sendMessageRetry, BX.MessengerCommon));

	if (userId == 0)
	{
		this.extraOpen(
			BX.create("div", { props : { className : "bx-messenger-box-hello-wrap" }, children: [
				BX.create("div", { props : { className : "bx-messenger-box-hello" }, html: BX.message('IM_M_EMPTY')})
			]})
		);
	}
	else
	{
		BX.MessengerCommon.openDialog(userId);
	}
};

BX.MessengerChat.prototype.closeMessenger = function()
{
	if (!this.popupMessenger || this.BXIM.callController.hasActiveCall())
		return false;

	if (this.BXIM.popupSettings != null)
		this.BXIM.popupSettings.close();

	if (this.webrtc.callInit)
	{
		this.webrtc.callCommand(this.webrtc.callChatId, 'decline', {'ACTIVE': this.callActive? 'Y': 'N', 'INITIATOR': this.initiator? 'Y': 'N'});
		this.webrtc.callAbort();
	}
	this.closeMenuPopup();

	this.popupMessenger = null;
	BX.remove(this.popupMessengerContent);
	this.popupMessengerContent = null;
	this.mentionListen = false;
	this.mentionDelimiter = '';
	this.BXIM.extraOpen = false;
	this.BXIM.dialogOpen = false;
	this.BXIM.notifyOpen = false;

	clearTimeout(this.popupMessengerDesktopTimeout);

	this.setUpdateStateStep();
	BX.unbind(document, "click", BX.proxy(this.BXIM.autoHide, this.BXIM));
	BX.unbind(window, "keydown", BX.proxy(this.closePopupFileMenuKeydown, this));
	this.webrtc.callOverlayClose();

	return true;
}

BX.MessengerChat.prototype.openMessengerPanel = function()
{
	if (!this.popupMessengerBodyPanel)
		return false;

	this.popupMessengerPanelOpen = true;

	this.popupMessengerBody.style.width = "calc(100% - 400px)";
	this.popupMessengerTextareaPlace.style.width = "calc(100% - 400px)";
	this.popupMessengerBodyPanel.style.height = this.popupMessengerBodyDialog.offsetHeight+'px';
	this.popupMessengerBodyPanel.style.right = "0";

	return true;
}

BX.MessengerChat.prototype.closeMessengerPanel = function()
{
	if (!this.popupMessengerBodyPanel)
		return false;

	this.popupMessengerPanelOpen = false;

	this.popupMessengerBody.style.removeProperty('width');
	this.popupMessengerTextareaPlace.style.removeProperty('width');
	this.popupMessengerBodyPanel.style.removeProperty('right');

	return true;
}

BX.MessengerChat.prototype.enterFullScreen = function()
{
  if (this.messengerFullscreenStatus)
  {
	  if (document.cancelFullScreen)
		  document.cancelFullScreen();
	  else if (document.mozCancelFullScreen)
		  document.mozCancelFullScreen();
	  else if (document.webkitCancelFullScreen)
		  document.webkitCancelFullScreen();
  }
  else
   {
	  if (BX.browser.IsChrome() || BX.browser.IsSafari())
	  {
		  this.popupMessengerContent.webkitRequestFullScreen(this.popupMessengerContent.ALLOW_KEYBOARD_INPUT);
		  BX.bind(window, "webkitfullscreenchange", this.messengerFullscreenBind = BX.proxy(this.eventFullScreen, this));
	  }
	  else if (BX.browser.IsFirefox())
	  {
		  this.popupMessengerContent.mozRequestFullScreen(this.popupMessengerContent.ALLOW_KEYBOARD_INPUT);
		  BX.bind(window, "mozfullscreenchange", this.messengerFullscreenBind = BX.proxy(this.eventFullScreen, this));
	  }
  }
};

BX.MessengerChat.prototype.eventFullScreen = function(event)
{
	if (this.messengerFullscreenStatus)
	{
		if (BX.browser.IsChrome() || BX.browser.IsSafari())
			BX.unbind(window, "webkitfullscreenchange", this.messengerFullscreenBind);
		else if (BX.browser.IsFirefox())
			BX.unbind(window, "mozfullscreenchange", this.messengerFullscreenBind);

		BX.removeClass(this.popupMessengerContent, 'bx-messenger-fullscreen');
		if (BX.browser.IsChrome())
		{
			BX.addClass(this.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
			setTimeout(BX.delegate(function(){
				BX.removeClass(this.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
			}, this), 100);
		}
		this.messengerFullscreenStatus = false;
		this.resizeMainWindow();
		this.popupMessenger.adjustPosition();
	}
	else
	{
		BX.addClass(this.popupMessengerContent, 'bx-messenger-fullscreen');
		this.messengerFullscreenStatus = true;
		this.resizeMainWindow();
		if (BX.browser.IsChrome())
		{
			setTimeout(BX.delegate(function(){
				  this.resizeMainWindow();
			}, this), 100);
		}
	}
	this.popupMessengerBody.scrollTop = this.popupMessengerBody.scrollHeight - this.popupMessengerBody.offsetHeight;
};

BX.MessengerChat.prototype.tooltip = function(bind, text, params)
{
	if (this.tooltipIsOpen())
		this.popupTooltip.close();

	params = params || {};

	params.offsetLeft = params.offsetLeft || 0;
	params.offsetTop = params.offsetTop || BX.MessengerCommon.isDesktop()? 0: -10;
	params.width = params.width || 0;
	params.angle = typeof(params.angle) == 'undefined'? true: params.angle;
	params.showOnce = typeof(params.showOnce) == 'undefined'? false: params.showOnce;
	params.bindOptions = typeof(params.bindOptions) == 'undefined'? {position: "top"}: params.bindOptions;
	if (params.showOnce)
	{
		if (this.tooltipShowed[params.showOnce])
		{
			return true;
		}
		else
		{
			BX.userOptions.save('im', 'tooltipShowed', params.showOnce, 1);
			this.tooltipShowed[params.showOnce] = 1;
		}
	}

	var content = null;

	if (typeof(text) == 'object')
	{
		content = BX.create("div", { props : { className: "bx-messenger-tooltip", style : "padding-right: 5px;"+(params.width>0? "width: "+params.width+"px;": '') }, children: [text]})
	}
	else
	{
		content = BX.create("div", { props : { className: "bx-messenger-tooltip", style : "padding-right: 5px;"+(params.width>0? "width: "+params.width+"px;": '') }, html: text})
	}

	this.popupTooltip = new BX.PopupWindow('bx-messenger-tooltip', bind, {
		//parentPopup: this.popupMessenger,
		lightShadow: true,
		autoHide: true,
		darkMode: true,
		offsetLeft: params.offsetLeft,
		offsetTop: params.offsetTop,
		closeIcon : {},
		bindOptions: params.bindOptions,
		events : {
			onPopupClose : function() {this.destroy(); },
			onPopupDestroy : BX.delegate(function() { this.popupTooltip = null; }, this)
		},
		zIndex: 2000,
		content: content
	});
	if (params.angle)
	{
		this.popupTooltip.setAngle({offset:23, position: params.bindOptions.position == 'top'? 'bottom': 'top'});
	}
	this.popupTooltip.show();

	return true;
};
BX.MessengerChat.prototype.tooltipIsOpen = function()
{
	return this.popupTooltip != null;
}
BX.MessengerChat.prototype.tooltipClose = function()
{
	if (this.tooltipIsOpen())
		this.popupTooltip.close();
}

BX.MessengerChat.prototype.dialogStatusRedraw = function(params)
{
	if (this.popupMessenger == null)
		return false;

	params = params || {};

	this.popupMessengerPanelButtonCall1.className = this.callButtonStatus(this.currentTab);
	this.popupMessengerPanelButtonCall2.className = this.callButtonStatus(this.currentTab);
	this.popupMessengerPanelButtonCall3.className = this.phoneButtonStatus();

	if (this.popupMessengerFileButton)
		BX.show(this.popupMessengerFileButton);

	this.popupMessengerPanel.className = this.openChatFlag? 'bx-messenger-panel bx-messenger-context-user bx-messenger-hide': 'bx-messenger-panel bx-messenger-context-user';

	clearInterval(this.popupMessengerPanelLastDateInterval);

	if (this.openChatFlag)
	{
		this.textareaIconToggle();
		this.redrawChatHeader(params);
	}
	else if (this.users[this.currentTab])
	{
		BX.style(this.popupOpenLinesSpam, 'display', '');

		if (this.popupMessengerFileFormChatId)
		{
			this.popupMessengerFileFormChatId.value = this.userChat[this.currentTab]? this.userChat[this.currentTab]: 0;
			if (!this.disk.enableExternal && (this.users[this.currentTab].bot || this.users[this.currentTab].network))
			{
				this.popupMessengerFileFormInput.setAttribute('disabled', true);
			}
			else
			{
				if (parseInt(this.popupMessengerFileFormChatId.value) > 0)
				{
					this.popupMessengerFileFormInput.removeAttribute('disabled');
				}
				else
				{
					this.popupMessengerFileFormInput.setAttribute('disabled', true);
				}
			}
		}

		if (this.openChatFlag)
		{
			this.popupMessengerPanelMute.title = this.muteButtonStatus(this.currentTab)? BX.message("IM_M_CHAT_MUTE_ON_2"): BX.message("IM_M_CHAT_MUTE_OFF_2");
		}
		else
		{
			this.popupMessengerPanelMute.title = this.muteButtonStatus(this.currentTab)? BX.message("IM_M_USER_BLOCK_OFF"): BX.message("IM_M_USER_BLOCK_ON");
		}
		this.popupMessengerPanelMute.className = "bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)? ' bx-messenger-panel-unmute': '');

		this.popupMessengerPanelAvatar.parentNode.href = this.users[this.currentTab].profile;
		this.popupMessengerPanelAvatar.parentNode.className = 'bx-messenger-panel-avatar bx-messenger-panel-avatar-status-'+BX.MessengerCommon.getUserStatus(this.users[this.currentTab]);
		this.popupMessengerPanelAvatar.parentNode.title = (BX.MessengerCommon.getUserStatus(this.users[this.currentTab], false)).title;
		this.popupMessengerPanelAvatar.src = this.users[this.currentTab].avatar? this.users[this.currentTab].avatar: this.BXIM.pathToBlankImage;
		this.popupMessengerPanelAvatar.className = "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar.src)? " bx-messenger-panel-avatar-img-default": "");
		BX.style(this.popupMessengerPanelAvatar, "background-color", (BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar.src) && this.users[this.currentTab].color? this.users[this.currentTab].color: ""));

		this.popupMessengerPanelTitle.href = this.users[this.currentTab].profile;
		this.popupMessengerPanelTitle.innerHTML = this.users[this.currentTab].name;
		if (this.BXIM.userId == this.currentTab)
		{
			this.popupMessengerPanelTitle.innerHTML = this.popupMessengerPanelTitle.innerHTML+' (<b><i>'+BX.message('IM_YOU')+'</i></b>)';
		}

		var funcUpdateLastDate = BX.delegate(function()
		{
			if (!this.popupMessengerPanelLastDate || this.currentTab && this.currentTab.toString().substr(0, 4) == 'chat')
				return false;

			var titleLastDate = BX.MessengerCommon.getUserLastDate(this.users[this.currentTab]);
			this.popupMessengerPanelLastDate.innerHTML = titleLastDate? '. '+titleLastDate: '';

			return true;
		}, this);
		funcUpdateLastDate();

		this.popupMessengerPanelLastDateInterval = setInterval(funcUpdateLastDate, 60000);

		this.popupMessengerPanelStatus.innerHTML = BX.MessengerCommon.getUserPosition(this.users[this.currentTab], false);

		var removeClass = [];
		if (this.users[this.currentTab].extranet)
		{
			BX.addClass(this.popupMessengerPanelTitle, 'bx-messenger-user-extranet');
			BX.addClass(this.popupMessengerDialog, 'bx-messenger-dialog-extranet');
			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-bot');
			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-network');
			removeClass.push('bx-messenger-chat-livechat');
			removeClass.push('bx-messenger-chat-lines');
			removeClass.push('bx-messenger-dialog-bot');
			removeClass.push('bx-messenger-dialog-network');
			removeClass.push('bx-messenger-dialog-self');
		}
		else if (this.users[this.currentTab].bot)
		{
			if (this.bot[this.currentTab] && this.bot[this.currentTab].type == 'network')
			{
				BX.addClass(this.popupMessengerPanelTitle, 'bx-messenger-user-network');
				BX.addClass(this.popupMessengerDialog, 'bx-messenger-dialog-network');
				BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-bot');
				BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-bot');
			}
			else
			{
				BX.addClass(this.popupMessengerPanelTitle, 'bx-messenger-user-bot');
				BX.addClass(this.popupMessengerDialog, 'bx-messenger-dialog-bot');
				BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-network');
				BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-network');
			}

			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-extranet');
			removeClass.push('bx-messenger-chat-livechat');
			removeClass.push('bx-messenger-chat-lines');
			removeClass.push('bx-messenger-dialog-extranet');
			removeClass.push('bx-messenger-dialog-self');

			this.popupMessengerPanelBotIcons = true;
		}
		else
		{
			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-extranet');
			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-bot');
			BX.removeClass(this.popupMessengerPanelTitle, 'bx-messenger-user-network');
			removeClass.push('bx-messenger-dialog-bot')
			removeClass.push('bx-messenger-dialog-network')
			removeClass.push('bx-messenger-chat-livechat');
			removeClass.push('bx-messenger-chat-lines');
			removeClass.push('bx-messenger-dialog-extranet');

			if (this.BXIM.userId == this.currentTab)
			{
				BX.addClass(this.popupMessengerDialog, 'bx-messenger-dialog-self');
			}
			else
			{
				removeClass.push('bx-messenger-dialog-self');
			}
		}
		this.popupMessengerTextarea.disabled = false;

		this.textareaIconToggle();

		removeClass.push('bx-messenger-chat-guest');
		removeClass.push('bx-messenger-chat-open');
		removeClass.push('bx-messenger-chat-chat');
		removeClass.push('bx-messenger-chat-call');
		removeClass.push('bx-messenger-chat-general');
		removeClass.push('bx-messenger-chat-general-first-open');
		removeClass.push('bx-messenger-chat-general-access');

		BX.removeClass(this.popupMessengerDialog, removeClass.join(" "));
	}

	return true;
};

BX.MessengerChat.prototype.muteButtonStatus = function(dialogId)
{
	var chatId = 0;
	if (dialogId.toString().substr(0,4) == 'chat')
	{
		chatId = dialogId.toString().substr(4);
	}
	else
	{
		chatId = this.userChat[dialogId];
	}
	return this.userChatBlockStatus[chatId] && this.userChatBlockStatus[chatId][this.BXIM.userId];
}

BX.MessengerChat.prototype.callButton = function(type)
{
	var button = null;
	if (type == 'call')
	{
		button = BX.create("span", {props : {className : this.phoneButtonStatus()}, children: [
			BX.create("a", {
				attrs: { href: "#call", title: BX.message("IM_PHONE_CALL") },
				props : { className : 'bx-messenger-panel-button bx-messenger-panel-call-audio' },
				events : {
					click: BX.delegate(function(e){
						if (this.BXIM.callController.hasActiveCall())
							return false;

						var currentChat = this.chat[this.getChatId()];
						if (currentChat.call_number)
						{
							this.BXIM.phoneTo(currentChat.call_number);
						}
						else
						{
							this.webrtc.openKeyPad();
						}

						BX.PreventDefault(e);
					}, this)
				},
				html: BX.message("IM_PHONE_CALL")
			})
		]});
	}
	else
	{
		button = BX.create("span", {props : {className : this.callButtonStatus(this.currentTab)}, children: [
			BX.create("a", {
				attrs: { href: "#call", title: BX.message("IM_M_CALL_VIDEO") },
				props : { className : 'bx-messenger-panel-button bx-messenger-panel-call-video' },
				events : {
					click: BX.delegate(function(e){
						if (!this.BXIM.callController.hasActiveCall())
							this.BXIM.callTo(this.currentTab, true);
						BX.PreventDefault(e);
					}, this)
				},
				html: BX.message("IM_M_CALL_VIDEO")
			}),
			BX.create("a", {
				attrs: { href: "#callMenu" },
				props : { className : 'bx-messenger-panel-call-menu' },
				events : {
					click: BX.delegate(function(e){
						if (!this.BXIM.callController.hasActiveCall())
							this.openPopupMenu(BX.proxy_context, 'callMenu');
						BX.PreventDefault(e);
					}, this)
				}
			})
		]});
	}
	return button;
};

BX.MessengerChat.prototype.callButtonStatus = function(dialogId)
{
	dialogId = dialogId.toString();
	var elementClassName = 'bx-messenger-panel-button-box bx-messenger-panel-call-hide';
	if (this.openChatFlag && this.chat[dialogId.substr(4)] && (this.chat[dialogId.substr(4)].type == 'lines' || this.chat[dialogId.substr(4)].type == 'livechat'))
	{

	}
	else if (this.BXIM.ppServerStatus && (!this.users[dialogId] || !this.users[dialogId].network))
	{
		elementClassName = (!this.BXIM.checkCallSupport(dialogId) || this.BXIM.callController.hasActiveCall())? 'bx-messenger-panel-button-box bx-messenger-panel-call-disabled': 'bx-messenger-panel-button-box bx-messenger-panel-call-enabled';
	}

	return elementClassName;
};

BX.MessengerChat.prototype.phoneButtonStatus = function()
{
	var elementClassName = 'bx-messenger-panel-call-hide';
	if (this.BXIM.ppServerStatus)
		elementClassName = (this.webrtc.phoneSupport() && this.webrtc.phoneCanPerformCalls ? 'bx-messenger-panel-call-enabled': 'bx-messenger-panel-call-disabled');

	return 'bx-messenger-panel-call-phone '+elementClassName;
};

/* CHAT */
BX.MessengerChat.prototype.chatListSearchAction = function(element)
{
	this.realSearch = true;

	this.popupContactListElementsWrap.appendChild(BX.create("div", {
		props : { className: "bx-messenger-cl-item-search"},
		html : BX.message('IM_M_CL_SEARCH')
	}));
	BX.remove(element);

	BX.MessengerCommon.contactListRealSearch(this.contactListSearchText);
}
BX.MessengerChat.prototype.toggleChatListGroup = function()
{
	if (BX.hasClass(BX.proxy_context.parentNode.parentNode, 'bx-messenger-chatlist-show-all'))
	{
		this.contactListShowed[BX.proxy_context.getAttribute('data-id')] = false;
		BX.proxy_context.innerHTML = BX.proxy_context.getAttribute('data-text');
		BX.removeClass(BX.proxy_context.parentNode.parentNode, 'bx-messenger-chatlist-show-all');
		if(this.popupContactListElements)
		{
			var pos = BX.pos(BX.proxy_context, true);
			this.popupContactListElements.scrollTop = pos.top-100;
		}
	}
	else
	{
		this.contactListShowed[BX.proxy_context.getAttribute('data-id')] = true;
		BX.proxy_context.innerHTML = BX.message('IM_CL_HIDE');
		BX.addClass(BX.proxy_context.parentNode.parentNode, 'bx-messenger-chatlist-show-all');
	}
}

BX.MessengerChat.prototype.openChatCreateForm = function(type)
{
	this.currentTab = 'create';

	var descriptionNodes = []
	var avatarColor = "";
	var placeholder = "";
	if (type == 'chat')
	{
		avatarColor = "#49afdf";
		descriptionNodes = [
			BX.create("div", { props : { className : "bx-messenger-box-create-icon bx-messenger-box-create-icon-"+type}, children: [
				BX.create("div", { props : { className : "bx-messenger-box-create-icon-image"}})
			]}),
			BX.create("div", { props : { className : "bx-messenger-box-create-title"}, html: BX.message('IM_CL_CHAT_2')}),
			BX.create("div", { props : { className : "bx-messenger-box-create-text"}, html: BX.message(this.BXIM.bitrixIntranet? 'IM_C_ABOUT_CHAT': 'IM_C_ABOUT_CHAT_CHAT').split('#BR#').join("<br />").replace('#PROFILE_END#', '</a>').replace('#PROFILE_START#', '<a href="'+BXIM.path.profile+'edit/" target="_blank">')})
		];
	}
	else if (type == 'open' && (!this.BXIM.userExtranet || this.openChatEnable))
	{
		avatarColor = "#a7c131";

		descriptionNodes = [
			BX.create("div", { props : { className : "bx-messenger-box-create-icon bx-messenger-box-create-icon-"+type}, children: [
				BX.create("div", { props : { className : "bx-messenger-box-create-icon-image"}})
			]}),
			BX.create("div", { props : { className : "bx-messenger-box-create-title"}, html: BX.message('IM_CL_OPEN_CHAT')}),
			BX.create("div", { props : { className : "bx-messenger-box-create-text"}, html: BX.message(this.BXIM.bitrixIntranet? 'IM_C_ABOUT_OPEN': 'IM_C_ABOUT_OPEN_SITE').split('#BR#').join("<br />").replace('#PROFILE_END#', '</a>').replace('#PROFILE_START#', '<a href="'+BXIM.path.profile+'edit/" target="_blank">').replace('#CHAT_END#', '</b>').replace('#CHAT_START#', '<b>')})
		];
	}
	else
	{
		type = 'private';
		avatarColor = this.users[this.BXIM.userId].color;

		descriptionNodes = [
			BX.create("div", { props : { className : "bx-messenger-box-create-icon bx-messenger-box-create-icon-"+type}, children: [
				BX.create("div", { props : { className : "bx-messenger-box-create-icon-image"}})
			]}),
			BX.create("div", { props : { className : "bx-messenger-box-create-title"}, html: BX.message('IM_CL_PRIVATE_CHAT')}),
			BX.create("div", { props : { className : "bx-messenger-box-create-text"}, html: BX.message(this.BXIM.bitrixIntranet? 'IM_C_ABOUT_PRIVATE': 'IM_C_ABOUT_PRIVATE_SITE').split('#BR#').join("<br />").replace('#PROFILE_END#', '</a>').replace('#PROFILE_START#', '<a href="'+BXIM.path.profile+'edit/" target="_blank">')})
		];
	}

	if (this.chatCreateForm && !BX.browser.IsIE11())
	{
		this.extraOpen(this.chatCreateForm);

		if (this.chatCreateFormAvatar.parentNode)
		{
			this.chatCreateFormAvatar.parentNode.className = "bx-messenger-panel-avatar bx-messenger-panel-avatar-"+type;
		}
		BX.style(this.chatCreateFormAvatar, 'background-color', avatarColor);

		this.chatCreateType = type;
		this.chatCreateUsers = {};

		this.chatCreateFormDescription.innerHTML = '';
		BX.adjust(this.chatCreateFormDescription, {children: descriptionNodes});

		BX.MessengerCommon.clearMentionList('create');

		this.chatCreateFormChatTitle.value = '';
		this.chatCreateFormUsersInput.value = '';
		this.chatCreateFormUsersDest.innerHTML = '';

		this.popupCreateChatTextarea.value = '';
		this.textareaCheckText({'textarea': 'createChat'});

		BX.style(this.chatCreateFormBody, 'height', this.popupMessengerBodySize+'px');
		BX.style(this.popupCreateChatTextarea, 'height', this.popupMessengerTextareaSize+'px');

		if (type == 'open')
		{
			BX.addClass(this.chatCreateFormUsersInput.parentNode.parentNode, 'bx-messenger-hide');
			BX.removeClass(this.chatCreateFormChatTitle.parentNode.parentNode, 'bx-messenger-hide');
		}
		else
		{
			BX.addClass(this.chatCreateFormChatTitle.parentNode.parentNode, 'bx-messenger-hide');
			BX.removeClass(this.chatCreateFormUsersInput.parentNode.parentNode, 'bx-messenger-hide');
			BX.removeClass(this.chatCreateFormUsersInput, 'bx-messenger-hide');
			BX.addClass(this.chatCreateFormUsersInput, "bx-messenger-input-dest-empty")
		}

		if (this.chatCreateUsers.length > 0 && this.popupCreateChatTextarea.value.length > 0) // TODO length
		{
			this.popupCreateChatTextarea.focus();
		}
		else
		{
			if (type == 'open')
			{
				this.chatCreateFormChatTitle.focus();
			}
			else
			{
				this.chatCreateFormUsersInput.focus();
			}
		}
	}
	else
	{
		this.chatCreateType = type;
		this.chatCreateUsers = {};
		BX.MessengerCommon.clearMentionList('create');
		this.chatCreateForm = BX.create("div", { props : { className : "bx-messenger-box-create" },  children : [
			BX.create("div", { props : { className : "bx-messenger-panel" }, children : [
				BX.create("div", { props : { className : "bx-messenger-panel-wrap" }, children : [
					BX.create('div', { props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-"+type }, children: [
						this.chatCreateFormAvatar = BX.create('img', { attrs : { src : this.BXIM.pathToBlankImage, style: 'background-color: '+avatarColor}, props : { className : "bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default" }})
					]}),
					BX.create("span", { props : { className : "bx-messenger-panel-title bx-messenger-panel-create-chat "+(type == 'open'? 'bx-messenger-hide':'') }, children: [
						BX.create("div", { props : { className : "bx-messenger-input-wrap bx-messenger-panel-create-input" }, children : [
							this.chatCreateFormUsersDest = BX.create("span", { props : { className : "bx-messenger-dest-items"}}),
							this.chatCreateFormUsersInput = BX.create("input", {props : { className : "bx-messenger-input bx-messenger-input-dest-empty" }, attrs: {type: "text", value: '', placeholder: BX.message('IM_C_PRIVATE_TITLE')}})
						]})
					]}),
					BX.create("span", { props : { className : "bx-messenger-panel-title bx-messenger-panel-create-chat "+(type != 'open'? 'bx-messenger-hide':'')}, children: [
						BX.create("div", { props : { className : "bx-messenger-input-wrap bx-messenger-panel-create-input" }, children : [
							this.chatCreateFormChatTitle = BX.create("input", {props : { className : "bx-messenger-input bx-messenger-input-dest-empty" }, attrs: {type: "text", value: '', placeholder: BX.message('IM_C_CHAT_TITLE')}})
						]})
					]})
				]})
			]}),
			BX.create("div", { props : { className : "bx-messenger-body-dialog" }, children: [
				this.chatCreateFormBody = BX.create("div", { props : { className : "bx-messenger-body" }, style : {height: this.popupMessengerBodySize+'px'}, children: [
					BX.create("div", { props : { className : "bx-messenger-box-create-desc"}, children: [
						this.chatCreateFormDescription = BX.create("div", { props : { className : "bx-messenger-box-create-desc-wrap"}, children: descriptionNodes})
					]})
				]}),
				BX.create("div", { props : { className : "bx-messenger-textarea-place"}, children : [
					BX.create("div", { props : { className : "bx-messenger-textarea-resize" }}),
					BX.create("div", { props : { className : "bx-messenger-textarea-send" }, children : [
						BX.create("a", {attrs: {href: "#send"}, props : { className : "bx-messenger-textarea-send-button" }, events : { click : BX.delegate(function(){
							this.createChat(this.chatCreateType, this.chatCreateUsers, this.popupCreateChatTextarea.value);
						}, this)}}),
						BX.create("span", {attrs : {title : BX.message('IM_M_SEND_TYPE_TITLE')}, props : { className : "bx-messenger-textarea-cntr-enter"}, html: this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter"), events: {
							click: BX.delegate(function() {
								this.BXIM.settings.sendByEnter = this.BXIM.settings.sendByEnter? false: true;
								this.BXIM.saveSettings({'sendByEnter': this.BXIM.settings.sendByEnter});

								BX.proxy_context.innerHTML = this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");
								this.popupMessengerTextareaSendType.innerHTML = BX.proxy_context.innerHTML;
							}, this)
						}})
					]}),
					BX.create("div", {props : { className : "bx-messenger-textarea-icons" }, children: [
						BX.create("div", {attrs : { title: BX.message('IM_SMILE_MENU')},  props : { className : "bx-messenger-textarea-smile" }, events : { click : BX.delegate(function(e){this.openSmileMenu({textarea: 'createChat', bind: e.currentTarget}); return BX.PreventDefault(e);}, this)}}),
						BX.create("div", {attrs : { title: BX.message('IM_MENTION_MENU')},  props : { className : "bx-messenger-textarea-mention" }, events : { click : BX.delegate(function(e){this.openMentionDialog({delay: 0, textarea: 'createChat'}); return BX.PreventDefault(e);}, this)}}),
						!this.disk.enable? null: BX.create("div", {attrs : { title: BX.message('IM_F_UPLOAD_MENU')}, props : { className : "bx-messenger-textarea-file" }, events: {click: BX.delegate(function(e){
							this.BXIM.openConfirm(BX.message('IM_F_ERR_NC'));
						}, this)}})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea" }, children : [
						this.popupCreateChatTextarea = BX.create("textarea", { props : { value: '', className : "bx-messenger-textarea-input"}, style : {height: this.popupMessengerTextareaSize+'px'}}),
						BX.create("div", { props : {className : "bx-messenger-textarea-placeholder"}, html : BX.message('IM_M_TA_TEXT')})
					]}),
					BX.create("div", { props : { className : "bx-messenger-textarea-clear" }})
				]})
			]})
		]});
		if (BX.MessengerCommon.isDesktop())
		{
			BX.bind(this.popupCreateChatTextarea, "contextmenu", BX.delegate(function(e) {
				this.openPopupMenu(e, 'copypaste', false, {'spell': true});
				return BX.PreventDefault(e);
			}, this));
		}
		BX.bind(this.popupCreateChatTextarea, "focus", BX.delegate(function() {
			this.textareaCheckText({'textarea': 'createChat'});
			this.setClosingByEsc(false);
			BX.addClass(this.popupCreateChatTextarea.parentNode, 'bx-messenger-textarea-focus');
		}, this));
		BX.bind(this.popupCreateChatTextarea, "blur", BX.delegate(function() {
			this.textareaCheckText({'textarea': 'createChat'});
			this.setClosingByEsc(true);
			BX.removeClass(this.popupCreateChatTextarea.parentNode, 'bx-messenger-textarea-focus');
		}, this));

		BX.bind(this.chatCreateFormChatTitle, "keydown", BX.delegate(function(event){
			this.textareaPrepareText(BX.proxy_context, event, BX.delegate(function(){
				this.createChat(this.chatCreateType, this.chatCreateUsers, this.popupCreateChatTextarea.value);
			}, this), function(){

			});
		}, this));

		BX.bind(this.chatCreateFormChatTitle, "keydown", BX.delegate(function(e) {
			if (e.keyCode == 9 || e.keyCode == 13)
			{
				this.popupCreateChatTextarea.focus();
				return BX.PreventDefault(e);
			}
		}, this));

		BX.bind(this.popupCreateChatTextarea, "keydown", BX.delegate(function(event){
			this.textareaPrepareText(BX.proxy_context, event, BX.delegate(function(){
				this.createChat(this.chatCreateType, this.chatCreateUsers, this.popupCreateChatTextarea.value);
			}, this), function(){

			});
		}, this));

		BX.bind(this.popupCreateChatTextarea, "keyup", BX.delegate(function(){
			this.textareaCheckText({'textarea': 'createChat'});
		}, this));

		if (BX.MessengerCommon.isDesktop())
		{
			BX.bindDelegate(this.popupMessengerBodyWrap, "contextmenu", {className: 'bx-messenger-content-item-content'}, BX.delegate(function(e) {
				this.openPopupMenu(e, 'dialogContext', false);
				return BX.PreventDefault(e);
			}, this));
		}
		this.extraOpen(this.chatCreateForm);

		if (type == 'open')
		{
			this.chatCreateFormChatTitle.focus();
		}
		else
		{
			this.chatCreateFormUsersInput.focus();
			BX.bind(this.chatCreateFormUsersInput, "keyup", BX.delegate(function(event){
				if (!this.popupChatDialog && this.chatCreateFormUsersInput.value.length > 0)
				{
					this.openChatDialog({
						'type': 'CHAT_CREATE',
						'bind': this.chatCreateFormUsersInput,
						'bindResult': this.chatCreateFormUsersDest,
						'bindSearch': this.chatCreateFormUsersInput,
						'bindUsersList': this.chatCreateUsers,
						'skipBind': this.chatCreateFormSkipDialogBind
					});
					this.chatCreateFormSkipDialogBind = true;
				}
			}, this))
		}
	}

}

BX.MessengerChat.prototype.getChatId = function()
{
	if (this.openChatFlag)
	{
		return this.currentTab.toString().substr(4);
	}
	else
	{
		return this.userChat[this.currentTab];
	}
}

BX.MessengerChat.prototype.createChat = function(type, users, message)
{
	if (this.BXIM.popupConfirm != null)
	{
		this.BXIM.popupConfirm.destroy();
		return false;
	}

	if (type == 'private')
	{
		var userId = 0;
		for (var i in users)
		{
			userId = users[i].id;
		}
		if (userId)
		{
			this.openMessenger(userId);

			this.popupMessengerTextarea.value = BX.MessengerCommon.prepareMention('create', message);
			this.sendMessage(userId);
		}
		else
		{
			this.chatCreateFormUsersInput.focus();
			return false;
		}
	}
	else
	{
		if (type == 'open')
		{
			if (BX.util.trim(this.chatCreateFormChatTitle.value) == '')
			{
				this.chatCreateFormChatTitle.focus();
				return false;
			}

			this.sendRequestChatDialog({
				'action' : 'CHAT_CREATE',
				'type' : 'open',
				'title' : this.chatCreateFormChatTitle.value,
				'message' : BX.MessengerCommon.prepareMention('create', message)
			});
		}
		else
		{
			if (BX.MessengerCommon.countObject(users) <= 0)
			{
				this.chatCreateFormUsersInput.focus();
				return false;
			}

			var arUsers = [];
			for (var i in users)
				arUsers.push(i);

			this.sendRequestChatDialog({
				'action' : 'CHAT_CREATE',
				'type' : 'chat',
				'users' : arUsers,
				'message' : BX.MessengerCommon.prepareMention('create', message)
			});
		}
	}

	return false;
}

BX.MessengerChat.prototype.kickFromChat = function(chatId, userId)
{
	if (!this.chat[chatId] && this.chat[chatId].owner != this.BXIM.userId && !this.userId[userId])
		return false;

	BX.ajax({
		url: this.BXIM.pathToAjax+'?CHAT_LEAVE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 60,
		data: {'IM_CHAT_LEAVE' : 'Y', 'CHAT_ID' : chatId, 'USER_ID' : userId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data){
			if (data.ERROR == '')
			{
				for (var i = 0; i < this.userInChat[data.CHAT_ID].length; i++)
					if (this.userInChat[data.CHAT_ID][i] == userId)
						delete this.userInChat[data.CHAT_ID][i];

				if (this.popupMessenger != null)
					BX.MessengerCommon.userListRedraw();

				BX.localStorage.set('mclk', {'chatId': data.CHAT_ID, 'userId': data.USER_ID}, 5);
			}
		}, this)
	});
};

BX.MessengerChat.prototype.redrawChatHeader = function(params)
{
	if (!this.openChatFlag)
		return false;

	var chatId = this.getChatId();
	if (!this.chat[chatId])
		return false;

	params = params || {};
	params.userRedraw = params.userRedraw || true;

	if (this.popupMessengerFileFormChatId)
	{
		this.popupMessengerFileFormChatId.value = chatId;
		if (parseInt(this.popupMessengerFileFormChatId.value) > 0)
		{
			this.popupMessengerFileFormInput.removeAttribute('disabled');
		}
		else
		{
			this.popupMessengerFileFormInput.setAttribute('disabled', true);
		}
	}
	if (this.popupMessengerFileFormChatId)
	{
		this.popupMessengerFileFormChatId.value = chatId;
		if (this.chat[chatId] && !this.disk.enableExternal && this.chat[chatId].type == 'lines' && this.chat[chatId].entity_id.substr(0,8) != 'livechat')
		{
			this.popupMessengerFileFormInput.setAttribute('disabled', true);
		}
		else
		{
			if (parseInt(this.popupMessengerFileFormChatId.value) > 0)
			{
				this.popupMessengerFileFormInput.removeAttribute('disabled');
			}
			else
			{
				this.popupMessengerFileFormInput.setAttribute('disabled', true);
			}
		}
	}

	this.renameChatDialogFlag = false;

	BX.style(this.popupOpenLinesSpam, 'display', '');
	BX.style(this.popupOpenLinesClose, 'display', 'none');

	var removeClass = [];
	var addClass = [];
	if (this.chat[chatId].type == 'call')
	{
		this.popupMessengerPanelAvatar3.src = this.chat[chatId].avatar? this.chat[chatId].avatar: this.BXIM.pathToBlankImage;
		this.popupMessengerPanelAvatar3.className = "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar3.src)? " bx-messenger-panel-avatar-img-default": "");
		BX.style(this.popupMessengerPanelAvatar3, "background-color", (BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar3.src) && this.chat[chatId].color? this.chat[chatId].color: ""));

		if (this.popupMessengerPanelCallTitle)
			this.popupMessengerPanelCallTitle.innerHTML = this.chat[chatId].name;
		if (this.popupMessengerPanelCallDescription)
			this.popupMessengerPanelCallDescription.innerText = this.chat[chatId] && this.chat[chatId].entity_data_1 && this.chat[chatId].entity_data_1.toString().charAt(0) === "Y" ? this.chat[chatId].call_number : BX.message('IM_PHONE_DESC');
		this.popupMessengerPanelAvatarId3.value = chatId;
		this.disk.avatarFormIsBlocked(chatId, 'popupMessengerPanelAvatarUpload3', this.popupMessengerPanelAvatarForm3);

		this.popupMessengerPanelMute3.title = this.muteButtonStatus(this.currentTab)? BX.message("IM_M_CHAT_MUTE_ON_2"): BX.message("IM_M_CHAT_MUTE_OFF_2");
		this.popupMessengerPanelMute3.className = "bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)? ' bx-messenger-panel-unmute': '');

		removeClass.push('bx-messenger-chat-guest');
		removeClass.push('bx-messenger-chat-open');
		removeClass.push('bx-messenger-chat-lines');
		removeClass.push('bx-messenger-chat-crm');
		removeClass.push('bx-messenger-chat-general');
		removeClass.push('bx-messenger-chat-general-first-open');
		removeClass.push('bx-messenger-chat-general-access');
		BX.style(this.popupOpenLinesTransfer, 'display', 'none');

		BX.addClass(this.popupMessengerDialog, 'bx-messenger-chat-call');
		BX.removeClass(this.popupMessengerDialog, removeClass.join(" "));

		this.popupMessengerPanelChat.className = 'bx-messenger-panel bx-messenger-context-chat bx-messenger-hide';
		this.popupMessengerPanelCall.className = 'bx-messenger-panel bx-messenger-context-call';
	}
	else
	{
		this.popupMessengerPanelMute2.title = this.muteButtonStatus(this.currentTab)? BX.message("IM_M_CHAT_MUTE_ON_2"): BX.message("IM_M_CHAT_MUTE_OFF_2");
		this.popupMessengerPanelMute2.className = "bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)? ' bx-messenger-panel-unmute': '');

		var isDefaultImage = BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar2.src);
		this.popupMessengerPanelAvatar2.src = this.chat[chatId].avatar? this.chat[chatId].avatar: this.BXIM.pathToBlankImage;
		this.popupMessengerPanelAvatar2.className = "bx-messenger-panel-avatar-img"+(isDefaultImage? " bx-messenger-panel-avatar-img-default": "");
		BX.style(this.popupMessengerPanelAvatar2, "background-color", (BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar2.src) && this.chat[chatId].color? this.chat[chatId].color: ""));

		if (this.popupMessengerPanelChatTitle.className.indexOf('bx-messenger-chat-edit') == -1)
		{
			this.popupMessengerPanelChatTitle.innerHTML = this.chat[chatId].name;
		}

		this.popupMessengerPanelAvatarId2.value = chatId;
		this.disk.avatarFormIsBlocked(chatId, 'popupMessengerPanelAvatarUpload2', this.popupMessengerPanelAvatarForm2);

		this.popupMessengerPanelAvatarForm2.className = "bx-messenger-panel-avatar";
		if (this.chat[chatId].type == 'lines' || this.chat[chatId].type == 'livechat' || this.chat[chatId].type == 'chat' || this.chat[chatId].entity_type == 'CRM')
		{
			var textareaDisabled = false;
			if (this.chat[chatId].type == 'livechat')
			{
				var session = BX.MessengerCommon.livechatGetSession(chatId);

				BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-lines');
				BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-livechat');
				addClass.push('bx-messenger-chat-livechat');
				removeClass.push('bx-messenger-chat-chat');
				removeClass.push('bx-messenger-chat-lines');
				removeClass.push('bx-messenger-chat-crm');
				BX.style(this.popupOpenLinesTransfer, 'display', 'none');
			}
			else if (this.chat[chatId].type == 'lines')
			{
				this.openLinesFlag = true;
				var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);

				BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-lines');
				BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-'+BX.MessengerCommon.linesGetSource(this.chat[chatId]));
				addClass.push('bx-messenger-chat-lines');
				removeClass.push('bx-messenger-chat-chat');
				removeClass.push('bx-messenger-chat-livechat');
				removeClass.push('bx-messenger-chat-crm');

				if (!BX.MessengerCommon.userInChat(chatId))
				{
					textareaDisabled = true;
					BX.style(this.popupOpenLinesTransfer, 'display', 'none');

					BX.style(this.popupMessengerTextareaOpenLinesTransfer, 'display', session.id? 'inline-block': 'none');
					this.popupMessengerTextareaOpenLinesAnswer.innerHTML = session.id? BX.message('IM_OL_INVITE_JOIN_2'): BX.message('IM_OL_INVITE_JOIN');
					this.popupMessengerTextareaOpenLinesSkip.innerHTML = BX.message('IM_OL_INVITE_CLOSE');
					this.popupMessengerTextareaOpenLinesText.innerHTML = session.id? BX.message('IM_OL_INVITE_TEXT_JOIN'): BX.message('IM_OL_INVITE_TEXT_OPEN');
				}
				else if (this.chat[chatId].owner == 0)
				{
					textareaDisabled = true;
					BX.style(this.popupOpenLinesTransfer, 'display', 'none');
					BX.style(this.popupOpenLinesClose, 'display', 'none');

					BX.style(this.popupMessengerTextareaOpenLinesTransfer, 'display', session.id? 'inline-block': 'none');
					this.popupMessengerTextareaOpenLinesAnswer.innerHTML = session.id? BX.message('IM_OL_INVITE_ANSWER'): BX.message('IM_OL_INVITE_JOIN');
					this.popupMessengerTextareaOpenLinesSkip.innerHTML = session.id? BX.message('IM_OL_INVITE_SKIP'): BX.message('IM_OL_INVITE_CLOSE');
					this.popupMessengerTextareaOpenLinesText.innerHTML = session.id? BX.message('IM_OL_INVITE_TEXT'): BX.message('IM_OL_INVITE_TEXT_OPEN');
				}
				else
				{
					if (this.chat[chatId].owner == this.BXIM.userId)
					{
						BX.style(this.popupOpenLinesTransfer, 'display', 'block');
						BX.style(this.popupOpenLinesClose, 'display', 'block');
					}
					else
					{
						BX.style(this.popupOpenLinesTransfer, 'display', 'none');
						BX.style(this.popupOpenLinesClose, 'display', 'none');
					}
				}

				if (!session.id || session.id && parseInt(this.chat[chatId].owner) > 0)
				{
					BX.style(this.popupOpenLinesSpam, 'display', '');
				}
				else
				{
					BX.style(this.popupOpenLinesSpam, 'display', 'block');
				}

				if (this.linesSilentMode[chatId])
				{
					BX.addClass(this.popupMessengerHiddenModeButton, 'bx-messenger-textarea-hidden-active');
				}
				else
				{
					BX.removeClass(this.popupMessengerHiddenModeButton, 'bx-messenger-textarea-hidden-active');
				}
			}
			else
			{
				this.openLinesFlag = false;
				BX.style(this.popupOpenLinesTransfer, 'display', 'none');
				BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-chat');

				addClass.push('bx-messenger-chat-chat');

				if (this.chat[chatId].entity_type == 'CRM')
				{
					addClass.push('bx-messenger-chat-crm');
					BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-type-crm');
				}
				else
				{
					removeClass.push('bx-messenger-chat-crm');
				}

				removeClass.push('bx-messenger-chat-livechat');
				removeClass.push('bx-messenger-chat-lines');
			}

			if (textareaDisabled)
			{
				addClass.push('bx-messenger-chat-guest');
			}
			else
			{
				removeClass.push('bx-messenger-chat-guest');
			}

			this.popupMessengerTextarea.disabled = textareaDisabled;

			removeClass.push('bx-messenger-chat-open');
			removeClass.push('bx-messenger-chat-general');
			removeClass.push('bx-messenger-chat-general-first-open');
			removeClass.push('bx-messenger-chat-general-access');
		}
		else
		{
			BX.addClass(this.popupMessengerPanelAvatarForm2, 'bx-messenger-panel-avatar-open');
			BX.style(this.popupOpenLinesTransfer, 'display', 'none');

			addClass.push('bx-messenger-chat-open');
			removeClass.push('bx-messenger-chat-chat');
			removeClass.push('bx-messenger-chat-livechat');
			removeClass.push('bx-messenger-chat-lines');

			var textareaDisabled = false;
			if (chatId == this.generalChatId)
			{
				addClass.push('bx-messenger-chat-general');
				if (!this.canSendMessageGeneralChat)
				{
					addClass.push('bx-messenger-chat-general-access');
					this.popupMessengerTextareaGeneralText.innerHTML = BX.message('IM_G_ACCESS');
					textareaDisabled = true;
				}
				else if (this.BXIM.settings.generalNotify)
				{
					addClass.push('bx-messenger-chat-general-first-open');
					// onclick="BX.Helper.show(\"redirect=detail&HD_ID='+BX.message('IM_G_JOIN_HELPDESK_ID')+'\");"
					this.popupMessengerTextareaGeneralText.innerHTML = BX.message('IM_G_JOIN').replace('#LINK_START#', '<a href="'+BX.message('IM_G_JOIN_LINK')+'" target="_blank" onclick="BXIM.closeMessenger()" style="margin-left: 10px; text-decoration: underline;">').replace('#LINK_END#', '</a>').replace('#ICON#', '<span class="bx-messenger-icon-notify-mute" onclick="BX.MessengerCommon.muteMessageChat(\'chat'+this.generalChatId+'\');"></span>');
					textareaDisabled = true;
				}
				else
				{
					removeClass.push('bx-messenger-chat-general-first-open');
					removeClass.push('bx-messenger-chat-general-access');
				}
			}
			else
			{
				removeClass.push('bx-messenger-chat-general');
				removeClass.push('bx-messenger-chat-general-first-open');
				removeClass.push('bx-messenger-chat-general-access');
			}

			if (textareaDisabled)
			{
				this.popupMessengerTextarea.disabled = true;
			}
			else if (BX.MessengerCommon.userInChat(chatId))
			{
				this.popupMessengerTextarea.disabled = false;
				removeClass.push('bx-messenger-chat-guest');
			}
			else
			{
				this.popupMessengerTextarea.disabled = true;
				addClass.push('bx-messenger-chat-guest');
			}
		}
		removeClass.push('bx-messenger-chat-call');

		BX.addClass(this.popupMessengerDialog, addClass.join(" "));
		BX.removeClass(this.popupMessengerDialog, removeClass.join(" "));

		if (isDefaultImage)
			BX.addClass(this.popupMessengerPanelStatus2, 'bx-messenger-panel-avatar-status-hide');
		else
			BX.removeClass(this.popupMessengerPanelStatus2, 'bx-messenger-panel-avatar-status-hide');

		if (this.chat[chatId].entity_type != "" && BX.MessengerCommon.getEntityTypePath(chatId))
		{
			this.popupMessengerPanelChat.className = 'bx-messenger-panel bx-messenger-context-chat bx-messenger-panel-with-menu';
		}
		else
		{
			this.popupMessengerPanelChat.className = 'bx-messenger-panel bx-messenger-context-chat';
		}

		if (this.chat[chatId].entity_type != "" && BX.MessengerCommon.checkRestriction(chatId, 'EXTEND'))
		{
			BX.style(this.popupMessengerPanelButtonExtend, 'display', 'none');
		}
		else
		{
			BX.style(this.popupMessengerPanelButtonExtend, 'display', 'block');
		}

		this.popupMessengerPanelCall.className = 'bx-messenger-panel bx-messenger-context-call bx-messenger-hide';
	}

	this.popupMessengerPanel.className = 'bx-messenger-panel bx-messenger-context-user bx-messenger-hide';

	if (!this.userInChat[chatId])
	{
		this.popupMessengerPanelUsers.innerHTML = this.chat[chatId].fake? BX.message('IM_CL_LOAD'): BX.message('IM_C_EMPTY');
		return false;
	}

	if (params.userRedraw)
	{
		var showUser = false;
		this.popupMessengerPanelUsers.innerHTML = '';

		if (this.userInChat[chatId])
		{
			this.userInChat[chatId].sort(BX.delegate(function(a, b) {
				if (!this.users[a] || !this.users[b]) return 0;
				i = 0;
				if (this.users[a].status != 'offline') { i += 20; }
				if (this.chat[chatId].owner == a) { i += 10 }
				if (this.users[a].status == 'online') { i += 5; }
				if (this.users[a].status == 'mobile') { i += 3; }
				if (this.users[a].avatar != "/bitrix/js/im/images/blank.gif") { i += 5 }
				if (a < b) { i += 1 }
				ii = 0;
				if (this.users[b].status != 'offline') { ii += 20; }
				if (this.chat[chatId].owner == b) { ii += 10 }
				if (this.users[b].status == 'online') { ii += 5; }
				if (this.users[b].status == 'mobile') { ii += 3; }
				if (this.users[b].avatar != "/bitrix/js/im/images/blank.gif") { ii += 5 }
				if (b < a) { ii += 1 }
				if (i < ii) { return 1; } else if (i > ii) { return -1;}else{ return 0;}
			}, this));
		}

		var extranetInChat = this.chat[chatId].extranet;
		if (this.chat[chatId].extranet == "")
		{
			extranetInChat = false;
			for (var i = 0; i < this.userInChat[chatId].length; i++)
			{
				extranetInChat = this.users[this.userInChat[chatId][i]] && this.users[this.userInChat[chatId][i]].extranet;
			}
		}
		if (this.chat[chatId].type == 'livechat')
		{
			BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-extranet');
			BX.removeClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-extranet');
			BX.addClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-title-lines');
		}
		else if (this.chat[chatId].type == 'lines')
		{
			BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-extranet');
			BX.removeClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-extranet');
			BX.addClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-title-lines');

			if (session.crm == 'Y')
			{
				BX.style(this.popupMessengerPanelCrm, 'display', 'inline-block');
			}
			else
			{
				BX.style(this.popupMessengerPanelCrm, 'display', 'none');
			}
		}
		else if (this.chat[chatId].entity_type == 'CRM')
		{
			BX.addClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-title-lines');
			BX.style(this.popupMessengerPanelCrm, 'display', 'inline-block');
		}
		else if (this.chat[chatId].extranet)
		{
			BX.addClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-extranet');
			BX.addClass(this.popupMessengerDialog, 'bx-messenger-dialog-extranet');
			BX.style(this.popupMessengerPanelCrm, 'display', 'none');
		}
		else
		{
			BX.removeClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-extranet')
			BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-extranet')
			BX.removeClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-title-lines');
			BX.style(this.popupMessengerPanelCrm, 'display', 'none');
		}
		BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-bot');
		BX.removeClass(this.popupMessengerDialog, 'bx-messenger-dialog-network');

		var userInChat = [];
		for (var i = 0; i < this.userInChat[chatId].length; i++)
		{
			var user = this.users[this.userInChat[chatId][i]];
			if (!user || !user.active)
			{
				continue;
			}

			if (this.chat[chatId].entity_type == "LINES" && this.chat[chatId].owner == 0 && user.id != this.BXIM.userId && !(user.bot || user.connector))
			{
				continue;
			}

			userInChat.push(this.userInChat[chatId][i]);
		}

		var maxCount = Math.floor((this.popupMessengerPanelUsers.offsetWidth)/135);
		if (maxCount >= userInChat.length)
		{
			for (var i = 0; i < userInChat.length && i < maxCount; i++)
			{
				var user = this.users[userInChat[i]];
				var avatarColor = BX.MessengerCommon.isBlankAvatar(user.avatar)? 'style="background-color: '+user.color+'"': '';
				this.popupMessengerPanelUsers.innerHTML += '<span class="bx-messenger-panel-chat-user" data-userId="'+user.id+'">' +
					'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(user)+(this.chat[chatId].owner == user.id? ' bx-notifier-popup-avatar-owner': '')+(user.extranet && !user.connector? ' bx-notifier-popup-avatar-extranet':'')+'">' +
						'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(user.avatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+user.avatar+'" title="'+user.name+'" '+avatarColor+'>' +
						'<span class="bx-notifier-popup-avatar-status-icon" title="'+user.name+'"></span>'+
					'</span>' +
					'<span class="bx-notifier-popup-user-name'+(user.extranet && !user.connector? ' bx-messenger-panel-chat-user-name-extranet':'')+(user.connector? ' bx-messenger-panel-chat-user-name-lines':'')+(user.bot? ' bx-messenger-panel-chat-user-name-bot':'')+'">'+user.name+'</span>' +
				'</span>';

				showUser = true;
			}
		}
		else
		{
			maxCount = Math.floor((this.popupMessengerPanelUsers.offsetWidth-10)/32);
			for (var i = 0; i < userInChat.length && i < maxCount; i++)
			{
				var user = this.users[userInChat[i]];

				var avatarColor = BX.MessengerCommon.isBlankAvatar(user.avatar)? 'style="background-color: '+user.color+'"': '';
				this.popupMessengerPanelUsers.innerHTML += '<span class="bx-messenger-panel-chat-user" data-userId="'+user.id+'">' +
					'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(user)+(this.chat[chatId].owner == user.id? ' bx-notifier-popup-avatar-owner': '')+(user.extranet? ' bx-notifier-popup-avatar-extranet':'')+'">' +
						'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(user.avatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+user.avatar+'" title="'+user.name+'" '+avatarColor+'>' +
					'<span class="bx-notifier-popup-avatar-status-icon" title="'+user.name+'"></span>'+
					'</span>' +
				'</span>';
				showUser = true;
			}
			if (showUser && userInChat.length > maxCount)
			{
				this.popupMessengerPanelUsers.innerHTML += '<span class="bx-notifier-popup-user-more" data-last-item="'+i+'">'+BX.message('IM_M_CHAT_MORE_USER').replace('#USER_COUNT#', (userInChat.length-maxCount))+'</span>';
			}
		}

		if (!showUser)
		{
			this.popupMessengerPanelUsers.innerHTML = BX.message('IM_CL_LOAD');
		}
	}
};

BX.MessengerChat.prototype.updateChatAvatar = function(chatId, chatAvatar)
{
	if (this.chat[chatId] && chatAvatar && chatAvatar.length > 0)
	{
		this.chat[chatId].avatar = chatAvatar;

		this.dialogStatusRedraw();
		BX.MessengerCommon.userListRedraw();
	}
	return true;
}
BX.MessengerChat.prototype.renameChatDialog = function()
{
	var chatId = this.getChatId();
	if (this.renameChatDialogFlag || !BX.MessengerCommon.userInChat(chatId) || BX.MessengerCommon.checkRestriction(chatId, 'RENAME'))
		return false;

	this.renameChatDialogFlag = true;

	BX.addClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-edit');

	this.popupMessengerPanelChatTitle.innerHTML = '';
	BX.adjust(this.popupMessengerPanelChatTitle, {children: [
		BX.create("div", { props : { className : "bx-messenger-input-wrap bx-messenger-panel-title-chat-input" }, children : [
			this.renameChatDialogInput = BX.create("input", {props : { className : "bx-messenger-input" }, attrs: {type: "text", value: BX.util.htmlspecialcharsback(this.chat[chatId].name)}})
		]})
	]});
	this.renameChatDialogInput.focus();
	BX.bind(this.renameChatDialogInput, "blur", BX.delegate(function(){
		BX.removeClass(this.popupMessengerPanelChatTitle, 'bx-messenger-chat-edit');

		BX.MessengerCommon.renameChat(chatId, this.renameChatDialogInput.value);

		BX.remove(this.renameChatDialogInput);
		this.renameChatDialogInput = null;

		this.popupMessengerPanelChatTitle.innerHTML = this.chat[chatId].name;
		this.renameChatDialogFlag = false;
	}, this));

	BX.bind(this.renameChatDialogInput, "keydown", BX.delegate(function(e) {
		if (e.keyCode == 27 && !BX.MessengerCommon.isDesktop())
		{
			this.renameChatDialogInput.value = BX.util.htmlspecialcharsback(this.chat[chatId].name);
			this.popupMessengerTextarea.focus();
			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 9 || e.keyCode == 13)
		{
			this.popupMessengerTextarea.focus();
			return BX.PreventDefault(e);
		}
	}, this));
};

BX.MessengerChat.prototype.openMentionDialog = function(params)
{
	if (this.popupSmileMenu != null)
	{
		this.popupSmileMenu.destroy();
	}

	if (this.popupChatDialog != null)
	{
		this.popupChatDialog.close();
		return false;
	}

	params = params || {};
	params.delay = params.delay || 300;
	params.textarea = params.textarea || 'default';

	var textarea = params.textarea == 'createChat'? this.popupCreateChatTextarea: this.popupMessengerTextarea;

	textarea.focus();
	if (textarea.value.substr(-1) != "@")
	{
		this.insertTextareaText(textarea, "@");
	}

	this.mentionListen = true;
	this.mentionDelimiter = "@";
	this.openChatDialog({'type': 'MENTION', 'bind': textarea, 'focus': false, 'delimiter': this.mentionDelimiter, 'delay': params.delay})

	this.setClosingByEsc(false);
}

BX.MessengerChat.prototype.openChatDialog = function(params)
{
	if (!this.enableGroupChat)
		return false;

	if (this.popupChatDialog != null)
	{
		this.popupChatDialog.close();
		return false;
	}
	if (this.popupTransferDialog != null)
	{
		this.popupTransferDialog.close();
		return false;
	}

	BX.MessengerCommon.contactListSearchClear();
	this.closePopupFileMenu();

	if (this.popupPopupMenu != null)
		this.popupPopupMenu.destroy();

	if (this.popupSmileMenu != null)
	{
		this.popupSmileMenu.destroy();
	}
	if (this.commandPopup != null)
	{
		this.commandPopup.destroy();
	}
	if (this.popupIframeMenu != null && this.popupIframeBind)
	{
		this.popupIframeMenu.destroy();
	}
	if (params.type == 'CHAT_EXTEND' && this.popupMessengerTextarea.disabled)
	{
		return false
	}

	var type = null;
	if (params.type == 'CHAT_ADD' || params.type == 'CHAT_EXTEND' || params.type == 'CALL_INVITE_USER' || params.type == 'MENTION' || params.type == 'CHAT_CREATE')
		this.popupChatDialogDestType = params.type;
	else
		return false;


	var offsetTop = 5;
	var angleOffset = {offset: BX.MessengerCommon.isPage()? 39: 210};
	var offsetLeft = BX.MessengerCommon.isPage()? this.webrtc.callActive? 5: 0: this.webrtc.callActive? -162: -170;

	this.popupChatDialogEmptyCallback = function(){}

	this.popupChatDialogExceptUsers = [];
	if (typeof(params.chatId) != 'undefined' && this.userInChat[params.chatId])
	{
		this.popupChatDialogExceptUsers = this.userInChat[params.chatId];
	}

	if (params.type == 'MENTION')
	{
		params.maxUsers = 1;
		offsetTop = BX.MessengerCommon.isPage()? 15: 10;
		offsetLeft = -10;
		angleOffset = {offset: 39};
	}
	else if (params.type == 'CHAT_CREATE')
	{
		if (this.chatCreateType == 'private')
		{
			params.maxUsers = 1;
		}

		this.popupChatDialogDestElements = params.bindResult;
		this.popupChatDialogContactListSearch = params.bindSearch;
		this.popupChatDialogUsers = params.bindUsersList;

		for (var i in this.popupChatDialogUsers)
		{
			this.popupChatDialogExceptUsers.push(this.popupChatDialogUsers[i].id);
		}

		this.popupChatDialogEmptyCallback = BX.delegate(function(){
			if (this.popupChatDialog)
				this.popupChatDialog.close();
		},this);
	}

	this.popupChatDialogMaxChatUsers = typeof(params.maxUsers) == 'undefined'? 1000000: parseInt(params.maxUsers);

	if (typeof(params.chatId) != 'undefined' && this.userInChat[params.chatId])
	{
		this.popupChatDialogMaxChatUsers = this.popupChatDialogMaxChatUsers-this.userInChat[params.chatId].length;
	}

	params.skipBind = typeof(params.skipBind) == 'undefined'? false: params.skipBind;

	var bindElement = params.bind? params.bind: null;
	var hideHistoryCheckbox = params.type != 'CHAT_EXTEND' || this.chat[params.chatId].entity_type == 'LINES';

	this.popupChatDialog = new BX.PopupWindow('bx-messenger-popup-newchat', bindElement, {
		//parentPopup: this.popupMessenger,
		lightShadow : true,
		closeIcon : true,
		offsetTop: offsetTop,
		offsetLeft: offsetLeft,
		autoHide: true,
		bindOptions: (params.type == 'MENTION'? {position: "top"}: {}),
		buttons: params.type == 'MENTION' || params.type == 'CHAT_CREATE'? []: [
			new BX.PopupWindowButton({
				text : BX.message('IM_M_CHAT_BTN_JOIN'),
				className : "popup-window-button-accept",
				events : { click : BX.delegate(function() {
					if (this.popupChatDialogDestType == 'CHAT_ADD')
					{
						var arUsers = [this.currentTab];
						for (var i in this.popupChatDialogUsers)
							arUsers.push(i);

						this.sendRequestChatDialog({
							'action' : this.popupChatDialogDestType,
							'users' : arUsers
						})
					}
					else if (this.popupChatDialogDestType == 'CHAT_EXTEND')
					{
						var arUsers = [];
						for (var i in this.popupChatDialogUsers)
							arUsers.push(i);

						this.sendRequestChatDialog({
							'action' : this.popupChatDialogDestType,
							'chatId' : this.getChatId(),
							'users' : arUsers
						})
					}
					else if (this.popupChatDialogDestType == 'CALL_INVITE_USER')
					{
						var arUsers = [];
						for (var i in this.popupChatDialogUsers)
							arUsers.push(i);

						this.webrtc.callInviteUserToChat(arUsers);
					}
				}, this) }
			}),
			new BX.PopupWindowButton({
				text : BX.message('IM_M_CHAT_BTN_CANCEL'),
				events : { click : BX.delegate(function() { this.popupChatDialog.close(); }, this) }
			})
		],
		closeByEsc: true,
		zIndex: 200,
		events : {
			onPopupClose : function() {
				this.destroy();
			},
			onPopupDestroy : BX.delegate(function() {
				this.popupChatDialog = null;
				this.mentionListen = false;
				this.mentionDelimiter = '';
				this.popupChatDialogDestType = '';
				if (params.type != 'CHAT_CREATE')
				{
					this.popupChatDialogUsers = {};
				}
				if (params.type == 'MENTION' || params.type == 'CHAT_CREATE')
				{
					BX.proxy_context.bindElement.focus();
				}
				else
				{
					this.popupChatDialogContactListElementsType = '';
					this.popupChatDialogContactListElements = null;
				}
			}, this)
		},
		content : BX.create("div", { props : { className : "bx-messenger-popup-newchat-wrap bx-messenger-popup-newchat-wrap-style-"+params.type+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: [
			BX.create("div", { props : { className : "bx-messenger-popup-newchat-caption" }, html: (params.type == 'MENTION'? BX.message('IM_MENTION_MENU'): BX.message('IM_M_CHAT_TITLE'))}),
			params.type == 'CHAT_CREATE'? null: BX.create("div", { props : { className : "bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"+(params.type == 'MENTION'? ' bx-messenger-hide': '') }, children: [
				this.popupChatDialogDestElements = BX.create("span", { props : { className : "bx-messenger-dest-items" }}),
				this.popupChatDialogContactListSearch = BX.create("input", {props : { className : "bx-messenger-input" }, attrs: {type: "text", placeholder: BX.message(this.BXIM.bitrixIntranet? 'IM_M_SEARCH_PLACEHOLDER_CP': 'IM_M_SEARCH_PLACEHOLDER'), value: ''}})
			]}),
			this.popupChatDialogContactListElements = BX.create("div", { props : { className : "bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap" }, children: BX.create("div", {
				props : { className: "bx-messenger-cl-item-load"},
				html : BX.message('IM_CL_LOAD')
			})}),
			hideHistoryCheckbox ? null: BX.create("div", { props : { className : "bx-messenger-popup-newchat-checkbox" }, children: [
				this.popupChatDialogShowHistory = BX.create("input", {props : { className : "bx-messenger-checkbox" }, attrs: {id: "popupChatDialogShowHistory", type: "checkbox", checked: (this.BXIM.options.chatExtendShowHistory? "true": ""), name: "popupChatDialogShowHistory"}}),
				BX.create("label", { attrs: {"for": "popupChatDialogShowHistory"}, props : { className : "bx-messenger-checkbox-label" }, html: BX.message('IM_M_CHAT_SHOW_HISTORY')})
			]})
		]})
	});

	this.popupChatDialog.setAngle(angleOffset);
	this.popupChatDialog.show();

	BX.addClass(this.popupChatDialog.popupContainer, "bx-messenger-mark");
	//BX.bind(this.popupChatDialog.popupContainer, "click", BX.PreventDefault);
	this.popupChatDialogContactListElementsType = params.type;

	BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': (this.popupChatDialogDestType == 'MENTION'), 'exceptUsers': this.popupChatDialogExceptUsers, timeout: 0, 'callback': {'empty': this.popupChatDialogEmptyCallback}});

	BX.bindDelegate(this.popupChatDialogContactListElements, "click", {className: 'bx-messenger-chatlist-more'}, BX.delegate(this.toggleChatListGroup, this));

	if (!params.skipBind && params.type != 'MENTION')
	{
		this.popupChatDialogContactListSearch.focus();

		BX.bind(this.popupChatDialogContactListSearch, "keyup", BX.delegate(function(event){
			if (event.keyCode == 16 || event.keyCode == 18 || event.keyCode == 20 || event.keyCode == 244 || event.keyCode == 91) // 224, 17
				return false;

			if (event.keyCode == 37 || event.keyCode == 39)
				return true;

			if (this.popupChatDialogContactListSearch.value != this.popupChatDialogContactListSearchLastText || this.popupChatDialogContactListSearch.value  == '')
			{
				if (this.popupChatDialogContactListSearch.value == '' && this.popupChatDialog && this.popupChatDialogDestType == 'CHAT_CREATE')
				{
					this.popupChatDialog.close();
					return false;
				}
			}
			else if (event.keyCode == 224 || event.keyCode == 18 || event.keyCode == 17)
			{
				return true;
			}

			if (event.keyCode == 8 && this.popupChatDialogContactListSearch.value == '')
			{
				var lastId = null;
				var arMentionSort = BX.util.objectSort(this.popupChatDialogUsers, 'date', 'asc');
				for (var i = 0; i < arMentionSort.length; i++)
				{
					lastId = arMentionSort[i].id;
				}
				if (lastId)
				{
					delete this.popupChatDialogUsers[lastId];
					this.redrawChatDialogDest();
				}
			}

			if (event.keyCode == 27 && this.popupChatDialogContactListSearch.value != '')
				BX.MessengerCommon.preventDefault(event);

			if (event.keyCode == 27)
			{
				if (this.BXIM.messenger.realSearch)
				{
					this.BXIM.messenger.realSearchFound = true;
				}
				this.popupChatDialogContactListSearch.value = '';
			}

			if (event.keyCode == 38 || event.keyCode == 40)
			{
				// todo up/down select
				return true;
			}

			if (event.keyCode == 13 && this.popupChatDialogContactListSearch.value != '')
			{
				var item = BX.findChildByClassName(this.popupChatDialogContactListElements, "bx-messenger-cl-item");
				if (item)
				{
					if (this.popupChatDialogContactListSearch.value != '')
					{
						this.popupChatDialogContactListSearch.value = '';
					}
					if (this.popupChatDialogUsers[item.getAttribute('data-userId')])
						delete this.popupChatDialogUsers[item.getAttribute('data-userId')];
					else
						this.popupChatDialogUsers[item.getAttribute('data-userId')] = {'id': item.getAttribute('data-userId'), 'date': new Date()};

					this.redrawChatDialogDest();

					if (this.popupChatDialogDestType == 'CHAT_CREATE')
					{
						if (this.popupChatDialog)
							this.popupChatDialog.close();
					}
				}
				else
				{
					var item = BX.findChildByClassName(this.popupChatDialogContactListElements, "bx-messenger-chatlist-search-button");
					if (item)
					{
						this.popupChatDialogContactListElements.appendChild(BX.create("div", {
							props : { className: "bx-messenger-cl-item-search"},
							html : BX.message('IM_M_CL_SEARCH')
						}));
						BX.remove(item);

						this.BXIM.messenger.realSearch = true;

						BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value, BX.delegate(function(){
							BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': (this.popupChatDialogDestType == 'MENTION'), 'exceptUsers': this.popupChatDialogExceptUsers, timeout: 100, 'callback': {'empty': this.popupChatDialogEmptyCallback}});
						}, this));

						return true;
					}
				}

				if (this.BXIM.messenger.realSearch)
				{
					this.BXIM.messenger.realSearchFound = true;
				}
			}

			this.popupChatDialogContactListSearchLastText = this.popupChatDialogContactListSearch.value;

			if (this.BXIM.messenger.realSearch)
			{
				this.BXIM.messenger.realSearchFound = this.popupChatDialogContactListSearch.value.length < 3;
			}

			BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': (this.popupChatDialogDestType == 'MENTION'), 'exceptUsers': this.popupChatDialogExceptUsers, timeout: 100, 'callback': {'empty': this.popupChatDialogEmptyCallback}});
			BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value, BX.delegate(function(){
				BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': (this.popupChatDialogDestType == 'MENTION'), 'exceptUsers': this.popupChatDialogExceptUsers, timeout: 100, 'callback': {'empty': this.popupChatDialogEmptyCallback}});
			}, this));

			if (this.popupChatDialog)
				this.popupChatDialog.adjustPosition();
		}, this));

		BX.bindDelegate(this.popupChatDialogDestElements, "click", {className: 'bx-messenger-dest-del'}, BX.delegate(function() {
			delete this.popupChatDialogUsers[BX.proxy_context.getAttribute('data-userId')];
			if (BX.MessengerCommon.countObject(this.popupChatDialogUsers) < this.popupChatDialogMaxChatUsers)
				BX.show(this.popupChatDialogContactListSearch);
			this.redrawChatDialogDest();
		}, this));

		BX.bindDelegate(this.popupChatDialogContactListElements, "click", {className: 'bx-messenger-chatlist-search-button'}, BX.delegate(function() {
			this.popupChatDialogContactListElements.appendChild(BX.create("div", {
				props : { className: "bx-messenger-cl-item-search"},
				html : BX.message('IM_M_CL_SEARCH')
			}));
			BX.remove(BX.proxy_context.parentNode);

			this.BXIM.messenger.realSearch = true;

			BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value, BX.delegate(function(){
				BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': (this.popupChatDialogDestType == 'MENTION'), 'exceptUsers': this.popupChatDialogExceptUsers, timeout: 100, 'callback': {'empty': this.popupChatDialogEmptyCallback}});
			}, this));
		}, this));
	}

	BX.bindDelegate(this.popupChatDialogContactListElements, "click", {className: 'bx-messenger-cl-item'}, BX.delegate(function(e) {
		if (this.popupChatDialogContactListSearch.value != '')
		{
			this.popupChatDialogContactListSearch.value = '';
			if (this.popupChatDialogDestType != 'MENTION' && this.popupChatDialogDestType != 'CHAT_CREATE')
			{
				BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {'viewOffline': true, 'viewChat': false, 'viewOpenChat': false, 'exceptUsers': this.popupChatDialogExceptUsers});
			}
		}

		if (this.popupChatDialogUsers[BX.proxy_context.getAttribute('data-userId')])
		{
			delete this.popupChatDialogUsers[BX.proxy_context.getAttribute('data-userId')];
		}
		else
		{
			if (BX.MessengerCommon.countObject(this.popupChatDialogUsers) == this.popupChatDialogMaxChatUsers)
				return false;

			this.popupChatDialogUsers[BX.proxy_context.getAttribute('data-userId')] = {'id': BX.proxy_context.getAttribute('data-userId'), 'date': new Date()};
		}

		if (this.popupChatDialogDestType == 'MENTION')
		{
			var replaceText = bindElement.value.substr(0, bindElement.selectionEnd);
			replaceText = replaceText.substr(replaceText.lastIndexOf(params.delimiter), bindElement.selectionEnd-replaceText.lastIndexOf(params.delimiter));

			bindElement.value = bindElement.value.replace(replaceText, BX.proxy_context.getAttribute('data-name')+' ');
			BX.MessengerCommon.addMentionList(this.currentTab, BX.proxy_context.getAttribute('data-name'), BX.proxy_context.getAttribute('data-userId'));

			if (this.popupChatDialog)
				this.popupChatDialog.close();
		}
		else
		{
			this.redrawChatDialogDest();
		}

		if (this.popupChatDialogDestType == 'CHAT_CREATE')
		{
			if (this.popupChatDialog)
				this.popupChatDialog.close();
		}

		return BX.PreventDefault(e);
	}, this));
};

BX.MessengerChat.prototype.redrawChatDialogDest = function()
{
	var content = '';
	var count = 0;
	var userId = 0;

	var arMentionSort = BX.util.objectSort(this.popupChatDialogUsers, 'date', 'asc');
	for (var i = 0; i < arMentionSort.length; i++)
	{
		userId = arMentionSort[i].id.toString();
		var isStructure = userId.substr(0, 9) == 'structure';
		var isExtranet = false;
		var blockName = '';
		if (isStructure)
		{
			var structureId = userId.substr(9);
			blockName = this.groups[structureId].name.split(' / ')[0];
		}
		else
		{
			blockName = this.users[userId].name;
			isExtranet = this.users[userId].extranet;
		}

		count++;
		content += '<span class="bx-messenger-dest-block'+(isExtranet? ' bx-messenger-dest-block-extranet': '')+(isStructure? ' bx-messenger-dest-block-structure': '')+'">'+
						'<span class="bx-messenger-dest-text">'+blockName+'</span>'+
					'<span class="bx-messenger-dest-del" data-userId="'+userId+'"></span></span>';
	}

	this.popupChatDialogDestElements.innerHTML = content;
	this.popupChatDialogDestElements.parentNode.scrollTop = this.popupChatDialogDestElements.parentNode.offsetHeight;

	if (this.popupChatDialogDestType != 'CHAT_CREATE')
	{
		if (BX.util.even(count))
			BX.addClass(this.popupChatDialogDestElements.parentNode, 'bx-messenger-popup-newchat-dest-even');
		else
			BX.removeClass(this.popupChatDialogDestElements.parentNode, 'bx-messenger-popup-newchat-dest-even');
	}

	var currentCount = BX.MessengerCommon.countObject(this.popupChatDialogUsers);
	if (currentCount >= this.popupChatDialogMaxChatUsers)
	{
		BX.addClass(this.popupChatDialogContactListSearch, 'bx-messenger-hide');

		if (this.popupChatDialogDestType == 'CHAT_CREATE')
		{
			if (this.popupChatDialog)
				this.popupChatDialog.close();
			this.popupCreateChatTextarea.focus();
		}
	}
	else
	{
		BX.removeClass(this.popupChatDialogContactListSearch, 'bx-messenger-hide');
		if (this.popupChatDialog)
			this.popupChatDialog.adjustPosition();

		this.popupChatDialogContactListSearch.focus();
	}

	if (currentCount)
	{
		BX.removeClass(this.popupChatDialogContactListSearch, 'bx-messenger-input-dest-empty');
	}
	else
	{
		BX.addClass(this.popupChatDialogContactListSearch, 'bx-messenger-input-dest-empty');
	}
};

BX.MessengerChat.prototype.sendRequestChatDialog = function(params)
{
	if (this.popupChatDialogSendBlock)
		return false;

	if (typeof(params) != 'object')
		return false;

	params.type = params.type == 'open'? 'open': 'chat';
	params.users = params.users || [];
	params.message = params.message || "";
	params.title = params.title || "";

	var users = [];
	for (var i = 0; i < params.users.length; i++)
	{
		if (params.users[i].toString().substr(0, 9) == 'structure')
		{
			params.users[i] = parseInt(params.users[i].toString().substr(9));
			if (params.users[i] < 0)
				continue;

			params.users[i] = 'structure'+params.users[i];
		}
		else if (params.users[i].toString().substr(0, 7) == 'network')
		{
		}
		else
		{
			params.users[i] = parseInt(params.users[i]);
			if (params.users[i] < 0)
				continue;
		}

		if (users.indexOf && users.indexOf(params.users[i]) >= 0)
			continue;

		if (params.users[i] == this.BXIM.userId)
			continue;

		if (params.chatId && this.userInChat[params.chatId].indexOf && this.userInChat[params.chatId].indexOf(params.users[i].toString()) >= 0)
			continue;

		users.push(params.users[i]);
	}
	params.users = users;

	var error = '';
	if (params.action == 'CHAT_CREATE' && params.type == 'chat' && params.users.length < 1)
	{
		error = BX.message('IM_M_CHAT_ERROR_1');
	}
	if (params.action == 'CHAT_ADD' && params.type == 'chat' && params.users.length <= 1)
	{
		if (params.users[0] && this.users[params.users[0]])
		{
			this.openMessenger(params.users[0]);
			if (this.popupChatDialog != null)
				this.popupChatDialog.close();

			return false;
		}
		else
		{
			error = BX.message('IM_M_CHAT_ERROR_1');
		}
	}
	else if (params.action == 'CHAT_EXTEND' && params.users.length == 0)
	{
		if (this.popupChatDialog != null)
			this.popupChatDialog.close();

		return false;
	}

	var pureAction = params.action;
	if (params.action == 'CHAT_CREATE')
	{
		params.action = 'CHAT_ADD';
	}

	if (error != "")
	{
		this.BXIM.openConfirm(error);
		return false;
	}

	this.popupChatDialogSendBlock = true;
	if (this.popupChatDialog != null)
		this.popupChatDialog.buttons[0].setClassName('popup-window-button-disable');

	var data = false;
	var logTag = '';
	if (params.action == 'CHAT_ADD')
	{
		data = {'IM_CHAT_ADD' : 'Y', 'TYPE' : params.type, 'TITLE' : params.title, 'MESSAGE' : params.message, 'USERS' : JSON.stringify(params.users), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()};
		logTag = '&logTag='+BX.MessengerCommon.getLogTrackingParams({
			name: 'im.chat.add',
			data: {
				timType: params.type == 'open'? 'open': 'chat',
				timCreateFrom: pureAction == 'CHAT_CREATE'? 'form': 'dialog',
			}
		})
	}
	else if (params.action == 'CHAT_EXTEND')
	{
		data = {'IM_CHAT_EXTEND' : 'Y', 'CHAT_ID' : params.chatId, 'HISTORY': (this.popupChatDialogShowHistory && this.popupChatDialogShowHistory.checked? 'Y':'N'), 'USERS' : JSON.stringify(params.users), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()};
		this.BXIM.options.chatExtendShowHistory = this.popupChatDialogShowHistory && this.popupChatDialogShowHistory.checked;
		BXIM.setLocalConfig('mcesh', this.BXIM.options.chatExtendShowHistory);
	}

	if (!data)
		return false;

	BX.ajax({
		url: this.BXIM.pathToAjax+'?'+params.action+'&V='+this.BXIM.revision+logTag,
		method: 'POST',
		dataType: 'json',
		timeout: 60,
		data: data,
		onsuccess: BX.delegate(function(data){
			this.popupChatDialogSendBlock = false;
			if (this.popupChatDialog != null)
				this.popupChatDialog.buttons[0].setClassName('popup-window-button-accept');
			if (data.ERROR == '')
			{
				if (data.CHAT_ID)
				{
					if (this.BXIM.ppServerStatus && this.currentTab != 'chat'+data.CHAT_ID)
					{
						this.openMessenger('chat'+data.CHAT_ID);
					}
					else if (!this.BXIM.ppServerStatus && this.currentTab != 'chat'+data.CHAT_ID)
					{
						setTimeout( BX.delegate(function(){
							this.openMessenger('chat'+data.CHAT_ID);
						}, this), 500);
					}
				}
				this.popupChatDialogSendBlock = false;
				if (this.popupChatDialog != null)
					this.popupChatDialog.close();
			}
			else
			{
				this.BXIM.openConfirm(data.ERROR);
			}
		}, this)
	});
};

/* CL */
BX.MessengerChat.prototype.openContactList = function()
{
	return this.openMessenger();
};

BX.MessengerChat.prototype.openPopupMenu = function(bind, type, setAngle, params)
{
	params = params? params: {};

	var destroySmilesPopup = params.closeSmiles === false? false: true;
	if (destroySmilesPopup && this.popupSmileMenu != null)
		this.popupSmileMenu.destroy();

	this.closePopupFileMenu();

	if (this.popupPopupMenu != null)
	{
		this.popupPopupMenu.destroy();
		return false;
	}
	var offsetTop = 0;
	var offsetLeft = 13;
	var menuItems = [];
	var bindOptions = {};
	var angleOptions = {offset: 4};
	this.popupPopupMenuStyle = "";

	if (params.offsetTop)
		offsetTop = params.offsetTop;

	if (params.offsetLeft)
		offsetLeft = params.offsetLeft;

	if (params.anglePosition)
		angleOptions.position = params.anglePosition;

	if (type == 'createChat')
	{
		bindOptions = {position: "bottom"};
		if (params.openDesktop)
		{
			menuItems = [
				{icon: 'bx-messenger-cc-private', text: BX.message("IM_CL_PRIVATE_CHAT"), onclick: BX.delegate(function(){
					BX.desktopUtils.goToBx("bx://chat/create/private"); this.closeMenuPopup();
				}, this)},
				{icon: 'bx-messenger-cc-chat', text: BX.message("IM_CL_CHAT_2"), onclick: BX.delegate(function(){
					BX.desktopUtils.goToBx("bx://chat/create/chat"); this.closeMenuPopup();
				}, this)},
				this.BXIM.userExtranet || !this.openChatEnable? null: {icon: 'bx-messenger-cc-open', text: BX.message("IM_CL_OPEN_CHAT"), onclick: BX.delegate(function(){
					BX.desktopUtils.goToBx("bx://chat/create/open"); this.closeMenuPopup();
				}, this)}
			];
		}
		else if (params.openMessenger)
		{
			menuItems = [
				{icon: 'bx-messenger-cc-private', text: BX.message("IM_CL_PRIVATE_CHAT"), onclick: BX.delegate(function(){
					this.openMessenger();this.openChatCreateForm('private'); this.closeMenuPopup();
				}, this)},
				{icon: 'bx-messenger-cc-chat', text: BX.message("IM_CL_CHAT_2"), onclick: BX.delegate(function(){
					this.openMessenger();this.openChatCreateForm('chat'); this.closeMenuPopup();
				}, this)},
				this.BXIM.userExtranet || !this.openChatEnable? null: {icon: 'bx-messenger-cc-open', text: BX.message("IM_CL_OPEN_CHAT"), onclick: BX.delegate(function(){
					this.openMessenger();this.openChatCreateForm('open'); this.closeMenuPopup();
				}, this)}
			];
		}
		else
		{
			menuItems = [
				{icon: 'bx-messenger-cc-private', text: BX.message("IM_CL_PRIVATE_CHAT"), onclick: BX.delegate(function(){
					this.openChatCreateForm('private'); this.closeMenuPopup();
				}, this)},
				{icon: 'bx-messenger-cc-chat', text: BX.message("IM_CL_CHAT_2"), onclick: BX.delegate(function(){
					this.openChatCreateForm('chat'); this.closeMenuPopup();
				}, this)},
				this.BXIM.userExtranet || !this.openChatEnable? null: {icon: 'bx-messenger-cc-open', text: BX.message("IM_CL_OPEN_CHAT"), onclick: BX.delegate(function(){
					this.openChatCreateForm('open'); this.closeMenuPopup();
				}, this)}
			];
		}
	}
	else if (type == 'pathMenu')
	{
		var chatId = this.getChatId();
		var pathOptions = BX.MessengerCommon.getEntityTypePath(chatId);

		offsetTop = 5;
		offsetLeft = 14;
		menuItems = [];

		if(this.BXIM.checkCallSupport(this.currentTab))
		{
			menuItems.push(
				{icon: 'bx-messenger-menu-call-video', text: BX.message('IM_M_CALL_VIDEO'), onclick: BX.delegate(function(){ this.BXIM.callTo(this.currentTab, true); this.closeMenuPopup(); }, this)}
			);
			menuItems.push(
				{icon: 'bx-messenger-menu-call-voice', text: BX.message('IM_M_CALL_VOICE'), onclick: BX.delegate(function(){ this.BXIM.callTo(this.currentTab, false); this.closeMenuPopup(); }, this)}
			);
			menuItems.push(
				{separator: true}
			);
		}
		menuItems.push(
			{icon: 'bx-messenger-menu-crm', text: pathOptions['TITLE'], href: pathOptions['PATH'], target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}
		);
		menuItems.push(
			{icon: 'bx-messenger-menu-history-2', text: BX.message("IM_M_HISTORY"), onclick: BX.delegate(function(){ this.openHistory(this.currentTab); this.closeMenuPopup(); }, this)}
		);
	}
	else if (type == 'openLinesMenu')
	{
		var chatId = this.getChatId();
		var isOwner = this.chat[chatId].owner == this.BXIM.userId;
		var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);

		offsetTop = 5;
		offsetLeft = 14;
		menuItems = [
			isOwner? {icon: 'bx-messenger-menu-pause', text: BX.message(session.pin == "Y"? "IM_M_OL_PAUSE_OFF": "IM_M_OL_PAUSE_ON"), onclick: BX.delegate(function(){  this.linesTogglePinMode();  this.closeMenuPopup(); }, this)}: null,
			isOwner && session.crm != 'Y'? {icon: 'bx-messenger-menu-crm', text: BX.message("IM_M_OL_ADD_LEAD"), onclick: BX.delegate(function(){  this.linesCreateLead(); this.closeMenuPopup(); }, this)}: null,
			session.crmLink && session.crmLinkLead == 'undefined' && session.crmLinkCompany == 'undefined' && session.crmLinkContact == 'undefined' && session.crmLinkDeal == 'undefined'? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM'), href: session.crmLink, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			session.crmLinkLead? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM_LEAD'), href: session.crmLinkLead, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			session.crmLinkCompany? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM_COMPANY'), href: session.crmLinkCompany, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			session.crmLinkContact? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM_CONTACT'), href: session.crmLinkContact, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			session.crmLinkDeal? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM_DEAL'), href: session.crmLinkDeal, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			//isOwner? {icon: 'bx-messenger-menu-close', text: BX.message("IM_M_OL_CLOSE"), onclick: BX.delegate(function(){  this.linesCloseDialog();  this.closeMenuPopup(); }, this)}: null,
			{icon: 'bx-messenger-menu-history-2', text: BX.message("IM_M_HISTORY"), onclick: BX.delegate(function(){ this.openHistory(this.currentTab); this.closeMenuPopup(); }, this)},
			session.id? {separator: true}:null,
			!isOwner && session.id? {icon: 'bx-messenger-menu-intercept', text: BX.message("IM_M_OL_INTERCEPT"), onclick: BX.delegate(function(){  this.linesInterceptSession();  this.closeMenuPopup(); }, this)}: null,
			isOwner && session.id? {icon: 'bx-messenger-menu-spam', text: BX.message("IM_M_OL_FORCE_CLOSE"), onclick: BX.delegate(function(){  this.linesMarkAsSpam();  this.closeMenuPopup(); }, this)}: null
		];
	}
	else if (type == 'textareaAppsMenu')
	{
		menuItems = [];
		for (var i = 0; i < this.textareaIcon.length; i++)
		{
			if (!this.textareaIcon[i] || this.BXIM.userExtranet && !this.textareaIcon[i]['extranet'] || this.textareaIcon[i].hidden)
			{
				continue;
			}

			if (this.desktop.ready() && !this.desktop.enableInVersion(39) && this.textareaIcon[i]['iframe'])
			{
				if (BXDesktopSystem.GetProperty('versionParts').join('.') != '5.0.32.38') // TODO remove this
				{
					continue;
				}
			}

			if (!this.textareaIcon[i]['title'] && !this.textareaIcon[i]['url'])
			{
				continue;
			}

			if (this.textareaIcon[i]['url'])
			{
				continue;
			}
			var title = this.textareaIcon[i]['description']? this.textareaIcon[i]['description']: this.textareaIcon[i]['title'];

			menuItems.push({
				text: BX.util.htmlspecialchars(this.textareaIcon[i]['title']),
				onclick: BX.delegate(function(e){
					this.textareaIconClick();

					return BX.PreventDefault(e);
				}, this),
				attrs : {
					title: title,
					"data-context": this.textareaIcon[i]['context'],
					"data-code": this.textareaIcon[i]['code'],
					"data-id": this.textareaIcon[i]['id']
				},
			});
		}

		offsetTop = 5;
		offsetLeft = 14;
	}
	else if (type == 'status')
	{
		offsetLeft = 9;
		bindOptions = {position: "top"};
		menuItems = [
			{icon: 'bx-messenger-status-online', text: BX.message("IM_STATUS_ONLINE"), onclick: BX.delegate(function(){ this.setStatus('online'); this.closeMenuPopup(); }, this)},
			{icon: 'bx-messenger-status-away', text: BX.message("IM_STATUS_AWAY"), onclick: BX.delegate(function(){ this.setStatus('away'); this.closeMenuPopup(); }, this)},
			{icon: 'bx-messenger-status-dnd', text: BX.message("IM_STATUS_DND"), onclick: BX.delegate(function(){ this.setStatus('dnd'); this.closeMenuPopup(); }, this)}
		];
	}
	else if (type == 'iconMenu')
	{
		var iconId = bind.getAttribute('data-id');
		menuItems = [
			{text: BX.message("IM_MENU_DELETE"), onclick: BX.delegate(function(e){
				this.removeRecentSmile(iconId);
				BX.remove(bind);
				this.popupPopupMenu.close();
				return BX.PreventDefault(e);
			}, this)},
		];
	}
	else if (type == 'notifyDelete')
	{
		var notifyId = bind.getAttribute('data-notifyId');
		var settingName = this.notify.notify[notifyId].settingName;
		var blockNotifyText = typeof (this.BXIM.settingsNotifyBlocked[settingName]) == 'undefined'? BX.message("IM_NOTIFY_DELETE_2"): BX.message("IM_NOTIFY_DELETE_3");
		if (typeof(params.applyToDom) != 'undefined')
		{
			bind = params.applyToDom;
		}
		menuItems = [
			this.notify.unreadNotify[notifyId]? {text: BX.message("IM_MENU_READ"), onclick: BX.delegate(function(){ this.notify.viewNotify(notifyId, true); this.closeMenuPopup(); }, this)}: null,
			!this.notify.unreadNotify[notifyId]? {text: BX.message("IM_MENU_UNREAD"), onclick: BX.delegate(function(){ this.notify.viewNotify(notifyId, false); this.closeMenuPopup(); }, this)}: null,
			{text: BX.message("IM_NOTIFY_DELETE_1"), onclick: BX.delegate(function(){ this.notify.deleteNotify(notifyId); this.closeMenuPopup(); }, this)},
			{text: blockNotifyText, onclick: BX.delegate(function(){ this.notify.blockNotifyType(settingName); this.closeMenuPopup(); }, this)}
		];
	}
	else if (type == 'callMenu')
	{
		offsetTop = 2;
		offsetLeft = 20;

		menuItems = [
			{icon: 'bx-messenger-menu-call-video', text: BX.message('IM_M_CALL_VIDEO'), onclick: BX.delegate(function(){ this.BXIM.callTo(this.currentTab, true); this.closeMenuPopup(); }, this)},
			{icon: 'bx-messenger-menu-call-voice', text: BX.message('IM_M_CALL_VOICE'), onclick: BX.delegate(function(){ this.BXIM.callTo(this.currentTab, false); this.closeMenuPopup(); }, this)},
		];

		if (this.BXIM.webrtc.phoneCanCallUserNumber && !this.openChatFlag && this.phones[this.currentTab])
		{
			menuItems.push({separator: true});

			if (this.phones[this.currentTab].PERSONAL_MOBILE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_MOBILE'), phone: BX.util.htmlspecialchars(this.phones[this.currentTab].PERSONAL_MOBILE), onclick: BX.delegate(function(){ this.BXIM.phoneTo(this.phones[this.currentTab].PERSONAL_MOBILE); this.closeMenuPopup(); }, this)}
				);
			}

			if (this.phones[this.currentTab].PERSONAL_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_PHONE'), phone: BX.util.htmlspecialchars(this.phones[this.currentTab].PERSONAL_PHONE), onclick: BX.delegate(function(){ this.BXIM.phoneTo(this.phones[this.currentTab].PERSONAL_PHONE); this.closeMenuPopup(); }, this)}
				);
			}

			if (this.phones[this.currentTab].WORK_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_WORK_PHONE'), phone: BX.util.htmlspecialchars(this.phones[this.currentTab].WORK_PHONE), onclick: BX.delegate(function(){ this.BXIM.phoneTo(this.phones[this.currentTab].WORK_PHONE); this.closeMenuPopup(); }, this)}
				);
			}

			if (this.phones[this.currentTab].INNER_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_INNER_PHONE'), phone: BX.util.htmlspecialchars(this.phones[this.currentTab].INNER_PHONE), onclick: BX.delegate(function(){ this.BXIM.phoneTo(this.phones[this.currentTab].INNER_PHONE); this.closeMenuPopup(); }, this)}
				);
			}
		}
	}
	else if (type == 'callPhoneMenu')
	{
		offsetTop = 2;
		offsetLeft = 25;

		menuItems = [
			{icon: 'bx-messenger-menu-call-'+(params.video? 'video': 'voice'), text: '<b>'+BX.message('IM_M_CALL_BTN_RECALL_3')+'</b>', onclick: BX.delegate(function(){ this.webrtc.callInvite(params.userId, params.video) }, this)}
		];
		menuItems.push({separator: true});
		if (this.phones[params.userId] && this.BXIM.webrtc.phoneCanCallUserNumber)
		{
			menuItems.push({separator: true});

			if (this.phones[params.userId].PERSONAL_MOBILE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_MOBILE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].PERSONAL_MOBILE), onclick: BX.delegate(function(){
						this.BXIM.phoneTo(this.phones[params.userId].PERSONAL_MOBILE);
						this.closeMenuPopup();
					}, this)}
				);
			}

			if (this.phones[params.userId].PERSONAL_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_PHONE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].PERSONAL_PHONE), onclick: BX.delegate(function(){
						this.BXIM.phoneTo(this.phones[params.userId].PERSONAL_PHONE);
						this.closeMenuPopup();
					}, this)}
				);
			}

			if (this.phones[params.userId].WORK_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_WORK_PHONE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].WORK_PHONE), onclick: BX.delegate(function(){
						this.BXIM.phoneTo(this.phones[params.userId].WORK_PHONE);
						this.closeMenuPopup();
					}, this)}
				);
			}
		}
	}
	else if (type == 'callTransferMenu')
	{
		offsetTop = 2;
		offsetLeft = 25;
		params.onSelect = BX.type.isFunction(params.onSelect) ? params.onSelect : BX.DoNothing;

		menuItems = [
			{icon: 'bx-messenger-menu-call-voice', text: BX.message('IM_PHONE_INNER_CALL'), onclick: BX.delegate(function(){
				this.closeMenuPopup();
				params.onSelect({
					type: 'user',
					userId: params.userId
				});
			}, this)}
		];

		if (this.phones[params.userId])
		{
			menuItems.push({separator: true});

			if (this.phones[params.userId].PERSONAL_MOBILE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_MOBILE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].PERSONAL_MOBILE), onclick: BX.delegate(function(){
						this.closeMenuPopup();
						params.onSelect({
							type: 'phone',
							userId: params.userId,
							phone: this.phones[params.userId].PERSONAL_MOBILE
						});
					}, this)}
				);
			}

			if (this.phones[params.userId].PERSONAL_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_PERSONAL_PHONE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].PERSONAL_PHONE), onclick: BX.delegate(function(){
						this.closeMenuPopup();
						params.onSelect({
							type: 'phone',
							userId: params.userId,
							phone: this.phones[params.userId].PERSONAL_PHONE
						});
					}, this)}
				);
			}

			if (this.phones[params.userId].WORK_PHONE)
			{
				menuItems.push(
					{type: 'call', text: BX.message('IM_PHONE_WORK_PHONE'), phone: BX.util.htmlspecialchars(this.phones[params.userId].WORK_PHONE), onclick: BX.delegate(function(){
						this.closeMenuPopup();
						params.onSelect({
							type: 'phone',
							userId: params.userId,
							phone: this.phones[params.userId].WORK_PHONE
						});
					}, this)}
				);
			}
		}
	}
	else if (type == 'callContextMenu')
	{
		var callData = BX.MessengerCommon.phoneGetCallFields(this.getChatId());
		menuItems = [
			{icon: 'bx-messenger-menu-history-2', text: BX.message("IM_M_HISTORY"), onclick: BX.delegate(function(){ this.openHistory(this.currentTab); this.closeMenuPopup(); }, this)},
			callData.crm ? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM'), href: callData.crmShowUrl, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)} : null
		];
	}
	else if (type == 'chatUser')
	{
		var userId = bind.getAttribute('data-userId');
		var chatId = this.getChatId();
		var isOwner = this.chat[chatId].owner == this.BXIM.userId;

		if (this.users[this.BXIM.userId].connector)
		{
			return false;
		}
		if (userId == this.BXIM.userId)
		{
			var hideExit =  false;
			if (BX.MessengerCommon.checkRestriction(chatId, isOwner? 'LEAVE_OWNER': 'LEAVE'))
			{
				hideExit = true;
			}
			else
			{
				hideExit = this.chat[chatId].type == 'lines' && (this.chat[chatId].owner == 0 || this.chat[chatId].owner == this.BXIM.userId);
			}
			menuItems = [
				{icon: 'bx-messenger-menu-profile', text: BX.message('IM_M_OPEN_PROFILE'), href: this.BXIM.path.profile, onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)},
				hideExit? null: {icon: 'bx-messenger-menu-chat-exit', text: BX.message('IM_M_CHAT_EXIT'), onclick: BX.delegate(function(){ BX.MessengerCommon.leaveFromChat(chatId); this.closeMenuPopup();}, this)}
			];
		}
		else if (this.chat[chatId].type == 'lines' && this.users[userId].connector)
		{
			//var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);
			menuItems = [
				{icon: 'bx-messenger-menu-chat-put', text: BX.message('IM_M_CHAT_PUT'), onclick: BX.delegate(function(){ this.insertTextareaText(this.popupMessengerTextarea, ' '+BX.util.htmlspecialcharsback(this.users[userId].name)+' ', false); BX.MessengerCommon.addMentionList(this.currentTab, BX.util.htmlspecialcharsback(this.users[userId].name), userId); this.popupMessengerTextarea.focus(); this.closeMenuPopup(); }, this)},
				//isOwner && session.crm != 'Y'? {icon: 'bx-messenger-menu-crm', text: BX.message("IM_M_OL_ADD_LEAD"), onclick: BX.delegate(function(){  this.linesCreateLead(); this.closeMenuPopup(); }, this)}: null,
				//session.crmLink? {icon: 'bx-messenger-menu-crm', text: BX.message('IM_M_OL_GOTO_CRM'), href: session.crmLink, target: '_blank', onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: null,
			];
		}
		else
		{
			var canKick = !BX.MessengerCommon.checkRestriction(chatId, 'LEAVE') && this.chat[chatId].owner == this.BXIM.userId;
			var userInChat = true;
			if (chatId != this.generalChatId)
			{
				userInChat = BX.MessengerCommon.userInChat(chatId);
			}
			else if (!this.canSendMessageGeneralChat || this.BXIM.settings.generalNotify)
			{
				userInChat = false;
			}
			if (canKick && this.chat[chatId].type == 'open')
			{
				canKick = this.users[userId].extranet? true: false;
			}
			menuItems = [
				!userInChat? null: {icon: 'bx-messenger-menu-chat-put', text: BX.message('IM_M_CHAT_PUT'), onclick: BX.delegate(function(){ this.insertTextareaText(this.popupMessengerTextarea, ' '+BX.util.htmlspecialcharsback(this.users[userId].name)+' ', false); BX.MessengerCommon.addMentionList(this.currentTab, BX.util.htmlspecialcharsback(this.users[userId].name), userId); this.popupMessengerTextarea.focus(); this.closeMenuPopup(); }, this)},
				{icon: 'bx-messenger-menu-write', text: BX.message('IM_M_WRITE_MESSAGE'), onclick: BX.delegate(function(){ this.openMessenger(userId); this.closeMenuPopup(); }, this)},
				(!this.BXIM.checkCallSupport(userId) || this.BXIM.callController.hasActiveCall())? null: {icon: 'bx-messenger-menu-video', text: BX.message('IM_M_CALL_VIDEO'), onclick: BX.delegate(function(){ this.BXIM.callTo(userId, true); this.closeMenuPopup(); }, this)},
				{icon: 'bx-messenger-menu-history', text: BX.message('IM_M_OPEN_HISTORY'), onclick: BX.delegate(function(){ this.openHistory(userId); this.closeMenuPopup();}, this)},
				{icon: 'bx-messenger-menu-profile', text: BX.message('IM_M_OPEN_PROFILE'), href: this.users[userId].profile, onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)},
				canKick? {icon: 'bx-messenger-menu-chat-exit', text: BX.message('IM_M_CHAT_KICK'), onclick: BX.delegate(function(){ this.kickFromChat(chatId, userId); this.closeMenuPopup();}, this)}: {}
			];
		}
	}
	else if (type == 'contactList')
	{
		offsetTop = 2;
		offsetLeft = 25;
		var userId = bind.getAttribute('data-userId');
		var userIsChat = bind.getAttribute('data-userIsChat') === true || bind.getAttribute('data-userIsChat') == "true";
		var dialogIsPinned = bind.getAttribute('data-isPinned') === true || bind.getAttribute('data-isPinned') == "true";
		var isOwner = userIsChat && this.chat[userId.toString().substr(4)].owner == this.BXIM.userId;

		if (this.recentList || userIsChat)
		{
			var isOpenlines = this.chat[userId.toString().substr(4)] && this.chat[userId.toString().substr(4)].type == 'lines';

			var chatMuteText = BX.message('IM_M_CHAT_MUTE_OFF');
			var muteEnable = false;
			if (userIsChat)
			{
				muteEnable = true;
			}
			else if (this.users[userId].extranet)
			{
				muteEnable = true;
			}

			if (muteEnable && this.muteButtonStatus(userId))
			{
				chatMuteText = BX.message('IM_M_CHAT_MUTE_ON');
			}

			var dialogPinnedText = BX.message(!dialogIsPinned? 'IM_M_OL_PIN_ON': 'IM_M_OL_PIN_OFF');

			hideItem = !BX.MessengerCommon.userInChat(userId.toString().substr(4));

			menuItems = [
				isOpenlines? null: {icon: 'bx-messenger-menu-write', text: BX.message('IM_M_WRITE_MESSAGE'), onclick: BX.delegate(function(){ this.openMessenger(userId); this.closeMenuPopup(); }, this)},
				isOpenlines? null: {icon: 'bx-messenger-menu-pin', text: dialogPinnedText, onclick: BX.delegate(function(){ BX.MessengerCommon.pinDialog(userId, !dialogIsPinned); this.closeMenuPopup(); }, this)},
				!isOpenlines && !hideItem && muteEnable ? {icon: 'bx-messenger-menu-chat-mute', text: chatMuteText, onclick: BX.delegate(function(){ BX.MessengerCommon.muteMessageChat(userId); this.closeMenuPopup();}, this)}: {},
				isOpenlines || (!this.BXIM.checkCallSupport(userId) || this.BXIM.callController.hasActiveCall()) || (userIsChat && (this.chat[userId.toString().substr(4)].type == 'call' || this.chat[userId.toString().substr(4)].type == 'lines'))? null: {icon: 'bx-messenger-menu-video', text: BX.message('IM_M_CALL_VIDEO'), onclick: BX.delegate(function(){ this.BXIM.callTo(userId, true); this.closeMenuPopup(); }, this)},
				hideItem && !userIsChat? null: {icon: 'bx-messenger-menu-history', text: BX.message('IM_M_OPEN_HISTORY'), onclick: BX.delegate(function(){ this.openHistory(userId); this.closeMenuPopup();}, this)},
				!userIsChat? {icon: 'bx-messenger-menu-profile', text: BX.message('IM_M_OPEN_PROFILE'), href: this.users[userId].profile, onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}: {},
				!hideItem && userIsChat && this.chat[userId.toString().substr(4)].type != 'call' && !BX.MessengerCommon.checkRestriction(userId.toString().substr(4), 'RENAME') ? {icon: 'bx-messenger-menu-chat-rename', text: BX.message('IM_M_CHAT_RENAME'), onclick: BX.delegate(function(){ if (this.currentTab != userId) { this.openMessenger(userId); } else { this.renameChatDialog(); }   this.closeMenuPopup();}, this)}: {},
				isOpenlines || userIsChat && !this.recentList? null: {icon: 'bx-messenger-menu-hide-'+(userIsChat? 'chat': 'dialog'), text: BX.message('IM_M_HIDE_'+(userIsChat? (this.chat[userId.toString().substr(4)].type == 'call'? 'CALL': 'CHAT'): 'DIALOG')), onclick: BX.delegate(function(){ BX.MessengerCommon.recentListHide(userId); this.closeMenuPopup();}, this)},
				!hideItem && userIsChat && this.chat[userId.toString().substr(4)].type != 'call' && this.chat[userId.toString().substr(4)].type != 'lines' && !BX.MessengerCommon.checkRestriction(userId.toString().substr(4), (isOwner? 'LEAVE_OWNER': 'LEAVE'))? {icon: 'bx-messenger-menu-chat-exit', text: BX.message('IM_M_CHAT_EXIT'), onclick: BX.delegate(function(){ BX.MessengerCommon.leaveFromChat(userId.toString().substr(4)); this.closeMenuPopup();}, this)}: {}
			];
		}
		else
		{
			menuItems = [
				{icon: 'bx-messenger-menu-write', text: BX.message('IM_M_WRITE_MESSAGE'), onclick: BX.delegate(function(){ this.openMessenger(userId); this.closeMenuPopup(); }, this)},
				(!userIsChat && (!this.BXIM.checkCallSupport(userId) || this.BXIM.callController.hasActiveCall()))? null: {icon: 'bx-messenger-menu-video', text: BX.message('IM_M_CALL_VIDEO'), onclick: BX.delegate(function(){ this.BXIM.callTo(userId, true); this.closeMenuPopup(); }, this)},
				{icon: 'bx-messenger-menu-history', text: BX.message('IM_M_OPEN_HISTORY'), onclick: BX.delegate(function(){ this.openHistory(userId); this.closeMenuPopup();}, this)},
				{icon: 'bx-messenger-menu-profile', text: BX.message('IM_M_OPEN_PROFILE'), href: this.users[userId].profile, onclick: BX.delegate(function(){ this.closeMenuPopup(); }, this)}
			];
		}
	}
	else if (type == 'dialogContext' || type == 'dialogMenu')
	{
		var messages = [];
		if (type == 'dialogMenu')
		{
			this.popupPopupMenuStyle = 'bx-messenger-content-item-menu-hover';
			angleOptions = {offset: 12};
			if (bind.parentNode.parentNode)
			{
				messages = [BX('im-message-'+bind.parentNode.parentNode.getAttribute('data-blockmessageid'))];
			}
		}
		else
		{
			var foundTarget = false;
			if (bind.target.className.indexOf("bx-messenger-file") >= 0 || bind.target.className.indexOf("bx-bxu-proper-canvas") >= 0)
			{
				var fileBox = BX.findParent(bind.target, {className : "bx-messenger-file-box"});
				if (fileBox && fileBox.previousSibling)
				{
					foundTarget = true;
					messages = [fileBox.previousSibling];
				}
			}
			if (!foundTarget)
			{
				if (BX.hasClass(bind.target,"bx-messenger-message"))
				{
					messages = [bind.target];
				}
				else if (bind.target.className.indexOf("bx-messenger-content-quote") >= 0)
				{
					messages = BX.findParent(bind.target, {className : "bx-messenger-message"});
					messages = [messages];
				}
				else
				{
					messages = BX.findChildrenByClassName(bind.target, "bx-messenger-message");
				}
				if (messages.length <= 0)
				{
					messages = BX.findParent(bind.target, {className : "bx-messenger-message"});
					if (!messages)
					{
						if (bind.target.className.substr(0, 19) == 'bx-messenger-attach')
						{
							var attach = BX.findParent(bind.target, {className : "bx-messenger-attach-box"});
							messages = attach.previousSibling;
						}
					}
					messages = [messages];
				}
			}
		}
		if (messages.length <= 0 || !messages[messages.length-1])
			return false;

		var messageName = BX.message('IM_M_SYSTEM_USER');
		var messageId = messages[messages.length-1].id.replace('im-message-','');
		if (this.message[messageId].senderId && this.users[this.message[messageId].senderId])
			messageName = this.users[this.message[messageId].senderId].name;

		if (messageId.substr(0,4) == 'temp')
			return false;

		var messageDate = this.message[messageId].date;
		var selectedText = type == 'dialogContext'? BX.desktop.clipboardSelected(): {'text': "", selectionStart: 0, selectionEnd: 0};

		var copyLink = false;
		var userName = '';
		var userId = this.message[messageId].senderId;
		var canShareToCalend = this.message[messageId].params && this.message[messageId].params.DATE_TS && this.message[messageId].params.DATE_TS.length > 0;
		if (this.openChatFlag && this.message[messageId].senderId != this.BXIM.userId && this.users[this.message[messageId].senderId])
		{
			userName = this.users[this.message[messageId].senderId].name;
		}

		var saveIconTarget = null;
		var copyLinkHref = '';
		if (type == 'dialogContext' && (
			bind.target.tagName == 'SPAN' && bind.target.parentNode.parentNode.tagName == 'A' ||
			bind.target.tagName == 'CANVAS' && bind.target.parentNode.tagName == 'A' ||
			bind.target.tagName == 'IMG' && bind.target.parentNode.tagName == 'A' ||
			bind.target.tagName == 'A'
		))
		{
			if (bind.target.tagName == 'A')
				copyLinkHref = bind.target.href;
			else if (bind.target.parentNode.tagName == 'A')
				copyLinkHref = bind.target.parentNode.href;
			else if (bind.target.parentNode.parentNode.tagName == 'A')
				copyLinkHref = bind.target.parentNode.parentNode.href;

			if (copyLinkHref.indexOf('/desktop_app/') < 0)
				copyLink = true;
		}
		else if (type == 'dialogContext' && bind.target.tagName == 'IMG' && bind.target.classList.contains('bx-icon'))
		{
			saveIconTarget = bind.target.src;
		}

		var copyFile = this.message[messageId].params && this.message[messageId].params.FILE_ID && this.message[messageId].params.FILE_ID.length > 0 && BX.clipboard.isCopySupported();

		var getClipboard = false;
		if (type == 'dialogContext' && BX.desktop)
		{
			getClipboard = true;
		}

		var canEdit = false;
		var canDelete = false;
		if (BX.MessengerCommon.checkEditMessage(messageId, 'edit'))
		{
			canEdit = true;
		}
		if (BX.MessengerCommon.checkEditMessage(messageId, 'delete'))
		{
			canDelete = true;
		}

		if (this.openChatFlag && this.message[messageId].chatId && !BX.MessengerCommon.userInChat(this.message[messageId].chatId))
		{
			return false;
		}

		var generalAccessBlock = false;
		if (this.openChatFlag && this.message[messageId].chatId && this.generalChatId == this.message[messageId].chatId)
		{
			if (this.BXIM.isAdmin && !this.message[messageId].isNowDeleted)
			{
				canDelete = true;
			}
			if (!this.canSendMessageGeneralChat)
			{
				generalAccessBlock = true;
			}
		}

		var hideBlockCreate = selectedText.text.length > 0 || this.users[this.BXIM.userId].extranet;
		var hideElementCreateOl = hideBlockCreate || !this.chat[this.message[messageId].chatId] || this.chat[this.message[messageId].chatId].entity_type != 'LINES';

		var linesQuickAnswersItem =
		{
			text: BX.message("IM_MENU_TO_OL_QA"),
			onclick: BX.delegate(function()
			{
				BX.MessengerCommon.linesSaveToQuickAnswers(messageId);
				this.closeMenuPopup();
			}, this)
		};
		if(this.message[messageId].quick_saved)
		{
			linesQuickAnswersItem.text = BX.message("IM_MENU_TO_OL_QA_ADDED");
			linesQuickAnswersItem.onclick = null;
		}

		menuItems = [
			userName.length <= 0 || generalAccessBlock? null: {text: BX.message("IM_MENU_ANSWER"), onclick: BX.delegate(function(e){ this.insertTextareaText(this.popupMessengerTextarea, ' '+BX.util.htmlspecialcharsback(userName)+' ', false); BX.MessengerCommon.addMentionList(this.currentTab, BX.util.htmlspecialcharsback(userName), userId);  setTimeout(BX.delegate(function(){ this.popupMessengerTextarea.focus(); }, this), 200);  this.closeMenuPopup(); }, this)},
			userName.length <= 0 || generalAccessBlock? null: {separator: true},
			copyLink? {text: BX.message("IM_MENU_COPY3"), onclick: BX.delegate(function()
				{
					BX.clipboard.copy(copyLinkHref);
					this.closeMenuPopup();
				}, this)
			}: null,
			copyFile? {text: BX.message("IM_MENU_COPY_FILE"), onclick: BX.delegate(function()
				{
					var text = '';
					for (var i = 0; i < this.message[messageId].params.FILE_ID.length; i++)
					{
						text = text+'[DISK='+this.message[messageId].params.FILE_ID[i]+']';
					}
					BX.clipboard.copy(text);
					this.closeMenuPopup();
				}, this)
			}: null,
			saveIconTarget? {text: BX.message("IM_SETTINGS_SAVE"), onclick: BX.delegate(function()
				{
					this.addRecentSmile(this.message[messageId].text, saveIconTarget);
					this.closeMenuPopup();
				}, this)
			}: null,
			saveIconTarget || copyFile || copyLink && this.message[messageId].text? {separator: true}: null,
			userId == this.BXIM.userId || selectedText.text.length > 0 ? null: {text: BX.message("IM_MENU_UNREAD"), onclick: BX.delegate(function(){ BX.MessengerCommon.unreadMessage(messageId); this.closeMenuPopup(); }, this)}, // TODO this
			userId == this.BXIM.userId ? null: {separator: true},
			selectedText.text.length <= 0 || generalAccessBlock? null: {text: BX.message("IM_MENU_QUOTE"), onclick: BX.delegate(function(){ var text = BX.IM.getSelectionText(); this.insertQuoteText(messageName, messageDate, text); this.closeMenuPopup(); }, this)},
			generalAccessBlock || selectedText.text.length > 0 || (!this.message[messageId].text && (!this.message[messageId].params || !this.message[messageId].params.FILE_ID || this.message[messageId].params.FILE_ID.length <= 0)) ? null: {text: BX.message("IM_MENU_QUOTE2"), onclick: BX.delegate(function()
				{
					var arQuote = [];
					for (var i = 0; i < messages.length; i++)
					{
						var messageId = messages[i].id.replace('im-message-','');
						if (this.message[messageId])
						{
							if (this.message[messageId].text)
							{
								arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
							}
							if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
							{
								for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
								{
									var fileId = this.message[messageId].params.FILE_ID[j];
									var chatId = this.message[messageId].chatId;
									if (this.disk.files[chatId][fileId])
									{
										arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
									}
								}
							}
						}
					}
					if (arQuote.length > 0)
					{
						this.insertQuoteText(messageName, messageDate, arQuote.join("\n"));
					}

					this.closeMenuPopup();
				}, this)
			},
			!getClipboard || selectedText.text.length <= 0? null: {text: BX.message("IM_MENU_COPY"), onclick: BX.delegate(function(){ BX.desktop.clipboardCopy(); this.closeMenuPopup(); }, this)},
			!getClipboard || !this.message[messageId].text || selectedText.text.length > 0? null: {text: BX.message("IM_MENU_COPY2"), onclick: BX.delegate(function()
				{
					var arQuote = [];
					for (var i = 0; i < messages.length; i++)
					{
						var messageId = messages[i].id.replace('im-message-','');
						if (this.message[messageId])
						{
							if (this.message[messageId].text)
							{
								arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
							}
							if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
							{
								for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
								{
									var fileId = this.message[messageId].params.FILE_ID[j];
									var chatId = this.message[messageId].chatId;
									if (this.disk.files[chatId][fileId])
									{
										arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
									}
								}
							}
						}
					}
					if (arQuote.length > 0)
					{
						BX.desktop.clipboardCopy(BX.delegate(function (value)
						{
							return this.insertQuoteText(messageName, messageDate, arQuote.join("\n"), false);
						}, this));
					}
					this.closeMenuPopup();
				}, this)
			},
			hideBlockCreate? null: {separator: true},
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_TASK"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'TASK'); this.closeMenuPopup(); }, this)},
			hideBlockCreate || !canShareToCalend? null: {text: BX.message("IM_MENU_TO_CALEND"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'CALEND'); this.closeMenuPopup(); }, this)},
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_CHAT"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'CHAT'); this.closeMenuPopup(); }, this)},
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_POST"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'POST'); this.closeMenuPopup(); }, this)},
			hideElementCreateOl? null: {separator: true},
			hideElementCreateOl? null: {text: BX.message("IM_MENU_TO_OL_START"), onclick: BX.delegate(function(){ BX.MessengerCommon.linesStartSessionByMessage(messageId); this.closeMenuPopup(); }, this)},
			hideElementCreateOl? null: linesQuickAnswersItem,
			!(!canEdit || this.message[messageId].senderId != this.BXIM.userId) || canDelete? {separator: true}: null,
			!canEdit || this.message[messageId].senderId != this.BXIM.userId? null: {text: BX.message("IM_MENU_EDIT"), onclick: BX.delegate(function() {this.editMessage(messageId);this.closeMenuPopup();}, this)},
			!canDelete? null: {text: BX.message("IM_M_HISTORY_DELETE"), onclick: BX.delegate(function() {this.deleteMessage(messageId, false);this.closeMenuPopup();}, this)}
		];
		if (this.message[messageId].params && this.message[messageId].params.MENU)
		{
			var firstPush = true;
			for (var i = 0; i < this.message[messageId].params.MENU.length; i++)
			{
				var menuItem = this.message[messageId].params.MENU[i];
				if (
					menuItem.CONTEXT &&
					(
						BX.MessengerCommon.isMobile() && menuItem.CONTEXT == 'DESKTOP' ||
						!BX.MessengerCommon.isMobile() && menuItem.CONTEXT == 'MOBILE'
					)
				)
				{
					continue;
				}
				if (firstPush)
				{
					menuItems.push({separator: true});
					firstPush = false;
				}
				var disabled = menuItem.DISABLED == 'Y';
				menuItems.push({
					text: menuItem.TEXT,
					disabled: disabled,
					icon: 'bx-messenger-menu-important',
					dataParams: menuItem,
					href: menuItem.LINK? menuItem.LINK: "",
					onclick: disabled? null: BX.delegate(function() {

						var menuItem = JSON.parse(BX.proxy_context.getAttribute('data-params'));

						if (menuItem.FUNCTION)
						{
							var userFunc = menuItem.FUNCTION.toString().replace('#MESSAGE_ID#', messageId).replace('#DIALOG_ID#', dialogId).replace('#USER_ID#', this.BXIM.userId);
							userFunc();
						}
						else if (menuItem.APP_ID)
						{
							menuItem.APP_PARAMS = menuItem.APP_PARAMS? menuItem.APP_PARAMS: '';
							this.textareaIconDialogClick(parseInt(menuItem.APP_ID), messageId, BX.util.htmlspecialchars(menuItem.APP_PARAMS));
						}

						this.closeMenuPopup();
					}, this)
				});
			}
		}
	}
	else if (type == 'shareMenu')
	{
		var messageId = bind.getAttribute('data-messageId');
		var selectedDate = bind.getAttribute('data-ts');

		var hideBlockCreate = this.users[this.BXIM.userId].extranet;
		menuItems = [
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_TASK"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'TASK', selectedDate); this.closeMenuPopup(); }, this)},
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_CALEND"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'CALEND', selectedDate); this.closeMenuPopup(); }, this)},
			hideBlockCreate? null: {text: BX.message("IM_MENU_TO_CHAT"), onclick: BX.delegate(function(){ this.shareMessage(messageId, 'CHAT', selectedDate); this.closeMenuPopup(); }, this)},
		];
	}
	else if (type == 'history')
	{
		var messages = [];
		if (bind.target.className == "bx-messenger-history-item")
		{
			messages = [bind.target];
		}
		else if (bind.target.className.indexOf("bx-messenger-content-quote") >= 0)
		{
			messages = BX.findParent(bind.target, {className : "bx-messenger-history-item"});
			messages = [messages];
		}
		else
		{
			messages = BX.findChildrenByClassName(bind.target, "bx-messenger-history-item");
		}
		if (messages.length <= 0)
		{
			messages = BX.findParent(bind.target, {className : "bx-messenger-history-item"});
			messages = [messages];
		}
		if (messages.length <= 0 || !messages[messages.length-1])
			return false;

		var messageName = BX.message('IM_M_SYSTEM_USER');
		var messageId = messages[messages.length-1].getAttribute('data-messageId');
		if (this.message[messageId].senderId && this.users[this.message[messageId].senderId])
			messageName = this.users[this.message[messageId].senderId].name;
		var messageDate = this.message[messageId].date;

		if (BX.desktop)
		{

			var selectedText = BX.desktop.clipboardSelected();

			var copyLink = false;
			var copyLinkHref = '';
			if (bind.target.tagName == 'IMG' && bind.target.parentNode.tagName == 'A' || bind.target.tagName == 'A')
			{
				if (bind.target.tagName == 'A')
					copyLinkHref = bind.target.href;
				else
					copyLinkHref = bind.target.parentNode.href;

				if (copyLinkHref.indexOf('/desktop_app/') < 0 || copyLinkHref.indexOf('/desktop_app/show.file.php') >= 0)
					copyLink = true;
			}

			var showContext = this.BXIM.messenger.historySearch? true: false;

			menuItems = [
				showContext? {text: BX.message("IM_HISTORY_RELATED"), onclick: BX.delegate(function(){
					this.showContext(messageId);
					this.closeMenuPopup();
				}, this)}: null,
				showContext? {separator: true}: null,
				copyLink? {text: BX.message("IM_MENU_COPY3"), onclick: BX.delegate(function()
					{
						BX.desktop.clipboardCopy(BX.delegate(function(){
							return copyLinkHref;
						}, this));
						this.closeMenuPopup();
					}, this)
				}: null,
				copyLink? {separator: true}: null,
				selectedText.text.length <= 0? null: {text: BX.message("IM_MENU_QUOTE"), onclick: BX.delegate(function(){ var text = BX.IM.getSelectionText();  this.insertQuoteText(messageName, messageDate, text); this.closeMenuPopup(); }, this)},
				{text: BX.message("IM_MENU_QUOTE2"), onclick: BX.delegate(function()
					{
						var arQuote = [];
						for (var i = 0; i < messages.length; i++)
						{
							var messageId = messages[i].getAttribute('data-messageId');
							if (this.message[messageId])
							{
								if (this.message[messageId].text)
								{
									arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
								}
								if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
								{
									for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
									{
										var fileId = this.message[messageId].params.FILE_ID[i];
										var chatId = this.message[messageId].chatId;
										if (this.disk.files[chatId][fileId])
										{
											arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
										}
									}
								}
							}
						}
						if (arQuote.length > 0)
						{
							this.insertQuoteText(messageName, messageDate, arQuote.join("\n"));
						}

						this.closeMenuPopup();
					}, this)
				},
				{separator: true},
				selectedText.text.length <= 0? null: {text: BX.message("IM_MENU_COPY"), onclick: BX.delegate(function(){ BX.desktop.clipboardCopy(); this.closeMenuPopup(); }, this)},
				{text: BX.message("IM_MENU_COPY2"), onclick: BX.delegate(function()
					{
						var arQuote = [];
						for (var i = 0; i < messages.length; i++)
						{
							var messageId = messages[i].getAttribute('data-messageId');
							if (this.message[messageId])
							{
								if (this.message[messageId].text)
								{
									arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
								}
								if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
								{
									for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
									{
										var fileId = this.message[messageId].params.FILE_ID[j];
										var chatId = this.message[messageId].chatId;
										if (this.disk.files[chatId][fileId])
										{
											arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
										}
									}
								}
							}
						}
						if (arQuote.length > 0)
						{
							BX.desktop.clipboardCopy(BX.delegate(function (value)
							{
								return this.insertQuoteText(messageName, messageDate, arQuote.join("\n"), false);
							}, this));
						}
						this.closeMenuPopup();
					}, this)
				}
			];
		}
		else
		{
			var showQuote = this.popupMessengerTextarea || opener;
			var showContext = this.BXIM.messenger.historySearch? true: false;
			menuItems = [
				showContext? {text: BX.message("IM_HISTORY_RELATED"), onclick: BX.delegate(function(){
					this.showContext(messageId);
					this.closeMenuPopup();
				}, this)}: null,
				/*showContext? {text: BX.message("IM_HISTORY_JUMP"), onclick: BX.delegate(function(){
					this.jumpToMessage(messageId);
					this.closeMenuPopup();
				}, this)}: null,*/
				showQuote? {separator: true}: null,
				showQuote? {text: BX.message("IM_MENU_QUOTE2"), onclick: BX.delegate(function()
					{
						var arQuote = [];
						for (var i = 0; i < messages.length; i++)
						{
							var messageId = messages[i].getAttribute('data-messageId');
							if (this.message[messageId])
							{
								if (this.message[messageId].text)
								{
									arQuote.push(BX.MessengerCommon.prepareTextBack(this.message[messageId].text));
								}
								if (this.message[messageId].params && this.message[messageId].params.FILE_ID)
								{
									for (var j = 0; j < this.message[messageId].params.FILE_ID.length; j++)
									{
										var fileId = this.message[messageId].params.FILE_ID[i];
										var chatId = this.message[messageId].chatId;
										if (this.disk.files[chatId][fileId])
										{
											arQuote.push('['+BX.message('IM_F_FILE')+': '+this.disk.files[chatId][fileId].name+']');
										}
									}
								}
							}
						}
						if (arQuote.length > 0)
						{
							this.insertQuoteText(messageName, messageDate, arQuote.join("\n"));
						}

						this.closeMenuPopup();
					}, this)
				}: null,
				!showContext && !showQuote? {text: BX.message("IM_P_CLOSE"), onclick: BX.delegate(function(){
					this.closeMenuPopup();
				}, this)}: null
			];
		}
	}
	else if (type == 'historyFileMenu')
	{
		offsetTop = 4;
		offsetLeft = 8;
		this.popupPopupMenuStyle = 'bx-messenger-file-active';

		var fileId = params.fileId;
		var chatId = params.chatId;
		var enableLink = true;
		//if (!BX.MessengerCommon.isDesktop())
		//	enableLink = false;

		if (!this.disk.files[chatId][fileId])
			return false;

		var deleteSelf = this.disk.files[chatId][fileId].authorId != this.BXIM.userId;

		menuItems = [
			enableLink? { text: BX.message("IM_F_DOWNLOAD"), href: this.disk.files[chatId][fileId].urlDownload, 'target': '_blank', onclick: BX.delegate(function(){  this.closeMenuPopup(); }, this)}: null,
			{text: BX.message("IM_F_DOWNLOAD_DISK"), onclick: BX.delegate(function(){
				this.disk.saveToDisk(chatId, fileId, {boxId: 'im-file-history-panel'});
				this.closeMenuPopup();
			}, this)},
			this.chat[chatId] && this.chat[chatId].type == 'open' && deleteSelf? null: {text: BX.message("IM_F_DELETE"), onclick: BX.delegate(function(){
				this.BXIM.openConfirm(deleteSelf? BX.message('IM_F_DELETE_SELF_CONFIRM'): BX.message('IM_F_DELETE_CONFIRM'), [
					new BX.PopupWindowButton({
						text : BX.message('IM_F_DELETE_CONFIRM_YES'),
						className : "popup-window-button-accept",
						events : { click : BX.delegate(function() {
							this.disk.deleteFile(chatId, fileId, {boxId: 'im-file-history-panel'});
							BX.proxy_context.popupWindow.close();
						}, this) }
					}),
					new BX.PopupWindowButton({
						text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
						className : "popup-window-button-decline",
						events : { click : function() { this.popupWindow.close(); } }
					})
				], true);

				this.closeMenuPopup();
			}, this)}
		];
	}
	else if (type == 'notify')
	{
		if (bind.target.className == 'bx-notifier-item-delete')
		{
			bind.target.setAttribute('id', 'bx-notifier-item-delete-'+bind.target.getAttribute('data-notifyId'));
			this.openPopupMenu(bind.target, 'notifyDelete');

			return false;
		}

		var selectedText = BX.desktop.clipboardSelected();

		var copyLink = false;

		if (bind.target.tagName == 'A' && (bind.target.href.indexOf('/desktop_app/') < 0 || copyLinkHref.indexOf('/desktop_app/show.file.php') >= 0))
		{
			copyLink = true;
			var copyLinkHref = bind.target.href;
		}
		else if (bind.target.parentNode.tagName == 'A' && (bind.target.parentNode.href.indexOf('/desktop_app/') < 0 || copyLinkHref.indexOf('/desktop_app/show.file.php') >= 0))
		{
			copyLink = true;
			var copyLinkHref = bind.target.parentNode.href;
		}

		if (!copyLink && selectedText.text.length <= 0)
		{
			var notifyId = bind.target.getAttribute('data-notifyId');
			if (!notifyId)
			{
				notifyId = bind.target.parentNode.parentNode.getAttribute('data-notifyId');
				if (!notifyId)
				{
					notifyId = bind.target.parentNode.getAttribute('data-notifyId');
				}
			}
			if (notifyId)
			{
				bind.target.setAttribute('data-notifyId', notifyId);
				this.openPopupMenu(bind.target, 'notifyDelete', false, {applyToDom: bind});
			}
			return false;
		}

		menuItems = [
			copyLink? {text: BX.message("IM_MENU_COPY3"), onclick: BX.delegate(function()
				{
					BX.desktop.clipboardCopy(BX.delegate(function(){
						return copyLinkHref;
					}, this));
					this.closeMenuPopup();
				}, this)
			}: null,
			copyLink? {separator: true}: null,
			selectedText.text.length <= 0? null: {text: BX.message("IM_MENU_COPY"), onclick: BX.delegate(function(){ BX.desktop.clipboardCopy(); this.closeMenuPopup(); }, this)}
		];

	}
	else if (type == 'copylink')
	{
		if (bind.target.tagName != 'A' || (bind.target.href.indexOf('/desktop_app/') >= 0 && bind.target.href.indexOf('/desktop_app/show.file.php') < 0 ))
			return false;

		menuItems = [
			{text: BX.message("IM_MENU_COPY3"), onclick: BX.delegate(function()
				{
					BX.desktop.clipboardCopy(BX.delegate(function(value){
						return bind.target.href;
					}, this));
					this.closeMenuPopup();
				}, this)
			}
		];
	}
	else if (type == 'copypaste')
	{
		if (params.spell && !this.desktop.enableInVersion(34))
		{
			params.spell = false;
		}

		menuItems = []
		var selectedText = BX.desktop.clipboardSelected(bind.target, params.spell);
		if (!selectedText.text)
		{
			params.spell = false;
		}

		if (params.spell)
		{
			if (params.spellReady)
			{
				for (var i = 0; i < params.suggest.length; i++)
				{
					dataParams = {'suggest': params.suggest[i], selectionStart: selectedText.selectionStart, selectionEnd: selectedText.selectionEnd};
					menuItems.push({text: params.suggest[i], slim: true, bold: true, dataParams: dataParams, onclick: BX.delegate(function(){
						var dataParams = JSON.parse(BX.proxy_context.getAttribute('data-params'));

						setTimeout(function(){
							BX.desktop.clipboardReplaceText(bind.target, dataParams.selectionStart, dataParams.selectionEnd, dataParams.suggest);
						}, 50);

						this.closeMenuPopup();
					}, this)});

					if (i == 5) break;
				}
				if (menuItems.length <= 0)
				{
					menuItems.push({text: BX.message("IM_MENU_SUGGEST_EMPTY"), bold: true, slim: true });
				}
				menuItems.push({separator: true});
			}
			else
			{
				BXDesktopSystem.SpellCheckWord(selectedText.text, BX.delegate(function(isCorrect, suggest){
					this.openPopupMenu(bind, 'copypaste', false, {'spell': !isCorrect, 'spellReady': true, 'suggest': suggest});
				}, this));
			}
		}

		if (!params.spell || params.spellReady)
		{
			if (selectedText.text.length)
			{
				menuItems.push({text: BX.message("IM_MENU_CUT"), onclick: BX.delegate(function(){ BX.desktop.clipboardCut(); this.closeMenuPopup(); }, this)}),
				menuItems.push({text: BX.message("IM_MENU_COPY"), onclick: BX.delegate(function(){ BX.desktop.clipboardCopy(); this.closeMenuPopup(); }, this)}),
				menuItems.push({text: BX.message("IM_MENU_DELETE"), onclick: BX.delegate(function(){ BX.desktop.clipboardDelete(); this.closeMenuPopup(); }, this)})
			}
			else
			{
				menuItems.push({text: BX.message("IM_MENU_PASTE"), onclick: BX.delegate(function(){ BX.desktop.clipboardPaste(); this.closeMenuPopup(); }, this)});
			}
			bindOptions = {position: "top"};
		}
	}
	else
	{
		menuItems = [];
	}

	if (menuItems.length <= 0)
	{
		return false;
	}

	var nullMenuItems = true;
	for (var i = 0; i < menuItems.length; i++)
	{
		if (menuItems[i])
		{
			nullMenuItems = false;
		}
	}
	if (nullMenuItems)
	{
		menuItems = [{text: BX.message("IM_NOTIFY_CONFIRM_CLOSE"), onclick: BX.delegate(function(){  this.closeMenuPopup(); }, this)}];
	}
	else
	{
		var firstElementSeparator = false;
		for (var i = 0; i < menuItems.length; i++)
		{
			if (menuItems[i])
			{
				if(menuItems[i].separator)
				{
					menuItems[i] = null;
				}
				else
				{
					break;
				}
			}
		}
	}

	menuItems = this.modifierPopupMenu(type, menuItems);

	this.popupPopupMenuDateCreate = +new Date();
	this.popupPopupMenu = new BX.PopupWindow('bx-messenger-popup-'+type, bind, {
		//parentPopup: this.popupMessenger,
		lightShadow : true,
		offsetTop: offsetTop,
		offsetLeft: offsetLeft,
		autoHide: true,
		closeByEsc: true,
		zIndex: params.zIndex ? params.zIndex : 3001,
		bindOptions: bindOptions,
		events : {
			onPopupClose : BX.delegate(function() {
				if (this.popupPopupMenuStyle && this.popupPopupMenu)
				{
					if (this.popupPopupMenuStyle == 'bx-messenger-file-active')
						BX.removeClass(this.popupPopupMenu.bindElement.parentNode, this.popupPopupMenuStyle);
					else if (this.popupPopupMenuStyle == 'bx-messenger-content-item-menu-hover')
						BX.removeClass(this.popupPopupMenu.bindElement.parentNode, this.popupPopupMenuStyle);
					else
						BX.removeClass(this.popupPopupMenu.bindElement, this.popupPopupMenuStyle);
				}
				if (this.popupPopupMenuDateCreate+500 < (+new Date()))
					BX.proxy_context.destroy()
			}, this),
			onPopupDestroy : BX.delegate(function() {
				if (this.popupPopupMenuStyle && this.popupPopupMenu)
				{
					if (this.popupPopupMenuStyle == 'bx-messenger-file-active')
						BX.removeClass(this.popupPopupMenu.bindElement.parentNode, this.popupPopupMenuStyle);
					else if (this.popupPopupMenuStyle == 'bx-messenger-content-item-menu-hover')
						BX.removeClass(this.popupPopupMenu.bindElement.parentNode, this.popupPopupMenuStyle);
					else
						BX.removeClass(this.popupPopupMenu.bindElement, this.popupPopupMenuStyle);
				}
				this.popupPopupMenu = null;
			}, this)
		},
		content : BX.create("div", { props : { className : "bx-messenger-popup-menu" }, children: [ //TODO SCROLL
			BX.create("div", { props : { className : "bx-messenger-popup-menu-items" }, children: BX.MessengerChat.MenuPrepareList(menuItems)})
		]})
	});
	if (setAngle !== false)
		this.popupPopupMenu.setAngle(angleOptions);

	this.popupPopupMenu.show();

	if (this.popupPopupMenuStyle)
	{
		if (this.popupPopupMenuStyle == 'bx-messenger-file-active')
			BX.addClass(bind.parentNode, this.popupPopupMenuStyle);
		else if (this.popupPopupMenuStyle == 'bx-messenger-content-item-menu-hover')
			BX.addClass(bind.parentNode, this.popupPopupMenuStyle);
		else
			BX.addClass(bind, this.popupPopupMenuStyle);
	}

	BX.bind(this.popupPopupMenu.popupContainer, "click", BX.MessengerCommon.preventDefault);

	if (type == 'dialogContext' || type == 'notify' || type == 'history' || type == 'copypaste')
	{
		BX.bind(this.popupPopupMenu.popupContainer, "mousedown", function(event){
			event.target.click();
		});
	}

	return false;
};

BX.MessengerChat.prototype.modifierPopupMenu = function(type, menu)
{
	var result = null;
	for (var i = 0; i < this.popupPopupMenuModifyFunction.length; i++)
	{
		result = this.popupPopupMenuModifyFunction[i](type, menu);
		if (result)
		{
			menu = result;
		}
	}

	return menu;
}

BX.MessengerChat.prototype.closePopupFileMenu = function()
{
	if (this.popupMessengerFileButton == null)
		return false;

	if (this.popupPopupMenuDateCreate+100 > (+new Date()))
		return false;

	if (BX.hasClass(this.popupMessengerFileButton, 'bx-messenger-textarea-file-active'))
	{
		BX.removeClass(this.popupMessengerFileButton, 'bx-messenger-textarea-file-active');
		this.setClosingByEsc(true);
	}
}

BX.MessengerChat.prototype.closePopupFileMenuKeydown = function(e)
{
	if (e.keyCode == 27)
	{
		setTimeout(BX.delegate(function(){
			this.closePopupFileMenu();
		}, this), 100);
	}
}

BX.MessengerChat.prototype.openPopupExternalData = function(bind, type, setAngle, params)
{
	if (this.popupSmileMenu != null)
		this.popupSmileMenu.destroy();

	if (this.popupPopupMenu != null)
	{
		this.popupPopupMenu.destroy();
		return false;
	}

	this.popupPopupMenuDateCreate = +new Date();
	var offsetTop = 0;
	var offsetLeft = 10;
	var bindOptions = {position: "top"};
	var sizesOptions = { width: '272px', height: '100px'};
	var ajaxData = { 'IM_GET_EXTERNAL_DATA' : 'Y', 'TYPE': type, 'TS': this.popupPopupMenuDateCreate, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()};
	var content = BX.create("div", { attrs: {'id': 'bx-messenger-external-data'}, props : { className : "bx-messenger-external-data" },  style: sizesOptions, children: [
		BX.create("div", { props : { className : "bx-messenger-external-data-load" }, html: BX.message('IM_CL_LOAD')})
	]})
	if (type == 'user')
	{
		sizesOptions = { width: '272px', height: '100px'};
		ajaxData['USER_ID'] = parseInt(params['ID']);
		if (this.users[ajaxData['USER_ID']] && !this.users[ajaxData['USER_ID']].fake)
		{
			ajaxData = false;
		}
	}
	else if (type == 'chat')
	{
		sizesOptions = { width: '272px', height: '100px'};
		ajaxData['CHAT_ID'] = parseInt(params['ID']);
		if (this.chat[ajaxData['CHAT_ID']] && !this.chat[ajaxData['CHAT_ID']].fake)
		{
			ajaxData = false;
		}
	}
	else if (type == 'phoneCallHistory')
	{
		sizesOptions = { width: '239px', height: '122px'};
		ajaxData['HISTORY_ID'] = parseInt(params['ID']);
	}
	else if (type == 'readedList')
	{
		ajaxData = false;
		var newReadedList = [];
		var firstUserId = 0;
		var firstUserDate = 0;
		for (var userId in this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab])
		{
			if (userId == this.BXIM.userId)
				continue;

			if (!firstUserDate || firstUserDate > this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][userId].date)
			{
				firstUserId = userId;
				firstUserDate = this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][userId].date;
			}

			newReadedList.push({'userId': userId, 'date': this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][userId].date});
		}

		var htmlElement = '<span class="bx-notifier-item-help-popup">';
		for (var i = 0; i < newReadedList.length; i++)
		{
			if (newReadedList[i].userId == firstUserId)
				continue;

			var avatarColor = BX.MessengerCommon.isBlankAvatar(this.BXIM.messenger.users[newReadedList[i].userId].avatar)? 'style="background-color: '+this.BXIM.messenger.users[newReadedList[i].userId].color+'"': '';
			htmlElement += '<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+newReadedList[i].userId+'" title="'+BX.MessengerCommon.formatDate(newReadedList[i].date)+'">' +
				'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(this.users[newReadedList[i].userId])+'">' +
					'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.BXIM.messenger.users[newReadedList[i].userId].avatar)? " bx-notifier-popup-avatar-img-default": "")+'" src="'+this.BXIM.messenger.users[newReadedList[i].userId].avatar+'" '+avatarColor+'>' +
				'</span>' +
				'<span class="bx-notifier-item-help-popup-name  '+(this.BXIM.messenger.users[newReadedList[i].userId].extranet? ' bx-notifier-popup-avatar-extranet':'')+'">'+this.BXIM.messenger.users[newReadedList[i].userId].name+'</span>' +
			'</span>';
		}
		htmlElement += '</span>';

		content = BX.create("div", { props : { className : "bx-messenger-popup-menu" }, html: htmlElement});
	}
	else
	{
		return false;
	}

	this.popupPopupMenu = new BX.PopupWindow('bx-messenger-popup-external-data', bind, {
		//parentPopup: this.popupMessenger,
		lightShadow : true,
		offsetTop: offsetTop,
		offsetLeft: offsetLeft,
		autoHide: true,
		closeByEsc: true,
		zIndex: 200,
		bindOptions: bindOptions,
		events : {
			onPopupClose : function() { this.destroy() },
			onPopupDestroy : BX.delegate(function() { this.popupPopupMenu = null; }, this)
		},
		content : content
	});
	if (setAngle !== false)
		this.popupPopupMenu.setAngle({offset: 4});
	this.popupPopupMenu.show();

	if (ajaxData)
	{
		BX.ajax({
			url: this.BXIM.pathToAjax+'?GET_EXTERNAL_DATA&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: ajaxData,
			onsuccess: BX.delegate(function(data){

				if (data.ERROR)
				{
					data.TYPE = 'noAccess';
				}
				else if (data.TYPE == 'chat')
				{
					for (var i in data.CHAT)
					{
						data.CHAT[i].date_create = new Date(data.CHAT[i].date_create);
						this.chat[i] = data.CHAT[i];
					}
					for (var i in data.USER_IN_CHAT)
					{
						this.userInChat[i] = data.USER_IN_CHAT[i];
					}
					for (var i in data.USER_BLOCK_CHAT)
					{
						this.userChatBlockStatus[i] = data.USER_BLOCK_CHAT[i];
					}
				}
				else if (data.TYPE == 'user')
				{
					for (var i in data.USERS)
					{
						data.USERS[i].last_activity_date = new Date(data.USERS[i].last_activity_date);
						data.USERS[i].mobile_last_date = new Date(data.USERS[i].mobile_last_date);
						data.USERS[i].idle = data.USERS[i].idle? new Date(data.USERS[i].idle): false;
						data.USERS[i].absent = data.USERS[i].absent? new Date(data.USERS[i].absent): false;

						this.users[i] = data.USERS[i];
					}
					for (var i in data.PHONES)
					{
						this.phones[i] = {};
						for (var j in data.PHONES[i])
						{
							this.phones[i][j] = BX.util.htmlspecialcharsback(data.PHONES[i][j]);
						}
					}
					for (var i in data.USER_IN_GROUP)
					{
						if (typeof(this.userInGroup[i]) == 'undefined')
						{
							this.userInGroup[i] = data.USER_IN_GROUP[i];
						}
						else
						{
							for (var j = 0; j < data.USER_IN_GROUP[i].users.length; j++)
								this.userInGroup[i].users.push(data.USER_IN_GROUP[i].users[j]);

							this.userInGroup[i].users = BX.util.array_unique(this.userInGroup[i].users)
						}
					}
				}

				data.TS = parseInt(data.TS);
				if (data.TS > 0 && data.TS != this.popupPopupMenuDateCreate || !this.popupPopupMenu)
					return false;

				this.drawExternalData(data.TYPE, data);
			}, this),
			onfailure: BX.delegate(function(){
				if (this.popupPopupMenu)
					this.popupPopupMenu.destroy();
			}, this)
		});
	}
	else
	{
		if (type == 'user')
			this.drawExternalData('user', {'USER_ID': params['ID']});
		else if (type == 'chat')
			this.drawExternalData('chat', {'CHAT_ID': params['ID']});

	}

	if (this.popupPopupMenu)
		BX.bind(this.popupPopupMenu.popupContainer, "click", BX.PreventDefault);

	return false;
};

BX.MessengerChat.prototype.drawExternalData = function(type, params)
{
	if (!BX('bx-messenger-external-data'))
		return false;

	if (type == 'noAccess')
	{
		BX('bx-messenger-external-data').innerHTML = BX.message('IM_M_USER_NO_ACCESS');
	}
	else if (type == 'user')
	{
		if (!this.users[params['USER_ID']])
		{
			if (this.popupPopupMenu)
				this.popupPopupMenu.destroy();

			return false;
		}

		var hideButtons = false;

		BX('bx-messenger-external-data').innerHTML = '';
		BX.adjust(BX('bx-messenger-external-data'), {children: [
			BX.create('div', { props : { className : "bx-messenger-external-avatar" }, children: [
				BX.create('div', { props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[params['USER_ID']]) }, children: [
					BX.create('img', { attrs : { src : this.users[params['USER_ID']].avatar, style: (BX.MessengerCommon.isBlankAvatar(this.users[params['USER_ID']].avatar)? 'background-color: '+this.users[params['USER_ID']].color: '')}, props : { className : "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.users[params['USER_ID']].avatar)? " bx-messenger-panel-avatar-img-default": "") }}),
					BX.create('span', { attrs : { title : (BX.MessengerCommon.getUserStatus(this.users[params['USER_ID']], false)).statusText},  props : { className : "bx-messenger-panel-avatar-status" }})
				]}),
				BX.create("span", { props : { className : "bx-messenger-panel-title"}, html: (
					this.users[params['USER_ID']].extranet? '<div class="bx-messenger-user-extranet">'+this.users[params['USER_ID']].name+'</div>':
					(this.users[params['USER_ID']].bot? '<div class="'+(this.bot[params['USER_ID']].type == 'network'? 'bx-messenger-user-network': 'bx-messenger-user-bot')+'">'+this.users[params['USER_ID']].name+'</div>': this.users[params['USER_ID']].name)
				)}),
				BX.create("span", { props : { className : "bx-messenger-panel-desc"}, html: BX.MessengerCommon.getUserPosition(this.users[params['USER_ID']])})
			]}),
			hideButtons? []: BX.create('div', {props : { className : "bx-messenger-external-data-buttons"}, children: [
				BX.create('span', {
					props : { className : "bx-notifier-item-button bx-notifier-item-button-white" },
					html: BX.message('IM_M_WRITE_MESSAGE'),
					events: {click: BX.delegate(function(e){
						this.popupPopupMenu.destroy();
						this.openMessenger(params['USER_ID']);
					}, this)}
				}),
				BX.create('span', {
					props : { className : "bx-notifier-item-button bx-notifier-item-button-white" },
					html: BX.message('IM_M_CALL_BTN_HISTORY'),
					events: {click: BX.delegate(function(){
						this.popupPopupMenu.destroy();
						this.openHistory(params['USER_ID']);
					}, this)}
				})
			]})
		]});
	}
	else if (type == 'chat')
	{
		if (!this.chat[params['CHAT_ID']])
		{
			if (this.popupPopupMenu)
				this.popupPopupMenu.destroy();

			return false;
		}

		var chatTypeTitle = BX.message('IM_CL_CHAT_2');
		if (this.chat[params['CHAT_ID']].type == 'call')
		{
			chatTypeTitle = BX.message('IM_CL_PHONE');
		}
		else if (this.chat[params['CHAT_ID']].type == 'lines')
		{
			chatTypeTitle = BX.message('IM_CL_LINES');
		}
		else if (this.chat[params['CHAT_ID']].type == 'livechat')
		{
			chatTypeTitle = BX.message('IM_CL_LINES');
		}
		else if (this.chat[params['CHAT_ID']].type == 'open')
		{
			chatTypeTitle = BX.message('IM_CL_OPEN_CHAT');
		}
		BX('bx-messenger-external-data').innerHTML = '';
		BX.adjust(BX('bx-messenger-external-data'), {children: [
			BX.create('div', { props : { className : "bx-messenger-external-avatar" }, children: [
				BX.create('div', { props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-"+this.chat[params['CHAT_ID']].type }, children: [
					BX.create('img', { attrs : { src : this.chat[params['CHAT_ID']].avatar, style: (BX.MessengerCommon.isBlankAvatar(this.chat[params['CHAT_ID']].avatar)? 'background-color: '+this.chat[params['CHAT_ID']].color: '')}, props : { className : "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.chat[params['CHAT_ID']].avatar)? " bx-messenger-panel-avatar-img-default": "") }}),
				]}),
				BX.create("span", { props : { className : "bx-messenger-panel-title"}, html: (
					this.chat[params['CHAT_ID']].extranet? '<div class="bx-messenger-user-extranet">'+this.chat[params['CHAT_ID']].name+'</div>': this.chat[params['CHAT_ID']].name
				)}),
				BX.create("span", { props : { className : "bx-messenger-panel-desc"}, html: chatTypeTitle})
			]}),
			BX.create('div', {props : { className : "bx-messenger-external-data-buttons"}, children: [
				BX.create('span', {
					props : { className : "bx-notifier-item-button bx-notifier-item-button-white" },
					html: BX.message('IM_M_OPEN_CHAT'),
					events: {click: BX.delegate(function(e){
						this.popupPopupMenu.destroy();
						this.openMessenger('chat'+params['CHAT_ID']);
					}, this)}
				}),
				BX.create('span', {
					props : { className : "bx-notifier-item-button bx-notifier-item-button-white" },
					html: BX.message('IM_M_CALL_BTN_HISTORY'),
					events: {click: BX.delegate(function(){
						this.popupPopupMenu.destroy();
						this.openHistory('chat'+params['CHAT_ID']);
					}, this)}
				})
			]})
		]});
	}
	else if (type == 'phoneCallHistory')
	{
		var recordHtml = false;
		if (params['CALL_RECORD_HTML'])
		{
			var recordHtml = {
				HTML: BX.message('CALL_RECORD_ERROR'),
				SCRIPT: []
			}
			if (!BX.MessengerCommon.isDesktop())
				recordHtml = BX.processHTML(params['CALL_RECORD_HTML'], false);
		}

		BX('bx-messenger-external-data').innerHTML = '';
		BX.adjust(BX('bx-messenger-external-data'), {children: [
			BX.create('div', { props : { className : "bx-messenger-record" }, children: [
				BX.create('div', { props : { className : "bx-messenger-record-phone-box" }, children: [
					BX.create('span', { props : { className : "bx-messenger-record-icon bx-messenger-record-icon-"+params['CALL_ICON'] }, attrs: {title: params['INCOMING_TEXT']}}),
					BX.create('span', { props : { className : "bx-messenger-record-phone" }, html: (params['PHONE_NUMBER_FORMATTED'] ? params['PHONE_NUMBER_FORMATTED'] : (params['PHONE_NUMBER'] && params['PHONE_NUMBER'].toString().length >=10? '+': '')+params['PHONE_NUMBER'])})
				]}),
				BX.create("div", { props : { className : "bx-messenger-record-reason"}, html: params['CALL_FAILED_REASON']}),
				BX.create('div', { props : { className : "bx-messenger-record-stats" }, children: [
					BX.create('span', { props : { className : "bx-messenger-record-time" }, html: params['CALL_DURATION_TEXT']}),
					BX.create('span', { props : { className : "bx-messenger-record-cost" }, html: params['COST_TEXT']})
				]}),
				recordHtml? BX.create('div', { props : { className : "bx-messenger-record-box" }, children: [
					BX.create('span', { props : { className : "bx-messenger-record-player" }, html: recordHtml.HTML})
				]}): null
			]})
		]});

		if (recordHtml)
		{
			for (var i = 0; i < recordHtml.SCRIPT.length; i++)
			{
				BX.evalGlobal(recordHtml.SCRIPT[i].JS);
			}
		}
	}
}

/* HISTORY */
BX.MessengerChat.prototype.openHistory = function(userId)
{
	if (this.popupMessengerConnectionStatusState != 'online')
		return false;

	if (this.historyWindowBlock)
		return false;

	this.historyLastSearch[userId] = '';

	if (!this.historyEndOfList[userId])
		this.historyEndOfList[userId] = {};

	if (!this.historyLoadFlag[userId])
		this.historyLoadFlag[userId] = {};

	if (this.popupHistory != null)
		this.popupHistory.destroy();

	var chatId = 0;
	var sessionId = 0;
	var enableDisk = this.BXIM.disk.enable;
	var isChat = false;
	if (userId.toString().substr(0,4) == 'chat')
	{
		isChat = true;
		chatId = parseInt(userId.toString().substr(4));
		if (chatId <= 0)
			return false;
	}
	else
	{
		userId = parseInt(userId);
		if (userId <= 0)
			return false;

		chatId = this.userChat[userId]? this.userChat[userId]: 0;
	}

	this.historyFilesEndOfList[chatId] = false;
	this.historyFilesLoadFlag[chatId] = false;

	this.historyUserId = userId;
	this.historyChatId = chatId;

	if (!BX.MessengerCommon.isPage())
		this.setClosingByEsc(false);

	this.popupHistoryPanel = null;
	var historyPanel = this.redrawHistoryPanel(userId, chatId);

	this.popupHistoryElements = BX.create("div", { props : { className : "bx-messenger-history"+(enableDisk? ' bx-messenger-history-with-disk': '')+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: [
		this.popupHistoryPanel = BX.create("div", { props : { className : "bx-messenger-panel-wrap" }, children: historyPanel}),
		BX.create("div", { props : { className : "bx-messenger-history-types" }, children : [
			BX.create("span", { props : { className : "bx-messenger-history-type bx-messenger-history-type-message" }, children : [
				this.popupHistoryButtonFilterBox = BX.create("div", { props : { className : "bx-messenger-panel-filter-box" }, style : {display: 'block'}, children : [
					this.popupHistorySearchDateWrap = BX.create('div', {props : { className : "bx-messenger-filter-date bx-messenger-input-wrap" }, html: '<span class="bx-messenger-input-date"></span><a class="bx-messenger-input-close" href="#close"></a><input type="text" class="bx-messenger-input" value="" tabindex="1003" placeholder="'+BX.message('IM_PANEL_FILTER_DATE')+'" />'}),
					this.popupHistorySearchWrap = BX.create('div', {props : { className : "bx-messenger-filter-text bx-messenger-history-filter-text bx-messenger-input-wrap" }, html: '<a class="bx-messenger-input-close" href="#close"></a><input type="text" class="bx-messenger-input" tabindex="1000" placeholder="'+BX.message('IM_PANEL_FILTER_TEXT')+'" value="" />'})
				]}),
				this.popupHistoryItems = BX.create("div", { props : { className : "bx-messenger-history-items" }, style : {height: this.popupHistoryItemsSize+'px'}, children : [
					this.popupHistoryBodyWrap = BX.create("div", { props : { className : "bx-messenger-history-items-wrap" }})
				]})
			]}),
			BX.create("span", { props : { className : "bx-messenger-history-type bx-messenger-history-type-disk" }, children : [
				this.popupHistoryFilesButtonFilterBox = BX.create("div", { props : { className : "bx-messenger-panel-filter-box" }, style : {display: 'block'}, children : [
					this.popupHistoryFilesSearchWrap = BX.create('div', {props : { className : "bx-messenger-filter-text bx-messenger-input-wrap" }, html: '<a class="bx-messenger-input-close" href="#close"></a><input type="text"  tabindex="1002" class="bx-messenger-input" placeholder="'+BX.message('IM_F_FILE_SEARCH')+'" value="" />'})
				]}),
				this.popupHistoryFilesItems = BX.create("div", { props : { className : "bx-messenger-history-items" }, style : {height: this.popupHistoryItemsSize+'px'}, children : [
					this.popupHistoryFilesBodyWrap = BX.create("div", { props : { className : "bx-messenger-history-items-wrap" }})
				]})
			]})
		]})
	]});

	if (this.BXIM.init && BX.MessengerCommon.isDesktop())
	{
		this.desktop.openHistory(userId, this.popupHistoryElements, "BXIM.openHistory('"+userId+"');");
		return false;
	}
	else if (BX.MessengerCommon.isDesktop())
	{
		this.popupHistory = new BX.PopupWindowDesktop();
		this.desktop.drawOnPlaceholder(this.popupHistoryElements);

		BX.bind(window, "keydown", BX.proxy(function(e) {
			if (e.keyCode == 27)
			{
				if (this.popupHistorySearchInput.value == '')
				{
					this.popupHistory.destroy();
				}
				else
				{
					this.popupHistorySearchInput.value = '';
					this.popupHistorySearchInput.focus();
				}
			}
		}, this));
	}
	else
	{
		this.popupHistory = new BX.PopupWindow('bx-messenger-popup-history', null, {
			//parentPopup: this.popupMessenger,
			//offsetTop: 0,
			autoHide: false,
			zIndex: 100,
			draggable: {restrict: true},
			closeByEsc: true,
			bindOptions: {position: "top"},
			events : {
				onPopupClose : function() { this.destroy(); },
				onPopupDestroy : BX.delegate(function() {
					this.popupHistory = null; this.historySearch = ''; this.setClosingByEsc(true);
					this.closeMenuPopup();
					var calend = BX.calendar.get()
					if (calend)
					{
						calend.Close();
					}
				}, this)
			},
			titleBar: {content: BX.create('span', {props : { className : "bx-messenger-title" }, html: BX.message('IM_M_HISTORY')})},
			closeIcon : {'right': '13px'},
			content : this.popupHistoryElements,
			contentColor : "white",
			noAllPaddings : true
		});
		this.popupHistory.show();
		BX.bind(this.popupHistory.popupContainer, "click", BX.MessengerCommon.preventDefault);
	}
	this.drawHistory(this.historyUserId);
	if (enableDisk)
	{
		this.drawHistoryFiles(this.historyChatId);
	}

	if (BX.MessengerCommon.isDesktop())
	{
		BX.bind(this.popupHistorySearchInput, "contextmenu", BX.delegate(function(e) {
			this.openPopupMenu(e, 'copypaste', false);
			return BX.PreventDefault(e);
		}, this));

		BX.bindDelegate(this.popupHistoryElements, "contextmenu", {className: 'bx-messenger-history-item'}, BX.delegate(function(e) {
			this.openPopupMenu(e, 'history', false);
			return BX.PreventDefault(e);
		}, this));
	}

	BX.bindDelegate(this.popupHistoryElements, 'click', {className: 'bx-messenger-ajax'}, BX.delegate(function() {
		if (BX.proxy_context.getAttribute('data-entity') == 'user')
		{
			this.openPopupExternalData(BX.proxy_context, 'user', true, {'ID': BX.proxy_context.getAttribute('data-userId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'chat')
		{
			this.openPopupExternalData(BX.proxy_context, 'chat', true, {'ID': BX.proxy_context.getAttribute('data-chatId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'openlines')
		{
			this.linesOpenHistory(BX.proxy_context.getAttribute('data-sessionId'));
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'network')
		{
			this.openMessenger('network'+BX.proxy_context.getAttribute('data-networkId'))
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'date')
		{
			this.openPopupMenu(BX.proxy_context, 'shareMenu');
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'phoneCallHistory')
		{
			this.openPopupExternalData(BX.proxy_context, 'phoneCallHistory', true, {'ID': BX.proxy_context.getAttribute('data-historyID')})
		}
	}, this));

	BX.bindDelegate(this.popupHistoryElements, "click", {className: 'bx-messenger-history-item-menu'}, BX.delegate(function(e) {
		this.openPopupMenu(e, 'history', false);
		return BX.PreventDefault(e);
	}, this));

	BX.bindDelegate(this.popupHistoryPanel, "click", {className: 'bx-messenger-panel-basket'},   BX.delegate(function(){
		this.BXIM.openConfirm(BX.message('IM_M_HISTORY_DELETE_ALL_CONFIRM'), [
			new BX.PopupWindowButton({
				text : BX.message('IM_M_HISTORY_DELETE_ALL'),
				className : "popup-window-button-accept",
				events : { click : BX.delegate(function() { this.deleteAllHistory(userId); BX.proxy_context.popupWindow.close(); }, this) }
			}),
			new BX.PopupWindowButton({
				text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
				className : "popup-window-button-decline",
				events : { click : function() { this.popupWindow.close(); } }
			})
		], true);
	}, this));

	this.popupHistorySearchInput = BX.findChildByClassName(this.popupHistorySearchWrap, "bx-messenger-input");
	this.popupHistorySearchInputClose = BX.findChildByClassName(this.popupHistorySearchInput.parentNode, "bx-messenger-input-close");

	this.popupHistorySearchDateInput = BX.findChildByClassName(this.popupHistorySearchDateWrap, "bx-messenger-input");
	this.popupHistorySearchDateInputClose = BX.findChildByClassName(this.popupHistorySearchDateInput.parentNode, "bx-messenger-input-close");

	BX.bind(this.popupHistorySearchDateInput, "focus",  BX.delegate(function(e){
		BX.calendar({node: BX.proxy_context, field: BX.proxy_context, bTime: false, callback_after: BX.delegate(this.newHistoryDateSearch, this)});
		return BX.PreventDefault(e);
	}, this));
	BX.bind(this.popupHistorySearchDateInput, "click",  BX.delegate(function(e){
		BX.calendar({node: BX.proxy_context, field: BX.proxy_context, bTime: false, callback_after: BX.delegate(this.newHistoryDateSearch, this)});
		return BX.PreventDefault(e);
	}, this));

	BX.bind(this.popupHistorySearchDateInputClose, "click",  BX.delegate(function(e){
		this.popupHistorySearchDateInput.value = '';
		this.historyDateSearch = "";
		this.historyLastSearch[this.historyUserId] = "";
		this.drawHistory(this.historyUserId, false, false);
	}, this));

	if (this.popupHistoryFilterVisible && !BX.browser.IsAndroid() && !BX.browser.IsIOS())
		BX.focus(this.popupHistorySearchInput);

	BX.bind(this.popupHistorySearchInputClose, "click",  BX.delegate(function(e){
		this.popupHistorySearchInput.value = '';
		this.historySearch = "";
		this.historyLastSearch[this.historyUserId] = "";
		this.drawHistory(this.historyUserId, false, false);
		return BX.PreventDefault(e);
	}, this));

	BX.bind(this.popupHistorySearchInput, "keyup", BX.delegate(this.newHistorySearch, this));

	BX.bind(this.popupHistoryItems, "scroll", BX.delegate(function(){ BX.MessengerCommon.loadHistory(userId) }, this));

	if (this.disk.enable)
	{
		BX.bindDelegate(this.popupHistoryFilesBodyWrap, "click", {className: 'bx-messenger-file-menu'}, BX.delegate(function(e) {
			var fileId = BX.proxy_context.parentNode.parentNode.getAttribute('data-fileId');
			var chatId = BX.proxy_context.parentNode.parentNode.getAttribute('data-chatId');
			this.openPopupMenu(BX.proxy_context, 'historyFileMenu', true, {fileId: fileId, chatId: chatId});
			return BX.PreventDefault(e);
		}, this));

		this.popupHistoryFilesSearchInput = BX.findChildByClassName(this.popupHistoryFilesSearchWrap, "bx-messenger-input");
		this.popupHistoryFilesSearchInputClose = BX.findChildByClassName(this.popupHistoryFilesSearchInput.parentNode, "bx-messenger-input-close");

		BX.bind(this.popupHistoryFilesSearchInputClose, "click",  BX.delegate(function(e){
			this.popupHistoryFilesSearchInput.value = '';
			this.historyFilesSearch = "";
			this.historyFilesLastSearch[this.historyChatId] = "";
			this.drawHistoryFiles(this.historyChatId, false, false);
			return BX.PreventDefault(e);
		}, this));

		BX.bind(this.popupHistoryFilesSearchInput, "keyup", BX.delegate(this.newHistoryFilesSearch, this));

		BX.bind(this.popupHistoryFilesItems, "scroll", BX.delegate(function(){ this.loadHistoryFiles(this.historyChatId) }, this));
	}
};

BX.MessengerChat.prototype.loadHistoryFiles = function(chatId, afterDelete)
{
	if (this.historyFilesLoadFlag[chatId])
		return;

	if (this.historyFilesSearch != "")
		return;

	if (afterDelete && this.popupHistoryFilesItems.offsetHeight > this.popupHistoryFilesBodyWrap.offsetHeight - 100)
	{
	}
	else if (!(this.popupHistoryFilesItems.scrollTop > this.popupHistoryFilesItems.scrollHeight-this.popupHistoryFilesItems.offsetHeight-100))
	{
		return;
	}

	if (!this.historyFilesEndOfList[chatId])
	{
		this.historyFilesLoadFlag[chatId] = true;

		if (this.popupHistoryFilesBodyWrap.childNodes.length > 0)
			this.historyFilesOpenPage[chatId] = Math.floor(this.popupHistoryFilesBodyWrap.childNodes.length/15)+1;
		else
			this.historyFilesOpenPage[chatId] = 1;

		var tmpLoadMoreWait = null;
		this.popupHistoryFilesBodyWrap.appendChild(tmpLoadMoreWait = BX.create("div", { props : { className : "bx-messenger-content-load-more-history" }, children : [
			BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
			BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_LOAD_FILES')})
		]}));

		BX.ajax({
			url: this.BXIM.pathToAjax+'?HISTORY_FILES_LOAD_MORE&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: {'IM_HISTORY_FILES_LOAD' : 'Y', 'CHAT_ID' : chatId, 'PAGE_ID' : this.historyFilesOpenPage[chatId], 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(data){
				if (tmpLoadMoreWait)
					BX.remove(tmpLoadMoreWait);
				this.historyFilesLoadFlag[data.CHAT_ID] = false;
				if (data.FILES.length == 0)
				{
					this.historyFilesEndOfList[data.CHAT_ID] = true;
					return;
				}

				var countFiles = 0;
				for (var i in data.FILES)
				{
					if (!this.disk.files[data.CHAT_ID])
						this.disk.files[data.CHAT_ID] = {};

					if (!this.disk.files[data.CHAT_ID][i])
					{
						data.FILES[i].date = new Date(data.FILES[i].date);
						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
					}
					countFiles++;
				}
				if (countFiles < 15)
				{
					this.historyFilesEndOfList[data.CHAT_ID] = true;
				}

				for (var i in data.FILES)
				{
					var file = this.disk.files[data.CHAT_ID][i];
					if (file && !BX('im-file-history-panel-'+file.id))
					{
						var fileNode = this.disk.drawHistoryFiles(data.CHAT_ID, file.id, {getElement: 'Y'});
						if (fileNode)
							this.popupHistoryFilesBodyWrap.appendChild(fileNode);
					}
				}
			}, this),
			onfailure: function(){
				if (tmpLoadMoreWait)
					BX.remove(tmpLoadMoreWait);
			}
		});
	}
};

BX.MessengerChat.prototype.showContext = function(messageId)
{
	BX.ajax({
		url: this.BXIM.pathToAjax+'?LOAD_CONTEXT_MESSAGE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		skipAuthCheck: true,
		timeout: 30,
		data: {'IM_LOAD_CONTEXT_MESSAGE' : 'Y', 'MESSAGE_ID' : messageId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data)
		{
			if (data && data.BITRIX_SESSID)
			{
				BX.message({'bitrix_sessid': data.BITRIX_SESSID});
			}
			if (data.ERROR == '')
			{
				var dialogId = data.DIALOG_ID;

				this.showMessage[dialogId] = [];
				this.sendAjaxTry = 0;
				for (var i in data.MESSAGE)
				{
					data.MESSAGE[i].date = new Date(data.MESSAGE[i].date);
					this.message[i] = data.MESSAGE[i];
				//	if (this.BXIM.settings.loadLastMessage)
				//		this.showMessage[dialogId].push(i);
				}
				//for (var i in data.USERS_MESSAGE)
				//{
				//	if (this.history[i])
				//		this.history[i] = BX.util.array_merge(this.history[i], data.USERS_MESSAGE[i]);
				//	else
				//		this.history[i] = data.USERS_MESSAGE[i];
				//}
				for (var i in data.FILES)
				{
					if (!this.disk.files[data.CHAT_ID])
						this.disk.files[data.CHAT_ID] = {};
					if (this.disk.files[data.CHAT_ID][i])
						continue;

					data.FILES[i].date = new Date(data.FILES[i].date);
					this.disk.files[data.CHAT_ID][i] = data.FILES[i];
				}
				for (var i in data.USERS)
				{
					data.USERS[i].last_activity_date = new Date(data.USERS[i].last_activity_date);
					data.USERS[i].mobile_last_date = new Date(data.USERS[i].mobile_last_date);
					data.USERS[i].idle = data.USERS[i].idle? new Date(data.USERS[i].idle): false;
					data.USERS[i].absent = data.USERS[i].absent? new Date(data.USERS[i].absent): false;

					this.users[i] = data.USERS[i];
				}
				for (var i in data.USER_IN_GROUP)
				{
					if (typeof(this.userInGroup[i]) == 'undefined')
					{
						this.userInGroup[i] = data.USER_IN_GROUP[i];
					}
					else
					{
						for (var j = 0; j < data.USER_IN_GROUP[i].users.length; j++)
							this.userInGroup[i].users.push(data.USER_IN_GROUP[i].users[j]);

						this.userInGroup[i].users = BX.util.array_unique(this.userInGroup[i].users)
					}
				}
				for (var i in data.PHONES)
				{
					this.phones[i] = {};
					for (var j in data.PHONES[i])
					{
						this.phones[i][j] = BX.util.htmlspecialcharsback(data.PHONES[i][j]);
					}
				}
				var previousSearch = this.historySearch;
				this.historySearch = '';
				this.drawHistory(data.DIALOG_ID, data.USERS_MESSAGE, false);
				this.historySearch = previousSearch;

				if (BX('im-message-history-'+messageId))
				{
					var startScroll = BX('im-message-history-'+messageId).parentNode.offsetTop;

					this.popupHistoryItems.scrollTop = startScroll-(this.popupHistoryItems.offsetHeight/2)+(BX('im-message-history-'+messageId).parentNode.offsetHeight/2)
					BX.addClass(BX('im-message-history-'+messageId).parentNode, 'bx-messenger-history-item-context');
					BX.addClass(this.popupHistoryBodyWrap, 'bx-messenger-history-items-wrap-show-context');
				}
			}
			else
			{
				if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry < 2)
				{
					this.sendAjaxTry++;
					setTimeout(BX.delegate(function(){this.showContext(messageId)}, this), 1000);
					BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
				}
				else if (data.ERROR == 'AUTHORIZE_ERROR')
				{
					this.sendAjaxTry++;
					if (BX.MessengerCommon.isDesktop())
					{
						setTimeout(BX.delegate(function (){
							this.showContext(messageId)
						}, this), 10000);
					}
					BX.onCustomEvent(window, 'onImError', [data.ERROR]);
				}
			}
		}, this),
		onfailure: BX.delegate(function(){
			this.sendAjaxTry = 0;
		}, this)
	});
}

BX.MessengerChat.prototype.jumpToMessage = function(messageId)
{

}

BX.MessengerChat.prototype.deleteAllHistory = function(userId)
{
	BX.ajax({
		url: this.BXIM.pathToAjax+'?HISTORY_REMOVE_ALL&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_HISTORY_REMOVE_ALL' : 'Y', 'USER_ID' : userId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
	});
	BX.localStorage.set('mhra', userId, 5);

	this.history[userId] = [];
	this.showMessage[userId] = [];
	this.popupHistoryBodyWrap.innerHTML = '';
	this.popupHistoryBodyWrap.appendChild(BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
		BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_NO_MESSAGE')})
	]}));

	if (BX.MessengerCommon.isDesktop())
		BX.desktop.onCustomEvent("main", "bxImClearHistory", [userId]);
	else if (this.BXIM.init)
		BX.MessengerCommon.drawTab(userId);
};

BX.MessengerChat.prototype.drawMessageHistory = function(message)
{
	if (typeof(message) != 'object')
		return null;

	if (typeof(message.params) != 'object')
	{
		message.params = {};
	}

	var system = message.senderId == 0;
	if (message.system && message.system == 'Y')
	{
		system = true;
		message.senderId = 0;
	}

	var edited = message.params && message.params.IS_EDITED == 'Y';
	var deleted = message.params && message.params.IS_DELETED == 'Y';

	var messageText = message.text;

	var filesNode = BX.MessengerCommon.diskDrawFiles(message.chatId, message.params.FILE_ID, {'status': ['done', 'error'], 'boxId': 'im-file-history'});
	if (filesNode.length > 0)
	{
		filesNode = BX.create("div", { props : { className : "bx-messenger-file-box"+(message.text != ''? ' bx-messenger-file-box-with-message':'') }, children: filesNode});
	}
	else
	{
		filesNode = null;
	}

	var attachNode = null;

	var attaches = [];
	if (message.params.ATTACH)
	{
		for (var i = 0; i < message.params.ATTACH.length; i++)
		{
			attaches[i] = message.params.ATTACH[i];
		}

		var attachPattern = /\[ATTACH=([0-9]{1,})\]/gm;  var match = [];
		while ((match = attachPattern.exec(messageText)) !== null)
		{
			for (var i = 0; i < attaches.length; i++)
			{
				if (message.params.ATTACH[i].ID == match[1])
				{
					attachNode = BX.create("div", { props : { className : "bx-messenger-attach-box" }, children: BX.MessengerCommon.drawAttach(message.id, message.chatId, [attaches[i]])});
					messageText = messageText.replace('[ATTACH='+match[1]+']', attachNode.innerHTML);
					delete attaches[i];
				}
			}
		}
	}

	if (message.params.LINK_ACTIVE && message.params.LINK_ACTIVE.length > 0 && message.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString()) < 0)
	{
		messageText = messageText.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/ig, '$2');
	}

	var extraClass = "";
	if (message.params.CLASS)
	{
		extraClass = message.params.CLASS;
	}

	attachNode = BX.MessengerCommon.drawAttach(message.id, message.chatId, attaches);
	if (attachNode.length > 0)
	{
		attachNode = BX.create("div", { props : { className : "bx-messenger-attach-box" }, children: attachNode});
	}
	else
	{
		attachNode = null;
	}
	var messageUser = this.BXIM.messenger.users[message.senderId];
	if (message.params && messageUser && messageUser.id > 0 && (message.params.AVATAR || message.params.NAME || message.params.USER_ID))
	{
		messageUser = BX.clone(messageUser);
		if (message.params.AVATAR)
		{
			messageUser.avatar = message.params.AVATAR;
		}
		if (message.params.NAME)
		{
			messageUser.name = message.params.NAME;
			messageUser.first_name = message.params.NAME.split(" ")[0];
		}
		message = BX.clone(message);
		if (parseInt(message.params.USER_ID))
		{
			message.senderId = 'network'+message.params.USER_ID;
		}
	}
	var voteBlock = BX.MessengerCommon.linesVoteDraw(message.id);
	if (voteBlock)
	{
		messageText = voteBlock;
		message.system = 'Y';
	}
	else
	{
		extraClass = extraClass.replace('bx-messenger-content-item-vote', '');

		var voteResultBlock = BX.MessengerCommon.linesVoteResultDraw(message.id, messageText);
		if (voteResultBlock)
		{
			messageText = voteResultBlock;
		}
	}

	var textNode = null;
	if (typeof(messageText) == 'string')
	{
		textNode = BX.create("span", {
			props : { className : "bx-messenger-history-item-text"+(deleted?" bx-messenger-message-deleted": " ")+(deleted || edited?" bx-messenger-message-edited": "")},
			attrs: {'id' : 'im-message-history-'+message.id},
			html: BX.MessengerCommon.prepareText(messageText, false, true, true, (!this.BXIM.messenger.openChatFlag || message.senderId == this.BXIM.userId? false: (this.BXIM.messenger.users[this.BXIM.userId].name)))}
		);
	}
	else
	{
		textNode = BX.create("span", {
			props : { className : "bx-messenger-history-item-text"+(deleted?" bx-messenger-message-deleted": " ")+(deleted || edited?" bx-messenger-message-edited": "")},
			attrs: {'id' : 'im-message-history-'+message.id},
			children: [messageText]}
		);
	}

	if (filesNode == null && message.text.length <= 0)
	{
		resultNode = BX.create("div", {attrs : { 'data-messageId' : message.id}, props : { className : "bx-messenger-history-item-text bx-messenger-item-skipped"}});
	}
	else
	{
		var userAvatar = "";
		var userColor = "";
		if (message.senderId > 0 && messageUser)
		{
			userAvatar = messageUser.avatar;
			userColor = messageUser.color;
		}

		resultNode = BX.create("div", { attrs : { 'data-messageId' : message.id}, props : { className : "bx-messenger-history-item"+(message.senderId == 0? " bx-messenger-history-item-3": (message.senderId == this.BXIM.userId?"": " bx-messenger-history-item-2"))+" "+extraClass }, children : [
			BX.create("div", { props : { className : "bx-messenger-history-hide" }, html : this.historyMessageSplit}),
			BX.create("span", { props : { className : "bx-messenger-history-item-avatar"}, children : [
				BX.create('img', { props : { className : "bx-messenger-content-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(userAvatar)? " bx-messenger-content-item-avatar-img-default": "") }, attrs : {src : message.senderId>0? userAvatar: this.BXIM.pathToBlankImage, style: (message.senderId>0 && BX.MessengerCommon.isBlankAvatar(userAvatar) && userColor? 'background-color: '+userColor: '')}})
			]}),
			BX.create("div", { props : { className : "bx-messenger-history-item-name" }, html : (this.users[message.senderId]? this.users[message.senderId].name: BX.message('IM_M_SYSTEM_USER'))+' <span class="bx-messenger-history-hide">[</span><span class="bx-messenger-history-item-date">'+BX.MessengerCommon.formatDate(message.date, BX.MessengerCommon.getDateFormatType('MESSAGE'))+'</span><span class="bx-messenger-history-hide">]</span>'/*<span class="bx-messenger-history-item-delete-icon" title="'+BX.message('IM_M_HISTORY_DELETE')+'" data-messageId="'+message.id+'"></span>*/}),
			BX.create("div", { props : { className : "bx-messenger-history-item-menu" }}),
			textNode,filesNode, attachNode,
			BX.create("div", { props : { className : "bx-messenger-history-hide" }, html : '<br />'}),
			BX.create("div", { props : { className : "bx-messenger-history-hide" }, html : this.historyMessageSplit})
		]});
	}

	return resultNode;
}

BX.MessengerChat.prototype.drawHistory = function(userId, historyElements, loadFromServer, sort)
{
	if (this.popupHistory == null)
		return false;

	sort = typeof(sort) == 'undefined'? true: sort;
	loadFromServer = typeof(loadFromServer) == 'undefined'? true: loadFromServer;

	var userIsChat = false;
	var chatId = 0;
	if (userId.toString().substr(0,4) == 'chat')
	{
		userIsChat = true;
		chatId = userId.toString().substr(4);
	}
	var arHistory = [];
	var nodeNeedClear = false;
	BX.removeClass(this.popupHistoryBodyWrap, 'bx-messenger-history-items-wrap-show-context');
	this.popupHistoryBodyWrap.innerHTML = '';

	var activeSearch = this.historySearch.length > 0;
	var historyElements = !historyElements? this.history: historyElements;
	if (historyElements[userId] && (!userIsChat && this.users[userId] || userIsChat && this.chat[chatId]))
	{
		var arHistorySort = BX.util.array_unique(historyElements[userId]);
		var arHistoryGroup = {};
		if (sort)
		{
			arHistorySort.sort(BX.delegate(function(i, ii) {i = parseInt(i); ii = parseInt(ii); if (!this.message[i] || !this.message[ii]){return 0;} var i1 = this.message[i].date.getTime(); var i2 = this.message[ii].date.getTime(); if (i1 > i2) { return -1; } else if (i1 < i2) { return 1;} else{ if (i > ii) { return -1; } else if (i < ii) { return 1;}else{ return 0;}}}, this));
		}
		for (var i = 0; i < arHistorySort.length; i++)
		{
			if (activeSearch && this.message[historyElements[userId][i]].text.toLowerCase().indexOf((this.historySearch+'').toLowerCase()) < 0)
				continue;

			var dateGroupTitle = BX.MessengerCommon.formatDate(this.message[historyElements[userId][i]].date, BX.MessengerCommon.getDateFormatType('MESSAGE_TITLE'));
			if (!BX('bx-im-history-'+dateGroupTitle) && !arHistoryGroup[dateGroupTitle])
			{
				arHistoryGroup[dateGroupTitle] = true;
				arHistory.push(BX.create("div", {props : { className: "bx-messenger-content-group bx-messenger-content-group-history"}, children : [
					BX.create("div", {attrs: {id: 'bx-im-history-'+dateGroupTitle}, props : { className: "bx-messenger-content-group-title"+(this.BXIM.language == 'ru'? ' bx-messenger-lowercase': '')}, html : dateGroupTitle})
				]}));
			}

			var message = this.drawMessageHistory(this.message[historyElements[userId][i]]);
			if (message)
				arHistory.push(message);
		}
		if (arHistory.length <= 0)
		{
			if (!this.historySearchBegin)
			{
				nodeNeedClear = true;
				arHistory = [
					BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
						BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_NO_MESSAGE')})
					]})
				];
			}
		}
	}
	else if (this.showMessage[userId] && this.showMessage[userId].length <= 0)
	{
		nodeNeedClear = true;
		arHistory = [
			BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
				BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_NO_MESSAGE')})
			]})
		];
	}

	if (arHistory.length > 0)
	{
		BX.adjust(this.popupHistoryBodyWrap, {children: arHistory});
		this.popupHistoryItems.scrollTop = 0;
	}

	if (loadFromServer && (!this.showMessage[userId] || this.showMessage[userId] && this.showMessage[userId].length < 20))
	{
		if (nodeNeedClear)
			this.popupHistoryFilesBodyWrap.innerHTML = '';

		this.popupHistoryBodyWrap.appendChild(
			BX.create("div", { props : { className : (BX.findChildrenByClassName(this.popupHistoryBodyWrap, "bx-messenger-history-item-text")).length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history" }, children : [
				BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
				BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_LOAD_MESSAGE')})
			]})
		);
		BX.ajax({
			url: this.BXIM.pathToAjax+'?HISTORY_LOAD&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			skipAuthCheck: true,
			timeout: 30,
			data: {'IM_HISTORY_LOAD' : 'Y', 'USER_ID' : userId, 'USER_LOAD' : userIsChat? (this.chat[userId.toString().substr(4)] && this.chat[userId.toString().substr(4)].fake? 'Y': 'N'): (this.users[userId] && this.users[userId].fake? 'Y': 'N'), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(data)
			{
				if (data && data.BITRIX_SESSID)
				{
					BX.message({'bitrix_sessid': data.BITRIX_SESSID});
				}
				if (data.ERROR == '')
				{
					if (!userIsChat)
					{
						if (!this.userChat[userId])
						{
							this.userChat[userId] = data.CHAT_ID;
						}
					}

					for (var i in data.FILES)
					{
						if (!this.disk.files[data.CHAT_ID])
							this.disk.files[data.CHAT_ID] = {};
						if (this.disk.files[data.CHAT_ID][i])
							continue;
						data.FILES[i].date = new Date(data.FILES[i].date);
						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
					}

					this.showMessage[userId] = [];
					this.sendAjaxTry = 0;
					for (var i in data.MESSAGE)
					{
						data.MESSAGE[i].date = new Date(data.MESSAGE[i].date);
						this.message[i] = data.MESSAGE[i];
						if (this.BXIM.settings.loadLastMessage)
							this.showMessage[userId].push(i);
					}
					for (var i in data.USERS_MESSAGE)
					{
						if (this.history[i])
							this.history[i] = BX.util.array_merge(this.history[i], data.USERS_MESSAGE[i]);
						else
							this.history[i] = data.USERS_MESSAGE[i];
					}
					if ((!userIsChat && this.users[userId] && !this.users[userId].fake) ||
						(userIsChat && this.chat[data.CHAT_ID] && !this.chat[data.CHAT_ID].fake))
					{
						BX.cleanNode(this.popupHistoryBodyWrap);
						if (!data.USERS_MESSAGE[userId] || data.USERS_MESSAGE[userId].length <= 0)
						{
							this.popupHistoryBodyWrap.appendChild(
								BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
									BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_NO_MESSAGE')})
								]})
							);
						}
						else
						{
							for (var i = 0; i < data.USERS_MESSAGE[userId].length; i++)
							{
								var dateGroupTitle = BX.MessengerCommon.formatDate(this.message[data.USERS_MESSAGE[userId][i]].date, BX.MessengerCommon.getDateFormatType('MESSAGE_TITLE'));
								var dataGroupCode = typeof(BX.translit) != 'undefined'? BX.translit(dateGroupTitle): dateGroupTitle;
								if (!BX('bx-im-history-'+dataGroupCode))
								{
									this.popupHistoryBodyWrap.appendChild(BX.create("div", {props : { className: "bx-messenger-content-group bx-messenger-content-group-history"}, children : [
										BX.create("div", {attrs: {id: 'bx-im-history-'+dataGroupCode}, props : { className: "bx-messenger-content-group-title"+(this.BXIM.language == 'ru'? ' bx-messenger-lowercase': '')}, html : dateGroupTitle})
									]}));
								}

								var message = this.drawMessageHistory(this.message[data.USERS_MESSAGE[userId][i]]);
								if (message)
									this.popupHistoryBodyWrap.appendChild(message);

							}
						}
						if (this.BXIM.settings.loadLastMessage && this.currentTab == userId)
							BX.MessengerCommon.drawTab(this.currentTab, true);
					}
					else
					{
						if (userIsChat && this.chat[data.USER_ID.substr(4)].fake)
							this.chat[data.USER_ID.toString().substr(4)].name = BX.message('IM_M_USER_NO_ACCESS');

						if (!userIsChat)
						{
							BX.MessengerCommon.getUserParam(userId, true);
							this.users[userId].name = BX.message('IM_M_USER_NO_ACCESS');
						}

						for (var i in data.USERS)
						{
							data.USERS[i].last_activity_date = new Date(data.USERS[i].last_activity_date);
							data.USERS[i].mobile_last_date = new Date(data.USERS[i].mobile_last_date);
							data.USERS[i].idle = data.USERS[i].idle? new Date(data.USERS[i].idle): false;
							data.USERS[i].absent = data.USERS[i].absent? new Date(data.USERS[i].absent): false;

							this.users[i] = data.USERS[i];
						}
						for (var i in data.USER_IN_GROUP)
						{
							if (typeof(this.userInGroup[i]) == 'undefined')
							{
								this.userInGroup[i] = data.USER_IN_GROUP[i];
							}
							else
							{
								for (var j = 0; j < data.USER_IN_GROUP[i].users.length; j++)
									this.userInGroup[i].users.push(data.USER_IN_GROUP[i].users[j]);

								this.userInGroup[i].users = BX.util.array_unique(this.userInGroup[i].users)
							}
						}
						for (var i in data.CHAT)
						{
							data.CHAT[i].date_create = new Date(data.CHAT[i].date_create);
							this.chat[i] = data.CHAT[i];
						}
						for (var i in data.USER_IN_CHAT)
						{
							this.userInChat[i] = data.USER_IN_CHAT[i];
						}
						for (var i in data.USER_BLOCK_CHAT)
						{
							this.userChatBlockStatus[i] = data.USER_BLOCK_CHAT[i];
						}
						if (!userIsChat)
							BX.MessengerCommon.userListRedraw();
						this.dialogStatusRedraw();

						this.drawHistory(userId, false, false);
					}
					if (this.historyChatId == 0)
					{
						this.historyChatId = data.CHAT_ID;
						this.drawHistoryFiles(this.historyChatId);
					}
					this.redrawHistoryPanel(userId, userIsChat? data.USER_ID.substr(4): 0);
				}
				else
				{
					if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry < 2)
					{
						this.sendAjaxTry++;
						setTimeout(BX.delegate(function(){this.drawHistory(userId, historyElements, loadFromServer)}, this), 1000);
						BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
					}
					else if (data.ERROR == 'AUTHORIZE_ERROR')
					{
						this.sendAjaxTry++;
						if (BX.MessengerCommon.isDesktop())
						{
							setTimeout(BX.delegate(function (){
								this.drawHistory(userId, historyElements, loadFromServer)
							}, this), 10000);
						}
						BX.onCustomEvent(window, 'onImError', [data.ERROR]);
					}
				}
			}, this),
			onfailure: BX.delegate(function(){
				this.sendAjaxTry = 0;
			}, this)
		});
	}
};

BX.MessengerChat.prototype.redrawHistoryPanel = function(userId, chatId, params)
{
	var isChat = userId.toString().substr(0,4) == 'chat'? true: false;
	var historyPanel = null;
	params = params || {};

	BX.MessengerCommon.getUserParam(userId);
	if (isChat)
	{
		historyPanel = BX.create("div", { props : { className : "bx-messenger-panel bx-messenger-panel-bg2" }, children : [
			BX.create('span', { props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-"+this.chat[chatId].type }, children:[
				BX.create('img', { attrs : { src : this.chat[chatId].avatar, style: (BX.MessengerCommon.isBlankAvatar(this.chat[chatId].avatar)? 'background-color: '+this.chat[chatId].color: '')}, props : { className : "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.chat[chatId].avatar)? " bx-messenger-panel-avatar-img-default": "") }})
			]}),
			params.drawLinesVote == 'Y'? BX.create("a", { attrs: {'data-sessionId': params.sessionId, 'data-rating': params.sessionVoteHead, 'data-context': 'history', title: BX.message('IM_M_HISTORY_LINES_VOTE_AND_COMMENT')}, props : { className : "bx-messenger-panel-history-vote"}, events: {'click': BX.delegate(function(){ this.linesVoteAndCommentHeadDialog(BX.proxy_context, params.sessionId, params.sessionVoteHead, params.sessionCommentHead); return BX.PreventDefault(); }, this)}}): null,
			params.drawLinesJoin == 'Y'? BX.create("a", { attrs: {title: BX.message('IM_M_HISTORY_LINES_JOIN')}, props : { className : "bx-messenger-panel-history-join"}, events: {'click': BX.delegate(function(){ this.popupHistory.close(); this.linesOpenMessenger(this.chat[chatId].entity_id)}, this)}}): null,
			this.popupHistoryButtonDeleteAll = this.chat[chatId].type == 'open' || this.chat[chatId].type == 'lines'? null: BX.create("a", { attrs: {title: BX.message('IM_M_HISTORY_DELETE_ALL')}, props : { className : "bx-messenger-panel-basket"}}),
			BX.create("span", { props : { className : "bx-messenger-panel-title bx-messenger-panel-title-middle"}, html: this.chat[chatId].name})
		]});
	}
	else
	{
		historyPanel = BX.create("div", { props : { className : "bx-messenger-panel bx-messenger-panel-bg2" }, children : [
			BX.create('a', { attrs : { href : this.users[userId].profile}, props : { className : "bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[userId]) }, children: [
				BX.create('img', { attrs : { src : this.users[userId].avatar, style: (BX.MessengerCommon.isBlankAvatar(this.users[userId].avatar)? 'background-color: '+this.users[userId].color: '')}, props : { className : "bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.users[userId].avatar)? " bx-messenger-panel-avatar-img-default": "") }}),
				BX.create('span', {  attrs : { title : (BX.MessengerCommon.getUserStatus(this.users[userId], false)).title},  props : { className : "bx-messenger-panel-avatar-status" }})
			]}),
			this.popupHistoryButtonDeleteAll = userId == this.BXIM.userId? null: BX.create("a", { props : { className : "bx-messenger-panel-basket"}}),
			BX.create("span", { props : { className : "bx-messenger-panel-title"}, html: (
				this.users[userId].extranet? '<div class="bx-messenger-user-extranet">'+this.users[userId].name+'</div>':
				(this.users[userId].bot && this.bot[userId]? '<div class="'+(this.bot[userId].type == 'network'? 'bx-messenger-user-network': 'bx-messenger-user-bot')+'">'+this.users[userId].name+'</div>': this.users[userId].name)
			)}),
			BX.create("span", { props : { className : "bx-messenger-panel-desc"}, html: BX.MessengerCommon.getUserPosition(this.users[userId])})
		]});
	}

	if (this.popupHistoryPanel)
	{
		this.popupHistoryPanel.innerHTML = '';
		BX.adjust(this.popupHistoryPanel, {children: [historyPanel]});
	}
	else
	{
		return [historyPanel];
	}
}

BX.MessengerChat.prototype.drawHistoryFiles = function(chatId, filesElements, loadFromServer)
{
	if (this.popupHistory == null)
		return false;

	loadFromServer = typeof(loadFromServer) == 'undefined'? true: loadFromServer;

	var activeSearch = this.historyFilesSearch.length > 0;
	var filesElements = !filesElements? this.disk.files[chatId]: filesElements;
	var arFiles = [];
	var nodeNeedClear = false;
	if (filesElements)
	{
		var arFilesSort = BX.util.objectSort(filesElements, 'date', 'desc');
		for (var i = 0; i < arFilesSort.length; i++)
		{
			if (activeSearch && arFilesSort[i].name.toLowerCase().indexOf((this.historyFilesSearch+'').toLowerCase()) < 0)
				continue;

			var filesNode = this.disk.drawHistoryFiles(chatId, arFilesSort[i].id, {getElement: 'Y'});
			if (filesNode)
				arFiles.push(filesNode);
		}
		if (arFiles.length <= 0)
		{
			if (!this.historyFilesSearchBegin)
			{
				nodeNeedClear = true;
				arFiles = [
					BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
						BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_NO_FILES_2')})
					]})
				];
			}
		}
		if (arFiles.length >= 15)
		{
			loadFromServer = false;
		}
	}
	else if (chatId == 0)
	{
		nodeNeedClear = true;
		arFiles = [
			BX.create("div", { props : { className : this.popupHistoryFilesBodyWrap.childNodes.length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history" }, children : [
				BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
				BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_LOAD_FILES')})
			]})
		];
	}
	else
	{
		nodeNeedClear = true;
		arFiles = [
			BX.create("div", { props : { className : "bx-messenger-content-history-empty" }, children : [
				BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_NO_FILES_2')})
			]})
		];
	}

	this.popupHistoryFilesBodyWrap.innerHTML = '';
	if (arFiles.length > 0)
	{
		BX.adjust(this.popupHistoryFilesBodyWrap, {children : arFiles});
		this.popupHistoryFilesItems.scrollTop = 0;
	}

	if (loadFromServer && chatId > 0)
	{
		if (nodeNeedClear)
			this.popupHistoryFilesBodyWrap.innerHTML = '';

		this.popupHistoryFilesBodyWrap.appendChild(
			BX.create("div", { props : { className : this.popupHistoryFilesBodyWrap.childNodes.length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history" }, children : [
				BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
				BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_LOAD_FILES')})
			]})
		);

		BX.ajax({
			url: this.BXIM.pathToAjax+'?HISTORY_FILES_LOAD&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			skipAuthCheck: true,
			timeout: 30,
			data: {'IM_HISTORY_FILES_LOAD' : 'Y', 'CHAT_ID' : chatId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(data)
			{
				if (data && data.BITRIX_SESSID)
				{
					BX.message({'bitrix_sessid': data.BITRIX_SESSID});
				}
				if (data.ERROR == '')
				{
					for (var i in data.FILES)
					{
						if (!this.disk.files[data.CHAT_ID])
							this.disk.files[data.CHAT_ID] = {};

						data.FILES[i].date = new Date(data.FILES[i].date);
						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
					}
					this.drawHistoryFiles(data.CHAT_ID, false, false);
				}
				else
				{
					if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry < 2)
					{
						this.sendAjaxTry++;
						BX.message({'bitrix_sessid': data.BITRIX_SESSID});
						setTimeout(BX.delegate(function(){this.drawHistoryFiles(chatId, filesElements, loadFromServer)}, this), 1000);
						BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
					}
					else if (data.ERROR == 'AUTHORIZE_ERROR')
					{
						this.sendAjaxTry++;
						if (BX.MessengerCommon.isDesktop())
						{
							setTimeout(BX.delegate(function (){
								this.drawHistoryFiles(chatId, filesElements, loadFromServer)
							}, this), 10000);
						}
						BX.onCustomEvent(window, 'onImError', [data.ERROR]);
					}
				}
			}, this),
			onfailure: BX.delegate(function(){
				this.sendAjaxTry = 0;
			}, this)
		});
	}
};

BX.MessengerChat.prototype.newHistorySearch = function(event)
{
	event = event||window.event;
	if (event.keyCode == 27 && this.historySearch != '')
		BX.MessengerCommon.preventDefault(event);

	if (event.keyCode == 27)
		this.popupHistorySearchInput.value = '';


	this.historySearch = this.popupHistorySearchInput.value;
	if (this.historyLastSearch[this.historyUserId] == this.historySearch)
	{
		return false;
	}
	this.historyLastSearch[this.historyUserId] = this.historySearch;

	if (this.popupHistorySearchInput.value.length <= 3)
	{
		this.historySearch = "";
		this.drawHistory(this.historyUserId, false, false);
		return false;
	}

	this.popupHistorySearchDateInput.value = '';
	this.historyDateSearch = "";

	this.historySearchBegin = true;
	this.drawHistory(this.historyUserId, false, false);

	var elEmpty = BX.findChildByClassName(this.popupHistoryBodyWrap, "bx-messenger-content-load-history");
	if (elEmpty)
		BX.remove(elEmpty);

	var elEmpty = BX.findChildByClassName(this.popupHistoryBodyWrap, "bx-messenger-content-history-empty");
	if (elEmpty)
		BX.remove(elEmpty);

	var tmpLoadMoreWait = null;
	this.popupHistoryBodyWrap.appendChild(tmpLoadMoreWait = BX.create("div", { props : { className : this.popupHistoryBodyWrap.childNodes.length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history"}, children : [
		BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
		BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_LOAD_MESSAGE')})
	]}));

	clearTimeout(this.historySearchTimeout);
	if (this.popupHistorySearchInput.value != '')
	{
		this.historySearchTimeout = setTimeout(BX.delegate(function(){
			BX.ajax({
				url: this.BXIM.pathToAjax+'?HISTORY_SEARCH&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 30,
				data: {'IM_HISTORY_SEARCH' : 'Y', 'USER_ID' : this.historyUserId, 'SEARCH' : this.popupHistorySearchInput.value, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
				onsuccess: BX.delegate(function(data){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historySearchBegin = false;
					if (data.ERROR != '')
						return false;

					if (data.MESSAGE.length == 0)
					{
						var nullResult = {};
						nullResult[data.USER_ID] = [];

						this.drawHistory(data.USER_ID, nullResult, false);
						return;
					}

					for (var i in data.MESSAGE)
					{
						data.MESSAGE[i].date = new Date(data.MESSAGE[i].date);
						this.message[i] = data.MESSAGE[i];
					}

					for (var i in data.FILES)
					{
						if (!this.disk.files[data.CHAT_ID])
							this.disk.files[data.CHAT_ID] = {};

						data.FILES[i].date = new Date(data.FILES[i].date);
						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
					}

					this.drawHistory(data.USER_ID, data.USERS_MESSAGE, false);
				}, this),
				onfailure: BX.delegate(function(){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historySearchBegin = false;
				}, this)
			});
		}, this), 1500);
	}

	return BX.PreventDefault(event);
};

BX.MessengerChat.prototype.newHistoryDateSearch = function(params)
{
	this.historyDateSearch = this.popupHistorySearchDateInput.value;
	if (this.historyLastSearch[this.historyUserId] == this.historyDateSearch)
	{
		return false;
	}
	this.historyLastSearch[this.historyUserId] = this.historyDateSearch;

	if (this.historyDateSearch.length <= 3)
	{
		this.historyDateSearch = "";
		this.drawHistory(this.historyUserId, false, false);
		return false;
	}

	this.popupHistorySearchInput.value = '';
	this.historySearch = "";

	this.historySearchBegin = true;

	var tmpLoadMoreWait = null;
	this.popupHistoryBodyWrap.innerHTML = '';
	this.popupHistoryBodyWrap.appendChild(tmpLoadMoreWait = BX.create("div", { props : { className : this.popupHistoryBodyWrap.childNodes.length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history"}, children : [
		BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
		BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_M_LOAD_MESSAGE')})
	]}));

	clearTimeout(this.historySearchTimeout);
	if (this.historyDateSearch != '')
	{
		this.historySearchTimeout = setTimeout(BX.delegate(function(){
			BX.ajax({
				url: this.BXIM.pathToAjax+'?HISTORY_DATE_SEARCH&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 30,
				data: {'IM_HISTORY_DATE_SEARCH' : 'Y', 'USER_ID' : this.historyUserId, 'DATE' : this.historyDateSearch, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
				onsuccess: BX.delegate(function(data){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historySearchBegin = false;
					if (data.ERROR != '')
						return false;

					if (data.MESSAGE.length == 0)
					{
						var nullResult = {};
						nullResult[data.USER_ID] = [];

						this.drawHistory(data.USER_ID, nullResult, false);
						return;
					}

					for (var i in data.MESSAGE)
					{
						data.MESSAGE[i].date = new Date(data.MESSAGE[i].date);
						this.message[i] = data.MESSAGE[i];
					}

					for (var i in data.FILES)
					{
						if (!this.disk.files[data.CHAT_ID])
							this.disk.files[data.CHAT_ID] = {};

						data.FILES[i].date = new Date(data.FILES[i].date);
						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
					}

					this.drawHistory(data.USER_ID, data.USERS_MESSAGE, false);
				}, this),
				onfailure: BX.delegate(function(){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historySearchBegin = false;
				}, this)
			});
		}, this), 1500);
	}
};

BX.MessengerChat.prototype.newHistoryFilesSearch = function(event)
{
	event = event||window.event;
	if (event.keyCode == 27 && this.historyFilesSearch != '')
		BX.MessengerCommon.preventDefault(event);

	if (event.keyCode == 27)
		this.popupHistoryFilesSearchInput.value = '';

	this.historyFilesSearch = this.popupHistoryFilesSearchInput.value;
	if (this.historyFilesLastSearch[this.historyChatId] == this.historyFilesSearch)
	{
		return false;
	}
	this.historyFilesLastSearch[this.historyChatId] = this.historyFilesSearch;

	if (this.popupHistoryFilesSearchInput.value.length <= 3)
	{
		this.historyFilesSearch = "";
		this.drawHistoryFiles(this.historyChatId, false, false);
		return false;
	}

	this.historyFilesSearchBegin = true;
	this.historySearch = this.popupHistorySearchInput.value;
	this.drawHistoryFiles(this.historyChatId, false, false);

	var elEmpty = BX.findChildByClassName(this.popupHistoryFilesBodyWrap, "bx-messenger-content-load-history");
	if (elEmpty)
		BX.remove(elEmpty);

	var elEmpty = BX.findChildByClassName(this.popupHistoryFilesBodyWrap, "bx-messenger-content-history-empty");
	if (elEmpty)
		BX.remove(elEmpty);

	var tmpLoadMoreWait = null;
	this.popupHistoryFilesBodyWrap.appendChild(tmpLoadMoreWait = BX.create("div", { props : { className : this.popupHistoryFilesBodyWrap.childNodes.length>0? "bx-messenger-content-load-more-history":"bx-messenger-content-load-history"}, children : [
		BX.create('span', { props : { className : "bx-messenger-content-load-img" }}),
		BX.create("span", { props : { className : "bx-messenger-content-load-text" }, html : BX.message('IM_F_LOAD_FILES')})
	]}));

	clearTimeout(this.historyFilesSearchTimeout);
	if (this.popupHistoryFilesSearchInput.value != '')
	{
		this.historyFilesSearchTimeout = setTimeout(BX.delegate(function(){
			BX.ajax({
				url: this.BXIM.pathToAjax+'?HISTORY_FILES_SEARCH&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 30,
				data: {'IM_HISTORY_FILES_SEARCH' : 'Y', 'CHAT_ID' : this.historyChatId, 'SEARCH' : this.popupHistoryFilesSearchInput.value, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
				onsuccess: BX.delegate(function(data){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historyFilesSearchBegin = false;

					if (data.ERROR != '')
						return false;

					if (data.FILES.length == 0)
					{
						this.drawHistoryFiles(data.CHAT_ID, false, false);
						return;
					}

					var fileFound = false;
					for (var i in data.FILES)
					{
						if (!this.disk.files[data.CHAT_ID])
							this.disk.files[data.CHAT_ID] = {};

						if (!this.disk.files[data.CHAT_ID][i])
							data.FILES[i].fromSearch = true;

						data.FILES[i].date = new Date(data.FILES[i].date);

						this.disk.files[data.CHAT_ID][i] = data.FILES[i];
						fileFound = true;
					}
					this.drawHistoryFiles(data.CHAT_ID, fileFound? data.FILES: false, false);
				}, this),
				onfailure: BX.delegate(function(){
					if (tmpLoadMoreWait)
						BX.remove(tmpLoadMoreWait);
					this.historyFilesSearchBegin = false;
				}, this)
			});
		}, this), 1500);
	}

	return BX.PreventDefault(event);
};

/* GET DATA */
BX.MessengerChat.prototype.setUpdateStateStep = function(send)
{
	send = send != false;

	var step = this.updateStateStepDefault;
	if (!this.BXIM.ppServerStatus)
	{
		if (this.popupMessenger != null)
		{
			step = 20;
			if (this.updateStateVeryFastCount > 0)
			{
				step = 5;
				this.updateStateVeryFastCount--;
			}
			else if (this.updateStateFastCount > 0)
			{
				step = 10;
				this.updateStateFastCount--;
			}
		}
	}

	this.updateStateStep = parseInt(step);

	if (send)
		BX.localStorage.set('uss', this.updateStateStep, 5);

	this.updateState();
};

BX.MessengerChat.prototype.updateState = function(force, send, reason)
{
	if (!this.BXIM.tryConnect || this.popupMessengerConnectionStatusState == 'offline')
		return false;

	force = force == true;
	send = send != false;
	reason = reason || 'UPDATE_STATE';

	clearTimeout(this.updateStateTimeout);
	this.updateStateTimeout = setTimeout(
		BX.delegate(function(){
			if (BX.MessengerCommon.isDesktop())
			{
				var errorText = 'IM UPDATE STATE: sending ajax'+(reason == 'UPDATE_STATE'? '': ' ('+reason+')')+' ['+this.updateStateCount+']';
				BX.desktop.log('phone.'+this.BXIM.userEmail+'.log', errorText);console.log(errorText);
			}
			var _ajax = BX.ajax({
				url: this.BXIM.pathToAjax+'?'+reason+'&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				skipAuthCheck: true,
				lsId: 'IM_UPDATE_STATE',
				lsTimeout: 1,
				timeout: 30,
				data: {'IM_UPDATE_STATE' : 'Y', 'OPEN_MESSENGER' : this.popupMessenger != null? 1: 0, 'TAB' : this.currentTab, 'FM' : JSON.stringify(this.flashMessage), 'FN' :  JSON.stringify(this.notify.flashNotify), 'SITE_ID': BX.message('SITE_ID'),'IM_AJAX_CALL' : 'Y', 'DESKTOP' : (BX.MessengerCommon.isDesktop()? 'Y': 'N'), 'sessid': BX.bitrix_sessid()},
				onsuccess: BX.delegate(function(data)
				{
					if (send)
						BX.localStorage.set('mus', true, 5);

					if (BX.MessengerCommon.isDesktop())
					{
						var errorText = '';
						if (data.ERROR == '')
						{
							errorText = 'IM UPDATE STATE: success request ['+this.updateStateCount+']';
						}
						else
						{
							errorText = 'IM UPDATE STATE: bad request ('+data.ERROR+') ['+this.updateStateCount+']';
						}
						BX.desktop.log('phone.'+this.BXIM.userEmail+'.log', errorText);console.log(errorText);
					}
					this.updateStateCount++;

					if (data && data.BITRIX_SESSID)
					{
						BX.message({'bitrix_sessid': data.BITRIX_SESSID});
					}
					if (data && data.ERROR == '')
					{
						if (!this.BXIM.checkRevision(data.REVISION))
							return false;

						if(this.BXIM.desktopDisk)
						{
							this.BXIM.desktopDisk.checkRevision(data.DISK_REVISION);
						}

						BX.message({'SERVER_TIME': data.SERVER_TIME});
						this.notify.updateNotifyCounters(data.COUNTERS, send);
						this.notify.updateNotifyMailCount(data.MAIL_COUNTER, send);

						if (!this.BXIM.xmppStatus && data.XMPP_STATUS && data.XMPP_STATUS == 'Y')
							this.BXIM.xmppStatus = true;

						if (!this.BXIM.desktopStatus && data.DESKTOP_STATUS && data.DESKTOP_STATUS == 'Y')
							this.BXIM.desktopStatus = true;

						var contactListRedraw = false;
						if (!(data.ONLINE.length <= 0))
						for (var i in data.ONLINE)
						{
							if (this.users[i])
							{
								this.users[i].status = data.ONLINE[i].status;
								this.users[i].color = data.ONLINE[i].color;
								this.users[i].idle = data.ONLINE[i].idle? new Date(data.ONLINE[i].idle): false;
								this.users[i].last_activity_date = new Date(data.ONLINE[i].last_activity_date);
								this.users[i].mobile_last_date = new Date(data.ONLINE[i].mobile_last_date);
							}
						}

						this.BXIM.messenger.command = data.COMMAND? data.COMMAND: [];
						this.BXIM.messenger.textareaIcon = data.TEXTAREA_ICON? data.TEXTAREA_ICON: [];
						this.BXIM.messenger.textareaIconPrepare();

						if (typeof(data.FILES) != "undefined")
						{
							for (var chatId in data.FILES)
							{
								if (!this.disk.files[chatId])
									this.disk.files[chatId] = {};

								for (var i in data.FILES[chatId])
								{
									data.FILES[chatId][i].date = new Date(data.FILES[chatId][i].date);
									this.disk.files[chatId][i] = data.FILES[chatId][i];
								}
							}
						}

						if (typeof(data.MESSAGE) != "undefined")
							for (var i in data.MESSAGE)
								data.MESSAGE[i].date = new Date(data.MESSAGE[i].date);

						BX.MessengerCommon.updateStateVar(data, send);
						if (typeof(data.USERS_MESSAGE) != "undefined")
							contactListRedraw = true;

						this.dialogStatusRedraw();
						BX.MessengerCommon.userListRedraw();

						if (typeof(data.NOTIFY) != "undefined")
						{
							for (var i in data.NOTIFY)
							{
								data.NOTIFY[i].date = new Date(data.NOTIFY[i].date);
								this.notify.notify[i] = data.NOTIFY[i];
								this.BXIM.lastRecordId = parseInt(i) > this.BXIM.lastRecordId? parseInt(i): this.BXIM.lastRecordId;
							}

							for (var i in data.FLASH_NOTIFY)
								if (typeof(this.notify.flashNotify[i]) == 'undefined')
									this.notify.flashNotify[i] = data.FLASH_NOTIFY[i];

							this.notify.changeUnreadNotify(data.UNREAD_NOTIFY, send);
						}

						this.setUpdateStateStep(false);
					}
					else if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry <= 2)
					{
							this.sendAjaxTry++;
							setTimeout(BX.delegate(function(){
								this.updateState(true, send, reason);
							}, this), 2000);
							BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
					}
					else  if (reason != 'UPDATE_STATE_RECONNECT')
					{
						if (data.ERROR == 'AUTHORIZE_ERROR')
						{
							this.sendAjaxTry++;
							if (BX.MessengerCommon.isDesktop())
							{
								setTimeout(BX.delegate(function (){
									this.updateState(true, send, reason);
								}, this), 10000);
							}
							BX.onCustomEvent(window, 'onImError', [data.ERROR]);
						}
						else if (this.sendAjaxTry < 5)
						{
							this.sendAjaxTry++;
							if (this.sendAjaxTry >= 2 && !BX.MessengerCommon.isDesktop())
							{
								BX.onCustomEvent(window, 'onImError', [data.ERROR]);
								return false;
							}

							setTimeout(BX.delegate(function(){
								this.updateState(true, send, reason);
							}, this), 60000);
							BX.onCustomEvent(window, 'onImError', [data.ERROR]);
						}
						else
						{

						}
					}
				}, this),
				onfailure: BX.delegate(function()
				{
					if (BX.MessengerCommon.isDesktop())
					{
						var errorText = 'IM UPDATE STATE: failure request (code: '+_ajax.status+') ['+this.updateStateCount+']';
						BX.desktop.log('phone.'+this.BXIM.userEmail+'.log', errorText); console.log(errorText);
					}
					this.updateStateCount++;

					this.sendAjaxTry = 0;
					this.setUpdateStateStep(false);
					try {
						if (typeof(_ajax) == 'object' && _ajax.status == 0 && reason != 'UPDATE_STATE_RECONNECT')
							BX.onCustomEvent(window, 'onImError', ['CONNECT_ERROR']);
					}
					catch(e) {}
				}, this)
			});
		}, this)
	, force? 150: this.updateStateStep*1000);
};

BX.MessengerChat.prototype.updateStateLight = function(force, send)
{
	if (!this.BXIM.tryConnect || this.popupMessengerConnectionStatusState == 'offline')
		return false;

	force = force == true;
	send = send != false;
	clearTimeout(this.updateStateTimeout);
	this.updateStateTimeout = setTimeout(
		BX.delegate(function(){
			BX.ajax({
				url: this.BXIM.pathToAjax+'?UPDATE_STATE_LIGHT&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				skipAuthCheck: true,
				lsId: 'IM_UPDATE_STATE_LIGHT',
				lsTimeout: 1,
				timeout: this.updateStateStepDefault > 10? this.updateStateStepDefault-2: 10,
				data: {'IM_UPDATE_STATE_LIGHT' : 'Y', 'SITE_ID': BX.message('SITE_ID'), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
				onsuccess: BX.delegate(function(data)
				{
					if (send)
						BX.localStorage.set('musl', true, 5);

					if (data && data.BITRIX_SESSID)
					{
						BX.message({'bitrix_sessid': data.BITRIX_SESSID});
					}

					if (data && data.ERROR == '')
					{
						if (!this.BXIM.checkRevision(data.REVISION))
							return false;

						BX.message({'SERVER_TIME': data.SERVER_TIME});

						this.notify.updateNotifyCounters(data.COUNTERS, send);
						this.updateStateLight(force, send);
					}
					else
					{
						if (data.ERROR == 'SESSION_ERROR' && this.sendAjaxTry <= 2)
						{
							this.sendAjaxTry++
							setTimeout(BX.delegate(function(){
								this.updateStateLight(true, send);
							}, this), 2000);
							BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
						}
						else if (data.ERROR == 'AUTHORIZE_ERROR')
						{
							this.sendAjaxTry++;
							if (BX.MessengerCommon.isDesktop())
							{
								setTimeout(BX.delegate(function (){
									this.updateStateLight(true, send);
								}, this), 10000);
							}
							BX.onCustomEvent(window, 'onImError', [data.ERROR]);
						}
						else if (this.sendAjaxTry < 5)
						{
							this.sendAjaxTry++;
							if (this.sendAjaxTry >= 2 && !BX.MessengerCommon.isDesktop())
							{
								BX.onCustomEvent(window, 'onImError', [data.ERROR]);
								return false;
							}

							setTimeout(BX.delegate(function(){
								this.updateStateLight(true, send);
							}, this), 60000);
							BX.onCustomEvent(window, 'onImError', [data.ERROR]);
						}
					}
				}, this),
				onfailure: BX.delegate(function() {
					this.sendAjaxTry = 0;
					this.setUpdateStateStep(false);
					try {
						if (typeof(_ajax) == 'object' && _ajax.status == 0)
							BX.onCustomEvent(window, 'onImError', ['CONNECT_ERROR']);
					}
					catch(e) {}
				}, this)
			});
		}, this)
	, force? 150: this.updateStateStepDefault*1000);
};

BX.MessengerChat.prototype.setClosingByEsc = function(result)
{
	if (this.popupMessenger == null)
		return false;

	if (result)
	{
		if (!this.BXIM.callController.hasActiveCall())
		{
			this.popupMessenger.setClosingByEsc(true);
		}
	}
	else
	{
		this.popupMessenger.setClosingByEsc(false);
	}
}
/* EXTRA */
BX.MessengerChat.prototype.extraOpen = function(content)
{
	if (!this.popupMessengerExtra)
		return false;

	this.setClosingByEsc(false);

	if (!this.BXIM.extraBind)
	{
		BX.bind(window, "keydown", this.BXIM.extraBind = BX.proxy(function(e) {
			if (e.keyCode == 27 && this.popupMessenger)
			{
				if (
					BX.SidePanel
					&& BX.SidePanel.Instance.isOpen()
					&& BX.SidePanel.Instance.isOnTop()
				)
				{
					BX.SidePanel.Instance.close()
				}
				else
				{
					this.popupMessenger.destroy();
				}
				//this.extraClose(true);
			}
		}, this));
	}

	this.BXIM.extraOpen = true;
	this.BXIM.dialogOpen = false;

	BX.style(this.popupMessengerDialog, 'display', 'none');
	BX.style(this.popupMessengerExtra, 'display', 'block');

	this.popupMessengerExtra.innerHTML = '';
	BX.adjust(this.popupMessengerExtra, {children: [content]});

	this.resizeMainWindow();
};

BX.MessengerChat.prototype.extraClose = function(openDialog, callToggle)
{
	if (!this.popupMessengerExtra)
		return true;

	setTimeout(BX.delegate(function(){
		this.setClosingByEsc(true);
	}, this), 200);

	if (this.BXIM.extraBind)
	{
		BX.unbind(window, "keydown", this.BXIM.extraBind);
		this.BXIM.extraBind = null;
	}

	this.BXIM.extraOpen = false;
	this.BXIM.dialogOpen = true;

	openDialog = openDialog == true;
	callToggle = callToggle != false;

	if (this.BXIM.notifyOpen)
		this.notify.closeNotify();

	this.closeMenuPopup();

	if (this.currentTab == 0)
	{
		this.extraOpen(
			BX.create("div", { props : { className : "bx-messenger-box-hello-wrap" }, children: [
				BX.create("div", { props : { className : "bx-messenger-box-hello" }, html: BX.message('IM_M_EMPTY')})
			]})
		);
	}
	else
	{
		BX.style(this.popupMessengerDialog, 'display', 'block');
		BX.style(this.popupMessengerExtra, 'display', 'none');
		this.popupMessengerExtra.innerHTML = '';

		if (openDialog)
		{
			this.openChatFlag = this.currentTab.toString().substr(0,4) == 'chat';
			BX.MessengerCommon.openDialog(this.currentTab, false, callToggle);
		}
	}
	this.resizeMainWindow();
};

/* TEXTAREA */

BX.MessengerChat.prototype.sendMessage = function(recipientId)
{
	if (this.popupMessengerConnectionStatusState != 'online')
		return false;

	recipientId = typeof(recipientId) == 'string' || typeof(recipientId) == 'number' ? recipientId: this.currentTab;
	BX.MessengerCommon.endSendWriting(recipientId);

	this.popupMessengerTextarea.value = this.popupMessengerTextarea.value.replace('    ', "\t");
	this.popupMessengerTextarea.value = BX.util.trim(this.popupMessengerTextarea.value);
	if (this.popupMessengerTextarea.value.length == 0)
		return false;

	if (this.popupMessengerTextarea.value.length > 20006)
	{
		this.popupMessengerTextarea.value = this.popupMessengerTextarea.value.substr(0, 20000)+' (...)';
	}

	if (this.BXIM.language=='ru' && BX.correctText && this.BXIM.settings.correctText)
	{
		this.popupMessengerTextarea.value = BX.correctText(this.popupMessengerTextarea.value);
	}

	this.addRecentSmile(this.popupMessengerTextarea.value);

	this.popupMessengerTextarea.value = this.popupMessengerTextarea.value.replace(/\[icon\=(\d+)([^\]]*)\]/ig, BX.delegate(function(whole, iconId)
	{
		iconId = 'icon'+iconId;
		var iconContent = '';
		if (this.smile[iconId].WIDTH == this.smile[iconId].HEIGHT)
		{
			iconContent = iconContent+' size='+this.smile[iconId].WIDTH;
		}
		else
		{
			if (this.smile[iconId].WIDTH)
			{
				iconContent = iconContent+' width='+this.smile[iconId].WIDTH;
			}
			if (this.smile[iconId].HEIGHT)
			{
				iconContent = iconContent+' height='+this.smile[iconId].NAME;
			}
		}
		if (this.smile[iconId].NAME)
		{
			iconContent = iconContent+' title='+this.smile[iconId].NAME;
		}

		return '[icon='+this.smile[iconId].IMAGE+iconContent+']';
	}, this));

	if (this.popupMessengerTextarea.value == '/clear')
	{
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		this.textareaHistory[this.currentTab] = '';
		this.showMessage[this.currentTab] = [];
		BX.MessengerCommon.drawTab(this.currentTab, true);

		if (BX.MessengerCommon.isDesktop())
			console.log('NOTICE: User use /clear');

		return false;
	}
	else if (this.popupMessengerTextarea.value == '/webrtcDebug' || this.popupMessengerTextarea.value == '/webrtcDebug on' || this.popupMessengerTextarea.value == '/webrtcDebug off')
	{
		if (this.popupMessengerTextarea.value == '/webrtcDebug')
			this.webrtc.debug = this.webrtc.debug? false: true;
		else if (this.popupMessengerTextarea.value == '/webrtcDebug on')
			this.webrtc.debug = true;
		else if (this.popupMessengerTextarea.value == '/webrtcDebug off')
			this.webrtc.debug = false;

		if (this.webrtc.debug)
		{
			this.tooltip(this.popupMessengerTextareaSendType.previousSibling, BX.message('IM_TIP_WEBRTC_ON'));
		}
		else
		{
			this.tooltip(this.popupMessengerTextareaSendType.previousSibling, BX.message('IM_TIP_WEBRTC_OFF'));
		}
		BX.PULL.capturePullEvent(this.webrtc.debug);

		this.textareaHistory[this.currentTab] = '';
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		if (console && console.log)
			console.log('NOTICE: User use /webrtcDebug and TURN '+(this.webrtc.debug? 'ON': 'OFF')+' debug');

		if (BX.MessengerCommon.isDesktop() && !this.webrtc.debug)
		{
			BX.MessengerWindow.windowReload();
		}

		return false;
	}
	else if (this.popupMessengerTextarea.value == '/windowReload')
	{
		this.textareaHistory[this.currentTab] = '';
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		location.reload();

		if (BX.MessengerCommon.isDesktop())
			console.log('NOTICE: User use /windowReload');

		return false;
	}
	else if (this.popupMessengerTextarea.value == '/correctText on' || this.popupMessengerTextarea.value == '/correctText off')
	{
		if (this.popupMessengerTextarea.value == '/correctText on')
		{
			this.BXIM.settings.correctText = true;
			this.tooltip(this.popupMessengerTextareaSendType.previousSibling, BX.message('IM_TIP_AC_ON'));
		}
		else
		{
			this.BXIM.settings.correctText = false;
			this.tooltip(this.popupMessengerTextareaSendType.previousSibling, BX.message('IM_TIP_AC_OFF'));
		}
		this.BXIM.saveSettings({'correctText': this.BXIM.settings.correctText});

		console.log('NOTICE: User use /correctText');
		return false;
	}
	else if (this.popupMessengerTextarea.value == '/getChatId')
	{
		var chatId = this.getChatId();
		this.tooltip(this.popupMessengerTextareaSendType.previousSibling, BX.message('IM_CHAT_ID_IS').replace('#CHAT_ID#', '<b>'+chatId+'</b>'));
		console.log('NOTICE: User use /getChatId');

		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		return false;
	}
	else if (this.popupMessengerTextarea.value.indexOf('/background') == 0)
	{
		var color = BX.util.trim(this.popupMessengerTextarea.value).split(" ")[1];
		if (!color)
		{
			color = this.BXIM.settings.backgroundImage? false: true;
		}

		this.BXIM.setBackground(color);
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		return false;
	}
	else if (this.popupMessengerTextarea.value.indexOf('/color') == 0)
	{
		var color = this.popupMessengerTextarea.value.split(" ")[1];
		if (color && this.openChatFlag)
		{
			BX.MessengerCommon.setColor(color, this.getChatId());
		}

		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		return false;
	}
	else if (this.popupMessengerTextarea.value.indexOf('/rename') == 0)
	{
		var title = this.popupMessengerTextarea.value.substr(8);
		if (title && this.openChatFlag)
		{
			BX.MessengerCommon.renameChat(this.getChatId(), title);
		}

		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		return false;
	}

	if (BX.MessengerCommon.isDesktop())
	{
		if (this.popupMessengerTextarea.value == '/openDeveloperTools')
		{
			this.textareaHistory[this.currentTab] = '';
			this.popupMessengerTextarea.value = '';
			this.textareaCheckText();

			BX.desktop.openDeveloperTools();

			console.log('NOTICE: User use /openDeveloperTools');
			return false;
		}
		else if (this.popupMessengerTextarea.value == '/clearWindowSize')
		{
			BX.desktop.setWindowSize({ Width: BX.MessengerWindow.initWidth, Height: BX.MessengerWindow.initHeight });
			this.BXIM.setLocalConfig('global_msz_v2', false);
			BX.desktop.apiReady = false;
			location.reload();

			if (BX.MessengerCommon.isDesktop())
				console.log('NOTICE: User use /clearWindowSize');

			return false;
		}
	}
	if (this.popupMessengerTextarea.value == '/showOnlyChat')
	{
		BX.MessengerCommon.recentListRedraw({'showOnlyChat': true});
		this.textareaHistory[this.currentTab] = '';
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();

		return false;
	}

	var chatId = recipientId.toString().substr(0,4) == 'chat'? recipientId.toString().substr(4): (this.userChat[recipientId]? this.userChat[recipientId]: 0);
	if (this.errorMessage[recipientId])
	{
		BX.MessengerCommon.sendMessageRetry();
		this.errorMessage[recipientId] = false;
	}

	this.popupMessengerTextarea.value = BX.MessengerCommon.prepareMention(recipientId, this.popupMessengerTextarea.value);

	var messageTmpIndex = this.messageTmpIndex;
	this.message['temp'+messageTmpIndex] = {'id' : 'temp'+messageTmpIndex, chatId: chatId, 'senderId' : this.BXIM.userId, 'recipientId' : recipientId, 'date' : new Date(), 'text' : BX.MessengerCommon.prepareText(this.popupMessengerTextarea.value, true) };
	if (!this.showMessage[recipientId])
		this.showMessage[recipientId] = [];
	this.showMessage[recipientId].push('temp'+messageTmpIndex);

	this.messageTmpIndex++;
	BX.localStorage.set('mti', this.messageTmpIndex, 5);
	if (this.popupMessengerTextarea == null || recipientId != this.currentTab)
		return false;

	clearTimeout(this.textareaHistoryTimeout);
	if (!BX.browser.IsAndroid() && !BX.browser.IsIOS())
		BX.focus(this.popupMessengerTextarea);

	var elLoad = BX.findChildByClassName(this.popupMessengerBodyWrap, "bx-messenger-content-load");
	if (elLoad)
		BX.remove(elLoad);

	var elEmpty = BX.findChildByClassName(this.popupMessengerBodyWrap, "bx-messenger-content-empty");
	if (elEmpty)
		BX.remove(elEmpty);

	if (recipientId.toString().substr(0,4) == 'chat' && this.linesSilentMode && this.linesSilentMode[recipientId.toString().substr(4)])
	{
		if (!this.message['temp'+messageTmpIndex].params)
		{
			this.message['temp'+messageTmpIndex].params = {};
		}
		this.message['temp'+messageTmpIndex].params.CLASS = "bx-messenger-content-item-system";
	}
	BX.MessengerCommon.drawMessage(recipientId, this.message['temp'+messageTmpIndex]);

	BX.MessengerCommon.sendMessageAjax(messageTmpIndex, recipientId, this.popupMessengerTextarea.value, recipientId.toString().substr(0,4) == 'chat');

	if (this.BXIM.settings.status != 'dnd')
	{
		this.BXIM.playSound("send");
	}

	this.textareaHistory[this.currentTab] = '';
	this.popupMessengerTextarea.value = '';
	this.textareaCheckText();

	setTimeout(BX.delegate(function(){
		this.popupMessengerTextarea.value = '';
		this.textareaCheckText();
	}, this), 0);

	return true;
};

BX.MessengerChat.prototype.textareaCheckText = function(params)
{
	params = params || {};
	params.textarea = params.textarea || 'default';

	var textarea = params.textarea == 'createChat'? this.popupCreateChatTextarea: this.popupMessengerTextarea;

	if (textarea.value.length > 0)
	{
		if (textarea.parentNode && textarea.parentNode.parentNode && textarea.parentNode.parentNode.className.indexOf('bx-messenger-textarea-with-text') == -1)
		{
			BX.addClass(textarea.parentNode.parentNode, 'bx-messenger-textarea-with-text');
		}
	}
	else
	{
		if (textarea.parentNode && textarea.parentNode.parentNode && textarea.parentNode.parentNode.className.indexOf('bx-messenger-textarea-with-text') >= 0)
		{
			BX.removeClass(textarea.parentNode.parentNode, 'bx-messenger-textarea-with-text');
		}
	}

	/*
	TODO: textarea auto resize
	if (textarea.offsetHeight != textarea.scrollHeight)
	{
		var textareaHeight = Math.max(Math.min(-(y-this.popupMessengerTextareaResize.pos.top) + this.popupMessengerTextareaResize.textOffset, 143), 30);

		this.popupMessengerTextareaSize = textareaHeight;
		this.popupMessengerTextarea.style.height = textareaHeight + 'px';
		this.popupMessengerBodySize = this.popupMessengerTextareaResize.textOffset-textareaHeight + this.popupMessengerTextareaResize.bodyOffset;
		this.popupMessengerBody.style.height = this.popupMessengerBodySize + 'px';
		this.popupMessengerBodyPanel.style.height = this.popupMessengerBodyDialog.offsetHeight + 'px';

		console.log('more text!!!');
	}
	*/
}

BX.MessengerChat.prototype.openCommandDialog = function()
{
	this.closeMenuPopup();

	var textarea =  this.popupMessengerTextarea;
	if (textarea.selectionStart == 0 || textarea.value.charCodeAt(textarea.selectionStart-1) == 10 || textarea.value.charCodeAt(textarea.selectionStart-1) == 13)
	{
		if (textarea.value.substr(-1) != "/")
		{
			this.insertTextareaText(textarea, "/");
		}
	}
	else
	{
		if (textarea.value.substr(-1) != "/")
		{
			this.insertTextareaText(textarea, "\n");
			this.insertTextareaText(textarea, "/");
		}
	}
	textarea.focus();

	this.textareaCommandListUpdate("");
}

BX.MessengerChat.prototype.textareaCommandListUpdate = function(command)
{
	if (this.currentTab == this.BXIM.userId)
	{
		return false;
	}

	if (command === false)
	{
		this.commandListen = false;
		this.commandSelect = '';
		this.commandSelectIndex = 1;
		if (this.commandPopup)
			this.commandPopup.close();
	}
	else
	{
		this.commandListen = true;
		this.commandList = BX.MessengerCommon.prepareCommandList(command);
		if (this.commandList.length > 0)
		{
			this.commandSelectIndex = 1;
			this.commandSelect = this.commandList[this.commandSelectIndex].command == '>>'? this.commandList[this.commandSelectIndex].command: this.commandList[this.commandSelectIndex].command.substr(1);

			var fistShow = false;
			if (!this.commandPopup)
			{
				this.commandPopup = new BX.PopupWindow('bx-messenger-command', this.popupMessengerTextareaPlace, {
					lightShadow : true,
					autoHide: true,
					offsetLeft: 5,
					bindOptions: {position: "top"},
					zIndex: 200,
					events : {
						onPopupClose : function() { this.destroy() },
						onPopupDestroy : BX.delegate(function() {
							if (this.commandPopup)
							{
								this.commandPopup = null;
								this.textareaCommandListUpdate(false);
							}
						}, this)
					},
					content: BX.create("div", { props : { className : "bx-messenger-command-popup "+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: [
						BX.create("div", { props : { className : "bx-messenger-command-popup-header"}, children: [
							BX.create("span", { props : { className : "bx-messenger-command-popup-title"}, html: BX.message('IM_COMMAND_TITLE')}),
							BX.create("span", { props : { className : "bx-messenger-command-popup-help"}, children: [
								BX.create("span", { props : { className : "bx-messenger-command-popup-help-item"}, html: BX.message('IM_COMMAND_H_1')}),
								BX.create("span", { props : { className : "bx-messenger-command-popup-help-item"}, html: BX.message('IM_COMMAND_H_2')}),
								BX.create("span", { props : { className : "bx-messenger-command-popup-help-item"}, html: BX.message('IM_COMMAND_H_3')})
							]})
						]}),
						this.commandPopupList = BX.create("div", { props : { className : "bx-messenger-command-popup-list"}, html: this.textareaCommandListItems()})
					]})
				});
				this.commandPopup.setAngle({offset: 5});
				fistShow = true;
			}
			if (fistShow)
			{
				this.commandPopup.show();
				BX.bindDelegate(this.commandPopupList, "click", {className: 'bx-messenger-command-popup-item'}, BX.delegate(function(){
					var id = BX.proxy_context.getAttribute('data-id');
					var command = '';
					for (var i = 0; i < this.command.length; i++)
					{
						if (this.command[i].id == id)
						{
							command = this.command[i].command.substr(1);
						}
					}
					this.commandSelect = command;
					this.textareaCommandClick()
				}, this));
				BX.bindDelegate(this.commandPopupList, "mouseover", {className: 'bx-messenger-command-popup-item'}, BX.delegate(function(){
					var id = BX.proxy_context.getAttribute('data-id');
					if (!id)
					{
						return true;
					}
					var command = '';
					for (var i = 0; i < this.command.length; i++)
					{
						if (this.command[i].id == id)
						{
							command = this.command[i].command.substr(1);
						}
					}
					this.commandSelectIndex = parseInt(BX.proxy_context.getAttribute('data-index'));
					this.commandSelect = command;

					var item = BX.findChildByClassName(this.commandPopupList, "bx-messenger-command-popup-item-selected");
					if (item)
					{
						BX.removeClass(item, "bx-messenger-command-popup-item-selected");
					}
					BX.addClass(BX.proxy_context, "bx-messenger-command-popup-item-selected");

					command = '/'+this.commandSelect;

					var textarea =  this.popupMessengerTextarea;
					var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/");
					var endOftextarea = textarea.value.substr(textarea.selectionStart);
					var startOftextarea = textarea.value.substr(0, selectionStart);
					textarea.value = startOftextarea+command+""+endOftextarea;
					textarea.selectionStart = selectionStart+command.length;
					textarea.selectionEnd = textarea.selectionStart;
				}, this));
			}
			else if (this.commandList.length > 0)
			{
				this.commandPopupList.innerHTML = this.textareaCommandListItems();
				this.commandPopup.adjustPosition({"forceBindPosition": true, position: "top"});
			}
		}
		else
		{
			this.commandSelectIndex = 0;
			this.commandSelect = command;

			if (this.commandPopup)
			{
				var commandPopup = this.commandPopup;
				this.commandPopup = null;
				commandPopup.close();
			}
		}
	}
}

BX.MessengerChat.prototype.textareaCommandListItems = function()
{
	var html = '';
	var firstSelected = false;
	for (var i = 0; i < this.commandList.length; i++)
	{
		if (this.commandList[i].type == 'category')
		{
			html += '<div class="bx-messenger-command-popup-item-category">'+this.commandList[i].title+'</div>';
		}
		else
		{
			html += '<div class="bx-messenger-command-popup-item bx-messenger-command-popup-item-'+i+' '+(this.commandSelectIndex == i? 'bx-messenger-command-popup-item-selected': '')+'" data-id="'+this.commandList[i].id+'" data-index="'+i+'">'+
						'<span class="bx-messenger-command-popup-item-text">'+
							'<span class="bx-messenger-command-popup-item-command">'+
								this.commandList[i].command+
							'</span>'+
							'<span class="bx-messenger-command-popup-item-params">'+
								this.commandList[i].params+
							'</span>'+
						'</span>'+
						'<span class="bx-messenger-command-popup-item-title">'+
							this.commandList[i].title+
						'</span>'+
					'</div>';
		}
	}
	return html;
}

BX.MessengerChat.prototype.textareaCommandClick = function()
{
	var command = '';
	if (this.commandSelect)
	{
		command = this.commandSelect == ">>"? ">> ": '/'+this.commandSelect+" ";
	}
	var textarea =  this.popupMessengerTextarea;
	var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/");
	var endOftextarea = textarea.value.substr(textarea.selectionStart);
	var startOftextarea = textarea.value.substr(0, selectionStart);
	textarea.value = startOftextarea+command+endOftextarea;

	textarea.selectionStart = selectionStart+command.length;
	textarea.selectionEnd = textarea.selectionStart;

	this.textareaCommandListUpdate(false);

	textarea.focus();
}

BX.MessengerChat.prototype.textareaCommandSelect = function(action)
{
	if (this.commandList.length <= 0 || this.commandList.length == 2)
	{
		return this.commandSelect;
	}

	if (action == 'up')
	{
		if (this.commandSelectIndex == 1)
		{
			this.commandSelectIndex = this.commandList.length-1;
		}
		else
		{
			this.commandSelectIndex -= 1;
			if (this.commandList[this.commandSelectIndex].type == 'category')
			{
				this.commandSelectIndex -= 1;
			}
		}
	}
	else
	{
		if (this.commandSelectIndex == this.commandList.length-1)
		{
			this.commandSelectIndex = 1;
		}
		else
		{
			this.commandSelectIndex += 1;
			if (this.commandList[this.commandSelectIndex].type == 'category')
			{
				this.commandSelectIndex += 1;
			}
		}
	}
	this.commandSelect = this.commandList[this.commandSelectIndex].command == '>>'? this.commandList[this.commandSelectIndex].command: this.commandList[this.commandSelectIndex].command.substr(1);

	var item = BX.findChildByClassName(this.commandPopupList, "bx-messenger-command-popup-item-selected");
	if (item)
	{
		BX.removeClass(item, "bx-messenger-command-popup-item-selected");
	}
	item = BX.findChildByClassName(this.commandPopupList, "bx-messenger-command-popup-item-"+this.commandSelectIndex);
	if (item)
	{
		BX.addClass(item, "bx-messenger-command-popup-item-selected");
		var itemVisible = BX.MessengerCommon.isElementVisibleOnScreen(item, this.commandPopupList, true);
		if (!itemVisible.top || !itemVisible.bottom)
		{
			var finish = 0;
			if (this.commandSelectIndex == this.commandList.length-1)
			{
				finish = this.commandPopupList.scrollHeight;
			}
			else if (this.commandSelectIndex > 1)
			{
				if (action == 'up')
				{
					finish = this.commandPopupList.scrollTop - (itemVisible.coords.top * -1);
				}
				else
				{
					finish = this.commandPopupList.scrollTop + itemVisible.coords.top - this.commandPopupList.offsetHeight + item.offsetHeight;
				}
			}

			if (this.commandPopupListAnimation != null)
			{
				this.commandPopupListAnimation.stop();
			}
			(this.commandPopupListAnimation = new BX.easing({
				duration : 400,
				start : { scroll : this.commandPopupList.scrollTop },
				finish : { scroll : finish},
				transition : BX.easing.makeEaseInOut(BX.easing.transitions.quart),
				step : BX.delegate(function(state){
					this.commandPopupList.scrollTop = state.scroll;
				}, this)
			})).animate();
		}
	}

	return this.commandSelect;
}

BX.MessengerChat.prototype.textareaPrepareText = function(textarea, e, sendCommand, closeCommand)
{
	var result = true;

	if (this.commandListen)
	{
		if (e.altKey == true || e.ctrlKey == true || e.metaKey == true)
		{
			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 8)
		{
			var previousText = textarea.value.substr(textarea.selectionStart-1, 1);
			if (previousText == '/')
			{
				this.textareaCommandListUpdate(false)
			}
			else
			{
				setTimeout(BX.delegate(function(){
					var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/")+1;
					var command = textarea.value.substr(
						selectionStart,
						textarea.selectionStart-selectionStart
					);
					this.textareaCommandListUpdate(command);
				},this), 10);
			}
		}
		else if (e.keyCode == 27)
		{
			this.commandListen = false;

			var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/");

			var endOftextarea = textarea.value.substr(textarea.selectionStart);
			var startOftextarea = textarea.value.substr(0, selectionStart+1);
			textarea.value = startOftextarea+endOftextarea;

			textarea.selectionStart = selectionStart+1;
			textarea.selectionEnd = textarea.selectionStart;

			this.textareaCommandListUpdate(false);
			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 9)
		{
			this.textareaCommandSelect('down');

			command = '/'+this.commandSelect;

			var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/");

			var endOftextarea = textarea.value.substr(textarea.selectionStart);
			var startOftextarea = textarea.value.substr(0, selectionStart);
			textarea.value = startOftextarea+command+""+endOftextarea;

			textarea.selectionStart = selectionStart+command.length;
			textarea.selectionEnd = textarea.selectionStart;

			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 39 || e.keyCode == 37)
		{
			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 38 || e.keyCode == 40)
		{
			if (e.keyCode == 38)
			{
				this.textareaCommandSelect('up');
			}
			else if (e.keyCode == 40)
			{
				this.textareaCommandSelect('down');
			}

			command = '/'+this.commandSelect;

			var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/");


			var endOftextarea = textarea.value.substr(textarea.selectionStart);
			var startOftextarea = textarea.value.substr(0, selectionStart);
			textarea.value = startOftextarea+command+endOftextarea;

			textarea.selectionStart = selectionStart+command.length;
			textarea.selectionEnd = textarea.selectionStart;

			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 13 || e.keyCode == 32)
		{
			this.textareaCommandClick();
			return BX.PreventDefault(e);
		}
		else
		{
			setTimeout(BX.delegate(function(){
				var selectionStart = textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/")+1;
				var command = textarea.value.substr(
					textarea.value.substr(0, textarea.selectionStart).lastIndexOf("/")+1,
					textarea.selectionStart-selectionStart
				);
				this.textareaCommandListUpdate(command);
			},this), 10);
		}
	}
	else if (this.mentionListen)
	{
		if (e.keyCode == 27)
		{
			this.mentionListen = false;
			this.mentionDelimiter = '';
			return BX.PreventDefault(e);
		}
		else if (e.keyCode == 13)
		{
			this.popupContactListSearchInput.value = '';
			var item = BX.findChildByClassName(this.popupChatDialogContactListElements, "bx-messenger-cl-item");
			if (item)
			{
				item.getAttribute('data-userId')
				var replaceText = textarea.value.substr(0, textarea.selectionEnd);
				replaceText = replaceText.substr(replaceText.lastIndexOf(this.mentionDelimiter), textarea.selectionEnd-replaceText.lastIndexOf(this.mentionDelimiter));

				textarea.value = textarea.value.replace(replaceText, item.getAttribute('data-name')+' ');
				BX.MessengerCommon.addMentionList(this.currentTab, item.getAttribute('data-name'), item.getAttribute('data-userId'));

				this.popupChatDialog.close();
			}

			return BX.PreventDefault(e);
		}
		else
		{
			setTimeout(BX.delegate(function(){
				var replaceText = textarea.value.substr(0, textarea.selectionEnd);

				var firstIndex = replaceText.lastIndexOf(this.mentionDelimiter);
				var lastIndex = textarea.selectionEnd-replaceText.lastIndexOf(this.mentionDelimiter);
				replaceText = replaceText.substr(firstIndex, lastIndex);
				if (replaceText.length <= 0 || firstIndex < 0)
				{
					if (this.popupChatDialog)
						this.popupChatDialog.close();
					return false;
				}
				replaceText = replaceText.substr(1);
				if (replaceText.substr(0, 1) == ' ')
				{
					if (this.popupChatDialog)
						this.popupChatDialog.close();
					return false;
				}
				else if (replaceText.length <= 3 && replaceText.substr(0, 1).substr(0,1).match(/\d$/))
				{
					if (this.popupChatDialog)
						this.popupChatDialog.close();
					return false;
				}

				this.popupChatDialogContactListSearch.value = replaceText;
				BX.MessengerCommon.contactListPrepareSearch('popupChatDialogContactListElements', this.popupChatDialogContactListElements, this.popupChatDialogContactListSearch.value, {
					'viewOffline': true,
					'viewChat': false,
					'viewOpenChat': true,
					'exceptUsers': [],
					'timeout': 100,
					'callback': {
						'empty': BX.delegate(function(){
							this.popupChatDialog.close();
							return false;
						}, this)
					}
				});
			},this), 10)
		}
	}
	else if (e.altKey == true && e.ctrlKey == true)
	{
	}
	else if ((e.shiftKey == true  && (e.keyCode == 61 || e.keyCode == 50 || e.keyCode == 187 || e.keyCode == 187)) || e.keyCode == 107)
	{
		var blocked = (this.BXIM.messenger.openChatFlag && this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)] && this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type == "livechat");
		if (!this.mentionListen && !blocked)
		{
			setTimeout(BX.delegate(function(){
				var delimiter = textarea.value.substr(textarea.selectionEnd-1, 1);
				if (!(delimiter == "@" || delimiter == "+"))
					return false;

				this.mentionListen = true;
				this.mentionDelimiter = delimiter;
				this.openChatDialog({'type': 'MENTION', 'bind': textarea, 'focus': false, 'delimiter': delimiter})

				this.setClosingByEsc(false);
			},this), 300)
		}
	}
	else if (e.metaKey == true || e.ctrlKey == true)
	{
		var tagReplace = {66: 'b', 83: 's', 73: 'i', 85: 'u'};
		if (tagReplace[e.keyCode] || e.keyCode == 84 || !BX.MessengerCommon.isDesktop() && BX.browser.IsChrome() && e.keyCode == 69)
		{
			var selectionStart = textarea.selectionStart;
			var selectionEnd = textarea.selectionEnd;

			resultText = textarea.value.substring(selectionStart, selectionEnd);
			if (e.keyCode == 84 || !BX.MessengerCommon.isDesktop() && BX.browser.IsChrome() && e.keyCode == 69)
			{
				if (selectionStart == selectionEnd)
				{
					selectionStart = 0;
					selectionEnd = textarea.value.length;
					resultText = textarea.value;
				}
				textarea.value = textarea.value.substring(0, selectionStart)+BX.correctText(resultText, {replace_way: 'AUTO', mixed:true})+textarea.value.substring(selectionEnd, textarea.value.length);
				textarea.selectionStart = selectionStart;
				textarea.selectionEnd = selectionEnd;
			}
			else
			{
				if (selectionStart == selectionEnd)
				{
					return BX.PreventDefault(e);
				}
				resultTagStart = textarea.value.substring(selectionStart, selectionStart+3);
				resultTagEnd = textarea.value.substring(selectionEnd-4, selectionEnd);

				if (resultTagStart.toLowerCase() == '['+tagReplace[e.keyCode]+']' && resultTagEnd.toLowerCase() == '[/'+tagReplace[e.keyCode]+']')
				{
					textarea.value = textarea.value.substring(0, selectionStart)+textarea.value.substring(selectionStart+3, selectionEnd-4)+textarea.value.substring(selectionEnd, textarea.value.length)
					textarea.selectionStart = selectionStart;
					textarea.selectionEnd = selectionEnd-7;
				}
				else
				{
					textarea.value = textarea.value.substring(0, selectionStart)+'['+tagReplace[e.keyCode]+']'+resultText+'[/'+tagReplace[e.keyCode]+']'+textarea.value.substring(selectionEnd, textarea.value.length);
					textarea.selectionStart = selectionStart;
					textarea.selectionEnd = selectionEnd+7;
				}
			}
			return BX.PreventDefault(e);
		}
	}
	else if ((e.keyCode == 191 || e.keyCode == 111 || e.keyCode == 220) && textarea == this.popupMessengerTextarea)
	{
		if (textarea.selectionStart == 0 || textarea.value.charCodeAt(textarea.selectionStart-1) == 10 || textarea.value.charCodeAt(textarea.selectionStart-1) == 13)
		{
			setTimeout(BX.delegate(function(){
				var delimiter = textarea.value.substr(textarea.selectionEnd-1, 1);
				if (delimiter == '/')
				{
					this.textareaCommandListUpdate("");
				}
			},this), 300)
		}
	}
	if (e.keyCode == 9)
	{
		this.insertTextareaText(textarea, "\t");
		return BX.PreventDefault(e);
	}
	if (e.keyCode == 27 && !BX.MessengerCommon.isDesktop())
	{
		if (e.shiftKey)
		{
			closeCommand();
		}
		else if (textarea == this.popupCreateChatTextarea)
		{
			if (this.popupCreateChatTextarea.value == "")
			{
				closeCommand();
			}
			else
			{
				return BX.PreventDefault(e);
			}
		}
		else if (textarea != this.popupMessengerTextarea || this.popupMessengerTextarea.value == "")
		{
			closeCommand();
		}
	}
	else if (e.keyCode == 38 && this.popupMessengerLastMessage > 0 && BX.util.trim(textarea.value).length <= 0)
	{
		this.editMessage(this.popupMessengerLastMessage);
	}
	else if (this.BXIM.settings.sendByEnter == true && (e.ctrlKey == true || e.altKey == true) && e.keyCode == 13)
		this.insertTextareaText(textarea, "\n");
	else if (this.BXIM.settings.sendByEnter == true && e.shiftKey == false && e.keyCode == 13)
		result = sendCommand();
	else if (this.BXIM.settings.sendByEnter == false && e.ctrlKey == true && e.keyCode == 13)
		result = sendCommand();
	else if (this.BXIM.settings.sendByEnter == false && (e.metaKey == true || e.altKey == true) && e.keyCode == 13 && BX.browser.IsMac())
		result = sendCommand();

	clearTimeout(this.textareaHistoryTimeout);
	this.textareaHistoryTimeout = setTimeout(BX.delegate(function(){
		this.textareaHistory[this.currentTab] = this.popupMessengerTextarea.value;
	}, this), 200);

	if (BX.util.trim(textarea.value).length > 2)
		BX.MessengerCommon.sendWriting(this.currentTab);

	if (!result)
		return BX.PreventDefault(e);
}

BX.MessengerChat.prototype.openAnswersMenu = function(params)
{
	this.BXIM.openConfirm(BX.message('IM_OL_ANSWERS_SOON'), [
		new BX.PopupWindowButton({
			text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
			className : "popup-window-button-decline",
			events : { click : function() { this.popupWindow.close(); } }
		})
	], true);
}
BX.MessengerChat.prototype.openFormsMenu = function(params)
{
	this.BXIM.openConfirm(BX.message('IM_OL_FORMS_SOON'), [
		new BX.PopupWindowButton({
			text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
			className : "popup-window-button-decline",
			events : { click : function() { this.popupWindow.close(); } }
		})
	], true);
}

BX.MessengerChat.prototype.addRecentSmile = function(text, icon)
{
	icon = icon || '';
	if (BX.MessengerCommon.isDesktop() && BX.browser.IsMac() && !this.desktop.enableInVersion(36))
		return false;

	var foundIcons = text.match(/\[icon\=([^\]]*)\]/ig);
	var saveNew = false;
	if (foundIcons && foundIcons.length)
	{
		var currentRecent = [];
		var smilesRecent = this.BXIM.getLocalConfig('smiles-recent', []) || [];
		for (var i = 0; i < smilesRecent.length; i++)
		{
			currentRecent.push(smilesRecent[i].IMAGE);
		}
		for (var i = 0; i < foundIcons.length; i++)
		{
			var whole = foundIcons[i];
			var url = whole.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);
			if (url && url[1])
			{
				url = url[1];
				if (currentRecent && currentRecent.indexOf(url) > -1 || url.match(/^(\d+)$/))
				{
					continue;
				}
			}
			else
			{
				continue;
			}

			if (icon && icon.indexOf(url) < 0)
			{
				continue;
			}

			saveNew = true;

			var attrs = {'IMAGE': url, 'HEIGHT': 20, 'WIDTH': 20, 'NAME': ''};

			var size = whole.match(/size\=(\d+)/i);
			if (size && size[1])
			{
				attrs['WIDTH'] = size[1];
				attrs['HEIGHT'] = size[1];
			}
			else
			{
				var width = whole.match(/width\=(\d+)/i);
				if (width && width[1])
				{
					attrs['WIDTH'] = width[1];
				}

				var height = whole.match(/height\=(\d+)/i);
				if (height && height[1])
				{
					attrs['HEIGHT'] = height[1];
				}

				if (attrs['WIDTH'] && !attrs['HEIGHT'])
				{
					attrs['HEIGHT'] = attrs['WIDTH'];
				}
				else if (attrs['HEIGHT'] && !attrs['WIDTH'])
				{
					attrs['WIDTH'] = attrs['HEIGHT'];
				}
				else
				{
					attrs['WIDTH'] = 20;
					attrs['HEIGHT'] = 20;
				}
			}

			var title = whole.match(/title\=(.*[^\s\]])/i);
			if (title && title[1])
			{
				title = title[1];
				if (title.indexOf('width=') > -1)
				{
					title = title.substr(0, title.indexOf('width='))
				}
				if (title.indexOf('height=') > -1)
				{
					title = title.substr(0, title.indexOf('height='))
				}
				if (title.indexOf('size=') > -1)
				{
					title = title.substr(0, title.indexOf('size='))
				}
				if (title)
				{
					title = BX.util.trim(title);
					attrs['NAME'] = title;
				}
			}
			smilesRecent.push(attrs);
			this.injectRecentSmile(attrs);
		}
		if (saveNew)
		{
			this.BXIM.setLocalConfig('smiles-recent', smilesRecent, 2600000);
		}
	}

	return foundIcons? foundIcons.length: 0;
}

BX.MessengerChat.prototype.removeRecentSmile = function(id)
{
	if (BX.MessengerCommon.isDesktop() && BX.browser.IsMac() && !this.desktop.enableInVersion(36))
		return false;

	var deleteImage = '';
	if (this.smile[id])
	{
		deleteImage = this.smile[id].IMAGE;
	}

	if (deleteImage)
	{
		var currentRecent = [];
		var smilesRecent = this.BXIM.getLocalConfig('smiles-recent', []) || [];
		for (var i = 0; i < smilesRecent.length; i++)
		{
			if (deleteImage != smilesRecent[i].IMAGE)
			{
				currentRecent.push(smilesRecent[i]);
			}
		}
		this.BXIM.setLocalConfig('smiles-recent', currentRecent, 2600000);

		delete this.smile[id];
	}

	return true
}

BX.MessengerChat.prototype.getRecentSmiles = function()
{
	if (BX.MessengerCommon.isDesktop() && BX.browser.IsMac() && !this.desktop.enableInVersion(36))
		return false;

	if (!this.smileSet)
		return false;

	this.smileSet.push({
		'ID': 'icons',
		'NAME': BX.message('IM_ICON_SET'),
		'PARENT_ID': 0,
		'TYPE': 'G'
	});

	var smilesRecent = this.BXIM.getLocalConfig('smiles-recent', []) || [];
	if (smilesRecent.length <= 0)
	{
		return true;
	}

	this.smileRecentId = smilesRecent.length+1;
	for (var i = 0; i < smilesRecent.length; i++)
	{
		this.injectRecentSmile(smilesRecent[i]);
	}
}
BX.MessengerChat.prototype.injectRecentSmile = function(params)
{
	var smile = BX.clone(params);
	if (typeof(smile) != 'object')
		return false;

	smile.TITLE = smile.NAME;
	if (!smile.TITLE)
	{
		smile.TITLE = smile.IMAGE.substring(smile.IMAGE.lastIndexOf('/')+1);
		smile.TITLE = smile.TITLE.substring(0, smile.TITLE.lastIndexOf('.'));
	}
	this.smile['icon'+this.smileRecentId] = {
		'NAME': smile.NAME,
		'HEIGHT': smile.HEIGHT>100? 100: smile.HEIGHT,
		'WIDTH': smile.WIDTH>100? 100: smile.WIDTH,
		'IMAGE': smile.IMAGE,
		'TYPING': '[icon='+this.smileRecentId+' title='+smile.TITLE+']',
		'SET_ID': 'icons'
	};
	this.smileRecentId++;
}


BX.MessengerChat.prototype.openSmileMenu = function(params)
{
	params = params || {};
	params.textarea = params.textarea || 'default';
	params.bind = params.bind || this.popupMessengerSmileButton;

	this.closePopupFileMenu();

	if (this.popupPopupMenu != null)
		this.popupPopupMenu.destroy();

	if (this.popupChatDialog != null)
	{
		this.popupChatDialog.destroy();
	}
	if (this.popupSmileMenu != null)
	{
		this.popupSmileMenu.destroy();
	}
	if (this.commandPopup != null)
	{
		this.commandPopup.destroy();
	}
	if (this.popupIframeMenu != null && this.popupIframeBind)
	{
		this.popupIframeMenu.destroy();
	}

	if (this.smile == false)
	{
		this.tooltip(this.popupMessengerSmileButton, BX.message('IM_SMILE_NA'), {offsetLeft: -20});
		return false;
	}

	var arGalleryItem = {};
	for (var id in this.smile)
	{
		if (!arGalleryItem[this.smile[id].SET_ID])
			arGalleryItem[this.smile[id].SET_ID] = [];

		var typing = BX.util.htmlspecialcharsback(this.smile[id].TYPING);

		arGalleryItem[this.smile[id].SET_ID].push(
			BX.create("img", { props : { className : 'bx-messenger-smile-gallery-image'}, attrs : { 'data-id': id, 'data-code': typing, 'data-textarea': params.textarea,  style: "width: "+this.smile[id].WIDTH+"px; height: "+this.smile[id].HEIGHT+"px", src : this.smile[id].IMAGE, alt : this.smile[id].TYPING, title : BX.util.htmlspecialcharsback(this.smile[id].NAME)}})
		);
	}

	var setCount = 0;
	var arGallery = [];
	var arSet = [
		BX.create("span", { props : { className : "bx-messenger-smile-nav-name" }, html: BX.message('IM_SMILE_SET')})
	];

	if (!this.smileSet[this.smileCurrentSet] || typeof(arGalleryItem[this.smileSet[this.smileCurrentSet]['ID']]) == 'undefined')
	{
		this.smileCurrentSet = 0;
	}

	var id = 0;
	var name = '';
	for (var i = 0; i < this.smileSet.length; i++)
	{
		if (typeof(arGalleryItem[this.smileSet[i]['ID']]) == 'undefined')
			continue;

		id = this.smileSet[i]['ID'];
		name = this.smileSet[i]['NAME'];

		arGallery.push(
			BX.create("span", { attrs : { 'data-set-id': id }, props : { className : "bx-messenger-smile-gallery-set"+(setCount != this.smileCurrentSet? ' bx-messenger-smile-gallery-set-hide': '') }, children: arGalleryItem[id]})
		);
		arSet.push(
			BX.create("span", { attrs : { 'data-set-id': id, title : BX.util.htmlspecialcharsback(name) }, props : { className : "bx-messenger-smile-nav-item"+(setCount == this.smileCurrentSet? ' bx-messenger-smile-nav-item-active': '')}})
		);
		setCount++;
	}

	this.popupSmileMenu = new BX.PopupWindow('bx-messenger-popup-smile', params.bind, {
		//parentPopup: this.popupMessenger,
		lightShadow : false,
		offsetTop: 0,
		offsetLeft: -38,
		autoHide: true,
		closeByEsc: true,
		bindOptions: {position: "top"},
		zIndex: 200,
		events : {
			onPopupClose : function() { this.destroy() },
			onPopupDestroy : BX.delegate(function() { this.popupSmileMenu = null; }, this)
		},
		content : BX.create("div", { props : { className : "bx-messenger-smile"+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: [
			this.popupSmileMenuGallery = BX.create("div", { props : { className : "bx-messenger-smile-gallery" }, children: arGallery}),
			this.popupSmileMenuSet = BX.create("div", { props : { className : "bx-messenger-smile-nav"+(setCount <= 1? " bx-messenger-smile-nav-disabled": "")}, children: arSet})
		]})
	});
	this.popupSmileMenu.setAngle({offset: 74});
	this.popupSmileMenu.show();

	BX.bindDelegate(this.popupSmileMenuGallery, "click", {className: 'bx-messenger-smile-gallery-image'}, BX.delegate(function(){
		var textarea = BX.proxy_context.getAttribute('data-textarea') == 'createChat'? this.popupCreateChatTextarea: this.popupMessengerTextarea;
		this.insertTextareaText(textarea, ' '+BX.proxy_context.getAttribute('data-code')+' ', false);
		this.popupSmileMenu.close();
		textarea.focus();
	}, this));

	BX.bindDelegate(this.popupSmileMenuGallery, "contextmenu", {className: 'bx-messenger-smile-gallery-image'}, BX.delegate(function(e){
		var foundIcons = BX.proxy_context.getAttribute('data-code').match(/\[icon\=([^\]]*)\]/ig);
		if (foundIcons)
		{
			this.openPopupMenu(BX.proxy_context, 'iconMenu', true, {closeSmiles: false});
			return BX.PreventDefault(e);
		}
	}, this));

	BX.bindDelegate(this.popupSmileMenuSet, "click", {className: 'bx-messenger-smile-nav-item'}, BX.delegate(function(){
		if (BX.hasClass(BX.proxy_context, 'bx-messenger-smile-nav-item-active'))
			return false;

		var nodesGallery = BX.findChildrenByClassName(this.popupSmileMenuGallery, "bx-messenger-smile-gallery-set", false);
		var nodesSet = BX.findChildrenByClassName(this.popupSmileMenuSet, "bx-messenger-smile-nav-item", false);
		for (var i = 0; i < nodesSet.length; i++)
		{
			if (BX.proxy_context == nodesSet[i])
			{
				BX.removeClass(nodesGallery[i], 'bx-messenger-smile-gallery-set-hide');
				BX.addClass(nodesSet[i], 'bx-messenger-smile-nav-item-active');
				this.smileCurrentSet = i;
				this.BXIM.setLocalConfig('smiles-current-set', i);
			}
			else
			{
				BX.addClass(nodesGallery[i], 'bx-messenger-smile-gallery-set-hide');
				BX.removeClass(nodesSet[i], 'bx-messenger-smile-nav-item-active');
			}
		}
	}, this));

	BX.onCustomEvent('onImOpenSmileMenu', []);

	return false;
};

BX.MessengerChat.prototype.textareaIconToggle = function()
{
	if (!this.popupMessengerPanelBotIcons)
	{
		return true;
	}

	var elements = BX.findChildrenByClassName(this.popupMessengerTextareaIconBox, "bx-messenger-textarea-icon-bot", true);
	if (!elements)
	{
		this.popupMessengerPanelBotIcons = false;
		return false;
	}

	for (var i = 0; i < elements.length; i++)
	{
		BX.removeClass(elements[i], 'bx-messenger-textarea-icon-bot-show');
	}

	this.popupMessengerPanelBotIcons = false;

	if (this.openBotFlag)
	{
		var elements = BX.findChildrenByClassName(this.popupMessengerTextareaIconBox, "bx-messenger-textarea-icon-bot-"+this.currentTab, true);
		if (elements)
		{
			for (var i = 0; i < elements.length; i++)
			{
				BX.addClass(elements[i], 'bx-messenger-textarea-icon-bot-show');
			}
			this.popupMessengerPanelBotIcons = true;
		}
	}

	return true;
}

BX.MessengerChat.prototype.textareaIconCheckContext = function(context)
{
	// context: all, chat, bot, lines, user, call ( postfix - admin)
	var isAdmin = context.substr(-6) == '-admin';
	if (isAdmin && !this.BXIM.isAdmin)
	{
		return false;
	}
	if (isAdmin)
	{
		context = context.substr(0, context.length-6);
	}

	if (context == 'chat')
	{
		if (!this.openChatFlag)
		{
			return false;
		}
	}
	else if (context == 'bot')
	{
		if (!this.openBotFlag)
		{
			return false;
		}
	}
	else if (context == 'lines')
	{
		if (!this.openLinesFlag)
		{
			return false;
		}
	}
	else if (context == 'call')
	{
		if (!this.openCallFlag)
		{
			return false;
		}
	}
	else if (context == 'user')
	{
		if (this.openCallFlag || this.openChatFlag || this.openLinesFlag)
		{
			return false;
		}
	}

	return true;
}

BX.MessengerChat.prototype.textareaIconPrepare = function()
{
	if (!this.popupMessengerTextareaIconBox)
		return false;

	this.popupMessengerTextareaIconBox.innerHTML = '';

	if (!this.textareaIcon.length)
	{
		return false;
	}

	var textareaIcon = null;

	var textareaApps = [];
	var textareaAppsClass = [];
	for (var i = 0; i < this.textareaIcon.length; i++)
	{
		if (!this.textareaIcon[i] || this.textareaIcon[i].hidden)
		{
			continue;
		}

		if (this.desktop.ready() && !this.desktop.enableInVersion(39) && this.textareaIcon[i]['iframe'])
		{
			if (BXDesktopSystem.GetProperty('versionParts').join('.') != '5.0.32.38') // TODO remove this
			{
				continue;
			}
		}

		var title = this.textareaIcon[i]['description']? this.textareaIcon[i]['description']: this.textareaIcon[i]['title'];

		if (!this.textareaIcon[i]['title'] && !this.textareaIcon[i]['url'])
		{
			continue;
		}

		var textareaIconClass = "bx-messenger-textarea-icon-marketplace-"+this.textareaIcon[i]['id']+" bx-messenger-textarea-icon-context-"+this.textareaIcon[i]['context']+(this.textareaIcon[i]['context'] == 'bot' || this.textareaIcon[i]['context'] == 'bot-admin'? ' bx-messenger-textarea-icon-bot bx-messenger-textarea-icon-bot-'+this.textareaIcon[i]['botId']: '');

		if (!this.textareaIcon[i]['url'])
		{
			textareaApps.push(this.textareaIcon[i]);
			textareaAppsClass.push(textareaIconClass);
			continue;
		}

		textareaIcon = BX.create("div", {
			props : { className : "bx-messenger-textarea-icon-marketplace "+textareaIconClass},
			attrs : { title: title, style: "background-image: url('"+this.textareaIcon[i]['url']+"')", "data-context": this.textareaIcon[i]['context'], "data-code": this.textareaIcon[i]['code'], "data-id": this.textareaIcon[i]['id'] },
			events : { click : BX.delegate(this.textareaIconClick, this)}
		});
		this.popupMessengerTextareaIconBox.appendChild(textareaIcon);
	}
	if (textareaApps.length)
	{
		this.popupMessengerTextareaIconApps = BX.create("div", {
			props : { className : "bx-messenger-textarea-icon-marketplace bx-messenger-textarea-icon-marketplace-default "+textareaAppsClass.join(" ")},
			attrs : { title: BX.message('IM_APPS_LIST') },
			events : { click : BX.delegate(function(e){
				this.openPopupMenu(BX.proxy_context, 'textareaAppsMenu');
			}, this)}
		});
		this.popupMessengerTextareaIconBox.appendChild(this.popupMessengerTextareaIconApps);
	}

	return true;
}

BX.MessengerChat.prototype.textareaIconDialogClick = function(id, messageId, params)
{
	params = params || {};

	var icon = null;
	for (var i = 0; i < this.textareaIcon.length; i++)
	{
		if (!this.textareaIcon[i] || this.textareaIcon[i].id != id)
		{
			continue;
		}

		icon = this.textareaIcon[i];
		break;
	}

	if (!icon && !params.___ajaxSkip)
	{
		BX.ajax({
			url: this.BXIM.pathToAjax+'?GET_TEXTAREA_ICONS&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 60,
			data: {'IM_GET_TEXTAREA_ICONS': 'Y', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(data){
				this.textareaIcon = data.TEXTAREA_ICON? data.TEXTAREA_ICON: [];
				this.textareaIconPrepare();

				params.___ajaxSkip = true;
				this.textareaIconDialogClick(id, messageId, params)
			}, this)
		});

		return false;
	}

	delete params.___ajaxSkip;

	if (this.textareaIconCheckContext(icon.context))
	{
		if (icon.iframe)
		{
			var dialogContext = 'user';
			var dialogEntityId = '';
			var dialogEntityData1 = '';
			if (this.currentTab.toString().substr(0,4) == 'chat')
			{
				dialogContext = this.chat[this.currentTab.substr(4)].entity_type.toLowerCase();
				dialogEntityId = this.chat[this.currentTab.substr(4)].entity_id;
				dialogEntityData1 = this.chat[this.currentTab.substr(4)].entity_data_1;
			}
			this.openFrameDialog({
				'bind': null,
				'title': icon.title,
				'copyright': icon.copyright,
				'iframe': {src: icon.iframe, width: icon.iframeWidth, height: icon.iframeHeight, popup: true},
				'params': {
					BOT_ID: icon.botId,
					BOT_CODE: icon.botCode,
					APP_ID: icon.id,
					APP_CODE: icon.code,
					DOMAIN: location.origin,
					DOMAIN_HASH: icon.domainHash,
					USER_ID: this.BXIM.userId,
					USER_HASH: icon.userHash,
					DIALOG_ID: this.currentTab,
					DIALOG_CONTEXT: dialogContext,
					DIALOG_ENTITY_ID: dialogEntityId,
					DIALOG_ENTITY_DATA_1: dialogEntityData1,
					LANG: BX.message.LANGUAGE_ID,
					IS_CHROME: BX.browser.IsChrome()? 'Y': 'N',
					CONTEXT: 'button',
					MESSAGE_ID: messageId,
					BUTTON_PARAMS: params
				}
			});
		}
		else if (icon.js)
		{
			var button = BX.proxy_context;
			eval(icon.js);
		}
	}
}

BX.MessengerChat.prototype.textareaIconClick = function(event)
{
	if (this.popupPopupMenu != null)
	{
		this.popupPopupMenu.destroy();
	}

	var icon = null;
	for (var i = 0; i < this.textareaIcon.length; i++)
	{
		if (!this.textareaIcon[i] || this.textareaIcon[i].id != BX.proxy_context.getAttribute('data-id') || this.textareaIcon[i].hidden)
		{
			continue;
		}

		icon = this.textareaIcon[i];
		break;
	}
	if (!icon)
	{
		return false;
	}

	if (this.textareaIconCheckContext(icon.context))
	{
		if (icon.iframe)
		{
			var dialogContext = 'user';
			var dialogEntityId = '';
			var dialogEntityData1 = '';
			if (this.currentTab.toString().substr(0,4) == 'chat')
			{
				dialogContext = this.chat[this.currentTab.substr(4)].entity_type.toLowerCase();
				dialogEntityId = this.chat[this.currentTab.substr(4)].entity_id;
				dialogEntityData1 = this.chat[this.currentTab.substr(4)].entity_data_1;;
			}

			this.openFrameDialog({
				'bind': event? BX.proxy_context: this.popupMessengerTextareaIconApps,
				'title': icon.title,
				'copyright': icon.copyright,
				'iframe': {src: icon.iframe, width: icon.iframeWidth, height: icon.iframeHeight, popup: icon.iframePopup},
				'params': {
					BOT_ID: icon.botId,
					BOT_CODE: icon.botCode,
					APP_ID: icon.id,
					APP_CODE: icon.code,
					DOMAIN: location.origin,
					DOMAIN_HASH: icon.domainHash,
					USER_ID: this.BXIM.userId,
					USER_HASH: icon.userHash,
					DIALOG_ID: this.currentTab,
					DIALOG_CONTEXT: dialogContext,
					DIALOG_ENTITY_ID: dialogEntityId,
					DIALOG_ENTITY_DATA_1: dialogEntityData1,
					LANG: BX.message.LANGUAGE_ID,
					IS_CHROME: BX.browser.IsChrome()? 'Y': 'N',
					CONTEXT: 'textarea'
				}
			});
		}
		else if (icon.js)
		{
			var button = BX.proxy_context;
			eval(icon.js);
		}
	}

	return event? BX.PreventDefault(event): true;
}

BX.MessengerChat.prototype.openFrameDialog = function(params)
{
	params = params || {};

	if (params.iframe && params.iframe.popup)
	{
		params.bind = null;
	}
	else
	{
		params.bind = params.bind || null;
	}

	this.closePopupFileMenu();

	if (this.popupPopupMenu != null)
	{
		this.popupPopupMenu.destroy();
	}
	if (this.popupChatDialog != null)
	{
		this.popupChatDialog.destroy();
	}
	if (this.popupSmileMenu != null)
	{
		this.popupSmileMenu.destroy();
	}
	if (this.commandPopup != null)
	{
		this.commandPopup.destroy();
	}
	if (this.popupIframeMenu != null)
	{
		this.popupIframeMenu.destroy();
	}

	this.openFrameDialogBid = params.params.BOT_ID;
	this.openFrameDialogDid = this.currentTab;

	if (this.sendFrameTokenCollection[this.openFrameDialogBid])
	{
		if (this.sendFrameTokenCollection[this.openFrameDialogBid]+(this.sendFrameTokenTimeout*1000) < +new Date())
		{
			this.sendFrameToken(this.openFrameDialogBid, this.openFrameDialogDid);
		}
	}
	else
	{
		this.sendFrameToken(this.openFrameDialogBid, this.openFrameDialogDid);
	}

	var iframeUrl = '';
	for (var i in params.params)
	{
		iframeUrl = iframeUrl+i+'='+encodeURIComponent(params.params[i])+'&'
	}
	iframeUrl = params.iframe.src+iframeUrl;

	params.iframe.height = parseInt(params.iframe.height);
	if (params.iframe.height > this.popupMessengerBody.offsetHeight)
	{
		params.iframe.height = this.popupMessengerBody.offsetHeight;
	}

	this.popupIframeBind = !!params.bind;

	this.popupIframeMenu = new BX.PopupWindow('bx-messenger-iframe', params.bind, {
		//parentPopup: this.popupMessenger,
		lightShadow : false,
		offsetTop: 0,
		offsetLeft: -38,
		autoHide: this.popupIframeBind,
		closeByEsc: true,
		bindOptions: {position: "top"},
		closeIcon : params.bind? null: {'right': '13px'},
		draggable : params.bind? null: {'restrict': true},
		zIndex: 200,
		events : {
			onPopupClose : function() { this.destroy() },
			onPopupDestroy : BX.delegate(function() {
				this.openFrameDialogBid = null;
				this.openFrameDialogDid = null;
				this.popupIframeMenu = null;
				this.popupIframeBind =  true;
				this.openFrameDialogFrame = null;
				this.openFrameDialogFrameSourceDomain = null;
			}, this)
		},
		content: BX.create("div", { props : { className : "bx-messenger-iframe-title-box"}, children: [
			this.openFrameDialogTitle = BX.create("div", { props : { className : "bx-messenger-command-popup-header"}, children: [
				BX.create("span", { props : { className : "bx-messenger-command-popup-title"}, text: params.title}),
				BX.create("span", { props : { className : "bx-messenger-command-popup-help"}, children: [
					BX.create("span", { props : { className : "bx-messenger-command-popup-help-item"}, text: params.copyright})
				]})
			]}),
			this.openFrameDialogFrame = BX.create("iframe", {
				attrs : { frameborder: 0, src: iframeUrl, style: 'min-width: '+parseInt(params.iframe.width)+'px; min-height: '+parseInt(params.iframe.height)+'px; max-height: 100%; max-width: 100%;', sandbox: "allow-same-origin allow-forms allow-scripts allow-popups", allow: "geolocation *; microphone *; camera *"},
				props : { className : "bx-messenger-iframe-element"+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll')}
			})
		]})
	});
	if (params.bind)
	{
		this.popupIframeMenu.setAngle({offset: 74});
	}
	else
	{
		this.openFrameDialogTitle.style.cursor = "move";
		BX.bind(this.openFrameDialogTitle, "mousedown", BX.proxy(this.popupIframeMenu.onTitleMouseDown, this.popupIframeMenu));
	}
	this.popupIframeMenu.show();

	BX.bind(this.openFrameDialogFrame, 'load', BX.delegate(this.openFrameDialogLoad, this));

	if (iframeUrl.indexOf('http') === 0)
	{
		var sourceHref = document.createElement('a');
		sourceHref.href = iframeUrl;

		this.openFrameDialogFrameSourceDomain = sourceHref.protocol+'//'+sourceHref.hostname+(sourceHref.port && sourceHref.port != '80' && sourceHref.port != '443'? ":"+sourceHref.port: "");
	}
	else
	{
		this.openFrameDialogFrameSourceDomain = location.protocol+'//'+location.hostname+(location.port && location.port != '80' && location.port != '443'? ":"+location.port: "");
	}

	BX.onCustomEvent('onImOpenFrameDialog', []);

	return false;
};

BX.MessengerChat.prototype.openFrameDialogLoad = function(params)
{
	var ie = 0 /*@cc_on + @_jscript_version @*/;
	if(typeof window.postMessage === 'function' && !ie)
	{
		this.openFrameDialogFrameUid = Math.random().toString().substr(2);
		this.openFrameDialogFrame.contentWindow.postMessage(JSON.stringify({
			'action': 'init',
			'domain': location.origin,
			'uniqueLoadId': this.openFrameDialogFrameUid
		}), this.openFrameDialogFrameSourceDomain);
	}
}

BX.MessengerChat.prototype.openFrameDialogPostMessage = function(params)
{
	var data = {};
	try { data = JSON.parse(params); } catch (err){}
	if(!data.action) return;

	if (this.openFrameDialogFrameUid != data.uniqueLoadId) return;

	if (data.action == 'send')
	{
		this.BXIM.sendMessage(data.message);
	}
	else if (data.action == 'put')
	{
		this.BXIM.putMessage(data.message);
		this.BXIM.messenger.textareaCheckText();
	}
	else if (data.action == 'call')
	{
		this.BXIM.phoneTo(data.number);
	}
	else if (data.action == 'support')
	{
		this.BXIM.openMessenger("networkLines"+data.code, null, true);
	}
	else if (data.action == 'close')
	{
		if (this.popupIframeMenu != null)
		{
			this.popupIframeMenu.destroy();
		}
	}

	return true;
};

BX.MessengerChat.prototype.expireFrameToken = function()
{
	if (!this.openFrameDialogBid)
	{
		return false;
	}

	for (var botId in this.sendFrameTokenCollection)
	{
		if (this.sendFrameTokenCollection[botId]+(this.sendFrameTokenTimeout*1000) < +new Date())
		{
			delete this.sendFrameTokenCollection[botId];

			if (this.openFrameDialogBid)
			{
				this.sendFrameToken(this.openFrameDialogBid, this.openFrameDialogDid);
			}
		}
	}

	return true;
}

BX.MessengerChat.prototype.sendFrameToken = function(botId, dialogId)
{
	this.sendFrameTokenCollection[botId] = +new Date();

	BX.ajax({
		url: this.BXIM.pathToAjax+'?SEND_FRAME_TOKEN&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 60,
		data: {'IM_OPEN_REST_TOKEN': 'Y', 'BOT_ID' : botId, 'DIALOG_ID' : dialogId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
	});
}

BX.MessengerChat.prototype.connectionStatus = function(status, send)
{
	send = typeof(send) == 'undefined'? true: send;

	if (!(status == 'online' || status == 'connecting' || status == 'offline'))
		return false;

	if (this.popupMessengerConnectionStatusState == status)
		return false;

	this.popupMessengerConnectionStatusState = status;

	var statusClass = '';

	if (status == 'offline')
	{
		this.popupMessengerConnectionStatusStateText = BX.message('IM_CS_OFFLINE');
		statusClass = 'bx-messenger-connection-status-offline';
	}
	else if (status == 'connecting')
	{
		this.popupMessengerConnectionStatusStateText = BX.message('IM_CS_CONNECTING');
		statusClass = 'bx-messenger-connection-status-connecting';
	}
	else if (status == 'online')
	{
		this.popupMessengerConnectionStatusStateText = BX.message('IM_CS_ONLINE');
		statusClass = 'bx-messenger-connection-status-online';
	}

	clearTimeout(this.popupMessengerConnectionStatusTimeout);

	if (!this.popupMessengerConnectionStatus)
		return false;

	if (status == 'online')
	{
		if (send)
		{
			if(this.redrawTab[this.currentTab])
			{
				BX.MessengerCommon.openDialog(this.currentTab);
			}
			else
			{
				this.updateState(true, false, 'UPDATE_STATE_RECONNECT');
			}
		}

		clearTimeout(this.popupMessengerConnectionStatusTimeout);
		this.popupMessengerConnectionStatusTimeout = setTimeout(BX.delegate(function(){
			BX.removeClass(this.popupMessengerConnectionStatus, "bx-messenger-connection-status-show");
			BX.addClass(this.popupMessengerConnectionStatus, "bx-messenger-connection-status-hide");
		}, this), 4000);
	}

	this.popupMessengerConnectionStatus.className = "bx-messenger-connection-status bx-messenger-connection-status-show "+statusClass;
	this.popupMessengerConnectionStatusText.innerHTML = this.popupMessengerConnectionStatusStateText;

	return true;
}

BX.MessengerChat.prototype.editMessage = function(messageId)
{
	if (!BX.MessengerCommon.checkEditMessage(messageId, 'edit'))
		return false;

	BX.removeClass(this.popupMessengerEditForm, 'bx-messenger-editform-disable');
	BX.removeClass(this.popupMessengerEditForm, 'bx-messenger-editform-hide');
	BX.addClass(this.popupMessengerEditForm, 'bx-messenger-editform-show');

	this.popupMessengerEditMessageId = messageId;

	if (this.popupMessengerEditTextarea.value.length > 20006)
	{
		this.popupMessengerEditTextarea.value = this.popupMessengerEditTextarea.value.substr(0, 20000)+' (...)';
	}

	this.popupMessengerEditTextarea.value = BX.MessengerCommon.prepareTextBack(this.message[messageId].text, true);

	this.popupMessengerEditTextarea.value = this.popupMessengerEditTextarea.value.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, BX.delegate(function(whole, userId, text)
	{
		BX.MessengerCommon.addMentionList(this.currentTab, text, parseInt(userId));
		return text;
	}, this));

	this.popupMessengerEditTextarea.value = this.popupMessengerEditTextarea.value.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, BX.delegate(function(whole, imol, chatId, text)
	{
		BX.MessengerCommon.addMentionList(this.currentTab, text, 'chat'+parseInt(chatId));
		return text;
	}, this));

	clearTimeout(this.popupMessengerEditFormTimeout);
	this.popupMessengerEditFormTimeout = setTimeout(BX.delegate(function(){
		if (!this.popupMessengerEditTextarea)
			return false;

		this.popupMessengerEditTextarea.focus();
		this.popupMessengerEditTextarea.selectionStart = this.popupMessengerEditTextarea.value.length;
		this.popupMessengerEditTextarea.selectionEnd = this.popupMessengerEditTextarea.value.length;
	}, this), 200);
}

BX.MessengerChat.prototype.editMessageCancel = function()
{
	this.popupMessengerEditTextarea.value = '';

	if (BX.hasClass(this.popupMessengerEditForm, 'bx-messenger-editform-disable'))
		return false;

	this.popupMessengerEditMessageId = 0;

	BX.removeClass(this.popupMessengerEditForm, 'bx-messenger-editform-show');
	BX.addClass(this.popupMessengerEditForm, 'bx-messenger-editform-hide');

	clearTimeout(this.popupMessengerEditFormTimeout);
	this.popupMessengerEditFormTimeout = setTimeout(BX.delegate(function(){
		BX.removeClass(this.popupMessengerEditForm, 'bx-messenger-editform-hide');
		BX.addClass(this.popupMessengerEditForm, 'bx-messenger-editform-disable');
	}, this), 500);

	this.popupMessengerTextarea.focus();
	this.popupMessengerTextarea.selectionStart = this.popupMessengerTextarea.value.length;
	this.popupMessengerTextarea.selectionEnd = this.popupMessengerTextarea.value.length;
}

BX.MessengerChat.prototype.deleteMessage = function(messageId, check)
{
	if (check !== false && !BX.MessengerCommon.checkEditMessage(messageId, 'delete'))
		return false;

	if (check !== false)
	{
		this.BXIM.openConfirm(BX.message('IM_M_HISTORY_DELETE_CONFIRM'), [
			new BX.PopupWindowButton({
				text : BX.message('IM_M_HISTORY_DELETE'),
				className : "popup-window-button-accept",
				events : { click : BX.delegate(function() { this.deleteMessage(messageId, false); BX.proxy_context.popupWindow.close(); }, this) }
			}),
			new BX.PopupWindowButton({
				text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
				className : "popup-window-button-decline",
				events : { click : function() { this.popupWindow.close(); } }
			})
		], true);
	}
	else
	{
		BX.MessengerCommon.deleteMessageAjax(messageId);
	}
}

BX.MessengerChat.prototype.shareMessage = function(messageId, type, date)
{
	BX.MessengerCommon.shareMessageAjax(messageId, type, date);
}

BX.MessengerChat.prototype.toggleLinesTab = function(checked)
{
	if (typeof(checked) == 'undefined')
	{
		checked = this.BXIM.settings.linesTabEnable;
	}
	else
	{
		this.BXIM.settings.linesTabEnable = checked;
	}

	if (checked)
	{
		if (BX.MessengerWindow.existsTab('im-ol'))
		{
			BX.MessengerWindow.showTab('im-ol');
		}
		else if (BX.MessengerCommon.isLinesOperator())
		{
			BX.MessengerWindow.addTab({
				id: 'im-ol',
				title: BX.message('IM_CTL_CHAT_OL'),
				order: 105,
				target: 'im',
				events: {
					open: BX.delegate(function(){
						if (BX.MessengerCommon.isPage() && this.BXIM.context == 'POPUP-FULLSCREEN' && !this.popupMessenger)
						{
							return false;
						}
						if (!this.BXIM.dialogOpen)
						{
							this.openMessenger(this.currentTab);
						}
						BX.MessengerCommon.userListRedraw();
					}, this),
					close: BX.delegate(function(){
						BX.MessengerCommon.userListRedraw();
					}, this)
				}
			});
		}
	}
	else
	{
		BX.MessengerWindow.hideTab('im-ol');
	}

	if (BX.MessengerWindow.currentTab == 'im-ol')
	{
		BX.MessengerWindow.changeTab('im', true);
	}
	BX.MessengerCommon.userListRedraw();
	this.updateMessageCount();

	return true;
}

BX.MessengerChat.prototype.toggleLinesNewGroup = function(active)
{
	if (typeof(active) == 'undefined')
	{
		active = this.BXIM.settings.linesNewGroupEnable;
	}
	else
	{
		this.BXIM.settings.linesNewGroupEnable = active;
	}

	BX.MessengerCommon.userListRedraw();

	return active;
}

BX.MessengerChat.prototype.onPaste = function(event)
{
	if (!event.clipboardData || !this.BXIM.disk.enable)
	{
		return true;
	}

	var text = event.clipboardData.getData("Text");
	if (text && !text.match(/\.(jpg|jpeg|png|gif)$/i))
	{
		return true;
	}

	this.imageUploaderFiles = [];

	var hasUploadFile = false;
	var uploadFilesLeft = event.clipboardData.files.length;
	for (var i=0; i < event.clipboardData.files.length; ++i)
	{
		var file = event.clipboardData.files[i];
		if (!file || !file.type.match(/(jpg|jpeg|png|gif)/i))
		{
			continue;
		}

		hasUploadFile = true;

		if (BX.browser.IsSafari())
		{
			fileName = file.name;
		}
		else
		{
			var convertType = file.name.replace(/^(.*)\.(jpg|jpeg|png|gif)$/im, function(whole, name, type){ return type; });
			var fileName = text? text.replace(/^(.*)\.(jpg|jpeg|png|gif)$/im, function(whole, name){return name+'.'+convertType;}): 'image_'+BX.Main.Date.format("Y-m-d_H:i:s")+'.'+convertType;
		}

		if (file.size > 1*1024*1024)
		{
			this.imageUploader();
		}

		var fileReader = new FileReader();

		fileReader.onerror = function (error)
		{
			console.error('BX.Messenger.onPaste -> fileReader.onerror:', error);

			if (this.popupImageUploader)
			{
				this.popupImageUploader.close();
			}
		}.bind(this)

		fileReader.onabort = function (error)
		{
			console.error('BX.Messenger.onPaste -> fileReader.onabort:', error);

			if (this.popupImageUploader)
			{
				this.popupImageUploader.close();
			}
		}.bind(this);

		fileReader.onloadend = function (result)
		{
			this.imageUploaderFiles.push({
				'name': fileName,
				'source': result.target.result,
			})

			if (uploadFilesLeft == 1)
			{
				if (this.popupImageUploader)
				{
					this.imageUploaderUpdateImage();
				}
				else
				{
					this.imageUploader();
				}
			}
			else
			{
				uploadFilesLeft--;
			}
		}.bind(this)

		fileReader.readAsDataURL(file);
	}

	if (hasUploadFile)
	{
		event.preventDefault();
		event.stopPropagation();
	}

	return true;
}

BX.MessengerChat.prototype.imageUploader = function()
{
	if (this.popupImageUploader)
		this.popupImageUploader.close();

	var titleBar = BX.message('IM_UPLOAD_IMAGE_TITLE');
	if (this.imageUploaderFiles.length > 1 && BX.message('IM_UPLOAD_IMAGE_TITLE_2'))
	{
		titleBar = BX.message('IM_UPLOAD_IMAGE_TITLE_2').replace('#NUMBER#', this.imageUploaderFiles.length);
	}

	this.popupImageUploader = new BX.PopupWindow('bx-messenger-image-uploader', null, {
		lightShadow: true,
		closeByEsc: true,
		closeIcon : {},
		contentNoPaddings : true,
		contentColor : "white",
		events : {
			onPopupClose : function() {this.destroy(); },
			onPopupDestroy : function() {
				this.popupImageUploader = null;
				this.imageUploaderTextarea = null;
				this.imageUploaderFiles = [];
			}.bind(this)
		},
		buttons: [
			new BX.PopupWindowButton({
				text : BX.message('IM_UPLOAD_IMAGE_BUTTON_UPLOAD'),
				className : "popup-window-button-accept",
				events : { click : BX.delegate(function() {
					this.disk.uploadFromClipboard(this.imageUploaderFiles, this.imageUploaderTextarea.value);
					BX.proxy_context.popupWindow.close();
				}, this) }
			}),
			new BX.PopupWindowButton({
				text : BX.message('IM_UPLOAD_IMAGE_BUTTON_CLOSE'),
				className : "popup-window-button-decline",
				events : { click : function() { this.popupWindow.close(); } }
			})
		],
		zIndex: 2000,
		titleBar: titleBar,
		content: '<div class="im-messenger-image-uploader">'+
			'<div class="im-messenger-image-uploader-preview bx-messenger-custom-scroll">'+
				this.imageUploaderPreperaImageNode()+
			'</div>'+
			'<div class="im-messenger-image-uploader-textarea">'+
				'<textarea class="im-messenger-image-uploader-textarea-input" placeholder="'+BX.message('IM_UPLOAD_IMAGE_COMMENT')+'"></textarea>'+
			'</div>'+
		'</div>'
	});
	this.popupImageUploader.show();

	BX.addClass(this.popupImageUploader.popupContainer, "bx-messenger-mark");

	this.imageUploaderButtonUpload = BX.findChildByClassName(this.popupImageUploader.buttonsContainer, 'popup-window-button-accept');
	if (this.imageUploaderButtonUpload && this.imageUploaderButtonUpload.innerHTML == BX.message('IM_UPLOAD_IMAGE_BUTTON_UPLOAD'))
	{
		this.imageUploaderButtonUpload.innerHTML = BX.message('IM_UPLOAD_IMAGE_BUTTON_UPLOAD')+' ('+(BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter")+')';
	}
	this.imageUploaderTextarea = BX.findChildByClassName(this.popupImageUploader.contentContainer, 'im-messenger-image-uploader-textarea-input');
	this.imageUploaderTextarea.focus();

	BX.bind(this.imageUploaderTextarea, 'keydown', function(event)
	{
		if (
			(event.metaKey == true || event.ctrlKey == true)
			&& (event.keyCode == 13 || event.keyCode == 32)
		)
		{
			this.disk.uploadFromClipboard(this.imageUploaderFiles, this.imageUploaderTextarea.value);
			this.popupImageUploader.close();
		}
	}.bind(this));

	if (this.imageUploaderFiles.length <= 0)
	{
		var previewNode = BX.findChildByClassName(this.popupImageUploader.contentContainer, 'im-messenger-image-uploader-preview');

		this.imageUploaderLoader = new BX.Loader({size: 42});
		this.imageUploaderLoader.show(previewNode);
	}

	return true;
};

BX.MessengerChat.prototype.imageUploaderPreperaImageNode = function()
{
	if (this.imageUploaderFiles.length <= 0)
	{
		return '';
	}

	var className = '';
	if (this.imageUploaderFiles.length == 1)
	{
		return '<div class="im-messenger-image-uploader-preview-box">' +
					'<img src="'+this.imageUploaderFiles[0].source+'" class="im-messenger-image-uploader-preview-image">' +
				'</div>';
	}
	else if (this.imageUploaderFiles.length == 2)
	{
		className = 'im-messenger-image-uploader-preview-group-box-twin';
	}
	else if (this.imageUploaderFiles.length == 3)
	{
		className = 'im-messenger-image-uploader-preview-group-box-one-line';
	}
	else if (this.imageUploaderFiles.length <= 6)
	{
		className = 'im-messenger-image-uploader-preview-group-box-two-line';
	}
	else
	{
		className = 'im-messenger-image-uploader-preview-group-box';
	}

	var result = '';
	this.imageUploaderFiles.forEach(function(item) {
		result += '<div class="im-messenger-image-uploader-preview-group-image">' +
					'<img src="'+item.source+'" class="im-messenger-image-uploader-preview-group-image-source">' +
				'</div>';
	});

	return '<div class="im-messenger-image-uploader-preview-box '+className+'">'+result+'</div>';
}

BX.MessengerChat.prototype.imageUploaderUpdateImage = function()
{
	if (!this.popupImageUploader || this.imageUploaderFiles.length <= 0)
	{
		return false;
	}

	var previewNode = BX.findChildByClassName(this.popupImageUploader.contentContainer, 'im-messenger-image-uploader-preview');
	if (!previewNode)
	{
		return false;
	}

	if (this.imageUploaderLoader)
	{
		this.imageUploaderLoader.destroy();
		this.imageUploaderLoader = null;
	}

	previewNode.innerHTML = this.imageUploaderPreperaImageNode();

	return true;
}

BX.MessengerChat.prototype.insertQuoteMessage = function(node)
{
	var arQuote = [];
	var firstMessage = true;
	var messageName = '';
	var messageDate = '';

	var stackMessages = BX.findChildren(node.parentNode.nextSibling.firstChild, {tagName : "span"}, false);
	for (var i = 0; i < stackMessages.length; i++) {
		var messageId = stackMessages[i].id.replace('im-message-','');
		if (this.message[messageId])
		{
			if (firstMessage)
			{
				if (this.users[this.message[messageId].senderId])
				{
					messageName = this.users[this.message[messageId].senderId].name;
					messageDate = this.message[messageId].date;
				}
				firstMessage = false;
			}

			var messageText = this.message[messageId].text.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, BX.delegate(function(whole, userId, text){return text;}, this));
			messageText = messageText.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, BX.delegate(function(whole, imol, chatId, text) {return text;}, this));
			messageText = messageText.replace(/\[RATING\=([1-5]{1})\]/ig, BX.delegate(function(whole, rating) {return '['+BX.message('IM_F_RATING')+'] ';}, this));
			messageText = messageText.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
			messageText = messageText.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
			messageText = messageText.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
			messageText = messageText.replace(/\[ATTACH=([0-9]{1,})\]/ig, BX.delegate(function(whole, command, text) {return command == 10000? '': '['+BX.message('IM_F_ATTACH')+'] ';}, this));

			arQuote.push(BX.MessengerCommon.prepareTextBack(messageText));
		}
	}
	this.insertQuoteText(messageName, messageDate, arQuote.join("\n"));
}

BX.MessengerChat.prototype.insertQuoteText = function(name, date, text, insertInTextarea)
{
	text = text.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, BX.delegate(function(whole, userId, text) {return text;}, this));
	text = text.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, BX.delegate(function(whole, imol, chatId, text) {return text;}, this));
	text = text.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
	text = text.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
	text = text.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/ig, BX.delegate(function(whole, command, text) {return text? text: command;}, this));
	text = text.replace(/\[ATTACH=([0-9]{1,})\]/ig, BX.delegate(function(whole, command, text) {return command == 10000? '': '['+BX.message('IM_F_ATTACH')+'] ';}, this));
	text = text.replace(/\[RATING\=([1-5]{1})\]/ig, BX.delegate(function(whole, rating) {return '['+BX.message('IM_F_RATING')+'] ';}, this));
	text = text.replace(/&nbsp;/ig, " ");

	var arQuote = [];
	arQuote.push((this.popupMessengerTextarea && this.popupMessengerTextarea.value.length>0?"\n":'')+this.historyMessageSplit);
	arQuote.push(BX.util.htmlspecialcharsback(name)+' ['+BX.MessengerCommon.formatDate(date)+']');
	arQuote.push(text);
	arQuote.push(this.historyMessageSplit+"\n");

	if (insertInTextarea !== false)
	{
		this.insertTextareaText(this.popupMessengerTextarea, arQuote.join("\n"), false);

		setTimeout(BX.delegate(function(){
			this.popupMessengerTextarea.scrollTop = this.popupMessengerTextarea.scrollHeight;
			this.popupMessengerTextarea.focus();
		}, this), 100);
	}
	else
	{
		return arQuote.join("\n");
	}
}

BX.MessengerChat.prototype.insertTextareaText = function(textarea, text, returnBack)
{
	if (!textarea && opener.BXIM.messenger.popupMessengerTextarea)
		textarea = opener.BXIM.messenger.popupMessengerTextarea;

	if (textarea.selectionStart || textarea.selectionStart == '0')
	{
		var selectionStart = textarea.selectionStart;
		var selectionEnd = textarea.selectionEnd;
		textarea.value = textarea.value.substring(0,selectionStart)+text+textarea.value.substring(selectionEnd, textarea.value.length);

		returnBack = returnBack != false;
		if (returnBack)
		{
			textarea.selectionStart = selectionStart+1;
			textarea.selectionEnd = selectionStart+1;
		}
		else if (BX.browser.IsChrome() || BX.browser.IsSafari() || BX.MessengerCommon.isDesktop())
		{
			textarea.selectionStart = textarea.value.length+1;
			textarea.selectionEnd = textarea.value.length+1;
		}
	}
	if (document.selection && document.documentMode && document.documentMode <= 8)
	{
		textarea.focus();
		var select=document.selection.createRange();
		select.text = text;
	}
};

BX.MessengerChat.prototype.resizeTextareaStart = function(e)
{
	if (this.webrtc.callOverlayFullScreen) return false;

	if(!e) e = window.event;

	this.popupMessengerTextareaResize.wndSize = BX.GetWindowScrollPos();
	this.popupMessengerTextareaResize.pos = BX.pos(this.popupMessengerTextarea);
	this.popupMessengerTextareaResize.y = e.clientY + this.popupMessengerTextareaResize.wndSize.scrollTop;
	this.popupMessengerTextareaResize.textOffset = this.popupMessengerTextarea.offsetHeight;
	this.popupMessengerTextareaResize.bodyOffset = this.popupMessengerBody.offsetHeight;

	BX.bind(document, "mousemove", BX.proxy(this.resizeTextareaMove, this));
	BX.bind(document, "mouseup", BX.proxy(this.resizeTextareaStop, this));

	if(document.body.setCapture)
		document.body.setCapture();

	document.onmousedown = BX.False;

	var b = document.body;
	b.ondrag = b.onselectstart = BX.False;
	b.style.MozUserSelect = 'none';
	b.style.cursor = 'move';

	BX.onCustomEvent('onImResizeTextarea', []);

	this.closeMenuPopup();
};
BX.MessengerChat.prototype.resizeTextareaMove = function(e)
{
	if(!e) e = window.event;

	var windowScroll = BX.GetWindowScrollPos();
	var x = e.clientX + windowScroll.scrollLeft;
	var y = e.clientY + windowScroll.scrollTop;
	if(this.popupMessengerTextareaResize.y == y)
		return;

	var textareaHeight = Math.max(Math.min(-(y-this.popupMessengerTextareaResize.pos.top) + this.popupMessengerTextareaResize.textOffset, 143), 30);

	this.popupMessengerTextareaSize = textareaHeight;
	this.popupMessengerTextarea.style.height = textareaHeight + 'px';
	this.popupMessengerBodySize = this.popupMessengerTextareaResize.textOffset-textareaHeight + this.popupMessengerTextareaResize.bodyOffset;
	this.popupMessengerBody.style.height = this.popupMessengerBodySize + 'px';
	this.popupMessengerBodyPanel.style.height = this.popupMessengerBodyDialog.offsetHeight + 'px';
	this.resizeMainWindow();

	this.popupMessengerTextareaResize.x = x;
	this.popupMessengerTextareaResize.y = y;
};

BX.MessengerChat.prototype.resizeTextareaStop = function()
{
	if(document.body.releaseCapture)
		document.body.releaseCapture();

	BX.unbind(document, "mousemove", BX.proxy(this.resizeTextareaMove, this));
	BX.unbind(document, "mouseup", BX.proxy(this.resizeTextareaStop, this));

	document.onmousedown = null;

	this.popupMessengerBody.scrollTop = this.popupMessengerBody.scrollHeight - this.popupMessengerBody.offsetHeight;

	var b = document.body;
	b.ondrag = b.onselectstart = null;
	b.style.MozUserSelect = '';
	b.style.cursor = '';

	clearTimeout(this.BXIM.adjustSizeTimeout);
	this.BXIM.adjustSizeTimeout = setTimeout(BX.delegate(function(){
		this.BXIM.setLocalConfig('global_tas', this.popupMessengerTextareaSize);
		this.BXIM.setLocalConfig('global_msz_v2', {
			'wz': this.popupMessengerFullWidth,
			'ta2': this.popupMessengerTextareaSize,
			'b': this.popupMessengerBodySize,
			'cl': this.popupContactListSize,
			'hi': this.popupHistoryItemsSize,
			'fz': this.popupMessengerFullHeight,
			'ez': this.popupContactListElementsSize,
			'nz': this.notify.popupNotifySize,
			'hf': this.popupHistoryFilterVisible,
			'dw': window.innerWidth,
			'dh': window.innerHeight,
			'place': 'taMove'
		});
	}, this), 500);
};

BX.MessengerChat.prototype.setTextareaSize = function(size)
{
	size = Math.max(Math.min(size, 143), 30);
	if (this.popupMessengerTextareaSize == size)
		return true;

	var difference = size-this.popupMessengerTextareaSize;

	this.popupMessengerBodySize = this.popupMessengerBodySize+(difference*-1);
	if (this.popupMessengerBody)
	{
		this.popupMessengerBody.style.height = this.popupMessengerBodySize + 'px';
		this.popupMessengerBodyPanel.style.height = this.popupMessengerBodyDialog.offsetHeight + 'px';
	}

	this.popupMessengerTextareaSize = size;
	if (this.popupMessengerTextarea)
	{
		this.popupMessengerTextarea.style.height = size + 'px';
	}

	return true;
}

BX.MessengerChat.prototype.resizeWindowStart = function()
{
	if (this.webrtc.callOverlayFullScreen) return false;
	if (this.popupMessengerTopLine)
		BX.remove(this.popupMessengerTopLine);

	this.popupMessengerWindow.pos = BX.pos(this.popupMessengerContent);
	this.popupMessengerWindow.mb = this.popupMessengerBodySize;
	this.popupMessengerWindow.nb = this.notify.popupNotifySize;

	BX.bind(document, "mousemove", BX.proxy(this.resizeWindowMove, this));
	BX.bind(document, "mouseup", BX.proxy(this.resizeWindowStop, this));

	if (document.body.setCapture)
		document.body.setCapture();

	document.onmousedown = BX.False;

	var b = document.body;
	b.ondrag = b.onselectstart = BX.False;
	b.style.MozUserSelect = 'none';
	b.style.cursor = 'move';

	this.closeMenuPopup();
	this.BXIM.autoHideDisable = true;
};
BX.MessengerChat.prototype.resizeWindowMove = function(e)
{
	if(!e) e = window.event;

	var windowScroll = BX.GetWindowScrollPos();
	var x = e.clientX + windowScroll.scrollLeft;
	var y = e.clientY + windowScroll.scrollTop;

	this.popupMessengerFullHeight = Math.max(Math.min(y-this.popupMessengerWindow.pos.top, 1000), this.popupMessengerMinHeight);
	this.popupMessengerFullWidth = Math.max(Math.min(x-this.popupMessengerWindow.pos.left, 1200), this.popupMessengerMinWidth);

	this.popupMessengerContent.style.height = this.popupMessengerFullHeight+'px';
	this.popupMessengerContent.style.width = this.popupMessengerFullWidth+'px';

	var changeHeight = this.popupMessengerFullHeight-Math.max(Math.min(this.popupMessengerWindow.pos.height, 1000), this.popupMessengerMinHeight);

	this.popupMessengerBodySize = this.popupMessengerWindow.mb+changeHeight;
	if (this.popupMessengerBody != null)
		this.popupMessengerBody.style.height = this.popupMessengerBodySize + 'px';
	if (this.popupMessengerBodyPanel != null)
		this.xx.style.height = this.popupMessengerBodyDialog.offsetHeight + 'px';
	if (this.popupMessengerExtra != null)
		this.popupMessengerExtra.style.height = this.popupMessengerFullHeight+'px';

	this.notify.popupNotifySize = Math.max(this.popupMessengerWindow.nb+(this.popupMessengerBodySize - this.popupMessengerWindow.mb), this.notify.popupNotifySizeMin);
	if (this.notify.popupNotifyItem != null)
		this.notify.popupNotifyItem.style.height = this.notify.popupNotifySize+'px';

	this.BXIM.messenger.redrawChatHeader();
	this.resizeMainWindow();
};

BX.MessengerChat.prototype.resizeWindowStop = function()
{
	if(document.body.releaseCapture)
		document.body.releaseCapture();

	BX.unbind(document, "mousemove", BX.proxy(this.resizeWindowMove, this));
	BX.unbind(document, "mouseup", BX.proxy(this.resizeWindowStop, this));

	document.onmousedown = null;

	this.popupMessengerBody.scrollTop = this.popupMessengerBody.scrollHeight - this.popupMessengerBody.offsetHeight;

	var b = document.body;
	b.ondrag = b.onselectstart = null;
	b.style.MozUserSelect = '';
	b.style.cursor = '';

	clearTimeout(this.BXIM.adjustSizeTimeout);
	this.BXIM.adjustSizeTimeout = setTimeout(BX.delegate(function(){
		this.BXIM.setLocalConfig('global_msz_v2', {
			'wz': this.popupMessengerFullWidth,
			'ta2': this.popupMessengerTextareaSize,
			'b': this.popupMessengerBodySize,
			'cl': this.popupContactListSize,
			'hi': this.popupHistoryItemsSize,
			'fz': this.popupMessengerFullHeight,
			'ez': this.popupContactListElementsSize,
			'nz': this.notify.popupNotifySize,
			'hf': this.popupHistoryFilterVisible,
			'dw': window.innerWidth,
			'dh': window.innerHeight,
			'place': 'winMove'
		});
		this.BXIM.autoHideDisable = false;
	}, this), 500);
};

/* COMMON */

BX.MessengerChat.prototype.newMessage = function(send)
{
	send = send != false;

	var arNewMessage = [];
	var arNewMessageText = [];
	var flashCount = 0;
	var flashNames = {};
	var enableSound = 0;
	for (var i in this.flashMessage)
	{
		var skip = false;
		var skipBlock = false;

		if (this.BXIM.isFocus() && this.popupMessenger != null && i == this.currentTab)
		{
			skip = true;
			enableSound++;
		}
		else if (i.toString().substr(0,4) == 'chat' || this.users[i] && this.users[i].extranet)
		{
			if (this.muteButtonStatus(i))
			{
				skipBlock = true;
			}
		}

		if (skip || skipBlock)
		{
			for (var k in this.flashMessage[i])
			{
				if (this.flashMessage[i][k] !== false)
				{
					this.flashMessage[i][k] = false;
					flashCount++;
				}
			}
			continue;
		}

		var flashedDialogId = {};
		for (var k in this.flashMessage[i])
		{
			if (this.flashMessage[i][k] === false || flashedDialogId[i])
			{
				this.flashMessage[i][k] = false;
				continue;
			}

			flashedDialogId[i] = true;

			var isChat = this.message[k].recipientId.toString().substr(0,4) == 'chat';
			var recipientId = this.message[k].recipientId;
			var senderId = !isChat && this.message[k].senderId == 0? i: this.message[k].senderId;

			if (
				isChat && !this.chat[recipientId.substr(4)]
				|| !isChat && !this.users[senderId]
			)
			{
				continue;
			}

			var isCall = isChat && this.chat[recipientId.substr(4)].type == 'call';
			var isLines = isChat && this.chat[recipientId.substr(4)].type == 'lines';
			var isSystem = this.message[k].system == 'Y';

			var messageText = BX.MessengerCommon.purifyText(this.message[k].text, this.message[k].params);

			if (i != this.BXIM.userId)
			{
				flashNames[i] = (isChat? this.chat[recipientId.substr(4)].name: this.users[senderId].name);
			}

			if (messageText.length > 150)
			{
				messageText = messageText.substr(0, 150);
				var lastSpace = messageText.lastIndexOf(' ');
				if (lastSpace < 140)
					messageText = messageText.substr(0, lastSpace)+'...';
				else
					messageText = messageText.substr(0, 140)+'...';
			}

			if (messageText == '')
			{
				if (this.message[k].params['FILE_ID'] && this.message[k].params['FILE_ID'].length > 0)
					messageText = '['+BX.message('IM_F_FILE')+']';
				else if (this.message[k].params['ATTACH'] && this.message[k].params['ATTACH'].length > 0)
					messageText = '['+BX.message('IM_F_ATTACH')+']';
			}

			if (isChat)
			{
				var chatId = recipientId.substr(4);
				var avatarStyle = BX.MessengerCommon.isBlankAvatar(this.chat[chatId].avatar)? 'background-color: '+this.chat[chatId].color: '';

				var avatarType = 3;
				if (isCall)
				{
					avatarType = 4;
				}
				else if(isLines)
				{
					avatarType = 7;
				}
				else if(this.generalChatId == chatId)
				{
					avatarType = 6;
				}
				else if (this.chat[recipientId.substr(4)].type == 'open')
				{
					avatarType = 5;
				}
			}
			else
			{
				var avatarStyle = BX.MessengerCommon.isBlankAvatar(this.users[senderId].avatar)? 'background-color: '+this.users[senderId].color: '';
			}
			var element = BX.create("div", {attrs : { 'data-userId' : isChat? recipientId: senderId, 'data-messageId' : k}, props : { className: "bx-notifier-item bx-notifier-item-"+k+" "}, children : [
				BX.create('span', {props : { className : "bx-notifier-item-content" }, children : [
					BX.create('span', {props : { className : "bx-notifier-item-avatar"}, children : [
						BX.create('img', {props : {className : "bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar)? (isChat? " bx-notifier-item-avatar-img-default-"+avatarType: " bx-notifier-item-avatar-img-default"): "")}, attrs : {src : isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar, style: avatarStyle}})
					]}),
					BX.create("a", {attrs : {href : '#', 'data-messageId' : k}, props : { className: "bx-notifier-item-delete"}}),
					BX.create('span', {props : { className : "bx-notifier-item-date" }, html: BX.MessengerCommon.formatDate(this.message[k].date)}),
					BX.create('span', {props : { className : "bx-notifier-item-name" }, html: isChat? this.chat[recipientId.substr(4)].name: this.users[senderId].name}),
					BX.create('span', {props : { className : "bx-notifier-item-text" }, html: (isChat && senderId>0?'<i>'+this.users[senderId].name+'</i>: ':'')+BX.MessengerCommon.prepareText(messageText, false, true)})
				]})
			]});
			if (!this.BXIM.xmppStatus || this.BXIM.xmppStatus && isChat)
			{
				arNewMessage.push(element);

				messageText = BX.util.htmlspecialcharsback(messageText);
				messageText = messageText.split('<br />').join("\n");
				messageText = messageText.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, function(whole, userId, text) {return text;});
				messageText = messageText.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, function(whole, imol, chatId, text) {return text;});
				messageText = messageText.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/ig, function(whole, historyId, text) {return text;});
				messageText = messageText.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/ig, function(whole, command, text) {return text? text: command;});
				messageText = messageText.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/ig, function(whole, command, text) {return text? text: command;});
				messageText = messageText.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/ig, function(whole, command, text) {return text? text: command;});
				messageText = messageText.replace(/\[ATTACH=([0-9]{1,})\]/ig, function(whole, historyId, text) {return '';});

				arNewMessageText.push({
					'id':  isChat? recipientId: senderId,
					'title':  BX.util.htmlspecialcharsback(isChat? this.chat[recipientId.substr(4)].name: this.users[senderId].name),
					'text':  (isChat && senderId>0?this.users[senderId].name+': ':'')+messageText,
					'icon':  isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar,
					'tag':  'im-messenger-'+(isChat? recipientId: senderId)
				});
			}
			this.flashMessage[i][k] = false;
		}
	}

	if (this.BXIM.context == "LINES" || this.BXIM.context == "DIALOG")
	{
		return false;
	}

	if (BX.MessengerCommon.isSlider())
		return false;

	if (!BX.MessengerCommon.isDesktop() && this.BXIM.desktopStatus)
		return false;

	if (arNewMessage.length > 5)
	{
		var names = '';
		for (var i in flashNames)
			names += ', <i>'+flashNames[i]+'</i>';

		var notify = {
			id: 0, type: 4, date: new Date(),
			title: BX.message('IM_NM_MESSAGE_1').replace('#COUNT#', arNewMessage.length),
			text: BX.message('IM_NM_MESSAGE_2').replace('#USERS#', names.substr(2))
		};
		arNewMessage = [];
		arNewMessage.push(this.notify.createNotify(notify, true))

		arNewMessageText = []
		arNewMessageText.push({
			'id': '',
			'title':  BX.message('IM_NM_MESSAGE_1').replace('#COUNT#', arNewMessage.length),
			'text':  BX.message('IM_NM_MESSAGE_2').replace('#USERS#', BX.util.htmlspecialcharsback(names.substr(2))).replace(/<\/?[^>]+>/gi, '')
		})
	}
	else if (arNewMessage.length == 0)
	{
		if (enableSound > 0 && BX.MessengerCommon.isDesktop())
			BX.desktop.flashIcon();

		if (send && enableSound > 0 && this.BXIM.settings.status != 'dnd')
		{
			this.BXIM.playSound("newMessage2");
		}

		return false;
	}

	if (BX.MessengerCommon.isDesktop())
		BX.desktop.flashIcon();

	//if (this.BXIM.settings.status == 'dnd')
	//	return false;

	if (BX.MessengerCommon.isDesktop())
	{
		for (var i = 0; i < arNewMessage.length; i++)
		{
			var dataMessageId = arNewMessage[i].getAttribute("data-messageId");
			var messsageJs =
				'var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+
				'notify.style.cursor = "pointer";'+
				'BX.bind(notify, "click", function(){BX.desktop.onCustomEvent("main", "bxImClickNewMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close")});'+
				'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ BX.desktop.onCustomEvent("main", "bxImClickCloseMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+
				'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';
			this.desktop.openNewMessage(dataMessageId, arNewMessage[i], messsageJs);
		}
	}
	else if(send && !this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
	{
		for (var i = 0; i < arNewMessageText.length; i++)
		{
			var notify = arNewMessageText[i];
			notify.onshow = function() {
				var notify = this;
				setTimeout(function(){
					notify.close();
				}, 5000)
			}
			notify.onclick = function() {
				window.focus();
				top.BXIM.openMessenger(notify.id);
				this.close();
			}
			this.BXIM.notifyManager.nativeNotify(notify)
		}
	}
	else
	{
		if (this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
		{
			BX.localStorage.set('mnnb', true, 1);
		}
		for (var i = 0; i < arNewMessage.length; i++)
		{
			this.BXIM.notifyManager.add({
				'html': arNewMessage[i],
				'tag': 'im-message-'+arNewMessage[i].getAttribute('data-userId'),
				'userId': arNewMessage[i].getAttribute('data-userId'),
				'click': BX.delegate(function(popup) {
					this.openMessenger(popup.notifyParams.userId);
					popup.close();
				}, this),
				'close': BX.delegate(function(popup) {
					BX.MessengerCommon.readMessage(popup.notifyParams.userId);
				}, this)
			});
		}
	}

	if (BX.MessengerCommon.isDesktop())
		BX.desktop.flashIcon();

	if (send)
	{
		this.BXIM.playSound("newMessage1");
	}
};

BX.MessengerChat.prototype.showNotifyBlock = function(messageParams)
{
	var isChat = messageParams.recipientId.toString().substr(0, 4) == 'chat';
	var recipientId = messageParams.recipientId;
	var isCall = isChat && this.chat[recipientId.substr(4)] && this.chat[recipientId.substr(4)].type == 'call';
	var isLines = isChat && this.chat[recipientId.substr(4)] && this.chat[recipientId.substr(4)].type == 'lines';
	var senderId = !isChat && messageParams.senderId == 0? i: messageParams.senderId;
	var messageText = messageParams.text_mobile? messageParams.text_mobile: messageParams.text;

	if (!messageParams.id)
		messageParams.id = "custom-"+(+new Date);

	if (messageParams.date)
		messageParams.date = new Date();

	messageText = messageText.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gmi, "[" + BX.message("IM_M_QUOTE_BLOCK") + "]");
	if (messageText.length > 150)
	{
		messageText = messageText.substr(0, 150);
		var lastSpace = messageText.lastIndexOf(' ');
		if (lastSpace < 140)
			messageText = messageText.substr(0, lastSpace) + '...';
		else
			messageText = messageText.substr(0, 140) + '...';
	}


	if (messageText == '' && messageParams.params['FILE_ID'].length > 0)
	{
		messageText = '[' + BX.message('IM_F_FILE') + ']';
	}

	if (isChat)
	{
		var chatId = recipientId.substr(4);
		var avatarStyle = BX.MessengerCommon.isBlankAvatar(this.chat[chatId].avatar)? 'background-color: '+this.chat[chatId].color: '';

		var avatarType = 3;
		if (isCall)
		{
			avatarType = 4;
		}
		else if(isLines)
		{
			avatarType = 7;
		}
		else if(this.generalChatId == chatId)
		{
			avatarType = 6;
		}
		else if (this.chat[recipientId.substr(4)].type == 'open')
		{
			avatarType = 5;
		}
	}
	else
	{
		var avatarStyle = BX.MessengerCommon.isBlankAvatar(this.users[senderId].avatar)? 'background-color: '+this.users[senderId].color: '';
	}

	var notifyHtmlNode = BX.create("div", {
		attrs : {'data-userId' : isChat? recipientId: senderId, 'data-messageId' : messageParams.id},
		props : {className : "bx-notifier-item bx-notifier-item-"+messageParams.id+" "},
		children : [
			BX.create('span', {
				props : {className : "bx-notifier-item-content"}, children : [
					BX.create('span', {
						props : {className : "bx-notifier-item-avatar"}, children : [
							BX.create('img', {
								props : {className : "bx-notifier-item-avatar-img" + (BX.MessengerCommon.isBlankAvatar(isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar)? (isChat? " bx-notifier-item-avatar-img-default-" + avatarType: " bx-notifier-item-avatar-img-default"): "")},
								attrs : {src : isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar, style: avatarStyle}
							})
						]
					}),
					BX.create("a", {
						attrs : {href : '#', 'data-messageId' : messageParams.id},
						props : {className : "bx-notifier-item-delete"}
					}),
					messageParams.date? BX.create('span', {
						props : {className : "bx-notifier-item-date"},
						html : BX.MessengerCommon.formatDate(messageParams.date)
					}): BX.create('span'),
					BX.create('span', {
						props : {className : "bx-notifier-item-name"},
						html : isChat? this.chat[recipientId.substr(4)].name: this.users[senderId].name
					}),
					BX.create('span', {
						props : {className : "bx-notifier-item-text"},
						html : (isChat && senderId > 0? '<i>' + this.users[senderId].name + '</i>: ': '') + BX.MessengerCommon.prepareText(messageText, false, true)
					})
				]
			})
		]
	});

	if (!this.BXIM.xmppStatus || this.BXIM.xmppStatus && isChat)
	{
		messageText = BX.util.htmlspecialcharsback(messageText);
		messageText = messageText.split('<br />').join("\n");
		messageText = messageText.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig, function (whole, userId, text) {return text;});
		messageText = messageText.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig, function (whole, imol, chatId, text) {return text;});
		messageText = messageText.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/ig, function (whole, historyId, text) {return text;});
		messageText = messageText.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/ig, function (whole, command, text) {return text? text: command;});
		messageText = messageText.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/ig, function (whole, command, text) {return text? text: command;});
		messageText = messageText.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/ig, function (whole, command, text) {return text? text: command;});
		messageText = messageText.replace(/\[ATTACH=([0-9]{1,})\]/ig, function (whole, command, text) {return '';});

		notifyTextObject = {
			'id' : isChat? recipientId: senderId,
			'title' : BX.util.htmlspecialcharsback(isChat? this.chat[recipientId.substr(4)].name: this.users[senderId].name),
			'text' : (isChat && senderId > 0? this.users[senderId].name + ': ': '') + messageText,
			'icon' : isChat? this.chat[recipientId.substr(4)].avatar: this.users[senderId].avatar,
			'tag' : 'im-messenger-' + (isChat? recipientId: senderId)
		};
	}
	else
	{
		return false;
	}

	if (!(!BX.MessengerCommon.isDesktop() && BX.MessengerCommon.isPage()) && !BX.MessengerCommon.isDesktop() && this.BXIM.desktopStatus)
		return false;

	if (BX.MessengerCommon.isDesktop())
	{
		var messsageJs =
			'var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+
			'notify.style.cursor = "pointer";'+
			'BX.bind(notify, "click", function(){BX.desktop.onCustomEvent("main", "bxImClickNewMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close")});'+
			'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ BX.desktop.onCustomEvent("main", "bxImClickCloseMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+
			'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';
		this.desktop.openNewMessage(
			notifyHtmlNode.getAttribute("data-messageId"),
			notifyHtmlNode,
			messsageJs
		);
	}
	else if(!this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
	{
		var notify = notifyTextObject;
		notify.onshow = function() {
			var notify = this;
			setTimeout(function(){
				notify.close();
			}, 5000)
		}
		notify.onclick = function() {
			window.focus();
			top.BXIM.openMessenger(notify.id);
			this.close();
		}
		this.BXIM.notifyManager.nativeNotify(notify);
	}
	else
	{
		this.BXIM.notifyManager.add({
			'html': notifyHtmlNode,
			'tag': 'im-message-'+notifyHtmlNode.getAttribute('data-userId'),
			'userId': notifyHtmlNode.getAttribute('data-userId'),
			'click': BX.delegate(function(popup) {
				this.openMessenger(popup.notifyParams.userId);
				popup.close();
			}, this),
			'close': BX.delegate(function(popup) {
				BX.MessengerCommon.readMessage(popup.notifyParams.userId);
			}, this)
		});
	}

	return true;
}

BX.MessengerChat.prototype.updateMessageCount = function(send)
{
	send = send != false;
	var count = 0;
	var chatId = 0;
	var countLines = 0;
	for (var i in this.unreadMessage)
	{
		if (!this.unreadMessage[i])
			continue;

		if (i.toString().substr(0,4) == 'chat')
		{
			chatId = i.toString().substr(4);
			if (this.chat[chatId] && this.chat[chatId].entity_type == 'LINES' && this.BXIM.settings.linesTabEnable && BX.MessengerCommon.isLinesOperator())
			{
				countLines = countLines+this.unreadMessage[i].length;
			}
			else if (!this.userChatBlockStatus[chatId] || !this.userChatBlockStatus[chatId][this.BXIM.userId])
			{
				count = count+this.unreadMessage[i].length;
			}
		}
		else
		{
			count = count+this.unreadMessage[i].length;
		}
	}

	if (send)
		BX.localStorage.set('mumc', {'unread':this.unreadMessage, 'flash':this.flashMessage}, 5);

	if (this.messageCount != count)
		BX.onCustomEvent(window, 'onImUpdateCounterMessage', [count, 'MESSAGE']);

	this.messageCount = count;

	if (this.BXIM.linesCount != countLines)
		BX.onCustomEvent(window, 'onImUpdateCounterMessage', [countLines, 'LINES']);

	this.BXIM.linesCount = countLines;

	var messageCountLabel = '';
	if (this.messageCount > 99)
		messageCountLabel = '99+';
	else if (this.messageCount > 0)
		messageCountLabel = this.messageCount;

	if (this.notify.panelButtonMessageCount)
	{
		this.notify.panelButtonMessageCount.innerHTML = messageCountLabel;
		this.notify.adjustPosition({"resize": true, "timeout": 500});
	}

	if (BX.MessengerCommon.isPage())
	{
		BX.MessengerWindow.setTabBadge('im', count);
		BX.MessengerWindow.setTabBadge('im-ol', countLines);
	}

	this.BXIM.messageCount = this.messageCount;

	return this.messageCount;
};

BX.MessengerChat.prototype.setStatus = function(status, send)
{
	send = send != false;

	//if (this.users[this.BXIM.userId].status == status)
	//	return false;

	if (!status)
		return false;

	status = status.toLowerCase();

	this.users[this.BXIM.userId].status = status;
	this.BXIM.updateCounter(); // for redraw digits on new color

	if (this.contactListPanelStatus != null && !BX.hasClass(this.contactListPanelStatus, 'bx-messenger-cl-panel-status-'+status))
	{
		this.contactListPanelStatus.className = 'bx-messenger-cl-panel-status-wrap bx-messenger-cl-panel-status-'+status;

		var statusText = BX.findChildByClassName(this.contactListPanelStatus, "bx-messenger-cl-panel-status-text");
		status = status == 'birthday'? 'online': status;
		statusText.innerHTML = BX.message("IM_STATUS_"+status.toUpperCase());

		if (send)
		{
			this.BXIM.saveSettings({'status': status});
			BX.onCustomEvent(this, 'onStatusChange', [status]);
			BX.localStorage.set('mms', status, 5);
		}
	}
	if (BX.MessengerCommon.isDesktop())
		BX.desktop.setIconStatus(status);
};

BX.MessengerChat.prototype.resizeMainWindow = function()
{
	if (BX.MessengerCommon.isPage())
		return false;

	if (this.popupMessengerExtra.style.display == "block")
		this.popupContactListElementsSize = this.popupMessengerExtra.offsetHeight-120;
	else
		this.popupContactListElementsSize = this.popupMessengerDialog.offsetHeight-120;

	this.popupContactListElements.style.height = this.popupContactListElementsSize+'px';
};

BX.MessengerChat.prototype.showTopLine = function(text, buttons, closeFunction)
{
	if (typeof (text) != 'string')
		return false;

	if (typeof(closeFunction) != "function")
	{
		closeFunction = BX.delegate(function(){this.hideTopLine();}, this);
	}
	var arElements = [];
	arElements.push(BX.create('span', { props : { className : "bx-messenger-box-topline-close" }, events: {click: closeFunction}}));

	if (typeof (buttons) == 'object')
	{
		var arButtons = [];
		for (var i = 0; i < buttons.length; i++)
		{
			arButtons.push(BX.create('span', { props : { className : "bx-messenger-box-topline-button" }, html: buttons[i].title, events: {click: buttons[i].callback}}));
		}
		arElements.push(BX.create('span', { props : { className : "bx-messenger-box-topline-buttons" }, children: arButtons}));
	}

	arElements.push(BX.create('span', { props : { className : "bx-messenger-box-topline-text" }, children: [
		BX.create('span', { props : { className : "bx-messenger-box-topline-text-inner"}, html: text})
	]}));

	this.popupMessengerTopLine.innerHTML = '';
	BX.adjust(this.popupMessengerTopLine, {children: arElements});
	BX.addClass(this.popupMessengerTopLine, "bx-messenger-box-topline-show");

	return true;
};

BX.MessengerChat.prototype.hideTopLine = function(send)
{
	BX.removeClass(this.popupMessengerTopLine, "bx-messenger-box-topline-show");

	if (send !== false);
	{
		BX.localStorage.set('mhtl', true, 1);
	}
};

BX.MessengerChat.prototype.closeMenuPopup = function()
{
	if (this.popupPopupMenu != null && this.popupPopupMenuDateCreate+100 < (+new Date()))
		this.popupPopupMenu.close();
	if (this.popupSmileMenu != null)
		this.popupSmileMenu.close();
	if (this.notify.popupNotifyMore != null)
		this.notify.popupNotifyMore.destroy();
	if (this.popupChatUsers != null)
		this.popupChatUsers.close();
	if (this.webrtc.popupKeyPad != null)
		this.webrtc.popupKeyPad.destroy();
	if (this.popupChatDialog != null)
		this.popupChatDialog.destroy();
	if (this.popupTransferDialog != null)
		this.popupTransferDialog.destroy();
	if (this.popupTooltip != null)
		this.popupTooltip.destroy();
	if (this.commandPopup != null)
		this.commandPopup.close();
	if (this.popupIframeMenu != null && this.popupIframeBind)
		this.popupIframeMenu.destroy();

	if (window.obCrm && window.obCrm.olCrmSelector && window.obCrm.olCrmSelector.popup)
		window.obCrm.olCrmSelector.popup.close();

	this.closePopupFileMenu();
};

BX.MessengerChat.MenuPrepareList = function(menuItems)
{
	var items = [];
	for (var i = 0; i < menuItems.length; i++)
	{
		var item = menuItems[i];
		if (item == null)
			continue;

		if (!item.separator && (!item.text || !BX.type.isNotEmptyString(item.text)))
			continue;

		if (item.separator)
		{
			items.push(BX.create("div", { props : { className : "bx-messenger-menu-hr" }}));
		}
		else if (item.type == 'call')
		{
			var a = BX.create("a", {
				props : { className: "bx-messenger-popup-menu-item"},
				attrs : { title : item.title ? item.title : "",  href : item.href ? item.href : "", target: item.target ? item.target : "_blank", 'data-params': item.dataParams? JSON.stringify(item.dataParams): ""},
				events : item.onclick && BX.type.isFunction(item.onclick) ? { click : item.onclick } : null,
				html :  '<div class="bx-messenger-popup-menu-item-call"><span class="bx-messenger-popup-menu-item-left"></span><span class="bx-messenger-popup-menu-item-title">' + item.text + '</span><span class="bx-messenger-popup-menu-right"></span></div>'+
						'<div><span class="bx-messenger-popup-menu-item-left"></span><span class="bx-messenger-popup-menu-item-text">' + item.phone + '</span><span class="bx-messenger-popup-menu-right"></span></div>'
			});

			if (item.href)
				a.href = item.href;
			items.push(a);
		}
		else
		{
			var attrs = item.attrs? item.attrs: {};
			attrs['title'] = item.title ? item.title : "";
			attrs['href'] = item.href ? item.href : "";
			attrs['target'] = item.target ? item.target : "_blank";
			attrs['data-params'] = item.dataParams? JSON.stringify(item.dataParams): "";

			var a = BX.create("a", {
				props : { className: "bx-messenger-popup-menu-item"+(item.bold? " bx-messenger-popup-menu-item-bold":"")+(item.slim? " bx-messenger-popup-menu-item-slim":"")+(item.disabled? " bx-messenger-popup-menu-item-disabled":"")+(BX.type.isNotEmptyString(item.className) ? " " + item.className : "")},
				attrs : attrs,
				events : item.onclick && BX.type.isFunction(item.onclick) ? { click : item.onclick } : null,
				html :  '<span class="bx-messenger-popup-menu-item-left"></span>'+(item.icon? '<span class="bx-messenger-popup-menu-item-icon '+item.icon+'"></span>':'')+'<span class="bx-messenger-popup-menu-item-text">' + item.text + '</span><span class="bx-messenger-popup-menu-right"></span>'
			});

			if (item.href)
				a.href = item.href;
			items.push(a);
		}
	}
	return items;
};

BX.MessengerChat.prototype.storageSet = function(params)
{
	if (params.key == 'ims')
	{
		if (this.BXIM.settings.viewOffline != params.value.viewOffline || this.BXIM.settings.viewGroup != params.value.viewGroup)
			BX.MessengerCommon.userListRedraw(true);

		if (this.BXIM.settings.sendByEnter != params.value.sendByEnter && this.popupMessengerTextareaSendType)
			this.popupMessengerTextareaSendType.innerHTML = this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");

		if (this.BXIM.settings.sendByEnter != params.value.sendByEnter && this.popupMessengerTextareaSendType)
			this.popupMessengerTextareaSendType.innerHTML = this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");

		BX.MessengerCommon.drawTab(this.currentTab, true);

		this.BXIM.settings = params.value;
	}
	else if (params.key == 'mus')
	{
		this.updateState(true, false);
	}
	else if (params.key == 'musl')
	{
		this.updateStateLight(true, false);
	}
	else if (params.key == 'mms')
	{
		this.setStatus(params.value, false);
	}
	else if (params.key == 'mhtl')
	{
		this.hideTopLine(false);
	}
	else if (params.key == 'mct')
	{
	}
	else if (params.key == 'mrlr')
	{
		BX.MessengerCommon.recentListHide(params.value.userId, false);
	}
	else if (params.key == 'mrd')
	{
		this.BXIM.settings.viewGroup = params.value.viewGroup;
		this.BXIM.settings.viewOffline = params.value.viewOffline;

		BX.MessengerCommon.userListRedraw();
	}
	else if (params.key == 'mrm')
	{
		BX.MessengerCommon.readMessage(params.value, false, false);
	}
	else if (params.key == 'mcl')
	{
		BX.MessengerCommon.leaveFromChat(params.value, false);
	}
	else if (params.key == 'mclk')
	{
		this.kickFromChat(params.value.chatId, params.value.userId);
	}
	else if (params.key == 'mes')
	{
		this.BXIM.settings.enableSound = params.value;
	}
	else if (params.key == 'mti')
	{
		if (params.value > this.messageTmpIndex)
			this.messageTmpIndex = params.value;
	}
	else if (params.key == 'mns')
	{
		if (this.popupContactListSearchInput != null)
			this.popupContactListSearchInput.value = params.value != null? params.value+'': '';

		this.contactListSearchText = params.value != null? params.value+'': '';
	}
	else if (params.key == 'msm')
	{
		if (this.message[params.value.id])
			return;

		params.value.date = new Date(params.value.date);
		this.message[params.value.id] = params.value;

		if (this.history[params.value.recipientId])
			this.history[params.value.recipientId].push(params.value.id);
		else
			this.history[params.value.recipientId] = [params.value.id];

		if (this.showMessage[params.value.recipientId])
			this.showMessage[params.value.recipientId].push(params.value.id);
		else
			this.showMessage[params.value.recipientId] = [params.value.id];

		BX.MessengerCommon.updateStateVar(params.value, false, false);

		BX.MessengerCommon.drawTab(params.value.recipientId, true);
	}
	else if (params.key == 'uss')
	{
		this.updateStateStep = parseInt(params.value);
	}
	else if (params.key == 'mumc')
	{
		setTimeout(BX.delegate(function(){
			var send = false;
			if (this.popupMessenger != null && this.BXIM.isFocus())
			{
				delete params.value.unread[this.currentTab];
				send = true;
			}

			this.unreadMessage = params.value.unread;
			this.flashMessage = params.value.flash;

			this.updateMessageCount(send);
		}, this), 500);
	}
	else if (params.key == 'mum')
	{
		params.value.message.date = new Date(params.value.message.date);
		this.message[params.value.message.id] = params.value.message;

		if (this.showMessage[params.value.userId])
		{
			this.showMessage[params.value.userId].push(params.value.message.id);
			this.showMessage[params.value.userId] = BX.util.array_unique(this.showMessage[params.value.userId]);
		}
		else
			this.showMessage[params.value.userId] = [params.value.message.id];

		BX.MessengerCommon.drawMessage(params.value.userId, params.value.message, this.currentTab == params.value.userId);
	}
	else if (params.key == 'muum')
	{
		BX.MessengerCommon.changeUnreadMessage(params.value, false);
	}
	else if (params.key == 'mcam' && !this.BXIM.ppServerStatus)
	{
		if (this.popupMessenger != null && !this.BXIM.callController.hasActiveCall())
			this.popupMessenger.close();
	}
};

/* OPEN LINES */
BX.MessengerChat.prototype.linesVoteHeadDialog = function(bindElement, sessionId, inline)
{
	inline = inline || false;

	var rating = bindElement.getAttribute('data-rating') || 0;

	var ratingNode = BX.MessengerCommon.linesVoteHeadNodes(sessionId, rating, true, inline? null: bindElement);

	if (inline)
		return ratingNode;

	this.tooltip(bindElement, ratingNode, {offsetTop: 10, offsetLeft: 12, bindOptions: {position: "bottom"}});

	return true;
}

BX.MessengerChat.prototype.linesVoteAndCommentHeadDialog = function(bindElement, sessionId, rating, comment)
{
	if(!rating)
	{
		rating = null
	}
	if(!comment)
	{
		comment = null
	}

	if (this.linesCommentHeadAdd)
		this.linesCommentHeadAdd(rating, comment, bindElement);

	return true;
}

BX.MessengerChat.prototype.linesOpenHistory = function(sessionId)
{
	BX.MessengerCommon.linesGetSessionHistory(sessionId);
}

BX.MessengerChat.prototype.linesShowHistory = function(chatId, data)
{
	if (this.popupMessengerConnectionStatusState != 'online')
		return false;

	if (this.historyWindowBlock)
		return false;

	if (this.popupHistory != null)
		this.popupHistory.destroy();

	if (!chatId)
		return false;

	var enableDisk = this.BXIM.disk.enable;

	enableDisk = false; // TODO files for session not work
	this.popupHistoryPanel = null;
	var historyPanel = this.redrawHistoryPanel('chat'+chatId, chatId, {'drawLinesJoin': data.CAN_JOIN, 'drawLinesVote': data.CAN_VOTE_HEAD, 'sessionVoteHead': data.SESSION_VOTE_HEAD, 'sessionCommentHead': data.SESSION_COMMENT_HEAD, 'sessionId': data.SESSION_ID});

	this.popupHistoryElements = BX.create("div", { props : { className : "bx-messenger-history"+(enableDisk? ' bx-messenger-history-with-disk': '')+(BX.browser.IsMac()? '': ' bx-messenger-custom-scroll') }, children: [
		this.popupHistoryPanel = BX.create("div", { props : { className : "bx-messenger-panel-wrap" }, children: historyPanel}),
		BX.create("div", { props : { className : "bx-messenger-history-types" }, children : [
			BX.create("span", { props : { className : "bx-messenger-history-type bx-messenger-history-type-message" }, children : [
				this.popupHistoryItems = BX.create("div", { props : { className : "bx-messenger-history-items" }, style : {height: this.popupHistoryItemsSize+'px'}, children : [
					this.popupHistoryBodyWrap = BX.create("div", { props : { className : "bx-messenger-history-items-wrap" }})
				]})
			]}),
			BX.create("span", { props : { className : "bx-messenger-history-type bx-messenger-history-type-disk" }, children : [
				this.popupHistoryFilesItems = BX.create("div", { props : { className : "bx-messenger-history-items" }, style : {height: this.popupHistoryItemsSize+'px'}, children : [
					this.popupHistoryFilesBodyWrap = BX.create("div", { props : { className : "bx-messenger-history-items-wrap" }})
				]})
			]})
		]})
	]});

	this.popupHistory = new BX.PopupWindow('bx-messenger-popup-history', null, {
		//parentPopup: this.popupMessenger,
		autoHide: false,
		zIndex: 100,
		draggable: {restrict: true},
		closeByEsc: true,
		events : {
			onPopupClose : function() { this.destroy(); },
			onPopupDestroy : BX.delegate(function() {
				this.popupHistory = null; this.historySearch = ''; this.setClosingByEsc(true);
				this.closeMenuPopup();
				var calend = BX.calendar.get()
				if (calend)
				{
					calend.Close();
				}
			}, this)
		},
		titleBar: {content: BX.create('span', {props : { className : "bx-messenger-title" }, html: BX.message('IM_M_HISTORY')})},
		closeIcon : {'right': '13px'},
		content : this.popupHistoryElements,
		contentColor : "white",
		noAllPaddings : true
	});
	this.popupHistory.show();
	BX.bind(this.popupHistory.popupContainer, "click", BX.MessengerCommon.preventDefault);

	if (data.HISTORY['chat'+chatId])
	{
		data.HISTORY['chat'+chatId].sort(BX.delegate(function (i, ii)
		{
			i = parseInt(i);
			ii = parseInt(ii);

			if (i > ii)
			{
				return 1;
			}
			else if (i < ii)
			{
				return -1;
			}
			else
			{
				return 0;
			}
		}, this));
	}


	this.drawHistory('chat'+chatId, data.HISTORY, false, false);
	if (enableDisk)
	{
		this.drawHistoryFiles(chatId, data.FILES, false);
	}

	BX.bindDelegate(this.popupHistoryElements, 'click', {className: 'bx-messenger-ajax'}, BX.delegate(function() {
		if (BX.proxy_context.getAttribute('data-entity') == 'user')
		{
			this.openPopupExternalData(BX.proxy_context, 'user', true, {'ID': BX.proxy_context.getAttribute('data-userId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'chat')
		{
			this.openPopupExternalData(BX.proxy_context, 'chat', true, {'ID': BX.proxy_context.getAttribute('data-chatId')})
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'openlines')
		{
			this.linesOpenHistory(BX.proxy_context.getAttribute('data-sessionId'));
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'network')
		{
			this.openMessenger('network'+BX.proxy_context.getAttribute('data-networkId'))
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'date')
		{
			this.openPopupMenu(BX.proxy_context, 'shareMenu');
		}
		else if (BX.proxy_context.getAttribute('data-entity') == 'phoneCallHistory')
		{
			this.openPopupExternalData(BX.proxy_context, 'phoneCallHistory', true, {'ID': BX.proxy_context.getAttribute('data-historyID')})
		}
	}, this));

	if (this.disk.enable)
	{
		BX.bindDelegate(this.popupHistoryFilesBodyWrap, "click", {className: 'bx-messenger-file-menu'}, BX.delegate(function(e) {
			var fileId = BX.proxy_context.parentNode.parentNode.getAttribute('data-fileId');
			var chatId = BX.proxy_context.parentNode.parentNode.getAttribute('data-chatId');
			this.openPopupMenu(BX.proxy_context, 'historyFileMenu', true, {fileId: fileId, chatId: chatId});
			return BX.PreventDefault(e);
		}, this));
	}
};

BX.MessengerChat.prototype.linesLivechatFormShow = function(type, stage, params)
{
	return false;
}
BX.MessengerChat.prototype.linesLivechatFormHide = function()
{
	return this.linesLivechatFormShow();
}

BX.MessengerChat.prototype.linesOpenMessenger = function(userCode, params)
{
	params = params || {};
	BX.MessengerCommon.linesOpenSession(userCode, params);
}

BX.MessengerChat.prototype.linesCreateLead = function()
{
	var chatId = this.getChatId();
	var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);
	if (session.crm == 'N')
	{
		BX.MessengerCommon.linesCreateLead(chatId);
	}
}
BX.MessengerChat.prototype.linesCloseDialog = function()
{
	var chatId = this.getChatId();

	BX.MessengerCommon.linesCloseDialog(chatId);
}
BX.MessengerChat.prototype.linesMarkAsSpam = function()
{
	var chatId = this.getChatId();

	BX.MessengerCommon.linesMarkAsSpam(chatId);
}
BX.MessengerChat.prototype.linesInterceptSession = function()
{
	var chatId = this.getChatId();

	BX.MessengerCommon.linesInterceptSession(chatId);
}
BX.MessengerChat.prototype.linesTogglePinMode = function()
{
	var chatId = this.getChatId();
	var flag;

	var session = BX.MessengerCommon.linesGetSession(this.chat[chatId]);
	if (session.pin == 'Y')
	{
		flag = 'N';
	}
	else
	{
		flag = 'Y';
	}

	BX.MessengerCommon.linesActivatePinMode(chatId, flag);
}
BX.MessengerChat.prototype.linesToggleSilentMode = function()
{
	var chatId = this.getChatId();
	var flag;

	if (this.linesSilentMode[chatId])
	{
		BX.removeClass(this.popupMessengerHiddenModeButton, 'bx-messenger-textarea-hidden-active');
		flag = 'N';
	}
	else
	{
		BX.addClass(this.popupMessengerHiddenModeButton, 'bx-messenger-textarea-hidden-active');
		flag = 'Y';
	}

	this.linesSilentMode[chatId] = flag == 'Y';

	this.tooltip(this.popupMessengerHiddenModeButton, BX.message(flag == 'Y'? 'IM_OL_CHAT_STEALTH_ON': 'IM_OL_CHAT_STEALTH_OFF'), {offsetLeft: 15, showOnce: flag == 'Y'? 'OL_STEALTH_ON': 'OL_STEALTH_OFF'});
	//BX.MessengerCommon.linesActivateSilentMode(chatId, flag);
}

BX.MessengerChat.prototype.linesOpenTransferDialog = function(params)
{
	if (this.BXIM.messenger.popupMessengerDialog && BX.hasClass(this.BXIM.messenger.popupMessengerDialog, "bx-messenger-chat-load-last-message"))
	{
		return false;
	}
	if (this.popupTransferDialog != null)
	{
		this.popupTransferDialog.close();
		return false;
	}
	if (this.popupChatDialog != null)
	{
		this.popupChatDialog.close();
		return false;
	}

	BX.MessengerCommon.contactListSearchClear();

	this.linesTransferUser = 0;
	var bindElement = params.bind? params.bind: null;
	params.maxUsers = 1;

	this.popupTransferDialog = new BX.PopupWindow('bx-messenger-popup-transfer', bindElement, {
		//parentPopup: this.popupMessenger,
		lightShadow : true,
		offsetTop: 5,
		offsetLeft: BX.MessengerCommon.isPage()? 5: -162,
		autoHide: true,
		buttons: [
			new BX.PopupWindowButton({
				text : BX.message('IM_OL_INVITE_TRANSFER'),
				className : "popup-window-button-accept",
				events : { click : BX.delegate(function() {
					var chatId = this.getChatId();
					this.linesSendTransfer(chatId);
				}, this) }
			}),
			new BX.PopupWindowButton({
				text : BX.message('IM_M_CHAT_BTN_CANCEL'),
				events : { click : BX.delegate(function() { this.popupTransferDialog.close(); }, this) }
			})
		],
		closeByEsc: true,
		zIndex: 200,
		events : {
			onPopupClose : function() { this.destroy() },
			onPopupDestroy : BX.delegate(function() { this.popupTransferDialog = null; this.popupTransferDialogContactListElements = null; }, this)
		},
		content : BX.create("div", { props : { className : "bx-messenger-popup-newchat-wrap" }, children: [
			BX.create("div", { props : { className : "bx-messenger-popup-newchat-caption" }, html: BX.message('IM_OL_TRANSFER_TEXT')}),
			BX.create("div", { props : { className : "bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even" }, children: [
				this.popupTransferDialogDestElements = BX.create("span", { props : { className : "bx-messenger-dest-items" }}),
				this.popupTransferDialogContactListSearch = BX.create("input", {props : { className : "bx-messenger-input" }, attrs: {type: "text", placeholder: BX.message(this.BXIM.bitrixIntranet? 'IM_M_SEARCH_PLACEHOLDER_CP': 'IM_M_SEARCH_PLACEHOLDER'), value: ''}})
			]}),
			this.popupTransferDialogContactListElements = BX.create("div", { props : { className : "bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap" }, children: []})
		]})
	});

	BX.MessengerCommon.contactListPrepareSearch('popupTransferDialogContactListElements', this.popupTransferDialogContactListElements, this.popupTransferDialogContactListSearch.value, {'viewChat': false, 'viewOpenChat': false, 'viewOffline': false, 'viewBot': false, 'viewTransferOlQueue': true, 'viewOnlyIntranet': true, 'viewOfflineWithPhones': false});

	BX.bindDelegate(this.popupTransferDialogContactListElements, "click", {className: 'bx-messenger-chatlist-more'}, BX.delegate(this.toggleChatListGroup, this));

	this.popupTransferDialog.setAngle({offset: BX.MessengerCommon.isPage()? 32: 198});
	this.popupTransferDialog.show();
	this.popupTransferDialogContactListSearch.focus();
	BX.addClass(this.popupTransferDialog.popupContainer, "bx-messenger-mark");
	BX.bind(this.popupTransferDialog.popupContainer, "click", BX.PreventDefault);

	BX.bind(this.popupTransferDialogContactListSearch, "keyup", BX.delegate(function(event){
		if (event.keyCode == 16 || event.keyCode == 17 || event.keyCode == 18 || event.keyCode == 20 || event.keyCode == 244 || event.keyCode == 224 || event.keyCode == 91)
			return false;

		if (event.keyCode == 27 && this.popupTransferDialogContactListSearch.value != '')
			BX.MessengerCommon.preventDefault(event);

		if (event.keyCode == 27)
		{
			this.popupTransferDialogContactListSearch.value = '';
		}

		if (event.keyCode == 8)
		{
			var lastId = null;
			var arMentionSort = BX.util.objectSort(this.popupChatDialogUsers, 'date', 'asc');
			for (var i = 0; i < arMentionSort.length; i++)
			{
				lastId = arMentionSort[i].id;
			}
			if (lastId)
			{
				delete this.popupChatDialogUsers[lastId];
				this.linesRedrawTransferDialogDest();
			}
		}

		if (event.keyCode == 13)
		{
			this.popupTransferDialogContactListSearch.value = '';
			var item = BX.findChildByClassName(this.popupTransferDialogContactListElements, "bx-messenger-cl-item");
			if (item)
			{
				if (this.popupTransferDialogContactListSearch.value != '')
				{
					this.popupTransferDialogContactListSearch.value = '';
				}
				if (this.linesTransferUser > 0)
				{
					params.maxUsers = params.maxUsers+1;
					if (params.maxUsers > 0)
						BX.show(this.popupTransferDialogContactListSearch);
					this.linesTransferUser = 0;
				}
				else
				{
					if (params.maxUsers > 0)
					{
						params.maxUsers = params.maxUsers-1;
						if (params.maxUsers <= 0)
							BX.hide(this.popupTransferDialogContactListSearch);

						this.linesTransferUser = item.getAttribute('data-userId');
					}
				}
				this.linesRedrawTransferDialogDest();
			}
		}

		BX.MessengerCommon.contactListPrepareSearch('popupTransferDialogContactListElements', this.popupTransferDialogContactListElements, this.popupTransferDialogContactListSearch.value, {'viewChat': false, 'viewOpenChat': false, 'viewOffline': false, 'viewBot': false, 'viewTransferOlQueue': true, 'viewOnlyIntranet': true, 'viewOfflineWithPhones': false, timeout: 100});
	}, this));
	BX.bindDelegate(this.popupTransferDialogDestElements, "click", {className: 'bx-messenger-dest-del'}, BX.delegate(function() {
		this.linesTransferUser = 0;
		params.maxUsers = params.maxUsers+1;
		if (params.maxUsers > 0)
			BX.show(this.popupTransferDialogContactListSearch);
		this.linesRedrawTransferDialogDest();
	}, this));
	BX.bindDelegate(this.popupTransferDialogContactListElements, "click", {className: 'bx-messenger-cl-item'}, BX.delegate(function(e) {
		if (this.popupTransferDialogContactListSearch.value != '')
		{
			this.popupTransferDialogContactListSearch.value = '';
			BX.MessengerCommon.contactListPrepareSearch('popupTransferDialogContactListElements', this.popupTransferDialogContactListElements, '', {'viewChat': false, 'viewOpenChat': false, 'viewOffline': false, 'viewBot': false, 'viewTransferOlQueue': true, 'viewOnlyIntranet': true, 'viewOfflineWithPhones': false});
		}
		if (this.linesTransferUser)
		{
			params.maxUsers = params.maxUsers+1;
			this.linesTransferUser = 0;
		}
		else
		{
			if (params.maxUsers <= 0)
				return false;
			params.maxUsers = params.maxUsers-1;
			this.linesTransferUser = BX.proxy_context.getAttribute('data-userId');
		}

		if (params.maxUsers <= 0)
			BX.hide(this.popupTransferDialogContactListSearch);
		else
			BX.show(this.popupTransferDialogContactListSearch);

		this.linesRedrawTransferDialogDest();

		return BX.PreventDefault(e);
	}, this));
};

BX.MessengerChat.prototype.linesRedrawTransferDialogDest = function()
{
	var content = '';
	var count = 0;

	var isQueue = this.linesTransferUser.toString().substr(0, 5) == 'queue';
	var queueId = isQueue? this.linesTransferUser.toString().substr(5): 0;

	if (isQueue)
	{
		var queueName = this.linesTransferUser;
		for (var i = 0; i < this.openlines.queue.length; i++)
		{
			if (this.openlines.queue[i].id == queueId)
			{
				queueName = this.openlines.queue[i].name;
				break;
			}
		}

		count++;
		content += '<span class="bx-messenger-dest-block bx-messenger-dest-block-queue">'+
						'<span class="bx-messenger-dest-text">'+queueName+'</span>'+
					'<span class="bx-messenger-dest-del" data-userId="'+this.linesTransferUser+'"></span></span>';
	}
	else if (this.linesTransferUser > 0)
	{
		count++;
		content += '<span class="bx-messenger-dest-block'+(this.users[this.linesTransferUser].extranet? ' bx-messenger-dest-block-extranet': '')+'">'+
						'<span class="bx-messenger-dest-text">'+(this.users[this.linesTransferUser].name)+'</span>'+
					'<span class="bx-messenger-dest-del" data-userId="'+this.linesTransferUser+'"></span></span>';
	}

	this.popupTransferDialogDestElements.innerHTML = content;
	this.popupTransferDialogDestElements.parentNode.scrollTop = this.popupTransferDialogDestElements.parentNode.offsetHeight;

	if (BX.util.even(count))
		BX.addClass(this.popupTransferDialogDestElements.parentNode, 'bx-messenger-popup-newchat-dest-even');
	else
		BX.removeClass(this.popupTransferDialogDestElements.parentNode, 'bx-messenger-popup-newchat-dest-even');

	this.popupTransferDialogContactListSearch.focus();
};

BX.MessengerChat.prototype.linesSendTransfer = function(chatId)
{
	if (this.BXIM.messenger.blockJoinChat[chatId])
		return false;

	if (this.chat[chatId] && this.chat[chatId].entity_type != 'LINES')
		return false;

	if (this.linesTransferUser <= 0)
		return false;

	if (this.popupTransferDialog)
		this.popupTransferDialog.close();

	this.BXIM.messenger.blockJoinChat[chatId] = true;

	if(!BX.MessengerCommon.userInChat(chatId))
		BX.MessengerCommon.dialogCloseCurrent(true);
	else
		BX.MessengerCommon.dialogCloseCurrent(false);

	if (this.linesTransferUser.toString().substr(0, 5) == 'queue')
	{
		var transferQueueId = this.linesTransferUser.substr(5);
		for (var i = 0; i < this.BXIM.messenger.openlines.queue.length; i++)
		{
			if (this.BXIM.messenger.openlines.queue[i].id == transferQueueId)
			{
				this.BXIM.messenger.openlines.queue[i].transfer_count = parseInt(this.BXIM.messenger.openlines.queue[i].transfer_count)+1;
			}
		}
	}

	BX.ajax({
		url: this.BXIM.pathToAjax+'?LINES_TRANSFER&V='+this.BXIM.revision+'&logTag='+BX.MessengerCommon.getLogTrackingParams({
			name: 'imopenlines.operator.transfer',
			dialog: BX.MessengerCommon.getDialogDataForTracking('chat'+chatId),
			data: {
				timTransferType: this.linesTransferUser.toString().substr(0, 5) == 'queue'? 'queue': 'user'
			}
		}),
		method: 'POST',
		dataType: 'json',
		timeout: 60,
		data: {'COMMAND': 'transfer', 'CHAT_ID' : chatId, 'TRANSFER_ID': this.linesTransferUser, 'IM_OPEN_LINES' : 'Y', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(){
			this.BXIM.messenger.blockJoinChat[chatId] = false;
		}, this),
		onfailure: BX.delegate(function(){
			this.BXIM.messenger.blockJoinChat[chatId] = false;
		}, this)
	});
};

BX.MessengerChat.prototype.linesCommentHeadAdd = function(rating, comment, bindElement)
{
	if(!rating)
	{
		rating = null;
	}
	if(!comment)
	{
		comment = null;
	}

	var elementSessionId = BX.proxy_context.getAttribute('data-sessionId');
	var context = BX.proxy_context.getAttribute('data-context');
	var proxyContext = BX.proxy_context;

	if(this.openlines)
	{
		if(this.openlines.voteRatingHead)
		{
			var saveRating = this.openlines.voteRatingHead[elementSessionId];
			if(saveRating && saveRating != null)
			{
				rating = saveRating;
			}
		}

		if(this.openlines.voteCommentHead)
		{
			var saveComment = this.openlines.voteCommentHead[elementSessionId];
			if(saveComment && saveComment != null)
			{
				comment = saveComment;
			}
		}
	}

	if (this.popupRatingCommentHead)
	{
		this.popupRatingCommentHead.destroy();
	}

	var ratingSelect = BX.delegate(function() {
		var elementRating = BX.proxy_context.getAttribute('data-rating');
		var ratingElements = BX.findChildren(BX('bx-messenger-popup-head-rating'), {
				"class" : "bx-lines-rating-popup-star"
			},
			true
		);

		if(ratingElements)
		{
			ratingElements.forEach(function(item, i, ratingElements) {
				if(item.getAttribute('data-rating') == elementRating)
				{
					BX.addClass(item, 'bx-lines-rating-popup-star-active');
				}
				else
				{
					BX.removeClass(item, 'bx-lines-rating-popup-star-active');
				}
			});
		}
	},this);

	this.popupRatingCommentHead = new BX.PopupWindow('bx-messenger-popup-head-rating', BX.proxy_context, {
		zIndex: 3001,
		lightShadow : true,
		bindOptions: {position: "top"},

		overlay: {opacity: 0, backgroundColor: "#000000"},
		className: 'bx-lines-rating-popup-window',
		autoHide: true,
		closeByEsc : true,
		bindOnResize: false,
		closeIcon: true,
		angle: context === 'history'?{offset: 37}:{offset: 50},
		// closeIcon: { top: "10px", right: "15px" },
		titleBar: context !== 'im' && context !== 'history'?BX.message('IM_OL_COMMENT_HEAD'):null,
		noAllPaddings: context !== 'im'?true:false,
		buttons: [
			new BX.PopupWindowButton({
				text: context === 'history'?BX.message('IM_OL_COMMENT_HEAD_BUTTON_VOTE'):BX.message('IM_OL_COMMENT_HEAD_BUTTON_SAVE'),
				className: context !== 'im'?'ui-btn ui-btn-primary':'popup-window-button-accept',
				events: {
					click:  BX.delegate(function() {
						var commentHeadTextarea = BX.findChild(BX('bx-messenger-popup-head-rating'), {
								"class" : "bx-lines-comment-head-textarea"
							},
							true
						);

						if(commentHeadTextarea)
						{
							var newComment = commentHeadTextarea.value;
						}

						if(newComment && newComment.length > 10000)
						{
							newComment = newComment.substr(0, 10000) + '...';
						}

						if(context !== 'history')
						{
							var newRating = null;

							if(newComment !==null)
							{
								proxyContext.innerText = newComment;
							}
						}
						else
						{
							var popupStarActive = BX.findChild(BX('bx-messenger-popup-head-rating'), {
									"class" : "bx-lines-rating-popup-star-active"
								},
								true
							);

							if(popupStarActive)
							{
								var newRating = popupStarActive.getAttribute('data-rating');
							}

							if (bindElement && newRating)
								bindElement.setAttribute('data-rating', newRating);
						}

						if(BX('bx-messenger-popup-history') && newComment !==null)
						{
							var itemCommentEdit = BX.findChildren(BX('bx-messenger-popup-history'), {
									"class" : "bx-messenger-content-item-vote-comment-edit",
									"data-sessionId": elementSessionId
								},
								true
							);

							if(itemCommentEdit)
							{
								itemCommentEdit.forEach(function(item, i, itemCommentEdit) {
									item.innerText = newComment;
								});
							}
						}

						if(BX('bx-messenger-popup-history') && newRating !==null)
						{
							var itemRatingEdit = BX.findChildren(BX('bx-messenger-popup-history'), {
									"class" : "bx-lines-rating-box-current",
									"data-sessionId": elementSessionId
								},
								true
							);

							if(itemRatingEdit)
							{
								itemRatingEdit.forEach(function(item, i, itemRatingEdit) {
									item.style.width = (newRating*20)+'%';
								});
							}
						}

						BX.MessengerCommon.linesVoteHeadSend(elementSessionId, newRating, newComment);

						this.popupRatingCommentHead.close();
					}, this)
				}
			})
		],
		events : {
			onPopupClose : BX.delegate(function() {
				BX.proxy_context.destroy()
			}, this),
			onPopupDestroy : BX.delegate(function() {
				this.popupRatingCommentHead = null;
			}, this)
		},
		content: BX.create('div', {props: {className: 'bx-lines-rating-popup'}, children: [
				context === 'im'?BX.create('span', {props: {className: 'bx-lines-rating-popup-im-title'}, html: BX.message('IM_OL_COMMENT_HEAD')}):null,
				context === 'history'?BX.create('div', {props: {className: 'bx-lines-rating-popup-title'}, children: [
						BX.create('div', {props: {className: 'bx-lines-rating-popup-stars-title'}, html: BX.message('IM_OL_VOTE') + ': '}),
						BX.create('div', {props: {className: 'bx-lines-rating-popup-stars-wrapper'}, children: [
								BX.create('div', {attrs: {'data-rating': 5, 'data-sessionId': elementSessionId}, props: {className: 'bx-lines-rating-popup-star' + (rating==5?' bx-lines-rating-popup-star-active':'')}, events: {click: ratingSelect}}),
								BX.create('div', {attrs: {'data-rating': 4, 'data-sessionId': elementSessionId}, props: {className: 'bx-lines-rating-popup-star' + (rating==4?' bx-lines-rating-popup-star-active':'')}, events: {click: ratingSelect}}),
								BX.create('div', {attrs: {'data-rating': 3, 'data-sessionId': elementSessionId}, props: {className: 'bx-lines-rating-popup-star' + (rating==3?' bx-lines-rating-popup-star-active':'')}, events: {click: ratingSelect}}),
								BX.create('div', {attrs: {'data-rating': 2, 'data-sessionId': elementSessionId}, props: {className: 'bx-lines-rating-popup-star' + (rating==2?' bx-lines-rating-popup-star-active':'')}, events: {click: ratingSelect}}),
								BX.create('div', {attrs: {'data-rating': 1, 'data-sessionId': elementSessionId}, props: {className: 'bx-lines-rating-popup-star' + (rating==1?' bx-lines-rating-popup-star-active':'')}, events: {click: ratingSelect}}),
							]})
					]}):null,
				BX.create('textarea', {props: {className: 'bx-lines-comment-head-textarea'}, html: comment, attrs: {'placeholder': BX.message('IM_OL_COMMENT_HEAD_TEXT'), 'data-sessionId': elementSessionId}}),
			]})
	});
	if(context === 'im')
	{
		BX.addClass(this.popupRatingCommentHead.popupContainer, "bx-messenger-mark");
	}

	this.popupRatingCommentHead.show();
}

BX.IM.Desktop = function(BXIM, params)
{
	this.BXIM = BXIM;

	this.initDate = new Date();

	this.clientVersion = false;
	this.markup = BX('placeholder-messanger');
	this.htmlWrapperHead = null;
	this.showNotifyId = {};
	this.showMessageId = {};
	this.lastSetIcon = null;

	this.topmostWindow = null;
	this.topmostWindowTimeout = null;
	this.topmostWindowCloseTimeout = null;

	this.minCallVideoWidth = 320;
	this.minCallVideoHeight = 180;
	this.minCallWidth = 320;
	this.minCallHeight = 35;
	this.minHistoryWidth = 608;
	this.minHistoryDiskWidth = 780;
	this.minHistoryHeight = 593;
	this.minSettingsWidth = 620;
	this.startSettingsHeight = BX.browser.IsMac()? 448: 357;
	this.minSettingsHeight = 137;

	if (this.BXIM.init && BX.MessengerCommon.isPage())
	{
		BX.MessengerWindow.addTab({
			id: 'config',
			title: BX.message('IM_SETTINGS'),
			order: 150,
			target: false,
			events: {
				open: BX.delegate(function(e){
					this.BXIM.openSettings({'active': BX.MessengerWindow.getCurrentTab()});
				}, this)
			}
		});

		BX.MessengerWindow.addSeparator({
			order: 500
		});

		if (!this.BXIM.bitrix24net)
		{
			BX.MessengerWindow.addTab({
				id: 'im-lf',
				title: BX.message('IM_DESKTOP_GO_SITE').replace('#COUNTER#', ''),
				order: 550,
				target: false,
				events: {
					open: BX.delegate(function(){
						BX.MessengerWindow.browse(BX.MessengerWindow.getCurrentUrl()+this.BXIM.path.lf);
					}, this)
				}
			});
		}

		if (this.BXIM.animationSupport && /Microsoft Windows NT 5/i.test(navigator.userAgent))
			this.BXIM.animationSupport = false;

		if (BX.MessengerCommon.isDesktop())
			this.BXIM.changeFocus(BX.desktop.windowIsFocused());

		if (this.BXIM.context == 'DESKTOP' || this.BXIM.context == 'POPUP-FULLSCREEN')
		{
			BX.bind(window, "keydown", BX.delegate(function(e) {
				if (!BX.MessengerWindow.isPopupShow())
					return false;

				if (!(BX.MessengerWindow.getCurrentTab() == 'im' || BX.MessengerWindow.getCurrentTab() == 'notify' || BX.MessengerWindow.getCurrentTab() == 'im-phone' || BX.MessengerWindow.getCurrentTab() == 'im-ol'))
					return false;

				if (e.keyCode == 27) // TODO check
				{
					if (
						BX.SidePanel
						&& BX.SidePanel.Instance.isOpen()
						&& BX.SidePanel.Instance.isOnTop()
					)
					{
						BX.SidePanel.Instance.close()
					}
					else if (this.messenger.popupSmileMenu)
					{
						this.messenger.popupSmileMenu.destroy();
					}
					else if (this.messenger.popupMessengerFileButton != null && BX.hasClass(this.messenger.popupMessengerFileButton, 'bx-messenger-textarea-file-active'))
					{
						this.messenger.closePopupFileMenu();
					}
					else if (this.messenger.popupPopupMenu)
					{
						this.messenger.popupPopupMenu.destroy();
					}
					else if (this.messenger.popupChatDialog && this.messenger.popupChatDialogContactListSearch.value.length >= 0)
					{
						this.messenger.popupChatDialogContactListSearch.value = '';
					}
					else if (this.BXIM.extraOpen)
					{
						//BX.MessengerWindow.changeTab('im');
						//this.messenger.extraClose(true);
					}
					else if (this.messenger.renameChatDialogInput && this.messenger.renameChatDialogInput.value.length > 0)
					{
						this.messenger.renameChatDialogInput.value = BX.util.htmlspecialcharsback(this.messenger.chat[this.messenger.currentTab.toString().substr(4)].name);
						this.messenger.popupMessengerTextarea.focus();
					}
					else if (this.messenger.popupContactListSearchInput && (this.messenger.popupContactListSearchInput.value.length > 0 || this.messenger.chatList))
					{
						BX.MessengerCommon.contactListSearch({'keyCode': 27});
						this.messenger.popupMessengerTextarea.focus();
					}
					else
					{
						if (BX.util.trim(this.messenger.popupMessengerEditTextarea.value).length > 0)
						{
							this.messenger.editMessageCancel();
						}
						else if (BX.util.trim(this.messenger.popupMessengerTextarea.value).length <= 0 && !this.BXIM.callController.hasActiveCall())
						{
							this.messenger.textareaHistory[this.messenger.currentTab] = '';
							this.messenger.popupMessengerTextarea.value = "";
							if (BX.MessengerCommon.isDesktop())
							{
								BX.desktop.windowCommand('hide');
							}
							else if (this.messenger.popupMessenger)
							{
								this.messenger.popupMessenger.destroy();
							}
						}
						else if (e.shiftKey)
						{
							this.messenger.textareaHistory[this.messenger.currentTab] = '';
							this.messenger.popupMessengerTextarea.value = "";
						}
					}
				}
				else if (e.altKey == true)
				{
					if (e.keyCode == 49 || e.keyCode == 50 || e.keyCode == 51
						|| e.keyCode == 52 || e.keyCode == 53 || e.keyCode == 54
						|| e.keyCode == 55 || e.keyCode == 56 || e.keyCode == 57)
					{
						this.messenger.openMessenger(this.messenger.recentListIndex[parseInt(e.keyCode)-49]);
						BX.PreventDefault(e);
					}
					else if (e.keyCode == 48)
					{
						this.messenger.popupContactListSearchInput.focus();
						BX.PreventDefault(e);
					}
				}
			}, this));
		}

		if (BX.MessengerCommon.isDesktop())
		{
			BX.desktop.syncPause(false);

			BX.desktop.addCustomEvent("bxImClickNewMessage", BX.delegate(function(userId) {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('im');
				this.BXIM.openMessenger(userId);
				if (BX.SidePanel)
				{
					BX.SidePanel.Instance.closeAll();
				}
			}, this));
			BX.desktop.addCustomEvent("bxImClickCloseMessage", BX.delegate(function(userId) {
				BX.MessengerCommon.readMessage(userId);
			}, this));
			BX.desktop.addCustomEvent("bxImClickCloseNotify", BX.delegate(function(notifyId) {
				this.BXIM.notify.viewNotify(notifyId);
			}, this));
			BX.desktop.addCustomEvent("bxImClickNotify", BX.delegate(function() {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('notify');
				if (BX.SidePanel)
				{
					BX.SidePanel.Instance.closeAll();
				}
			}, this));
			BX.desktop.addCustomEvent("bxCallDecline", BX.delegate(function() {
				var callVideo = this.webrtc.callVideo;
				this.webrtc.callSelfDisabled = true;
				this.webrtc.callCommand(this.webrtc.callChatId, 'decline', {'ACTIVE': this.webrtc.callActive? 'Y': 'N', 'INITIATOR': this.webrtc.initiator? 'Y': 'N'});
				this.BXIM.playSound('stop');
				this.webrtc.callOverlayClose();
			}, this));
			BX.desktop.addCustomEvent("bxPhoneAnswer", BX.delegate(function() {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('im');

				this.BXIM.stopRepeatSound('ringtone');
				this.webrtc.phoneIncomingAnswer();

				this.closeTopmostWindow();
			}, this));
			BX.desktop.addCustomEvent("bxPhoneSkip", BX.delegate(function() {
				this.webrtc.phoneCallFinish();
				this.webrtc.callAbort();
				this.webrtc.callOverlayClose();
			}, this));
			BX.desktop.addCustomEvent("bxCallOpenDialog", BX.delegate(function() {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('im');
				if (this.BXIM.dialogOpen)
				{
					if (this.webrtc.callOverlayUserId > 0)
					{
						this.messenger.openChatFlag = false;
						BX.MessengerCommon.openDialog(this.webrtc.callOverlayUserId, false, false);
					}
					else
					{
						this.messenger.openChatFlag = true;
						BX.MessengerCommon.openDialog('chat'+this.webrtc.callOverlayChatId, false, false);
					}
				}
				else
				{
					if (this.webrtc.callOverlayUserId > 0)
					{
						this.messenger.openChatFlag = false;
						this.messenger.currentTab = this.webrtc.callOverlayUserId;
					}
					else
					{
						this.messenger.openChatFlag = true;
						this.messenger.currentTab = 'chat'+this.webrtc.callOverlayChatId;
					}
					this.messenger.extraClose(true, false);
				}
				this.webrtc.callOverlayToggleSize(false);
			}, this));
			BX.desktop.addCustomEvent("bxCallMuteMic", BX.delegate(function() {
				if (this.webrtc.phoneCurrentCall)
					this.webrtc.phoneToggleAudio();
				else
					this.webrtc.toggleAudio();

				var icon = BX.findChildByClassName(BX('bx-messenger-call-overlay-button-mic'), "bx-messenger-call-overlay-button-mic");
				if (icon)
					BX.toggleClass(icon, 'bx-messenger-call-overlay-button-mic-off');
			}, this));
			BX.desktop.addCustomEvent("bxCallAnswer", BX.delegate(function(chatId, userId, video, callToGroup) {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('im');
				this.webrtc.callActive = true;

				BX.ajax({
					url: this.BXIM.pathToCallAjax+'?CALL_ANSWER&V='+this.BXIM.revision,
					method: 'POST',
					dataType: 'json',
					timeout: 30,
					data: {'IM_CALL' : 'Y', 'COMMAND': 'answer', 'CHAT_ID': chatId, 'CALL_TO_GROUP': callToGroup? 'Y': 'N', 'RECIPIENT_ID' : this.callUserId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
					onsuccess: BX.delegate(function(){
						this.webrtc.callDialog();
					}, this)
				});
			}, this));
			BX.desktop.addCustomEvent("bxCallJoin", BX.delegate(function(chatId, userId, video, callToGroup) {
				BX.desktop.windowCommand("show");
				BX.desktop.changeTab('im');
				this.webrtc.callAbort();
				this.webrtc.callOverlayClose(false);
				this.webrtc.callInvite(callToGroup? 'chat'+chatId: userId, video);
			}, this));

			BX.desktop.addCustomEvent("bxImClearHistory", BX.delegate(function(userId) {
				this.messenger.history[userId] = [];
				this.messenger.showMessage[userId] = [];

				if (this.BXIM.init)
					BX.MessengerCommon.drawTab(userId);
			}, this));
			BX.desktop.addCustomEvent("bxSaveSettings", BX.delegate(function(settings) {
				this.BXIM.settings = settings;
				if (this.BXIM.messenger != null)
				{
					var changeTab = BX.MessengerWindow.currentTab == 'im-ol' || BX.MessengerWindow.currentTab == 'im';
					BX.MessengerCommon.drawTab(this.messenger.currentTab, true, 0, changeTab);
					BX.MessengerCommon.userListRedraw(true);
					if (this.BXIM.messenger.popupMessengerTextareaSendType)
						this.BXIM.messenger.popupMessengerTextareaSendType.innerHTML = this.BXIM.settings.sendByEnter? 'Enter': (BX.browser.IsMac()? "&#8984;+Enter": "Ctrl+Enter");

					if (BX.MessengerCommon.isPage() && this.BXIM.bitrixOpenLines)
					{
						this.messenger.toggleLinesTab();
						this.messenger.toggleLinesNewGroup();
					}
				}
				if(this.BXIM.webrtc != null)
				{
					this.BXIM.webrtc.readDefaults();
				}
			}, this));
			BX.desktop.addCustomEvent("bxSaveColor", BX.delegate(function(params) {
				BX.MessengerCommon.setColor(params.color, params.chatId);
			}, this));
			BX.desktop.addCustomEvent("bxImClickConfirmNotify", BX.delegate(function(notifyId) {
				delete this.BXIM.notify.notify[notifyId];
				delete this.BXIM.notify.unreadNotify[notifyId];
				delete this.BXIM.notify.flashNotify[notifyId];
				this.BXIM.notify.updateNotifyCount(false);
				if (this.BXIM.openNotify)
					this.BXIM.notify.openNotify(true, true);
			}, this));

			BX.desktop.addCustomEvent("BXUserAway", BX.delegate(this.onAwayAction, this));

			BX.desktop.addCustomEvent("BXTrayAction", BX.delegate(this.onTrayAction, this));

			BX.desktop.addCustomEvent("BXWakeAction", BX.delegate(this.onWakeAction, this));

			BX.desktop.addCustomEvent("BXForegroundChanged", BX.delegate(function(focus)
			{
				clearTimeout(this.BXIM.windowFocusTimeout);
				this.BXIM.windowFocusTimeout = setTimeout(BX.delegate(function(){
					this.BXIM.changeFocus(focus);
					if (this.BXIM.isFocus() && this.messenger && this.messenger.unreadMessage[this.messenger.currentTab] && this.messenger.unreadMessage[this.messenger.currentTab].length>0)
						BX.MessengerCommon.readMessage(this.messenger.currentTab);

					if (this.BXIM.isFocus('notify') && this.notify)
					{
						if (this.notify.unreadNotifyLoad)
							this.notify.loadNotify();
						else if (this.notify.notifyUpdateCount > 0)
							this.notify.viewNotifyAll();
					}
				}, this), focus? 500: 0);
			}, this));

			BX.desktop.addCustomEvent("BXTopmostMoved", BX.delegate(function(x, y)
			{
				x = parseInt(x);
				y = parseInt(y);
				if (x >= 0 && y >= 0)
				{
					BXDesktopSystem.StoreSettings('global_topmost_x', ''+x);
					BXDesktopSystem.StoreSettings('global_topmost_y', ''+y);
				}
			}, this));

			BX.desktop.addCustomEvent("BXTrayMenu", BX.delegate(function (){
				var lFcounter = BXIM.notify.getCounter('**');
				var notifyCounter = BXIM.notify.getCounter('im_notify');
				var messengerCounter = BXIM.notify.getCounter('im_message');

				BX.desktop.addTrayMenuItem({Id: "messenger", Order: 100,Title: (BX.message('IM_DESKTOP_OPEN_MESSENGER') || '').replace('#COUNTER#', (messengerCounter>0? '('+messengerCounter+')':'')), Callback: function(){
					BX.desktop.windowCommand("show");
					BX.desktop.changeTab('im');
					BXIM.messenger.openMessenger(BXIM.messenger.currentTab);
				},Default: true	});

				BX.desktop.addTrayMenuItem({Id: "notify",Order: 120,Title: (BX.message('IM_DESKTOP_OPEN_NOTIFY') || '').replace('#COUNTER#', (notifyCounter>0? '('+notifyCounter+')':'')), Callback: function(){
					BX.desktop.windowCommand("show");
					BX.desktop.changeTab('notify');
					BXIM.notify.openNotify(false, true);
				}});
				BX.desktop.addTrayMenuItem({Id: "bdisk",Order: 130, Title: BX.message('IM_DESKTOP_BDISK'), Callback: function(){
					if (BX.desktop.diskAttachStatus())
					{
						BX.desktop.diskOpenFolder();
					}
					else
					{
						BX.desktop.windowCommand("show");
						BX.desktop.changeTab('disk');
					}
				}});
				BX.desktop.addTrayMenuItem({Id: "site",Order: 140, Title: (BX.message('IM_DESKTOP_GO_SITE') || '').replace('#COUNTER#', (lFcounter>0? '('+lFcounter+')':'')), Callback: function(){
					BX.desktop.browse(BX.desktop.getCurrentUrl());
				}});
				BX.desktop.addTrayMenuItem({Id: "separator1",IsSeparator: true, Order: 150});
				BX.desktop.addTrayMenuItem({Id: "settings",Order: 160, Title: BX.message('IM_DESKTOP_SETTINGS'), Callback: function(){
					BXIM.openSettings();
				}});
				BX.desktop.addTrayMenuItem({Id: "separator2",IsSeparator: true,Order: 1000});
				BX.desktop.addTrayMenuItem({Id: "logout",Order: 1010, Title: BX.message('IM_DESKTOP_LOGOUT'),Callback: function(){ BX.desktop.logout(false, 'tray_menu') }});
			}, this));
			BX.desktop.addCustomEvent("BXProtocolUrl", BX.delegate(function(command, params) {
				console.log('BXProtocolUrl', command, params? JSON.stringify(params): "");
				params = params? params: {}
				if (params.bitrix24net && params.bitrix24net == 'Y' && !this.BXIM.bitrix24net)
					return false;

				for (var i in params)
				{
					params[i] = decodeURIComponent(params[i]);
				}

				if (command == 'messenger')
				{
					if (params.dialog)
					{
						this.BXIM.openMessenger(params.dialog);
					}
					else if (params.chat)
					{
						this.BXIM.openMessenger('chat'+params.chat);
					}
					else
					{
						this.BXIM.openMessenger();
					}
					if (params.tab)
					{
						BX.MessengerWindow.changeTab(params.tab, true);
					}
					BX.desktop.setActiveWindow();
					BX.desktop.windowCommand("show");
				}
				else if (command == 'chat' && params.id)
				{
					this.BXIM.openMessenger('chat'+params.id);
					BX.desktop.setActiveWindow();
					BX.desktop.windowCommand("show");
				}
				else if (command == 'chat' && params.create)
				{
					this.BXIM.openMessenger();
					this.BXIM.messenger.openChatCreateForm(params.create);
					BX.desktop.setActiveWindow();
					BX.desktop.windowCommand("show");
				}
				else if (command == 'notify')
				{
					this.BXIM.openNotify({'force': true});
					BX.desktop.setActiveWindow();
					BX.desktop.windowCommand("show");
				}
				else if (command == 'history' && params.user)
				{
					if (params.dialog)
					{
						this.BXIM.openHistory(params.dialog);
					}
					else if (params.chat)
					{
						this.BXIM.openHistory('chat'+params.chat);
					}
					BX.desktop.setActiveWindow();
					BX.desktop.windowCommand("show");
				}
				else if (command == 'callto')
				{
					if (params.video)
					{
						this.BXIM.callTo(params.video, true);
						BX.desktop.setActiveWindow();
						BX.desktop.windowCommand("show");
					}
					else if (params.audio)
					{
						this.BXIM.callTo(params.audio, false);
						BX.desktop.setActiveWindow();
						BX.desktop.windowCommand("show");
					}
					else if (params.phone)
					{
						if (params.params)
						{
							this.webrtc.phoneCall(unescape(params.phone), BX.desktopUtils.decodeParams(params.params));
						}
						else
						{
							this.BXIM.phoneTo(unescape(params.phone));
						}
					}

				}
				else if (command == 'calllist')
				{
					if(!params.id)
						return;

					this.BXIM.startCallList(params.id, BX.desktopUtils.decodeParams(params.params));
				}
			}, this));

			BX.addCustomEvent("onPullEvent-webdav", function(command,params)
			{
				BX.desktop.diskReportStorageNotification(command, params);
			});
		}

		BX.addCustomEvent("onPullEvent-main", BX.delegate(function(command,params)
		{
			if (command == 'user_counter' && params[BX.message('SITE_ID')] && params[BX.message('SITE_ID')].hasOwnProperty('**'))
			{
				var lfCounter = parseInt(params[BX.message('SITE_ID')]['**']);
				this.notify.updateNotifyCounters({'**':lfCounter});
			}
		}, this));
	}
};

BX.IM.Desktop.prototype.run = function()
{
	return BX.MessengerCommon.isPage();
};

BX.IM.Desktop.prototype.ready = function()
{
	return BX.MessengerCommon.isDesktop();
};

BX.IM.Desktop.prototype.getCurrentUrl = function()
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	return BX.desktop.getCurrentUrl();
}

BX.IM.Desktop.prototype.enableInVersion = function(version)
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	return BX.desktop.enableInVersion(version);
}

BX.IM.Desktop.prototype.addCustomEvent = function(eventName, eventHandler)
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	BX.desktop.addCustomEvent(eventName, eventHandler);
}

BX.IM.Desktop.prototype.onCustomEvent = function(windowTarget, eventName, arEventParams)
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	BX.desktop.onCustomEvent(windowTarget, eventName, arEventParams);
};

BX.IM.Desktop.prototype.windowCommand = function(command, currentWindow)
{
	if (!BX.MessengerCommon.isDesktop()) return false;

	if (typeof(currentWindow) == "undefined")
		BX.desktop.windowCommand(command)
	else
		BX.desktop.windowCommand(currentWindow, command)
};

BX.IM.Desktop.prototype.browse = function(url)
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	BX.desktop.browse(url);
};

BX.IM.Desktop.prototype.drawOnPlaceholder = function(content)
{
	if (this.markup == null || !BX.type.isDomNode(content)) return false;

	this.markup.innerHTML = '';
	this.markup.appendChild(content);
};

BX.IM.Desktop.prototype.openNewNotify = function(notifyId, content, js)
{
	if (!BX.MessengerCommon.isDesktop()) return;
	if (content == "") return false;

	if (this.showNotifyId[notifyId])
		return false;

	this.showNotifyId[notifyId] = true;

	var sendNotify = {};
	sendNotify[notifyId] = this.BXIM.notify.notify[notifyId];

	BXDesktopSystem.ExecuteCommand('notification.show.html', this.getHtmlPage(content, js, {'notify' : sendNotify}, 'im-notify-popup'));
};

BX.IM.Desktop.prototype.openNewMessage = function(messageId, content, js)
{
	if (!BX.MessengerCommon.isDesktop()) return;
	if (content == "") return false;

	if (this.showMessageId[messageId])
		return false;

	this.showMessageId[messageId] = true;

	BXDesktopSystem.ExecuteCommand('notification.show.html', this.getHtmlPage(content, js, true, 'im-notify-popup'));
};

BX.IM.Desktop.prototype.adjustSize = function()
{
	documentOffsetHeight = document.body.offsetHeight;
	if (BX.MessengerCommon.isPage() && !BX.MessengerCommon.isDesktop())
	{
		if (this.BXIM.context == 'POPUP-FULLSCREEN' && BX.hasClass(BX.MessengerWindow.popup, 'bx-im-fullscreen-closed'))
		{
			return false;
		}
		if (this.BXIM.context == "LINES")
		{
			if (window.innerHeight < BX.MessengerWindow.minHeight)
			{
				return false;
			}
		}
		else if (BX.MessengerWindow.content)
		{
			documentOffsetHeight = BX.MessengerWindow.content.offsetHeight;
		}

		var newHeight = documentOffsetHeight-this.initHeight;
		this.initHeight = documentOffsetHeight;
	}
	else if (!BX.MessengerCommon.isDesktop() || !this.BXIM.init  || !this.BXIM.messenger || !this.BXIM.notify)
	{
		return false;
	}
	else
	{
		if (window.innerHeight < BX.MessengerWindow.minHeight)
			return false;
		var newHeight = documentOffsetHeight-this.initHeight;
		this.initHeight = documentOffsetHeight;
	}
	this.BXIM.messenger.popupMessengerBodySize = Math.max(this.BXIM.messenger.popupMessengerBodySize+newHeight, this.BXIM.messenger.popupMessengerBodySizeMin-(this.BXIM.messenger.popupMessengerTextareaSize-30));
	if (this.BXIM.messenger.popupMessengerBody != null)
	{
		this.BXIM.messenger.popupMessengerBody.style.height = this.BXIM.messenger.popupMessengerBodySize+'px';
		this.BXIM.messenger.popupMessengerBodyPanel.style.height = this.BXIM.messenger.popupMessengerBodyDialog.offsetHeight+'px';
		this.BXIM.messenger.redrawChatHeader();
	}

	this.BXIM.messenger.popupContactListElementsSize = Math.max(this.BXIM.messenger.popupContactListElementsSize+newHeight, this.BXIM.messenger.popupContactListElementsSizeMin);
	if (this.BXIM.messenger.popupContactListElements != null)
		this.BXIM.messenger.popupContactListElements.style.height = this.BXIM.messenger.popupContactListElementsSize+'px';

	this.BXIM.messenger.popupMessengerFullHeight = documentOffsetHeight;
	if (this.BXIM.messenger.popupMessengerExtra != null)
		this.BXIM.messenger.popupMessengerExtra.style.height = this.BXIM.messenger.popupMessengerFullHeight+'px';

	this.BXIM.notify.popupNotifySize = Math.max(this.BXIM.notify.popupNotifySize+newHeight, this.BXIM.notify.popupNotifySizeMin);
	if (this.BXIM.notify.popupNotifyItem != null)
		this.BXIM.notify.popupNotifyItem.style.height = this.BXIM.notify.popupNotifySize+'px';

	if (this.BXIM.webrtc.callOverlay)
	{
		this.BXIM.webrtc.callOverlay.style.transition = 'none';
		this.BXIM.webrtc.callOverlay.style.width = (this.BXIM.messenger.popupMessengerExtra.style.display == "block"? this.BXIM.messenger.popupMessengerExtra.offsetWidth-1: this.BXIM.messenger.popupMessengerDialog.offsetWidth-1)+'px';
		this.BXIM.webrtc.callOverlay.style.height = (this.BXIM.messenger.popupMessengerFullHeight-1)+'px';
	}

	if (this.BXIM.messenger.chatCreateFormBody)
	{
		BX.style(this.BXIM.messenger.chatCreateFormBody, 'height', this.BXIM.messenger.popupMessengerBodySize+'px');
	}
	if (this.BXIM.messenger.popupCreateChatTextarea)
	{
		BX.style(this.BXIM.messenger.popupCreateChatTextarea, 'height', this.BXIM.messenger.popupMessengerTextareaSize+'px');
	}

	this.BXIM.messenger.closeMenuPopup();

	if (BX.MessengerCommon.isDesktop())
	{
		clearTimeout(this.BXIM.adjustSizeTimeout);
		this.BXIM.adjustSizeTimeout = setTimeout(BX.delegate(function(){
			this.BXIM.setLocalConfig('global_msz_v2', {
				'wz': this.BXIM.messenger.popupMessengerFullWidth,
				'ta2': this.BXIM.messenger.popupMessengerTextareaSize,
				'b': this.BXIM.messenger.popupMessengerBodySize,
				'cl': this.BXIM.messenger.popupContactListSize,
				'hi': this.BXIM.messenger.popupHistoryItemsSize,
				'fz': this.BXIM.messenger.popupMessengerFullHeight,
				'ez': this.BXIM.messenger.popupContactListElementsSize,
				'nz': this.BXIM.notify.popupNotifySize,
				'hf': this.BXIM.messenger.popupHistoryFilterVisible,
				'dw': window.innerWidth,
				'dh': window.innerHeight,
				'place': 'desktop'
			});
			if (this.BXIM.webrtc.callOverlay)
				this.BXIM.webrtc.callOverlay.style.transition = '';
		}, this), 500);
	}

	return true;
};

BX.IM.Desktop.prototype.autoResize = function(window)
{
	if (!BX.MessengerCommon.isDesktop()) return;

	BX.desktop.resize();
};

BX.IM.Desktop.prototype.openSettings = function(content, js, params)
{
	if (!BX.MessengerCommon.isDesktop()) return false;
	params = params || {};

	if(params.minSettingsWidth)
		this.minSettingsWidth = params.minSettingsWidth;

	if(params.minSettingsHeight)
		this.minSettingsHeight = params.minSettingsHeight;

	BX.desktop.createWindow("settings", BX.delegate(function(settings) {
		settings.SetProperty("clientSize", { Width: this.minSettingsWidth, Height: this.startSettingsHeight });
		settings.SetProperty("minClientSize", { Width: this.minSettingsWidth, Height: this.minSettingsHeight });
		settings.SetProperty("resizable", false);
		settings.SetProperty("title", BX.message('IM_SETTINGS'));
		settings.ExecuteCommand("html.load", this.getHtmlPage(content, js, {}));
	},this));
};

BX.IM.Desktop.prototype.openHistory = function(userId, content, js)
{
	if (!BX.MessengerCommon.isDesktop()) return false;

	BX.desktop.createWindow("history", BX.delegate(function(history)
	{
		var data = {'chat':{}, 'users':{}, 'files':{}};

		var diskEnable = this.messenger.disk.enable;
		if (userId.toString().substr(0,4) == 'chat')
		{
			var chatId = userId.substr(4);
			data['chat'][chatId] = this.messenger.chat[chatId];
			data['files'][chatId] = this.disk.files[chatId];
			for (var i = 0; i < this.messenger.userInChat[chatId].length; i++)
				data['users'][this.messenger.userInChat[chatId][i]] = this.messenger.users[this.messenger.userInChat[chatId][i]];
		}
		else
		{
			chatId = this.messenger.userChat[userId]? this.messenger.userChat[userId]: 0;

			data['userChat'] = {}
			data['userChat'][userId] = chatId;
			data['users'][userId] = this.messenger.users[userId];
			data['users'][this.BXIM.userId] = this.messenger.users[this.BXIM.userId];
			data['files'][chatId] = this.disk.files[chatId];
		}
		history.SetProperty("clientSize", { Width: diskEnable? this.minHistoryDiskWidth: this.minHistoryWidth, Height: this.minHistoryHeight });
		history.SetProperty("minClientSize", { Width: diskEnable? this.minHistoryDiskWidth: this.minHistoryWidth, Height: this.minHistoryHeight });
		history.SetProperty("resizable", false);
		history.ExecuteCommand("html.load", this.getHtmlPage(content, js, data));
		history.SetProperty("title", BX.message('IM_M_HISTORY'));
	},this));
};

BX.IM.Desktop.prototype.openCallFloatDialog = function()
{
	if (!this.BXIM.init || !BX.MessengerCommon.isDesktop() || !this.webrtc || !this.webrtc.callActive || this.topmostWindow || this.phoneTransferEnabled)
		return false;

	if (this.webrtc.callVideo && !this.webrtc.callStreamMain)
		return false;

	if (!this.webrtc.callOverlayTitleBlock)
		return false;

	this.openTopmostWindow("callFloatDialog", 'BXIM.webrtc.callFloatDialog("'+BX.util.jsencode(this.webrtc.callOverlayTitleBlock.innerHTML.replace(/<\/?[^>]+>/gi, ' '))+'", "'+(this.webrtc.callVideo? this.webrtc.callOverlayVideoMain.src: '')+'", '+(this.webrtc.audioMuted?1:0)+')', {}, 'im-desktop-call');
};

BX.IM.Desktop.prototype.closeCallFloatDialog = function()
{
	if (!BX.MessengerCommon.isDesktop() || !this.topmostWindow)
		return false;

	if (this.webrtc.callActive)
	{
		if (this.webrtc.callOverlayUserId > 0 && this.webrtc.callOverlayUserId == this.messenger.currentTab)
		{
			this.closeTopmostWindow();
		}
		else if (this.webrtc.callOverlayChatId > 0 && this.webrtc.callOverlayChatId == this.messenger.currentTab.toString().substr(4))
		{
			this.closeTopmostWindow();
		}
	}
	else
	{
		this.closeTopmostWindow();
	}
}

BX.IM.Desktop.prototype.openTopmostWindow = function(name, js, initJs, bodyClass)
{
	if (!BX.MessengerCommon.isDesktop())
		return false;

	this.closeTopmostWindow();

	console.log('openTopmostWindow init', name, js);
	clearTimeout(this.topmostWindowTimeout);
	this.topmostWindowTimeout = setTimeout(BX.delegate(function(){
		if (this.topmostWindow)
			return false;

		console.log('openTopmostWindow show', name);
		this.topmostWindow = BXDesktopSystem.ExecuteCommand('topmost.show.html', this.getHtmlPage("", js, initJs, bodyClass));
	}, this), 500);
};

BX.IM.Desktop.prototype.closeTopmostWindow = function()
{
	clearTimeout(this.topmostWindowTimeout);
	clearTimeout(this.topmostWindowCloseTimeout);
	if (!this.topmostWindow)
		return false;

	console.log('closeTopmostWindow init');
	if (this.topmostWindow && this.topmostWindow.document)
		BX.desktop.windowCommand(this.topmostWindow, "hide");

	this.topmostWindowCloseTimeout = setTimeout(BX.delegate(function(){
		if (this.topmostWindow && this.topmostWindow.document)
		{
			/*if (this.topmostWindow.document && this.topmostWindow.document.title.length > 0)
			{*/
				console.log('closeTopmostWindow close');
				BX.desktop.windowCommand(this.topmostWindow, "close");
				this.topmostWindow = null;
			/*}
			else
			{
				this.closeTopmostWindow();
			}*/
		}
	}, this), 300);
}

BX.IM.Desktop.prototype.getHtmlPage = function(content, jsContent, initImJs, bodyClass)
{
	if (!BX.MessengerCommon.isDesktop()) return;

	content = content || '';
	jsContent = jsContent || '';
	bodyClass = bodyClass || '';

	var initImConfig = typeof(initImJs) == "undefined" || typeof(initImJs) != "object"? {}: initImJs;
	initImJs = typeof(initImJs) != "undefined";
	if (this.htmlWrapperHead == null)
		this.htmlWrapperHead = document.head.outerHTML.replace(/BX\.PULL\.start\([^)]*\);/g, '');

	if (content != '' && BX.type.isDomNode(content))
		content = content.outerHTML;

	if (jsContent != '' && BX.type.isDomNode(jsContent))
		jsContent = jsContent.outerHTML;

	if (jsContent != '')
		jsContent = '<script type="text/javascript">BX.ready(function(){'+jsContent+'});</script>';

	var initJs = '';
	if (initImJs == true)
	{
		initJs = "<script type=\"text/javascript\">"+
			"BX.ready(function() {"+
				"BXIM = new BX.IM(null, {"+
					"'init': false,"+
					"'colors' : "+(this.BXIM.colors? JSON.stringify(this.BXIM.colors): "false")+","+
					"'settings' : "+JSON.stringify(this.BXIM.settings)+","+
					"'settingsView' : "+JSON.stringify(this.BXIM.settingsView)+","+
					"'updateStateInterval': '"+this.BXIM.updateStateInterval+"',"+
					"'desktop': "+BX.MessengerCommon.isPage()+","+
					"'desktopVersion': "+this.BXIM.desktopVersion+","+
					"'ppStatus': false,"+
					"'ppServerStatus': false,"+
					"'xmppStatus': "+this.BXIM.xmppStatus+","+
					"'bitrixNetwork': "+this.BXIM.bitrixNetwork+","+
					"'bitrixNetwork2': "+this.BXIM.bitrixNetwork2+","+
					"'bitrixOpenLines': "+this.BXIM.bitrixOpenLines+","+
					"'bitrix24': "+this.BXIM.bitrix24+","+
					"'bitrixIntranet': "+this.BXIM.bitrixIntranet+","+
					"'bitrixXmpp': "+this.BXIM.bitrixXmpp+","+
					"'bitrixMobile': "+this.BXIM.bitrixMobile+","+
					"'files' : "+(initImConfig.files? JSON.stringify(initImConfig.files): '{}')+","+
					"'notify' : "+(initImConfig.notify? JSON.stringify(initImConfig.notify): '{}')+","+
					"'users' : "+(initImConfig.users? JSON.stringify(initImConfig.users): '{}')+","+
					"'chat' : "+(initImConfig.chat? JSON.stringify(initImConfig.chat): '{}')+","+
					"'userChat' : "+(initImConfig.userChat? JSON.stringify(initImConfig.userChat): '{}')+","+
					"'userInChat' : "+(initImConfig.userInChat? JSON.stringify(initImConfig.userInChat): '{}')+","+
					"'hrphoto' : "+(initImConfig.hrphoto? JSON.stringify(initImConfig.hrphoto): '{}')+","+
					"'phoneCrm' : "+(initImConfig.phoneCrm? JSON.stringify(initImConfig.phoneCrm): '{}')+","+
					"'generalChatId': "+this.BXIM.messenger.generalChatId+","+
					"'canSendMessageGeneralChat': "+this.BXIM.messenger.canSendMessageGeneralChat+","+
					"'userId': "+this.BXIM.userId+","+
					"'userEmail': '"+this.BXIM.userEmail+"',"+
					"'userColor': '"+this.BXIM.userColor+"',"+
					"'userGender': '"+this.BXIM.userGender+"',"+
					"'userExtranet': "+this.BXIM.userExtranet+","+
					"'disk': {'enable': "+(this.disk? this.disk.enable: false)+", 'external': "+(this.disk? this.disk.external: false)+"},"+
					"'path' : "+JSON.stringify(this.BXIM.path)+
				"});"+
			"});"+
		"</script>";
	}
	return '<!DOCTYPE html><html>'+this.htmlWrapperHead+'<body class="im-desktop im-desktop-popup '+bodyClass+'"><div id="placeholder-messanger">'+content+'</div>'+initJs+jsContent+'</body></html>';
};

BX.IM.Desktop.prototype.onAwayAction = function (away, manual)
{
	BX.ajax({
		url: this.BXIM.pathToAjax+'?IDLE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_IDLE' : 'Y', 'IM_AJAX_CALL' : 'Y', IDLE: away? 'Y': 'N', MANUAL: manual? 'Y': 'N', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data)
		{
			if (data && data.BITRIX_SESSID)
			{
				BX.message({'bitrix_sessid': data.BITRIX_SESSID});
			}
			if (data.ERROR == 'AUTHORIZE_ERROR' && BX.MessengerCommon.isDesktop() && this.messenger.sendAjaxTry < 3)
			{
				this.messenger.sendAjaxTry++;
				BX.onCustomEvent(window, 'onImError', [data.ERROR]);
			}
			else if (data.ERROR == 'SESSION_ERROR' && this.messenger.sendAjaxTry < 2)
			{
				this.messenger.sendAjaxTry++;
				BX.onCustomEvent(window, 'onImError', [data.ERROR, data.BITRIX_SESSID]);
			}
			else
			{
				if (data.ERROR == 'AUTHORIZE_ERROR' || data.ERROR == 'SESSION_ERROR')
				{
					BX.onCustomEvent(window, 'onImError', [data.ERROR]);
				}
			}
		}, this)
	});
}
BX.IM.Desktop.prototype.onWakeAction = function ()
{
	BX.desktop.setIconStatus('offline');

	BX.MessengerCommon.checkInternetConnection(function()
	{
		var initDate = BXIM.desktop.initDate;
		var curDate = new Date();
		if (
			initDate.getDate()+''+initDate.getMonth()+''+initDate.getFullYear()
			== curDate.getDate()+''+curDate.getMonth()+''+curDate.getFullYear()
		)
		{
			BX.PULL.restart();
		}
		else
		{
			BX.desktop.windowReload();
		}
	},
	BX.delegate(function()
	{
		BX.desktop.login();
	}, this), 10)
}
BX.IM.Desktop.prototype.onTrayAction = function ()
{
	BX.desktop.windowCommand("show");
	var messengerCounter = this.BXIM.notify.getCounter('im_message');
	var notifyCounter = this.BXIM.notify.getCounter('im_notify');
	if (messengerCounter > 0)
	{
		if (this.BXIM.notifyOpen == true && notifyCounter > 0)
		{
			BX.desktop.changeTab('notify');
			//this.BXIM.notify.openNotify(false, true);
		}
		else
		{
			BX.desktop.changeTab('im');
			this.BXIM.messenger.openMessenger();
		}
	}
	else if (notifyCounter > 0)
	{
		BX.desktop.changeTab('notify');
		//this.BXIM.notify.openNotify(false, true);
	}
	if (this.BXIM.messenger.popupMessengerTextarea)
	{
		this.BXIM.messenger.popupMessengerTextarea.focus();
	}
};
BX.IM.Desktop.prototype.birthdayStatus = function(value)
{
	if (!BX.MessengerCommon.isDesktop()) return false;

	if (typeof(value) !='boolean')
	{
		return this.BXIM.getLocalConfig('birthdayStatus', true);
	}
	else
	{
		this.BXIM.setLocalConfig('birthdayStatus', value);
		return value;
	}
};

BX.IM.Desktop.prototype.changeTab = function(currentTab)
{
	return false;
};

BX.PopupWindowDesktop = function()
{
	this.closeByEsc = true;
	this.setClosingByEsc = function(enable) { this.closeByEsc = enable; };
	this.close = function(){
		if (BX.MessengerCommon.isDesktop())
		{
			BX.desktop.windowCommand('close');
		}
		else if (BX.MessengerCommon.isPage())
		{
			BX.MessengerWindow.closePopup();
		}
	};
	this.destroy = function(){
		if (BX.MessengerCommon.isDesktop())
		{
			BX.desktop.windowCommand('close');
		}
		else if (BX.MessengerCommon.isPage())
		{
			BX.MessengerWindow.closePopup();
		}
	};
};

/* WebRTC */
BX.IM.WebRTC = function(BXIM, params)
{
	if (this.parent)
	{
		this.parent.constructor.apply(this, arguments);
	}
	this.BXIM = BXIM;
	this.screenSharing = new BX.IM.ScreenSharing(this, params);

	this.panel = params.panel;
	this.desktop = params.desktopClass;

	this.callToPhone = false;
	this.callOverlayFullScreen = false;

	this.callToMobile = false;

	this.callAspectCheckInterval = null;
	this.callAspectHorizontal = true;
	this.callInviteTimeout = null;
	this.callNotify = null;
	this.callAllowTimeout = null;
	this.callDialogAllow = null;
	this.callOverlay = null;
	this.callOverlayMinimize = null;
	this.callOverlayChatId = 0;
	this.callOverlayUserId = 0;
	this.callSelfDisabled = false;
	this.callOverlayPhotoSelf = null;
	this.callOverlayPhotoUsers = {};
	this.callOverlayVideoUsers = {};
	this.callOverlayVideoPhotoUsers = {};
	this.callOverlayPhotoCompanion = null;
	this.callOverlayPhotoMini = null;
	this.callOverlayVideoMain = null;
	this.callOverlayVideoReserve = null;
	this.callOverlayVideoSelf = null;
	this.callOverlayProgressBlock = null;
	this.callOverlayStatusBlock = null;
	this.callOverlayButtonsBlock = null;

	this.callView = null;

	this.phoneEnabled = params.phoneEnabled;
	this.phoneCanPerformCalls = params.phoneCanPerformCalls;
	this.phoneDeviceActive = params.phoneDeviceActive == 'Y';
	this.phoneCanCallUserNumber = params.phoneCanCallUserNumber == 'Y';
	this.phoneCallerID = '';
	this.phoneLogin = '';
	this.phoneServer = '';
	this.phoneCheckBalance = false;
	this.phoneCallHistory = {};
	this.phoneHistory = this.BXIM.getLocalConfig('phone-history') || [];

	this.phoneSDKinit = false;
	this.phoneMicAccess = false;
	this.phoneIncoming = false;
	this.phoneCallId = '';
	this.phoneCallTime = 0;
	this.phoneCallConfig = {};
	this.phoneCallExternal = false;
	this.phoneCallDevice = 'WEBRTC';
	this.phonePortalCall = false;
	this.phoneNumber = '';
	this.phoneFullNumber = '';
	this.phoneNumberUser = '';
	this.phoneParams = {};
	this.phoneAPI = null;
	this.phoneDisconnectAfterCallFlag = true;
	this.phoneCurrentCall = null;
	this.phoneCrm = params.phoneCrm? params.phoneCrm: {};
	this.phoneMicMuted = false;
	this.phoneHolded = false;
	this.phoneRinging = 0;
	this.phoneTransferEnabled = false;
	this.phoneTransferTargetType = 'user'; // user|phone
	this.phoneTransferTargetId = '';
	this.phoneTransferCallId = '';
	this.phoneConnectedInterval = null;
	this.phoneDeviceDelayTimeout = null;
	this.phoneLines = params.phoneLines || {};
	this.phoneDefaultLineId = params.phoneDefaultLineId || false;
	this.phoneAvailableLines = params.phoneAvailableLines || [];

	this.phoneCallView = false;
	this.foldedPhoneCallView = BX.FoldedCallView.getInstance();
	this.callListId = 0;
	this.lastCallListCallParams = null;

	this.debug = false;

	this.phoneKeypad = null;
	this.popupTransferDialog = null;
	this.popupTransferDialogDestElements = null;
	this.popupTransferDialogContactListSearch = null;
	this.popupTransferDialogContactListElements = null;

	if (this.setTurnServer)
	{
		this.setTurnServer({
			'turnServer': params.turnServer || '',
			'turnServerFirefox': params.turnServerFirefox || '',
			'turnServerLogin': params.turnServerLogin || '',
			'turnServerPassword': params.turnServerPassword || ''
		});
	}

	this.readDefaults();
	this.restoreFoldedCallView();
	if(BX.type.isFunction(this.logDevices))
	{
		this.logDevices();
	}

	var commonElementsInit = false;
	if (this.enabled)
	{
		commonElementsInit = true;
	}
	else
	{
		if (!this.BXIM.desktopStatus)
		{
			this.initAudio(true);
		}

	}

	if (this.phoneEnabled && (this.phoneDeviceActive || this.enabled))
	{
		commonElementsInit = true;

		/* TODO disabled because of problems with the microphone change
		if (BX.MessengerCommon.isDesktop())
		{
			this.phoneDisconnectAfterCallFlag = false;
		}*/

		BX.MessengerCommon.pullPhoneEvent();
	}



	if (commonElementsInit)
	{
		this.initAudio();

		if (BX.browser.SupportLocalStorage())
		{
			BX.addCustomEvent(window, "onLocalStorageSet", this.storageSet.bind(this));
		}

		BX.garbage(function(){
			if (this.callInit && !this.callActive)
			{
				if (this.initiator)
				{
					this.callCommand(this.callChatId, 'decline', {'ACTIVE': this.callActive? 'Y': 'N', 'INITIATOR': this.initiator? 'Y': 'N'}, false);
					this.callAbort();
				}
			}
			if (this.callActive)
			{
				if(this.phoneCallView && (this.phoneCallExternal || this.phoneCallDevice === 'PHONE'))
				{
					if(this.phoneCallView.canBeUnloaded())
					{
						BX.localStorage.set('bxim-folded-call-card', {
							phoneCallId: this.phoneCallId,
							phoneCrm: this.phoneCrm,
							phoneCallDevice: this.phoneCallDevice,
							phoneCallExternal: this.phoneCallExternal,
							callView: this.phoneCallView.getState()
						}, 15);
					}
				}
				else
				{
					this.callCommand(this.callChatId, 'errorAccess', {}, false);
				}
			}

			this.callOverlayClose();
		}, this);
	}

	this.initialize();
};

if (BX.inheritWebrtc)
	BX.inheritWebrtc(BX.IM.WebRTC);

BX.IM.WebRTC.prototype.ready = function()
{
	return this.enabled;
};

BX.IM.WebRTC.prototype.initialize = function()
{
	BX.addCustomEvent("onImDialogOpen", this.onImDialogOpen.bind(this));
	BX.addCustomEvent("onPullEvent-im", this.onPullEvent.bind(this));
};

BX.IM.WebRTC.prototype.onImDialogOpen = function(e)
{
	if(this.callView)
		this.callOverlayToggleSize();
};

BX.IM.WebRTC.prototype.onPullEvent = function(command, params)
{
	if (command != 'call')
		return;

	this.log('Incoming', params.command, params.senderId, JSON.stringify(params));

	var handlers = {
		join: this.onPullEventJoin.bind(this),
		invite: this.onPullEventInvite.bind(this),
		invite_join: this.onPullEventInvite.bind(this),
		invite_user: this.onPullEventInviteUser.bind(this),
		wait: this.onPullEventWait.bind(this),
		answer: this.onPullEventAnswer.bind(this),
		ready: this.onPullEventReady.bind(this),
		errorAccess: this.onPullEventErrorAccess.bind(this),
		reconnect: this.onPullEventReconnect.bind(this),
		signaling: this.onPullEventSignaling.bind(this),
		waitTimeout: this.onPullEventWaitTimeout.bind(this),
		busy_self: this.onPullEventBusySelf.bind(this),
		callToPhone: this.onPullEventCallToPhone.bind(this),
		busy: this.onPullEventBusy.bind(this),
		decline: this.onPullEventDecline.bind(this),
		answer_self: this.onPullEventAnswerSelf.bind(this),
		decline_self: this.onPullEventDeclineSelf.bind(this)
	};

	if(handlers[params.command])
	{
		handlers[params.command].call(this, params)
	}
	else
	{
		console.log('Unknown call command ' + params.command);
	}
};


BX.IM.WebRTC.prototype.onPullEventJoin = function(params)
{
	for (var i in params.users)
	{
		params.users[i].last_activity_date = new Date(params.users[i].last_activity_date);
		params.users[i].mobile_last_date = new Date(params.users[i].mobile_last_date);
		params.users[i].idle = params.users[i].idle? new Date(params.users[i].idle): false;
		params.users[i].absent = params.users[i].absent? new Date(params.users[i].absent): false;

		this.messenger.users[i] = params.users[i];
	}

	for (var i in params.hrphoto)
		this.messenger.hrphoto[i] = params.hrphoto[i];

	if (this.callInit || this.callActive)
	{
		setTimeout(BX.delegate(function(){
			BX.ajax({
				url: this.BXIM.pathToCallAjax+'?CALL_BUSY&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 30,
				data: {'IM_CALL' : 'Y', 'COMMAND': 'busy', 'CHAT_ID': params.chatId, 'RECIPIENT_ID' : params.senderId, 'VIDEO': params.video? 'Y': 'N', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
			});
		}, this), params.callToGroup? 1000: 0);
	}
	else
	{
		if (BX.MessengerCommon.isDesktop() || !this.BXIM.desktopStatus)
		{
			this.messenger.openMessenger('chat'+params.chatId);
			this.BXIM.repeatSound('ringtone', 5000);
			this.callNotifyWait(params.chatId, params.senderId, params.video, params.callToGroup, true);
		}

		if (BX.MessengerCommon.isDesktop() && !this.BXIM.windowFocus)
		{
			var data = {'users' : {}, 'chat' : {}, 'userInChat' : {}, 'hrphoto' : {}};
			if (params.callToGroup)
			{
				data['chat'][params.chatId] = this.messenger.chat[params.chatId];
				data['userInChat'][params.chatId] = this.messenger.userInChat[params.chatId];
			}

			for (var i = 0; i < this.messenger.userInChat[params.chatId].length; i++)
			{
				data['users'][this.messenger.userInChat[params.chatId][i]] = this.messenger.users[this.messenger.userInChat[params.chatId][i]];
				data['hrphoto'][this.messenger.userInChat[params.chatId][i]] = this.messenger.hrphoto[this.messenger.userInChat[params.chatId][i]];
			}

			this.desktop.openTopmostWindow("callNotifyWaitDesktop", "BXIM.webrtc.callNotifyWaitDesktop("+params.chatId+",'"+params.senderId+"', "+(params.video?1:0)+", "+(params.callToGroup?1:0)+", true);", data, 'im-desktop-call');
		}
	}

}

BX.IM.WebRTC.prototype.onPullEventInvite = function(params)
{
	console.trace("Trying to call deprecated function onPullEventInvite");
	return;

	for (var i in params.users)
	{
		params.users[i].last_activity_date = new Date(params.users[i].last_activity_date);
		params.users[i].mobile_last_date = new Date(params.users[i].mobile_last_date);
		params.users[i].idle = params.users[i].idle? new Date(params.users[i].idle): false;
		params.users[i].absent = params.users[i].absent? new Date(params.users[i].absent): false;

		this.messenger.users[i] = params.users[i];
	}

	for (var i in params.hrphoto)
		this.messenger.hrphoto[i] = params.hrphoto[i];

	for (var i in params.chat)
	{
		params.chat[i].date_create = new Date(params.chat[i].date_create);
		this.messenger.chat[i] = params.chat[i];
	}

	for (var i in params.userInChat)
		this.messenger.userInChat[i] = params.userInChat[i];

	if(!this.enabled && !this.BXIM.desktopStatus)
	{
		this.callView = new BX.IM.Call.View({
			toUserId: this.BXIM.userId,
			fromUserId: params.senderId,
			groupCall: this.callToGroup,
			users: this.callToGroup ? this.messenger.userInChat(params.senderId) : [params.senderId],
			video: params.video,
			progress: 'offline',
			status: BX.MessengerCommon.isDesktop()? BX.message('IM_M_CALL_ST_NO_WEBRTC_3'): BX.message('IM_M_CALL_ST_NO_WEBRTC_2'),
			uiState: this.BXIM.platformName == '' ? BX.IM.Call.UiState.Finished : BX.IM.Call.UiState.Unsupported
		});
		this.bindCallViewCallbacks();
		this.callView.show();

		this.callOverlayDeleteEvents({'closeNotify': false});
		return;
	}

	if (this.callInit || this.callActive)
	{
		if (params.command == 'invite')
		{
			if (this.callChatId == params.chatId)
			{
				this.callCommand(params.chatId, 'busy_self');
				this.callOverlayClose(false);
			}
			else
			{
				setTimeout(BX.delegate(function(){
					BX.ajax({
						url: this.BXIM.pathToCallAjax+'?CALL_BUSY&V='+this.BXIM.revision,
						method: 'POST',
						dataType: 'json',
						timeout: 30,
						data: {'IM_CALL' : 'Y', 'COMMAND': 'busy', 'CHAT_ID': params.chatId, 'RECIPIENT_ID' : params.senderId, 'VIDEO': params.video? 'Y': 'N', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
					});
				}, this), params.callToGroup? 1000: 0);
			}
		}
		else if (this.initiator && this.callChatId == params.chatId)
		{
			this.initiator = false;
			this.callDialog();
			BX.ajax({
				url: this.BXIM.pathToCallAjax+'?CALL_ANSWER&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				timeout: 30,
				data: {'IM_CALL' : 'Y', 'COMMAND': 'answer', 'CHAT_ID': this.callChatId, 'CALL_TO_GROUP': this.callToGroup? 'Y': 'N',  'RECIPIENT_ID' : this.callUserId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
			});
		}
	}
	else
	{
		if (BX.MessengerCommon.isDesktop() || !this.BXIM.desktopStatus)
		{
			this.BXIM.repeatSound('ringtone', 5000);
			this.callCommand(params.chatId, 'wait');
			if (BX.MessengerCommon.isPage())
			{
				BX.MessengerWindow.changeTab('im');
			}

			if (params.isMobile)
			{
				this.callToMobile = true;
			}


			this.callNotifyWait(params.chatId, params.senderId, params.video, params.callToGroup);

		}
		if (BX.MessengerCommon.isDesktop() && !this.BXIM.isFocus('all'))
		{
			var data = {'users' : {}, 'chat' : {}, 'userInChat' : {}, 'hrphoto' : {}};
			if (params.callToGroup)
			{
				data['chat'][params.chatId] = this.messenger.chat[params.chatId];
				data['userInChat'][params.chatId] = this.messenger.userInChat[params.chatId];
			}
			for (var i = 0; i < this.messenger.userInChat[params.chatId].length; i++)
			{
				data['users'][this.messenger.userInChat[params.chatId][i]] = this.messenger.users[this.messenger.userInChat[params.chatId][i]];
				data['hrphoto'][this.messenger.userInChat[params.chatId][i]] = this.messenger.hrphoto[this.messenger.userInChat[params.chatId][i]];
			}
			this.desktop.openTopmostWindow("callNotifyWaitDesktop", "BXIM.webrtc.callNotifyWaitDesktop("+params.chatId+",'"+params.senderId+"', "+(params.video?1:0)+", "+(params.callToGroup?1:0)+");", data, 'im-desktop-call');
		}
	}
};

BX.IM.WebRTC.prototype.onPullEventInviteUser = function(params)
{
	if(!this.callInit || this.callChatId != params.lastChatId)
		return;

	for (var i in params.users)
	{
		params.users[i].last_activity_date = new Date(params.users[i].last_activity_date);
		params.users[i].mobile_last_date = new Date(params.users[i].mobile_last_date);
		params.users[i].idle = params.users[i].idle? new Date(params.users[i].idle): false;
		params.users[i].absent = params.users[i].absent? new Date(params.users[i].absent): false;

		this.messenger.users[i] = params.users[i];
	}

	for (var i in params.hrphoto)
		this.messenger.hrphoto[i] = params.hrphoto[i];

	this.callChatId = params.chatId;

	this.callView.redraw();
};

BX.IM.WebRTC.prototype.onPullEventWait = function(params)
{
	if(this.callActive || !this.callInit || this.callChatId != params.chatId)
		return;

	if (!this.callToGroup)
	{
		clearTimeout(this.callDialtoneTimeout);
		this.callDialtoneTimeout = setTimeout(BX.delegate(function(){
			this.BXIM.repeatSound('dialtone', 5000);
		}, this), 2000);
	}

	this.callWait(params.senderId);
};

BX.IM.WebRTC.prototype.onPullEventAnswer = function(params)
{
	if(!this.initiator || this.callChatId != params.chatId)
		return;

	this.callDialog();
	if (params.isMobile)
	{
		this.callToMobile = true;
	}
}

BX.IM.WebRTC.prototype.onPullEventReady = function(params)
{
	if (this.callActive && this.callStreamSelf == null)
	{
		clearTimeout(this.callAllowTimeout);
		this.callAllowTimeout = setTimeout(BX.delegate(function(){
			this.BXIM.playSound('error');
			this.callView.setProgress('offline');
			this.callCommand(this.callChatId, 'errorAccess');
			this.callView.setUiState(BX.IM.Call.UiState.Finished);
			this.callAbort(BX.message('IM_M_CALL_ST_NO_ACCESS_3'));
		}, this), 60000);
	}
	this.log('Opponent '+params.senderId+' ready!');
	this.connected[params.senderId] = true;
}

BX.IM.WebRTC.prototype.onPullEventErrorAccess = function(params)
{
	if(this.callChatId != params.chatId)
		return false;

	if(this.callInit && params.callToGroup)
		return this.onGroupCallUserError(params.senderId);

	if(!this.callActive || (params.callToGroup && !params.closeConnect))
		return false;

	this.BXIM.playSound('error');
	this.callOverlayProgress('offline');
	this.callView.setUiState(BX.IM.Call.UiState.Finished);
	this.callAbort(BX.message('IM_M_CALL_ST_NO_ACCESS_2'));
}

BX.IM.WebRTC.prototype.onPullEventReconnect = function(params)
{
	if(!this.callActive || this.callChatId != params.chatId)
		return false;

	clearTimeout(this.pcConnectTimeout[params.senderId]);
	clearTimeout(this.initPeerConnectionTimeout[params.senderId]);

	if (this.pc[params.senderId])
		this.pc[params.senderId].close();

	delete this.pc[params.senderId];
	delete this.pcStart[params.senderId];

	if (this.callStreamMain == this.callStreamUsers[params.senderId])
		this.callStreamMain = null;
	this.callStreamUsers[params.senderId] = null;

	this.initPeerConnection(params.senderId);
}

BX.IM.WebRTC.prototype.onPullEventSignaling = function(params)
{
	if(!this.callActive || this.callChatId != params.chatId)
		return false;

	this.signalingPeerData(params.senderId, params.peer);
}

BX.IM.WebRTC.prototype.onPullEventWaitTimeout = function(params)
{
	if(this.callChatId != params.chatId)
		return false;

	if(this.callInit && params.callToGroup)
		return this.onGroupCallUserError(params.senderId);

	if(!this.callInit || (params.callToGroup && !params.closeConnect))
		return false;

	this.callAbort();
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onPullEventBusySelf = function(params)
{
	if(!this.callInit || this.callChatId != params.chatId)
		return false;

	this.callAbort();
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onPullEventCallToPhone = function(params)
{
	if(!this.callInit || this.callChatId != params.chatId)
		return false;

	this.callAbort();
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onPullEventBusy = function(params)
{
	if(this.callChatId != params.chatId)
		return false;

	if(this.callInit && params.callToGroup)
		return this.onGroupCallUserError(params.senderId);

	if(!this.callInit || (params.callToGroup && !params.closeConnect))
		return false;

	this.BXIM.playSound('error');
	this.callView.setProgress('offline');
	this.callView.setUiState(BX.Im.Call.UiState.Finished);
	this.callAbort(BX.message('IM_M_CALL_ST_BUSY'));
};

BX.IM.WebRTC.prototype.onPullEventDecline = function(params)
{
	if(this.callChatId != params.chatId)
		return false;

	if(this.callInit && params.callToGroup)
		return this.onGroupCallUserError(params.senderId);

	if(!this.callInit || (params.callToGroup && !params.closeConnect))
		return false;

	if (this.callInitUserId != this.BXIM.userId || this.callActive)
	{
		var callVideo = this.callVideo;
		this.callOverlayStatus(BX.message('IM_M_CALL_ST_DECLINE'));

		this.BXIM.playSound('stop');
		this.callOverlayClose();
	}
	else if (this.callInitUserId == this.BXIM.userId)
	{
		this.BXIM.playSound('error');
		this.callOverlayProgress('offline');
		this.callView.setUiState(BX.IM.Call.UiState.Finished);
		this.callAbort(BX.message('IM_M_CALL_ST_DECLINE'));
	}
	else
	{
		this.callAbort();
	}
};

BX.IM.WebRTC.prototype.onPullEventAnswerSelf = function(params)
{
	if(this.callSelfDisabled || this.callActive)
		return false;

	this.BXIM.stopRepeatSound('ringtone');
	this.BXIM.stopRepeatSound('dialtone');
	this.callOverlayClose(true);
};

BX.IM.WebRTC.prototype.onPullEventDeclineSelf = function(params)
{
	if(this.callSelfDisabled || this.callChatId != params.chatId)
		return false;

	this.BXIM.stopRepeatSound('ringtone');
	this.BXIM.stopRepeatSound('dialtone');
	this.callOverlayClose(true);
};

BX.IM.WebRTC.prototype.onGroupCallUserError = function(userId)
{
	this.connected[userId] = false;
	delete this.pc[userId];
	delete this.pcStart[userId];

	if(this.callStreamUsers[userId])
	{
		this.callView.removeRemoteStream(userId);
	}

	this.callView.setProgress(BX.IM.Call.UiProgress.Wait);
	this.callView.setStatus(BX.message(this.callToGroup? 'IM_M_CALL_ST_WAIT_ACCESS_3':'IM_M_CALL_ST_WAIT_ACCESS_2'));
};

BX.IM.WebRTC.prototype.restoreFoldedCallView = function()
{
	var self = this;
	var callProperties = BX.localStorage.get('bxim-folded-call-card');

	if(!BX.type.isPlainObject(callProperties))
		return;

	this.callActive = true;
	this.phoneCallId = callProperties.phoneCallId;
	this.phoneCrm = callProperties.phoneCrm;
	this.phoneCallDevice = callProperties.phoneCallDevice;
	this.phoneCallExternal = callProperties.phoneCallExternal;

	var callViewProperties = callProperties.callView;
	callViewProperties.BXIM = this.BXIM;
	this.phoneCallView = new BX.PhoneCallView(callProperties.callView);
	if(this.phoneCallExternal)
	{
		this.phoneCallView.setUiState(BX.PhoneCallView.UiState.externalCard);
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);
		this.bindPhoneViewCallbacksExternalCall(this.phoneCallView);
	}
	else
	{
		this.bindPhoneViewCallbacks(this.phoneCallView);
	}

	if(this.phoneCallExternal)
	{
		BX.localStorage.set('viExternalCard', true, 5);
		this.phoneConnectedInterval = setInterval(function()
		{
			if(self.phoneCallExternal)
			{
				BX.localStorage.set('viExternalCard', true, 5);
			}
		}, 5000);
	}

	setTimeout(function()
	{
		BX.MessengerCommon.phoneCommand('getCall', {'CALL_ID' : self.phoneCallId}, true, function(result)
		{
			if(!result.FOUND || result.FOUND !== 'Y')
			{
				self.phoneCallId = '';
				self.callActive = false;
				self.phoneCallExternal = false;
				self.callSelfDisabled = false;
				clearInterval(self.BXIM.webrtc.phoneConnectedInterval);
				BX.localStorage.set('viExternalCard', false);
				if(self.phoneCallView)
				{
					self.phoneCallView.dispose();
					self.phoneCallView = null;
				}
			}
		});

	}.bind(this), 0);
}

BX.IM.WebRTC.prototype.readDefaults = function()
{
	if(!localStorage)
		return;

	this.defaultMicrophone = localStorage.getItem('bx-im-settings-default-microphone');
	this.defaultCamera = localStorage.getItem('bx-im-settings-default-camera');
	this.defaultSpeaker = localStorage.getItem('bx-im-settings-default-speaker');
	this.enableMicAutoParameters = (localStorage.getItem('bx-im-settings-enable-mic-auto-parameters') !== 'N');
}

BX.IM.WebRTC.prototype.initAudio = function(onlyError)
{
	if (onlyError === true)
	{
		this.panel.appendChild(this.BXIM.audio.error = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-error.ogg", type : "audio/ogg; codecs=vorbis" }}),
			BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-error.mp3", type : "audio/mpeg" }})
		]}));

		return false;
	}

	this.panel.appendChild(this.BXIM.audio.dialtone = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-dialtone.ogg", type : "audio/ogg; codecs=vorbis" }}),
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-dialtone.mp3", type : "audio/mpeg" }})
	]}));

	this.panel.appendChild(this.BXIM.audio.ringtone = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-ringtone.ogg", type : "audio/ogg; codecs=vorbis" }}),
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-ringtone.mp3", type : "audio/mpeg" }})
	]}));

	this.panel.appendChild(this.BXIM.audio.start = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-start.ogg", type : "audio/ogg; codecs=vorbis" }}),
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-start.mp3", type : "audio/mpeg" }})
	]}));

	this.panel.appendChild(this.BXIM.audio.stop = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-stop.ogg", type : "audio/ogg; codecs=vorbis" }}),
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-stop.mp3", type : "audio/mpeg" }})
	]}));

	this.panel.appendChild(this.BXIM.audio.error = BX.create("audio", { props : { className : "bx-messenger-audio" }, children : [
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-error.ogg", type : "audio/ogg; codecs=vorbis" }}),
		BX.create("source", { attrs : { src : "/bitrix/js/im/audio/video-error.mp3", type : "audio/mpeg" }})
	]}));

	if (typeof(this.BXIM.audio.stop.play) == 'undefined')
	{
		this.BXIM.settings.enableSound = false;
	}

};

/* WebRTC UserMedia API */
BX.IM.WebRTC.prototype.startGetUserMedia = function(video, audio)
{
	clearTimeout(this.callDialtoneTimeout);
	this.BXIM.stopRepeatSound('ringtone');
	this.BXIM.stopRepeatSound('dialtone');

	var showAllowPopup = true;

	clearTimeout(this.callInviteTimeout);
	clearTimeout(this.callDialogAllowTimeout);
	if (showAllowPopup)
	{
		this.callDialogAllowTimeout = setTimeout(BX.delegate(function(){
			this.callDialogAllowShow();
		}, this), 1500);
	}

	this.parent.startGetUserMedia.apply(this, arguments);
};

BX.IM.WebRTC.prototype.onUserMediaSuccess = function(stream)
{
	clearTimeout(this.callAllowTimeout);

	var result = this.parent.onUserMediaSuccess.apply(this, arguments);
	if (!result)
		return false;

	if (this.callDialogAllow)
		this.callDialogAllow.close();

	if(this.callView)
	{
		this.callView.setProgress('online');
		this.callView.setStatus(BX.message(this.callToGroup? 'IM_M_CALL_ST_WAIT_ACCESS_3':'IM_M_CALL_ST_WAIT_ACCESS_2'));
		this.callView.setLocalStream(this.callStreamSelf);
	}

	this.callCommand(this.callChatId, 'ready');
	if (BX.MessengerCommon.isDesktop() && this.BXIM.init)
	{
		BX.desktop.syncPause(true);
	}
};

BX.IM.WebRTC.prototype.onUserMediaError = function(error)
{
	clearTimeout(this.callAllowTimeout);

	var result = this.parent.onUserMediaError.apply(this, arguments);
	if (!result)
		return false;

	if (this.callDialogAllow)
		this.callDialogAllow.close();

	if (this.useFallbackConstraints === false)
	{
		this.useFallbackConstraints = true;
		this.startGetUserMedia(this.lastUserMediaParams['video'], this.lastUserMediaParams['audio']);
	}
	else
	{
		this.BXIM.playSound('error');
		this.callOverlayProgress('offline');
		this.callCommand(this.callChatId, 'errorAccess');

		if (location.protocol.indexOf('https') === -1)
		{
			this.callAbort(BX.message('IM_M_CALL_ST_NO_ACCESS_HTTPS'));
		}
		else
		{
			this.callAbort(BX.message('IM_M_CALL_ST_NO_ACCESS'));
		}

		this.callView.setUiState(BX.IM.Call.UiState.Finished);
	}
};

/* WebRTC PeerConnection Events */
BX.IM.WebRTC.prototype.setLocalAndSend = function(userId, desc)
{
	var result = this.parent.setLocalAndSend.apply(this, arguments);
	if (!result)
		return false;

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_SIGNALING&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_CALL' : 'Y', 'COMMAND': 'signaling', 'CHAT_ID': this.callChatId,  'RECIPIENT_ID' : userId, 'PEER': JSON.stringify( desc ), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
	});

	return true;
};

BX.IM.WebRTC.prototype.onRemoteStreamAdded = function (userId, event, mainStream)
{
	if(!this.callView)
		return;

	this.callView.setUiState(BX.IM.Call.UiState.Connected);
	this.callView.setRemoteStream(userId, this.callStreamUsers[userId]);

	if (mainStream)
	{
		this.callView.setStatus(BX.message('IM_M_CALL_ST_ONLINE'));
		if (BX.MessengerCommon.isDesktop())
			BX.desktop.onCustomEvent("bxCallChangeMainVideo", [URL.createObjectURL(this.callStreamUsers[userId])]);

		if (!this.BXIM.windowFocus)
			this.desktop.openCallFloatDialog();
	}

	if (this.initiator)
		this.callCommand(this.callChatId, 'start', {'CALL_TO_GROUP': this.callToGroup? 'Y': 'N', 'RECIPIENT_ID' : userId});
};

BX.IM.WebRTC.prototype.onRemoteStreamRemoved = function(userId, event)
{
	this.callView.removeRemoteStream(userId);
};

BX.IM.WebRTC.prototype.onIceCandidate = function (userId, candidates)
{
	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_SIGNALING&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_CALL' : 'Y', 'COMMAND': 'signaling', 'CHAT_ID': this.callChatId,  'RECIPIENT_ID' : userId, 'PEER': JSON.stringify(candidates), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
	});
}

BX.IM.WebRTC.prototype.peerConnectionError = function(userId, event)
{
	if (this.callDialogAllow)
		this.callDialogAllow.close();

	if(!this.callView)
		return;

	this.callCommand(this.callChatId, 'errorAccess');
	this.callOverlayDeleteEvents();
	this.callView.setProgress('offline');
	this.callView.setUiState(BX.IM.Call.UiState.Finished);
	this.callView.setStatus(BX.message('IM_M_CALL_ST_CON_ERROR'));
};

BX.IM.WebRTC.prototype.peerConnectionGetStats = function()
{
	if (this.detectedBrowser != 'chrome')
		return false;

	if (this.callUserId <= 0 || !this.pc[this.callUserId] || !this.pc[this.callUserId].getStats || this.callToGroup || this.callToPhone)
		return false;

	this.pc[this.callUserId].getStats(function(e){
		console.log(e)
	})
};

BX.IM.WebRTC.prototype.peerConnectionReconnect = function (userId)
{
	var result = this.parent.peerConnectionReconnect.apply(this, arguments);
	if (!result)
		return false;

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_RECONNECT&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_CALL' : 'Y', 'COMMAND': 'reconnect', 'CHAT_ID' : this.callChatId,  'RECIPIENT_ID' : userId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(){
			this.initPeerConnection(userId, true);
		}, this)
	});

	return true;
}

/* WebRTC Signaling API  */
BX.IM.WebRTC.prototype.callSupport = function(dialogId, messengerClass)
{
	messengerClass = messengerClass? messengerClass: this.messenger;
	var userCheck = true;
	if (typeof(dialogId) != 'undefined')
	{
		if (parseInt(dialogId)>0)
		{
			userCheck = messengerClass.users[dialogId] && messengerClass.users[dialogId].status != 'guest' && !messengerClass.users[dialogId].bot && !messengerClass.users[dialogId].network;
		}
		else
		{
			if (messengerClass.chat[dialogId.toString().substr(4)] && messengerClass.chat[dialogId.toString().substr(4)].type == 'open')
			{
				userCheck = false;
			}
			else
			{
				userCheck = (messengerClass.userInChat[dialogId.toString().substr(4)] && messengerClass.userInChat[dialogId.toString().substr(4)].length <= 4);
			}
		}
	}
	return this.BXIM.ppServerStatus && this.enabled && userCheck;
};

BX.IM.WebRTC.prototype.callInvite = function(userId, video, screen)
{
	console.trace("Trying to call deprecated function callInvite");
	return;

	if (BX.localStorage.get('viInitedCall'))
		return false;

	if (BX.MessengerCommon.isPage() && BX.MessengerWindow.currentTab != 'im')
	{
		BX.MessengerWindow.changeTab('im');
	}

	if (!this.callSupport())
	{
		if (!BX.MessengerCommon.isDesktop())
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_NO_WEBRT'), [
				this.BXIM.platformName == ''? null: new BX.PopupWindowButton({
					text : BX.message('IM_M_CALL_BTN_DOWNLOAD'),
					className : "popup-window-button-accept",
					events : { click : BX.delegate(function() { window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp"); BX.proxy_context.popupWindow.close(); }, this) }
				}),
				new BX.PopupWindowButton({
					text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
					className : "popup-window-button-decline",
					events : { click : function() { this.popupWindow.close(); } }
				})
			]);
		}
		return false;
	}

	var callToChat = false;
	if (parseInt(userId) > 0)
	{
		if (this.messenger.users[userId] && this.messenger.users[userId].status == 'guest')
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_USER_OFFLINE'));
			return false;
		}
		else if (!this.messenger.users[userId])
		{
			BX.MessengerCommon.getUserParam(userId);
		}
		userId = parseInt(userId);
	}
	else
	{
		userId = userId.toString().substr(4);
		if (!this.messenger.userInChat[userId] || this.messenger.userInChat[userId].length <= 1)
		{
			return false;
		}
		else if (!this.messenger.userInChat[userId] || this.messenger.userInChat[userId].length > 4)
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_CHAT_LARGE'));
			return false;
		}
		callToChat = true;
	}

	video = video == true;
	screen = video === true && screen === true;

	if (!this.callActive && !this.callInit && userId > 0)
	{
		this.initiator = true;
		this.callInitUserId = this.BXIM.userId;
		this.callInit = true;
		this.callActive = false;
		this.callUserId = callToChat? 0: userId;
		this.callChatId = callToChat? userId: 0;
		this.callToGroup = callToChat;
		this.callGroupUsers = callToChat? this.messenger.userInChat[userId]: [];
		this.callVideo = video;

		this.callView = new BX.IM.Call.View({
			messenger: this.messenger,
			toUserId: userId,
			fromUserId: this.BXIM.userId,
			groupCall: this.callToGroup,
			users: this.callToGroup ? this.messenger.userInChat[userId] : [userId],
			videoCall: video,
			status: BX.message('IM_M_CALL_ST_CONNECT'),
			uiState: BX.IM.Call.UiState.Outgoing
		});
		this.bindCallViewCallbacks();
		this.callView.show();

		this.BXIM.playSound("start");

		BX.ajax({
			url: this.BXIM.pathToCallAjax+'?CALL_INVITE&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: {'IM_CALL' : 'Y', 'COMMAND': 'invite', 'CHAT_ID' : userId, 'CHAT': (callToChat? 'Y': 'N'), 'VIDEO' : video? 'Y': 'N', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(data)
			{
				if (data.ERROR == '')
				{
					this.callChatId = data.CHAT_ID;
					for (var i in data.USERS)
					{
						data.USERS[i].last_activity_date = new Date(data.USERS[i].last_activity_date);
						data.USERS[i].mobile_last_date = new Date(data.USERS[i].mobile_last_date);
						data.USERS[i].idle = data.USERS[i].idle? new Date(data.USERS[i].idle): false;
						data.USERS[i].absent = data.USERS[i].absent? new Date(data.USERS[i].absent): false;

						this.messenger.users[i] = data.USERS[i];
					}

					for (var i in data.HR_PHOTO)
						this.messenger.hrphoto[i] = data.HR_PHOTO[i];

					if (data.CALL_ENABLED && this.callToGroup)
					{
						for (var i in data.USERS_CONNECT)
						{
							this.connected[i] = true;
						}
						this.initiator = false;
						this.callInitUserId = 0;
						this.callInit = true;
						this.callActive = false;
						this.callUserId = 0;
						this.callChatId = data.CHAT_ID;
						this.callToGroup = data.CALL_TO_GROUP;
						this.callGroupUsers = this.messenger.userInChat[data.CHAT_ID];
						this.callVideo = data.CALL_VIDEO;
						this.callDialog();
						return false;
					}

					this.callView.setTitle(this.callOverlayTitle());
					this.callView.updatePhoto();

					var callUserId = this.callToGroup? 'chat'+this.callChatId: this.callUserId;
					var callToGroup = this.callToGroup;
					var callVideo = this.callVideo;

					this.callInviteTimeout = setTimeout(BX.delegate(function(){
						this.callView.setProgress(BX.IM.Call.UiProgress.Offline);
						this.callView.setUiState(BX.IM.Call.UiState.Finished);
						this.callAbort(BX.message(callToGroup? 'IM_M_CALL_ST_NO_WEBRTC_1': 'IM_M_CALL_ST_NO_WEBRTC'));
						this.callCommand(this.callChatId, 'errorOffline');
					}, this), 30000);
				}
				else
				{
					this.callView.setProgress(BX.IM.Call.UiProgress.Offline);
					this.callView.setUiState(BX.IM.Call.UiState.Finished);
					this.callAbort(data.ERROR);
					this.callCommand(this.callChatId, 'errorOffline');
				}
			}, this),
			onfailure: BX.delegate(function() {
				this.callAbort(BX.message('IM_M_CALL_ERR'));
				this.callOverlayClose();
			}, this)
		});
	}
};

BX.IM.WebRTC.prototype.callWait = function()
{
	if (!this.callSupport())
		return false;

	this.callOverlayStatus(BX.message(this.callToGroup? 'IM_M_CALL_ST_WAIT_2': 'IM_M_CALL_ST_WAIT'));

	clearTimeout(this.callInviteTimeout);
	this.callInviteTimeout = setTimeout(BX.delegate(function(){
		if (!this.initiator)
		{
			this.callAbort();
			this.callOverlayClose();
			return false;
		}

		this.BXIM.playSound('error');
		this.callView.setProgress(BX.IM.Call.UiProgress.Offline);
		this.callView.setUiState(BX.IM.Call.UiState.Finished);

		this.callCommand(this.callChatId, 'waitTimeout');
		this.callAbort(BX.message(this.callToGroup? 'IM_M_CALL_ST_NO_ANSWER_2': 'IM_M_CALL_ST_NO_ANSWER'));

	}, this), 20000);
};

BX.IM.WebRTC.prototype.callChangeMainVideo = function(userId)
{
	var lastUserId = this.callOverlayVideoMain.getAttribute('data-userId');
	if (lastUserId == userId || !this.callStreamUsers[userId])
		return false;

	BX.addClass(this.callOverlayVideoMain, "bx-messenger-call-video-main-block-animation");

	clearTimeout(this.callChangeMainVideoTimeout);
	this.callChangeMainVideoTimeout = setTimeout(BX.delegate(function(){
		this.callOverlayVideoMain.setAttribute('data-userId', userId);
		this.attachMediaStream(this.callOverlayVideoMain, this.callStreamUsers[userId]);

		if (BX.MessengerCommon.isDesktop())
			BX.desktop.onCustomEvent("bxCallChangeMainVideo", [this.callOverlayVideoMain.src]);

		BX.addClass(this.callOverlayVideoUsers[userId].parentNode, 'bx-messenger-call-video-block-hide');
		BX.addClass(this.callOverlayVideoUsers[userId].parentNode, 'bx-messenger-call-video-hide');
		this.callOverlayVideoUsers[userId].parentNode.setAttribute('title', '');

		if (this.callStreamUsers[lastUserId])
		{
			this.attachMediaStream(this.callOverlayVideoUsers[lastUserId], this.callStreamUsers[lastUserId]);
			BX.removeClass(this.callOverlayVideoUsers[lastUserId].parentNode, 'bx-messenger-call-video-hide');
		}

		this.callOverlayVideoUsers[lastUserId].parentNode.setAttribute('title', BX.message('IM_CALL_MAGNIFY'));
		BX.removeClass(this.callOverlayVideoUsers[lastUserId].parentNode, 'bx-messenger-call-video-block-hide');
		BX.removeClass(this.callOverlayVideoMain, "bx-messenger-call-video-main-block-animation");

	}, this), 400);
};

BX.IM.WebRTC.prototype.callInviteUserToChat = function(users)
{
	if (this.callChatId <= 0 || this.messenger.popupChatDialogSendBlock)
		return false;

	var error = '';
	if (users.length == 0)
	{
		if (this.messenger.popupChatDialog != null)
			this.messenger.popupChatDialog.close();
		return false;
	}
	if (error != "")
	{
		this.BXIM.openConfirm(error);
		return false;
	}

	if (this.screenSharing.callInit)
	{
		this.screenSharing.callDecline();
	}

	this.messenger.popupChatDialogSendBlock = true;
	if (this.messenger.popupChatDialog != null)
		this.messenger.popupChatDialog.buttons[0].setClassName('popup-window-button-disable');

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_INVITE_USER&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		timeout: 60,
		data: {'IM_CALL' : 'Y', 'COMMAND': 'invite_user', 'USERS': JSON.stringify(users), 'CHAT_ID': this.callChatId, 'RECIPIENT_ID' : this.callUserId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data){
			this.messenger.popupChatDialogSendBlock = false;
			if (this.messenger.popupChatDialog != null)
				this.messenger.popupChatDialog.buttons[0].setClassName('popup-window-button-accept');

			if (data.ERROR == '')
			{
				this.messenger.popupChatDialogSendBlock = false;
				if (this.messenger.popupChatDialog != null)
					this.messenger.popupChatDialog.close();
			}
			else
			{
				this.BXIM.openConfirm(data.ERROR);
			}
		}, this)
	});
};

BX.IM.WebRTC.prototype.callCommand = function(chatId, command, params, async)
{
	if (!this.callSupport())
		return false;

	chatId = parseInt(chatId);
	async = async != false;
	params = typeof(params) == 'object' ? params: {};

	if (chatId > 0)
	{
		BX.ajax({
			url: this.BXIM.pathToCallAjax+'?CALL_SHARED&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			async: async,
			data: {'IM_CALL' : 'Y', 'COMMAND': command, 'CHAT_ID': chatId, 'RECIPIENT_ID' : this.callUserId, 'PARAMS' : JSON.stringify(params), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
			onsuccess: BX.delegate(function(){
				if (this.callDialogAllow)
					this.callDialogAllow.close();
			}, this)
		});
	}
};

/* WebRTC dialogs markup */
BX.IM.WebRTC.prototype.callDialog = function()
{
	if (!this.callSupport())
		return false;

	clearTimeout(this.callInviteTimeout);
	clearTimeout(this.callDialogAllowTimeout);
	if (this.callDialogAllow)
		this.callDialogAllow.close();

	this.callActive = true;
	if(!this.callView)
		return;

	if (this.messenger.popupMessenger == null)
	{
		this.messenger.openMessenger(this.callUserId);
	}

	this.callView.setProgress('wait');
	this.callView.setStatus(BX.message('IM_M_CALL_ST_WAIT_ACCESS'));
	if(this.callToMobile)
		this.callView.setCallWithMobile(true);

	this.callView.setFloating(false);
	this.callView.setUiSize(BX.IM.Call.UiSize.Full);
	this.callView.setUiState(BX.IM.Call.UiState.Connecting);

	this.startGetUserMedia(this.callVideo);
};

BX.IM.WebRTC.prototype.toggleScreenSharing = function()
{
	if (this.screenSharing.callInit && this.screenSharing.initiator)
	{
		this.screenSharing.callDecline();
	}
	else
	{
		this.screenSharing.callInvite();
	}

	return true;
}

BX.IM.WebRTC.prototype.callOverlayShow = function(params)
{
	if (!params || !(params.toUserId || params.phoneNumber) || !(params.fromUserId || params.phoneNumber) || !params.buttons)
		return false;

	if (this.callOverlay != null)
	{
		this.callOverlayClose(false, true);
	}
	this.messenger.closeMenuPopup();

	params.video = params.video != false;
	params.callToGroup = params.callToGroup == true;
	params.callToPhone = params.callToPhone == true;
	params.minimize = typeof(params.minimize) == 'undefined'? (this.messenger.popupMessenger == null): (params.minimize == true);
	params.status = params.status? params.status: "";
	params.progress = params.progress? params.progress: "connect";


	this.callOverlayMinimize = params.prepare? true: params.minimize;

	var scrollableArea = null;
	if (this.BXIM.dialogOpen)
		scrollableArea = this.messenger.popupMessengerBody;
	else if (this.BXIM.notifyOpen)
		scrollableArea = this.messenger.popupNotifyItem;

	if (scrollableArea)
	{
		if (BX.MessengerCommon.isScrollMin(scrollableArea))
		{
			setTimeout(BX.delegate(function(){
				BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
			},this), params.minimize? 0: 400);
		}
		else
		{
			BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
			scrollableArea.scrollTop = scrollableArea.scrollTop + 50;
		}
	}
	else
	{
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
	}

	if (!this.callOverlayMinimize)
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call-maxi');

	var callOverlayStyle = {
		width : !this.messenger.popupMessenger? '610px': (this.messenger.popupMessengerExtra.style.display == "block"? this.messenger.popupMessengerExtra.offsetWidth+1: this.messenger.popupMessengerDialog.offsetWidth+1)+'px',
		height : (this.messenger.popupMessengerFullHeight+2)+'px',
		marginLeft : this.messenger.popupContactListSize+'px'
	};

	if (this.messenger.popupMessenger == null)
	{
		callOverlayStyle['marginTop'] = '-1px';
	}

	var callOverlayBody = params.callToGroup? this.callGroupOverlayShow(params): this.callUserOverlayShow(params);

	this.callOverlay =  BX.create("div", { props : { className : 'bx-messenger-call-overlay '+(params.callToGroup? ' bx-messenger-call-overlay-group ':'')+(this.callOverlayMinimize? 'bx-messenger-call-overlay-mini': 'bx-messenger-call-overlay-maxi')}, style : callOverlayStyle, children: [
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-lvl-1'}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-lvl-2'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-video-main'}, children: [
					BX.create("div", { props : { className : 'bx-messenger-call-video-main-wrap'}, children: [
						BX.create("div", { props : { className : 'bx-messenger-call-video-main-watermark'}, children: [
							BX.create("img", { props : { className : 'bx-messenger-call-video-main-watermark-img'},  attrs : {src : '/bitrix/js/im/images/watermark_'+(this.BXIM.language == 'ru'? 'ru': 'en')+'.png'}})
						]}),
						BX.create("div", { props : { className : 'bx-messenger-call-video-main-cell'}, children: [
							BX.create("div", { props : { className : 'bx-messenger-call-video-main-bg'}, children: [
								this.callOverlayVideoMain = BX.create("video", { attrs : { autoplay : true }, props : { className : 'bx-messenger-call-video-main-block'}}),
								this.callOverlayVideoReserve = BX.create("video", { attrs : { autoplay : true }, props : { className : 'bx-messenger-hide'}})
							]})
						]})
					]})
				]})
			]})
		]}),
		this.callOverlayBody = BX.create("div", { props : { className : 'bx-messenger-call-overlay-body'}, children: callOverlayBody})
	]});
	if (params.prepare)
	{
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-float');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-show');
	}
	else if (this.messenger.popupMessenger != null)
	{
		this.messenger.setClosingByEsc(false);
		this.messenger.popupMessengerContent.insertBefore(this.callOverlay, this.messenger.popupMessengerContent.firstChild);
	}
	else if (this.callNotify != null)
	{
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-float');
		this.callNotify.setContent(this.callOverlay);
	}
	else
	{
		this.callNotify = new BX.PopupWindow('bx-messenger-call-notify', null, {
			//parentPopup: this.popupMessenger,
			lightShadow : true,
			zIndex: 200,
			events : {
				onPopupClose : function() { this.destroy(); },
				onPopupDestroy : BX.delegate(function() {
					BX.unbind(window, "scroll", this.popupCallNotifyEvent);
					this.callNotify = null;
				}, this)},
			content : this.callOverlay
		});
		this.callNotify.show();

		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-float');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-show');
		BX.addClass(this.callNotify.popupContainer.children[0], 'bx-messenger-popup-window-transparent');
		setTimeout(BX.delegate(function(){
			if (this.callNotify)
			{
				this.callNotify.adjustPosition();
			}
		}, this), 500);
		BX.bind(window, "scroll", this.popupCallNotifyEvent = BX.proxy(function(){ this.callNotify.adjustPosition();}, this));
	}
	setTimeout(BX.delegate(function(){
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-show');
	}, this), 100);

	this.callOverlayStatus(params.status);
	this.callView.setUiState(BX.IM.Call.UiState.Finished);
	this.callOverlayProgress(params.progress);

	return true;
};

BX.IM.WebRTC.prototype.callGroupOverlayShow = function(params)
{

	var callIncoming = params.fromUserId != this.BXIM.userId;
	var callChatId = params.fromUserId != this.BXIM.userId? params.fromUserId: params.toUserId;

	var callTitle = this.callOverlayTitle();

	this.callOverlayChatId = callChatId;

	var callOverlayPhotoUsers = [];
	var callOverlayVideoUsers = [];
	for (var i = 0; i < this.messenger.userInChat[callChatId].length; i++)
	{
		var userId = this.messenger.userInChat[callChatId][i];
		var userAvatarData = BX.MessengerCommon.getHrPhoto(userId, this.messenger.users[userId].color);
		callOverlayPhotoUsers.push(BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-left'}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-block'}, children: [
				this.callOverlayPhotoUsers[userId] = BX.create("img", { props : { className : 'bx-messenger-call-overlay-photo-img'}, attrs : { 'data-userId': userId, src : userAvatarData.src, style: (userAvatarData.color? 'background-color: '+userAvatarData.color: '')}})
			]})
		]}));

		if (userId == this.BXIM.userId)
			continue;

		var userAvatarData = BX.MessengerCommon.getHrPhoto(userId, this.messenger.users[userId].color);
		callOverlayVideoUsers.push(BX.create("div", { props : { className : 'bx-messenger-call-video-mini bx-messenger-call-video-hide'}, attrs: {'data-userId': userId}, events: {click: BX.delegate(function(){ this.callChangeMainVideo(BX.proxy_context.getAttribute('data-userId')); }, this)}, children: [
			this.callOverlayVideoUsers[userId] = BX.create("video", { attrs : { autoplay : true }, props : { className : 'bx-messenger-call-video-mini-block'}}),
			BX.create("div", { props : { className : 'bx-messenger-call-video-mini-photo'}, children: [
				this.callOverlayVideoPhotoUsers[userId] = BX.create("img", { props : { className : 'bx-messenger-call-video-mini-photo-img'}, attrs : { src : userAvatarData.src, style: (userAvatarData.color? 'background-color: '+userAvatarData.color: '')}})
			]})
		]}));
	}

	var userAvatarData = BX.MessengerCommon.getHrPhoto(this.BXIM.userId, this.messenger.users[this.BXIM.userId].color);
	return [
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-line-maxi'}, attrs : { title: BX.message('IM_M_CALL_BTN_RETURN')}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-line-maxi-block'}})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-video-users'}, children: callOverlayVideoUsers}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-title'}, children: [
			this.callOverlayTitleBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-title-block'}, html: callTitle})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo'}, children: callOverlayPhotoUsers}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-progress-group'}, children: [
			this.callOverlayProgressBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-progress'}})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-status'}, children: [
			this.callOverlayStatusBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-status-block'}})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-video-mini'}, children: [
			this.callOverlayVideoSelf = BX.create("video", { attrs : { autoplay : true }, props : { className : 'bx-messenger-call-video-mini-block'}}),
			BX.create("div", { props : { className : 'bx-messenger-call-video-mini-photo'}, children: [
				this.callOverlayPhotoMini = BX.create("img", { props : { className : 'bx-messenger-call-video-mini-photo-img'}, attrs : { src : userAvatarData.src, style: (userAvatarData.color? 'background-color: '+userAvatarData.color: '')}})
			]})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-buttons'}, children: [
			this.callOverlayButtonsBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-buttons-block'}})
		]})
	];
};

BX.IM.WebRTC.prototype.callUserOverlayShow = function(params)
{

	var callIncoming = params.toUserId == this.BXIM.userId;
	var callUserId = callIncoming? params.fromUserId: params.toUserId;

	var callTitle = this.callOverlayTitle();

	this.callOverlayUserId = callUserId;

	var userAvatarDataCall = BX.MessengerCommon.getHrPhoto(callUserId, this.messenger.users[callUserId].color);
	var userAvatarDataSelf = BX.MessengerCommon.getHrPhoto(this.BXIM.userId, this.messenger.users[this.BXIM.userId].color);

	return [
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-line-maxi'}, attrs : { title: BX.message('IM_M_CALL_BTN_RETURN')}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-line-maxi-block'}})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-title'}, children: [
			this.callOverlayTitleBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-title-block'}, html: callTitle})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo'}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-left'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-block'}, children: [
					this.callOverlayPhotoCompanion = BX.create("img", { props : { className : 'bx-messenger-call-overlay-photo-img'}, attrs : { 'data-userId': callUserId, src : userAvatarDataCall.src, style: (userAvatarDataCall.color? 'background-color: '+userAvatarDataCall.color: '')}})
				]})
			]}),
			this.callOverlayProgressBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-progress'+(callIncoming?'': ' bx-messenger-call-overlay-photo-progress-incoming')}}),
			BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-right'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-overlay-photo-block'}, children: [
					this.callOverlayPhotoSelf = BX.create("img", { props : { className : 'bx-messenger-call-overlay-photo-img'}, attrs : { 'data-userId': this.BXIM.userId, src : userAvatarDataSelf.src, style: (userAvatarDataSelf.color? 'background-color: '+userAvatarDataSelf.color: '')}})
				]})
			]})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-status'}, children: [
			this.callOverlayStatusBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-status-block'}})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-video-mini'}, children: [
			this.callOverlayVideoSelf = BX.create("video", { attrs : { autoplay : true }, props : { className : 'bx-messenger-call-video-mini-block'}}),
			BX.create("div", { props : { className : 'bx-messenger-call-video-mini-photo'}, children: [
				this.callOverlayPhotoMini = BX.create("img", { props : { className : 'bx-messenger-call-video-mini-photo-img'}, attrs : { src : userAvatarDataSelf.src, style: (userAvatarDataSelf.color? 'background-color: '+userAvatarDataSelf.color: '')}})
			]})
		]}),
		BX.create("div", { props : { className : 'bx-messenger-call-overlay-buttons'}, children: [
			this.callOverlayButtonsBlock = BX.create("div", { props : { className : 'bx-messenger-call-overlay-buttons-block'}})
		]})
	];
};

BX.IM.WebRTC.prototype.bindCallViewCallbacks = function()
{
	if(!this.callView)
		return;

	this.callView.setCallback('onClose', this.onCallViewClose.bind(this));
	this.callView.setCallback('onDestroy', this.onCallViewDestroy.bind(this));
	this.callView.setCallback('onButtonClick', this.onCallViewButtonClick.bind(this));
	this.callView.setCallback('onMaximizeClick', this.onCallViewMaximizeClick.bind(this));
};

BX.IM.WebRTC.prototype.onCallViewButtonClick = function(e)
{
	var buttonName = e.buttonName;

	var handlers = {
		answer: this.onCallViewAnswerButtonClick.bind(this),
		decline: this.onCallViewDeclineButtonClick.bind(this),
		hangup: this.onCallViewHangupButtonClick.bind(this),
		showChat: this.onCallViewShowChatButtonClick.bind(this),
		hideChat: this.onCallViewHideChatButtonClick.bind(this),
		inviteUsers: this.onCallViewInviteUsersButtonClick.bind(this),
		toggleMute: this.onCallViewToggleMuteButtonClick.bind(this),
		toggleScreenSharing: this.onCallViewToggleScreenSharingButtonClick.bind(this),
		showHistory: this.onCallViewShowHistoryButtonClick.bind(this),
		redial: this.onCallViewRedialButtonClick.bind(this),
		close: this.onCallViewCloseButtonClick.bind(this),
		download: this.onCallViewDownloadButtonClick.bind(this)
	};

	if(BX.type.isFunction(handlers[buttonName]))
	{
		handlers[buttonName].call(this, e);
	}
};

BX.IM.WebRTC.prototype.onCallViewAnswerButtonClick = function(e)
{
	this.BXIM.stopRepeatSound('ringtone');
	if (e.join)
	{
		var callToGroup = this.callToGroup;
		var callChatId = this.callChatId;
		var callUserId = this.callUserId;
		var callVideo = this.callVideo;

		this.callAbort();
		this.callOverlayClose(false);
		this.callInvite(callToGroup? 'chat'+callChatId: callUserId, callVideo);
	}
	else
	{
		this.callDialog();
		BX.ajax({
			url: this.BXIM.pathToCallAjax+'?CALL_ANSWER&V='+this.BXIM.revision,
			method: 'POST',
			dataType: 'json',
			timeout: 30,
			data: {'IM_CALL' : 'Y', 'COMMAND': 'answer', 'CHAT_ID': this.callChatId, 'CALL_TO_GROUP': this.callToGroup? 'Y': 'N',  'RECIPIENT_ID' : this.callUserId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
		});
		this.desktop.closeTopmostWindow();
	}
};

BX.IM.WebRTC.prototype.onCallViewDeclineButtonClick = function(e)
{
	this.BXIM.stopRepeatSound('ringtone');
	this.callSelfDisabled = true;
	this.callCommand(this.callChatId, 'decline', {'ACTIVE': this.callActive? 'Y': 'N', 'INITIATOR': this.initiator? 'Y': 'N'});
	this.callAbort();
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onCallViewHangupButtonClick = function(e)
{
	var callVideo = this.callVideo;
	this.callSelfDisabled = true;
	this.callCommand(this.callChatId, 'decline', {'ACTIVE': this.callActive? 'Y': 'N', 'INITIATOR': this.initiator? 'Y': 'N'});
	this.BXIM.playSound('stop');
	this.callAbort();
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onCallViewShowChatButtonClick = function(e)
{
	this.callOverlayToggleSize();
};

BX.IM.WebRTC.prototype.onCallViewHideChatButtonClick = function(e)
{
	this.callOverlayToggleSize();
};

BX.IM.WebRTC.prototype.onCallViewInviteUsersButtonClick = function(e)
{
	if (this.messenger.userInChat[this.callChatId] && this.messenger.userInChat[this.callChatId].length == 4)
	{
		this.BXIM.openConfirm(BX.message('IM_CALL_GROUP_MAX_USERS'));
		return false;
	}

	this.messenger.openChatDialog({
		chatId: this.callChatId,
		type: 'CALL_INVITE_USER',
		bind: e.node,
		maxUsers: 4
	});
};

BX.IM.WebRTC.prototype.onCallViewToggleMuteButtonClick = function(e)
{
	this.audioMuted = e.audioMuted;
	this.toggleAudio(false);
};

BX.IM.WebRTC.prototype.onCallViewToggleScreenSharingButtonClick = function(e)
{
	if (!this.desktop.enableInVersion(30))
	{
		this.BXIM.openConfirm({title: BX.message('IM_M_CALL_SCREEN'), message: BX.message('IM_M_CALL_SCREEN_ERROR')});
		return false;
	}

	//todo: bx-messenger-call-overlay-button-screen-off

	this.toggleScreenSharing();
};

BX.IM.WebRTC.prototype.onCallViewShowHistoryButtonClick = function(e)
{
	this.messenger.openHistory(this.messenger.currentTab)
};

BX.IM.WebRTC.prototype.onCallViewRedialButtonClick = function(e)
{
	var callUserId = this.callToGroup? 'chat'+this.callChatId: this.callUserId;
	var callVideo = this.callVideo;

	if (this.phoneCount(this.messenger.phones[callUserId]) > 0)
	{
		this.messenger.openPopupMenu(e.node, 'callPhoneMenu', true, {userId: callUserId, video: callVideo });
	}
	else
	{
		this.callInvite(callUserId, callVideo);
	}
};

BX.IM.WebRTC.prototype.onCallViewCloseButtonClick = function(e)
{
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onCallViewDownloadButtonClick = function(e)
{
	window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp");
	this.callOverlayClose();
};

BX.IM.WebRTC.prototype.onCallViewClose = function(e)
{
	this.callView.destroy();
};

BX.IM.WebRTC.prototype.onCallViewDestroy = function(e)
{
	this.callView = null;
};

BX.IM.WebRTC.prototype.onCallViewMaximizeClick = function(e)
{
	if (this.BXIM.dialogOpen)
	{
		if (this.callOverlayUserId > 0)
		{
			this.messenger.openChatFlag = false;
			BX.MessengerCommon.openDialog(this.callOverlayUserId, false);
		}
		else
		{
			this.messenger.openChatFlag = true;
			BX.MessengerCommon.openDialog('chat'+this.callOverlayChatId, false);
		}
	}
	else
	{
		if (this.callOverlayUserId > 0)
		{
			this.messenger.openChatFlag = false;
			this.messenger.currentTab = this.callOverlayUserId;
		}
		else
		{
			this.messenger.openChatFlag = true;
			this.messenger.currentTab = 'chat'+this.callOverlayChatId;
		}
		this.messenger.extraClose(true, false);
	}
	this.callView.setUiSize(BX.IM.Call.UiSize.Full);
};

BX.IM.WebRTC.prototype.callPhoneOverlayMeter = function(percent)
{
	if (!this.phoneCurrentCall || this.phoneCurrentCall.state() != "CONNECTED")
		return false;

	var grade = 5;
	if (100 == percent)
		grade = 5;
	else if (percent >= 99)
		grade = 4;
	else if (percent >= 97 )
		grade = 3;
	else if (percent >= 95)
		grade = 2;
	else
		grade = 1;

	this.phoneCallView.setQuality(grade);
	return grade;
}

BX.IM.WebRTC.prototype.overlayEnterFullScreen = function()
{
	if (this.callOverlayFullScreen)
	{
		BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen');
		if (document.cancelFullScreen)
			document.cancelFullScreen();
		else if (document.mozCancelFullScreen)
			document.mozCancelFullScreen();
		else if (document.webkitCancelFullScreen)
			document.webkitCancelFullScreen();
	}
	else
	{
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen');
		if (this.detectedBrowser == 'chrome')
		{
			BX.bind(window, "webkitfullscreenchange", this.callOverlayFullScreenBind = BX.proxy(this.overlayEventFullScreen, this));
			this.messenger.popupMessengerContent.webkitRequestFullScreen(this.messenger.popupMessengerContent.ALLOW_KEYBOARD_INPUT);
		}
		else if (this.detectedBrowser == 'firefox')
		{
			BX.bind(window, "mozfullscreenchange", this.callOverlayFullScreenBind = BX.proxy(this.overlayEventFullScreen, this));
			this.messenger.popupMessengerContent.mozRequestFullScreen(this.messenger.popupMessengerContent.ALLOW_KEYBOARD_INPUT);
		}
	}
};

BX.IM.WebRTC.prototype.overlayEventFullScreen = function()
{
	if (this.callOverlayFullScreen)
	{
		if (this.detectedBrowser == 'chrome')
			BX.unbind(window, "webkitfullscreenchange", this.callOverlayFullScreenBind);
		else if (this.detectedBrowser == 'firefox')
			BX.unbind(window, "mozfullscreenchange", this.callOverlayFullScreenBind);

		BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen');
		if (BX.browser.IsChrome())
		{
			BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
			setTimeout(BX.delegate(function(){
				BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen-chrome-hack');
			}, this), 100);
		}
		this.callOverlayFullScreen = false;
		this.messenger.resizeMainWindow();
	}
	else
	{
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen');
		this.callOverlayFullScreen = true;
		this.messenger.resizeMainWindow();
	}
	this.messenger.popupMessengerBody.scrollTop = this.messenger.popupMessengerBody.scrollHeight - this.messenger.popupMessengerBody.offsetHeight;
};


BX.IM.WebRTC.prototype.callOverlayToggleSize = function(minimize)
{
	if (this.callView == null)
		return false;

	if (!this.ready())
	{
		this.callOverlayClose(true);
		return false;
	}

	var resizeToMax = typeof(minimize) == 'boolean'? !minimize: this.callOverlayMinimize;

	var minimizeToLine = false;
	if (this.messenger.popupMessenger != null && !this.BXIM.dialogOpen)
		minimizeToLine = true;
	else if (this.messenger.popupMessenger != null && this.callOverlayUserId > 0 && this.callOverlayUserId != this.messenger.currentTab)
		minimizeToLine = true;
	else if (this.messenger.popupMessenger != null && this.callOverlayChatId > 0 && this.callOverlayChatId != this.messenger.currentTab.toString().substr(4))
		minimizeToLine = true;
	else if (this.messenger.popupMessenger != null && this.callOverlayUserId == 0 && this.callOverlayChatId == 0 && this.phoneNumber)
		minimizeToLine = true;

	if (resizeToMax)
	{
		this.callOverlayMinimize = false;
		this.callView.setUiSize(BX.IM.Call.UiSize.Full);
	}
	else
	{
		this.callOverlayMinimize = true;

		if (minimizeToLine)
		{
			this.callView.setUiSize(BX.IM.Call.UiSize.Line);
		}
		else
		{
			this.callView.setUiSize(BX.IM.Call.UiSize.Minimized);
		}

		//todo: wtf?
		if (this.BXIM.isFocus())
			BX.MessengerCommon.readMessage(this.messenger.currentTab);
		if (this.BXIM.isFocus() && this.notify.notifyUpdateCount > 0)
			this.notify.viewNotifyAll();
	}

	if (this.callOverlayUserId > 0 && this.callOverlayUserId == this.messenger.currentTab)
	{
		this.desktop.closeTopmostWindow();
	}
	else if (this.callOverlayChatId > 0 && this.callOverlayChatId == this.messenger.currentTab.toString().substr(4))
	{
		this.desktop.closeTopmostWindow();
	}
	else
	{
		this.desktop.openCallFloatDialog();
	}
};

BX.IM.WebRTC.prototype.callOverlayClose = function(animation, onlyMarkup)
{
	if (this.callOverlay == null && this.callView == null)
		return false;

	this.audioMuted = true;
	this.toggleAudio(false);

	onlyMarkup = onlyMarkup == true;

	if (!onlyMarkup && this.callOverlayFullScreen)
	{
		if (this.detectedBrowser == 'firefox')
		{
			BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-fullscreen');
			BX.remove(this.messenger.popupMessengerContent);
			BX.hide(this.messenger.popupMessenger.popupContainer);
			setTimeout(BX.delegate(function(){
				this.messenger.popupMessenger.destroy();
				this.messenger.openMessenger(this.messenger.currentTab);
			}, this), 200);
		}
		else
		{
			this.overlayEnterFullScreen();
		}
	}

	if (this.messenger.popupMessenger != null)
	{
		var scrollableArea = null;
		if (this.BXIM.dialogOpen)
			scrollableArea = this.messenger.popupMessengerBody;
		else if (this.BXIM.notifyOpen)
			scrollableArea = this.messenger.popupNotifyItem;

		if (scrollableArea)
		{
			if (BX.MessengerCommon.isScrollMax(scrollableArea))
			{
				BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
			}
			else
			{
				BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
				scrollableArea.scrollTop = scrollableArea.scrollTop-50;
			}
		}
		else
		{
			BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-call');
		}
		BX.removeClass(this.messenger.popupMessengerContent, 'bx-messenger-call-maxi');
	}
	this.messenger.closeMenuPopup();

	animation = animation != false;

	if (animation)
		this.callView.closeAnimated();
	else
		this.callView.close();

	if (animation)
	{
		setTimeout(BX.delegate(function(){
			BX.remove(this.callOverlay);
			this.callOverlay = null;
			this.callOverlayButtonsBlock = null;
			this.callOverlayTitleBlock = null;
			this.callOverlayMeter = null;
			this.callOverlayStatusBlock = null;
			this.callOverlayProgressBlock = null;
			this.callOverlayMinimize = null;
			this.callOverlayChatId = 0;
			this.callOverlayUserId = 0;
			this.callOverlayPhotoSelf = null;
			this.callOverlayPhotoUsers = {};
			this.callOverlayVideoUsers = {};
			this.callOverlayVideoPhotoUsers = {};
			this.callOverlayPhotoCompanion = null;
			this.callSelfDisabled = false;
			if (this.BXIM.isFocus())
				BX.MessengerCommon.readMessage(this.messenger.currentTab);
		}, this), 300);
	}
	else
	{
		BX.remove(this.callOverlay);
		this.callOverlay = null;
		this.callOverlayButtonsBlock = null;
		this.callOverlayStatusBlock = null;
		this.callOverlayProgressBlock = null;
		this.callOverlayMinimize = null;
		this.callOverlayChatId = 0;
		this.callOverlayUserId = 0;
		this.callOverlayPhotoSelf = null;
		this.callOverlayPhotoUsers = {};
		this.callOverlayVideoUsers = {};
		this.callOverlayVideoPhotoUsers = {};
		this.callOverlayPhotoCompanion = null;
		this.callSelfDisabled = false;
		if (this.BXIM.isFocus())
			BX.MessengerCommon.readMessage(this.messenger.currentTab);
	}

	if (onlyMarkup)
	{
		this.BXIM.stopRepeatSound('ringtone');
		this.BXIM.stopRepeatSound('dialtone');
	}
	else
	{
		this.callOverlayDeleteEvents();
	}

	this.desktop.closeTopmostWindow();
};

BX.IM.WebRTC.prototype.callAbort = function(reason)
{
	this.callOverlayDeleteEvents();

	if (reason && this.phoneCallView)
	{
		if(this.phoneCallView)
			this.phoneCallView.setStatusText(reason);
		else if(this.callView)
			this.callView.setStatus(reason)
	}
};

BX.IM.WebRTC.prototype.callOverlayDeleteEvents = function(params)
{
	params = params || {};

	this.desktop.closeTopmostWindow();


	var closeNotify = params.closeNotify !== false;
	if (closeNotify && this.callNotify)
		this.callNotify.destroy();

	var callId = null;
	if (this.phoneCallId)
	{
		callId = this.phoneCallId;
	}
	else if (this.callToGroup)
	{
		callId = 'chat'+this.callChatId;
	}
	else
	{
		callId = 'user'+this.callUserId;
	}
	BX.onCustomEvent(window, 'onImCallEnd', {'CALL_ID': callId});

	clearInterval(this.callAspectCheckInterval);

	if (BX.MessengerCommon.isDesktop() && this.BXIM.init)
	{
		BX.desktop.syncPause(false);
	}

	this.deleteEvents();

	this.callToMobile = false;
	this.callToPhone = false;

	if (this.messenger.popupMessenger)
	{
		this.messenger.popupMessenger.setClosingByEsc(true);
		this.messenger.dialogStatusRedraw();
	}

	this.phoneCallFinish();

	clearTimeout(this.callDialtoneTimeout);
	this.BXIM.stopRepeatSound('ringtone');
	this.BXIM.stopRepeatSound('dialtone');

	clearTimeout(this.callInviteTimeout);
	clearTimeout(this.callDialogAllowTimeout);
	if (this.callDialogAllow)
		this.callDialogAllow.close();
}

BX.IM.WebRTC.prototype.callOverlayProgress = function(progress)
{
	if (this.phoneCallView)
		this.phoneCallView.setProgress(progress);
	else if (this.callView)
			this.callView.setProgress(progress);
};

BX.IM.WebRTC.prototype.callOverlayStatus = function(status)
{
	if (!BX.type.isNotEmptyString(status))
		return false;

	if(this.phoneCallView)
		this.phoneCallView.setStatusText(status);
	else if(this.callView)
		this.callView.setStatus(status)
};

BX.IM.WebRTC.prototype.callOverlayTitle = function()
{
	var callTitle = '';
	var callIncoming = this.callInitUserId != this.BXIM.userId;

	if (this.callToGroup)
	{
		callTitle = this.messenger.chat[this.callChatId].name;
		if (callTitle.length > 85)
			callTitle = callTitle.substr(0,85)+'...';

		callTitle = BX.message('IM_CALL_GROUP_'+(this.callVideo? 'VIDEO':'VOICE')+(callIncoming? '_FROM': '_TO')).replace('#CHAT#', callTitle);
	}
	else
	{
		callTitle = BX.message('IM_M_CALL_'+(this.callVideo? 'VIDEO':'VOICE')+(callIncoming? '_FROM': '_TO')).replace('#USER#', this.messenger.users[this.callUserId].name);
	}

	return callTitle;
}

BX.IM.WebRTC.prototype.setCallOverlayTitle = function(title)
{
	if(this.phoneCallView)
	{
		this.phoneCallView.setTitle(title);
	}
}

BX.IM.WebRTC.prototype.callOverlayTimer = function(state) // TODO not ready yet
{
	tate = typeof(state) == 'undefined'? 'start': state;

	if (state == 'start')
	{
		this.phoneCallTimeInterval = setInterval(BX.delegate(function(){
			this.phoneCallTime++;
		}, this), 1000);
	}
	else if (state == 'pause')
	{
		clearInterval(this.phoneCallTimeInterval);
	}
	else
	{
		clearInterval(this.phoneCallTimeInterval);
	}
}

BX.IM.WebRTC.prototype.callOverlayDrawCrm = function()
{
	if (!this.callOverlayCrmBlock || !this.phoneCrm.FOUND)
		return false;

	this.callOverlayCrmBlock.innerHTML = '';

	if (this.phoneCrm.FOUND == 'Y')
	{
		BX.removeClass(this.callOverlay, 'bx-messenger-call-overlay-mini');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-maxi');
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call-maxi');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-crm');
		BX.removeClass(this.callOverlay, 'bx-messenger-call-overlay-crm-short');

		var crmContactName = this.phoneCrm.CONTACT && this.phoneCrm.CONTACT.NAME? this.phoneCrm.CONTACT.NAME: '';
		if (this.phoneCrm.ACTIVITY_URL)
		{
			crmContactName = '<a href="'+this.phoneCrm.SHOW_URL+'" target="_blank" class="bx-messenger-call-crm-about-link">'+crmContactName+'</a>';
		}
		var crmAbout = BX.create("div", { props : { className : 'bx-messenger-call-crm-about'}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block bx-messenger-call-crm-about-contact'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-header'}, html: BX.message('IM_CRM_ABOUT_CONTACT')}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-avatar'}, html: this.phoneCrm.CONTACT && this.phoneCrm.CONTACT.PHOTO? '<img src="'+this.phoneCrm.CONTACT.PHOTO+'" class="bx-messenger-call-crm-about-block-avatar-img">': ''}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-line-1'}, html: crmContactName}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-line-2'}, html: this.phoneCrm.CONTACT && this.phoneCrm.CONTACT.POST? this.phoneCrm.CONTACT.POST: ''})
			]}),
			this.phoneCrm.COMPANY? BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block bx-messenger-call-crm-about-company'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-header'}, html: BX.message('IM_CRM_ABOUT_COMPANY')}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-line-1'}, html: this.phoneCrm.COMPANY})
			]}): null
		]});

		var crmResponsibility = BX.create("div", { props : { className : 'bx-messenger-call-crm-about'}, children: [
			BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block bx-messenger-call-crm-about-contact'}, children: (this.phoneCrm.RESPONSIBILITY && this.phoneCrm.RESPONSIBILITY.NAME? [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-header'}, html: BX.message('IM_CRM_RESPONSIBILITY')}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-avatar'}, html: this.phoneCrm.RESPONSIBILITY.PHOTO? '<img src="'+this.phoneCrm.RESPONSIBILITY.PHOTO+'" class="bx-messenger-call-crm-about-block-avatar-img">': ''}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-line-1'}, html: this.phoneCrm.RESPONSIBILITY.NAME? this.phoneCrm.RESPONSIBILITY.NAME: ''}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-about-block-line-2'}, html: this.phoneCrm.RESPONSIBILITY.POST? this.phoneCrm.RESPONSIBILITY.POST: ''})
			]: [])})
		]});

		var crmButtons = null;
		if (this.phoneCrm.ACTIVITY_URL || this.phoneCrm.INVOICE_URL || this.phoneCrm.DEAL_URL)
		{
			crmButtons = BX.create("div", { props : { className : 'bx-messenger-call-crm-buttons'}, children: [
				this.phoneCrm.ACTIVITY_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.ACTIVITY_URL},  props : { className : 'bx-messenger-call-crm-button'}, html: BX.message('IM_CRM_BTN_ACTIVITY')}): null,
				this.phoneCrm.DEAL_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.DEAL_URL},  props : { className : 'bx-messenger-call-crm-button'}, html: BX.message('IM_CRM_BTN_DEAL')}): null,
				this.phoneCrm.INVOICE_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.INVOICE_URL},  props : { className : 'bx-messenger-call-crm-button'}, html: BX.message('IM_CRM_BTN_INVOICE')}): null,
				this.phoneCrm.CURRENT_CALL_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.CURRENT_CALL_URL},  props : { className : 'bx-messenger-call-crm-link'}, html: '+ '+BX.message('IM_CRM_BTN_CURRENT_CALL')}): null
			]})
		}

		var crmActivities = null;
		if (this.phoneCrm.ACTIVITIES && this.phoneCrm.ACTIVITIES.length > 0)
		{
			crmArActivities = [];
			for (var i = 0; i < this.phoneCrm.ACTIVITIES.length; i++)
			{
				crmArActivities.push(BX.create("div", { props : { className : 'bx-messenger-call-crm-activities-item'}, children: [
					BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.ACTIVITIES[i].URL}, props : { className : 'bx-messenger-call-crm-activities-name'}, html: this.phoneCrm.ACTIVITIES[i].TITLE}),
					BX.create("div", {
						props : { className : 'bx-messenger-call-crm-activities-status'},
						html: (this.phoneCrm.ACTIVITIES[i].OVERDUE == 'Y'? '<span class="bx-messenger-call-crm-activities-dot"></span>': '')+this.phoneCrm.ACTIVITIES[i].DATE
					})
				]}));
			}
			crmActivities = BX.create("div", { props : { className : 'bx-messenger-call-crm-activities'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-activities-header'}, html: BX.message('IM_CRM_ACTIVITIES')}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-activities-items'}, children: crmArActivities})
			]});
		}

		var crmDeals = null;
		if (this.phoneCrm.DEALS && this.phoneCrm.DEALS.length > 0)
		{
			crmArDeals = [];
			for (var i = 0; i < this.phoneCrm.DEALS.length; i++)
			{
				crmArDeals.push(BX.create("div", { props : { className : 'bx-messenger-call-crm-deals-item'}, children: [
					BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.DEALS[i].URL}, props : { className : 'bx-messenger-call-crm-deals-name'}, html: this.phoneCrm.DEALS[i].TITLE}),
					BX.create("div", {
						props : { className : 'bx-messenger-call-crm-deals-status'},
						html: this.phoneCrm.DEALS[i].STAGE
					})
				]}));
			}
			crmDeals = BX.create("div", { props : { className : 'bx-messenger-call-crm-deals'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-deals-header'}, html: BX.message('IM_CRM_DEALS')}),
				BX.create("div", { props : { className : 'bx-messenger-call-crm-deals-items'}, children: crmArDeals})
			]});
		}

		var crmBlock = [];
		if (crmActivities && crmDeals)
		{
			crmBlock = [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
				crmAbout,
				crmActivities,
				crmDeals,
				BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
				crmButtons
			];
		}
		else
		{
			if (crmActivities || crmDeals)
			{
				crmBlock = [
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmAbout,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmResponsibility,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmActivities? crmActivities: crmDeals,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmButtons
				];
			}
			else if (!crmActivities && !crmDeals && crmButtons)
			{
				BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-crm-short');
				this.callOverlayCrmBlock.innerHTML = '';
				crmBlock = [
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmAbout,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmResponsibility,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmButtons
				];
			}
			else
			{
				BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-crm-short');
				this.callOverlayCrmBlock.innerHTML = '';
				crmBlock = [
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmAbout,
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					BX.create("div", { props : { className : 'bx-messenger-call-crm-space'}}),
					crmResponsibility
				];
			}
		}
	}
	else if (this.phoneCrm.LEAD_URL || this.phoneCrm.CONTACT_URL)
	{
		BX.removeClass(this.callOverlay, 'bx-messenger-call-overlay-mini');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-maxi');
		BX.addClass(this.messenger.popupMessengerContent, 'bx-messenger-call-maxi');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-crm');
		BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-crm-short');
		crmBlock = [
			BX.create("div", { props : { className : 'bx-messenger-call-crm-phone-space'}}),
			BX.create("div", { props : { className : 'bx-messenger-call-crm-phone-icon'}, children: [
				BX.create("div", { props : { className : 'bx-messenger-call-crm-phone-icon-block'}})
			]}),
			BX.create("div", { props : { className : 'bx-messenger-call-crm-phone-space'}}),
			BX.create("div", { props : { className : 'bx-messenger-call-crm-buttons bx-messenger-call-crm-buttons-center'}, children: [
				this.phoneCrm.CONTACT_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.CONTACT_URL},  props : { className : 'bx-messenger-call-crm-button'}, html: BX.message('IM_CRM_BTN_NEW_CONTACT')}): null,
				this.phoneCrm.LEAD_URL? BX.create("a", { attrs: {target: '_blank', href: this.phoneCrm.LEAD_URL},  props : { className : 'bx-messenger-call-crm-button'}, html: BX.message('IM_CRM_BTN_NEW_LEAD')}): null
			]})
		];
	}
	BX.adjust(this.callOverlayCrmBlock, {children: crmBlock});
};

BX.IM.WebRTC.prototype.callDialogAllowShow = function(checkActive)
{
	if (BX.MessengerCommon.isDesktop())
		return false;

	if (this.phoneMicAccess)
		return false;

	checkActive = checkActive != false;
	if (!this.phoneAPI)
	{
		if (this.callStreamSelf != null)
			return false;

		if (checkActive && !this.callActive)
			return false;
	}

	if (this.callDialogAllow)
		this.callDialogAllow.close();

	this.callDialogAllow = new BX.IM.Call.HardwareDialog({
		bindNode: this.messenger.popupMessengerDialog,
		offsetTop: (this.messenger.popupMessengerDialog? (this.callOverlayMinimize? -20: -this.messenger.popupMessengerDialog.offsetHeight/2-100): -20),
		offsetLeft: (this.callOverlay? (this.callOverlay.offsetWidth/2-170): 0),
		onDestroy: function()
		{
			this.callDialogAllow = null;
		}.bind(this)
	});
	this.callDialogAllow.show();
};

BX.IM.WebRTC.prototype.callNotifyWait = function(chatId, userId, video, callToGroup, join)
{
	console.trace("Deprecated function callNotifyWait called");
	return;

	if (!this.callSupport())
		return false;

	join = join == true;
	video = video == true;
	callToGroup = callToGroup == true;

	this.initiator = false;
	this.callInitUserId = userId;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = callToGroup? 0: userId;
	this.callChatId = chatId;
	this.callToGroup = callToGroup;
	this.callGroupUsers = this.messenger.userInChat[chatId];
	this.callVideo = video;

	this.callView = new BX.IM.Call.View({
		messenger: this.messenger,
		toUserId: this.BXIM.userId,
		fromUserId: this.callToGroup? chatId: userId,
		groupCall: this.callToGroup,
		users: this.callToGroup ? this.messenger.userInChat[chatId] : [userId],
		videoCall: video,
		title: this.callOverlayTitle(),
		status: BX.message(this.callToGroup ? 'IM_M_CALL_ST_INVITE_2': 'IM_M_CALL_ST_INVITE'),
		uiState: BX.IM.Call.UiState.Incoming,
		callWithMobile: this.callToMobile,
		floating: !this.messenger.popupMessenger,
		join: join
	});
	this.bindCallViewCallbacks();
	this.callView.show();

	if(!this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
	{
		var notify = {
			title:  BX.message('IM_PHONE_DESC'),
			text:  BX.util.htmlspecialcharsback(this.callOverlayTitle()),
			icon: this.callUserId? this.messenger.users[this.callUserId].avatar: '',
			tag:  'im-call',
			onshow: function()
			{
				var self = this;
				setTimeout(function(){ self.close(); }, 5000)
			},
			onclick: function()
			{
				window.focus();
				this.close();
			}
		};
		this.BXIM.notifyManager.nativeNotify(notify)
	}
};

BX.IM.WebRTC.prototype.callNotifyWaitDesktop = function(chatId, userId, video, callToGroup, join)
{
	this.BXIM.ppServerStatus = true;
	if (!this.callSupport() || !this.desktop.ready())
		return false;

	join = join == true;
	video = video == true;
	callToGroup = callToGroup == true;

	this.initiator = false;
	this.callInitUserId = userId;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = callToGroup? 0: userId;
	this.callChatId = chatId;
	this.callToGroup = callToGroup;
	this.callGroupUsers = this.messenger.userInChat[chatId];
	this.callVideo = video;

	this.callOverlayShow({
		prepare : true,
		toUserId : this.BXIM.userId,
		fromUserId : this.callToGroup? chatId: userId,
		callToGroup : this.callToGroup,
		video : video,
		status : BX.message(this.callToGroup? 'IM_M_CALL_ST_INVITE_2': 'IM_M_CALL_ST_INVITE'),
		buttons : [
			{
				text: BX.message('IM_M_CALL_BTN_ANSWER'),
				className: 'bx-messenger-call-overlay-button-answer',
				events: {
					click : BX.delegate(function() {
						if (join)
							BX.desktop.onCustomEvent("main", "bxCallJoin", [chatId, userId, video, callToGroup]);
						else
							BX.desktop.onCustomEvent("main", "bxCallAnswer", [chatId, userId, video, callToGroup]);

						BX.desktop.windowCommand('close');
					}, this)
				}
			},
			{
				text: BX.message('IM_M_CALL_BTN_HANGUP'),
				className: 'bx-messenger-call-overlay-button-hangup',
				events: {
					click : BX.delegate(function() {
						BX.desktop.onCustomEvent("main", "bxCallDecline", []);
						BX.desktop.windowCommand('close');
					}, this)
				}
			}
		]
	});
	this.desktop.drawOnPlaceholder(this.callOverlay);
	BX.desktop.setWindowPosition({X:STP_CENTER, Y:STP_VCENTER, Width: 470, Height: 120});
};

BX.IM.WebRTC.prototype.callFloatDialog = function(title, stream, audioMuted)
{
	if (!BX.MessengerCommon.isDesktop())
		return false;

	this.audioMuted = audioMuted;

	var minCallWidth = stream? this.desktop.minCallVideoWidth: this.desktop.minCallWidth;
	var minCallHeight = stream? this.desktop.minCallVideoHeight: this.desktop.minCallHeight;

	var callOverlayStyle = {
		width : minCallWidth+'px',
		height : minCallHeight+'px'
	};

	this.callOverlay =  BX.create("div", { props : { className : 'bx-messenger-call-float'+(stream? '': ' bx-messenger-call-float-audio')}, style : callOverlayStyle, children: [
		this.callOverlayVideoMain = (!stream? null: BX.create("video", {
			attrs : { autoplay : true, src: stream },
			props : { className : 'bx-messenger-call-float-video'},
			events: {'click': BX.delegate(function(){
				BX.desktop.onCustomEvent("main", "bxCallOpenDialog", []);
			}, this)}
		})),
		BX.create("div", { props : { className : 'bx-messenger-call-float-buttons'}, children: [
			BX.create("div", {
				props : { className : 'bx-messenger-call-float-button bx-messenger-call-float-button-mic'+(this.audioMuted? ' bx-messenger-call-float-button-mic-disabled':'')},
				events: {'click': BX.delegate(function(e)
				{
					this.audioMuted = !this.audioMuted;
					BX.desktop.onCustomEvent("main", "bxCallMuteMic", [this.audioMuted]);

					BX.toggleClass(BX.proxy_context, 'bx-messenger-call-float-button-mic-disabled');
					var text = BX.findChildByClassName(BX.proxy_context, "bx-messenger-call-float-button-text");
					text.innerHTML = BX.message('IM_M_CALL_BTN_MIC')+' '+BX.message('IM_M_CALL_BTN_MIC_'+(this.audioMuted? 'OFF': 'ON'));

					BX.PreventDefault(e);
				}, this)},
				children: [
					BX.create("span", { props : { className : 'bx-messenger-call-float-button-icon'}}),
					BX.create("span", { props : { className : 'bx-messenger-call-float-button-text'}, html: BX.message('IM_M_CALL_BTN_MIC')+' '+BX.message('IM_M_CALL_BTN_MIC_'+(this.audioMuted? 'OFF': 'ON'))})
				]
			}),
			BX.create("div", {
				props : { className : 'bx-messenger-call-float-button bx-messenger-call-float-button-decline'},
				events: {'click': BX.delegate(function(e){
					BX.desktop.onCustomEvent("main", "bxCallDecline", []);
					BX.desktop.windowCommand('close');

					BX.PreventDefault(e);
				}, this)},
				children: [
					BX.create("span", { props : { className : 'bx-messenger-call-float-button-icon'}}),
					BX.create("span", { props : { className : 'bx-messenger-call-float-button-text'}, html: BX.message('IM_M_CALL_BTN_HANGUP')})
				]
			})
		]})
	]});

	this.desktop.drawOnPlaceholder(this.callOverlay);

	BX.desktop.setWindowMinSize({ Width: minCallWidth, Height: minCallHeight });
	BX.desktop.setWindowResizable(false);
	BX.desktop.setWindowClosable(false);
	BX.desktop.setWindowResizable(false);
	BX.desktop.setWindowTitle(BX.util.htmlspecialcharsback(BX.util.htmlspecialcharsback(title)));

	if (BXDesktopSystem.QuerySettings('global_topmost_x',null))
	{
		BX.desktop.setWindowPosition({X: parseInt(BXDesktopSystem.QuerySettings('global_topmost_x', STP_RIGHT)), Y: parseInt(BXDesktopSystem.QuerySettings('global_topmost_y', STP_TOP)), Width: minCallWidth, Height: minCallHeight, Mode: STP_FRONT});
		if (!BX.browser.IsMac())
			BX.desktop.setWindowPosition({X: parseInt(BXDesktopSystem.QuerySettings('global_topmost_x', STP_RIGHT)), Y: parseInt(BXDesktopSystem.QuerySettings('global_topmost_y', STP_TOP)), Width: minCallWidth, Height: minCallHeight, Mode: STP_FRONT});
	}
	else
	{
		BX.desktop.setWindowPosition({X: STP_RIGHT, Y: STP_TOP, Width: minCallWidth, Height: minCallHeight, Mode: STP_FRONT});
		if (!BX.browser.IsMac())
			BX.desktop.setWindowPosition({X: STP_RIGHT, Y: STP_TOP, Width: minCallWidth, Height: minCallHeight, Mode: STP_FRONT});
	}

	if (stream)
	{
		clearInterval(this.callAspectCheckInterval);
		this.callAspectCheckInterval = setInterval(BX.delegate(function(){
			if (this.callOverlayVideoMain.offsetWidth < this.callOverlayVideoMain.offsetHeight)
			{
				if (this.callAspectHorizontal)
				{
					this.callAspectHorizontal = false;
					BX.addClass(this.callOverlay, 'bx-messenger-call-overlay-aspect-vertical');
					BX.desktop.setWindowSize({Width: this.desktop.minCallVideoHeight, Height: this.desktop.minCallVideoWidth});
				}
			}
			else
			{
				if (!this.callAspectHorizontal)
				{
					this.callAspectHorizontal = true;
					BX.removeClass(this.callOverlay, 'bx-messenger-call-overlay-aspect-vertical');
					BX.desktop.setWindowSize({Width: this.desktop.minCallVideoWidth, Height: this.desktop.minCallVideoHeight});
				}
			}
		}, this), 500);
	}

	BX.desktop.addCustomEvent("bxCallChangeMainVideo", BX.delegate(function(src) {
		this.callOverlayVideoMain.src = src;
	}, this));
};

BX.IM.WebRTC.prototype.storageSet = function(params)
{
	if (params.key == 'vite')
	{
		if(params.value === true || !this.BXIM.webrtc.callSelfDisabled)
		{
			this.phoneTransferEnabled = params.value;
		}
	}
	else if (params.key == 'viExternalCard')
	{
		if(params.value === false)
		{
			this.hideExternalCall();
		}
	}
};

/* WebRTC Cloud Phone */
BX.IM.WebRTC.prototype.phoneSupport = function()
{
	return this.phoneEnabled && (this.phoneDeviceActive || this.ready());
}

BX.IM.WebRTC.prototype.phoneMute = function()
{
	if (!this.phoneCurrentCall)
		return false;

	this.phoneMicMuted = true;
	this.phoneCurrentCall.muteMicrophone();
}

BX.IM.WebRTC.prototype.phoneUnmute = function()
{
	if (!this.phoneCurrentCall)
		return false;

	this.phoneMicMuted = false;
	this.phoneCurrentCall.unmuteMicrophone();
}

BX.IM.WebRTC.prototype.phoneToggleAudio = function()
{
	if (!this.phoneCurrentCall)
		return false;

	if (this.phoneMicMuted)
	{
		this.phoneCurrentCall.unmuteMicrophone();
		this.phoneCallView.setMuted(false);
	}
	else
	{
		this.phoneCurrentCall.muteMicrophone();
	}
	this.phoneMicMuted = !this.phoneMicMuted;
}

BX.IM.WebRTC.prototype.phoneDeviceCall = function(status)
{
	var result = true;
	if (typeof(status) == 'boolean')
	{
		this.BXIM.setLocalConfig('viDeviceCallBlock', !status);
		BX.localStorage.set('viDeviceCallBlock', !status, 86400);
		if(this.phoneCallView)
			this.phoneCallView.setDeviceCall(status);
	}
	else
	{
		var deviceCallBlock = this.BXIM.getLocalConfig('viDeviceCallBlock');
		if (!deviceCallBlock)
		{
			deviceCallBlock = BX.localStorage.get('viDeviceCallBlock');
		}
		result = this.phoneDeviceActive && deviceCallBlock != true;
	}
	return result;

}

BX.IM.WebRTC.prototype.openKeyPad = function(e)
{
	var bindElement;
	var offsetTop;
	var offsetLeft;
	var anglePosition = this.BXIM.design == 'DESKTOP' && !this.callActive? "left": "top";
	var angleOffset = this.BXIM.design == 'DESKTOP'? (this.callActive? 120: 76): 94;

	if (!this.phoneSupport() && !(this.BXIM.desktopStatus && this.BXIM.desktopVersion >= 18))
	{
		if (!BX.MessengerCommon.isDesktop())
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_NO_WEBRT'), [
				this.BXIM.platformName == ''? null: new BX.PopupWindowButton({
					text : BX.message('IM_M_CALL_BTN_DOWNLOAD'),
					className : "popup-window-button-accept",
					events : { click : BX.delegate(function() { window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp"); BX.proxy_context.popupWindow.close(); }, this) }
				}),
				new BX.PopupWindowButton({
					text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
					className : "popup-window-button-decline",
					events : { click : function() { this.popupWindow.close(); } }
				})
			]);
		}
		return false;
	}

	if(this.callInit || this.callActive || this.phoneCurrentCall || BX.localStorage.get('viInitedCall') || BX.localStorage.get('viExternalCard'))
	{
		return false;
	}

	if(this.phoneKeypad !== null)
	{
		this.phoneKeypad.close();
		return false;
	}

	if (this.messenger.popupMessenger)
	{
		if (!this.callActive)
		{
			if (this.BXIM.design == 'DESKTOP')
			{
				bindElement = BX('bx-desktop-tab-im-phone');
				offsetTop = -110;
				offsetLeft = 60;
			}
			else
			{
				BX.addClass(this.messenger.popupContactListSearchCall, 'bx-messenger-input-search-call-active');
				bindElement = this.messenger.popupContactListSearchCall;
				offsetTop = -10;
				offsetLeft = -52;
			}
		}
		else
		{
			bindElement = BX('bx-messenger-call-overlay-button-keypad');
			offsetTop = 7;
			offsetLeft = BX.MessengerCommon.isPage()? -90: -65;
			if (BX.MessengerCommon.isPage())
			{
				BX.MessengerWindow.closeTab('im-phone');
			}
		}
	}
	else
	{
		bindElement = this.notify.panelButtonCall;
		offsetTop = this.notify.panelButtonCallOffsetTop? this.notify.panelButtonCallOffsetTop: 5;
		offsetLeft = this.notify.panelButtonCallOffsetLeft? this.notify.panelButtonCallOffsetLeft: -75;
		anglePosition = this.notify.panelButtonCallAnlgePosition? this.notify.panelButtonCallAnlgePosition: anglePosition;
		angleOffset = this.notify.panelButtonCallAnlgeOffset? this.notify.panelButtonCallAnlgeOffset: angleOffset;
	}

	this.messenger.setClosingByEsc(false);
	this.phoneKeypad = new BX.PhoneKeypad({
		bindElement: bindElement,
		offsetTop: offsetTop,
		offsetLeft: offsetLeft,
		anglePosition: anglePosition,
		angleOffset: angleOffset,
		defaultLineId: this.phoneDefaultLineId,
		lines: this.phoneLines,
		availableLines: this.phoneAvailableLines,
		history: this.phoneGetHistory(),

		onDial: function(e)
		{
			var params = {};
			this.phoneKeypad.close();

			if(e.lineId)
			{
				params['LINE_ID'] = e.lineId;
			}

			this.phoneCall(e.phoneNumber, params);
		}.bind(this),
		onClose: function()
		{
			this.phoneKeypad = null;
			if (this.messenger.popupMessenger && this.BXIM.design == 'DESKTOP' && BX.MessengerCommon.isPage())
			{
				if (BX.MessengerWindow.lastTabTarget != 'im')
				{
					BX.MessengerWindow.changeTab(this.BXIM.dialogOpen? 'im': 'notify');
				}
				else
				{
					BX.MessengerWindow.closeTab('im-phone');
				}
			}

			this.messenger.setClosingByEsc(true);
			BX.removeClass(this.messenger.popupContactListSearchCall, 'bx-messenger-input-search-call-active');
		}.bind(this)
	});
	this.phoneKeypad.show();
}

BX.IM.WebRTC.prototype.phoneCount = function(numbers)
{
	var count = 0;
	if (typeof (numbers) === 'object')
	{
		if (numbers.PERSONAL_MOBILE)
			count++;
		else if (numbers.PERSONAL_PHONE)
			count++;
		else if (numbers.WORK_PHONE)
			count++;
	}

	return count;
}

BX.IM.WebRTC.prototype.phoneDisconnectAfterCall = function(value)
{
	if (BX.MessengerCommon.isDesktop())
	{
		value = false;
	}

	this.phoneDisconnectAfterCallFlag = value === false? false: true;

	return true;
}

BX.IM.WebRTC.prototype.phoneDisplayExternal = function(params)
{
	var number = params.phoneNumber;
	this.phoneLog(number, params);

	this.phoneNumberUser = BX.util.htmlspecialchars(number);

	number = BX.MessengerCommon.phoneCorrect(number);
	if (typeof(params) != 'object')
		params = {};

	if (this.callActive || this.callInit)
		return;

	if(this.phoneCallView)
		return;

	this.initiator = true;
	this.callInitUserId = this.BXIM.userId;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = 0;
	this.callChatId = 0;
	this.callToGroup = 0;
	this.callGroupUsers = [];
	this.phoneNumber = number;

	this.phoneCallView = new BX.PhoneCallView({
		BXIM: this.BXIM,
		callId: params.callId,
		config: params.config,
		direction: BX.PhoneCallView.Direction.outgoing,
		phoneNumber : this.phoneNumber,
		statusText : BX.message('IM_M_CALL_ST_CONNECT'),
		hasSipPhone: true,
		deviceCall: true,
		portalCall: params.portalCall,
		portalCallUserId: params.portalCallUserId,
		portalCallData: params.portalCallData,
		crm: params.showCrmCard,
		crmEntityType: params.crmEntityType,
		crmEntityId: params.crmEntityId,
		crmData: this.phoneCrm
	});
	this.bindPhoneViewCallbacks(this.phoneCallView);
	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.idle);
	this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);
	this.phoneCallView.show();
}

BX.IM.WebRTC.prototype.isRestLine = function(lineId)
{
	if(this.phoneLines.hasOwnProperty(lineId))
		return this.phoneLines[lineId].TYPE === 'REST';
	else
		return false;
};

BX.IM.WebRTC.prototype.setPhoneNumber = function(phoneNumber)
{
	var matches = /(\d+)([;#]*)([\d,]*)/.exec(phoneNumber);
	this.phoneFullNumber = phoneNumber;
	if(matches)
	{
		this.phoneNumber = matches[1];
	}
};

BX.IM.WebRTC.prototype.phoneCall = function(number, params)
{
	if (BX.localStorage.get('viInitedCall'))
		return false;

	if (this.phoneCallView)
		return false;

	if(this.callActive || this.callInit)
		return false;

	if (this.popupKeyPad)
		this.popupKeyPad.close();

	if (number != '')
	{
		this.phoneAddToHistory(number);
	}

	var lineId = BX.type.isPlainObject(params) && params['LINE_ID'] ? params['LINE_ID'] : this.phoneDefaultLineId;
	if(this.isRestLine(lineId))
	{
		BX.MessengerCommon.phoneStartCallViaRestApp(number, lineId, params);
		return true;
	}

	this.phoneLog(number, params);

	this.phoneNumberUser = BX.util.htmlspecialchars(number);
	numberOriginal = number;

	if (typeof(params) != 'object')
		params = {};

	var internationalNumber = BX.MessengerCommon.phoneCorrect(number);
	if(internationalNumber[0] === '+')
	{
		internationalNumber = internationalNumber.substr(1);
	}

	if (internationalNumber.length <= 0)
	{
		this.BXIM.openConfirm({title: BX.message('IM_PHONE_WRONG_NUMBER'), message: BX.message('IM_PHONE_WRONG_NUMBER_DESC')});
		return false;
	}

	this.setPhoneNumber(internationalNumber);

	if (!this.phoneSupport())
	{
		if (!BX.MessengerCommon.isDesktop())
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_NO_WEBRT'), [
				new BX.PopupWindowButton({
					text : BX.message('IM_M_CALL_BTN_DOWNLOAD'),
					className : "popup-window-button-accept",
					events : { click : BX.delegate(function() { window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp"); BX.proxy_context.popupWindow.close(); }, this) }
				}),
				new BX.PopupWindowButton({
					text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
					className : "popup-window-button-decline",
					events : { click : function() { this.popupWindow.close(); } }
				})
			]);
		}
		return false;
	}

	this.initiator = true;
	this.callInitUserId = this.BXIM.userId;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = 0;
	this.callChatId = 0;
	this.callToGroup = 0;
	this.phoneCallExternal = this.phoneDeviceCall();
	this.callGroupUsers = [];
	this.phoneParams = params;

	this.phoneCallView = new BX.PhoneCallView({
		phoneNumber: this.phoneFullNumber,
		callTitle: this.phoneNumberUser,
		fromUserId: this.BXIM.userId,
		direction: BX.PhoneCallView.Direction.outgoing,
		uiState: BX.PhoneCallView.UiState.connectingOutgoing,
		status: BX.message('IM_M_CALL_ST_CONNECT'),
		hasSipPhone: this.phoneDeviceActive,
		deviceCall: this.phoneCallExternal,
		BXIM: this.BXIM,
		crmData: this.phoneCrm,
		autoFold: (params['AUTO_FOLD'] === true)
	});
	this.bindPhoneViewCallbacks(this.phoneCallView);
	this.phoneCallView.show();

	this.BXIM.playSound("start");

	if (this.phoneCallExternal)
	{
		this.phoneCallDevice = 'PHONE';
		this.phoneCallView.setProgress('wait');
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_PHONE_NOTICE'));

		BX.MessengerCommon.phoneCommand(
			'deviceStartCall',
			{
				'NUMBER': numberOriginal.toString().replace(/[^0-9\*#,;]/g, ''),
				'PARAMS': params
			},
			true,
			function(response)
			{
				if(response.ERROR)
				{
					this.phoneCallView.setProgress('error');
					this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_PHONE_ERROR'));
					this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);
					this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);
				}
				else
				{
					this.phoneCallId = response.CALL_ID;
					this.phoneCallExternal = (response.EXTERNAL == true);
					this.phoneCallConfig = response.CONFIG;
					this.phoneCallView.setProgress('wait');
					this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_WAIT_PHONE'));
					this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);
					this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
				}

				if (BX.MessengerCommon.isDesktop())
				{
					//todo
					BX.desktop.changeTab('im');
					BX.desktop.windowCommand("show");
					this.BXIM.desktop.closeTopmostWindow();
				}

			}.bind(this)
		);
	}
	else
	{
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_CALL_INIT'));

		this.phoneApiInit().then(function()
		{
			this.phoneOnSDKReady();
		}.bind(this));
	}
}

BX.IM.WebRTC.prototype.phoneAddToHistory = function(phoneNumber)
{
	var oldHistory = this.phoneHistory;
	var phoneIndex = oldHistory.indexOf(phoneNumber);

	if(phoneIndex === 0)
	{
		//it's the first element already, nothing to do
	}
	else if (phoneIndex > 0)
	{
		//moving number to the top
		oldHistory.splice(phoneIndex, phoneIndex);
		this.phoneHistory = [phoneNumber].concat(oldHistory);
	}
	else
	{
		//adding as the top element of history
		this.phoneHistory = [phoneNumber].concat(oldHistory.slice(0, 4));
	}
	this.BXIM.setLocalConfig('phone-history', this.phoneHistory);
}

BX.IM.WebRTC.prototype.phoneGetHistory = function()
{
	return this.phoneHistory;
}

BX.IM.WebRTC.prototype.startCallList = function(callListId, params)
{
	callListId = parseInt(callListId);
	if(callListId == 0 || this.callActive || this.callInit || this.phoneCallView || this.isCallListMode())
		return false;

	this.callListId = callListId;
	this.phoneCallView = new BX.PhoneCallView({
		crm: true,
		callListId: callListId,
		callListStatusId: params.callListStatusId,
		callListItemIndex: params.callListItemIndex,
		direction: BX.PhoneCallView.Direction.outgoing,
		makeCall: (params.makeCall === true),
		uiState: BX.PhoneCallView.UiState.outgoing,
		BXIM: this.BXIM,
		webformId: params.webformId || 0,
		webformSecCode: params.webformSecCode || '',
		hasSipPhone: this.phoneDeviceActive,
		deviceCall: this.phoneDeviceCall(),
		crmData: this.phoneCrm
	});

	this.bindPhoneViewCallbacks(this.phoneCallView);
	this.phoneCallView.show();

	return true;
};

BX.IM.WebRTC.prototype.isCallListMode = function()
{
	return (this.callListId > 0);
};

BX.IM.WebRTC.prototype.callListMakeCall = function(e)
{
	if(this.isRestLine(this.phoneDefaultLineId))
	{
		BX.MessengerCommon.phoneStartCallViaRestApp(
			e.phoneNumber,
			this.phoneDefaultLineId,
			{
				'ENTITY_TYPE': 'CRM_' + e.crmEntityType,
				'ENTITY_ID': e.crmEntityId,
				'CALL_LIST_ID': e.callListId
			}
		);
		return true;
	}

	if (BX.localStorage.get('viInitedCall'))
		return false;

	if(this.callActive || this.callInit)
		return false;

	if(!this.phoneCallView)
		return false;

	this.lastCallListCallParams = e;

	if (typeof(params) != 'object')
		params = {};

	if (!this.phoneSupport())
	{
		this.phoneCallView.setStatusText(BX.message('IM_CALL_NO_WEBRT'));
		this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);
		return false;
	}

	var number = e.phoneNumber;
	var numberOriginal = number;
	var internationalNumber = BX.MessengerCommon.phoneCorrect(number);
	if(internationalNumber[0] === '+')
		internationalNumber = internationalNumber.substr(1);

	if (internationalNumber.length <= 0)
	{
		this.phoneCallView.setStatusText(BX.message('IM_PHONE_WRONG_NUMBER_DESC'));
		return false;
	}

	this.initiator = true;
	this.callInitUserId = this.BXIM.userId;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = 0;
	this.callChatId = 0;
	this.callToGroup = 0;
	this.phoneCallExternal = this.phoneDeviceCall();
	this.callGroupUsers = [];
	this.setPhoneNumber(internationalNumber);
	this.phoneParams = {
		'ENTITY_TYPE': 'CRM_' + e.crmEntityType,
		'ENTITY_ID': e.crmEntityId,
		'CALL_LIST_ID': e.callListId
	};

	this.BXIM.playSound("start");

	if (this.phoneCallExternal)
	{
		this.phoneCallDevice = 'PHONE';
		this.phoneCallView.setProgress('wait');
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_PHONE_NOTICE'));
		this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
		BX.MessengerCommon.phoneCommand(
			'deviceStartCall',
			{
				'NUMBER': numberOriginal.toString().replace(/[^0-9\*#,;]/g, ''),
				'PARAMS': this.phoneParams
			},
			true,
			function(response)
			{
				if(response.ERROR)
				{
					this.phoneCallView.setProgress('error');
					this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_PHONE_ERROR'));
					this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);
					this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);
				}
				else
				{
					this.phoneCallId = response.CALL_ID;
					this.phoneCallExternal = (params.EXTERNAL == true);
					this.phoneCallConfig = params.CONFIG;
					this.phoneCallView.setProgress('wait');
					this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_WAIT_PHONE'));
					this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);
					this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
				}

				if (BX.MessengerCommon.isDesktop())
				{
					//todo
					BX.desktop.changeTab('im');
					BX.desktop.windowCommand("show");
					this.BXIM.desktop.closeTopmostWindow();
				}

			}.bind(this)
		);
	}
	else
	{
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_CALL_INIT'));
		this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
		this.phoneApiInit().then(function()
		{
			this.phoneOnSDKReady();
		}.bind(this));
	}
}

BX.IM.WebRTC.prototype.phoneIncomingAnswer = function()
{
	this.BXIM.stopRepeatSound('ringtone');
	this.callSelfDisabled = true;
	BX.MessengerCommon.phoneCommand('answer', {'CALL_ID' : this.phoneCallId});

	if (this.popupKeyPad)
		this.popupKeyPad.close();

	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);
	this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);

	this.phoneApiInit().then(function()
	{
		BX.MessengerCommon.phoneCommand('ready', {'CALL_ID': this.phoneCallId});
	}.bind(this));
}

BX.IM.WebRTC.prototype.phoneApiInit = function()
{
	var result = new BX.Promise();
	if (!this.phoneSupport())
	{
		result.reject('Telephony is not supported');
		return result;
	}

	if(this.phoneAPI && this.phoneAPI.connected())
	{
		if(this.defaultMicrophone)
		{
			this.phoneAPI.useAudioSource(this.defaultMicrophone);
		}
		if(this.defaultSpeaker)
		{
			VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({
				outputId: this.defaultSpeaker
			});
		}

		result.resolve();
		return result;
	}

	var phoneApiParameters = {
		useRTCOnly: true,
		micRequired: true,
		videoSupport: false,
		progressTone: false
	};


	if(this.enableMicAutoParameters === false)
	{
		phoneApiParameters.audioConstraints = {optional: [
			{echoCancellation:false},
			{googEchoCancellation:false},
			{googEchoCancellation2:false},
			{googDAEchoCancellation:false},
			{googAutoGainControl: false},
			{googAutoGainControl2: false},
			{mozAutoGainControl: false},
			{googNoiseSuppression: false},
			{googNoiseSuppression2: false},
			{googHighpassFilter: false},
			{googTypingNoiseDetection: false},
			{googAudioMirroring: false}
		]};
	}

	BX.Voximplant.getClient({
		debug: this.debug,
		apiParameters: phoneApiParameters
	}).then(function(client)
	{
		this.phoneAPI = client;

		if(this.defaultMicrophone)
		{
			this.phoneAPI.useAudioSource(this.defaultMicrophone);
		}
		if(this.defaultSpeaker)
		{
			VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({
				outputId: this.defaultSpeaker
			});
		}

		if(BX.MessengerCommon.isDesktop() && BX.type.isFunction(this.phoneAPI.setLoggerCallback))
		{
			this.phoneAPI.enableSilentLogging();
			this.phoneAPI.setLoggerCallback(function(e)
			{
				this.phoneLog(e.label + ": " + e.message);
			}.bind(this))
		}

		this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionFailed, this.phoneOnConnectionFailed.bind(this));
		this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionClosed, this.phoneOnConnectionClosed.bind(this));
		this.phoneAPI.addEventListener(VoxImplant.Events.IncomingCall, this.phoneOnIncomingCall.bind(this));
		this.phoneAPI.addEventListener(VoxImplant.Events.MicAccessResult, this.phoneOnMicResult.bind(this));
		this.phoneAPI.addEventListener(VoxImplant.Events.SourcesInfoUpdated, this.phoneOnInfoUpdated.bind(this));
		this.phoneAPI.addEventListener(VoxImplant.Events.NetStatsReceived, this.phoneOnNetStatsReceived.bind(this));
		result.resolve();

	}.bind(this)).catch(function(e)
	{
		BX.MessengerCommon.phoneCommand('connectionError', {
			'CALL_ID': this.BXIM.webrtc.phoneCallId,
			'ERROR': e
		});

		this.phoneCallFinish();
		this.BXIM.playSound('error');
		this.callOverlayProgress('offline');
		this.callAbort(BX.message('IM_PHONE_ERROR'));
		this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);

		result.reject('Could not connect to Voximplant cloud');
	}.bind(this));

	return result;

	// old version for history
	if (this.phoneAPI)
	{
		if (this.phoneSDKinit)
		{
			if (this.phoneIncoming)
			{
				BX.MessengerCommon.phoneCommand('ready', {'CALL_ID': this.phoneCallId});
			}
			else if (this.callInitUserId == this.BXIM.userId)
			{
				this.phoneOnSDKReady();
			}

		}
		else
		{
			this.phoneOnSDKReady();
		}
		return true;
	}

	this.phoneAPI = VoxImplant.getInstance();
	this.phoneAPI.addEventListener(VoxImplant.Events.SDKReady, BX.delegate(this.phoneOnSDKReady, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionEstablished, BX.delegate(this.phoneOnConnectionEstablished, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionFailed, BX.delegate(this.phoneOnConnectionFailed, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionClosed, BX.delegate(this.phoneOnConnectionClosed, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.IncomingCall, BX.delegate(this.phoneOnIncomingCall, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.AuthResult, BX.delegate(this.phoneOnAuthResult, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.MicAccessResult, BX.delegate(this.phoneOnMicResult, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.SourcesInfoUpdated, BX.delegate(this.phoneOnInfoUpdated, this));
	this.phoneAPI.addEventListener(VoxImplant.Events.NetStatsReceived, BX.delegate(this.phoneOnNetStatsReceived, this));

	var phoneApiParameters = {
		useRTCOnly: true,
		micRequired: true,
		videoSupport: false,
		progressTone: false
	};

	if(this.debug)
	{
		phoneApiParameters.showDebugInfo = true;
		phoneApiParameters.showWarnings = true;
		phoneApiParameters.prettyPrint = true;
	}

	if(this.enableMicAutoParameters === false)
	{
		phoneApiParameters.audioConstraints = {optional: [
			{echoCancellation:false},
			{googEchoCancellation:false},
			{googEchoCancellation2:false},
			{googDAEchoCancellation:false},
			{googAutoGainControl: false},
			{googAutoGainControl2: false},
			{mozAutoGainControl: false},
			{googNoiseSuppression: false},
			{googNoiseSuppression2: false},
			{googHighpassFilter: false},
			{googTypingNoiseDetection: false},
			{googAudioMirroring: false}
		]};
	}

	this.phoneAPI.init(phoneApiParameters);
	if(this.defaultMicrophone)
	{
		this.phoneAPI.useAudioSource(this.defaultMicrophone);
	}

	if(BX.MessengerCommon.isDesktop() && BX.type.isFunction(this.phoneAPI.setLoggerCallback))
	{
		this.phoneAPI.enableSilentLogging();
		this.phoneAPI.setLoggerCallback(function(e)
		{
			this.phoneLog(e.label + ": " + e.message);
		}.bind(this))
	}

	this.phoneSDKinit = true;
	return true;
}

BX.IM.WebRTC.prototype.phoneOnSDKReady = function(params)
{
	this.phoneLog('SDK ready');

	params = params || {};
	params.delay = params.delay || false;

	if (!params.delay && this.phoneDeviceActive)
	{
		if (!this.phoneIncoming && !this.phoneDeviceCall())
		{
			if (BX.MessengerCommon.isPage())
			{
				BX.MessengerWindow.changeTab('im');
			}
			if (BX.MessengerCommon.isDesktop())
			{
				BX.desktop.windowCommand("show");
				this.desktop.closeTopmostWindow();
			}
			this.callOverlayProgress('wait');
			this.callDialogAllowTimeout = setTimeout(BX.delegate(function (){

				this.phoneOnSDKReady({delay : true});
			}, this), 5000);
			return false;
		}
	}

	if (BX.MessengerCommon.isDesktop() && this.BXIM.init)
	{
		BX.desktop.syncPause(true);
	}

	if (!this.phoneAPI.connected())
	{
		this.phoneAPI.connect(false);

		clearTimeout(this.callDialogAllowTimeout);
		this.callDialogAllowTimeout = setTimeout(BX.delegate(function(){
			this.callDialogAllowShow();
		}, this), 1500);

		this.phoneCallView.setProgress('wait');
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_WAIT_ACCESS'));
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
		if(this.phoneIncoming)
			this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);
		else
			this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);
	}
	else
	{
		this.phoneLog('Connection exists');

		this.phoneCallView.setProgress('connect');
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_CONNECT'));
		this.phoneOnAuthResult({result: true});
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
		if(this.phoneIncoming)
			this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);
		else
			this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);

	}
}

BX.IM.WebRTC.prototype.phoneOnConnectionEstablished = function(e)
{
	BX.MessengerCommon.phoneOnConnectionEstablished(e);
	this.phoneAPI.requestOneTimeLoginKey(this.phoneLogin+"@"+this.phoneServer);
}

BX.IM.WebRTC.prototype.phoneOnConnectionFailed = function(e)
{
	BX.MessengerCommon.phoneOnConnectionFailed(e);
}

BX.IM.WebRTC.prototype.phoneOnConnectionClosed = function(e)
{
	BX.MessengerCommon.phoneOnConnectionClosed(e);
}

BX.IM.WebRTC.prototype.phoneOnIncomingCall = function(params)
{
	BX.MessengerCommon.phoneOnIncomingCall(params);
}

BX.IM.WebRTC.prototype.phoneOnAuthResult = function(e)
{
	BX.MessengerCommon.phoneOnAuthResult(e);
}

BX.IM.WebRTC.prototype.phoneOnMicResult = function(e)
{
	BX.MessengerCommon.phoneOnMicResult(e);
}

BX.IM.WebRTC.prototype.phoneOnInfoUpdated = function(e)
{
	this.phoneLog('Info updated', this.phoneAPI.audioSources(), this.phoneAPI.videoSources());
}

BX.IM.WebRTC.prototype.phoneOnCallConnected = function(e)
{
	if (BX.MessengerCommon.isDesktop() && this.BXIM.init)
	{
		BX.desktop.syncPause(true);
	}

	this.BXIM.stopRepeatSound('ringtone', 5000);
	BX.localStorage.set('viInitedCall', true, 7);

	clearInterval(this.phoneConnectedInterval);
	this.phoneConnectedInterval = setInterval(function(){
		BX.localStorage.set('viInitedCall', true, 7);
	}, 5000);

	this.desktop.closeTopmostWindow();

	this.phoneLog('Call connected', e);

	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connected);
	this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);
	this.phoneCallView.setProgress('online');
	this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_ONLINE'));
	this.callActive = true;
	if (!this.BXIM.windowFocus)
		this.desktop.openCallFloatDialog();
}

BX.IM.WebRTC.prototype.phoneOnCallDisconnected = function(e)
{
	BX.MessengerCommon.phoneOnCallDisconnected(e);
}

BX.IM.WebRTC.prototype.phoneOnCallFailed = function(e)
{
	BX.MessengerCommon.phoneOnCallFailed(e);
}

BX.IM.WebRTC.prototype.phoneOnProgressToneStart = function(e)
{
	BX.MessengerCommon.phoneOnProgressToneStart(e);
}

BX.IM.WebRTC.prototype.phoneOnProgressToneStop = function(e)
{
	BX.MessengerCommon.phoneOnProgressToneStop(e);
}

BX.IM.WebRTC.prototype.phoneOnNetStatsReceived = function(e)
{
	BX.MessengerCommon.phoneOnNetStatsReceived(e);
}

BX.IM.WebRTC.prototype.phoneCallFinish = function()
{
	BX.MessengerCommon.phoneCallFinish();
}

BX.IM.WebRTC.prototype.bindPhoneViewCallbacks = function(callView)
{
	if(!callView instanceof BX.PhoneCallView)
		return false;

	callView.setCallback('mute', function(){this.phoneMute();}.bind(this));
	callView.setCallback('unmute', function(){this.phoneUnmute();}.bind(this));
	callView.setCallback('hold', function(){BX.MessengerCommon.phoneHold();}.bind(this));
	callView.setCallback('unhold', function(){BX.MessengerCommon.phoneUnhold();}.bind(this));
	callView.setCallback('answer', this.phoneIncomingAnswer.bind(this));
	callView.setCallback('skip', function()
	{
		BX.MessengerCommon.phoneCommand('skip', {'CALL_ID': this.BXIM.webrtc.phoneCallId});

		this.phoneCallFinish();
		this.callAbort();
		this.phoneCallView.close();
	}.bind(this));
	callView.setCallback('hangup', function()
	{
		if (this.phoneCallExternal && this.phoneCallId)
		{
			BX.MessengerCommon.phoneCommand('deviceHungup', {'CALL_ID': this.phoneCallId});
		}

		this.phoneCallFinish();
		this.callAbort();
		this.BXIM.playSound('stop');
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_FINISHED'));
		this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);
		if(this.isCallListMode())
		{
			this.phoneCallView.setUiState(BX.PhoneCallView.UiState.outgoing);
			if(this.phoneCallView.isFolded())
			{
				this.phoneCallView.unfold();
			}
		}
		else
		{
			this.phoneCallView.close();
		}

	}.bind(this));
	callView.setCallback('transfer', function(e)
	{
		if(e.type == 'user')
		{
			this.phoneTransferTargetType = 'user';
			this.phoneTransferTargetId = e.userId;
			this.sendInviteTransfer();
		}
		else if(e.type == 'phone')
		{
			this.phoneTransferTargetType = 'pstn';
			this.phoneTransferTargetId = e.phone;
			this.sendInviteTransfer();
		}
	}.bind(this));
	callView.setCallback('cancelTransfer', this.cancelInviteTransfer.bind(this));
	callView.setCallback('completeTransfer', this.completeTransfer.bind(this));
	callView.setCallback('callListMakeCall', this.callListMakeCall.bind(this));
	callView.setCallback('close', function()
	{
		this.callListId = 0;
		if(this.phoneCallView)
		{
			this.phoneCallView.dispose();
			this.phoneCallView = null;
		}

		if(this.phoneCallDevice == 'PHONE')
		{
			this.phoneCallId = '';
			this.callActive = false;
			this.callInit = false;
			this.phoneCallExternal = false;
			this.callSelfDisabled = false;
			clearInterval(this.BXIM.webrtc.phoneConnectedInterval);

			BX.localStorage.set('viExternalCard', false);
		}
	}.bind(this));
	callView.setCallback('switchDevice', function(e)
	{
		var phoneNumber = e.phoneNumber;
		var lastCallListCallParams = this.lastCallListCallParams;
		if (this.phoneCallExternal && this.phoneCallId)
		{
			BX.MessengerCommon.phoneCommand('deviceHungup', {'CALL_ID': this.phoneCallId});
		}
		this.phoneCallFinish();
		this.callAbort();
		this.phoneDeviceCall(!this.phoneDeviceCall());
		this.phoneCallView.setDeviceCall(this.phoneDeviceCall());
		if(this.isCallListMode())
		{
			this.callListMakeCall(lastCallListCallParams);
		}
		else
		{
			this.phoneCallView.close();
			this.phoneCall(phoneNumber);
		}
	}.bind(this));
	callView.setCallback('qualityGraded', function(grade)
	{
		var message = {
			COMMAND: 'gradeQuality',
			grade: grade
		};
		if(this.phoneCurrentCall)
			this.phoneCurrentCall.sendMessage(JSON.stringify(message));

	}.bind(this));
	callView.setCallback('dialpadButtonClicked', function(key)
	{
		BX.MessengerCommon.phoneSendDTMF(key);
	}.bind(this));
}

BX.IM.WebRTC.prototype.phoneIncomingWait = function(params)
{
	/*chatId, callId, callerId, lineNumber, companyPhoneNumber, isCallback*/
	params.isCallback = !!params.isCallback;
	this.phoneLog('incoming call', JSON.stringify(params));

	if (!this.phoneSupport())
	{
		if (!BX.MessengerCommon.isDesktop())
		{
			this.BXIM.openConfirm(BX.message('IM_CALL_NO_WEBRT'), [
				new BX.PopupWindowButton({
					text : BX.message('IM_M_CALL_BTN_DOWNLOAD'),
					className : "popup-window-button-accept",
					events : { click : BX.delegate(function() { window.open(BX.browser.IsMac()? "http://dl.bitrix24.com/b24/bitrix24_desktop.dmg": "http://dl.bitrix24.com/b24/bitrix24_desktop.exe", "desktopApp"); BX.proxy_context.popupWindow.close(); }, this) }
				}),
				new BX.PopupWindowButton({
					text : BX.message('IM_NOTIFY_CONFIRM_CLOSE'),
					className : "popup-window-button-decline",
					events : { click : function() { this.popupWindow.close(); } }
				})
			]);
		}
		return false;
	}

	this.phoneNumberUser = BX.util.htmlspecialchars(params.callerId);
	params.callerId = params.callerId.replace(/[^a-zA-Z0-9\.]/g, '');

	if(this.callActive || this.callInit)
		return false;

	this.initiator = true;
	this.callInitUserId = 0;
	this.callInit = true;
	this.callActive = false;
	this.callUserId = 0;
	this.callChatId = 0;
	this.callToGroup = 0;
	this.callGroupUsers = [];
	this.phoneIncoming = true;
	this.phoneCallId = params.callId;
	this.phoneNumber = params.callerId;
	this.phoneParams = {};

	var direction;

	if (params.isCallback)
		direction = BX.PhoneCallView.Direction.callback;
	else
		direction = BX.PhoneCallView.Direction.incoming;

	this.phoneCallView = new BX.PhoneCallView({
		BXIM: this.BXIM,
		userId : this.BXIM.userId,
		phoneNumber : this.phoneNumber,
		lineNumber : params.lineNumber,
		companyPhoneNumber : params.companyPhoneNumber,
		callTitle : this.phoneNumberUser,
		direction : direction,
		transfer: this.phoneTransferEnabled,
		statusText : (params.isCallback ? BX.message('IM_PHONE_INVITE_CALLBACK') : BX.message('IM_PHONE_INVITE')),
		crm: params.showCrmCard,
		crmEntityType: params.crmEntityType,
		crmEntityId: params.crmEntityId,
		crmActivityId: params.crmActivityId,
		crmActivityEditUrl: params.crmActivityEditUrl,
		callId: this.phoneCallId,
		crmData: this.phoneCrm
	});
	this.bindPhoneViewCallbacks(this.phoneCallView);
	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.incoming);
	this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);
	if(params.config)
	{
		this.phoneCallView.setConfig(params.config);
	}

	this.phoneCallView.show();

	if(params.portalCall)
	{
		this.phoneCallView.setPortalCall(true);
		this.phoneCallView.setPortalCallData(params.portalCallData);
		this.phoneCallView.setPortalCallUserId(params.portalCallUserId);
	}

	if(!this.BXIM.windowFocus && this.BXIM.notifyManager.nativeNotifyGranted())
	{
		var notify = {
			'title':  BX.message('IM_PHONE_DESC'),
			'text':  BX.util.htmlspecialcharsback(this.phoneCallView.getTitle()),
			'icon': this.callUserId? this.messenger.users[this.callUserId].avatar: '',
			'tag':  'im-call'
		};
		notify.onshow = function() {
			var notify = this;
			setTimeout(function(){
				notify.close();
			}, 5000)
		}
		notify.onclick = function() {
			window.focus();
			this.close();
		}
		this.BXIM.notifyManager.nativeNotify(notify)
		}
};

BX.IM.WebRTC.prototype.sendInviteTransfer = function()
{
	if (!this.phoneCurrentCall && this.phoneCallDevice == 'WEBRTC')
		return false;

	if (!this.phoneTransferTargetType || !this.phoneTransferTargetId)
		return false;

	if (this.popupTransferDialog)
		this.popupTransferDialog.close();

	BX.MessengerCommon.phoneCommand('startTransfer',
		{
			'CALL_ID' : this.phoneCallId,
			'TARGET_TYPE': this.phoneTransferTargetType,
			'TARGET_ID': this.phoneTransferTargetId
		}
	).then(function(result)
		{
			if(result.SUCCESS == 'Y')
			{
				this.phoneTransferEnabled = true;
				BX.localStorage.set('vite', true, 1);

				this.phoneTransferCallId = result.DATA.CALL.CALL_ID;
				this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_TRANSFER'));
				this.phoneCallView.setUiState(BX.PhoneCallView.UiState.transferring);

			}
			else
			{
				console.error("Could not start call transfer. Error: ", result.ERRORS);
			}
		}.bind(this)
	);
};

BX.IM.WebRTC.prototype.cancelInviteTransfer = function()
{
	if (!this.phoneCurrentCall && this.phoneCallDevice == 'WEBRTC')
		return false;

	this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_ONLINE'));
	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connected);

	if (this.phoneTransferEnabled)
	{
		BX.MessengerCommon.phoneCommand('cancelTransfer', {'CALL_ID' : this.phoneTransferCallId});
	}

	this.phoneTransferTargetId = 0;
	this.phoneTransferTargetType = '';
	this.phoneTransferCallId = '';
	this.phoneTransferEnabled = false;
	BX.localStorage.set('vite', false, 1);
}

BX.IM.WebRTC.prototype.errorInviteTransfer = function(code, reason)
{
	if (!this.phoneTransferEnabled)
		return false;

	if(code == '403' || code == '410' || code == '486')
	{
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_TRANSFER_' + code));
	}
	else
	{
		this.phoneCallView.setStatusText(BX.message('IM_M_CALL_ST_TRANSFER_1'));
	}
	this.BXIM.playSound('error', true);
	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.transferFailed);

	this.phoneTransferTargetId = 0;
	this.phoneTransferTargetType = '';
	this.phoneTransferCallId = '';
	this.phoneTransferEnabled = false;
	BX.localStorage.set('vite', false, 1);
}

BX.IM.WebRTC.prototype.completeTransfer = function()
{
	BX.MessengerCommon.phoneCommand('completeTransfer', {'CALL_ID' : this.phoneTransferCallId});
}

BX.IM.WebRTC.prototype.startMicTest = function ()
{
	var buttonRecord, buttonPlay, buttonExit, statusLine, selfVideo, outputVideo;
	var recorder;
	var constraints = {audio: {deviceId: {ideal: this.defaultMicrophone}}, video: {deviceId: {ideal: this.defaultCamera}}};
	var recordBlob;
	var state = 'waiting';
	var self = this;
	var chunks = [];

	var layout = BX.create('div', {props: {className: 'bx-messenger-mic-test'}, children: [
		BX.create('div', {props: {className: 'bx-messenger-mic-test-videos'}, children: [
			BX.create('div', {props: {className: 'bx-messenger-mic-test-video-wrap'}, children: [
				selfVideo = BX.create('video', {props: {className: 'bx-messenger-mic-test-video-self'}}),
			]}),
			BX.create('div', {props: {className: 'bx-messenger-mic-test-video-wrap'}, children: [
				outputVideo = BX.create('video', {props: {className: 'bx-messenger-mic-test-video-self'}, events: {
					'ended': function()
					{
						state = 'idle';
						buttonPlay.innerText = BX.message('IM_CALL_MIC_TEST_PLAY_START');
						buttonRecord.disabled = false;
					}
				}})
			]})
		]}),
		BX.create('div', {props: {className: 'bx-messenger-mic-test-buttons'}, children: [
			buttonRecord = BX.create('button', {text: BX.message('IM_CALL_MIC_TEST_RECORD_START'), events: {
				'click': function()
				{
					if(state == 'idle')
					{
						recorder = new MediaRecorder(self.micTestVideoStream, {mimeType: 'video/webm; codecs=vp9'});
						recorder.start();
						recorder.ondataavailable = function(e)
						{
							chunks.push(e.data);
						}
						recorder.onstop = function()
						{
							recordBlob = new Blob(chunks, {'type': 'video/webm'});
							outputVideo.srcObject = recordBlob;
							state = 'idle';
							buttonPlay.disabled = false;
							buttonRecord.innerText = BX.message('IM_CALL_MIC_TEST_RECORD_START')
						}
						outputVideo.src = null;
						buttonRecord.innerText = BX.message('IM_CALL_MIC_TEST_RECORD_STOP')
						buttonPlay.disabled = true;
						state = 'recording';
					}
					else if (state == 'recording')
					{
						recorder.stop();

					}
					else if (state == 'playing')
					{

					}

				}
			}}),
			buttonPlay = BX.create('button', {text: BX.message('IM_CALL_MIC_TEST_PLAY_START'), events: {
				'click': function()
				{
					if(state == 'idle')
					{
						outputVideo.play();
						state = 'playing';
						buttonPlay.innerText = BX.message('IM_CALL_MIC_TEST_PLAY_STOP');
						buttonRecord.disabled = true;
					}
					else if(state == 'playing')
					{
						outputVideo.pause();
						state = 'idle';
						buttonPlay.innerText = BX.message('IM_CALL_MIC_TEST_PLAY_START');
						buttonRecord.disabled = false;
					}
				}
			}}),
			buttonExit = BX.create('button', {text: BX.message('IM_CALL_MIC_TEST_CLOSE'), events: {
				'click': function()
				{
					BX.webrtc.stopMediaStream(self.micTestVideoStream);
					self.micTestVideoStream = null;
					BX.remove(layout);
				}
			}})
		]}),
		statusLine = BX.create('div', {props: {className: 'bx-messenger-mic-test-button-exit'}}),
	]});
	this.messenger.popupMessengerContent.insertBefore(layout, this.messenger.popupMessengerContent.firstChild);

	selfVideo.volume = 0;
	buttonRecord.disabled = true;
	buttonPlay.disabled = true;
	navigator.mediaDevices.getUserMedia(constraints).then(function(stream)
	{
		self.micTestVideoStream = stream;
		selfVideo.srcObject = self.micTestVideoStream;
		selfVideo.play();
		state = 'idle';
		buttonRecord.disabled = false;
	})
}

BX.IM.WebRTC.prototype.showExternalCall = function(params)
{
	var self = this;
	var direction;
	if (this.phoneCallView)
		return;

	setTimeout(function() {
		BX.localStorage.set('viExternalCard', true, 5);
	}, 100);

	clearInterval(this.phoneConnectedInterval);
	this.phoneConnectedInterval = setInterval(function(){
		if(self.phoneCallExternal)
		{
			BX.localStorage.set('viExternalCard', true, 5);
		}
	}, 5000);

	this.phoneCallId = params.callId;
	this.callActive = true;
	this.phoneCallExternal = true;

	if(params.isCallback)
		direction = BX.PhoneCallView.Direction.callback;
	else if(params.fromUserId > 0)
		direction = BX.PhoneCallView.Direction.outgoing;
	else
		direction = BX.PhoneCallView.Direction.incoming;

	this.phoneCallView = new BX.PhoneCallView({
		BXIM: this.BXIM,
		callId: params.callId,
		direction: direction,
		phoneNumber: params.phoneNumber,
		lineNumber: params.lineNumber,
		companyPhoneNumber: params.companyPhoneNumber,
		fromUserId: params.fromUserId,
		toUserId: params.toUserId,
		crm: params.showCrmCard,
		crmEntityType: params.crmEntityType,
		crmEntityId: params.crmEntityId,
		crmActivityId: params.crmActivityId,
		crmActivityEditUrl: params.crmActivityEditUrl,
		crmData: this.phoneCrm
	});
	this.bindPhoneViewCallbacksExternalCall(this.phoneCallView);
	this.phoneCallView.setUiState(BX.PhoneCallView.UiState.externalCard);
	this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);
	this.phoneCallView.setConfig(params.config);
	this.phoneCallView.show();

	if(params.portalCall)
	{
		this.phoneCallView.setPortalCall(true);
		this.phoneCallView.setPortalCallData(params.portalCallData);
		this.phoneCallView.setPortalCallUserId(params.portalCallUserId);
	}
};

BX.IM.WebRTC.prototype.bindPhoneViewCallbacksExternalCall = function(phoneCallView)
{
	phoneCallView.setCallback('close', function()
	{
		if(this.phoneCallView)
		{
			this.phoneCallView.dispose();
			this.phoneCallView = null;
		}

		this.phoneCallId = '';
		this.callActive = false;
		this.phoneCallExternal = false;
		this.callSelfDisabled = false;
		clearInterval(this.BXIM.webrtc.phoneConnectedInterval);
		BX.localStorage.set('viExternalCard', false);
	}.bind(this));

};

BX.IM.WebRTC.prototype.hideExternalCall = function(clearFlag)
{
	if (this.phoneCallView)
	{
		this.phoneCallView.autoClose();
	}
}

BX.IM.WebRTC.prototype.phoneLog = function()
{
	if (BX.MessengerCommon.isDesktop())
	{
		var text = '';
		for (var i = 0; i < arguments.length; i++)
		{
			if(BX.type.isPlainObject(arguments[i]))
			{
				try
				{
					text = text + ' | ' + JSON.stringify(arguments[i]);
				}
				catch (e)
				{
					text = text + ' | (circular structure)';
				}
			}
			else
			{
				text = text + ' | ' + arguments[i];
			}
		}
		BX.desktop.log('phone.'+this.BXIM.userEmail+'.log', text.substr(3));
	}
	if (this.debug)
	{
		if (console)
		{
			try
			{
				console.log('Phone Log', JSON.stringify(arguments));
			}
			catch (e)
			{
				console.log('Phone Log', arguments[0]);
			}

		}
	}
};

BX.IM.ScreenSharing = function(webrtc, params)
{
	if (this.parent)
	{
		this.parent.constructor.apply(this, arguments);
	}
	params = params || {};

	this.webrtc = webrtc;
	this.BXIM = this.webrtc.BXIM;

	this.debug = true;

	this.sdpConstraints = {'mandatory': { 'OfferToReceiveAudio':false, 'OfferToReceiveVideo': true }};

	this.oneway = true;
	this.sourceSelf = null;
	this.sourceOpponent = null;

	this.callWindowBeforeUnload = null;

	BX.addCustomEvent("onImCallEnd", BX.delegate(function(command,params)
	{
		this.callDecline(false);
	}, this));

	BX.addCustomEvent("onPullEvent-im", BX.delegate(function(command,params)
	{
		if (command == 'screenSharing')
		{
			if (params.command == 'inactive')
			{
				this.callDecline(false);
			}
			else if (!this.webrtc.callActive || this.webrtc.callUserId != params.senderId)
			{
				this.callCommand('inactive');
			}
			else
			{
				this.log('Incoming', params.command, params.senderId, JSON.stringify(params));

				if (params.command == 'invite')
				{
					if (this.callInit)
					{
						this.deleteEvents();
					}

					this.initiator = false;
					this.callVideo = true;
					this.callInit = true;
					this.callUserId = params.senderId;
					this.callInitUserId = params.senderId;
					this.callAnswer()
				}
				else if (params.command == 'answer' && this.initiator)
				{
					this.startScreenSharing();
				}
				else if (params.command == 'decline')
				{
					this.callDecline();
				}
				else if (params.command == 'ready')
				{
					this.log('Opponent '+params.senderId+' ready!');
					this.connected[params.senderId] = true;
				}
				else if (params.command == 'reconnect')
				{
					clearTimeout(this.pcConnectTimeout[params.senderId]);
					clearTimeout(this.initPeerConnectionTimeout[params.senderId]);

					if (this.pc[params.senderId])
						this.pc[params.senderId].close();

					delete this.pc[params.senderId];
					delete this.pcStart[params.senderId];

					if (this.callStreamMain == this.callStreamUsers[params.senderId])
						this.callStreamMain = null;
					this.callStreamUsers[params.senderId] = null;

					this.initPeerConnection(params.senderId);
				}
				else if (params.command == 'signaling' && this.callActive)
				{
					this.signalingPeerData(params.senderId, params.peer);
				}
				else
				{
					this.log('Command "'+params.command+'" skip');
				}
			}
		}
	}, this));

	BX.garbage(function(){
		if (this.callInit)
		{
			this.callCommand('decline', true);
		}
	}, this);
};
if (BX.inheritWebrtc)
	BX.inheritWebrtc(BX.IM.ScreenSharing);

BX.IM.ScreenSharing.prototype.startScreenSharing = function()
{
	var options = {
		mandatory:
		{
			chromeMediaSource : 'screen',
			googLeakyBucket : true,
			maxWidth : window.screen.width,
			maxHeight : window.screen.height,
			maxFrameRate : 5
		}
	};

	this.startGetUserMedia(options, false);
};

BX.IM.ScreenSharing.prototype.onUserMediaSuccess = function(stream)
{
	var result = this.parent.onUserMediaSuccess.apply(this, arguments);
	if (!result)
		return false;

	if (this.initiator)
	{
		BX.addClass(this.webrtc.callOverlay, 'bx-messenger-call-overlay-screen-sharing-self');
		this.attachMediaStream(this.webrtc.callOverlayVideoSelf, this.callStreamSelf);
	}

	this.callCommand('ready');

	return true;
};

BX.IM.ScreenSharing.prototype.onUserMediaError = function(error)
{
	var result = this.parent.onUserMediaError.apply(this, arguments);
	if (!result)
		return false;

	this.callDecline();

	return true;
}

BX.IM.ScreenSharing.prototype.setLocalAndSend = function(userId, desc)
{
	var result = this.parent.setLocalAndSend.apply(this, arguments);
	if (!result)
		return false;

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_SIGNALING',
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SHARING' : 'Y', 'COMMAND': 'signaling', 'USER_ID' : userId, 'PEER': JSON.stringify( desc ), 'IM_AJAX_CALL': 'Y', 'sessid': BX.bitrix_sessid()}
	});

	return true;
}

BX.IM.ScreenSharing.prototype.onRemoteStreamAdded = function (userId, event, setMainVideo)
{
	if (!setMainVideo)
		return false;

	BX.addClass(this.webrtc.callOverlay, 'bx-messenger-call-overlay-screen-sharing');
	this.attachMediaStream(this.webrtc.callOverlayVideoReserve, this.webrtc.callStreamMain);
	this.webrtc.callOverlayVideoReserve.play();
	this.attachMediaStream(this.webrtc.callOverlayVideoMain, this.callStreamMain);
	this.webrtc.callOverlayVideoMain.play();

	return true;
}

BX.IM.ScreenSharing.prototype.onRemoteStreamRemoved = function(userId, event)
{
}

BX.IM.ScreenSharing.prototype.onIceCandidate = function (userId, candidates)
{
	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_SIGNALING',
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SHARING' : 'Y', 'COMMAND': 'signaling', 'USER_ID' : userId, 'PEER': JSON.stringify(candidates), 'IM_AJAX_CALL': 'Y', 'sessid': BX.bitrix_sessid()}
	});
}

BX.IM.ScreenSharing.prototype.peerConnectionError = function (userId, event)
{
	this.callDecline();
}

BX.IM.ScreenSharing.prototype.peerConnectionReconnect = function (userId)
{
	var result = this.parent.peerConnectionReconnect.apply(this, arguments);
	if (!result)
		return false;

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_RECONNECT',
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		data: {'IM_SHARING' : 'Y', 'COMMAND': 'reconnect', 'USER_ID' : userId, 'IM_AJAX_CALL': 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(){
			this.initPeerConnection(userId, true);
		}, this)
	});

	return true;
}

BX.IM.ScreenSharing.prototype.deleteEvents = function ()
{
	BX.removeClass(this.webrtc.callOverlay, 'bx-messenger-call-overlay-screen-sharing-self');
	BX.removeClass(this.webrtc.callOverlay, 'bx-messenger-call-overlay-screen-sharing');
	this.webrtc.callOverlayVideoReserve.src = "";
	this.attachMediaStream(this.webrtc.callOverlayVideoSelf, this.webrtc.callStreamSelf);
	this.attachMediaStream(this.webrtc.callOverlayVideoMain, this.webrtc.callStreamMain);
	this.webrtc.callOverlayVideoMain.play();
	this.webrtc.callOverlayVideoSelf.play();

	this.parent.deleteEvents.apply(this, arguments);

	var icon = BX.findChildByClassName(BX('bx-messenger-call-overlay-button-screen'), "bx-messenger-call-overlay-button-screen");
	if (icon)
		BX.removeClass(icon, 'bx-messenger-call-overlay-button-screen-off');

	return true;
}

BX.IM.ScreenSharing.prototype.callInvite = function ()
{
	if (this.callInit)
	{
		this.deleteEvents();
	}

	this.initiator = true;
	this.callVideo = true;

	this.callInit = true;
	this.callActive = true;

	this.callUserId = this.webrtc.callUserId;
	this.callInitUserId = BXIM.userId;
	this.callCommand('invite');

	var icon = BX.findChildByClassName(BX('bx-messenger-call-overlay-button-screen'), "bx-messenger-call-overlay-button-screen");
	if (icon)
		BX.addClass(icon, 'bx-messenger-call-overlay-button-screen-off');
}

BX.IM.ScreenSharing.prototype.callAnswer = function ()
{
	this.callActive = true;
	this.startGetUserMedia();

	this.callCommand('answer');
}

BX.IM.ScreenSharing.prototype.callDecline = function (send)
{
	if (!this.callInit)
		return false;

	send = send !== false;
	if (send)
	{
		this.callCommand('decline');
	}

	this.deleteEvents();
}

BX.IM.ScreenSharing.prototype.callCommand = function(command, async)
{
	if (!this.signalingReady())
		return false;

	BX.ajax({
		url: this.BXIM.pathToCallAjax+'?CALL_COMMAND',
		method: 'POST',
		dataType: 'json',
		timeout: 30,
		async: async != false,
		data: {'IM_SHARING' : 'Y', 'COMMAND': command, 'USER_ID': this.callUserId, 'IM_AJAX_CALL': 'Y', 'sessid': BX.bitrix_sessid()}
	});
};

/* DiskManager */
BX.IM.DiskManager = function(BXIM, params)
{
	this.BXIM = BXIM;
	this.notify = params.notifyClass;
	this.desktop = params.desktopClass;

	this.enable = params.enable;
	this.enableExternal = params.enableExternal;
	this.lightVersion = BXIM.ieVersion == 8 || BXIM.ieVersion == 9;

	this.formBlocked = {};
	this.formAgents = {};

	this.files = params.files;
	for (var fileId in this.files)
	{
		this.files[fileId].date = new Date(this.files[fileId].date);
	}

	this.filesProgress = {};
	this.filesMessage = {};
	this.filesRegister = {};

	this.fileTmpId = 1;

	this.timeout = {};

	BX.garbage(function(){
		var messages = {};
		var chatId = 0;
		for (var tmpId in this.filesMessage)
		{
			messages[tmpId] = this.filesMessage[tmpId];
			if (this.messenger.message[messages[tmpId]])
			{
				chatId = this.messenger.message[messages[tmpId]].chatId;
			}
		}
		if (chatId > 0)
		{
			BX.ajax({
				url: this.BXIM.pathToFileAjax+'?FILE_TERMINATE&V='+this.BXIM.revision,
				method: 'POST',
				dataType: 'json',
				skipAuthCheck: true,
				timeout: 30,
				async: false,
				data: {'IM_FILE_UNREGISTER' : 'Y', CHAT_ID: chatId, FILES: JSON.stringify(this.filesProgress), MESSAGES: JSON.stringify(messages), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()}
			});
		}
	}, this);
};
BX.IM.DiskManager.prototype.getFileMenuIcon = function()
{
	if (!this.enable)
		return null;

	return BX.create("div", {attrs : { title: BX.message('IM_F_UPLOAD_MENU')}, props : { className : "bx-messenger-textarea-file"+(this.lightVersion? " bx-messenger-textarea-file-light": "") }, children : [
		BX.create("div", { attrs: {'title': this.BXIM.ieVersion > 1? BX.message('IM_F_UPLOAD_MENU'): ' '}, props : { className : "bx-messenger-textarea-file-popup"+(this.BXIM.context == "LINES"? " bx-messenger-textarea-file-popup-short": "") }, children : [
			this.messenger.popupMessengerFileForm = BX.create('form', { attrs : { action : this.BXIM.pathToFileAjax, style: this.lightVersion? "z-index: 0": ""}, props : { className : "bx-messenger-textarea-file-form" }, children: [
				BX.create('input', { attrs : { type : 'hidden', name: 'IM_FILE_UPLOAD', value: 'Y'}}),
				this.messenger.popupMessengerFileFormChatId = BX.create('input', { attrs : { type : 'hidden', name: 'CHAT_ID', value: 0}}),
				this.messenger.popupMessengerFileFormRegChatId = BX.create('input', { attrs : { type : 'hidden', name: 'REG_CHAT_ID', value: 0}}),
				this.messenger.popupMessengerFileFormRegMessageId = BX.create('input', { attrs : { type : 'hidden', name: 'REG_MESSAGE_ID', value: 0}}),
				this.messenger.popupMessengerFileFormRegParams = BX.create('input', { attrs : { type : 'hidden', name: 'REG_PARAMS', value: ''}}),
				this.messenger.popupMessengerFileFormRegMessageHidden = BX.create('input', { attrs : { type : 'hidden', name: 'REG_MESSAGE_HIDDEN', value: 'N'}}),
				BX.create('input', { attrs : { type : 'hidden', name: 'IM_AJAX_CALL', value: 'Y'}}),
				this.messenger.popupMessengerFileFormInput = BX.create('input', { attrs : { type : 'file',multiple : 'true', 'title': this.BXIM.ieVersion > 1? BX.message('IM_F_UPLOAD_MENU'): ' '}, props : { className : "bx-messenger-textarea-file-popup-input"}})
			]}),
			this.lightVersion? null: BX.create("div", { props : { className : "bx-messenger-popup-menu-item" }, html: (BX.browser.IsMobile()? BX.message('IM_F_UPLOAD_MENU_1_M'): BX.message('IM_F_UPLOAD_MENU_1'))}),
			this.lightVersion || this.BXIM.context == "LINES"? null: BX.create("div", { props : { className : "bx-messenger-menu-hr" }}),
			this.BXIM.context == "LINES"? null: BX.create("div", { props : { className : "bx-messenger-popup-menu-item" }, html: BX.message('IM_F_UPLOAD_MENU_2'), events:{
				click: BX.delegate(function(){
					this.openFileDialog();
				}, this)
			}}),
			BX.create("div", { props : { className : "bx-messenger-textarea-file-popup-arrow" }})
		]})
	], events: {
		click: BX.delegate(function(e){
			if (this.messenger.popupMessengerConnectionStatusState != 'online')
				return false;

			if (BX.hasClass(this.messenger.popupMessengerFileButton, 'bx-messenger-textarea-file-active'))
			{
				setTimeout(BX.delegate(function(){
					this.messenger.closePopupFileMenu();
				}, this), 100);
			}
			else
			{
				if (parseInt(this.messenger.popupMessengerFileFormChatId.value) <= 0)
				{
					return false;
				}

				if (this.messenger.popupMessengerFileFormInput.getAttribute('disabled'))
				{
					var showNotice = false;
					if (this.messenger.currentTab.toString().substr(0, 4) == 'chat')
					{
						var chatId = this.messenger.currentTab.toString().substr(4);
						if (this.messenger.chat[chatId] && !this.enableExternal && this.messenger.chat[chatId].type == 'lines' && this.messenger.chat[chatId].entity_id.substr(0,8) != 'livechat')
						{
							showNotice = true;
						}
					}
					else if (this.messenger.users[this.messenger.currentTab].bot || this.messenger.users[this.messenger.currentTab].network)
					{
						showNotice = true;
					}

					if (showNotice)
					{
						if (this.BXIM.isAdmin)
						{
							var enableNode = BX.create('div', {children: [
								BX.create('span', {html: BX.message('IM_D_SEND_PUBLIC_ADMIN')+'&nbsp;&nbsp;'}),
								BX.create('span', {props: {className: 'bx-messenger-ajax'}, html: BX.message('IM_D_SEND_PUBLIC_ADMIN_ON'), events: {'click': BX.delegate(function(){
									this.messenger.closeMenuPopup();

									BX.ajax({
										url: this.BXIM.pathToAjax+'?IM_DISK_ACTIVATE_PUBLIC_LINK&V='+this.BXIM.revision,
										method: 'POST',
										dataType: 'json',
										timeout: 30,
										data: {'IM_DISK_ACTIVATE_PUBLIC_LINK' : 'Y', 'STATUS' : 'Y', 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
										onsuccess: BX.delegate(function(data){
											this.tooltip(this.messenger.popupMessengerFileButton, BX.message('IM_D_SEND_PUBLIC_ADMIN_READY'), {offsetLeft: 10});

											this.enableExternal = true;
											this.messenger.popupMessengerFileFormInput.removeAttribute('disabled');
										},this)
									});

								}, this)}}),
							]});

							this.messenger.tooltip(BX.proxy_context, enableNode, {offsetLeft: 10, width: 400});
						}
						else
						{
							this.messenger.tooltip(BX.proxy_context, BX.message('IM_D_SEND_PUBLIC_USER'), {offsetLeft: 10, width: 400});
						}
						return BX.PreventDefault(e);
					}
					else
					{
						return BX.PreventDefault(e);
					}
				}

				this.messenger.closeMenuPopup();
				this.messenger.popupPopupMenuDateCreate = +new Date();
				BX.addClass(this.messenger.popupMessengerFileButton, 'bx-messenger-textarea-file-active');

				BX.onCustomEvent('onImOpenFileMenu', []);

				if (BX.MessengerCommon.isPage())
				{
					BX.addClass(this.messenger.popupMessengerFileButton, 'bx-messenger-textarea-file-desktop');
				}
				this.messenger.setClosingByEsc(false);
			}
		}, this)
	}});
}

BX.IM.DiskManager.prototype.drawHistoryFiles = function(chatId, fileId, params)
{
	if (!this.enable)
		return [];

	if (typeof(this.files[chatId]) == 'undefined')
		return [];

	var fileIds = [];
	if (typeof(fileId) != 'object')
	{
		fileId = parseInt(fileId);
		if (typeof(this.files[chatId][fileId]) == 'undefined')
			return [];

		fileIds.push(fileId);
	}
	else
	{
		fileIds = fileId;
	}
	params = params || {};

	var enableLink = true;
	//if (!BX.MessengerCommon.isDesktop())
	//	enableLink = false;

	var nodeCollection = [];
	for (var i = 0; i < fileIds.length; i++)
	{
		var file = this.files[chatId][fileIds[i]];
		if (!file)
			continue;

		if (!(file.status == 'done' || file.status == 'error'))
			continue;

		var fileDate = BX.MessengerCommon.formatDate(file.date, [
			["tommorow", "tommorow"],
			["today", "today"],
			["yesterday", "yesterday"],
			["", BX.Main.Date.convertBitrixFormat(BX.message("FORMAT_DATE"))]
		]);
		var name = BX.create("span", { props : { className: "bx-messenger-file-user"}, children: [
			BX.create("span", { props : { className: "bx-messenger-file-author"}, html: this.messenger.users[file.authorId]? this.messenger.users[file.authorId].name: file.authorName}),
			BX.create("span", { props : { className: "bx-messenger-file-date"}, html: fileDate})
		]});

		var preview = null;
		if (file.type == 'image' && (file.preview || file.urlPreview))
		{
			if (file.urlPreview)
			{
				var imageNode = BX.create("img", { attrs:{'src': file.urlPreview}, props : { className: "bx-messenger-file-image-text"}});
			}
			else if (file.preview && typeof(file.preview) != 'string')
			{
				var imageNode = file.preview;
			}
			else
			{
				var imageNode = BX.create("img", { attrs:{'src': file.preview}, props : { className: "bx-messenger-file-image-text"}});
			}

			if (enableLink && file.urlShow)
			{
				preview = BX.create("div", {props : { className: "bx-messenger-file-preview"},  children: [
					BX.create("span", {props : { className: "bx-messenger-file-image"},  children: [
						BX.create("a", {attrs: {'href': file.urlShow, 'target': '_blank'}, props : { className: "bx-messenger-file-image-src"},  children: [
							imageNode
						]})
					]}),
					BX.create("br")
				]});
			}
			else
			{
				preview = BX.create("div", {props : { className: "bx-messenger-file-preview"},  children: [
					BX.create("span", {props : { className: "bx-messenger-file-image"},  children: [
						BX.create("span", {props : { className: "bx-messenger-file-image-src"},  children: [
							imageNode
						]})
					]}),
					BX.create("br")
				]});
			}
		}
		var fileName = file.name;
		if (fileName.length > 23)
		{
			fileName = fileName.substr(0, 10)+'...'+fileName.substr(fileName.length-10, fileName.length);
		}

		var title = BX.create("span", { attrs: {'title': file.name}, props : { className: "bx-messenger-file-title"}, html: fileName});
		if (enableLink && (file.urlShow || file.urlDownload))
		{
			title = BX.create("a", { props : { className: "bx-messenger-file-title-href"}, attrs: {'href': file.urlShow? file.urlShow: file.urlDownload, 'target': '_blank'}, children: [title]});
		}
		title = BX.create("div", { props : { className: "bx-messenger-file-attrs"}, children: [
			title,
			BX.create("span", { props : { className: "bx-messenger-file-size"}, html: BX.UploaderUtils.getFormattedSize(file.size)}),
			BX.create("span", { attrs: { title: BX.message('IM_F_MENU')}, props : { className: "bx-messenger-file-menu"}})
		]});

		var status = null;
		if (file.status == 'error')
		{
			status = BX.create("span", { props : { className: "bx-messenger-file-status-error"}, html: file.errorText? file.errorText: BX.message('IM_F_ERROR')})
		}

		if (fileIds.length == 1 && params.showInner == 'Y')
		{
			nodeCollection = [name, title, preview, status];
		}
		else
		{
			nodeCollection.push(BX.create("div", {
				attrs : {id : 'im-file-history-panel-' + file.id, 'data-chatId' : file.chatId, 'data-fileId' : file.id},
				props : {className : "bx-messenger-file"},
				children : [name, title, preview, status]
			}));
		}
		if (fileIds.length == 1 && params.getElement == 'Y')
		{
			nodeCollection = nodeCollection[0];
		}
	}

	return nodeCollection
}
BX.IM.DiskManager.prototype.chatDialogInit = function()
{
	if (!this.messenger.popupMessengerFileFormInput || !BX.Uploader)
		return false;

	this.formAgents['imDialog'] = BX.Uploader.getInstance({
		id : 'imDialog',
		allowUpload : "A",
		uploadMethod : "deferred",
		showImage : true,
		filesInputMultiple: true,
		input : this.messenger.popupMessengerFileFormInput,
		dropZone : this.messenger.popupMessengerBodyDialog,
		fields: {preview: {params: {width: '500', height: '500'}}}
	});

	BX.addCustomEvent(this.formAgents['imDialog'], 'onAttachFiles', BX.delegate(function(files, nodes, agent){
		if (this.messenger.popupMessengerFileFormInput.getAttribute('disabled'))
			return false;

		var chatId = agent.form.CHAT_ID.value;
		if (this.messenger.chat[chatId] && this.messenger.chat[chatId].type == 'open' && !BX.MessengerCommon.userInChat(chatId))
		{
			while (files.length > 0)
			{
			   files.pop();
			}
		}
		else if (this.messenger.chat[chatId] && chatId == this.messenger.generalChatId && !this.messenger.canSendMessageGeneralChat)
		{
			while (files.length > 0)
			{
			   files.pop();
			}
		}
	}, this));

	BX.addCustomEvent(this.formAgents['imDialog'].dropZone, 'dragEnter', BX.delegate(function(e){
		if (this.messenger.currentTab.toString().substr(0, 4) == 'chat' && this.messenger.chat[this.BXIM.messenger.currentTab.substr(4)].type == 'open')
		{
			if (!BX.MessengerCommon.userInChat(this.messenger.currentTab.substr(4)))
				return false;
		}
		if (this.messenger.currentTab.toString().substr(0, 4) == 'chat' && this.messenger.currentTab.toString().substr(4) == this.messenger.generalChatId && !this.messenger.canSendMessageGeneralChat)
		{
			return false;
		}

		if (parseInt(this.messenger.popupMessengerFileFormChatId.value) <= 0 || this.messenger.popupMessengerFileFormInput.getAttribute('disabled'))
			return false;

		var isFileTransfer = false;

		if (e && e["dataTransfer"] && e["dataTransfer"]["types"])
		{
			for (var i in e["dataTransfer"]["types"])
			{
				if (e["dataTransfer"]["types"][i] === "Files")
				{
					isFileTransfer = true;
					break;
				}
			}
		}
		if (isFileTransfer === false)
			return false;

		BX.style(this.messenger.popupMessengerFileDropZone, 'display', 'block');
		BX.style(this.messenger.popupMessengerFileDropZone, 'width', (this.messenger.popupMessengerBodyDialog.offsetWidth-2)+'px');
		BX.style(this.messenger.popupMessengerFileDropZone, 'height', (this.messenger.popupMessengerBodyDialog.offsetHeight-2)+'px');
		clearTimeout(this.messenger.popupMessengerFileDropZoneTimeout);
		this.messenger.popupMessengerFileDropZoneTimeout = setTimeout(BX.delegate(function(){
			BX.addClass(this.messenger.popupMessengerFileDropZone, "bx-messenger-file-dropzone-active");
		},this), 10);
	}, this));

	BX.addCustomEvent(this.formAgents['imDialog'].dropZone, 'dragLeave', BX.delegate(function(){
		if (this.messenger.currentTab.toString().substr(0, 4) == 'chat' && this.messenger.chat[this.messenger.currentTab.substr(4)].type == 'open')
		{
			if (!BX.MessengerCommon.userInChat(this.messenger.currentTab.substr(4)))
				return false;
		}

		BX.removeClass(this.messenger.popupMessengerFileDropZone, "bx-messenger-file-dropzone-active");
		clearTimeout(this.messenger.popupMessengerFileDropZoneTimeout);
		this.messenger.popupMessengerFileDropZoneTimeout = setTimeout(BX.delegate(function(){
			BX.style(this.messenger.popupMessengerFileDropZone, 'display', 'none');
			BX.style(this.messenger.popupMessengerFileDropZone, 'width', 0);
			BX.style(this.messenger.popupMessengerFileDropZone, 'height', 0);
		}, this), 300);
	}, this));

	BX.addCustomEvent(this.formAgents['imDialog'], "onError", BX.delegate(BX.MessengerCommon.diskChatDialogUploadError, BX.MessengerCommon));

	BX.addCustomEvent(this.formAgents['imDialog'], "onFileinputIsReinited", BX.delegate(function(fileInput){
		if (!fileInput && !this.formAgents['imDialog'].fileInput)
			return false;

		this.messenger.popupMessengerFileFormInput = fileInput? fileInput: this.formAgents['imDialog'].fileInput;
		if (parseInt(this.messenger.popupMessengerFileFormChatId.value) <= 0)
		{
			this.messenger.popupMessengerFileFormInput.setAttribute('disabled', true);
		}
	}, this));

	BX.addCustomEvent(this.formAgents['imDialog'], "onFileIsInited", BX.delegate(function(id, file, agent){
		BX.MessengerCommon.diskChatDialogFileInited(id, file, agent);
		BX.addCustomEvent(file, 'onUploadStart', BX.delegate(BX.MessengerCommon.diskChatDialogFileStart, BX.MessengerCommon));
		BX.addCustomEvent(file, 'onUploadProgress', BX.delegate(BX.MessengerCommon.diskChatDialogFileProgress, BX.MessengerCommon));
		BX.addCustomEvent(file, 'onUploadDone', BX.delegate(BX.MessengerCommon.diskChatDialogFileDone, BX.MessengerCommon))
		BX.addCustomEvent(file, 'onUploadError', BX.delegate(BX.MessengerCommon.diskChatDialogFileError, BX.MessengerCommon));
	}, this));

	if (BX.DiskFileDialog)
	{
		if (!this.flagFileDialogInited)
		{
			BX.addCustomEvent(BX.DiskFileDialog, 'inited', BX.proxy(this.initEventFileDialog, this));
		}

		BX.addCustomEvent(BX.DiskFileDialog, 'loadItems', BX.delegate(function(link, name)
		{
			if (name != 'im-file-dialog')
				return false;

			BX.DiskFileDialog.target[name] = link.replace('/bitrix/tools/disk/uf.php', this.BXIM.pathToFileAjax);

		}, this));
	}
};

BX.IM.DiskManager.prototype.saveToDiskAction = function(item, params)
{
	var popupConfirm = BX.Disk.showActionModal({
		html: BX.message('IM_DISK_VIEWER_DESCR_PROCESS_SAVE_FILE_TO_OWN_FILES').replace('#NAME#', '<a href="#" class="bx-viewer-file-link">' + item.title +'</a>'),
		showLoaderIcon: true,
		autoHide: false
	});

	var promise = BX.rest.callMethod('im.disk.file.save', {FILE_ID: params.fileId});
	if(promise)
	{
		promise.then(function (result) {
			var data = result.data();
			var pathToFile = BXIM.path.disk.localFile.replace("_FILE_ID_", data.file.id);

			BX.Disk.showActionModal({
				html: BX.message('IM_DISK_VIEWER_DESCR_SAVE_FILE_TO_OWN_FILES').replace('#NAME#', data.file.name).replace('#FOLDER#', '<a href="'+pathToFile+'" target="_blank">'+data.folder.name+'</a>'),
				showLoaderIcon: false,
				autoHide: true
			});
		}.bind(this)).catch(function (error) {
			popupConfirm.destroy();
		}.bind(this))
	}
}

BX.IM.DiskManager.prototype.saveToDisk = function(chatId, fileId, params)
{
	if (!this.files[chatId] || !this.files[chatId][fileId])
		return false;

	if (this.files[chatId][fileId].saveToDiskBlock)
		return false;

	params = params || {};

	this.files[chatId][fileId].saveToDiskBlock = true;

	var boxId = params.boxId? params.boxId: 'im-file';

	var fileBox = BX(boxId+'-'+fileId);
	var element = BX.findChildByClassName(fileBox, "bx-messenger-file-download-disk");
	if (element)
	{
		BX.addClass(element, 'bx-messenger-file-download-block');
		element.innerHTML = BX.message('IM_SAVING');
	}
	else if (boxId == 'im-file-history-panel')
	{
		element = BX.findChildByClassName(fileBox, "bx-messenger-file-date");
		if (element)
		{
			BX.addClass(element.parentNode.parentNode, 'bx-messenger-file-download-block');
			element.setAttribute('data-date', element.innerHTML);
			element.innerHTML = BX.message('IM_SAVING');
		}
	}

	BX.ajax({
		url: this.BXIM.pathToFileAjax+'?FILE_SAVE_TO_DISK&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		skipAuthCheck: true,
		timeout: 30,
		data: {'IM_FILE_SAVE_TO_DISK' : 'Y', CHAT_ID: chatId, FILE_ID: fileId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			this.files[chatId][fileId].saveToDiskBlock = false;

			var fileBox = BX(boxId+'-'+fileId);
			var element = BX.findChildByClassName(fileBox, "bx-messenger-file-download-disk");
			if (element)
			{
				BX.removeClass(element, 'bx-messenger-file-download-block');
				element.innerHTML = BX.message('IM_F_DOWNLOAD_DISK');

			}
			else if (boxId == 'im-file-history-panel')
			{
				element = BX.findChildByClassName(fileBox, "bx-messenger-file-date");
				if (element)
				{
					BX.removeClass(element.parentNode.parentNode, 'bx-messenger-file-download-block');
					element.innerHTML = element.getAttribute('data-date');
				}
				element = BX.findChildByClassName(fileBox, "bx-messenger-file-title");
			}
			if (element && data.ERROR == '')
			{
				var pathToFile = this.BXIM.path.disk.localFile.replace("_FILE_ID_", data.NEW_FILE_ID);
				this.messenger.tooltip(element, BX.message('IM_F_SAVE_OK_2').replace('#URL_START#', '<a href="'+pathToFile+'" target="_blank" class="bx-messenger-file-link">').replace('#URL_END#', '</a>'));
			}
			else
			{
				this.messenger.tooltip(element, BX.message('IM_F_SAVE_ERR'));
			}
		}, this),
		onfailure: BX.delegate(function(){
			this.files[chatId][fileId].saveToDiskBlock = false;
			var fileBox = BX(boxId+'-'+fileId);
			var element = BX.findChildByClassName(fileBox, "bx-messenger-file-download-disk");
			if (element)
			{
				BX.removeClass(element, 'bx-messenger-file-download-block');
				element.innerHTML = BX.message('IM_F_DOWNLOAD_DISK');
				this.messenger.tooltip(element, BX.message('IM_F_SAVE_ERR'));
			}
			else if (boxId == 'im-file-history-panel')
			{
				element = BX.findChildByClassName(fileBox, "bx-messenger-file-date");
				if (element)
				{
					BX.removeClass(element.parentNode.parentNode, 'bx-messenger-file-download-block');
					element.innerHTML = element.getAttribute('data-date');
				}
			}
		}, this)
	});
}

BX.IM.DiskManager.prototype.deleteFile = function(chatId, fileId, params)
{
	if (!this.files[chatId] || !this.files[chatId][fileId])
		return false;

	if (this.files[chatId][fileId].saveToDiskBlock)
		return false;

	params = params || {};

	this.files[chatId][fileId].saveToDiskBlock = true;

	var boxId = params.boxId? params.boxId: 'im-file';

	var fileBox = BX(boxId+'-'+fileId);
	var element = BX.findChildByClassName(fileBox, "bx-messenger-file-download-disk");
	if (element)
	{
		BX.addClass(element, 'bx-messenger-file-download-block');
		element.innerHTML = BX.message('IM_DELETING');
	}
	else if (boxId == 'im-file-history-panel')
	{
		element = BX.findChildByClassName(fileBox, "bx-messenger-file-date");
		if (element)
		{
			BX.addClass(element.parentNode.parentNode, 'bx-messenger-file-download-block');
			element.setAttribute('data-date', element.innerHTML);
			element.innerHTML = BX.message('IM_DELETING');
		}
	}

	BX.ajax({
		url: this.BXIM.pathToFileAjax+'?FILE_DELETE&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		skipAuthCheck: true,
		timeout: 30,
		data: {'IM_FILE_DELETE' : 'Y', CHAT_ID: chatId, FILE_ID: fileId, 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data)
		{
			delete this.files[chatId][fileId];

			var recipientId = BX.MessengerCommon.getRecipientByChatId(chatId);

			if (BX('im-file-history-'+fileId))
			{
				this.messenger.drawHistory(recipientId);
			}
			if (BX('im-file-'+fileId))
			{
				BX.MessengerCommon.drawTab(recipientId, true);
			}
			var fileBox = BX(boxId+'-'+fileId);
			BX.style(fileBox, 'transform','scale(0, 0)');
			BX.style(fileBox, 'height', fileBox.offsetHeight+'px');
			setTimeout(function(){ BX.style(fileBox, 'height', '0px');}, 500);
			setTimeout(function(){ BX.remove(fileBox) }, 700);

			this.messenger.loadHistoryFiles(chatId, true);

		}, this),
		onfailure: BX.delegate(function(){
			this.files[chatId][fileId].saveToDiskBlock = false;
			var fileBox = BX(boxId+'-'+fileId);
			var element = BX.findChildByClassName(fileBox, "bx-messenger-file-download-disk");
			if (element)
			{
				BX.removeClass(element, 'bx-messenger-file-download-block');
				element.innerHTML = BX.message('IM_F_DOWNLOAD_DISK');
				this.messenger.tooltip(element, BX.message('IM_F_SAVE_ERR'));
			}
			else if (boxId == 'im-file-history-panel')
			{
				element = BX.findChildByClassName(fileBox, "bx-messenger-file-date");
				if (element)
				{
					BX.removeClass(element.parentNode.parentNode, 'bx-messenger-file-download-block');
					element.innerHTML = element.getAttribute('data-date');
				}
			}
		}, this)
	});
}

BX.IM.DiskManager.prototype.openFileDialog = function()
{
	this.messenger.setClosingByEsc(false);

	BX.ajax({
		url: this.BXIM.pathToFileAjax+'?action=selectFile&dialogName=im-file-dialog',
		method: 'GET',
		skipAuthCheck: true,
		timeout: 30,
		onsuccess: BX.delegate(function(data) {
			if (typeof(data) == 'object' && data.error)
			{
				this.messenger.setClosingByEsc(true);
			}
		}, this),
		onfailure: BX.delegate(function(){
			this.messenger.setClosingByEsc(true);
		}, this)
	});
}
BX.IM.DiskManager.prototype.initEventFileDialog = function(name)
{
	if (name != 'im-file-dialog' || !BX.DiskFileDialog)
		return false;

	this.flagFileDialogInited = true;

	BX.DiskFileDialog.obCallback[name] = {
		'saveButton' : BX.delegate(function(tab, path, selected){
			this.uploadFromDisk(tab, path, selected);
		}, this),
		'popupShow' : BX.delegate(function(){
			BX.bind(BX.DiskFileDialog.popupWindow.popupContainer, "click", BX.MessengerCommon.preventDefault);
			this.messenger.setClosingByEsc(false);
		}, this),
		'popupDestroy' : BX.delegate(function(){
			this.messenger.setClosingByEsc(true);
		}, this)
	};

	BX.DiskFileDialog.openDialog(name);

}
BX.IM.DiskManager.prototype.uploadFromDisk = function(tab, path, selected, text)
{
	text = text || '';
	var chatId = this.messenger.popupMessengerFileFormChatId.value;
	if (!this.files[chatId])
		this.files[chatId] = {};

	var paramsFileId = []
	for(var i in selected)
	{
		var fileId = i.replace('n', '');

		this.files[chatId]['disk'+fileId] = {
			'id': 'disk'+fileId,
			'tempId': 'disk'+fileId,
			'chatId': chatId,
			'date': new Date(selected[i].modifyDateInt*1000),
			'type': 'file',
			'preview': '',
			'name': selected[i].name,
			'size': selected[i].sizeInt,
			'status': 'upload',
			'progress': -1,
			'authorId': this.BXIM.userId,
			'authorName': this.messenger.users[this.BXIM.userId].name,
			'urlPreview': '',
			'urlShow': '',
			'urlDownload': ''
		};
		paramsFileId.push('disk'+fileId);
	}

	var recipientId = 0;
	if (this.messenger.chat[chatId])
	{
		recipientId = 'chat'+chatId;
	}
	else
	{
		for (var userId in this.messenger.userChat)
		{
			if (this.messenger.userChat[userId] == chatId)
			{
				recipientId = userId;
				break;
			}
		}
	}
	if (!recipientId)
		return false;

	var olSilentMode = 'N';
	if (recipientId.toString().substr(0,4) == 'chat' && this.BXIM.messenger.linesSilentMode && this.BXIM.messenger.linesSilentMode[chatId])
	{
		olSilentMode = 'Y';
	}

	var tmpMessageId = 'tempFile'+this.fileTmpId;
	this.messenger.message[tmpMessageId] = {
		'id': tmpMessageId,
		'chatId': chatId,
		'senderId': this.BXIM.userId,
		'recipientId': recipientId,
		'date': new Date(),
		'text': text,
		'params': {'FILE_ID': paramsFileId, 'CLASS': olSilentMode == "Y"? "bx-messenger-content-item-system": ""}
	};
	if (!this.messenger.showMessage[recipientId])
		this.messenger.showMessage[recipientId] = [];

	this.messenger.showMessage[recipientId].push(tmpMessageId);
	BX.MessengerCommon.drawMessage(recipientId, this.messenger.message[tmpMessageId]);
	BX.MessengerCommon.drawProgessMessage(tmpMessageId);

	this.messenger.sendMessageFlag++;
	this.messenger.popupMessengerFileFormInput.setAttribute('disabled', true);

	BX.ajax({
		url: this.BXIM.pathToFileAjax+'?FILE_UPLOAD_FROM_DISK&V='+this.BXIM.revision,
		method: 'POST',
		dataType: 'json',
		skipAuthCheck: true,
		timeout: 30,
		data: {'IM_FILE_UPLOAD_FROM_DISK' : 'Y', CHAT_ID: chatId, RECIPIENT_ID: recipientId, MESSAGE: text, MESSAGE_TMP_ID: tmpMessageId, 'OL_SILENT': olSilentMode, FILES: JSON.stringify(paramsFileId), 'IM_AJAX_CALL' : 'Y', 'sessid': BX.bitrix_sessid()},
		onsuccess: BX.delegate(function(data) {
			if (data.ERROR != '')
			{
				this.messenger.sendMessageFlag--;
				delete this.messenger.message[tmpMessageId];
				BX.MessengerCommon.drawTab(recipientId);

				return false;
			}

			this.messenger.sendMessageFlag--;
			var messagefileId = [];
			var filesProgress = {};
			for(var tmpId in data.FILES)
			{
				var newFile = data.FILES[tmpId];

				if (parseInt(newFile.id) > 0)
				{
					newFile.date = new Date(newFile.date);
					this.files[data.CHAT_ID][newFile.id] = newFile;
					delete this.files[data.CHAT_ID][tmpId];

					if (BX('im-file-'+tmpId))
					{
						BX('im-file-'+tmpId).setAttribute('data-fileId', newFile.id);
						BX('im-file-'+tmpId).id = 'im-file-'+newFile.id;
						BX.MessengerCommon.diskRedrawFile(data.CHAT_ID, newFile.id);
					}
					messagefileId.push(newFile.id);
				}
				else
				{
					this.files[data.CHAT_ID][tmpId]['status'] = 'error';
					BX.MessengerCommon.diskRedrawFile(data.CHAT_ID, tmpId);
				}
			}

			this.messenger.message[data.MESSAGE_ID] = BX.clone(this.messenger.message[data.MESSAGE_TMP_ID]);
			this.messenger.message[data.MESSAGE_ID]['id'] = data.MESSAGE_ID;
			this.messenger.message[data.MESSAGE_ID]['params']['FILE_ID'] = messagefileId;

			if (this.messenger.popupMessengerLastMessage == data.MESSAGE_TMP_ID)
				this.messenger.popupMessengerLastMessage = data.MESSAGE_ID;

			delete this.messenger.message[data.MESSAGE_TMP_ID];

			var idx = BX.util.array_search(''+data.MESSAGE_TMP_ID+'', this.messenger.showMessage[data.RECIPIENT_ID]);
			if (this.messenger.showMessage[data.RECIPIENT_ID][idx])
				this.messenger.showMessage[data.RECIPIENT_ID][idx] = ''+data.MESSAGE_ID+'';

			if (BX('im-message-'+data.MESSAGE_TMP_ID))
			{
				BX('im-message-'+data.MESSAGE_TMP_ID).id = 'im-message-'+data.MESSAGE_ID;
				var element = BX.findChild(this.messenger.popupMessengerBodyWrap, {attribute: {'data-messageid': ''+data.MESSAGE_TMP_ID}}, true);
				if (element)
				{
					element.setAttribute('data-messageid',	''+data.MESSAGE_ID+'');
					if (element.getAttribute('data-blockmessageid') == ''+data.MESSAGE_TMP_ID)
						element.setAttribute('data-blockmessageid',	''+data.MESSAGE_ID+'');
				}
				else
				{
					var element2 = BX.findChild(this.messenger.popupMessengerBodyWrap, {attribute: {'data-blockmessageid': ''+data.MESSAGE_TMP_ID}}, true);
					if (element2)
					{
						element2.setAttribute('data-blockmessageid', ''+data.MESSAGE_ID+'');
					}
				}
				var lastMessageElementDate = BX.findChildByClassName(element, "bx-messenger-content-item-date");
				if (lastMessageElementDate)
					lastMessageElementDate.innerHTML = ' &nbsp; '+BX.MessengerCommon.formatDate(this.messenger.message[data.MESSAGE_ID].date, BX.MessengerCommon.getDateFormatType('MESSAGE'));
			}
			BX.MessengerCommon.clearProgessMessage(data.MESSAGE_ID);

			if (this.messenger.history[data.RECIPIENT_ID])
				this.messenger.history[data.RECIPIENT_ID].push(data.MESSAGE_ID);
			else
				this.messenger.history[data.RECIPIENT_ID] = [data.MESSAGE_ID];

			if (BX.MessengerCommon.enableScroll(this.messenger.popupMessengerBody, 200))
			{
				if (this.BXIM.animationSupport)
				{
					if (this.messenger.popupMessengerBodyAnimation != null)
						this.messenger.popupMessengerBodyAnimation.stop();
					(this.messenger.popupMessengerBodyAnimation = new BX.easing({
						duration : 800,
						start : { scroll : this.messenger.popupMessengerBody.scrollTop },
						finish : { scroll : this.messenger.popupMessengerBody.scrollHeight - this.messenger.popupMessengerBody.offsetHeight},
						transition : BX.easing.makeEaseInOut(BX.easing.transitions.quart),
						step : BX.delegate(function(state){
							this.messenger.popupMessengerBody.scrollTop = state.scroll;
						}, this)
					})).animate();
				}
				else
				{
					this.messenger.popupMessengerBody.scrollTop = this.messenger.popupMessengerBody.scrollHeight - this.messenger.popupMessengerBody.offsetHeight;
				}
			}

			this.messenger.popupMessengerFileFormInput.removeAttribute('disabled');
		}, this),
		onfailure: BX.delegate(function(){
			this.messenger.sendMessageFlag--;
			delete this.messenger.message[tmpMessageId];
			BX.MessengerCommon.drawTab(recipientId);
		}, this)
	});
	this.fileTmpId++;
}
BX.IM.DiskManager.prototype.uploadFromClipboard = function(list, text)
{
	var result = list.map(function(item) {
		var dataBlob = BX.UploaderUtils.dataURLToBlob(item.source);
		dataBlob.name = item.name;

		return dataBlob;
	});

	text = text.trim();

	this.formAgents['imDialog'].messageText = text? text: '';
	this.formAgents['imDialog'].onChange(result);

	return true;
}
BX.IM.DiskManager.prototype.chatAvatarInit = function()
{
	if (!BX.Uploader)
		return false;

	if (this.messenger.popupMessengerPanelAvatarUpload2)
	{
		this.formAgents['popupMessengerPanelAvatarUpload2'] = BX.Uploader.getInstance({
			id : 'popupMessengerPanelAvatarUpload2',
			allowUpload : "I",
			uploadMethod : "immediate",
			showImage : false,
			input : this.messenger.popupMessengerPanelAvatarUpload2,
			dropZone : this.messenger.popupMessengerPanelAvatarUpload2.parentNode
		});

		BX.addCustomEvent(this.formAgents['popupMessengerPanelAvatarUpload2'], "onFileinputIsReinited", BX.delegate(function(fileInput){
			if (!fileInput && !this.formAgents['popupMessengerPanelAvatarUpload2'].fileInput)
				return false;

			this.messenger.popupMessengerPanelAvatarUpload2 = fileInput? fileInput: this.formAgents['popupMessengerPanelAvatarUpload2'].fileInput;
		}, this));

		BX.addCustomEvent(this.formAgents['popupMessengerPanelAvatarUpload2'], "onFileIsInited", BX.delegate(function(id, file, agent){
			this.chatAvatarAttached(agent);
			BX.addCustomEvent(file, 'onUploadDone', BX.delegate(this.chatAvatarDone, this));
			BX.addCustomEvent(file, 'onUploadError', BX.delegate(this.chatAvatarError, this));
		}, this));
	}

	if (this.messenger.popupMessengerPanelAvatarUpload3)
	{
		this.formAgents['popupMessengerPanelAvatarUpload3'] = BX.Uploader.getInstance({
			id : 'popupMessengerPanelAvatarUpload3',
			allowUpload : "I",
			uploadMethod : "immediate",
			showImage : false,
			input : this.messenger.popupMessengerPanelAvatarUpload3,
			dropZone : this.messenger.popupMessengerPanelAvatarUpload3.parentNode
		});

		BX.addCustomEvent(this.formAgents['popupMessengerPanelAvatarUpload3'], "onFileinputIsReinited", BX.delegate(function (fileInput)
		{
			if (!fileInput && !this.formAgents['popupMessengerPanelAvatarUpload3'].fileInput)
				return false;

			this.messenger.popupMessengerPanelAvatarUpload3 = fileInput? fileInput: this.formAgents['popupMessengerPanelAvatarUpload3'].fileInput;
		}, this));

		BX.addCustomEvent(this.formAgents['popupMessengerPanelAvatarUpload3'], "onFileIsInited", BX.delegate(function (id, file, agent)
		{
			this.chatAvatarAttached(agent);
			BX.addCustomEvent(file, 'onUploadDone', BX.delegate(this.chatAvatarDone, this));
			BX.addCustomEvent(file, 'onUploadError', BX.delegate(this.chatAvatarError, this));
		}, this));
	}
};
BX.IM.DiskManager.prototype.avatarFormIsBlocked = function(chatId, formId, form)
{

	var result = this.formBlocked[formId+'_'+chatId] || BX.MessengerCommon.checkRestriction(chatId, 'AVATAR')? true: false;

	if (this.messenger.currentTab != 'chat'+chatId)
		return result;

	var element = this.formAgents[formId] && this.formAgents[formId].fileInput? this.formAgents[formId].fileInput: null;
	if (element)
	{
		if (result)
		{
			element.title = '';
			element.disabled = true;
			element.style.cursor = "default";
		}
		else
		{
			element.title = BX.message('IM_M_AVATAR_UPLOAD');
			element.removeAttribute('disabled');
			element.style.cursor = '';
		}
	}
	if (form)
	{
		if (result)
		{
			BX.addClass(form.firstChild, 'bx-messenger-panel-avatar-progress-on');
		}
		else
		{
			BX.removeClass(form.firstChild, 'bx-messenger-panel-avatar-progress-on');
		}

		BX.removeClass(form, 'bx-messenger-panel-avatar-upload-error');
	}

	return result;
}
BX.IM.DiskManager.prototype.chatAvatarAttached = function(agent)
{
	if (!agent.form.CHAT_ID) return false;

	this.formBlocked[agent.id+'_'+agent.form.CHAT_ID.value] = true;
	this.avatarFormIsBlocked(agent.form.CHAT_ID.value, agent.id, agent.form);
}
BX.IM.DiskManager.prototype.chatAvatarDone = function(status, file, agent, pIndex)
{
	this.formBlocked[agent.id+'_'+file.file.chatId] = false;
	this.avatarFormIsBlocked(file.file.chatId, agent.id, agent.form);
	this.messenger.updateChatAvatar(file.file.chatId, file.file.chatAvatar);
}
BX.IM.DiskManager.prototype.chatAvatarError = function(status, file, agent, pIndex)
{
	var formFields = agent.streams.packages.getItem(pIndex).data

	this.formBlocked[agent.id+'_'+formFields.CHAT_ID] = false;
	this.avatarFormIsBlocked(formFields.CHAT_ID, agent.id, agent.form);
	BX.addClass(agent.form, 'bx-messenger-panel-avatar-upload-error');
	agent.fileInput.title = file.error;
}

/* NotifyManager */
BX.IM.NotifyManager = function(BXIM)
{
	this.stack = [];
	this.stackTimeout = null;
	this.stackPopup = {};
	this.stackPopupTimeout = {};
	this.stackPopupTimeout2 = {};
	this.stackPopupId = 0;
	this.stackOverflow = false;

	this.blockNativeNotify = false;
	this.blockNativeNotifyTimeout = null;

	this.notifyShow = 0;
	this.notifyHideTime = 5000;
	this.notifyHeightCurrent = 10;
	this.notifyHeightMax = 0;
	this.notifyGarbageTimeout = null;
	this.notifyAutoHide = true;
	this.notifyAutoHideTimeout = null;

	/*
	BX.bind(window, 'scroll', BX.delegate(function(events){
		if (this.notifyShow > 0)
			for (var i in this.stackPopup)
				this.stackPopup[i].close();
	}, this));
	*/

	if (BX.browser.SupportLocalStorage())
	{
		BX.addCustomEvent(window, "onLocalStorageSet", BX.proxy(this.storageSet, this));
	}

	this.BXIM = BXIM;
};

BX.IM.NotifyManager.prototype.storageSet = function(params)
{
	if (params.key == 'mnnb')
	{
		this.blockNativeNotify = true;
		clearTimeout(this.blockNativeNotifyTimeout);
		this.blockNativeNotifyTimeout = setTimeout(BX.delegate(function(){
			this.blockNativeNotify = false;
		}, this), 1000)
	}
}

BX.IM.NotifyManager.prototype.add = function(params)
{
	if (typeof(params) != "object" || !params.html)
		return false;

	if (BX.type.isDomNode(params.html))
		params.html = params.html.outerHTML;

	this.stack.push(params);

	if (!this.stackOverflow)
		this.setShowTimer(300);
};

BX.IM.NotifyManager.prototype.remove = function(stackId)
{
	delete this.stack[stackId];
};

BX.IM.NotifyManager.prototype.draw = function()
{
	this.show();
}

BX.IM.NotifyManager.prototype.show = function()
{
	this.notifyHeightMax = document.body.offsetHeight;

	var windowPos = BX.GetWindowScrollPos();
	for (var i = 0; i < this.stack.length; i++)
	{
		if (typeof(this.stack[i]) == 'undefined')
			continue;

		/* show notify to calc width & height */
		var notifyPopup = new BX.PopupWindow('bx-im-notify-flash-'+this.stackPopupId, {top: '-1000px', left: 0}, {
			//parentPopup: this.popupMessenger,
			lightShadow : true,
			zIndex: 3400,
			events : {
				onPopupClose : BX.delegate(function() {
					BX.proxy_context.popupContainer.style.opacity = 0;
					this.notifyShow--;
					this.notifyHeightCurrent -= BX.proxy_context.popupContainer.offsetHeight+10;
					this.stackOverflow = false;
					setTimeout(BX.delegate(function() {
						this.destroy();
					}, BX.proxy_context), 1500);
				}, this),
				onPopupDestroy : BX.delegate(function() {
					BX.unbindAll(BX.findChildByClassName(BX.proxy_context.popupContainer, "bx-notifier-item-delete"));
					BX.unbindAll(BX.proxy_context.popupContainer);
					delete this.stackPopup[BX.proxy_context.uniquePopupId];
					delete this.stackPopupTimeout[BX.proxy_context.uniquePopupId];
					delete this.stackPopupTimeout2[BX.proxy_context.uniquePopupId];
				}, this)
			},
			bindOnResize: false,
			content : BX.create("div", {props : { className: "bx-notifyManager-item"}, html: this.stack[i].html})
		});
		notifyPopup.notifyParams = this.stack[i];
		notifyPopup.notifyParams.id = i;
		notifyPopup.show();
		BX.onCustomEvent(window, 'onNotifyManagerShow', [this.stack[i]]);

		/* move notify out monitor */
		notifyPopup.popupContainer.style.left = document.body.offsetWidth-notifyPopup.popupContainer.offsetWidth-10+'px';
		notifyPopup.popupContainer.style.opacity = 0;

		if (this.notifyHeightMax < this.notifyHeightCurrent+notifyPopup.popupContainer.offsetHeight+10)
		{
			if (this.notifyShow > 0)
			{
				notifyPopup.destroy();
				this.stackOverflow = true;
				break;
			}
		}

		/* move notify to top-right */
		BX.addClass(notifyPopup.popupContainer, 'bx-notifyManager-animation');
		notifyPopup.popupContainer.style.opacity = 1;
		notifyPopup.popupContainer.style.top = windowPos.scrollTop+this.notifyHeightCurrent+'px';

		this.notifyHeightCurrent = this.notifyHeightCurrent+notifyPopup.popupContainer.offsetHeight+10;
		this.stackPopupId++;
		this.notifyShow++;
		this.remove(i);

		/* notify events */
		this.stackPopupTimeout[notifyPopup.uniquePopupId] = null;

		BX.bind(notifyPopup.popupContainer, "mouseover", BX.delegate(function() {
			this.clearAutoHide();
		}, this));

		BX.bind(notifyPopup.popupContainer, "mouseout", BX.delegate(function() {
			this.setAutoHide(this.notifyHideTime/2);
		}, this));

		BX.bind(notifyPopup.popupContainer, "contextmenu", BX.delegate(function(e){
			if (this.stackPopup[BX.proxy_context.id].notifyParams.tag)
				this.closeByTag(this.stackPopup[BX.proxy_context.id].notifyParams.tag);
			else
				this.stackPopup[BX.proxy_context.id].close();

			return BX.PreventDefault(e);
		}, this));

		var arLinks = BX.findChildren(notifyPopup.popupContainer, {tagName : "a"}, true);
		for (var j = 0; j < arLinks.length; j++)
		{
			if (arLinks[j].href != '#')
				arLinks[j].target = "_blank";
		}

		BX.bind(BX.findChildByClassName(notifyPopup.popupContainer, "bx-notifier-item-delete"), 'click', BX.delegate(function(e){
			var id = BX.proxy_context.parentNode.parentNode.parentNode.parentNode.id.replace('popup-window-content-', '');

			if (this.stackPopup[id].notifyParams.close)
				this.stackPopup[id].notifyParams.close(this.stackPopup[id]);

			this.stackPopup[id].close();

			if (this.notifyAutoHide == false)
			{
				this.clearAutoHide();
				this.setAutoHide(this.notifyHideTime/2);
			}
			return BX.PreventDefault(e);
		}, this));

		BX.bindDelegate(notifyPopup.popupContainer, "click", {className: "bx-notifier-item-button-confirm"}, BX.delegate(function(e){
			var id = BX.proxy_context.getAttribute('data-id');
			this.BXIM.notify.confirmRequest({
				'notifyId': id,
				'notifyValue': BX.proxy_context.getAttribute('data-value'),
				'notifyURL': BX.proxy_context.getAttribute('data-url'),
				'notifyTag': this.BXIM.notify.notify[id] && this.BXIM.notify.notify[id].tag? this.BXIM.notify.notify[id].tag: null,
				'groupDelete': BX.proxy_context.getAttribute('data-group') != null
			}, true);
			for (var i in this.stackPopup)
			{
				if (this.stackPopup[i].notifyParams.notifyId == id)
					this.stackPopup[i].close();
			}
			if (this.notifyAutoHide == false)
			{
				this.clearAutoHide();
				this.setAutoHide(this.notifyHideTime/2);
			}
			return BX.PreventDefault(e);
		}, this));

		if (notifyPopup.notifyParams.click)
		{
			notifyPopup.popupContainer.style.cursor = 'pointer';
			BX.bind(notifyPopup.popupContainer, 'click', BX.delegate(function(e){
				this.notifyParams.click(this);
				if (this.notifyParams.notifyId != 'network')
					return BX.PreventDefault(e);
			}, notifyPopup));
		}
		this.stackPopup[notifyPopup.uniquePopupId] = notifyPopup;
	}

	if (this.stack.length > 0)
	{
		this.clearAutoHide(true);
		this.setAutoHide(this.notifyHideTime);
	}
	this.garbage();
};

BX.IM.NotifyManager.prototype.closeByTag = function(tag)
{
	for (var i = 0; i < this.stack.length; i++)
	{
		if (typeof(this.stack[i]) != 'undefined' && this.stack[i].tag == tag)
		{
			delete this.stack[i];
		}
	}
	for (var i in this.stackPopup)
	{
		if (this.stackPopup[i].notifyParams.tag == tag)
			this.stackPopup[i].close()
	}
};

BX.IM.NotifyManager.prototype.setShowTimer = function(time)
{
	clearTimeout(this.stackTimeout);
	this.stackTimeout = setTimeout(BX.delegate(this.draw, this), time);
};

BX.IM.NotifyManager.prototype.setAutoHide = function(time)
{
	this.notifyAutoHide = true;
	clearTimeout(this.notifyAutoHideTimeout);
	this.notifyAutoHideTimeout = setTimeout(BX.delegate(function(){
		for (var i in this.stackPopupTimeout)
		{
			this.stackPopupTimeout[i] = setTimeout(BX.delegate(function(){
				this.close();
			}, this.stackPopup[i]), time-1000);
			this.stackPopupTimeout2[i] = setTimeout(BX.delegate(function(){
				this.setShowTimer(300);
			}, this), time-700);
		}
	}, this), 1000);
};

BX.IM.NotifyManager.prototype.clearAutoHide = function(force)
{
	clearTimeout(this.notifyGarbageTimeout);
	this.notifyAutoHide = false;
	force = force==true;
	if (force)
	{
		clearTimeout(this.stackTimeout);
		for (var i in this.stackPopupTimeout)
		{
			clearTimeout(this.stackPopupTimeout[i]);
			clearTimeout(this.stackPopupTimeout2[i]);
		}
	}
	else
	{
		clearTimeout(this.notifyAutoHideTimeout);
		this.notifyAutoHideTimeout = setTimeout(BX.delegate(function(){
			clearTimeout(this.stackTimeout);
			for (var i in this.stackPopupTimeout)
			{
				clearTimeout(this.stackPopupTimeout[i]);
				clearTimeout(this.stackPopupTimeout2[i]);
			}
		}, this), 300);
	}
};

BX.IM.NotifyManager.prototype.garbage = function()
{
	clearTimeout(this.notifyGarbageTimeout);
	this.notifyGarbageTimeout = setTimeout(BX.delegate(function(){
		var newStack = [];
		for (var i = 0; i < this.stack.length; i++)
		{
			if (typeof(this.stack[i]) != 'undefined')
				newStack.push(this.stack[i]);
		}
		this.stack = newStack;
	}, this), 10000);
};

BX.IM.NotifyManager.prototype.nativeNotify = function(params, force)
{
	if (!params.title || params.title.length <= 0)
		return false;

	if (this.blockNativeNotify)
		return false;

	if (!force)
	{
		setTimeout(BX.delegate(function(){
			if (this.blockNativeNotify)
				return false;

			this.nativeNotify(params, true);
		}, this), Math.floor(Math.random() * (151)) + 50);

		return true;
	}

	BX.localStorage.set('mnnb', true, 1);

	var notify = new Notification(params.title, {
		tag : (params.tag? params.tag: ''),
		body : (params.text? params.text: ''),
		icon : (params.icon? params.icon: '')
	});
	if (typeof(params.onshow) == 'function')
		notify.onshow = params.onshow;
	if (typeof(params.onclick) == 'function')
		notify.onclick = params.onclick;
	if (typeof(params.onclose) == 'function')
		notify.onclose = params.onclose;
	if (typeof(params.onerror) == 'function')
		notify.onerror = params.onerror;

	return true;
};

BX.IM.NotifyManager.prototype.nativeNotifyShow = function()
{
	this.show();
};

BX.IM.NotifyManager.prototype.nativeNotifyGranted = function()
{
	return (window.Notification && window.Notification.permission && window.Notification.permission.toLowerCase() == "granted");
};

BX.IM.NotifyManager.prototype.nativeNotifyAccessForm = function()
{
	clearTimeout(this.BXIM.messenger.popupMessengerTopLineTimeout);
	if (!this.BXIM.messenger.popupMessengerTopLine)
		return false;

	var nativeNotify = BX.localStorage.get('imNativeNotify');
	if (
		!this.BXIM.xmppStatus && !this.BXIM.desktopStatus && nativeNotify !== false &&
		window.Notification && window.Notification.permission && window.Notification.permission.toLowerCase() == "default"
	)
	{
		clearTimeout(this.popupMessengerDesktopTimeout);
		var acceptButton = BX.delegate(function(){
			Notification.requestPermission();
			this.BXIM.messenger.hideTopLine();
		}, this);
		var declineButton = BX.delegate(function(){
			BX.localStorage.set('imNativeNotify', false, 3000000);
			this.BXIM.saveSettings({'nativeNotify': this.BXIM.settings.nativeNotify});
			this.BXIM.messenger.hideTopLine();
		}, this);

		this.BXIM.messenger.showTopLine(BX.message("IM_WN_MAC")+"<br />"+BX.message("IM_WN_TEXT"), [
			{title: BX.message('IM_WN_ACCEPT'), callback: acceptButton},
			{title: BX.message('IM_DESKTOP_INSTALL_N'), callback: declineButton}
		], BX.delegate(function(){
			BX.localStorage.set('imNativeNotify', false, 86400);
			this.BXIM.messenger.hideTopLine()
		}, this));
	}
	else
	{
		return false;
	}

	return true;
}

BX.IM.LevelMeter = function(element)
{
	this.element = element;
	this.maximumLevel = 1;

	this.mediaStream = null;
	this.audioContext = null;
	this.mediaStreamNode = null;
	this.scriptNode = null;

	this.instant = 0.0;
	this.slow = 0.0;
	this.clip = 0.0;

	this.supported =  (window.AudioContext || window.webkitAudioContext);
	this.animationInterval = null;

	this.mask = BX.create('div', {attrs: {className: 'bx-messenger-settings-level-meter-mask'}});
	this.filler = BX.create('div', {attrs: {className: 'bx-messenger-settings-level-meter-filler'}});
	this.element.appendChild(this.mask);
	this.mask.appendChild(this.filler);
};

BX.IM.LevelMeter.prototype.render = function()
{
	var fillerWidth = Math.floor(this.slow * 100);
	this.filler.style.width = fillerWidth+'%';
};

BX.IM.LevelMeter.prototype.attachMediaStream = function(mediaStream)
{
	var self = this;

	if(!(mediaStream instanceof MediaStream))
		return;

	this.stop();

	this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
	this.scriptNode = this.audioContext.createScriptProcessor(2048, 1, 1);
	this.scriptNode.connect(this.audioContext.destination); //chrome does not start processing without this for unknown reason

	this.mediaStream = mediaStream;
	this.mediaStreamNode = this.audioContext.createMediaStreamSource(this.mediaStream);
	this.mediaStreamNode.connect(this.scriptNode);

	this.scriptNode.onaudioprocess = function(event) {
		var input = event.inputBuffer.getChannelData(0);
		var i;
		var sum = 0.0;
		var clipcount = 0;
		for (i = 0; i < input.length; ++i) {
			sum += input[i] * input[i];
			if (Math.abs(input[i]) > 0.99) {
				clipcount += 1;
			}
		}

		self.instant = Math.sqrt(sum / input.length);
		self.slow = 0.75 * self.slow + 0.25 * self.instant;
		self.clip = clipcount / input.length;
	};
	this.animationInterval = setInterval(this.render.bind(this), 200);
};

BX.IM.LevelMeter.prototype.getVolume = function()
{
	return {
		instant: this.instant,
		slow: this.slow
	}
};

BX.IM.LevelMeter.prototype.stop = function()
{
	if(this.scriptNode)
		this.scriptNode.disconnect();

	if(this.mediaStreamNode)
		this.mediaStreamNode.disconnect();

	if(this.audioContext)
		this.audioContext.close();

	if(this.animationInterval)
		clearInterval(this.animationInterval);

	this.scriptNode = null;
	this.mediaStreamNode = null;
	this.mediaStream = null;
	this.audioContext = null;
	this.animationInterval = null;
};


})();

/* Desktop utils */

(function(){

if (BX.desktopUtils)
	return;

BX.desktopUtils = function (){
	this.runningCheckTimeout = {};
	this.checkUrl = "http://127.0.0.1:20141/";
	this._openedBxLink = false;
};

BX.desktopUtils.prototype.runningCheck = function(successCallback, failureCallback, successOnlyWithNewApp)
{
	if (typeof(successCallback) == 'undefined')
	{
		return false;
	}
	if (typeof(failureCallback) == 'undefined')
	{
		failureCallback = function(){};
	}

	successOnlyWithNewApp = typeof (successOnlyWithNewApp) == 'undefined' || !successOnlyWithNewApp? false: true;

	var dateCheck = (+new Date());
	if (typeof(BXIM) == 'undefined' || BX.MessengerCommon.isDesktop() || !BXIM.desktopStatus || BXIM.desktopVersion < 18)
	{
		failureCallback(false, dateCheck);
		return false;
	}
	else if (BXIM.desktopVersion < 35)
	{
		if (successOnlyWithNewApp)
		{
			failureCallback(false, dateCheck);
		}
		else
		{
			successCallback(true, dateCheck);
		}
		return true;
	}

	var alreadyRunFailureCallback = false;
	var checkElement = BX.create("img", {
		attrs : {
			"src" : this.checkUrl+"icon.png?"+dateCheck,
			"data-id": dateCheck
		},
		props : {className : "bx-messenger-out-of-view"},
		events : {
			"error" : function () {
				if (alreadyRunFailureCallback)
				{
					return;
				}

				var checkId = this.getAttribute('data-id');
				failureCallback(false, checkId);
				clearTimeout(BX.desktopUtils.runningCheckTimeout[checkId]);
				BX.remove(this);
			},
			"load" : function () {
				var checkId = this.getAttribute('data-id');
				successCallback(true, checkId);
				clearTimeout(BX.desktopUtils.runningCheckTimeout[checkId]);
				BX.remove(this);
			}
		}
	});
	document.body.appendChild(checkElement);
	this.runningCheckTimeout[dateCheck] = setTimeout(function(){
		failureCallback(false, dateCheck);
		clearTimeout(BX.desktopUtils.runningCheckTimeout[dateCheck]);
		BX.remove(this);

		alreadyRunFailureCallback = true;
	}, 500);

	return true;
};

BX.desktopUtils.prototype.goToBx = function (url)
{
	if (typeof(BXIM) != 'undefined' && BXIM.desktopVersion >= 36 && !url.match(/^bx:\/\/v(\d)\//))
	{
		url = url.replace('bx://', 'bx://v'+BXIM.desktopProtocolVersion+'/' + location.hostname + '/');
	}
	this._setOpenedBxLink();
	location.href = url;
};

BX.desktopUtils.prototype._setOpenedBxLink = function()
{
	this._openedBxLink = true;
	setTimeout(function()
	{
		BX.onCustomEvent("BXLinkOpened", []);
		this._openedBxLink = false;
	}.bind(this), 1000);
};

BX.desktopUtils.prototype.isChangedLocationToBx = function ()
{
	return this._openedBxLink;
};

BX.desktopUtils.prototype.encodeParams = function(params)
{
	if(!BX.type.isPlainObject(params))
		return '';

	var stringParams = '';
	var first = true;
	for (var i in params)
	{
		stringParams = stringParams+(first ? '' : '!!')+i+'!!'+params[i];
		first = false;
	}
	return stringParams;
};

BX.desktopUtils.prototype.decodeParams = function(encodedParams)
{
	var result = {};
	if(!BX.type.isNotEmptyString(encodedParams))
		return result;

	var chunks = encodedParams.split('!!');
	for (var i = 0; i < chunks.length; i=i+2)
	{
		result[chunks[i]] = chunks[i+1];
	}
	return result;
};

BX.desktopUtils = new BX.desktopUtils();
})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:54:"/bitrix/js/im/v1/call/simple_vad.min.js?15577564042434";s:6:"source";s:35:"/bitrix/js/im/v1/call/simple_vad.js";s:3:"min";s:39:"/bitrix/js/im/v1/call/simple_vad.min.js";s:3:"map";s:39:"/bitrix/js/im/v1/call/simple_vad.map.js";}"*/
(function(){if(BX.SimpleVAD){return}var t=.1;var i=2e3;BX.SimpleVAD=function(t){this.mediaStream=t.mediaStream;this.audioContext=null;this.mediaStreamNode=null;this.analyserNode=null;this.audioTimeDomainData=null;this.voiceState=false;this.measureInterval=0;this.inactivityTimeout=0;this.callbacks={voiceStarted:BX.type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,voiceStopped:BX.type.isFunction(t.onVoiceStopped)?t.onVoiceStopped:BX.DoNothing};if(BX.SimpleVAD.isSupported()){this.init()}};BX.SimpleVAD.isSupported=function(){return(window.AudioContext||window.webkitAudioContext)&&window.AnalyserNode&&typeof window.AnalyserNode.prototype["getFloatTimeDomainData"]==="function"};BX.SimpleVAD.prototype.init=function(){if(!(this.mediaStream instanceof MediaStream)){return false}this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.analyserNode=this.audioContext.createAnalyser();this.analyserNode.fftSize=128;this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.mediaStream);this.mediaStreamNode.connect(this.analyserNode);this.audioTimeDomainData=new Float32Array(this.analyserNode.fftSize);this.measureInterval=setInterval(this.analyzeAudioStream.bind(this),100)};BX.SimpleVAD.prototype.analyzeAudioStream=function(){this.analyserNode.getFloatTimeDomainData(this.audioTimeDomainData);var i=this.getAverageVolume(this.audioTimeDomainData);this.setVoiceState(i>=t)};BX.SimpleVAD.prototype.setVoiceState=function(t){if(this.voiceState==t){return}if(t){this.callbacks.voiceStarted();clearTimeout(this.inactivityTimeout);this.inactivityTimeout=0;this.voiceState=true}else{if(!this.inactivityTimeout){this.inactivityTimeout=setTimeout(this.onInactivityTimeout.bind(this),i)}}};BX.SimpleVAD.prototype.onInactivityTimeout=function(){this.inactivityTimeout=0;this.voiceState=false;this.callbacks.voiceStopped()};BX.SimpleVAD.prototype.getAverageVolume=function(t){var i=0;for(var e=0;e<t.length;e++){i+=t[e]*t[e]}return Math.sqrt(i/t.length)};BX.SimpleVAD.prototype.destroy=function(){if(this.analyserNode){this.analyserNode.disconnect()}if(this.mediaStreamNode){this.mediaStreamNode.disconnect()}if(this.audioContext){this.audioContext.close()}clearInterval(this.measureInterval);this.analyserNode=null;this.mediaStreamNode=null;this.mediaStream=null;this.audioContext=null;this.callbacks={voiceStarted:BX.DoNothing,voiceStopped:BX.DoNothing}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:55:"/bitrix/js/im/v1/call/controller.min.js?155775640421082";s:6:"source";s:35:"/bitrix/js/im/v1/call/controller.js";s:3:"min";s:39:"/bitrix/js/im/v1/call/controller.min.js";s:3:"map";s:39:"/bitrix/js/im/v1/call/controller.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Controller){return}BX.Call.Controller=function(e){this.messenger=e.messenger;this.container=null;this.folded=false;this.debug=false;this.currentCall=null;this.childCall=null;this.callView=null;this.callNotification=null;this.invitePopup=null;this.isHttps=window.location.protocol==="https:";this.callWithMobile=false;this.autoCloseCallView=true;this.localStreams={main:null,screen:null};this.cameraList={};this.microphoneList={};this.defaultMicrophone=localStorage?localStorage.getItem("bx-im-settings-default-microphone"):"";this.defaultCamera=localStorage?localStorage.getItem("bx-im-settings-default-camera"):"";this.defaultSpeaker=localStorage?localStorage.getItem("bx-im-settings-default-speaker"):"";this.enableMicAutoParameters=localStorage?localStorage.getItem("bx-im-settings-enable-mic-auto-parameters")!=="N":true;this._onCallUserInvitedHandler=this._onCallUserInvited.bind(this);this._onCallDestroyHandler=this._onCallDestroy.bind(this);this._onCallUserStateChangedHandler=this._onCallUserStateChanged.bind(this);this._onCallLocalMediaReceivedHandler=this._onCallLocalMediaReceived.bind(this);this._onCallLocalMediaStoppedHandler=this._onCallLocalMediaStopped.bind(this);this._onCallUserStreamReceivedHandler=this._onCallUserStreamReceived.bind(this);this._onCallUserStreamRemovedHandler=this._onCallUserStreamRemoved.bind(this);this._onCallUserVoiceStartedHandler=this._onCallUserVoiceStarted.bind(this);this._onCallUserVoiceStoppedHandler=this._onCallUserVoiceStopped.bind(this);this._onCallDeviceListUpdatedHandler=this._onCallDeviceListUpdated.bind(this);this._onCallFailureHandler=this._onCallFailure.bind(this);this._onBeforeUnloadHandler=this._onBeforeUnload.bind(this);this._onImTabChangeHandler=this._onImTabChange.bind(this);this._onChildCallFirstStreamHandler=this._onChildCallFirstStream.bind(this);this._onWindowFocusHandler=this._onWindowFocus.bind(this);this._onWindowBlurHandler=this._onWindowBlur.bind(this);if(BX.desktop){this.floatingWindow=new BX.Call.FloatingVideo({onMainAreaClick:this._onFloatingVideoMainAreaClick.bind(this),onButtonClick:this._onFloatingVideoButtonClick.bind(this)});this.floatingWindowUser=0}this.showFloatingWindowTimeout=0;this.hideIncomingCallTimeout=0;this.init()};BX.Call.Controller.prototype={init:function(){var e=this;BX.addCustomEvent(window,"CallEvents::incomingCall",function(t){var i=t.call;this.callWithMobile=t.isMobile===true;if(!this.currentCall){this.currentCall=i;this.bindCallEvents();this.checkDeskop().then(function(){return e.enumerateDevices()}).then(function(){e.showIncomingCall({video:t.video==true})})}else{if(i.id==this.currentCall.id){}else if(i.parentId==this.currentCall.id){if(!this.childCall){this.childCall=i;this.childCall.users.forEach(function(e){this.callView.addUser(e,BX.Call.UserState.Calling)},this);this.answerChildCall()}}else{i.decline(486);return false}}}.bind(this));if(BX.desktop){window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);BX.desktop.addCustomEvent("BXForegroundChanged",function(e){if(e){this._onWindowFocus()}else{this._onWindowBlur()}}.bind(this))}window.addEventListener("beforeunload",this._onBeforeUnloadHandler);BX.addCustomEvent("OnDesktopTabChange",this._onImTabChangeHandler);BX.garbage(this.destroy,this)},bindCallEvents:function(){this.currentCall.addEventListener(BX.Call.Event.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.addEventListener(BX.Call.Event.onDestroy,this._onCallDestroyHandler);this.currentCall.addEventListener(BX.Call.Event.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.addEventListener(BX.Call.Event.onStreamReceived,this._onCallUserStreamReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onStreamRemoved,this._onCallUserStreamRemovedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(BX.Call.Event.onDeviceListUpdated,this._onCallDeviceListUpdatedHandler);this.currentCall.addEventListener(BX.Call.Event.onCallFailure,this._onCallFailureHandler)},removeCallEvents:function(){this.currentCall.removeEventListener(BX.Call.Event.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.removeEventListener(BX.Call.Event.onDestroy,this._onCallDestroyHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.removeEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.removeEventListener(BX.Call.Event.onStreamReceived,this._onCallUserStreamReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onStreamRemoved,this._onCallUserStreamRemovedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(BX.Call.Event.onDeviceListUpdated,this._onCallDeviceListUpdatedHandler);this.currentCall.removeEventListener(BX.Call.Event.onCallFailure,this._onCallFailureHandler)},bindCallViewEvents:function(){this.callView.setCallback("onClose",this._onCallViewClose.bind(this));this.callView.setCallback("onDestroy",this._onCallViewDestroy.bind(this));this.callView.setCallback("onButtonClick",this._onCallViewButtonClick.bind(this));this.callView.setCallback("onBodyClick",this._onCallViewBodyClick.bind(this));this.callView.setCallback("onReplaceCamera",this._onCallViewReplaceCamera.bind(this));this.callView.setCallback("onReplaceMicrophone",this._onCallViewReplaceMicrophone.bind(this));this.callView.setCallback("onSetCentralUser",this._onCallViewSetCentralUser.bind(this))},enumerateDevices:function(){var e=this;e.microphoneList={};e.cameraList={};return new Promise(function(t,i){navigator.mediaDevices.enumerateDevices().then(function(i){i.forEach(function(t){if(t.kind=="audioinput"){e.microphoneList[t.deviceId]=t.label}else if(t.kind=="videoinput"){e.cameraList[t.deviceId]=t.label}});t()})})},isMessengerOpen:function(){return!!this.messenger.popupMessenger},isWebRTCSupported:function(){return typeof webkitRTCPeerConnection!="undefined"||typeof mozRTCPeerConnection!="undefined"||typeof RTCPeerConnection!="undefined"},isCallServerAllowed:function(){return BX.message("call_server_enabled")==="Y"},getUserLimit:function(){return this.isCallServerAllowed()?10:4},createContainer:function(){this.container=BX.create("div",{props:{className:"bx-messenger-call-overlay"}});if(BX.MessengerWindow){BX.MessengerWindow.content.insertBefore(this.container,BX.MessengerWindow.content.firstChild)}else{this.messenger.popupMessengerContent.insertBefore(this.container,this.messenger.popupMessengerContent.firstChild)}this.messenger.popupMessengerContent.classList.add("bx-messenger-call")},resize:function(){},answerChildCall:function(){this.removeCallEvents();this.childCall.addEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.childCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.answer({useVideo:this.currentCall.isVideoEnabled()})},_onChildCallFirstStream:function(e){this.callView.setStream(e.userId,e.stream);this.childCall.removeEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.removeCallEvents();var t=this.currentCall;t.destroy();this.currentCall=this.childCall;this.childCall=null;if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}if(t.muted){this.currentCall.setMuted(true)}this.bindCallEvents()},checkDeskop:function(){return new Promise(function(e,t){BX.desktopUtils.runningCheck(t,e)})},showIncomingCall:function(e){if(!BX.type.isPlainObject(e)){e={}}e.video=e.video==true;var t=this.callWithMobile?e.video===true:true;this.callNotification=new BX.Call.Notification({callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,video:e.video,hasCamera:Object.keys(this.cameraList).length>0&&t,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallNotificationButtonClick.bind(this)});this.callNotification.show();clearTimeout(this.hideIncomingCallTimeout);this.hideIncomingCallTimeout=setTimeout(function(){if(this.callNotification){this.callNotification.close()}}.bind(this),30*1e3);window.BXIM.repeatSound("ringtone",5e3)},showNotification:function(e){BX.UI.Notification.Center.notify({content:e,position:"top-right",autoHideDelay:5e3,closeButton:true})},startCall:function(e,t){if(this.callView||this.currentCall){return}var i=BX.Call.Provider.Plain;if(this.isCallServerAllowed()&&e.toString().substr(0,4)==="chat"){i=BX.Call.Provider.Voximplant}if(!this.isMessengerOpen()){this.messenger.openMessenger()}this.createContainer();this.callView=new BX.Call.View({container:this.container,showChatButtons:true,userLimit:this.getUserLimit(),language:window.BXIM.language});this.bindCallViewEvents();BX.Call.Engine.getInstance().createCall({entityType:"chat",entityId:e,provider:i,videoEnabled:!!t,enableMicAutoParameters:this.enableMicAutoParameters,debug:this.debug===true}).then(function(e){this.currentCall=e.call;if(this.defaultMicrophone){this.currentCall.setMicrophoneId(this.defaultMicrophone)}if(this.defaultCamera){this.currentCall.setCameraId(this.defaultCamera)}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}this.autoCloseCallView=true;this.bindCallEvents();this.callView.appendUsers(this.currentCall.getUsers());this.callView.show();this.currentCall.inviteUsers();window.BXIM.repeatSound("dialtone",5e3)}.bind(this)).catch(function(e){console.error(e);this._onCallFailure({error:e.code=="access_denied"?"ACCESS_DENIED":"UNKNOWN_ERROR"})}.bind(this))},hasActiveCall:function(){return this.currentCall!=null||this.callView!=null},fold:function(){if(this.folded||BX.desktop){return}this.folded=true;this.container.classList.add("bx-messenger-call-overlay-folded");this.callView.setTitle(this.currentCall.associatedEntity.name);this.callView.setSize(BX.Call.View.Size.Folded)},unfold:function(){if(!this.folded){return}this.folded=false;this.container.classList.remove("bx-messenger-call-overlay-folded");this.callView.setSize(BX.Call.View.Size.Full)},_onCallNotificationClose:function(e){clearTimeout(this.hideIncomingCallTimeout);window.BXIM.stopRepeatSound("ringtone");this.callNotification.destroy()},_onCallNotificationDestroy:function(e){this.callNotification=null},_onCallNotificationButtonClick:function(e){clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(e.button){case"answer":if(BX.desktop){BX.desktop.windowCommand("show")}if(this.callView){this.callView.destroy()}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}else if(!this.isMessengerOpen()){this.messenger.openMessenger()}this.createContainer();this.callView=new BX.Call.View({container:this.container,users:this.currentCall.users,userStates:this.currentCall.getUsers(),showChatButtons:true,userLimit:this.getUserLimit()});this.autoCloseCallView=true;if(this.callWithMobile){this.callView.disableAddUser()}this.bindCallViewEvents();this.callView.show();if(this.defaultMicrophone){this.currentCall.setMicrophoneId(this.defaultMicrophone)}if(this.defaultCamera){this.currentCall.setCameraId(this.defaultCamera)}this.currentCall.answer({useVideo:e.video,enableMicAutoParameters:this.enableMicAutoParameters});break;case"decline":this.currentCall.decline();break}},_onCallViewClose:function(e){this.callView.destroy();if(this.floatingWindow){this.floatingWindow.close()}},_onCallViewDestroy:function(e){if(this.messenger.popupMessengerContent){BX.remove(this.container)}this.messenger.popupMessengerContent.classList.remove("bx-messenger-call");this.container=null;this.callView=null;this.folded=false;this.autoCloseCallView=true},_onCallViewBodyClick:function(e){if(this.folded){this.unfold()}},_onCallViewButtonClick:function(e){var t=e.buttonName;var i={hangup:this._onCallViewHangupButtonClick.bind(this),close:this._onCallViewCloseButtonClick.bind(this),inviteUser:this._onCallViewInviteUserButtonClick.bind(this),toggleMute:this._onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this._onCallViewToggleScreenSharingButtonClick.bind(this),toggleVideo:this._onCallViewToggleVideoButtonClick.bind(this),showChat:this._onCallViewShowChatButtonClick.bind(this),showHistory:this._onCallViewShowHistoryButtonClick.bind(this),fullscreen:this._onCallViewFullScreenButtonClick.bind(this)};if(BX.type.isFunction(i[t])){i[t].call(this,e)}},_onCallViewHangupButtonClick:function(e){var t=this;if(!this.currentCall){return}this.currentCall.hangup().then(function(){if(t.currentCall){t.currentCall.destroy()}if(t.callView){t.callView.close()}})},_onCallViewCloseButtonClick:function(e){if(this.currentCall){this.currentCall.destroy()}if(this.callView){this.callView.close()}},_onCallViewShowChatButtonClick:function(e){this.messenger.openMessenger(this.currentCall.associatedEntity.id);if(BX.desktop){this.detached=true;this.callView.hide();this.floatingWindow.show();this.container.style.width=0}else{this.fold()}},_getDisconnectedUsers:function(){var e=[];var t=this.currentCall.getUsers();for(var i in t){if(t[i]!==BX.Call.UserState.Connected&&BX.Call.Util.userData[i]){e.push(BX.Call.Util.userData[i])}}return e},_onCallViewInviteUserButtonClick:function(e){if(this.invitePopup){this.invitePopup.close();return}var t=this.currentCall.getUsers();var i=this._getDisconnectedUsers();this.invitePopup=new BX.Call.InvitePopup({bindElement:e.node,zIndex:1200,idleUsers:i,allowNewUsers:Object.keys(t).length<this.getUserLimit()-1,onDestroy:this._onInvitePopupDestroy.bind(this),onSelect:this._onInvitePopupSelect.bind(this)});this.invitePopup.show()},_onCallViewToggleMuteButtonClick:function(e){this.currentCall.setMuted(e.muted);this.callView.setMuted(e.muted);if(this.floatingWindow){this.floatingWindow.setAudioMuted(e.muted)}},_onCallViewToggleScreenSharingButtonClick:function(e){if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing()}else{this.currentCall.startScreenSharing()}},_onCallViewToggleVideoButtonClick:function(e){this.currentCall.setVideoEnabled(e.video)},_onCallViewShowHistoryButtonClick:function(e){this.messenger.openHistory(this.currentCall.associatedEntity.id)},_onCallViewFullScreenButtonClick:function(e){if(this.folded){this.unfold()}this.callView.toggleFullScreen()},_onCallViewReplaceCamera:function(e){if(this.currentCall){this.currentCall.setCameraId(e.deviceId)}},_onCallViewReplaceMicrophone:function(e){if(this.currentCall){this.currentCall.setMicrophoneId(e.deviceId)}},_onCallViewSetCentralUser:function(e){if(e.stream&&this.floatingWindow){this.floatingWindowUser=e.userId;this.floatingWindow.setStream(e.stream)}},_onCallUserInvited:function(e){if(this.callView){this.callView.addUser(e.userId)}},_onCallDestroy:function(e){this.currentCall=null;this.callWithMobile=false;if(this.callNotification){this.callNotification.close()}if(this.invitePopup){this.invitePopup.close()}if(this.callView&&this.autoCloseCallView){this.callView.close()}if(this.floatingWindow){this.floatingWindow.close()}window.BXIM.messenger.dialogStatusRedraw();window.BXIM.stopRepeatSound("dialtone");window.BXIM.stopRepeatSound("ringtone")},_onCallUserStateChanged:function(e){window.BXIM.stopRepeatSound("dialtone");if(this.callView){this.callView.setUserState(e.userId,e.state);if(e.isMobile){this.callView.disableAddUser();this.callView.disableSwitchCamera();this.callView.disableSwitchMicrophone();this.callView.disableScreenSharing();this.callView.updateButtons()}}if(e.state==BX.Call.UserState.Connected){BX.Call.Util.getUser(e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_CONNECTED",{gender:e.gender,name:e.name}))}.bind(this))}else if(e.state==BX.Call.UserState.Idle&&e.previousState==BX.Call.UserState.Connected){BX.Call.Util.getUser(e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_DISCONNECTED",{gender:e.gender,name:e.name}))}.bind(this))}else if(e.state==BX.Call.UserState.Failed){BX.Call.Util.getUser(e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_FAILED",{gender:e.gender,name:e.name}))}.bind(this))}else if(e.state==BX.Call.UserState.Declined){BX.Call.Util.getUser(e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_DECLINED",{gender:e.gender,name:e.name}))}.bind(this))}},_onCallLocalMediaReceived:function(e){this.localStreams[e.tag]=e.stream;if(this.callView){this.callView.setLocalStream(e.stream)}},_onCallLocalMediaStopped:function(e){this.localStreams[e.tag]=null;if(e.tag==="screen"){this.callView.setLocalStream(this.localStreams["main"])}},_onCallUserStreamReceived:function(e){if(this.callView){this.callView.setStream(e.userId,e.stream)}if(this.floatingWindow&&this.floatingWindowUser==e.userId){this.floatingWindow.setStream(e.stream)}},_onCallUserStreamRemoved:function(e){},_onCallUserVoiceStarted:function(e){if(this.callView){this.callView.setUserTalking(e.userId,true)}},_onCallUserVoiceStopped:function(e){if(this.callView){this.callView.setUserTalking(e.userId,false)}},_onCallDeviceListUpdated:function(e){if(this.callView){this.callView.setDeviceList(e.deviceList)}},_onCallFailure:function(e){var t=e.error;console.error("Call failure: ",e);if(t=="AUTHORIZE_ERROR"){this.callView.showFatalError({text:BX.message("IM_CALL_ERROR_AUTHORIZATION")})}else if(t=="ACCESS_DENIED"){this.callView.showFatalError({text:BX.message("IM_CALL_ERROR_ACCESS_DENIED")})}else if(t=="UNKNOWN_ERROR"){this.callView.showFatalError({text:BX.message("IM_CALL_ERROR_UNKNOWN")})}else if(!this.isHttps){this.callView.showFatalError({text:BX.message("IM_CALL_ERROR_HTTPS_REQUIRED")})}else{this.callView.showFatalError({text:BX.message("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")})}this.autoCloseCallView=false;if(this.currentCall){this.currentCall.decline()}},_onInvitePopupDestroy:function(e){this.invitePopup=null},_onInvitePopupSelect:function(e){this.invitePopup.close();if(!this.currentCall){return}var t=e.user.id;if(this.isCallServerAllowed()&&this.currentCall instanceof BX.Call.PlainCall){this.removeCallEvents();BX.Call.Engine.getInstance().createChildCall(this.currentCall.id,BX.Call.Provider.Voximplant,[t]).then(function(e){this.childCall=e.call;this.childCall.addEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.childCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.inviteUsers({users:this.childCall.users})}.bind(this));this.callView.addUser(t,BX.Call.UserState.Calling)}else{var i=this.currentCall.getUsers();if(Object.keys(i).length<this.getUserLimit()-1||i.hasOwnProperty(t)){this.currentCall.inviteUsers({users:[t]})}}},_onWindowFocus:function(){if(!this.detached){clearTimeout(this.showFloatingWindowTimeout);if(this.floatingWindow){this.floatingWindow.hide()}}},_onWindowBlur:function(e){clearTimeout(this.showFloatingWindowTimeout);if(this.currentCall&&this.floatingWindow&&this.callView){this.showFloatingWindowTimeout=setTimeout(function(){if(this.currentCall&&this.floatingWindow&&this.callView){this.floatingWindow.show()}}.bind(this),300)}},_onBeforeUnload:function(e){if(this.hasActiveCall()){e.preventDefault();e.returnValue=""}},_onImTabChange:function(e){if(e==="notify"&&this.currentCall&&this.callView){this.fold()}},_onFloatingVideoMainAreaClick:function(e){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");if(!this.currentCall){return}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}else if(!this.isMessengerOpen()){this.messenger.openMessenger()}if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false}},_onFloatingVideoButtonClick:function(e){switch(e.buttonName){case"toggleMute":this._onCallViewToggleMuteButtonClick(e);break;case"hangup":this._onCallViewHangupButtonClick();break}},destroy:function(){if(this.floatingWindow){this.floatingWindow.destroy();this.floatingWindow=null}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:50:"/bitrix/js/im/v1/call/engine.min.js?15577564046362";s:6:"source";s:31:"/bitrix/js/im/v1/call/engine.js";s:3:"min";s:35:"/bitrix/js/im/v1/call/engine.min.js";s:3:"map";s:35:"/bitrix/js/im/v1/call/engine.map.js";}"*/
(function(){BX.namespace("BX.Call");BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Calling:"Calling",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant",Janus:"Janus"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Event={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onDestroy:"onDestroy"};var e={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var l=false;BX.Call.Engine=function(){if(!l){throw new Error("Do not use this constructor directly, use BX.Call.Engine.getInstance instead")}this.calls={};this.userId=BX.message("USER_ID");this.init()};BX.Call.Engine.getInstance=function(){return BX.CallEngine};BX.Call.Engine.prototype.init=function(){BX.addCustomEvent("onPullEvent-im",this.__onPullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-im",this.__onPullClientEvent.bind(this))};BX.Call.Engine.prototype.getCurrentUserId=function(){return this.userId};BX.Call.Engine.prototype.createCall=function(l){var a=this;return new Promise(function(n,t){var i=l.type||BX.Call.Type.Instant;var r=l.provider||a.getDefaultProvider();var s={type:i,provider:r,entityType:l.entityType,entityId:l.entityId,userIds:BX.type.isArray(l.userIds)?l.userIds:[]};var o={callParams:[e.createCall,s],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(o,function(e){if(e.callParams.error()){var i=e.callParams.error().getError();return t({code:i.error,message:i.error_description})}var r=e.callParams.data();var s=r.call;var o=a.__getCallFabric(s["PROVIDER"]);var c=o.createCall({id:s["ID"],instanceId:a.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:r.users,videoEnabled:l.videoEnabled==true,enableMicAutoParameters:l.enableMicAutoParameters!==false,associatedEntity:s.ASSOCIATED_ENTITY,events:{onDestroy:a.__onCallDestroy.bind(a)},debug:l.debug===true});var u=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(u));a.calls[s["ID"]]=c;if(r.userData){BX.MessengerCommon.updateUserData(r.userData)}n({call:c,isNew:r.isNew})})})};BX.Call.Engine.prototype.createChildCall=function(l,a,n){var t=this;return new Promise(function(i,r){if(!t.calls[l]){return r("Parent call is not found")}var s=t.calls[l];var o={parentId:l,newProvider:a,newUsers:n};var c={callParams:[e.createChildCall,o],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(c,function(e){var l=e.callParams.data();var a=l.call;var n=t.__getCallFabric(a["PROVIDER"]);var r=n.createCall({id:a["ID"],instanceId:t.getUuidv4(),parentId:a["PARENT_ID"],direction:BX.Call.Direction.Outgoing,users:l.users,videoEnabled:s.isVideoEnabled(),enableMicAutoParameters:s.enableMicAutoParameters!==false,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:t.__onCallDestroy.bind(t)}});var o=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(o));t.calls[a["ID"]]=r;i({call:r,isNew:l.isNew})})})};BX.Call.Engine.prototype.getCall=function(e,l){var a=this.__getCallFabric(e["PROVIDER"]);var n=a.createCall({id:e["ID"],instanceId:this.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:l,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[e["ID"]]=n;return n};BX.Call.Engine.prototype.getCallWithId=function(l){var a=this;return new Promise(function(n,t){if(a.calls[l]){return n(a.calls[l])}BX.ajax.runAction(e.getCall,{data:{callId:l}}).then(function(e){if(e.state==="success"){var l=e.data.call;n({call:a.getCall(l),isNew:false})}else if(e.state==="error"){t(e.errors[0])}})})};BX.Call.Engine.prototype.getUuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var l=Math.random()*16|0,a=e=="x"?l:l&3|8;return a.toString(16)})};BX.Call.Engine.prototype.__onPullEvent=function(e,l,a){var n={"Call::incoming":this.__onPullIncomingCall.bind(this)};if(n[e]){n[e].call(this,l,a)}else if(e.substr(0,6)==="Call::"&&l["call"]){var t=l["call"];var i=t["ID"];if(this.calls[i]){this.calls[i].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullClientEvent=function(e,l,a){if(e.substr(0,6)==="Call::"&&l["callId"]){var n=l["callId"];if(this.calls[n]){this.calls[n].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullIncomingCall=function(e,l){if(l.server_time_ago>30){console.error("Call was started too long time ago");return}var a=e.call;var n=a.ID;var t;if(e.publicIds){BX.PULL.setPublicIds(Object.values(e.publicIds))}if(e.userData){BX.MessengerCommon.updateUserData(e.userData)}if(this.calls[n]){t=this.calls[n]}else{var i=this.__getCallFabric(a.PROVIDER);t=i.createCall({id:n,instanceId:this.getUuidv4(),parentId:a.PARENT_ID||null,direction:BX.Call.Direction.Incoming,users:e.users,initiatorId:e.senderId,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[n]=t}if(t){BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:t,video:e.video===true,isMobile:e.isMobile===true}])}};BX.Call.Engine.prototype.__onCallDestroy=function(e){if(this.calls[e.call.id]){delete this.calls[e.call.id]}};BX.Call.Engine.prototype.getDefaultProvider=function(){return BX.Call.Provider.Plain};BX.Call.Engine.prototype.__getCallFabric=function(e){if(e==BX.Call.Provider.Plain){return BX.Call.PlainCallFabric}else if(e==BX.Call.Provider.Voximplant){return BX.Call.VoximplantCallFabric}else if(e==BX.Call.Provider.Janus){return BX.Call.JanusCallFabric}throw new Error("Unknown call provider type "+e)};BX.Call.PlainCallFabric={createCall:function(e){return new BX.Call.PlainCall(e)}};BX.Call.VoximplantCallFabric={createCall:function(e){return new BX.Call.VoximplantCall(e)}};BX.Call.JanusCallFabric={createCall:function(e){return new BX.Call.JanusCall(e)}};l=true;BX.CallEngine=new BX.Call.Engine;l=false})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:59:"/bitrix/js/im/v1/call/hardware_dialog.min.js?15577564041614";s:6:"source";s:40:"/bitrix/js/im/v1/call/hardware_dialog.js";s:3:"min";s:44:"/bitrix/js/im/v1/call/hardware_dialog.min.js";s:3:"map";s:44:"/bitrix/js/im/v1/call/hardware_dialog.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.HardwareDialog)return;BX.Call.HardwareDialog=function(e){this.bindNode=e.bindNode;this.offsetTop=e.offsetTop;this.offsetLeft=e.offsetLeft;this.popup=null;this.callbacks={onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing}};BX.Call.HardwareDialog.prototype.createPopup=function(){this.popup=new BX.PopupWindow("bx-messenger-call-access",this.bindNode,{lightShadow:true,zIndex:200,offsetTop:this.offsetTop,offsetLeft:this.offsetLeft,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){this.popup=null;this.callbacks.onDestroy()}.bind(this)},content:this.createLayout()})};BX.Call.HardwareDialog.prototype.createLayout=function(){return BX.create("div",{props:{className:"bx-messenger-call-dialog-allow"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-image-block"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-center"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-arrow"}})]}),BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-center"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-button"},html:BX.message("IM_M_CALL_ALLOW_BTN")})]})]}),BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-text"},html:BX.message("IM_M_CALL_ALLOW_TEXT")})]})};BX.Call.HardwareDialog.prototype.show=function(){if(!this.popup){this.createPopup()}this.popup.show()};BX.Call.HardwareDialog.prototype.close=function(){if(this.popup){this.popup.close()}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:57:"/bitrix/js/im/v1/call/abstract_call.min.js?15577564042925";s:6:"source";s:38:"/bitrix/js/im/v1/call/abstract_call.js";s:3:"min";s:42:"/bitrix/js/im/v1/call/abstract_call.min.js";s:3:"map";s:42:"/bitrix/js/im/v1/call/abstract_call.map.js";}"*/
(function(){BX.namespace("BX.Call");BX.Call.AbstractCall=function(t){var e=this;this.id=t.id;this.instanceId=t.instanceId;this.parentId=t.parentId||null;this.direction=t.direction;this.debug=t.debug||false;this.ready=false;this.userId=BX.Call.Engine.getInstance().getCurrentUserId();this.initiatorId=t.initiatorId||"";this.users=BX.type.isArray(t.users)?t.users.filter(function(t){return t!=e.userId}):[];this.associatedEntity=BX.type.isPlainObject(t.associatedEntity)?t.associatedEntity:{};this.videoEnabled=t.videoEnabled===true;this.cameraId=t.cameraId||"";this.microphoneId=t.microphoneId||"";this.muted=t.muted===true;this.localStreams={main:null,screen:null};this.eventListeners={};if(BX.type.isPlainObject(t.events)){this.initEventListeners(t.events)}};BX.Call.AbstractCall.prototype.initEventListeners=function(t){for(var e in t){this.addEventListener(e,t[e])}};BX.Call.AbstractCall.prototype.addEventListener=function(t,e){if(!BX.type.isArray(this.eventListeners[t])){this.eventListeners[t]=[]}if(BX.type.isFunction(e)){this.eventListeners[t].push(e)}};BX.Call.AbstractCall.prototype.removeEventListener=function(t,e){if(BX.type.isArray(this.eventListeners[t])&&this.eventListeners[t].indexOf(e)>=0){var i=this.eventListeners[t].indexOf(e);if(i>=0){this.eventListeners[t].splice(i,1)}}};BX.Call.AbstractCall.prototype.runCallback=function(t,e){if(BX.type.isArray(this.eventListeners[t])&&this.eventListeners[t].length>0){if(!BX.type.isPlainObject(e)){e={}}e.call=this;for(var i=0;i<this.eventListeners[t].length;i++){this.eventListeners[t][i].call(this,e)}}};BX.Call.AbstractCall.prototype.getLocalStream=function(t){return this.localStreams[t]};BX.Call.AbstractCall.prototype.setLocalStream=function(t,e){e=e||"main";this.localStreams[e]=t};BX.Call.AbstractCall.prototype.isVideoEnabled=function(){return this.videoEnabled};BX.Call.AbstractCall.prototype.__onPullEvent=function(t,e){throw new Error("__onPullEvent should be implemented")};BX.Call.AbstractCall.prototype.inviteUsers=function(){throw new Error("inviteUsers is not implemented")};BX.Call.AbstractCall.prototype.cancel=function(){throw new Error("cancel is not implemented")};BX.Call.AbstractCall.prototype.answer=function(){throw new Error("answer is not implemented")};BX.Call.AbstractCall.prototype.decline=function(t,e){throw new Error("decline is not implemented")};BX.Call.AbstractCall.prototype.hangup=function(){throw new Error("hangup is not implemented")};BX.Call.AbstractCall.prototype.log=function(){var t="";if(BX.desktop&&BX.desktop.ready()){for(var e=0;e<arguments.length;e++){try{t=t+" | "+(typeof arguments[e]=="object"?JSON.stringify(arguments[e]):arguments[e])}catch(e){t=t+" | (circular structure)"}}BX.desktop.log(BX.message("USER_ID")+".video.log",t.substr(3))}if(this.debug){if(console){var i=["Call log; "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:55:"/bitrix/js/im/v1/call/plain_call.min.js?155775640431680";s:6:"source";s:35:"/bitrix/js/im/v1/call/plain_call.js";s:3:"min";s:39:"/bitrix/js/im/v1/call/plain_call.min.js";s:3:"map";s:39:"/bitrix/js/im/v1/call/plain_call.map.js";}"*/
(function(){BX.namespace("BX.Call");var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping",negotiationNeeded:"im.call.negotiationNeeded",connectionOffer:"im.call.connectionOffer",connectionAnswer:"im.call.connectionAnswer",iceCandidate:"im.call.iceCandidate"};var t={ping:"Call::ping",negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped"};var n={offerToReceiveVideo:true,offerToReceiveAudio:true};var i=3e4;var a=25e3;BX.Call.PlainCall=function(e){this.superclass.constructor.apply(this,arguments);this.state=e.state||"";this.peers=this.initPeers(this.users);this.voiceDetection=null;this.signaling=new BX.Call.PlainCall.Signaling({call:this});this.deviceList=[];this.turnServer=(BX.browser.IsFirefox()?BX.message("turn_server_firefox"):BX.message("turn_server"))||"turn.calls.bitrix24.com";this.turnServerLogin=BX.message("turn_server_login")||"bitrix";this.turnServerPassword=BX.message("turn_server_password")||"bitrix";this.ping();this.pingInterval=setInterval(this.ping.bind(this),a);this._onUnloadHandler=this._onUnload.bind(this);this.enableMicAutoParameters=e.enableMicAutoParameters!==false;window.addEventListener("unload",this._onUnloadHandler)};BX.extend(BX.Call.PlainCall,BX.Call.AbstractCall);BX.Call.PlainCall.prototype.initPeers=function(e){var t={};for(var n=0;n<e.length;n++){var i=e[n];if(i==this.userId)continue;t[i]=this.createPeer(i)}return t};BX.Call.PlainCall.prototype.createPeer=function(e){var t=this;return new BX.Call.PlainCall.Peer({call:this,userId:e,ready:e==this.initiatorId,signalingConnected:e==this.initiatorId,onStreamReceived:function(e){t.runCallback(BX.Call.Event.onStreamReceived,e)},onStreamRemoved:function(e){t.runCallback(BX.Call.Event.onStreamRemoved,e)},onStateChanged:this.__onPeerStateChanged.bind(this),onRTCStatsReceived:this.__onPeerRTCStatsReceived.bind(this)})};BX.Call.PlainCall.prototype.getUsers=function(){var e={};for(var t in this.peers){e[t]=this.peers[t].calculatedState}return e};BX.Call.PlainCall.prototype.isReady=function(){return this.ready};BX.Call.PlainCall.prototype.setVideoEnabled=function(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.ready){this.replaceLocalMediaStream()}};BX.Call.PlainCall.prototype.setMuted=function(e){e=!!e;if(this.muted==e){return}this.muted=e;if(this.localStreams["main"]){var t=this.localStreams["main"].getAudioTracks();if(t[0]){t[0].enabled=!this.muted}}};BX.Call.PlainCall.prototype.setCameraId=function(e){if(this.cameraId==e){return}this.cameraId=e;if(this.ready&&this.videoEnabled){this.replaceLocalMediaStream()}};BX.Call.PlainCall.prototype.setMicrophoneId=function(e){if(this.microphoneId==e){return}this.microphoneId=e;if(this.ready){this.replaceLocalMediaStream()}};BX.Call.PlainCall.prototype.stopSendingStream=function(e){};BX.Call.PlainCall.prototype.inviteUsers=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}var n=BX.type.isArray(e.users)?e.users:Object.keys(this.peers);this.ready=true;if(e.localStream instanceof MediaStream&&!this.localStreams["main"]){this.localStreams["main"]=e.localStream}this.getLocalMediaStream().then(function(){return t.signaling.inviteUsers({userIds:n,video:t.videoEnabled?"Y":"N"})}).then(function(e){for(var i=0;i<n.length;i++){if(!t.peers[n[i]]){t.peers[n[i]]=t.createPeer(n[i]);t.runCallback(BX.Call.Event.onUserInvited,{userId:n[i]})}t.peers[n[i]].onInvited()}}).catch(function(e){t.runCallback(BX.Call.Event.onCallFailure,e)})};BX.Call.PlainCall.prototype.getMediaConstraints=function(){var e={};var t=this.videoEnabled?{}:false;var n=navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{};if(this.microphoneId){e.deviceId={ideal:this.microphoneId}}if(!this.enableMicAutoParameters){if(n.echoCancellation){e.echoCancellation=false}if(n.noiseSuppression){e.noiseSuppression=false}if(n.autoGainControl){e.autoGainControl=false}}if(t){t.aspectRatio=1.7777777778;if(this.cameraId){t.deviceId={ideal:this.cameraId}}}return{audio:e,video:t}};BX.Call.PlainCall.prototype.getLocalMediaStream=function(e){var t=this;if(!BX.type.isNotEmptyString(e)){e="main"}this.log("Requesting access to media devices");return new Promise(function(n,i){if(t.localStreams[e]){return n(t.localStreams[e])}var a=t.getMediaConstraints();navigator.mediaDevices.getUserMedia(a).then(function(i){t.log("Local media stream received");t.localStreams[e]=i;t.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:e,stream:i});if(e==="main"){t.attachVoiceDetection();if(t.muted){var a=i.getAudioTracks();if(a[0]){a[0].enabled=false}}}if(t.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then(function(e){t.deviceList=e;t.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:t.deviceList})})}n(t.localStreams[e])}).catch(function(n){t.log("Could not get local media stream.",n);t.log("Request constraints: .",a);t.runCallback("onLocalMediaError",{tag:e,error:n});i(n)})})};BX.Call.PlainCall.prototype.startMediaCapture=function(){return this.getLocalMediaStream()};BX.Call.PlainCall.prototype.attachVoiceDetection=function(){if(this.voiceDetection){this.voiceDetection.destroy()}try{this.voiceDetection=new BX.SimpleVAD({mediaStream:this.localStreams["main"],onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)})}catch(e){this.log("Could not attach voice detection to media stream")}};BX.Call.PlainCall.prototype.startScreenSharing=function(){var e=this;if(this.localStreams["screen"]){return}navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"screen",maxWidth:1920,maxHeight:1080,maxFrameRate:5}}}).then(function(t){e.localStreams["screen"]=t;e.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"screen",stream:t});if(e.ready){for(var n in e.peers){if(e.peers[n].calculatedState===BX.Call.UserState.Connected){e.peers[n].sendMedia()}}}}).catch(function(e){this.log(e)})};BX.Call.PlainCall.prototype.stopScreenSharing=function(){if(!this.localStreams["screen"]){return}this.localStreams["screen"].getTracks().forEach(function(e){e.stop()});this.localStreams["screen"]=null;this.runCallback(BX.Call.Event.onLocalMediaStopped,{tag:"screen"});for(var e in this.peers){if(this.peers[e].calculatedState===BX.Call.UserState.Connected){this.peers[e].sendMedia()}}};BX.Call.PlainCall.prototype.isScreenSharingStarted=function(){return this.localStreams["screen"]instanceof MediaStream};BX.Call.PlainCall.prototype.onLocalVoiceStarted=function(){this.signaling.sendVoiceStarted({userId:this.users})};BX.Call.PlainCall.prototype.onLocalVoiceStopped=function(){this.signaling.sendVoiceStopped({userId:this.users})};BX.Call.PlainCall.prototype.answer=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}if(this.direction!==BX.Call.Direction.Incoming){throw new Error("Only incoming call could be answered")}this.ready=true;this.videoEnabled=e.useVideo==true;this.enableMicAutoParameters=e.enableMicAutoParameters!==false;if(e.localStream instanceof MediaStream){this.localStreams["main"]=e.localStream}return new Promise(function(e,n){t.getLocalMediaStream().then(function(){return t.signaling.sendAnswer()},function(e){t.runCallback(BX.Call.Event.onCallFailure,e)}).then(function(){e()})})};BX.Call.PlainCall.prototype.decline=function(t,n){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(typeof t!="undefined"){i.code=t}if(typeof n!="undefined"){i.reason=n}BX.ajax.runAction(e.decline,{data:i}).then(function(){this.destroy()}.bind(this))};BX.Call.PlainCall.prototype.hangup=function(){this.ready=false;var t=this;return new Promise(function(n,i){BX.ajax.runAction(e.hangup,{data:{callId:t.id,callInstanceId:t.instanceId}}).then(function(){for(var e in t.peers){t.peers[e].disconnect()}n()})})};BX.Call.PlainCall.prototype.ping=function(){this.signaling.sendPing({userId:this.users})};BX.Call.PlainCall.prototype.getState=function(){};BX.Call.PlainCall.prototype.replaceLocalMediaStream=function(e){var t=this;e=e||"main";if(this.localStreams[e]){BX.webrtc.stopMediaStream(this.localStreams[e]);this.localStreams[e]=null}this.getLocalMediaStream(e).then(function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(e)}}}}).catch(function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e)}.bind(this))};BX.Call.PlainCall.prototype.sendAllStreams=function(e){if(!this.peers[e])return;if(!this.peers[e].isReady())return;for(var t in this.localStreams){if(this.localStreams[t]){this.peers[e].sendMedia()}}};BX.Call.PlainCall.prototype.isAnyoneParticipating=function(){for(var e in this.peers){if(this.peers[e].isParticipating()){return true}}return false};BX.Call.PlainCall.prototype.__onPullEvent=function(e,t,n){var i={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::ping":this.__onPullEventPing.bind(this),"Call::negotiationNeeded":this.__onPullEventNegotiationNeeded.bind(this),"Call::connectionOffer":this.__onPullEventConnectionOffer.bind(this),"Call::connectionAnswer":this.__onPullEventConnectionAnswer.bind(this),"Call::iceCandidate":this.__onPullEventIceCandidate.bind(this),"Call::voiceStarted":this.__onPullEventVoiceStarted.bind(this),"Call::voiceStopped":this.__onPullEventVoiceStopped.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::associatedEntityReplaced":this.__onPullEventAssociatedEntityReplaced.bind(this),"Call::finish":this.__onPullEventFinish.bind(this)};if(i[e]){this.log("Signaling: "+e+"; Parameters: "+JSON.stringify(t));i[e].call(this,t)}};BX.Call.PlainCall.prototype.__onPullEventUsersInvited=function(e){var t=e.users;for(var n=0;n<t.length;n++){var i=t[n];if(this.peers[i]){if(this.peers[i].calculatedState===BX.Call.UserState.Failed||this.peers[i].calculatedState===BX.Call.UserState.Idle){this.peers[i].onInvited()}}else{this.peers[i]=this.createPeer(i);this.runCallback(BX.Call.Event.onUserInvited,{userId:i});this.peers[i].onInvited()}}};BX.Call.PlainCall.prototype.__onPullEventAnswer=function(e){var t=e.senderId;if(t===this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.peers[t]){return}this.peers[t].setSignalingConnected(true);this.peers[t].setReady(true);if(this.ready){this.sendAllStreams(t)}};BX.Call.PlainCall.prototype.__onPullEventAnswerSelf=function(e){if(e.callInstanceId===this.instanceId)return;this.destroy()};BX.Call.PlainCall.prototype.__onPullEventHangup=function(e){var t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.destroy()}}if(!this.peers[t])return;this.peers[t].disconnect(e.code);this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()){this.destroy()}};BX.Call.PlainCall.prototype.__onPullEventPing=function(e){var t=this.peers[e.senderId];if(!t)return;t.setSignalingConnected(true)};BX.Call.PlainCall.prototype.__onPullEventNegotiationNeeded=function(e){var t=this.peers[e.senderId];if(!t){return}t.setReady(true);if(e.restart){t.reconnect()}else{t.onNegotiationNeeded()}};BX.Call.PlainCall.prototype.__onPullEventConnectionOffer=function(e){var t=this.peers[e.senderId];if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp)};BX.Call.PlainCall.prototype.__onPullEventConnectionAnswer=function(e){var t=this.peers[e.senderId];if(!t)return;t.setUserAgent(e.userAgent);t.setConnectionAnswer(e.sdp)};BX.Call.PlainCall.prototype.__onPullEventIceCandidate=function(e){var t=this.peers[e.senderId];var n;if(!t)return;try{n=e.candidates;for(var i=0;i<n.length;i++){t.addIceCandidate(n[i])}}catch(e){this.log("Error parsing serialized candidate: ",e)}};BX.Call.PlainCall.prototype.__onPullEventVoiceStarted=function(e){this.runCallback(BX.Call.Event.onUserVoiceStarted,{userId:e.senderId})};BX.Call.PlainCall.prototype.__onPullEventVoiceStopped=function(e){this.runCallback(BX.Call.Event.onUserVoiceStopped,{userId:e.senderId})};BX.Call.PlainCall.prototype.__onPullEventAssociatedEntityReplaced=function(e){if(e.call&&e.call.ASSOCIATED_ENTITY){this.associatedEntity=e.call.ASSOCIATED_ENTITY}};BX.Call.PlainCall.prototype.__onPullEventFinish=function(e){this.destroy()};BX.Call.PlainCall.prototype.__onPeerStateChanged=function(e){this.runCallback(BX.Call.Event.onUserStateChanged,e);if(e.state==BX.Call.UserState.Failed){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this))}}};BX.Call.PlainCall.prototype.__onPeerRTCStatsReceived=function(e){this.runCallback(BX.Call.Event.onRTCStatsReceived,e)};BX.Call.PlainCall.prototype._onUnload=function(t){BX.ajax.runAction(e.hangup,{data:{callId:this.id,callInstanceId:this.instanceId}});for(var n in this.peers){this.peers[n].disconnect()}};BX.Call.PlainCall.prototype.destroy=function(){for(var e in this.peers){if(this.peers[e]){this.peers[e].destroy()}}for(var t in this.localStreams){if(this.localStreams[t]){BX.webrtc.stopMediaStream(this.localStreams[t]);this.localStreams[t]=null}}window.removeEventListener("unload",this._onUnloadHandler);clearInterval(this.pingInterval);this.runCallback(BX.Call.Event.onDestroy)};BX.Call.PlainCall.Signaling=function(e){this.call=e.call};BX.Call.PlainCall.Signaling.prototype.isIceTricklingAllowed=function(){return BX.PULL.isPublishingSupported()};BX.Call.PlainCall.Signaling.prototype.inviteUsers=function(t){return this.__runAjaxAction(e.invite,t)};BX.Call.PlainCall.Signaling.prototype.sendAnswer=function(t){return this.__runAjaxAction(e.answer,t)};BX.Call.PlainCall.Signaling.prototype.sendConnectionOffer=function(n){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.connectionOffer,n)}else{return this.__runAjaxAction(e.connectionOffer,n)}};BX.Call.PlainCall.Signaling.prototype.sendConnectionAnswer=function(n){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.connectionAnswer,n)}else{return this.__runAjaxAction(e.connectionAnswer,n)}};BX.Call.PlainCall.Signaling.prototype.sendIceCandidate=function(n){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.iceCandidate,n)}else{return this.__runAjaxAction(e.iceCandidate,n)}};BX.Call.PlainCall.Signaling.prototype.sendNegotiationNeeded=function(n){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.negotiationNeeded,n)}else{return this.__runAjaxAction(e.negotiationNeeded,n)}};BX.Call.PlainCall.Signaling.prototype.sendVoiceStarted=function(e){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.voiceStarted,e)}};BX.Call.PlainCall.Signaling.prototype.sendVoiceStopped=function(e){if(BX.PULL.isPublishingSupported()){return this.__sendPullEvent(t.voiceStopped,e)}};BX.Call.PlainCall.Signaling.prototype.sendPing=function(n){if(BX.PULL.isPublishingSupported()){this.__sendPullEvent(t.ping,n);this.__runAjaxAction(e.ping,{retransmit:false})}else{this.__runAjaxAction(e.ping,{retransmit:true})}};BX.Call.PlainCall.Signaling.prototype.__sendPullEvent=function(e,t){if(!t.userId){throw new Error("userId is not found in data")}if(!BX.type.isArray(t.userId)){t.userId=[t.userId]}t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));BX.PULL.sendMessage(t.userId,"im",e,t,10)};BX.Call.PlainCall.Signaling.prototype.__runAjaxAction=function(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.log("Sending ajax-based signaling event "+e+"; "+JSON.stringify(t));return BX.ajax.runAction(e,{data:t}).catch(function(e){console.error(e)})};BX.Call.PlainCall.Peer=function(e){this.call=e.call;this.userId=e.userId;this.ready=e.ready===true;this.calling=false;this.inviteTimeout=false;this.declined=false;this.signalingConnected=e.signalingConnected===true;this.failureReason="";this.userAgent="";this.isFirefox=false;this.isChrome=false;this.isMobile=false;this.calculatedState=this.calculateState();this.localStreams={main:null,screen:null};this.senderMediaStream=null;this.peerConnection=null;this.pendingIceCandidates=[];this.localIceCandidates=[];this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing,onRTCStatsReceived:BX.type.isFunction(e.onRTCStatsReceived)?e.onRTCStatsReceived:BX.DoNothing};this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.statsInterval=null;this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionIceConnectionStateChangeHandler=this._onPeerConnectionIceConnectionStateChange.bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=this._onPeerConnectionIceGatheringStateChange.bind(this);this._onPeerConnectionNegotiationNeededHandler=BX.debounce(this._onPeerConnectionNegotiationNeeded,100,this);this._onPeerConnectionTrackHandler=this._onPeerConnectionTrack.bind(this);this._onPeerConnectionRemoveStreamHandler=this._onPeerConnectionRemoveStream.bind(this)};BX.Call.PlainCall.Peer.prototype.sendMedia=function(){var e=[];if(this.call.localStreams["main"]){e=e.concat(this.call.localStreams["main"].getAudioTracks())}if(this.call.localStreams["screen"]){e=e.concat(this.call.localStreams["screen"].getVideoTracks())}else if(this.call.localStreams["main"]){e=e.concat(this.call.localStreams["main"].getVideoTracks())}this.log("User: "+this.userId+"; Sending media streams. Tracks: "+e.map(function(e){return e.id}).join("; "));if(e.length===0){this.log("No media streams to send");return}if(this.peerConnection){this.peerConnection.getSenders().forEach(function(e){this.peerConnection.removeTrack(e)}.bind(this))}if(this.senderMediaStream&&this.senderMediaStream.getTracks().length>0){this.log("removing old tracks");this.senderMediaStream.getTracks().forEach(function(e){this.senderMediaStream.removeTrack(e)},this)}if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.getSignaling().sendNegotiationNeeded({userId:this.userId});return}var t=BX.Call.Engine.getInstance().getUuidv4();this._createPeerConnection(t)}this.senderMediaStream=new MediaStream;e.forEach(function(e){this.senderMediaStream.addTrack(e);this.peerConnection.addTrack(e,this.senderMediaStream)},this)};BX.Call.PlainCall.Peer.prototype.replaceMediaStream=function(e){if(this.isRenegotiationSupported()){this.sendMedia()}else{this.localStreams[e]=this.call.getLocalStream(e);this.reconnect()}};BX.Call.PlainCall.Peer.prototype.isInitiator=function(){return this.call.userId<this.userId};BX.Call.PlainCall.Peer.prototype.isRenegotiationSupported=function(){return BX.browser.IsChrome()&&this.isChrome};BX.Call.PlainCall.Peer.prototype.setReady=function(e){this.ready=e;if(this.ready){this.declined=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.isReady=function(){return this.ready};BX.Call.PlainCall.Peer.prototype.onInvited=function(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(this.onInviteTimeout.bind(this),3e4);this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.onInviteTimeout=function(){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.setUserAgent=function(e){this.userAgent=e;this.isFirefox=e.toLowerCase().indexOf("firefox")!=-1;this.isChrome=e.toLowerCase().indexOf("chrome")!=-1;this.isMobile=e==="Bitrix Mobile"};BX.Call.PlainCall.Peer.prototype.getUserAgent=function(){return this.userAgent};BX.Call.PlainCall.Peer.prototype.isParticipating=function(){if(this.calling)return true;if(this.declined)return false;if(this.peerConnection){var e=this.peerConnection.iceConnectionState;if(e=="checking"||e=="connected"||e=="completed"){return true}}return false};BX.Call.PlainCall.Peer.prototype.setSignalingConnected=function(e){this.signalingConnected=e;this.updateCalculatedState();if(this.signalingConnected)this.refreshSignalingTimeout();else this.stopSignalingTimeout()};BX.Call.PlainCall.Peer.prototype.isSignalingConnected=function(){return this.signalingConnected};BX.Call.PlainCall.Peer.prototype.setDeclined=function(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.isDeclined=function(){return this.declined};BX.Call.PlainCall.Peer.prototype.updateCalculatedState=function(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState,isMobile:this.isMobile});this.calculatedState=e}};BX.Call.PlainCall.Peer.prototype.calculateState=function(){if(this.peerConnection){if(this.peerConnection.iceConnectionState==="failed"){return BX.Call.UserState.Failed}if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return BX.Call.UserState.Connected}return BX.Call.UserState.Connecting}if(this.calling)return BX.Call.UserState.Calling;if(this.inviteTimeout)return BX.Call.UserState.Failed;if(this.declined)return BX.Call.UserState.Declined;if(this.ready)return BX.Call.UserState.Ready;return BX.Call.UserState.Idle};BX.Call.PlainCall.Peer.prototype.getSignaling=function(){return this.call.signaling};BX.Call.PlainCall.Peer.prototype.startStatisticsGathering=function(){clearInterval(this.statsInterval);this.statsInterval=setInterval(function(){if(!this.peerConnection){return false}this.peerConnection.getStats().then(function(e){this.callbacks.onRTCStatsReceived({userId:this.userId,stats:e})}.bind(this))}.bind(this),1e3)};BX.Call.PlainCall.Peer.prototype.stopStatisticsGathering=function(){clearInterval(this.statsInterval);this.statsInterval=null};BX.Call.PlainCall.Peer.prototype.updateCandidatesTimeout=function(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)};BX.Call.PlainCall.Peer.prototype.sendIceCandidates=function(){this.candidatesTimeout=null;this.log("User "+this.userId+": sending ICE candidates due to the timeout");if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}};BX.Call.PlainCall.Peer.prototype._createPeerConnection=function(e){this.log("User "+this.userId+": Creating peer connection");var t={iceServers:[{url:"stun:"+this.call.turnServer},{url:"turn:"+this.call.turnServer,username:this.call.turnServerLogin,credential:this.call.turnServerPassword}]};this.localIceCandidates=[];var n=new RTCPeerConnection(t);n._id=e;n.addEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);n.addEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);n.addEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);n.addEventListener("negotiationneeded",this._onPeerConnectionNegotiationNeededHandler);n.addEventListener("track",this._onPeerConnectionTrackHandler);n.addEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.peerConnection=n;this.updateCalculatedState();this.startStatisticsGathering()};BX.Call.PlainCall.Peer.prototype._destroyPeerConnection=function(){if(!this.peerConnection)return;this.log("User "+this.userId+": Destroying peer connection");this.stopStatisticsGathering();this.peerConnection.removeEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.removeEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.removeEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.removeEventListener("negotiationneeded",this._onPeerConnectionNegotiationNeededHandler);this.peerConnection.removeEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.removeEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.peerConnection.close();this.peerConnection=null};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceCandidate=function(e){var t=e.candidate;this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+(t?t.candidate:t));if(t){if(this.getSignaling().isIceTricklingAllowed()){this.getSignaling().sendIceCandidate({userId:this.userId,candidates:[t.toJSON()]})}else{this.localIceCandidates.push(t.toJSON());this.updateCandidatesTimeout()}}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceConnectionStateChange=function(e){this.log("User "+this.userId+": ICE connection state changed. New state: "+this.peerConnection.iceConnectionState);this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceGatheringStateChange=function(e){var t=e.target;this.log("User "+this.userId+": ICE gathering state changed to : "+t.iceGatheringState);if(t.iceGatheringState==="complete"){this.log("User "+this.userId+": ICE gathering complete");if(!this.getSignaling().isIceTricklingAllowed()){if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates already sent")}}}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionNegotiationNeeded=function(e){this.log("User "+this.userId+": needed negotiation for peer connection");this.log("signaling state: ",e.target.signalingState);this.log("ice connection state: ",e.target.iceConnectionState);this.log("pendingRemoteDescription: ",e.target.pendingRemoteDescription);if(e.target.iceConnectionState!=="new"&&e.target.iceConnectionState!=="connected"&&e.target.iceConnectionState!=="completed"){this.log("User "+this.userId+": wrong connection state");return}if(this.isInitiator()){this.createAndSendOffer()}else{this.getSignaling().sendNegotiationNeeded({userId:this.userId})}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionTrack=function(e){this.log("User "+this.userId+": media track received: ",e.track.id+" ("+e.track.kind+")");this.callbacks.onStreamReceived({userId:this.userId,kind:e.track.kind,stream:e.streams[0]})};BX.Call.PlainCall.Peer.prototype._onPeerConnectionRemoveStream=function(e){this.log("User: "+this.userId+"_onPeerConnectionRemoveStream: ",e);this.callbacks.onStreamRemoved({userId:this.userId,stream:e.stream})};BX.Call.PlainCall.Peer.prototype.stopSignalingTimeout=function(){clearTimeout(this.signalingConnectionTimeout)};BX.Call.PlainCall.Peer.prototype.refreshSignalingTimeout=function(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(this._onLostSignalingConnection.bind(this),i)};BX.Call.PlainCall.Peer.prototype._onLostSignalingConnection=function(){this.setSignalingConnected(false)};BX.Call.PlainCall.Peer.prototype.setConnectionOffer=function(e,t){this.log("User "+this.userId+": applying connection offer for connection "+e);if(!this.call.isReady())return;if(!this.isReady())return;if(this.peerConnection){if(this.peerConnection._id!==e){this._destroyPeerConnection();this._createPeerConnection(e)}}else{this._createPeerConnection(e)}this.applyOfferAndSendAnswer(t)};BX.Call.PlainCall.Peer.prototype.createAndSendOffer=function(e){var t=this;connectionConfig=n;for(var i in e){connectionConfig[i]=e[i]}t.peerConnection.createOffer(connectionConfig).then(function(e){t.log("User "+t.userId+": Created connection offer.");t.log("Applying local description");return t.peerConnection.setLocalDescription(e)}).then(function(){t.sendOffer()})};BX.Call.PlainCall.Peer.prototype.sendOffer=function(){this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:this.peerConnection._id,sdp:this.peerConnection.localDescription.sdp,userAgent:navigator.userAgent})};BX.Call.PlainCall.Peer.prototype.applyOfferAndSendAnswer=function(e){var t=this;var n=new RTCSessionDescription({type:"offer",sdp:e});var i=this.peerConnection;this.log("User: "+this.userId+"; Applying remote offer");this.log("User: "+this.userId+"; Peer ice connection state ",i.iceConnectionState);i.setRemoteDescription(n).then(function(){if(i.iceConnectionState==="new"){t.sendMedia()}return t.peerConnection.createAnswer()}).then(function(e){t.log("Created connection answer.");t.log("Applying local description.");return t.peerConnection.setLocalDescription(e)}).then(function(){t.applyPendingIceCandidates();t.getSignaling().sendConnectionAnswer({userId:t.userId,connectionId:t.peerConnection._id,sdp:t.peerConnection.localDescription.sdp,userAgent:navigator.userAgent})}).catch(function(e){t.log(e)})};BX.Call.PlainCall.Peer.prototype.setConnectionAnswer=function(e){var t=this;if(!this.peerConnection)return;if(this.peerConnection.signalingState!=="have-local-offer")return;var n=new RTCSessionDescription({type:"answer",sdp:e});this.log("User: "+this.userId+"; Applying remote answer");this.peerConnection.setRemoteDescription(n).then(function(){t.applyPendingIceCandidates()})};BX.Call.PlainCall.Peer.prototype.addIceCandidate=function(e){if(!this.peerConnection)return;if(this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){this.peerConnection.addIceCandidate(e).then(function(){this.log("User: "+this.userId+"; Added remote ICE candidate: "+(e?e.candidate:e))}.bind(this)).catch(function(e){this.log(e)}.bind(this))}else{this.pendingIceCandidates.push(e)}};BX.Call.PlainCall.Peer.prototype.applyPendingIceCandidates=function(){var e=this;if(!this.peerConnection||!this.peerConnection.remoteDescription.type)return;if(BX.type.isArray(this.pendingIceCandidates)){this.pendingIceCandidates.forEach(function(t){e.peerConnection.addIceCandidate(t).then(function(){this.log("User: "+this.userId+"; Added remote ICE candidate: "+(t?t.candidate:t))}.bind(this))});e.pendingIceCandidates=[]}};BX.Call.PlainCall.Peer.prototype.onNegotiationNeeded=function(){if(this.peerConnection){this.createAndSendOffer({iceRestart:true})}else{this.sendMedia()}};BX.Call.PlainCall.Peer.prototype.reconnect=function(){if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}else{this.getSignaling().sendNegotiationNeeded({userId:this.userId,restart:true})}};BX.Call.PlainCall.Peer.prototype.disconnect=function(){this._destroyPeerConnection()};BX.Call.PlainCall.Peer.prototype.log=function(){this.call.log.apply(this.call,arguments)};BX.Call.PlainCall.Peer.prototype.destroy=function(){this.disconnect();if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}for(var e in this.localStreams){this.localStreams[e]=null}clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onStreamReceived=BX.DoNothing;this.callbacks.onStreamRemoved=BX.DoNothing}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:60:"/bitrix/js/im/v1/call/voximplant_call.min.js?155775640420147";s:6:"source";s:40:"/bitrix/js/im/v1/call/voximplant_call.js";s:3:"min";s:44:"/bitrix/js/im/v1/call/voximplant_call.min.js";s:3:"map";s:44:"/bitrix/js/im/v1/call/voximplant_call.map.js";}"*/
(function(){debug=false;BX.namespace("BX.Call");var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var t={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped"};var i=25e3;navigator["getDisplayMedia"]=function(){var e={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[{googTemporalLayeredScreencast:true}]}};return navigator.mediaDevices.getUserMedia(e)};BX.Call.VoximplantCall=function(e){BX.Call.PlainCall.superclass.constructor.apply(this,arguments);if(!window.VoxImplant){throw new Error("Voximplant SDK is not found")}this.voximplant=null;this.voximplantCall=null;this.signaling=new BX.Call.VoximplantCall.Signaling({call:this});this.peers={};this.voiceDetection=null;this.screenShared=false;this.deviceList=[];this.__onMicAccessResultHandler=this.__onMicAccessResult.bind(this);this.__onLocalDevicesUpdatedHandler=this.__onLocalDevicesUpdated.bind(this);this.__onLocalMediaRendererAddedHandler=this.__onLocalMediaRendererAdded.bind(this);this.__onBeforeLocalMediaRendererRemovedHandler=this.__onBeforeLocalMediaRendererRemoved.bind(this);this.init();this.ping();this.pingInterval=setInterval(this.ping.bind(this),i)};BX.extend(BX.Call.VoximplantCall,BX.Call.AbstractCall);BX.Call.VoximplantCall.prototype.init=function(){this.users.forEach(function(e){this.peers[e]=this.createPeer(e)},this)};BX.Call.VoximplantCall.prototype.ping=function(){this.signaling.sendPing({userId:this.users})};BX.Call.VoximplantCall.prototype.createPeer=function(e){return new BX.Call.VoximplantCall.Peer({call:this,userId:e,ready:e==this.initiatorId,onStreamReceived:function(e){this.runCallback(BX.Call.Event.onStreamReceived,e)}.bind(this),onStreamRemoved:function(e){this.runCallback(BX.Call.Event.onStreamRemoved,e)}.bind(this),onStateChanged:this.__onPeerStateChanged.bind(this)})};BX.Call.VoximplantCall.prototype.getUsers=function(){var e={};for(var t in this.peers){e[t]=this.peers[t].calculatedState}return e};BX.Call.VoximplantCall.prototype.getClient=function(){var e=this;return new Promise(function(t,i){if(e.voximplant){return t()}BX.Voximplant.getClient().then(function(i){e.voximplant=i;e.voximplant.enableSilentLogging();e.voximplant.setLoggerCallback(function(t){if(e.debug){e.log(t.label+": "+t.message)}});e.bindClientEvents();t()}).catch(function(e){i(e)})})};BX.Call.VoximplantCall.prototype.bindClientEvents=function(){this.voximplant.addEventListener(VoxImplant.Events.MicAccessResult,this.__onMicAccessResultHandler);var e=VoxImplant.Hardware.StreamManager.get();e.on(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler)};BX.Call.VoximplantCall.prototype.removeClientEvents=function(){if(this.voximplant){this.voximplant.removeEventListener(VoxImplant.Events.MicAccessResult,this.__onMicAccessResultHandler)}var e=VoxImplant.Hardware.StreamManager.get();e.off(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler)};BX.Call.VoximplantCall.prototype.setMuted=function(e){if(this.muted==e){return}this.muted=e;if(this.voximplantCall){if(this.muted){this.voximplantCall.muteMicrophone()}else{this.voximplantCall.unmuteMicrophone()}}};BX.Call.VoximplantCall.prototype.setVideoEnabled=function(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.voximplantCall){this.voximplantCall.sendVideo(this.videoEnabled);if(!this.videoEnabled){this.voximplantCall.sendVideo(this.videoEnabled)}}};BX.Call.VoximplantCall.prototype.setCameraId=function(e){if(this.cameraId==e){return}this.cameraId=e;if(this.voximplantCall){VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(this.voximplantCall,{cameraId:this.cameraId})}};BX.Call.VoximplantCall.prototype.setMicrophoneId=function(e){if(this.microphoneId==e){return}this.microphoneId=e;if(this.voximplantCall){VoxImplant.Hardware.AudioDeviceManager.get().setCallAudioSettings(this.voximplantCall,{inputId:this.microphoneId})}};BX.Call.VoximplantCall.prototype.startScreenSharing=function(){if(!this.voximplantCall){return}this.voximplantCall.shareScreen(true).then(function(){this.screenShared=true}.bind(this))};BX.Call.VoximplantCall.prototype.stopScreenSharing=function(){if(!this.voximplantCall){return}this.voximplantCall.stopSharingScreen();this.screenShared=false;this.runCallback(BX.Call.Event.onLocalMediaStopped,{tag:"screen"})};BX.Call.VoximplantCall.prototype.isScreenSharingStarted=function(){return this.screenShared};BX.Call.VoximplantCall.prototype.inviteUsers=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}var i=BX.type.isArray(e.users)?e.users:this.users;this.attachToConference().then(function(){return t.signaling.inviteUsers({userIds:i,video:t.videoEnabled?"Y":"N"})}).then(function(e){for(var n=0;n<i.length;n++){if(!t.peers[i[n]]){t.peers[i[n]]=t.createPeer(i[n]);t.runCallback(BX.Call.Event.onUserInvited,{userId:i[n]})}t.peers[i[n]].onInvited()}}).catch(function(e){t.runCallback(BX.Call.Event.onCallFailure,{error:e})})};BX.Call.VoximplantCall.prototype.answer=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}this.videoEnabled=e.useVideo==true;this.signaling.sendAnswer();this.attachToConference().catch(function(e){t.runCallback(BX.Call.Event.onCallFailure,{error:e})})};BX.Call.VoximplantCall.prototype.decline=function(){this.ready=false;BX.ajax.runAction(e.decline,{data:{callId:this.id,callInstanceId:this.instanceId}}).then(function(){this.destroy()}.bind(this))};BX.Call.VoximplantCall.prototype.hangup=function(e,t){var i=this;return new Promise(function(n,a){var l={};if(typeof e!="undefined"){l.code=e}if(typeof t!="undefined"){l.reason=t}i.signaling.sendHangup(l);if(i.voximplantCall){if(i.voximplantCall.state()!="ENDED"){i.voximplantCall.hangup()}}return n()})};BX.Call.VoximplantCall.prototype.attachToConference=function(){var e=this;return new Promise(function(t,i){if(e.voximplantCall){return t()}e.getClient().then(function(){if(!e.voximplant._config.experiments){e.voximplant._config.experiments={}}e.voximplantCall=e.voximplant.callConference({number:"bx_conf_"+e.id,video:{sendVideo:e.videoEnabled,receiveVideo:true},customData:null});e.bindCallEvents();var n=function(){e.log("Call connected");e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,a);if(e.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then(function(t){e.deviceList=t;e.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:e.deviceList})})}t()};var a=function(t){e.log("Could not attach to conference",t);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,a);i(t)};e.voximplantCall.addEventListener(VoxImplant.CallEvents.Connected,n);e.voximplantCall.addEventListener(VoxImplant.CallEvents.Failed,a)}).catch(function(t){var i;if(typeof t==="string"){e.runCallback(BX.Call.Event.onCallFailure,{error:t})}else if(BX.type.isPlainObject(t)){if(t.hasOwnProperty("status")&&t.status==401){i="AUTHORIZE_ERROR"}else if(t.name==="AuthResult"){i="AUTHORIZE_ERROR"}else{i="UNKNOWN_ERROR"}e.runCallback(BX.Call.Event.onCallFailure,{error:i})}})})};BX.Call.VoximplantCall.prototype.bindCallEvents=function(){this.voximplantCall.addEventListener(VoxImplant.CallEvents.Disconnected,this.__onCallDisconnected.bind(this));this.voximplantCall.addEventListener(VoxImplant.CallEvents.MessageReceived,this.__onCallMessageReceived.bind(this));this.voximplantCall.addEventListener(VoxImplant.CallEvents.EndpointAdded,this.__onCallEndpointAdded.bind(this))};BX.Call.VoximplantCall.prototype.isAnyoneParticipating=function(){for(var e in this.peers){if(this.peers[e].isParticipating()){return true}}return false};BX.Call.VoximplantCall.prototype.attachVoiceDetection=function(e){if(this.voiceDetection){this.voiceDetection.destroy()}this.voiceDetection=new BX.SimpleVAD({mediaStream:e,onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)})};BX.Call.VoximplantCall.prototype.onLocalVoiceStarted=function(e){this.signaling.sendVoiceStarted()};BX.Call.VoximplantCall.prototype.onLocalVoiceStopped=function(e){this.signaling.sendVoiceStopped()};BX.Call.VoximplantCall.prototype.__onPeerStateChanged=function(e){this.runCallback(BX.Call.Event.onUserStateChanged,e);if(e.state==BX.Call.UserState.Failed){if(!this.isAnyoneParticipating()){this.hangup()}}};BX.Call.VoximplantCall.prototype.__onPullEvent=function(e,t,i){var n={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::finish":this.__onPullEventFinish.bind(this)};if(n[e]){n[e].call(this,t)}};BX.Call.VoximplantCall.prototype.__onPullEventAnswer=function(e){var t=e.senderId;if(t===this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.peers[t]){return}this.peers[t].setReady(true)};BX.Call.VoximplantCall.prototype.__onPullEventAnswerSelf=function(e){if(e.callInstanceId===this.instanceId){return}this.destroy()};BX.Call.VoximplantCall.prototype.__onPullEventHangup=function(e){var t=e.senderId;if(this.userId==t&&this.instanceId!=e.callInstanceId){this.destroy();return}if(!this.peers[t])return;this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()){this.hangup()}};BX.Call.VoximplantCall.prototype.__onPullEventUsersInvited=function(e){this.log("__onPullEventUsersInvited",e);var t=e.users;for(var i=0;i<t.length;i++){var n=t[i];if(this.peers[n]){if(this.peers[n].calculatedState===BX.Call.UserState.Failed||this.peers[n].calculatedState===BX.Call.UserState.Idle){this.peers[n].onInvited()}}else{this.peers[n]=this.createPeer(n);this.runCallback(BX.Call.Event.onUserInvited,{userId:n});this.peers[n].onInvited()}}};BX.Call.VoximplantCall.prototype.__onPullEventFinish=function(e){this.destroy()};BX.Call.VoximplantCall.prototype.__onMicAccessResult=function(e){this.log("__onMicAccessResult",e);if(e.result){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"main",stream:e.stream})}else{this.log("Could not get access to media input devices",e)}};BX.Call.VoximplantCall.prototype.__onLocalDevicesUpdated=function(e){this.log("__onLocalDevicesUpdated",e)};BX.Call.VoximplantCall.prototype.__onLocalMediaRendererAdded=function(e){this.log("__onLocalMediaRendererAdded",e);var t=e.renderer;if(t.kind==="sharing"){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"screen",stream:t.stream})}};BX.Call.VoximplantCall.prototype.__onBeforeLocalMediaRendererRemoved=function(e){this.log("__onBeforeLocalMediaRendererRemoved",e);var t=e.renderer;if(t.kind==="sharing"){this.runCallback(BX.Call.Event.onLocalMediaStopped,{tag:"screen"})}};BX.Call.VoximplantCall.prototype.__onCallDisconnected=function(e){this.log("__onCallDisconnected",e);this.destroy()};BX.Call.VoximplantCall.prototype.__onCallEndpointAdded=function(e){this.log("__onCallEndpointAdded",e);var t=this;var i=e.endpoint;var n=i.userName;if(BX.type.isNotEmptyString(n)&&n.substr(0,4)=="user"){var a=parseInt(n.substr(4));if(this.peers[a]){this.peers[a].setEndpoint(i)}}else{i.addEventListener(VoxImplant.EndpointEvents.InfoUpdated,function(e){this.log("VoxImplant.EndpointEvents.InfoUpdated",e);var t=e.endpoint;var i=t.userName;if(BX.type.isNotEmptyString(i)&&i.substr(0,4)=="user"){var n=parseInt(i.substr(4));if(this.peers[n]){this.peers[n].setEndpoint(t)}}}.bind(this));this.log("Unknown endpoint "+n)}};BX.Call.VoximplantCall.prototype.__onCallMessageReceived=function(e){var i;try{i=JSON.parse(e.text)}catch(e){this.log("Could not parse scenario message.",e)}var n=i.eventName;if(n===t.voiceStarted){this.runCallback(BX.Call.Event.onUserVoiceStarted,{userId:i.senderId})}else if(n===t.voiceStopped){this.runCallback(BX.Call.Event.onUserVoiceStopped,{userId:i.senderId})}else{this.log("Unknown scenario event")}};BX.Call.VoximplantCall.prototype.destroy=function(){if(this.voximplantCall){if(this.voximplantCall.state()!="ENDED"){this.voximplantCall.hangup()}}this.voximplantCall=null;for(var e in this.peers){if(this.peers.hasOwnProperty(e)){this.peers[e].destroy()}}this.removeClientEvents();clearInterval(this.pingInterval);this.runCallback(BX.Call.Event.onDestroy)};BX.Call.VoximplantCall.Signaling=function(e){this.call=e.call};BX.Call.VoximplantCall.Signaling.prototype.inviteUsers=function(t){return this.__runAjaxAction(e.invite,t)};BX.Call.VoximplantCall.Signaling.prototype.sendAnswer=function(t){return this.__runAjaxAction(e.answer,t)};BX.Call.VoximplantCall.Signaling.prototype.sendCancel=function(t){return this.__runAjaxAction(e.cancel,t)};BX.Call.VoximplantCall.Signaling.prototype.sendHangup=function(t){return this.__runAjaxAction(e.hangup,t)};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStarted=function(e){return this.__sendMessage(t.voiceStarted,e)};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStopped=function(e){return this.__sendMessage(t.voiceStopped,e)};BX.Call.VoximplantCall.Signaling.prototype.sendPing=function(t){this.__runAjaxAction(e.ping,{retransmit:false})};BX.Call.VoximplantCall.Signaling.prototype.__sendMessage=function(e,t){if(!this.call.voximplantCall){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))};BX.Call.VoximplantCall.Signaling.prototype.__runAjaxAction=function(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=BX.Call.Engine.getInstance().getUuidv4();return BX.ajax.runAction(e,{data:t})};BX.Call.VoximplantCall.Peer=function(e){this.userId=e.userId;this.call=e.call;this.ready=!!e.ready;this.calling=false;this.declined=false;this.inviteTimeout=false;this.endpoint=null;this.stream=null;this.tracks={audio:null,video:null,sharing:null};this.callingTimeout=0;this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing};this.__onEndpointRemoteMediaAddedHandler=this.__onEndpointRemoteMediaAdded.bind(this);this.__onEndpointRemoteMediaRemovedHandler=this.__onEndpointRemoteMediaRemoved.bind(this);this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.calculatedState=this.calculateState()};BX.Call.VoximplantCall.Peer.prototype={setReady:function(e){this.ready=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()},setDeclined:function(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()},setEndpoint:function(e){this.log("Adding endpoint with "+e.mediaRenderers.length+" media renderers");if(!this.ready){this.setReady(true)}if(this.endpoint){throw new Error("Endpoint already exists for user "+this.userId)}this.endpoint=e;for(var t=0;t<this.endpoint.mediaRenderers.length;t++){this.addMediaRenderer(this.endpoint.mediaRenderers[t]);if(this.endpoint.mediaRenderers[t].element){BX.remove(this.endpoint.mediaRenderers[t].element)}}this.bindEndpointEventHandlers()},addMediaRenderer:function(e){this.log("Adding media renderer");if(!this.stream){this.stream=new MediaStream}e.stream.getTracks().forEach(function(t){if(t.kind=="audio"){this.tracks.audio=t}else if(t.kind=="video"){if(e.kind=="sharing"){this.tracks.sharing=t}else{this.tracks.video=t}}else{this.log("Unknown track kind "+t.kind)}},this);this.updateMediaStream();this.updateCalculatedState()},updateMediaStream:function(){if(!this.stream){this.stream=new MediaStream}this.stream.getTracks().forEach(function(e){if(!this.hasTrack(e)){this.stream.removeTrack(e)}},this);if(this.tracks.audio&&!this.stream.getTrackById(this.tracks.audio.id)){this.stream.addTrack(this.tracks.audio)}if(this.tracks.sharing){if(this.tracks.video&&this.stream.getTrackById(this.tracks.video.id)){this.stream.removeTrack(this.tracks.video)}if(!this.stream.getTrackById(this.tracks.sharing.id)){this.stream.addTrack(this.tracks.sharing)}}else{if(this.tracks.video&&!this.stream.getTrackById(this.tracks.video.id)){this.stream.addTrack(this.tracks.video)}}this.callbacks.onStreamReceived({userId:this.userId,stream:this.stream})},hasTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}if(this.tracks.kind&&this.tracks.kind.id==e.id){return true}}return false},removeTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}var i=this.tracks[t]?this.tracks[t].id:"";if(i==e.id){this.tracks[t]=null}}},bindEndpointEventHandlers:function(){this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},removeEndpointEventHandlers:function(){this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},calculateState:function(){if(this.stream)return BX.Call.UserState.Connected;if(this.endpoint)return BX.Call.UserState.Connecting;if(this.calling)return BX.Call.UserState.Calling;if(this.inviteTimeout)return BX.Call.UserState.Failed;if(this.declined)return BX.Call.UserState.Declined;if(this.ready)return BX.Call.UserState.Ready;return BX.Call.UserState.Idle},updateCalculatedState:function(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState});this.calculatedState=e}},isParticipating:function(){return(this.calling||this.ready||this.endpoint)&&!this.declined},onInvited:function(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(this.onInviteTimeout.bind(this),3e4);this.updateCalculatedState()},onInviteTimeout:function(){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;this.updateCalculatedState()},__onEndpointRemoteMediaAdded:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaAdded",e);this.addMediaRenderer(e.mediaRenderer)},__onEndpointRemoteMediaRemoved:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, track id: "+e.mediaRenderer.stream.getTracks()[0].id,e);e.mediaRenderer.stream.getTracks().forEach(function(e){this.removeTrack(e)},this);if(this.stream){this.updateMediaStream()}this.updateCalculatedState()},__onEndpointRemoved:function(e){this.log("VoxImplant.EndpointEvents.Removed",e);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}if(this.stream){this.stream=null}for(var t in this.tracks){if(this.tracks.hasOwnProperty(t)){this.tracks[t]=null}}this.updateCalculatedState()},log:function(){this.call.log.apply(this.call,arguments)},destroy:function(){if(this.stream){this.stream=null}if(this.endpoint){this.endpoint=null}for(var e in this.tracks){if(this.tracks.hasOwnProperty(e)){this.tracks[e]=null}}clearTimeout(this.callingTimeout);this.callingTimeout=null}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:48:"/bitrix/js/im/v1/call/util.min.js?15577564042668";s:6:"source";s:29:"/bitrix/js/im/v1/call/util.js";s:3:"min";s:33:"/bitrix/js/im/v1/call/util.min.js";s:3:"map";s:33:"/bitrix/js/im/v1/call/util.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Util){return}BX.Call.Util={userData:{},usersInProcess:{},updateUserData:function(e){var r=[];var a=this;for(var t=0;t<e.length;t++){if(this.userData.hasOwnProperty(e[t])){continue}r.push(e[t])}var n=new Promise(function(e,t){if(r.length===0){return e()}BX.rest.callMethod("im.user.list.get",{ID:r,AVATAR_HR:"Y"}).then(function(r){var t=r.answer.result;if(BX.type.isPlainObject(t)){for(var n in t){a.userData[n]=t[n];delete a.usersInProcess[n]}}e()}).catch(function(e){t(e.answer)})});for(var t=0;t<r.length;t++){this.usersInProcess[r[t]]=n}return n},getUser:function(e){var r=this;return new Promise(function(a,t){if(r.userData.hasOwnProperty(e)){return a(r.userData[e])}else if(r.usersInProcess.hasOwnProperty(e)){r.usersInProcess[e].then(function(){return a(r.userData[e])})}else{r.updateUserData([e]).then(function(){return a(r.userData[e])})}})},getUserName:function(e){var r=this;return new Promise(function(a,t){if(r.userData.hasOwnProperty(e)){return a(r.userData[e].name?r.userData[e].name:"")}else if(r.usersInProcess.hasOwnProperty(e)){r.usersInProcess[e].then(function(){return a(r.userData[e].name?r.userData[e].name:"")})}else{r.updateUserData([e]).then(function(){return a(r.userData[e].name?r.userData[e].name:"")})}})},getUserAvatar:function(e){var r=this;return new Promise(function(a,t){if(r.userData.hasOwnProperty(e)){return a(r.userData[e].avatar_hr?r.userData[e].avatar_hr:"")}else if(r.usersInProcess.hasOwnProperty(e)){r.usersInProcess[e].then(function(){return a(r.userData[e].avatar_hr?r.userData[e].avatar_hr:"")})}else{r.updateUserData([e]).then(function(){return a(r.userData[e].avatar_hr?r.userData[e].avatar_hr:"")})}})},getCustomMessage:function(e,r){var a;if(!BX.type.isPlainObject(r)){r={}}if(r.gender&&BX.message.hasOwnProperty(e+"_"+r.gender)){a=BX.message(e+"_"+r.gender)}else{a=BX.message(e)}r=this.convertKeysToUpper(r);return a.replace(/#.+?#/gm,function(e){var a=e.substr(1,e.length-2);return r.hasOwnProperty(a)?r[a]:e})},convertKeysToUpper:function(e){var r=BX.util.objectClone(e);for(var a in r){var t=a.toUpperCase();if(t!=a){r[t]=r[a];delete r[a]}}return r},appendChildren:function(e,r){r.forEach(function(r){e.appendChild(r)})},containsVideoTrack:function(e){if(!(e instanceof MediaStream))return false;return e.getVideoTracks().length>0},findRowCount:function(e,r,a){var t=0;var n=0;for(var s=1;s<=a;s++){var u=this.getFilledArea(e,r,a,s);if(u>n){t=s;n=u}}return t},getFilledArea:function(e,r,a,t){var n=Math.ceil(a/t);var s=e/n;var u=r/t;var i=u/s;var o=9/16;var c;var f;if(i<o){c=u;f=s*(i/o)}else{f=s;c=u*(o/i)}var h=f*c*a;return h}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/im/v1/call/view.min.js?155775640438288";s:6:"source";s:29:"/bitrix/js/im/v1/call/view.js";s:3:"min";s:33:"/bitrix/js/im/v1/call/view.min.js";s:3:"map";s:33:"/bitrix/js/im/v1/call/view.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.View){return}var e={Grid:1,Centered:2};var t={Calling:1,Connected:2,Error:3};var s=1200;BX.Call.View=function(s){this.title=s.title;this.container=s.container;this.cameraId=s.cameraId;this.microphoneId=s.microphoneId;this.showChatButtons=s.showChatButtons===true;this.language=s.language||"";this.cameraList=[];this.microphoneList=[];this.userLimit=s.userLimit||1;this.userId=BX.message("USER_ID");this.localUser=new n({id:this.userId,state:BX.Call.UserState.Connected,localUser:true});this.elements={root:null,container:null,overlay:null,panel:null,audioContainer:null,audio:{},center:{container:null,video:null},userBlock:null,ear:{left:null,right:null},userList:{rows:[],addButton:null}};this.buttons={title:null,grid:null,add:null,link:null,microphone:null,camera:null,screen:null,chat:null,history:null,hangup:null,fullscreen:null,overlay:null,status:null};this.size=BX.Call.View.Size.Full;this.isMuted=false;this.isCameraOn=false;this.isFullScreen=false;this.disabledButtons={};this.uiState=t.Calling;this.layout=e.Centered;this.grid={rows:0,columns:0};this.users={};if(BX.type.isPlainObject(s.userStates)){this.appendUsers(s.userStates)}this.callbacks={onClose:BX.type.isFunction(s.onClose)?s.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(s.onDestroy)?s.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(s.onButtonClick)?s.onButtonClick:BX.DoNothing,onBodyClick:BX.type.isFunction(s.onBodyClick)?s.onBodyClick:BX.DoNothing,onReplaceCamera:BX.type.isFunction(s.onReplaceCamera)?s.onReplaceCamera:BX.DoNothing,onReplaceMicrophone:BX.type.isFunction(s.onReplaceMicrophone)?s.onReplaceMicrophone:BX.DoNothing,onSetCentralUser:BX.type.isFunction(s.onSetCentralUser)?s.onSetCentralUser:BX.DoNothing};this.scrollInterval=0;this._onFullScreenChangeHandler=this._onFullScreenChange.bind(this);this._onResizeHandler=this._onResize.bind(this);this.init()};BX.Call.View.prototype.init=function(){if(this.isFullScreenSupported()){if(BX.browser.IsChrome()||BX.browser.IsSafari()){window.addEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler)}else if(BX.browser.IsFirefox()){window.addEventListener("mozfullscreenchange",this._onFullScreenChangeHandler)}}window.addEventListener("resize",this._onResizeHandler);this.elements.audioContainer=BX.create("div",{props:{className:"bx-messenger-videocall-audio-container"}});this.container.appendChild(this.elements.audioContainer)};BX.Call.View.prototype.setCallback=function(e,t){if(BX.type.isFunction(t)&&this.callbacks.hasOwnProperty(e)){this.callbacks[e]=t}};BX.Call.View.prototype.appendUsers=function(e){if(!BX.type.isPlainObject(e)){return}var t=Object.keys(e);for(var s=0;s<t.length;s++){this.users[t[s]]=new n({id:t[s],state:e[t[s]]?e[t[s]]:BX.Call.UserState.Idle,onClick:this._onUserClick.bind(this)})}BX.Call.Util.updateUserData(t)};BX.Call.View.prototype.setDeviceList=function(e){this.cameraList=[];this.microphoneList=[];for(var t=0;t<e.length;t++){var s=e[t];if(s.kind=="audioinput"){this.microphoneList.push(s)}else if(s.kind=="videoinput"){this.cameraList.push(s)}}if(this.buttons.camera){if(this.cameraList.length===0){this.buttons.camera.hideArrow()}else{this.buttons.camera.showArrow()}}if(this.buttons.microphone){if(this.microphoneList.length===0){this.buttons.microphone.hideArrow()}else{this.buttons.microphone.showArrow()}}};BX.Call.View.prototype.setCentralUser=function(t){if(this.centralUser.userId==t){return}if(t==this.userId&&this.getUsersWithVideo().length>0){return}if(!this.users[t]){return}this.centralUser.setUserId(t);if(this.layout==e.Centered){this.updateUserList()}this.callbacks.onSetCentralUser({userId:t,stream:t==this.userId?this.localUser.stream:this.users[t].stream})};BX.Call.View.prototype.getUserCount=function(){return Object.keys(this.users).length};BX.Call.View.prototype.getConnectedUserCount=function(){return this.getConnectedUsers().length};BX.Call.View.prototype.getUsersWithVideo=function(){var e=[];for(var t in this.users){if(this.users[t].hasVideo()){e.push(t)}}return e};BX.Call.View.prototype.getConnectedUsers=function(){var e=[];for(var t in this.users){if(this.users[t].state==BX.Call.UserState.Connected){e.push(t)}}return e};BX.Call.View.prototype.setUiState=function(e){if(this.uiState==e){return}this.uiState=e;this.updateButtons()};BX.Call.View.prototype.setLayout=function(t){if(t==this.layout){return}this.layout=t;for(var s=0;s<this.elements.userList.rows.length;s++){BX.remove(this.elements.userList.rows[s])}this.elements.userList.rows=this.renderUserList();if(this.layout==e.Centered){this.elements.root.className="bx-messenger-videocall bx-messenger-videocall-centered";BX.Call.Util.appendChildren(this.elements.userBlock,this.elements.userList.rows);this.elements.container.appendChild(this.elements.center);this.elements.container.appendChild(this.elements.userBlock);this.centralUser.reattachStream()}else if(this.layout==e.Grid){this.elements.root.className="bx-messenger-videocall bx-messenger-videocall-grid bx-messenger-videocall-grid-r-"+this.grid.rows+" bx-messenger-videocall-grid-c-"+this.grid.columns;this.elements.container.removeChild(this.elements.center);this.elements.container.removeChild(this.elements.userBlock);BX.Call.Util.appendChildren(this.elements.container,this.elements.userList.rows)}this.toggleEars()};BX.Call.View.prototype.setCameraState=function(e){e=!!e;if(this.isCameraOn==e){return}this.isCameraOn=e;if(this.buttons.camera){if(this.isCameraOn){this.buttons.camera.enable()}else{this.buttons.camera.disable()}}};BX.Call.View.prototype.setMuted=function(e){e=!!e;if(this.isMuted==e){return}this.isMuted=e;if(this.buttons.microphone){if(this.isMuted){this.buttons.microphone.disable()}else{this.buttons.microphone.enable()}}};BX.Call.View.prototype.addUser=function(e,t){if(this.users[e]){return}this.users[e]=new n({id:e,state:t||BX.Call.UserState.Idle,onClick:this._onUserClick.bind(this)});this.updateUserList();this.updateButtons()};BX.Call.View.prototype.setUserState=function(e,t){var s=this.users[e];if(!s){return}s.setState(t);if(this.centralUser.userId==this.userId&&t==BX.Call.UserState.Connected){this.setCentralUser(e)}else if(e==this.centralUser.userId&&(t==BX.Call.UserState.Idle||t==BX.Call.UserState.Failed)){var i=this.getUsersWithVideo();var n=this.getConnectedUsers();if(i.length>0){this.setCentralUser(i[0])}else if(this.localUser.hasVideo()){this.setCentralUser(this.userId)}else if(n.length>0){this.setCentralUser(n[0])}}this.updateUserList();this.updateButtons()};BX.Call.View.prototype.setTitle=function(e){this.title=e};BX.Call.View.prototype.setUserTalking=function(e,t){var s=this.users[e];if(!s){return}s.setTalking(t)};BX.Call.View.prototype.setLocalStream=function(t){this.localUser.stream=t;this.setCameraState(this.localUser.hasVideo());var s=t.getVideoTracks();if(s.length>0){var i=s[0].getSettings();this.cameraId=i.deviceId||""}else{this.cameraId=""}var n=t.getAudioTracks();if(n.length>0){var r=n[0].getSettings();this.microphoneId=r.deviceId||""}else{this.microphoneId=""}if(this.layout==e.Centered&&this.centralUser.userId==this.userId){this.centralUser.setStream(t)}else{this.updateUserList()}};BX.Call.View.prototype.setStream=function(e,s){if(this.uiState==t.Calling){this.setUiState(t.Connected)}if(!this.users[e]){throw Error("User "+e+" is not a part of this call")}if(!this.elements.audio[e]){this.elements.audio[e]=BX.create("audio");this.elements.audioContainer.appendChild(this.elements.audio[e])}if(s.getAudioTracks().length>0&&s!=this.elements.audio[e].srcObject){this.elements.audio[e].srcObject=s;this.elements.audio[e].play()}this.users[e].stream=s;if(this.users[e].hasVideo()){if(this.centralUser.userId==this.userId){this.setCentralUser(e)}}else{if(this.centralUser.userId==e){var i=this.getUsersWithVideo();if(i.length>0){this.setCentralUser(i[0])}else if(this.localUser.hasVideo()){this.setCentralUser(this.userId)}}}if(this.centralUser.userId==e){this.centralUser.setStream(s)}this.updateUserList()};BX.Call.View.prototype.show=function(){if(!this.elements.root){this.render()}this.container.appendChild(this.elements.root);if(this.layout==e.Centered){this.centralUser.reattachStream()}this.updateButtons();this.updateUserList();this.toggleEars()};BX.Call.View.prototype.hide=function(){BX.remove(this.elements.root)};BX.Call.View.prototype.showFatalError=function(e){if(!this.elements.root){this.render();this.container.appendChild(this.elements.root)}var s=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"}});if(BX.type.isNotEmptyString(e.text)){var i=BX.create("div",{props:{className:"bx-messenger-videocall-status-text"},text:e.text});s.appendChild(i)}if(this.elements.overlay.childElementCount){BX.cleanNode(this.elements.overlay)}this.elements.overlay.appendChild(s);this.setUiState(t.Error)};BX.Call.View.prototype.close=function(){BX.cleanNode(this.container);this.callbacks.onClose()};BX.Call.View.prototype.setSize=function(t){if(this.size==t){return}this.size=t;if(this.size==BX.Call.View.Size.Folded){this.elements.panel.classList.add("bx-messenger-videocall-panel-folded");BX.remove(this.elements.container);this.updateButtons()}else{this.elements.panel.classList.remove("bx-messenger-videocall-panel-folded");this.elements.wrap.appendChild(this.elements.container);if(this.layout==e.Centered){this.centralUser.reattachStream()}this.updateButtons();this.updateUserList()}};BX.Call.View.prototype.toggleFullScreen=function(){if(this.isFullScreen){this.exitFullScreen()}else{this.enterFullScreen()}};BX.Call.View.prototype.isButtonDisabled=function(e){return this.disabledButtons.hasOwnProperty(e)};BX.Call.View.prototype.disableAddUser=function(){this.disabledButtons["add"]=true;if(this.elements.userList.addButton){BX.remove(this.elements.userList.addButton);this.elements.userList.addButton=null}};BX.Call.View.prototype.disableSwitchCamera=function(){this.disabledButtons["camera"]=true};BX.Call.View.prototype.disableSwitchMicrophone=function(){this.disabledButtons["microphone"]=true};BX.Call.View.prototype.disableScreenSharing=function(){this.disabledButtons["screen"]=true};BX.Call.View.prototype.getButtonList=function(){if(this.uiState==t.Error){return["close"]}if(this.size==BX.Call.View.Size.Folded){return["title","hangup","fullscreen"]}var e=[];if(this.uiState===t.Connected){e.push("grid")}if(this.getConnectedUserCount()<this.userLimit-1&&!this.isFullScreen&&this.uiState===t.Connected){e.push("add")}if(false&&!this.isFullScreen){e.push("link")}if(this.uiState===t.Connected){e.push("microphone","camera")}if(this.isScreenSharingSupported()&&!this.isFullScreen&&this.uiState===t.Connected){e.push("screen")}if(this.showChatButtons&&!this.isFullScreen){e.push("chat","history")}e.push("hangup");if(this.isFullScreenSupported()){e.push("fullscreen")}e=e.filter(function(e){return!this.isButtonDisabled(e)},this);return e};BX.Call.View.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall bx-messenger-videocall-centered"},children:[this.elements.wrap=BX.create("div",{props:{className:"bx-messenger-videocall-wrap"},children:[this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-inner"},children:[this.elements.overlay=BX.create("div",{props:{className:"bx-messenger-videocall-overlay"}})]}),this.elements.panel=BX.create("div",{props:{className:"bx-messenger-videocall-panel"}})]})],events:{click:this._onBodyClick.bind(this)}});this.centralUser=new i({parent:this,video:false,stream:false,userId:this.userId,language:this.language});this.elements.center=this.centralUser.render();this.elements.userBlock=BX.create("div",{props:{className:"bx-messenger-videocall-user-block"},children:[this.elements.ear.left=BX.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-left"},events:{mouseenter:this.scrollUserBlockLeft.bind(this),mouseleave:this.stopScroll.bind(this)}}),this.elements.ear.right=BX.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-right"},events:{mouseenter:this.scrollUseBlockRight.bind(this),mouseleave:this.stopScroll.bind(this)}})]});if(this.layout==e.Centered){this.elements.container.appendChild(this.elements.center);this.elements.container.appendChild(this.elements.userBlock)}return this.elements.root};BX.Call.View.prototype.renderUserList=function(){var s=this.elements.root.getBoundingClientRect();var i=this.localUser.hasVideo()&&(this.layout==e.Grid||this.centralUser.userId!=this.userId);var n=[];for(var r in this.users){var l=this.users[r];if(this.layout==e.Centered&&r==this.centralUser.userId){continue}if(l.state==BX.Call.UserState.Idle){continue}n.push(l.render())}if(i){n.push(this.localUser.render())}var a=[];var o=n.length;var c=this.layout==e.Centered?1:BX.Call.Util.findRowCount(s.width,s.height,o);var h=Math.ceil(o/c);var d;for(d=0;d<c;d++){a.push(BX.create("div",{props:{className:"bx-messenger-videocall-user-list"}}))}var u=0;var p=0;for(d=0;d<o;d++){if(p>=h){p=0;u++}a[u].appendChild(n[d]);p++}var m=this.layout==e.Centered&&o>0&&!this.isFullScreen&&this.uiState===t.Connected&&!this.isButtonDisabled("add")&&this.getConnectedUserCount()<this.userLimit-1;if(m){this.elements.userList.addButton=BX.create("div",{props:{className:"bx-messenger-videocall-user-add"},children:[BX.create("div",{props:{className:"bx-messenger-videocall-user-add-inner"}})],events:{click:this._onAddButtonClick.bind(this)}});if(!this.isFullScreen){a[u].appendChild(this.elements.userList.addButton)}}else{this.elements.userList.addButton=null}this.grid.rows=c;this.grid.columns=h;if(this.layout===e.Centered&&a.length===1){a[0].addEventListener("scroll",this.toggleEars.bind(this))}return a};BX.Call.View.prototype.renderButtons=function(e){var t;var s;var i;var n;t=BX.create("div",{props:{className:"bx-messenger-videocall-panel-inner"},children:[s=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}}),i=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}}),n=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}})]});for(var c=0;c<e.length;c++){switch(e[c]){case"title":this.buttons.title=new r({text:this.title,isGroupCall:Object.keys(this.users).length>1});s.appendChild(this.buttons.title.render());break;case"grid":this.buttons.grid=new l({class:"grid",text:BX.message("IM_M_CALL_BTN_GRID"),onClick:this._onGridButtonClick.bind(this)});s.appendChild(this.buttons.grid.render());break;case"add":this.buttons.add=new l({class:"add",text:BX.message("IM_M_CALL_BTN_ADD"),onClick:this._onAddButtonClick.bind(this)});s.appendChild(this.buttons.add.render());break;case"link":this.buttons.link=new l({class:"link",text:BX.message("IM_M_CALL_BTN_LINK"),onClick:this._onLinkButtonClick.bind(this)});s.appendChild(this.buttons.link.render());break;case"microphone":this.buttons.microphone=new o({class:"microphone",text:BX.message("IM_M_CALL_BTN_MIC"),enabled:!this.isMuted,arrowEnabled:this.microphoneList.length>0&&!this.isFullScreen,onClick:this._onMicrophoneButtonClick.bind(this),onArrowClick:this._onMicrophoneArrowClick.bind(this)});i.appendChild(this.buttons.microphone.render());break;case"camera":this.buttons.camera=new o({class:"camera",text:BX.message("IM_M_CALL_BTN_CAMERA"),enabled:this.isCameraOn,arrowEnabled:this.cameraList.length>0&&!this.isFullScreen,onClick:this._onCameraButtonClick.bind(this),onArrowClick:this._onCameraArrowClick.bind(this)});i.appendChild(this.buttons.camera.render());break;case"screen":this.buttons.screen=new l({class:"screen",text:BX.message("IM_M_CALL_BTN_SCREEN"),onClick:this._onScreenButtonClick.bind(this)});i.appendChild(this.buttons.screen.render());break;case"chat":this.buttons.chat=new l({class:"chat",text:BX.message("IM_M_CALL_BTN_CHAT"),onClick:this._onChatButtonClick.bind(this)});i.appendChild(this.buttons.chat.render());break;case"history":this.buttons.history=new l({class:"history",text:BX.message("IM_M_CALL_BTN_HISTORY"),onClick:this._onHistoryButtonClick.bind(this)});i.appendChild(this.buttons.history.render());break;case"hangup":this.buttons.hangup=new a({text:BX.message("IM_M_CALL_BTN_HANGUP"),onClick:this._onHangupButtonClick.bind(this)});n.appendChild(this.buttons.hangup.render());break;case"close":this.buttons.close=new a({text:BX.message("IM_M_CALL_BTN_CLOSE"),onClick:this._onCloseButtonClick.bind(this)});i.appendChild(this.buttons.close.render());break;case"fullscreen":this.buttons.fullscreen=new l({class:"resize",text:"",onClick:this._onFullScreenButtonClick.bind(this)});n.appendChild(this.buttons.fullscreen.render());break}}return t};BX.Call.View.prototype.updateUserList=function(){for(var t=0;t<this.elements.userList.rows.length;t++){BX.remove(this.elements.userList.rows[t])}this.elements.userList.rows=this.renderUserList();if(this.layout==e.Centered){BX.Call.Util.appendChildren(this.elements.userBlock,this.elements.userList.rows);var s=this.elements.userList.rows[0];this.centralUser.setFullSize(s.childElementCount==0)}else if(this.layout==e.Grid){BX.Call.Util.appendChildren(this.elements.container,this.elements.userList.rows);this.elements.root.className="bx-messenger-videocall bx-messenger-videocall-grid bx-messenger-videocall-grid-r-"+this.grid.rows+" bx-messenger-videocall-grid-c-"+this.grid.columns}this.toggleEars()};BX.Call.View.prototype.updateButtons=function(){var e=this.getButtonList();BX.cleanNode(this.elements.panel);this.elements.panel.appendChild(this.renderButtons(e))};BX.Call.View.prototype.isScreenSharingSupported=function(){return typeof BXDesktopSystem!=="undefined"};BX.Call.View.prototype.isFullScreenSupported=function(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){return document.webkitFullscreenEnabled===true}else if(BX.browser.IsFirefox()){return document.mozFullscreenEnabled===true}else{return false}};BX.Call.View.prototype.enterFullScreen=function(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){this.elements.root.webkitRequestFullScreen()}else if(BX.browser.IsFirefox()){this.elements.root.mozRequestFullScreen()}};BX.Call.View.prototype.exitFullScreen=function(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}};BX.Call.View.prototype.toggleEars=function(){this.toggleRightEar();this.toggleLeftEar()};BX.Call.View.prototype.toggleRightEar=function(){if(this.layout==e.Centered&&this.elements.userList.rows.length==1&&this.elements.userList.rows[0].scrollWidth>this.elements.userList.rows[0].offsetWidth&&this.elements.userList.rows[0].offsetWidth+this.elements.userList.rows[0].scrollLeft<this.elements.userList.rows[0].scrollWidth){this.elements.ear.right.classList.add("bx-messenger-videocall-ear-show")}else{this.elements.ear.right.classList.remove("bx-messenger-videocall-ear-show")}};BX.Call.View.prototype.toggleLeftEar=function(){if(this.layout==e.Centered&&this.elements.userList.rows.length==1&&this.elements.userList.rows[0].scrollLeft>0){this.elements.ear.left.classList.add("bx-messenger-videocall-ear-show")}else{this.elements.ear.left.classList.remove("bx-messenger-videocall-ear-show")}};BX.Call.View.prototype.scrollUserBlockLeft=function(){this.stopScroll();this.scrollInterval=setInterval(function(){this.elements.userList.rows[0].scrollLeft-=10}.bind(this),20)};BX.Call.View.prototype.scrollUseBlockRight=function(){this.stopScroll();this.scrollInterval=setInterval(function(){this.elements.userList.rows[0].scrollLeft+=10}.bind(this),20)};BX.Call.View.prototype.stopScroll=function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=0}};BX.Call.View.prototype._onBodyClick=function(e){this.callbacks.onBodyClick()};BX.Call.View.prototype._onFullScreenChange=function(e){if(BX.browser.IsChrome()||BX.browser.IsSafari()){this.isFullScreen=document.webkitFullscreenElement==this.elements.root}else if(BX.browser.IsFirefox()){this.isFullScreen=document.mozFullscreenElement==this.elements.root}if(this.isFullScreen){if(this.elements.userList.addButton){BX.remove(this.elements.userList.addButton)}}else{if(this.elements.userList.addButton){this.elements.userList.rows[this.elements.userList.rows.length-1].appendChild(this.elements.userList.addButton)}}this.updateButtons()};BX.Call.View.prototype._onResize=function(){if(this.centralUser){this.centralUser.updateAvatarWidth()}this.toggleEars()};BX.Call.View.prototype._onUserClick=function(t){var s=t.userId;if(s==this.userId){return}this.setCentralUser(s);if(this.layout==e.Grid){this.setLayout(e.Centered)}};BX.Call.View.prototype._onGridButtonClick=function(t){this.setLayout(this.layout==e.Centered?e.Grid:e.Centered)};BX.Call.View.prototype._onAddButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"inviteUser",node:e.currentTarget})};BX.Call.View.prototype._onLinkButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"settings",node:e.currentTarget})};BX.Call.View.prototype._onMicrophoneButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"toggleMute",muted:!this.isMuted})};BX.Call.View.prototype._onMicrophoneArrowClick=function(e){e.stopPropagation();if(this.microphoneList.length===0){return}c.create({parentElement:e.currentTarget,deviceList:this.microphoneList,current:this.microphoneId,onSelect:this._onMicrophoneSelected.bind(this)}).show()};BX.Call.View.prototype._onMicrophoneSelected=function(e){if(e.deviceId===this.microphoneId){return}this.callbacks.onReplaceMicrophone(e)};BX.Call.View.prototype._onCameraButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"toggleVideo",video:!this.isCameraOn})};BX.Call.View.prototype._onCameraArrowClick=function(e){e.stopPropagation();if(this.cameraList.length===0){return}c.create({parentElement:e.currentTarget,deviceList:this.cameraList,current:this.cameraId,onSelect:this._onCameraSelected.bind(this)}).show()};BX.Call.View.prototype._onCameraSelected=function(e){if(e.deviceId===this.cameraId){return}this.callbacks.onReplaceCamera(e)};BX.Call.View.prototype._onScreenButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"toggleScreenSharing",node:e.target})};BX.Call.View.prototype._onChatButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"showChat",node:e.target})};BX.Call.View.prototype._onHistoryButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"showHistory",node:e.target})};BX.Call.View.prototype._onHangupButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"hangup",node:e.target})};BX.Call.View.prototype._onCloseButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"close",node:e.target})};BX.Call.View.prototype._onFullScreenButtonClick=function(e){e.stopPropagation();this.callbacks.onButtonClick({buttonName:"fullscreen",node:e.target})};BX.Call.View.prototype.destroy=function(){if(this.elements.root){BX.cleanNode(this.elements.root,true);this.elements.root=null}window.removeEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("mozfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("resize",this._onResizeHandler);for(var e in this.users){if(this.users.hasOwnProperty(e)){this.users[e].destroy()}}this.centralUser.destroy();this.callbacks.onDestroy()};var i=function(e){this.parent=e.parent;this.stream=e.stream||null;this.userId=e.userId;this.language=e.language;this.hasVideo=false;this.elements={container:null,inner:null,watermark:null,video:null,user:null,userBlock:null,avatar:null,nameBlock:null,name:null};this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500)};i.prototype.getWatermarkUrl=function(e){switch(e){case"ua":return"/bitrix/js/im/images/watermark-white-ua.svg";case"ru":case"kz":case"by":return"/bitrix/js/im/images/watermark-white-ru.svg";default:return"/bitrix/js/im/images/watermark-white-en.svg"}};i.prototype.render=function(){this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-video-block"},children:[this.elements.watermark=BX.create("div",{props:{className:"bx-messenger-videocall-watermark"},children:[BX.create("img",{props:{className:"bx-messenger-videocall-watermark-img",src:this.getWatermarkUrl(this.language)}})]})]});this.elements.video=BX.create("video",{props:{className:"bx-messenger-videocall-video",autoplay:true,volume:0}});this.elements.user=BX.create("div",{props:{className:"bx-messenger-audiocall"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-wrap"},children:[this.elements.inner=BX.create("div",{props:{className:"bx-messenger-audiocall-inner"},children:[this.elements.userBlock=BX.create("div",{props:{className:"bx-messenger-audiocall-user-block"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-user-block-inner"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-user"},children:[this.elements.avatar=BX.create("div",{props:{className:"bx-messenger-audiocall-user-item"}})]})]})]}),this.elements.nameBlock=BX.create("div",{props:{className:"bx-messenger-audiocall-user-name"},children:[this.elements.name=BX.create("span",{props:{className:"bx-messenger-audiocall-user-link"}})]})]})]})]});if(this.stream&&BX.Call.Util.containsVideoTrack(this.stream)){this.elements.container.appendChild(this.elements.video);this.elements.container.classList.remove("bx-messenger-videocall-audio")}else{if(this.userId!=this.parent.userId){this.elements.container.classList.add("bx-messenger-videocall-audio")}}this.updateUserInfo();return this.elements.container};i.prototype.updateUserInfo=function(){var e=this;BX.Call.Util.getUserName(this.userId).then(function(t){e.elements.name.innerText=t;return BX.Call.Util.getUserAvatar(e.userId)}).then(function(t){if(t!=""){e.elements.avatar.style.backgroundImage="url("+t+")"}else{e.elements.avatar.style.removeProperty("background-image")}})};i.prototype.updateAvatarWidth=function(){this.elements.userBlock.style.maxWidth=this.elements.inner.offsetHeight-this.elements.nameBlock.offsetHeight+"px"};i.prototype.setUserId=function(e){if(this.userId==e){return}if(e==this.parent.userId){this.setStream(this.parent.localUser.stream)}else{this.setStream(this.parent.users[e].stream)}this.userId=e;this.updateUserInfo()};i.prototype.setStream=function(e){this.stream=e;var t=BX.Call.Util.containsVideoTrack(e);if(this.hasVideo&&!t){BX.remove(this.elements.video);this.elements.container.appendChild(this.elements.user);this.elements.container.classList.add("bx-messenger-videocall-audio");this.updateAvatarWidth()}else if(!this.hasVideo&&t){BX.remove(this.elements.user);this.elements.container.appendChild(this.elements.video);this.elements.container.classList.remove("bx-messenger-videocall-audio")}this.hasVideo=t;if(this.hasVideo){this.elements.video.srcObject=e}};i.prototype.reattachStream=function(){if(this.hasVideo){this.elements.video.srcObject=this.stream}};i.prototype.setFullSize=function(e){if(e){this.elements.container.classList.add("bx-messenger-videocall-video-block-full")}else{this.elements.container.classList.remove("bx-messenger-videocall-video-block-full")}this.updateAvatarWidth()};i.prototype.isVideo=function(){};i.prototype.checkVideoAspect=function(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}};i.prototype.destroy=function(){this.stream=null;clearInterval(this.checkAspectInterval)};var n=function(e){this.id=e.id;this.name="";this.avatar="";this.state=e.state;this.stream=e.stream;this.talking=false;this.localUser=e.localUser===true;this.hidden=false;this.elements={root:null,container:null,video:null,avatar:null,nameContainer:null,name:null,overlay:null,state:null,removeButton:null};this.callBacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing};this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500)};n.prototype.render=function(){var e=this;this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-user"},dataset:{userId:this.id},children:[this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-user-inner"}})],events:{click:function(e){e.stopPropagation();this.callBacks.onClick({userId:this.id})}.bind(this)}});if(this.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}if(this.localUser){this.elements.root.classList.add("bx-messenger-videocall-user-self")}this.elements.avatar=BX.create("div",{props:{className:"bx-message-videocall-user-avatar"}});BX.Call.Util.getUserAvatar(this.id).then(function(t){if(t!=""){e.elements.avatar.style.backgroundImage="url("+t+")"}else{e.elements.avatar.style.removeProperty("background-image")}});if(!this.hasVideo()){this.elements.container.appendChild(this.elements.avatar)}this.elements.video=BX.create("video",{props:{className:"bx-messenger-videocall-video",volume:0,autoplay:true}});if(this.stream&&this.stream.active){this.elements.video.srcObject=this.stream}this.elements.container.appendChild(this.elements.video);this.elements.overlay=BX.create("div",{props:{className:"bx-messenger-videocall-overlay"}});this.elements.container.appendChild(this.elements.overlay);this.elements.state=this.renderState();if(this.elements.state){this.elements.overlay.appendChild(this.elements.state)}this.elements.nameContainer=BX.create("div",{props:{className:"bx-messenger-videocall-user-name"},children:[this.elements.name=BX.create("span",{props:{className:"bx-messenger-videocall-user-text"},text:name}),BX.create("div",{props:{className:"bx-messenger-videocall-user-shadow"}})]});this.elements.container.appendChild(this.elements.nameContainer);BX.Call.Util.getUserName(this.id).then(function(t){if(t!=""){e.elements.name.innerText=t}});return this.elements.root};n.prototype.renderState=function(){var e;switch(this.state){case BX.Call.UserState.Idle:break;case BX.Call.UserState.Calling:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_WAIT_ANSWER")})]});break;case BX.Call.UserState.Declined:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-cross"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_DECLINED")})]});break;case BX.Call.UserState.Ready:case BX.Call.UserState.Connecting:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_WAIT_CONNECT")})]});break;case BX.Call.UserState.Connected:break;case BX.Call.UserState.Failed:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-cross"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_CONNECTION_ERROR")})]});break}return e?e:null};n.prototype.setState=function(e){if(this.state==e){return}this.state=e;if(!this.elements.root){return}if(this.elements.state){BX.cleanNode(this.elements.overlay);this.elements.state=null}this.elements.state=this.renderState();if(this.elements.state){this.elements.overlay.appendChild(this.elements.state)}};n.prototype.setTalking=function(e){if(this.talking==e){return}this.talking=e;if(!this.elements.root){return}if(this.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}else{this.elements.root.classList.remove("bx-messenger-videocall-user-talking")}};n.prototype.hide=function(){if(!this.elements.root){return}this.elements.root.dataset.hidden=1};n.prototype.show=function(){if(!this.elements.root){return}delete this.elements.root.dataset.hidden};n.prototype.hasVideo=function(){return this.state==BX.Call.UserState.Connected&&BX.Call.Util.containsVideoTrack(this.stream)};n.prototype.checkVideoAspect=function(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}};n.prototype.destroy=function(){this.stream=null;clearInterval(this.checkAspectInterval)};var r=function(e){this.elements={root:null};this.text=BX.type.isNotEmptyString(e.text)?e.text:"";this.isGroupCall=e.isGroupCall};r.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-title"},html:this.getTitle(this.text)});return this.elements.root};r.prototype.getTitle=function(e){var t='<span class="bx-messenger-videocall-panel-title-name">'+BX.util.htmlspecialchars(this.text)+"</span>";if(this.isGroupCall){return BX.message("IM_M_GROUP_CALL_WITH").replace("#CHAT_NAME#",t)}else{return BX.message("IM_M_CALL_WITH").replace("#USER_NAME#",t)}};var l=function(e){this.class=e.class;this.text=BX.type.isNotEmptyString(e.text)?e.text:"";this.elements={root:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing}};l.prototype.render=function(){if(this.elements.root){return this.elements.root}var e;if(this.text!==""){e=BX.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})}else{e=null}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item"},children:[BX.create("div",{props:{className:"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-"+this.class}}),e],events:{click:this.callbacks.onClick}});return this.elements.root};var a=function(e){this.text=e.text;this.elements={root:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing}};a.prototype.render=function(){if(this.elements.root){return this.elements.root}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item bx-messenger-videocall-panel-item-btn"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-round bx-messenger-videocall-panel-btn ui-btn-icon-phone-down"},text:this.text})],events:{click:this.callbacks.onClick}});return this.elements.root};var o=function(e){this.class=e.class;this.text=e.text;this.enabled=e.enabled==true;this.arrowEnabled=e.arrowEnabled==true;this.elements={root:null,icon:null,arrow:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing,onArrowClick:BX.type.isFunction(e.onArrowClick)?e.onArrowClick:BX.DoNothing}};o.prototype.render=function(){if(this.elements.root){return this.elements.root}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item"},children:[this.elements.icon=BX.create("div",{props:{className:this.getIconClass()}}),BX.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})],events:{click:this.callbacks.onClick}});this.elements.arrow=BX.create("div",{props:{className:"bx-messenger-videocall-panel-arrow"},events:{click:function(e){this.callbacks.onArrowClick.apply(this,arguments);e.stopPropagation()}.bind(this)}});if(this.arrowEnabled){this.elements.icon.appendChild(this.elements.arrow)}return this.elements.root};o.prototype.getIconClass=function(){return"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-"+this.class+(this.enabled?"":"-off")};o.prototype.enable=function(){if(this.enabled){return}this.enabled=true;this.elements.icon.className=this.getIconClass()};o.prototype.disable=function(){if(!this.enabled){return}this.enabled=false;this.elements.icon.className=this.getIconClass()};o.prototype.showArrow=function(){if(this.arrowEnabled){return}this.arrowEnabled=true;this.elements.icon.appendChild(this.elements.arrow)};o.prototype.hideArrow=function(){if(!this.arrowEnabled){return}this.arrowEnabled=false;this.elements.icon.removeChild(this.elements.arrow)};var c=function(e){this.deviceList=e.deviceList;this.current=e.current;this.parentElement=e.parentElement;this.menu=null;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing}};c.create=function(e){return new c(e)};c.prototype.show=function(){var e=this;var t=[];this.deviceList.forEach(function(s){t.push({id:s.deviceId,text:s.label||"("+BX.message("IM_M_CALL_DEVICE_NO_NAME")+")",className:e.current==s.deviceId?"menu-popup-item-accept":"device-selector-empty",onclick:function(){e.menu.close();e.callbacks.onSelect(s)}})});this.menu=BX.PopupMenu.create("call-view-select-device",this.parentElement,t,{autoHide:true,zIndex:s+500,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"top"},angle:{position:"bottom"},overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){e.menu.popupWindow.destroy();BX.PopupMenu.destroy("call-view-select-device")},onPopupDestroy:function(){e.menu=null}}});this.menu.popupWindow.show()};BX.Call.View.Size={Folded:"folded",Full:"full"}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:56:"/bitrix/js/im/v1/call/notification.min.js?15577564046006";s:6:"source";s:37:"/bitrix/js/im/v1/call/notification.js";s:3:"min";s:41:"/bitrix/js/im/v1/call/notification.min.js";s:3:"map";s:41:"/bitrix/js/im/v1/call/notification.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Notification){return}var t={onButtonClick:"CallNotification::onButtonClick"};BX.Call.Notification=function(o){this.popup=null;this.window=null;this.callerAvatar=BX.type.isNotEmptyString(o.callerAvatar)?o.callerAvatar:"";if(this.callerAvatar=="/bitrix/js/im/images/blank.gif"){this.callerAvatar=""}this.callerName=o.callerName;this.video=o.video;this.hasCamera=o.hasCamera==true;this.callbacks={onClose:BX.type.isFunction(o.onClose)?o.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(o.onDestroy)?o.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(o.onButtonClick)?o.onButtonClick:BX.DoNothing};this._onContentButtonClickHandler=this._onContentButtonClick.bind(this);if(BX.desktop){BX.desktop.addCustomEvent(t.onButtonClick,this._onContentButtonClickHandler)}};BX.Call.Notification.prototype.show=function(){if(BX.desktop){var t={video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.callNotification = new BX.Call.NotificationContent("+JSON.stringify(t)+"); window.callNotification.showInDesktop();"))}}else{this.content=new BX.Call.NotificationContent({video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName,onClose:this.callbacks.onClose,onDestroy:this.callbacks.onDestroy,onButtonClick:this.callbacks.onButtonClick});this.createPopup(this.content.render());this.popup.show()}};BX.Call.Notification.prototype.createPopup=function(t){this.popup=new BX.PopupWindow("bx-messenger-call-notify",null,{content:t,closeIcon:false,noAllPaddings:true,zIndex:1200,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){this.callbacks.onClose()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)}})};BX.Call.Notification.prototype.close=function(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.callbacks.onClose()};BX.Call.Notification.prototype.destroy=function(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(BX.desktop){BX.desktop.removeCustomEvents(t.onButtonClick)}};BX.Call.Notification.prototype._onContentButtonClick=function(t){this.callbacks.onButtonClick(t)};BX.Call.NotificationContent=function(t){this.video=t.video;this.hasCamera=t.hasCamera;this.callerAvatar=t.callerAvatar;this.callerName=t.callerName;this.elements={root:null,avatar:null};this.callbacks={onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing}};BX.Call.NotificationContent.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-call-window"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-body"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-left"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-block"},children:[this.elements.avatar=BX.create("img",{props:{className:"bx-messenger-call-window-overlay-photo-img",src:this.callerAvatar||"/bitrix/js/im/images/hidef-avatar-v3.png"},style:{backgroundColor:"#df532d"}})]})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-info"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title-block"},children:[document.createTextNode(this.video?BX.message("IM_M_VIDEO_CALL_FROM"):BX.message("IM_M_CALL_FROM")),BX.create("span",{props:{className:"bx-messenger-call-overlay-title-caller"},text:BX.util.htmlspecialchars(this.callerName)})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-primary-dark ui-btn-icon-camera bx-messenger-call-window-button"+(!this.hasCamera?" ui-btn-disabled":"")},text:BX.message("IM_M_CALL_BTN_ANSWER_VIDEO"),events:{click:this._onAnswerWithVideoButtonClick.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-primary-dark ui-btn-icon-phone-up bx-messenger-call-window-button"},text:BX.message("IM_M_CALL_BTN_ANSWER"),events:{click:this._onAnswerButtonClick.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-danger-dark ui-btn-icon-phone-down"},text:BX.message("IM_M_CALL_BTN_DECLINE"),events:{click:this._onDeclineButtonClick.bind(this)}})]})]})]})]})]});return this.elements.root};BX.Call.NotificationContent.prototype.showInDesktop=function(){this.render();document.body.appendChild(this.elements.root);BX.desktop.setWindowPosition({X:STP_CENTER,Y:STP_VCENTER,Width:635,Height:125})};BX.Call.NotificationContent.prototype._onAnswerButtonClick=function(o){if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"answer",video:false}])}else{this.callbacks.onButtonClick({button:"answer",video:false})}};BX.Call.NotificationContent.prototype._onAnswerWithVideoButtonClick=function(o){if(!this.hasCamera){return}if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"answer",video:true}])}else{this.callbacks.onButtonClick({button:"answer",video:true})}};BX.Call.NotificationContent.prototype._onDeclineButtonClick=function(o){if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"decline"}])}else{this.callbacks.onButtonClick({button:"decline"})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:56:"/bitrix/js/im/v1/call/invite_popup.min.js?15577564048105";s:6:"source";s:37:"/bitrix/js/im/v1/call/invite_popup.js";s:3:"min";s:41:"/bitrix/js/im/v1/call/invite_popup.min.js";s:3:"map";s:41:"/bitrix/js/im/v1/call/invite_popup.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.InvitePopup){return}BX.Call.InvitePopup=function(e){if(!BX.type.isPlainObject(e)){e={}}this.idleUsers=e.idleUsers||[];this.recentUsers=[];this.bindElement=e.bindElement;this.allowNewUsers=e.allowNewUsers;this.elements={root:null,inputBox:null,input:null,destinationContainer:null,contactList:null,moreButton:null};this.popup=null;this.zIndex=e.zIndex||0;this.searchPhrase="";this.searchNext=0;this.searchResult=[];this.searchTotalCount=0;this.searchTimeout=0;this.fetching=false;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing,onClose:BX.type.isFunction(e.onClose)?e.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing}};BX.Call.InvitePopup.prototype={show:function(){if(!this.elements.root){this.render()}this.createPopup();this.popup.show();if(this.allowNewUsers){this.showLoader();this.getRecent().then(this.updateContactList.bind(this))}else{this.updateContactList()}},close:function(){if(this.popup){this.popup.close()}},createPopup:function(){var e=this;this.popup=new BX.PopupWindow("bx-call-popup-invite",this.bindElement,{zIndex:this.zIndex,lightShadow:true,autoHide:true,closeByEsc:true,content:this.elements.root,bindOptions:{position:"top"},angle:{position:"bottom",offset:49},buttons:[new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_INVITE"),className:"popup-window-button-accept",events:{click:function(e){if(this.selectedUser){this.callbacks.onSelect({user:this.selectedUser})}}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_CANCEL"),events:{click:function(){e.popup.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){e.popup=null;e.elements.contactList=null;e.callbacks.onDestroy()}}})},getRecent:function(){var e=this;return new Promise(function(t,s){BX.rest.callMethod("im.recent.get",{SKIP_OPENLINES:"Y",SKIP_CHAT:"Y"}).then(function(s){var n=s.answer;e.recentUsers=Object.values(n.result).map(function(e){return e.user});t()})})},search:function(){var e=this;return new Promise(function(t,s){e.searchResult=[];e.searchNext=0;e.searchTotalCount=0;BX.rest.callMethod("im.search.user.list",{FIND:e.searchPhrase}).then(function(s){var n=s.answer;e.searchTotalCount=n.total;e.searchNext=n.next;e.searchResult=e.searchResult.concat(Object.values(n.result));t()})})},fetchMoreSearchResults:function(){var e=this;return new Promise(function(t,s){BX.rest.callMethod("im.search.user.list",{FIND:e.searchPhrase,OFFSET:e.searchNext}).then(function(s){var n=s.answer;e.searchTotalCount=n.total;e.searchNext=n.next;var i=Object.values(n.result);e.searchResult=e.searchResult.concat(i);t(i)})})},render:function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-popup-newchat-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},text:BX.message("IM_CALL_INVITE_INVITE_USER")})]});this.elements.inputBox=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"},children:[this.elements.destinationContainer=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.elements.input=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:this.allowNewUsers?BX.message("IM_M_SEARCH_PLACEHOLDER"):BX.message("IM_M_CALL_REINVITE_PLACEHOLDER"),value:"",disabled:!this.allowNewUsers},events:{keyup:this._onInputKeyUp.bind(this)}})]});this.elements.root.appendChild(this.elements.inputBox);this.elements.contactList=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:[]});this.elements.root.appendChild(this.elements.contactList)},updateDestination:function(){if(!this.elements.inputBox){return}BX.cleanNode(this.elements.destinationContainer);if(this.selectedUser){this.elements.destinationContainer.appendChild(this.renderDestinationUser(this.selectedUser));this.elements.input.style.display="none"}else{this.elements.input.style.removeProperty("display");this.elements.input.focus()}},updateContactList:function(){BX.cleanNode(this.elements.contactList);this.elements.contactList.appendChild(this.renderContactList())},showLoader:function(){BX.cleanNode(this.elements.contactList);this.elements.contactList.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-load"},text:BX.message("IM_CL_LOAD")}))},renderContactList:function(){var e=document.createDocumentFragment();var t;if(this.idleUsers.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_CALL_PARTICIPANTS")));for(t=0;t<this.idleUsers.length;t++){e.appendChild(this.renderUser(this.idleUsers[t]))}}if(this.searchPhrase!=""){if(this.searchResult.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_SEARCH_RESULTS")));for(t=0;t<this.searchResult.length;t++){e.appendChild(this.renderUser(this.searchResult[t]))}if(this.searchTotalCount>this.searchResult.length){this.elements.moreButton=this.renderMoreButton();e.appendChild(this.elements.moreButton)}}else{}}else if(this.recentUsers.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_RECENT")));for(t=0;t<this.recentUsers.length;t++){e.appendChild(this.renderUser(this.recentUsers[t]))}}return e},renderSeparator:function(e){return BX.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[BX.create("span",{props:{className:"bx-messenger-chatlist-group-title"},text:e})]})},renderUser:function(e){var t=e.work_position;var s;var n=BX.create("span",{props:{className:"bx-messenger-cl-item"},dataset:{id:e.id,name:e.name,status:e.status,avatar:e.avatar},events:{click:function(t){this.setSelectedUser(e)}.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-cl-avatar"},children:[s=BX.create("img",{props:{className:"bx-messenger-cl-avatar-img bx-messenger-cl-avatar-img-default"},style:{backgroundColor:e.color}}),BX.create("span",{props:{className:"bx-messenger-cl-status"}})]}),BX.create("span",{props:{className:"bx-messenger-cl-user"},children:[BX.create("div",{props:{className:"bx-messenger-cl-user-title"},text:e.name}),BX.create("div",{props:{className:"bx-messenger-cl-user-desc"},text:t})]})]});if(e.avatar){s.src=e.avatar}return n},renderDestinationUser:function(e){return BX.create("span",{props:{className:"bx-messenger-dest-block"},children:[BX.create("span",{props:{className:"bx-messenger-dest-text"},text:e.name}),BX.create("span",{props:{className:"bx-messenger-dest-del"},events:{click:this.removeSelectedUser.bind(this)}})]})},renderMoreButton:function(){return BX.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},events:{click:this._onMoreButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-chatlist-more"},text:BX.message("IM_CALL_INVITE_MORE")+" "+(this.searchTotalCount-this.searchResult.length)})]})},setSelectedUser:function(e){this.selectedUser=e;this.updateDestination()},removeSelectedUser:function(){this.selectedUser=null;this.updateDestination()},_onMoreButtonClick:function(){if(this.fetching){return}this.fetching=true;this.fetchMoreSearchResults().then(function(e){var t=document.createDocumentFragment();var s=null;for(var n=0;n<e.length;n++){t.appendChild(this.renderUser(e[n]))}if(this.searchTotalCount>this.searchResult.length){s=this.renderMoreButton();t.appendChild(s)}BX.replace(this.elements.moreButton,t);this.elements.moreButton=s;this.fetching=false}.bind(this))},_onInputKeyUp:function(e){var t=this;if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91){return false}if(e.keyCode==27&&this.elements.input.value!==""){BX.MessengerCommon.preventDefault(e)}if(e.keyCode==27){this.elements.input.value=""}if(this.searchTimeout){clearTimeout(this.searchTimeout)}this.searchTimeout=setTimeout(function(){t.searchPhrase=t.elements.input.value;if(t.searchPhrase==""){t.updateContactList()}else{t.search().then(function(){t.updateContactList()})}},300)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:58:"/bitrix/js/im/v1/call/floating_video.min.js?15577564048584";s:6:"source";s:39:"/bitrix/js/im/v1/call/floating_video.js";s:3:"min";s:43:"/bitrix/js/im/v1/call/floating_video.min.js";s:3:"map";s:43:"/bitrix/js/im/v1/call/floating_video.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.FloatingVideo){return}var t={setStream:"FloatingVideo::setStream",setAudioMuted:"FloatingVideo::setAudioMuted",onMainAreaClick:"FloatingVideo::onMainAreaClick",onMicButtonClick:"FloatingVideo::onMicButtonClick",onHangupButtonClick:"FloatingVideo::onHangupButtonClick"};var e=320;var s=180;var i=320;var n=70;BX.Call.FloatingVideo=function(t){if(typeof t!=="object"){t={}}this.stream=t.stream&&BX.Call.Util.containsVideoTrack(t.stream)?URL.createObjectURL(t.stream):null;this.audioMuted=t.audioMuted||false;this.window=null;this.visible=false;this.callbacks={onMainAreaClick:BX.type.isFunction(t.onMainAreaClick)?t.onMainAreaClick:BX.DoNothing,onButtonClick:BX.type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing};this._onContentMainAreaClickHandler=this._onContentMainAreaClick.bind(this);this._onContentMicButtonClickHandler=this._onContentMicButtonClick.bind(this);this._onContentHangupButtonClickHandler=this._onContentHangupButtonClick.bind(this);this.bindEventHandlers()};BX.Call.FloatingVideo.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(t.onMainAreaClick,this._onContentMainAreaClickHandler);BX.desktop.addCustomEvent(t.onMicButtonClick,this._onContentMicButtonClickHandler);BX.desktop.addCustomEvent(t.onHangupButtonClick,this._onContentHangupButtonClickHandler)},_onContentMainAreaClick:function(){this.callbacks.onMainAreaClick()},_onContentMicButtonClick:function(){this.callbacks.onButtonClick({buttonName:"toggleMute",muted:!this.audioMuted})},_onContentHangupButtonClick:function(){this.callbacks.onButtonClick({buttonName:"hangup"})},setStream:function(e){if(BX.Call.Util.containsVideoTrack(e)){this.stream=URL.createObjectURL(e)}else{this.stream=null}if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,t.setStream,[this.stream])}},setAudioMuted:function(e){if(this.audioMuted==e){return}this.audioMuted=e;if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,t.setAudioMuted,[this.audioMuted])}},show:function(){if(!BX.desktop){return}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show");BX.desktop.onCustomEvent(this.window,t.setAudioMuted,[this.audioMuted]);BX.desktop.onCustomEvent(this.window,t.setStream,[this.stream])}else{var e={stream:this.stream,audioMuted:this.audioMuted};this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.FVC = new BX.Call.FloatingVideoContent("+JSON.stringify(e)+");"))}this.visible=true},hide:function(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("hide");this.visible=false},close:function(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null;this.visible=false},destroy:function(){if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}this.stream=null;BX.desktop.removeCustomEvents(t.onMainAreaClick);BX.desktop.removeCustomEvents(t.onMicButtonClick);BX.desktop.removeCustomEvents(t.onHangupButtonClick)}};BX.Call.FloatingVideoContent=function(t){this.stream=t.stream;this.audioMuted=t.audioMuted;this.elements={container:null,video:null,micButton:null,micButtonText:null,hangupButton:null};this.render();this.adjustWindow();this.bindEventHandlers();this.callAspectHorizontal=true;if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}};BX.Call.FloatingVideoContent.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(t.setStream,this.setStream.bind(this));BX.desktop.addCustomEvent(t.setAudioMuted,this.setAudioMuted.bind(this));window.addEventListener("beforeunload",this.destroy.bind(this))},render:function(){var t=this.stream?e:i;var o=this.stream?s:n;var a={width:t+"px",height:o+"px"};this.elements.container=BX.create("div",{props:{className:"bx-messenger-call-float"+(this.stream?"":" bx-messenger-call-float-audio")},style:a,events:{click:this.onMainAreaClick.bind(this)},children:[BX.create("div",{props:{className:"bx-messenger-call-float-audio-unfold"},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_UNFOLD")})]}),BX.create("div",{props:{className:"bx-messenger-call-float-buttons"},children:[this.elements.micButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-mic"+(this.audioMuted?" bx-messenger-call-float-button-mic-disabled":"")},events:{click:this.onMicButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),this.elements.micButtonText=BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_"+(this.audioMuted?"OFF":"ON"))})]}),this.elements.hangupButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-decline"},events:{click:this.onHangupButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_HANGUP")})]})]})]});this.elements.video=BX.create("video",{attrs:{autoplay:true,src:this.stream},props:{className:"bx-messenger-call-float-video",volume:0}});if(this.stream){BX.prepend(this.elements.video,this.elements.container)}document.body.appendChild(this.elements.container)},adjustWindow:function(){var t=this.stream?e:i;var o=this.stream?s:n;BX.desktop.setWindowMinSize({Width:t,Height:o});BX.desktop.setWindowResizable(false);BX.desktop.setWindowClosable(false);BX.desktop.setWindowResizable(false);BX.desktop.setWindowTitle("");if(BXDesktopSystem.QuerySettings("global_topmost_x",null)){BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:t,Height:o,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:t,Height:o,Mode:STP_FRONT})}else{BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:t,Height:o,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:t,Height:o,Mode:STP_FRONT})}},checkVideoAspect:function(){if(this.elements.video.videoWidth<this.elements.video.videoHeight){if(this.callAspectHorizontal){this.callAspectHorizontal=false;BX.addClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:s,Height:e})}}else{if(!this.callAspectHorizontal){this.callAspectHorizontal=true;BX.removeClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:e,Height:s})}}},setStream:function(t){clearInterval(this.callAspectCheckInterval);this.stream=t;var o=this.stream?e:i;var a=this.stream?s:n;var l={width:o+"px",height:a+"px"};if(this.elements.container){if(this.stream){if(!this.elements.video.parentNode){BX.prepend(this.elements.video,this.elements.container);BX.removeClass(this.elements.container,"bx-messenger-call-float-audio")}this.elements.video.src=this.stream}else{BX.remove(this.elements.video);BX.addClass(this.elements.container,"bx-messenger-call-float-audio")}BX.adjust(this.elements.container,{style:l})}if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}this.adjustWindow()},setAudioMuted:function(t){this.audioMuted=t;if(this.audioMuted){BX.addClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_OFF")})}else{BX.removeClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_ON")})}},onMainAreaClick:function(e){BX.desktop.onCustomEvent("main",t.onMainAreaClick,[]);e.stopPropagation()},onMicButtonClick:function(e){BX.desktop.onCustomEvent("main",t.onMicButtonClick,[this.audioMuted]);e.stopPropagation()},onHangupButtonClick:function(e){BX.desktop.onCustomEvent("main",t.onHangupButtonClick,[]);e.stopPropagation()},destroy:function(){this.stream=null;BX.desktop.removeCustomEvents(t.setStream);BX.desktop.removeCustomEvents(t.setAudioMuted)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:60:"/bitrix/js/pull/protobuf/protobuf.min.min.js?155775644220692";s:6:"source";s:40:"/bitrix/js/pull/protobuf/protobuf.min.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
!function(t,r){"use strict";!function(r,e,n){function i(t){var n=e[t];return n||r[t][0].call(n=e[t]={exports:{}},i,n,n.exports),n.exports}var o=t.protobuf=i(n[0]);"function"==typeof define&&define.amd&&define(["long"],function(t){return t&&t.isLong&&(o.util.Long=t,o.configure()),o}),"object"==typeof module&&module&&module.exports&&(module.exports=o)}({1:[function(t,r){function e(t,r){for(var e=Array(arguments.length-1),n=0,i=2,o=!0;i<arguments.length;)e[n++]=arguments[i++];return new Promise(function(i,s){e[n]=function(t){if(o)if(o=!1,t)s(t);else{for(var r=Array(arguments.length-1),e=0;e<r.length;)r[e++]=arguments[e];i.apply(null,r)}};try{t.apply(r||null,e)}catch(t){o&&(o=!1,s(t))}})}r.exports=e},{}],2:[function(t,e,n){var i=n;i.length=function(t){var r=t.length;if(!r)return 0;for(var e=0;--r%4>1&&"="===t.charAt(r);)++e;return Math.ceil(3*t.length)/4-e};for(var o=Array(64),s=Array(123),u=0;u<64;)s[o[u]=u<26?u+65:u<52?u+71:u<62?u-4:u-59|43]=u++;i.encode=function(t,r,e){for(var n,i=null,s=[],u=0,f=0;r<e;){var h=t[r++];switch(f){case 0:s[u++]=o[h>>2],n=(3&h)<<4,f=1;break;case 1:s[u++]=o[n|h>>4],n=(15&h)<<2,f=2;break;case 2:s[u++]=o[n|h>>6],s[u++]=o[63&h],f=0}u>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),u=0)}return f&&(s[u++]=o[n],s[u++]=61,1===f&&(s[u++]=61)),i?(u&&i.push(String.fromCharCode.apply(String,s.slice(0,u))),i.join("")):String.fromCharCode.apply(String,s.slice(0,u))};i.decode=function(t,e,n){for(var i,o=n,u=0,f=0;f<t.length;){var h=t.charCodeAt(f++);if(61===h&&u>1)break;if((h=s[h])===r)throw Error("invalid encoding");switch(u){case 0:i=h,u=1;break;case 1:e[n++]=i<<2|(48&h)>>4,i=h,u=2;break;case 2:e[n++]=(15&i)<<4|(60&h)>>2,i=h,u=3;break;case 3:e[n++]=(3&i)<<6|h,u=0}}if(1===u)throw Error("invalid encoding");return n-o},i.test=function(t){return/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(t)}},{}],3:[function(t,e){function n(){this.a={}}e.exports=n,n.prototype.on=function(t,r,e){return(this.a[t]||(this.a[t]=[])).push({fn:r,ctx:e||this}),this},n.prototype.off=function(t,e){if(t===r)this.a={};else if(e===r)this.a[t]=[];else for(var n=this.a[t],i=0;i<n.length;)n[i].fn===e?n.splice(i,1):++i;return this},n.prototype.emit=function(t){var r=this.a[t];if(r){for(var e=[],n=1;n<arguments.length;)e.push(arguments[n++]);for(n=0;n<r.length;)r[n].fn.apply(r[n++].ctx,e)}return this}},{}],4:[function(t,r){function e(t){return"undefined"!=typeof Float32Array?function(){function r(t,r,e){o[0]=t,r[e]=s[0],r[e+1]=s[1],r[e+2]=s[2],r[e+3]=s[3]}function e(t,r,e){o[0]=t,r[e]=s[3],r[e+1]=s[2],r[e+2]=s[1],r[e+3]=s[0]}function n(t,r){return s[0]=t[r],s[1]=t[r+1],s[2]=t[r+2],s[3]=t[r+3],o[0]}function i(t,r){return s[3]=t[r],s[2]=t[r+1],s[1]=t[r+2],s[0]=t[r+3],o[0]}var o=new Float32Array([-0]),s=new Uint8Array(o.buffer),u=128===s[3];t.writeFloatLE=u?r:e,t.writeFloatBE=u?e:r,t.readFloatLE=u?n:i,t.readFloatBE=u?i:n}():function(){function r(t,r,e,n){var i=r<0?1:0;if(i&&(r=-r),0===r)t(1/r>0?0:2147483648,e,n);else if(isNaN(r))t(2143289344,e,n);else if(r>3.4028234663852886e38)t((i<<31|2139095040)>>>0,e,n);else if(r<1.1754943508222875e-38)t((i<<31|Math.round(r/1.401298464324817e-45))>>>0,e,n);else{var o=Math.floor(Math.log(r)/Math.LN2),s=8388607&Math.round(r*Math.pow(2,-o)*8388608);t((i<<31|o+127<<23|s)>>>0,e,n)}}function e(t,r,e){var n=t(r,e),i=2*(n>>31)+1,o=n>>>23&255,s=8388607&n;return 255===o?s?NaN:i*(1/0):0===o?1.401298464324817e-45*i*s:i*Math.pow(2,o-150)*(s+8388608)}t.writeFloatLE=r.bind(null,n),t.writeFloatBE=r.bind(null,i),t.readFloatLE=e.bind(null,o),t.readFloatBE=e.bind(null,s)}(),"undefined"!=typeof Float64Array?function(){function r(t,r,e){o[0]=t,r[e]=s[0],r[e+1]=s[1],r[e+2]=s[2],r[e+3]=s[3],r[e+4]=s[4],r[e+5]=s[5],r[e+6]=s[6],r[e+7]=s[7]}function e(t,r,e){o[0]=t,r[e]=s[7],r[e+1]=s[6],r[e+2]=s[5],r[e+3]=s[4],r[e+4]=s[3],r[e+5]=s[2],r[e+6]=s[1],r[e+7]=s[0]}function n(t,r){return s[0]=t[r],s[1]=t[r+1],s[2]=t[r+2],s[3]=t[r+3],s[4]=t[r+4],s[5]=t[r+5],s[6]=t[r+6],s[7]=t[r+7],o[0]}function i(t,r){return s[7]=t[r],s[6]=t[r+1],s[5]=t[r+2],s[4]=t[r+3],s[3]=t[r+4],s[2]=t[r+5],s[1]=t[r+6],s[0]=t[r+7],o[0]}var o=new Float64Array([-0]),s=new Uint8Array(o.buffer),u=128===s[7];t.writeDoubleLE=u?r:e,t.writeDoubleBE=u?e:r,t.readDoubleLE=u?n:i,t.readDoubleBE=u?i:n}():function(){function r(t,r,e,n,i,o){var s=n<0?1:0;if(s&&(n=-n),0===n)t(0,i,o+r),t(1/n>0?0:2147483648,i,o+e);else if(isNaN(n))t(0,i,o+r),t(2146959360,i,o+e);else if(n>1.7976931348623157e308)t(0,i,o+r),t((s<<31|2146435072)>>>0,i,o+e);else{var u;if(n<2.2250738585072014e-308)u=n/5e-324,t(u>>>0,i,o+r),t((s<<31|u/4294967296)>>>0,i,o+e);else{var f=Math.floor(Math.log(n)/Math.LN2);1024===f&&(f=1023),u=n*Math.pow(2,-f),t(4503599627370496*u>>>0,i,o+r),t((s<<31|f+1023<<20|1048576*u&1048575)>>>0,i,o+e)}}}function e(t,r,e,n,i){var o=t(n,i+r),s=t(n,i+e),u=2*(s>>31)+1,f=s>>>20&2047,h=4294967296*(1048575&s)+o;return 2047===f?h?NaN:u*(1/0):0===f?5e-324*u*h:u*Math.pow(2,f-1075)*(h+4503599627370496)}t.writeDoubleLE=r.bind(null,n,0,4),t.writeDoubleBE=r.bind(null,i,4,0),t.readDoubleLE=e.bind(null,o,0,4),t.readDoubleBE=e.bind(null,s,4,0)}(),t}function n(t,r,e){r[e]=255&t,r[e+1]=t>>>8&255,r[e+2]=t>>>16&255,r[e+3]=t>>>24}function i(t,r,e){r[e]=t>>>24,r[e+1]=t>>>16&255,r[e+2]=t>>>8&255,r[e+3]=255&t}function o(t,r){return(t[r]|t[r+1]<<8|t[r+2]<<16|t[r+3]<<24)>>>0}function s(t,r){return(t[r]<<24|t[r+1]<<16|t[r+2]<<8|t[r+3])>>>0}r.exports=e(e)},{}],5:[function(t,r,e){function n(t){try{var r=eval("quire".replace(/^/,"re"))(t);if(r&&(r.length||Object.keys(r).length))return r}catch(t){}return null}r.exports=n},{}],6:[function(t,r){function e(t,r,e){var n=e||8192,i=n>>>1,o=null,s=n;return function(e){if(e<1||e>i)return t(e);s+e>n&&(o=t(n),s=0);var u=r.call(o,s,s+=e);return 7&s&&(s=1+(7|s)),u}}r.exports=e},{}],7:[function(t,r,e){var n=e;n.length=function(t){for(var r=0,e=0,n=0;n<t.length;++n)e=t.charCodeAt(n),e<128?r+=1:e<2048?r+=2:55296==(64512&e)&&56320==(64512&t.charCodeAt(n+1))?(++n,r+=4):r+=3;return r},n.read=function(t,r,e){if(e-r<1)return"";for(var n,i=null,o=[],s=0;r<e;)n=t[r++],n<128?o[s++]=n:n>191&&n<224?o[s++]=(31&n)<<6|63&t[r++]:n>239&&n<365?(n=((7&n)<<18|(63&t[r++])<<12|(63&t[r++])<<6|63&t[r++])-65536,o[s++]=55296+(n>>10),o[s++]=56320+(1023&n)):o[s++]=(15&n)<<12|(63&t[r++])<<6|63&t[r++],s>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i?(s&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))},n.write=function(t,r,e){for(var n,i,o=e,s=0;s<t.length;++s)n=t.charCodeAt(s),n<128?r[e++]=n:n<2048?(r[e++]=n>>6|192,r[e++]=63&n|128):55296==(64512&n)&&56320==(64512&(i=t.charCodeAt(s+1)))?(n=65536+((1023&n)<<10)+(1023&i),++s,r[e++]=n>>18|240,r[e++]=n>>12&63|128,r[e++]=n>>6&63|128,r[e++]=63&n|128):(r[e++]=n>>12|224,r[e++]=n>>6&63|128,r[e++]=63&n|128);return e-o}},{}],8:[function(t,r,e){function n(){i.Reader.b(i.BufferReader),i.util.b()}var i=e;i.build="minimal",i.Writer=t(16),i.BufferWriter=t(17),i.Reader=t(9),i.BufferReader=t(10),i.util=t(15),i.rpc=t(12),i.roots=t(11),i.configure=n,i.Writer.b(i.BufferWriter),n()},{10:10,11:11,12:12,15:15,16:16,17:17,9:9}],9:[function(t,r){function e(t,r){return RangeError("index out of range: "+t.pos+" + "+(r||1)+" > "+t.len)}function n(t){this.buf=t,this.pos=0,this.len=t.length}function i(){var t=new h(0,0),r=0;if(!(this.len-this.pos>4)){for(;r<3;++r){if(this.pos>=this.len)throw e(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*r)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*r)>>>0,t}for(;r<4;++r)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*r)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(r=0,this.len-this.pos>4){for(;r<5;++r)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*r+3)>>>0,this.buf[this.pos++]<128)return t}else for(;r<5;++r){if(this.pos>=this.len)throw e(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*r+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function o(t,r){return(t[r-4]|t[r-3]<<8|t[r-2]<<16|t[r-1]<<24)>>>0}function s(){if(this.pos+8>this.len)throw e(this,8);return new h(o(this.buf,this.pos+=4),o(this.buf,this.pos+=4))}r.exports=n;var u,f=t(15),h=f.LongBits,a=f.utf8,l="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new n(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new n(t);throw Error("illegal buffer")};n.create=f.Buffer?function(t){return(n.create=function(t){return f.Buffer.isBuffer(t)?new u(t):l(t)})(t)}:l,n.prototype.c=f.Array.prototype.subarray||f.Array.prototype.slice,n.prototype.uint32=function(){var t=4294967295;return function(){if(t=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return t;if((this.pos+=5)>this.len)throw this.pos=this.len,e(this,10);return t}}(),n.prototype.int32=function(){return 0|this.uint32()},n.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},n.prototype.bool=function(){return 0!==this.uint32()},n.prototype.fixed32=function(){if(this.pos+4>this.len)throw e(this,4);return o(this.buf,this.pos+=4)},n.prototype.sfixed32=function(){if(this.pos+4>this.len)throw e(this,4);return 0|o(this.buf,this.pos+=4)},n.prototype.float=function(){if(this.pos+4>this.len)throw e(this,4);var t=f.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},n.prototype.double=function(){if(this.pos+8>this.len)throw e(this,4);var t=f.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},n.prototype.bytes=function(){var t=this.uint32(),r=this.pos,n=this.pos+t;if(n>this.len)throw e(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(r,n):r===n?new this.buf.constructor(0):this.c.call(this.buf,r,n)},n.prototype.string=function(){var t=this.bytes();return a.read(t,0,t.length)},n.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw e(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw e(this)}while(128&this.buf[this.pos++]);return this},n.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;;){if(4==(t=7&this.uint32()))break;this.skipType(t)}break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},n.b=function(t){u=t;var r=f.Long?"toLong":"toNumber";f.merge(n.prototype,{int64:function(){return i.call(this)[r](!1)},uint64:function(){return i.call(this)[r](!0)},sint64:function(){return i.call(this).zzDecode()[r](!1)},fixed64:function(){return s.call(this)[r](!0)},sfixed64:function(){return s.call(this)[r](!1)}})}},{15:15}],10:[function(t,r){function e(t){n.call(this,t)}r.exports=e;var n=t(9);(e.prototype=Object.create(n.prototype)).constructor=e;var i=t(15);i.Buffer&&(e.prototype.c=i.Buffer.prototype.slice),e.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))}},{15:15,9:9}],11:[function(t,r){r.exports={}},{}],12:[function(t,r,e){e.Service=t(13)},{13:13}],13:[function(t,e){function n(t,r,e){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");i.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=!!r,this.responseDelimited=!!e}e.exports=n;var i=t(15);(n.prototype=Object.create(i.EventEmitter.prototype)).constructor=n,n.prototype.rpcCall=function t(e,n,o,s,u){if(!s)throw TypeError("request must be specified");var f=this;if(!u)return i.asPromise(t,f,e,n,o,s);if(!f.rpcImpl)return setTimeout(function(){u(Error("already ended"))},0),r;try{return f.rpcImpl(e,n[f.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(t,n){if(t)return f.emit("error",t,e),u(t);if(null===n)return f.end(!0),r;if(!(n instanceof o))try{n=o[f.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return f.emit("error",t,e),u(t)}return f.emit("data",n,e),u(null,n)})}catch(t){return f.emit("error",t,e),setTimeout(function(){u(t)},0),r}},n.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},{15:15}],14:[function(t,r){function e(t,r){this.lo=t>>>0,this.hi=r>>>0}r.exports=e;var n=t(15),i=e.zero=new e(0,0);i.toNumber=function(){return 0},i.zzEncode=i.zzDecode=function(){return this},i.length=function(){return 1};var o=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(t){if(0===t)return i;var r=t<0;r&&(t=-t);var n=t>>>0,o=(t-n)/4294967296>>>0;return r&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new e(n,o)},e.from=function(t){if("number"==typeof t)return e.fromNumber(t);if(n.isString(t)){if(!n.Long)return e.fromNumber(parseInt(t,10));t=n.Long.fromString(t)}return t.low||t.high?new e(t.low>>>0,t.high>>>0):i},e.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var r=1+~this.lo>>>0,e=~this.hi>>>0;return r||(e=e+1>>>0),-(r+4294967296*e)}return this.lo+4294967296*this.hi},e.prototype.toLong=function(t){return n.Long?new n.Long(0|this.lo,0|this.hi,!!t):{low:0|this.lo,high:0|this.hi,unsigned:!!t}};var s=String.prototype.charCodeAt;e.fromHash=function(t){return t===o?i:new e((s.call(t,0)|s.call(t,1)<<8|s.call(t,2)<<16|s.call(t,3)<<24)>>>0,(s.call(t,4)|s.call(t,5)<<8|s.call(t,6)<<16|s.call(t,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},e.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},e.prototype.length=function(){var t=this.lo,r=(this.lo>>>28|this.hi<<4)>>>0,e=this.hi>>>24;return 0===e?0===r?t<16384?t<128?1:2:t<2097152?3:4:r<16384?r<128?5:6:r<2097152?7:8:e<128?9:10}},{15:15}],15:[function(e,n,i){function o(t,e,n){for(var i=Object.keys(e),o=0;o<i.length;++o)t[i[o]]!==r&&n||(t[i[o]]=e[i[o]]);return t}function s(t){function r(t,e){if(!(this instanceof r))return new r(t,e);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,r):Object.defineProperty(this,"stack",{value:Error().stack||""}),e&&o(this,e)}return(r.prototype=Object.create(Error.prototype)).constructor=r,Object.defineProperty(r.prototype,"name",{get:function(){return t}}),r.prototype.toString=function(){return this.name+": "+this.message},r}var u=i;u.asPromise=e(1),u.base64=e(2),u.EventEmitter=e(3),u.float=e(4),u.inquire=e(5),u.utf8=e(7),u.pool=e(6),u.LongBits=e(14),u.emptyArray=Object.freeze?Object.freeze([]):[],u.emptyObject=Object.freeze?Object.freeze({}):{},u.isNode=!!(t.process&&t.process.versions&&t.process.versions.node),u.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},u.isString=function(t){return"string"==typeof t||t instanceof String},u.isObject=function(t){return t&&"object"==typeof t},u.isset=u.isSet=function(t,r){var e=t[r];return!(null==e||!t.hasOwnProperty(r))&&("object"!=typeof e||(Array.isArray(e)?e.length:Object.keys(e).length)>0)},u.Buffer=function(){try{var t=u.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),u.d=null,u.e=null,u.newBuffer=function(t){return"number"==typeof t?u.Buffer?u.e(t):new u.Array(t):u.Buffer?u.d(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},u.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,u.Long=t.dcodeIO&&t.dcodeIO.Long||u.inquire("long"),u.key2Re=/^true|false|0|1$/,u.key32Re=/^-?(?:0|[1-9][0-9]*)$/,u.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,u.longToHash=function(t){return t?u.LongBits.from(t).toHash():u.LongBits.zeroHash},u.longFromHash=function(t,r){var e=u.LongBits.fromHash(t);return u.Long?u.Long.fromBits(e.lo,e.hi,r):e.toNumber(!!r)},u.merge=o,u.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},u.newError=s,u.ProtocolError=s("ProtocolError"),u.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&this[t[n]]!==r&&null!==this[t[n]])return t[n]}},u.oneOfSetter=function(t){return function(r){for(var e=0;e<t.length;++e)t[e]!==r&&delete this[t[e]]}},u.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},u.b=function(){var t=u.Buffer;if(!t)return void(u.d=u.e=null);u.d=t.from!==Uint8Array.from&&t.from||function(r,e){return new t(r,e)},u.e=t.allocUnsafe||function(r){return new t(r)}}},{1:1,14:14,2:2,3:3,4:4,5:5,6:6,7:7}],16:[function(t,e){function n(t,e,n){this.fn=t,this.len=e,this.next=r,this.val=n}function i(){}function o(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function s(){this.len=0,this.head=new n(i,0,0),this.tail=this.head,this.states=null}function u(t,r,e){r[e]=255&t}function f(t,r,e){for(;t>127;)r[e++]=127&t|128,t>>>=7;r[e]=t}function h(t,e){this.len=t,this.next=r,this.val=e}function a(t,r,e){for(;t.hi;)r[e++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)r[e++]=127&t.lo|128,t.lo=t.lo>>>7;r[e++]=t.lo}function l(t,r,e){r[e]=255&t,r[e+1]=t>>>8&255,r[e+2]=t>>>16&255,r[e+3]=t>>>24}e.exports=s;var c,p=t(15),y=p.LongBits,d=p.base64,b=p.utf8;s.create=p.Buffer?function(){return(s.create=function(){return new c})()}:function(){return new s},s.alloc=function(t){return new p.Array(t)},p.Array!==Array&&(s.alloc=p.pool(s.alloc,p.Array.prototype.subarray)),s.prototype.f=function(t,r,e){return this.tail=this.tail.next=new n(t,r,e),this.len+=r,this},h.prototype=Object.create(n.prototype),h.prototype.fn=f,s.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new h((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},s.prototype.int32=function(t){return t<0?this.f(a,10,y.fromNumber(t)):this.uint32(t)},s.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},s.prototype.uint64=function(t){var r=y.from(t);return this.f(a,r.length(),r)},s.prototype.int64=s.prototype.uint64,s.prototype.sint64=function(t){var r=y.from(t).zzEncode();return this.f(a,r.length(),r)},s.prototype.bool=function(t){return this.f(u,1,t?1:0)},s.prototype.fixed32=function(t){return this.f(l,4,t>>>0)},s.prototype.sfixed32=s.prototype.fixed32,s.prototype.fixed64=function(t){var r=y.from(t);return this.f(l,4,r.lo).f(l,4,r.hi)},s.prototype.sfixed64=s.prototype.fixed64,s.prototype.float=function(t){return this.f(p.float.writeFloatLE,4,t)},s.prototype.double=function(t){return this.f(p.float.writeDoubleLE,8,t)};var g=p.Array.prototype.set?function(t,r,e){r.set(t,e)}:function(t,r,e){for(var n=0;n<t.length;++n)r[e+n]=t[n]};s.prototype.bytes=function(t){var r=t.length>>>0;if(!r)return this.f(u,1,0);if(p.isString(t)){var e=s.alloc(r=d.length(t));d.decode(t,e,0),t=e}return this.uint32(r).f(g,r,t)},s.prototype.string=function(t){var r=b.length(t);return r?this.uint32(r).f(b.write,r,t):this.f(u,1,0)},s.prototype.fork=function(){return this.states=new o(this),this.head=this.tail=new n(i,0,0),this.len=0,this},s.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new n(i,0,0),this.len=0),this},s.prototype.ldelim=function(){var t=this.head,r=this.tail,e=this.len;return this.reset().uint32(e),e&&(this.tail.next=t.next,this.tail=r,this.len+=e),this},s.prototype.finish=function(){for(var t=this.head.next,r=this.constructor.alloc(this.len),e=0;t;)t.fn(t.val,r,e),e+=t.len,t=t.next;return r},s.b=function(t){c=t}},{15:15}],17:[function(t,r){function e(){i.call(this)}function n(t,r,e){t.length<40?o.utf8.write(t,r,e):r.utf8Write(t,e)}r.exports=e;var i=t(16);(e.prototype=Object.create(i.prototype)).constructor=e;var o=t(15),s=o.Buffer;e.alloc=function(t){return(e.alloc=o.e)(t)};var u=s&&s.prototype instanceof Uint8Array&&"set"===s.prototype.set.name?function(t,r,e){r.set(t,e)}:function(t,r,e){if(t.copy)t.copy(r,e,0,t.length);else for(var n=0;n<t.length;)r[e++]=t[n++]};e.prototype.bytes=function(t){o.isString(t)&&(t=o.d(t,"base64"));var r=t.length>>>0;return this.uint32(r),r&&this.f(u,r,t),this},e.prototype.string=function(t){var r=s.byteLength(t);return this.uint32(r),r&&this.f(n,r,t),this}},{15:15,16:16}]},{},[8])}("object"==typeof window&&window||"object"==typeof self&&self||this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:53:"/bitrix/js/pull/protobuf/model.min.js?155775644213978";s:6:"source";s:33:"/bitrix/js/pull/protobuf/model.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(e){"use strict";var n=e.Reader,t=e.Writer,r=e.util;var s=e.roots["push-server"]||(e.roots["push-server"]={});s.RequestBatch=function(){function e(e){this.requests=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.requests=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.requests!=null&&n.requests.length)for(var i=0;i<n.requests.length;++i)s.Request.encode(n.requests[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.RequestBatch;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.requests&&o.requests.length))o.requests=[];o.requests.push(s.Request.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.Request=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.incomingMessages=null;e.prototype.channelStats=null;e.prototype.serverStats=null;var i;Object.defineProperty(e.prototype,"command",{get:r.oneOfGetter(i=["incomingMessages","channelStats","serverStats"]),set:r.oneOfSetter(i)});e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.incomingMessages!=null&&n.hasOwnProperty("incomingMessages"))s.IncomingMessagesRequest.encode(n.incomingMessages,r.uint32(10).fork()).ldelim();if(n.channelStats!=null&&n.hasOwnProperty("channelStats"))s.ChannelStatsRequest.encode(n.channelStats,r.uint32(18).fork()).ldelim();if(n.serverStats!=null&&n.hasOwnProperty("serverStats"))s.ServerStatsRequest.encode(n.serverStats,r.uint32(26).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.Request;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.incomingMessages=s.IncomingMessagesRequest.decode(t,t.uint32());break;case 2:o.channelStats=s.ChannelStatsRequest.decode(t,t.uint32());break;case 3:o.serverStats=s.ServerStatsRequest.decode(t,t.uint32());break;default:t.skipType(a&7);break}}return o};return e}();s.IncomingMessagesRequest=function(){function e(e){this.messages=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.messages=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.messages!=null&&n.messages.length)for(var i=0;i<n.messages.length;++i)s.IncomingMessage.encode(n.messages[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.IncomingMessagesRequest;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.messages&&o.messages.length))o.messages=[];o.messages.push(s.IncomingMessage.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.IncomingMessage=function(){function e(e){this.receivers=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.receivers=r.emptyArray;e.prototype.sender=null;e.prototype.body="";e.prototype.expiry=0;e.prototype.type="";e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.receivers!=null&&n.receivers.length)for(var i=0;i<n.receivers.length;++i)s.Receiver.encode(n.receivers[i],r.uint32(10).fork()).ldelim();if(n.sender!=null&&n.hasOwnProperty("sender"))s.Sender.encode(n.sender,r.uint32(18).fork()).ldelim();if(n.body!=null&&n.hasOwnProperty("body"))r.uint32(26).string(n.body);if(n.expiry!=null&&n.hasOwnProperty("expiry"))r.uint32(32).uint32(n.expiry);if(n.type!=null&&n.hasOwnProperty("type"))r.uint32(42).string(n.type);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.IncomingMessage;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.receivers&&o.receivers.length))o.receivers=[];o.receivers.push(s.Receiver.decode(t,t.uint32()));break;case 2:o.sender=s.Sender.decode(t,t.uint32());break;case 3:o.body=t.string();break;case 4:o.expiry=t.uint32();break;case 5:o.type=t.string();break;default:t.skipType(a&7);break}}return o};return e}();s.ChannelStatsRequest=function(){function e(e){this.channels=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.channels=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.channels!=null&&n.channels.length)for(var i=0;i<n.channels.length;++i)s.ChannelId.encode(n.channels[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ChannelStatsRequest;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.channels&&o.channels.length))o.channels=[];o.channels.push(s.ChannelId.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.ChannelId=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.id=r.newBuffer([]);e.prototype.isPrivate=false;e.prototype.signature=r.newBuffer([]);e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.id!=null&&n.hasOwnProperty("id"))r.uint32(10).bytes(n.id);if(n.isPrivate!=null&&n.hasOwnProperty("isPrivate"))r.uint32(16).bool(n.isPrivate);if(n.signature!=null&&n.hasOwnProperty("signature"))r.uint32(26).bytes(n.signature);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ChannelId;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.id=t.bytes();break;case 2:o.isPrivate=t.bool();break;case 3:o.signature=t.bytes();break;default:t.skipType(a&7);break}}return o};return e}();s.ServerStatsRequest=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ServerStatsRequest;while(t.pos<i){var a=t.uint32();switch(a>>>3){default:t.skipType(a&7);break}}return o};return e}();s.Sender=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.type=0;e.prototype.id=r.newBuffer([]);e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.type!=null&&n.hasOwnProperty("type"))r.uint32(8).int32(n.type);if(n.id!=null&&n.hasOwnProperty("id"))r.uint32(18).bytes(n.id);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.Sender;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.type=t.int32();break;case 2:o.id=t.bytes();break;default:t.skipType(a&7);break}}return o};return e}();s.SenderType=function(){var e={},n=Object.create(e);n[e[0]="UNKNOWN"]=0;n[e[1]="CLIENT"]=1;n[e[2]="BACKEND"]=2;return n}();s.Receiver=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.id=r.newBuffer([]);e.prototype.isPrivate=false;e.prototype.signature=r.newBuffer([]);e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.id!=null&&n.hasOwnProperty("id"))r.uint32(10).bytes(n.id);if(n.isPrivate!=null&&n.hasOwnProperty("isPrivate"))r.uint32(16).bool(n.isPrivate);if(n.signature!=null&&n.hasOwnProperty("signature"))r.uint32(26).bytes(n.signature);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.Receiver;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.id=t.bytes();break;case 2:o.isPrivate=t.bool();break;case 3:o.signature=t.bytes();break;default:t.skipType(a&7);break}}return o};return e}();s.ResponseBatch=function(){function e(e){this.responses=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.responses=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.responses!=null&&n.responses.length)for(var i=0;i<n.responses.length;++i)s.Response.encode(n.responses[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ResponseBatch;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.responses&&o.responses.length))o.responses=[];o.responses.push(s.Response.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.Response=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.outgoingMessages=null;e.prototype.channelStats=null;e.prototype.serverStats=null;var i;Object.defineProperty(e.prototype,"command",{get:r.oneOfGetter(i=["outgoingMessages","channelStats","serverStats"]),set:r.oneOfSetter(i)});e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.outgoingMessages!=null&&n.hasOwnProperty("outgoingMessages"))s.OutgoingMessagesResponse.encode(n.outgoingMessages,r.uint32(10).fork()).ldelim();if(n.channelStats!=null&&n.hasOwnProperty("channelStats"))s.ChannelStatsResponse.encode(n.channelStats,r.uint32(18).fork()).ldelim();if(n.serverStats!=null&&n.hasOwnProperty("serverStats"))s.JsonResponse.encode(n.serverStats,r.uint32(26).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.Response;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.outgoingMessages=s.OutgoingMessagesResponse.decode(t,t.uint32());break;case 2:o.channelStats=s.ChannelStatsResponse.decode(t,t.uint32());break;case 3:o.serverStats=s.JsonResponse.decode(t,t.uint32());break;default:t.skipType(a&7);break}}return o};return e}();s.OutgoingMessagesResponse=function(){function e(e){this.messages=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.messages=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.messages!=null&&n.messages.length)for(var i=0;i<n.messages.length;++i)s.OutgoingMessage.encode(n.messages[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.OutgoingMessagesResponse;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.messages&&o.messages.length))o.messages=[];o.messages.push(s.OutgoingMessage.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.OutgoingMessage=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.id=r.newBuffer([]);e.prototype.body="";e.prototype.expiry=0;e.prototype.created=0;e.prototype.sender=null;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.id!=null&&n.hasOwnProperty("id"))r.uint32(10).bytes(n.id);if(n.body!=null&&n.hasOwnProperty("body"))r.uint32(18).string(n.body);if(n.expiry!=null&&n.hasOwnProperty("expiry"))r.uint32(24).uint32(n.expiry);if(n.created!=null&&n.hasOwnProperty("created"))r.uint32(37).fixed32(n.created);if(n.sender!=null&&n.hasOwnProperty("sender"))s.Sender.encode(n.sender,r.uint32(42).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.OutgoingMessage;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.id=t.bytes();break;case 2:o.body=t.string();break;case 3:o.expiry=t.uint32();break;case 4:o.created=t.fixed32();break;case 5:o.sender=s.Sender.decode(t,t.uint32());break;default:t.skipType(a&7);break}}return o};return e}();s.ChannelStatsResponse=function(){function e(e){this.channels=[];if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.channels=r.emptyArray;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.channels!=null&&n.channels.length)for(var i=0;i<n.channels.length;++i)s.ChannelStats.encode(n.channels[i],r.uint32(10).fork()).ldelim();return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ChannelStatsResponse;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:if(!(o.channels&&o.channels.length))o.channels=[];o.channels.push(s.ChannelStats.decode(t,t.uint32()));break;default:t.skipType(a&7);break}}return o};return e}();s.ChannelStats=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.id=r.newBuffer([]);e.prototype.isPrivate=false;e.prototype.isOnline=false;e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.id!=null&&n.hasOwnProperty("id"))r.uint32(10).bytes(n.id);if(n.isPrivate!=null&&n.hasOwnProperty("isPrivate"))r.uint32(16).bool(n.isPrivate);if(n.isOnline!=null&&n.hasOwnProperty("isOnline"))r.uint32(24).bool(n.isOnline);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.ChannelStats;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.id=t.bytes();break;case 2:o.isPrivate=t.bool();break;case 3:o.isOnline=t.bool();break;default:t.skipType(a&7);break}}return o};return e}();s.JsonResponse=function(){function e(e){if(e)for(var n=Object.keys(e),t=0;t<n.length;++t)if(e[n[t]]!=null)this[n[t]]=e[n[t]]}e.prototype.json="";e.create=function n(t){return new e(t)};e.encode=function e(n,r){if(!r)r=t.create();if(n.json!=null&&n.hasOwnProperty("json"))r.uint32(10).string(n.json);return r};e.decode=function e(t,r){if(!(t instanceof n))t=n.create(t);var i=r===undefined?t.len:t.pos+r,o=new s.JsonResponse;while(t.pos<i){var a=t.uint32();switch(a>>>3){case 1:o.json=t.string();break;default:t.skipType(a&7);break}}return o};return e}();return s})(protobuf);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:57:"/bitrix/js/pull/client/pull.client.min.js?155775644239145";s:6:"source";s:37:"/bitrix/js/pull/client/pull.client.js";s:3:"min";s:41:"/bitrix/js/pull/client/pull.client.min.js";s:3:"map";s:41:"/bitrix/js/pull/client/pull.client.map.js";}"*/
(function(){if(!window.BX){window.BX={}}else if(window.BX.PullClient){return}var e=window.BX;var t=window.protobuf;var n=19;var o=60;var i=30*60;var s=24*60*60;var r=6e4;var c="bx-pull-session";var a=20;var u={WebSocket:"webSocket",LongPolling:"longPolling"};var l={Online:"online",Offline:"offline",Connecting:"connect"};var h={Unknown:0,Client:1,Backend:2};var f={Server:"server",Client:"client",Online:"online",Status:"status",Revision:"revision"};var d={NORMAL_CLOSURE:1e3,SERVER_DIE:1001,CONFIG_REPLACED:3e3,CHANNEL_EXPIRED:3001,SERVER_RESTARTED:3002,CONFIG_EXPIRED:3003,MANUAL:3004};var p={CHANNEL_EXPIRE:"CHANNEL_EXPIRE",CONFIG_EXPIRE:"CONFIG_EXPIRE",SERVER_RESTART:"SERVER_RESTART"};var g=t.roots["push-server"]["Response"];var m=t.roots["push-server"]["ResponseBatch"];var y=t.roots["push-server"]["Request"];var b=t.roots["push-server"]["RequestBatch"];var v=t.roots["push-server"]["IncomingMessagesRequest"];var k=t.roots["push-server"]["IncomingMessage"];var S=t.roots["push-server"]["Receiver"];var E=function(t){t=t||{};var n=this;this.context="master";this.userId=t.userId?t.userId:typeof e.message!=="undefined"&&e.message.USER_ID?e.message.USER_ID:0;this.siteId=t.siteId?t.siteId:typeof e.message!=="undefined"&&e.message.SITE_ID?e.message.SITE_ID:"none";this.restClient=typeof t.restClient!=="undefined"?t.restClient:e.rest;this.enabled=typeof t.serverEnabled!=="undefined"?t.serverEnabled==="Y"||t.serverEnabled===true:typeof e.message!=="undefined"&&e.message.pull_server_enabled==="Y";this.unloading=false;this.starting=false;this.debug=false;this.connectionAttempt=0;this.connectionType="";this.reconnectTimeout=null;this.restoreWebSocketTimeout=null;this.skipCheckRevision=t.skipCheckRevision===true;this._subscribers={};this.watchTagsQueue={};this.watchUpdateInterval=174e4;this.watchForceUpdateInterval=5e3;if(typeof t.configTimestamp!=="undefined"){this.configTimestamp=t.configTimestamp}else if(typeof e.message!=="undefined"&&e.message.pull_config_timestamp){this.configTimestamp=e.message.pull_config_timestamp}else{this.configTimestamp=0}this.session={mid:null,tag:null,time:null,history:{},messageCount:0};this._connectors={webSocket:null,longPolling:null};Object.defineProperty(this,"connector",{get:function(){return n._connectors[n.connectionType]}});this.isSecure=document.location.href.indexOf("https")===0;this.config=null;this.storage=new R({userId:this.userId,siteId:this.siteId});this.sharedConfig=new C({onWebSocketBlockChanged:this.onWebSocketBlockChanged.bind(this),storage:this.storage});this.channelManager=new _({restClient:this.restClient});this.notificationPopup=null;this.checkInterval=null;this.offlineTimeout=null;this.isManualDisconnect=false};E.prototype.subscribe=function(e){if(!e){console.error(L.getDateForLog()+": Pull.subscribe: params for subscribe function is invalid. ");return function(){}}if(!L.isPlainObject(e)){return this.attachCommandHandler(e)}e=e||{};e.type=e.type||f.Server;e.command=e.command||null;if(e.type==f.Server||e.type==f.Client){if(typeof this._subscribers[e.type]==="undefined"){this._subscribers[e.type]={}}if(typeof this._subscribers[e.type][e.moduleId]==="undefined"){this._subscribers[e.type][e.moduleId]={callbacks:[],commands:{}}}if(e.command){if(typeof this._subscribers[e.type][e.moduleId]["commands"][e.command]==="undefined"){this._subscribers[e.type][e.moduleId]["commands"][e.command]=[]}this._subscribers[e.type][e.moduleId]["commands"][e.command].push(e.callback);return function(){this._subscribers[e.type][e.moduleId]["commands"][e.command]=this._subscribers[e.type][e.moduleId]["commands"][e.command].filter(function(t){return t!==e.callback})}.bind(this)}else{this._subscribers[e.type][e.moduleId]["callbacks"].push(e.callback);return function(){this._subscribers[e.type][e.moduleId]["callbacks"]=this._subscribers[e.type][e.moduleId]["callbacks"].filter(function(t){return t!==e.callback})}.bind(this)}}else{if(typeof this._subscribers[e.type]==="undefined"){this._subscribers[e.type]=[]}this._subscribers[e.type].push(e.callback);return function(){this._subscribers[e.type]=this._subscribers[e.type].filter(function(t){return t!==e.callback})}.bind(this)}};E.prototype.attachCommandHandler=function(e){if(typeof e.getModuleId!=="function"||typeof e.getModuleId()!=="string"){console.error(L.getDateForLog()+": Pull.attachCommandHandler: result of handler.getModuleId() is not a string.");return function(){}}var t=f.Server;if(typeof e.getSubscriptionType==="function"){t=e.getSubscriptionType()}this.subscribe({type:t,moduleId:e.getModuleId(),callback:function(t){var n=null;if(typeof e.getMap==="function"){var o=e.getMap();if(o&&typeof o==="object"){if(typeof o[t.command]==="function"){n=o[t.command].bind(e)}else if(typeof o[t.command]==="string"&&typeof e[o[t.command]]==="function"){n=e[o[t.command]].bind(e)}}}if(!n){var i="handle"+t.command.charAt(0).toUpperCase()+t.command.slice(1);if(typeof e[i]==="function"){n=e[i].bind(e)}}if(n){if(this.debug&&this.context!=="master"){console.warn(L.getDateForLog()+": Pull.attachCommandHandler: receive command",t)}n(t.params,t.extra,t.command)}}.bind(this)})};E.prototype.emit=function(e){e=e||{};if(e.type==f.Server||e.type==f.Client){if(typeof this._subscribers[e.type]==="undefined"){this._subscribers[e.type]={}}if(typeof this._subscribers[e.type][e.moduleId]==="undefined"){this._subscribers[e.type][e.moduleId]={callbacks:[],commands:{}}}if(this._subscribers[e.type][e.moduleId]["callbacks"].length>0){this._subscribers[e.type][e.moduleId]["callbacks"].forEach(function(t){t(e.data,{type:e.type,moduleId:e.moduleId})})}if(this._subscribers[e.type][e.moduleId]["commands"][e.data.command]&&this._subscribers[e.type][e.moduleId]["commands"][e.data.command].length>0){this._subscribers[e.type][e.moduleId]["commands"][e.data.command].forEach(function(t){t(e.data.params,e.data.extra,e.data.command,{type:e.type,moduleId:e.moduleId})})}return true}else{if(typeof this._subscribers[e.type]==="undefined"){this._subscribers[e.type]=[]}if(this._subscribers[e.type].length<=0){return true}this._subscribers[e.type].forEach(function(t){t(e.data,{type:e.type})});return true}};E.prototype.init=function(){this._connectors.webSocket=new P({parent:this,onOpen:this.onWebSocketOpen.bind(this),onMessage:this.parseResponse.bind(this),onDisconnect:this.onWebSocketDisconnect.bind(this),onError:this.onWebSocketError.bind(this)});this._connectors.longPolling=new T({parent:this,onOpen:this.onLongPollingOpen.bind(this),onMessage:this.parseResponse.bind(this),onDisconnect:this.onLongPollingDisconnect.bind(this),onError:this.onLongPollingError.bind(this)});this.connectionType=this.isWebSocketAllowed()?u.WebSocket:u.LongPolling;window.addEventListener("beforeunload",this.onBeforeUnload.bind(this));window.addEventListener("offline",this.onOffline.bind(this));window.addEventListener("online",this.onOnline.bind(this));if(e&&e.addCustomEvent){e.addCustomEvent("BXLinkOpened",this.connect.bind(this))}if(e&&e.desktop){e.desktop.addCustomEvent("BXLoginSuccess",function(){this.restart(1e3,"Desktop login")}.bind(this))}};E.prototype.start=function(t){if(this.starting||this.isConnected()){return}if(!this.userId&&typeof e.message!=="undefined"&&e.message.USER_ID){this.userId=e.message.USER_ID}if(this.siteId==="none"&&typeof e.message!=="undefined"&&e.message.SITE_ID){this.siteId=e.message.SITE_ID}var n=new e.Promise;if(L.isPlainObject(t)){this.config=t}if(!this.enabled){n.reject({ex:{error:"PULL_DISABLED",error_description:"Push & Pull server is disabled"}});return n}var o=this;var i=(new Date).getTime();var s=this.storage.get(c);if(L.isPlainObject(s)&&s.hasOwnProperty("ttl")&&s.ttl>=i){this.session.mid=s.mid}this.starting=true;this.loadConfig().catch(function(e){o.starting=false;o.sendPullStatus(l.Offline);o.stopCheckConfig();console.error(L.getDateForLog()+": Pull: could not read push-server config. ",e);n.reject(e)}).then(function(e){o.setConfig(e);o.init();o.connect();o.updateWatch();o.startCheckConfig();n.resolve(true)});return n};E.prototype.setLastMessageId=function(e){this.session.mid=e};E.prototype.setPublicIds=function(e){return this.channelManager.setPublicIds(e)};E.prototype.sendMessage=function(e,t,n,o,i){return this.sendMessageBatch([{users:e,moduleId:t,command:n,params:o,expiry:i}])};E.prototype.sendMessageBatch=function(e){if(!this.isPublishingEnabled()){console.error("Client publishing is not supported or is disabled");return false}var t=[];var n={};for(var o=0;o<e.length;o++){for(var i=0;i<e[o].users.length;i++){n[e[o].users[i]]=true}}this.channelManager.getPublicIds(Object.keys(n)).then(function(n){e.forEach(function(e){var o={module_id:e.moduleId,command:e.command,params:e.params};var i=k.create({receivers:this.createMessageReceivers(e.users,n),body:JSON.stringify(o),expiry:e.expiry||0});t.push(i)},this);var o=b.create({requests:[{incomingMessages:{messages:t}}]});var i=b.encode(o).finish();return this.connector.send(i)}.bind(this))};E.prototype.createMessageReceivers=function(e,t){var n=[];for(var o=0;o<e.length;o++){var i=e[o];if(!t[i]||!t[i].publicId){throw new Error("Could not determine public id for user "+i)}n.push(S.create({id:this.encodeId(t[i].publicId),signature:this.encodeId(t[i].signature)}))}return n};E.prototype.restart=function(t,n){var o=this;this.disconnect(t,n);this.storage.remove("bx-pull-config");this.config=null;this.loadConfig().catch(function(t){console.error(L.getDateForLog()+": Pull: could not read push-server config",t);o.sendPullStatus(l.Offline);clearTimeout(o.reconnectTimeout);if(t.status==401||t.status==403){o.stopCheckConfig();if(e&&e.onCustomEvent){e.onCustomEvent(window,"onPullError",["AUTHORIZE_ERROR"])}}}).then(function(e){o.setConfig(e);o.connect();o.updateWatch();o.startCheckConfig()})};E.prototype.loadConfig=function(){var t=new e.Promise;if(!this.config){this.config={api:{},channels:{},server:{timeShift:0}};var n=this.storage.get("bx-pull-config");if(this.isConfigActual(n)&&this.checkRevision(n.api.revision_web)){t.resolve(n);return t}else{this.storage.remove("bx-pull-config")}}else if(this.isConfigActual(this.config)&&this.checkRevision(this.config.api.revision_web)){t.resolve(this.config);return t}else{this.config={api:{},channels:{},server:{timeShift:0}}}this.restClient.callBatch({serverTime:["server.time"],configGet:["pull.config.get",{CACHE:"N"}]},function(e){if(!e){t.reject(new Error("Network error while getting new config"));return false}var n=0;if(e.serverTime&&!e.serverTime.error()){n=Math.floor((L.getTimestamp()-new Date(e.serverTime.data()).getTime())/1e3)}if(e.configGet.error()){var o=e.configGet.error();if(o.getError().error=="AUTHORIZE_ERROR"||o.getError().error=="WRONG_AUTH_TYPE"){o.status=403}t.reject(o)}else if(e.configGet){var i=e.configGet.data();i.server.timeShift=n;t.resolve(i)}},false,false,"pull.config");return t};E.prototype.isConfigActual=function(e){if(!L.isPlainObject(e)){return false}if(e.server.config_timestamp<this.configTimestamp){return false}var t=new Date;var n=Object.keys(e.channels).length;if(n===0){return false}for(var o in e.channels){if(!e.channels.hasOwnProperty(o)){continue}var i=e.channels[o];var s=new Date(i.end);if(s<t){return false}}return true};E.prototype.startCheckConfig=function(){if(this.checkInterval){clearInterval(this.checkInterval)}this.checkInterval=setInterval(this.checkConfig.bind(this),r)};E.prototype.stopCheckConfig=function(){if(this.checkInterval){clearInterval(this.checkInterval)}this.checkInterval=null};E.prototype.checkConfig=function(){if(this.isConfigActual(this.config)){if(!this.checkRevision(this.config.api.revision_web)){return false}}else{console.log(L.getDateForLog()+": Stale config detected. Restarting");this.restart(d.CONFIG_EXPIRED,"Config update required")}};E.prototype.setConfig=function(e){for(var t in e){if(e.hasOwnProperty(t)&&this.config.hasOwnProperty(t)){this.config[t]=e[t]}}this.storage.set("bx-pull-config",e)};E.prototype.isWebSocketSupported=function(){return typeof window.WebSocket!=="undefined"};E.prototype.isWebSocketAllowed=function(){if(this.sharedConfig.isWebSocketBlocked()){return false}return this.isWebSocketEnabled()};E.prototype.isWebSocketEnabled=function(){if(!this.isWebSocketSupported()){return false}return this.config.server.websocket_enabled===true};E.prototype.isPublishingSupported=function(){return this.getServerVersion()>3};E.prototype.isPublishingEnabled=function(){if(!this.isPublishingSupported()){return false}return this.config.server.publish_enabled===true};E.prototype.isProtobufSupported=function(){return this.getServerVersion()>3&&!L.browser.IsIe()};E.prototype.disconnect=function(e,t){if(this.connector){this.isManualDisconnect=true;this.connector.disconnect(e,t)}};E.prototype.stop=function(e,t){this.disconnect(e,t);this.stopCheckConfig()};E.prototype.reconnect=function(e,t,n){this.disconnect(e,t);n=n||1;this.scheduleReconnect(n)};E.prototype.restoreWebSocketConnection=function(){if(this.connectionType==u.WebSocket){return true}this._connectors.webSocket.connect()};E.prototype.scheduleReconnect=function(e){if(!this.enabled)return false;if(!e){if(this.connectionAttempt>3&&this.connectionType===u.WebSocket){this.sharedConfig.setWebSocketBlocked(true);this.connectionType=u.LongPolling;this.connectionAttempt=1;e=1}else{e=this.getConnectionAttemptDelay(this.connectionAttempt)}}if(this.reconnectTimeout){clearTimeout(this.reconnectTimeout)}console.log(L.getDateForLog()+": Pull: scheduling reconnection in "+e+" seconds; attempt # "+this.connectionAttempt);this.reconnectTimeout=setTimeout(this.connect.bind(this),e*1e3)};E.prototype.scheduleRestoreWebSocketConnection=function(){console.log(L.getDateForLog()+": Pull: scheduling restoration of websocket connection in "+i+" seconds");var e=this;if(this.restoreWebSocketTimeout){return}this.restoreWebSocketTimeout=setTimeout(function(){e.restoreWebSocketTimeout=0;e.restoreWebSocketConnection()},i*1e3)};E.prototype.connect=function(){if(!this.enabled||this.connector.connected){return false}if(this.reconnectTimeout){clearTimeout(this.reconnectTimeout)}this.sendPullStatus(l.Connecting);this.connectionAttempt++;this.connector.connect()};E.prototype.parseResponse=function(e){var t;var n=this.extractMessages(e);var o=[];if(n.length===0){this.session.mid=null;return}for(var i=0;i<n.length;i++){var s=n[i];this.session.mid=s.mid||null;this.session.tag=s.tag||null;this.session.time=s.time||null;o.push(s.text);if(!this.session.history[s.text.module_id]){this.session.history[s.text.module_id]={}}if(!this.session.history[s.text.module_id][s.text.command]){this.session.history[s.text.module_id][s.text.command]=0}this.session.history[s.text.module_id][s.text.command]++;this.session.messageCount++}this.broadcastMessages(o)};E.prototype.extractMessages=function(e){if(e instanceof ArrayBuffer){return this.extractProtobufMessages(e)}else if(L.isNotEmptyString(e)){return this.extractPlainTextMessages(e)}};E.prototype.extractProtobufMessages=function(e){var t=[];try{var n=m.decode(new Uint8Array(e));for(var o=0;o<n.responses.length;o++){var i=n.responses[o];if(i.command!="outgoingMessages"){continue}var s=n.responses[o].outgoingMessages.messages;for(var r=0;r<s.length;r++){var c=s[r];var a;try{a=JSON.parse(c.body)}catch(e){console.error(L.getDateForLog()+": Pull: Could not parse message body",e);continue}if(!a.extra){a.extra={}}a.extra.sender={type:c.sender.type};if(c.sender.id instanceof Uint8Array){a.extra.sender.id=this.decodeId(c.sender.id)}var u={mid:this.decodeId(c.id),text:a};t.push(u)}}}catch(e){console.error(L.getDateForLog()+": Pull: Could not parse message",e)}return t};E.prototype.extractPlainTextMessages=function(e){var t=[];var n=e.match(/#!NGINXNMS!#(.*?)#!NGINXNME!#/gm);if(n===null){text="\n========= PULL ERROR ===========\n"+"Error type: parseResponse error parsing message\n"+"\n"+"Data string: "+e+"\n"+"================================\n\n";console.warn(text);return t}for(var o=0;o<n.length;o++){n[o]=n[o].substring(12,n[o].length-12);if(n[o].length<=0){continue}try{var i=JSON.parse(n[o])}catch(e){continue}t.push(i)}return t};E.prototype.decodeId=function(e){if(!(e instanceof Uint8Array)){throw new Error("encodedId should be an instance of Uint8Array")}var t="";for(var n=0;n<e.length;n++){var o=e[n].toString(16);if(o.length===1){t+="0"}t+=o}return t};E.prototype.encodeId=function(e){if(!e){return new Uint8Array}var t=[];for(var n=0;n<e.length;n+=2){t.push(parseInt(e.substr(n,2),16))}return new Uint8Array(t)};E.prototype.broadcastMessages=function(t){t.forEach(function(t){var n=t.module_id=t.module_id.toLowerCase();var o=t.command;if(!t.extra){t.extra={}}if(t.extra.server_time_unix){t.extra.server_time_ago=(L.getTimestamp()-t.extra.server_time_unix*1e3)/1e3-(this.config.server.timeShift?this.config.server.timeShift:0);t.extra.server_time_ago=t.extra.server_time_ago>0?t.extra.server_time_ago:0}this.logMessage(t);try{if(t.extra.sender&&t.extra.sender.type===h.Client){if(typeof e.onCustomEvent!=="undefined"){e.onCustomEvent(window,"onPullClientEvent-"+n,[o,t.params,t.extra],true);e.onCustomEvent(window,"onPullClientEvent",[n,o,t.params,t.extra],true)}this.emit({type:f.Client,moduleId:n,data:{command:o,params:L.clone(t.params),extra:L.clone(t.extra)}})}else if(n==="pull"){this.handleInternalPullEvent(o,t)}else if(n=="online"){if(t.extra.server_time_ago<240){if(typeof e.onCustomEvent!=="undefined"){e.onCustomEvent(window,"onPullOnlineEvent",[o,t.params,t.extra],true)}this.emit({type:f.Online,data:{command:o,params:L.clone(t.params),extra:L.clone(t.extra)}})}}else{if(typeof e.onCustomEvent!=="undefined"){e.onCustomEvent(window,"onPullEvent-"+n,[o,t.params,t.extra],true);e.onCustomEvent(window,"onPullEvent",[n,o,t.params,t.extra],true)}this.emit({type:f.Server,moduleId:n,data:{command:o,params:L.clone(t.params),extra:L.clone(t.extra)}})}}catch(n){if(typeof console=="object"){console.warn("\n========= PULL ERROR ===========\n"+"Error type: broadcastMessages execute error\n"+"Error event: ",n,"\n"+"Message: ",t,"\n"+"================================\n");if(typeof e.debug!=="undefined"){e.debug(n)}}}if(t.extra&&t.extra.revision_web){this.checkRevision(t.extra.revision_web)}},this)};E.prototype.logMessage=function(e){if(!this.debug){return}if(e.extra.sender&&e.extra.sender.type===h.Client){console.info("onPullClientEvent-"+e.module_id,e.command,e.params,e.extra)}else if(e.moduleId=="online"){console.info("onPullOnlineEvent",e.command,e.params,e.extra)}else{console.info("onPullEvent",e.module_id,e.command,e.params,e.extra)}};E.prototype.onLongPollingOpen=function(){this.unloading=false;this.starting=false;this.connectionAttempt=0;this.isManualDisconnect=false;this.sendPullStatus(l.Online);if(this.offlineTimeout){clearTimeout(this.offlineTimeout);this.offlineTimeout=null}console.log(L.getDateForLog()+": Pull: Long polling connection with push-server opened");if(this.isWebSocketEnabled()){this.scheduleRestoreWebSocketConnection()}};E.prototype.onWebSocketBlockChanged=function(e){var t=e.isWebSocketBlocked;if(t&&this.connectionType===u.WebSocket&&!this.isConnected()){clearTimeout(this.reconnectTimeout);this.connectionAttempt=0;this.connectionType=u.LongPolling;this.scheduleReconnect(1)}else if(!t&&this.connectionType===u.LongPolling){clearTimeout(this.reconnectTimeout);clearTimeout(this.restoreWebSocketTimeout);this.connectionAttempt=0;this.connectionType=u.WebSocket;this.scheduleReconnect(1)}};E.prototype.onWebSocketOpen=function(){this.unloading=false;this.starting=false;this.connectionAttempt=0;this.isManualDisconnect=false;this.sendPullStatus(l.Online);this.sharedConfig.setWebSocketBlocked(false);if(this.connectionType==u.LongPolling){this.connectionType=u.WebSocket;this._connectors.longPolling.disconnect()}if(this.offlineTimeout){clearTimeout(this.offlineTimeout);this.offlineTimeout=null}console.log(L.getDateForLog()+": Pull: Websocket connection with push-server opened")};E.prototype.onWebSocketDisconnect=function(e){if(this.connectionType===u.WebSocket){if(e.code!=d.CONFIG_EXPIRED&&e.code!=d.CHANNEL_EXPIRED&&e.code!=d.CONFIG_REPLACED){this.sendPullStatus(l.Offline)}else{this.offlineTimeout=setTimeout(function(){this.sendPullStatus(l.Offline)}.bind(this),5e3)}}if(!e){e={}}console.log(L.getDateForLog()+": Pull: Websocket connection with push-server closed. Code: "+e.code+", reason: "+e.reason);if(!this.isManualDisconnect){this.scheduleReconnect()}this.isManualDisconnect=false};E.prototype.onWebSocketError=function(e){this.starting=false;if(this.connectionType===u.WebSocket){this.sendPullStatus(l.Offline)}console.error(L.getDateForLog()+": Pull: WebSocket connection error",e);this.scheduleReconnect()};E.prototype.onLongPollingDisconnect=function(e){if(this.connectionType===u.LongPolling){if(e.code!=d.CONFIG_EXPIRED&&e.code!=d.CHANNEL_EXPIRED&&e.code!=d.CONFIG_REPLACED){this.sendPullStatus(l.Offline)}else{this.offlineTimeout=setTimeout(function(){this.sendPullStatus(l.Offline)}.bind(this),5500)}}if(!e){e={}}console.log(L.getDateForLog()+": Pull: Long polling connection with push-server closed. Code: "+e.code+", reason: "+e.reason);if(!this.isManualDisconnect){this.scheduleReconnect()}this.isManualDisconnect=false};E.prototype.onLongPollingError=function(e){this.starting=false;if(this.connectionType===u.LongPolling){this.sendPullStatus(l.Offline)}console.error(L.getDateForLog()+": Pull: Long polling connection error",e);this.scheduleReconnect()};E.prototype.isConnected=function(){return this.connector?this.connector.connected:false};E.prototype.onBeforeUnload=function(){this.unloading=true;var e=L.clone(this.session);e.ttl=(new Date).getTime()+a*1e3;this.storage.set(c,JSON.stringify(e),a);this.reconnect(d.NORMAL_CLOSURE,"onbeforeunload",15)};E.prototype.onOffline=function(){this.disconnect("1000","offline")};E.prototype.onOnline=function(){this.connect()};E.prototype.handleInternalPullEvent=function(e,t){switch(e.toUpperCase()){case p.CHANNEL_EXPIRE:{if(t.params.action=="reconnect"){this.config.channels[t.params.channel.type]=t.params.new_channel;console.info("Pull: new config for "+t.params.channel.type+" channel set:\n",this.config.channels[t.params.channel.type]);this.reconnect(d.CONFIG_REPLACED,"config was replaced")}else{this.restart(d.CHANNEL_EXPIRED,"channel expired")}break}case p.CONFIG_EXPIRE:{this.restart(d.CONFIG_EXPIRED,"config expired");break}case p.SERVER_RESTART:{this.reconnect(d.SERVER_RESTARTED,"server was restarted",15);break}default:}};E.prototype.checkRevision=function(t){if(this.skipCheckRevision){return true}t=parseInt(t);if(t>0&&t!=n){this.enabled=false;if(typeof e.message!=="undefined"){this.showNotification(e.message("PULL_OLD_REVISION"))}this.disconnect(d.NORMAL_CLOSURE,"check_revision");if(typeof e.onCustomEvent!=="undefined"){e.onCustomEvent(window,"onPullRevisionUp",[t,n])}this.emit({type:f.Revision,data:{server:t,client:n}});console.log(L.getDateForLog()+": Pull revision changed from "+n+" to "+t+". Reload required");return false}return true};E.prototype.showNotification=function(t){var n=this;if(this.notificationPopup||typeof e.PopupWindow==="undefined")return;this.notificationPopup=new e.PopupWindow("bx-notifier-popup-confirm",null,{zIndex:200,autoHide:false,closeByEsc:false,overlay:true,content:e.create("div",{props:{className:"bx-messenger-confirm"},html:t}),buttons:[new e.PopupWindowButton({text:e.message("JS_CORE_WINDOW_CLOSE"),className:"popup-window-button-decline",events:{click:function(e){n.notificationPopup.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){n.notificationPopup=null}}});this.notificationPopup.show()};E.prototype.getRevision=function(){return this.config.api.revision_web};E.prototype.getServerVersion=function(){return this.config.server.version};E.prototype.getConfig=function(){return this.config};E.prototype.getDebugInfo=function(){if(!console||!console.info||!JSON||!JSON.stringify)return false;var e;if(this.config&&this.config.channels&&this.config.channels.private){e="ChannelID: "+this.config.channels.private.id+"\n"+"ChannelDie: "+this.config.channels.private.end+"\n"+"ChannelDieShared: "+this.config.channels.shared.end}else{e="Config error: config is not loaded"}var t=JSON.stringify(this.watchTagsQueue);var n="\n========= PULL DEBUG ===========\n"+"UserId: "+this.userId+" "+(this.userId>0?"":"(guest)")+"\n"+"Browser online: "+(navigator.onLine?"Y":"N")+"\n"+"Connect: "+(this.isConnected()?"Y":"N")+"\n"+"WebSocket support: "+(this.isWebSocketSupported()?"Y":"N")+"\n"+"WebSocket connect: "+(this._connectors.webSocket&&this._connectors.webSocket.connected?"Y":"N")+"\n"+"WebSocket mode: "+(this._connectors.webSocket&&this._connectors.webSocket.socket?this._connectors.webSocket.socket.url.search("binaryMode=true")!=-1?"protobuf":"text":"-")+"\n"+"Try connect: "+(this.reconnectTimeout?"Y":"N")+"\n"+"Try number: "+this.connectionAttempt+"\n"+"\n"+"Path: "+(this.connector?this.connector.path:"-")+"\n"+e+"\n"+"\n"+"Last message: "+(this.session.mid>0?this.session.mid:"-")+"\n"+"Session history: "+JSON.stringify(this.session.history)+"\n"+"Watch tags: "+(t=="{}"?"-":t)+"\n"+"================================\n";return console.info(n)};E.prototype.capturePullEvent=function(e){if(e===undefined){e=true}this.debug=e};E.prototype.getConnectionPath=function(e){var t;switch(e){case u.WebSocket:t=this.isSecure?this.config.server.websocket_secure:this.config.server.websocket;break;case u.LongPolling:t=this.isSecure?this.config.server.long_pooling_secure:this.config.server.long_polling;break;default:throw new Error("Unknown connection type "+e)}if(!L.isNotEmptyString(t)){return false}var o=[];["private","shared"].forEach(function(e){if(typeof this.config.channels[e]!=="undefined"){o.push(this.config.channels[e].id)}},this);if(o.length===0){return false}var i={CHANNEL_ID:o.join("/")};if(this.isProtobufSupported()){i.binaryMode="true"}if(this.session.mid){i.mid=this.session.mid}if(this.session.tag){i.tag=this.session.tag}if(this.session.time){i.time=this.session.time}i.revision=n;return t+"?"+L.buildQueryString(i)};E.prototype.getPublicationPath=function(){var e=this.isSecure?this.config.server.publish_secure:this.config.server.publish;if(!e){return""}var t=[];for(var n in this.config.channels){if(!this.config.channels.hasOwnProperty(n)){continue}t.push(this.config.channels[n].id)}var o={CHANNEL_ID:t.join("/")};return e+"?"+L.buildQueryString(o)};E.prototype.getConnectionAttemptDelay=function(e){var t;if(e<1){t=.5}else if(e<3){t=15}else if(e<5){t=45}else if(e<10){t=600}else{t=3600}return t+t*Math.random()*.2};E.prototype.sendPullStatus=function(t){if(this.unloading){return}if(typeof e.onCustomEvent!=="undefined"){e.onCustomEvent(window,"onPullStatus",[t])}this.emit({type:f.Status,data:{status:t}})};E.prototype.extendWatch=function(e,t){if(!e||this.watchTagsQueue[e]){return false}this.watchTagsQueue[e]=true;if(t){this.updateWatch(t)}};E.prototype.updateWatch=function(e){clearTimeout(this.watchUpdateTimeout);this.watchUpdateTimeout=setTimeout(function(){var e=Object.keys(this.watchTagsQueue);if(e.length>0){this.restClient.callMethod("pull.watch.extend",{tags:e}).then(function(e){var t=e.data();for(var n in t){if(t.hasOwnProperty(n)&&!t[n]){this.clearWatch(n)}}this.updateWatch()}.bind(this)).catch(function(){this.updateWatch()}.bind(this))}else{this.updateWatch()}}.bind(this),e?this.watchForceUpdateInterval:this.watchUpdateInterval)};E.prototype.clearWatch=function(e){delete this.watchTagsQueue[e]};E.prototype.setPrivateVar=function(){};E.prototype.returnPrivateVar=function(){};E.prototype.expireConfig=function(){};E.prototype.updateChannelID=function(){};E.prototype.tryConnect=function(){};E.prototype.tryConnectDelay=function(){};E.prototype.tryConnectSet=function(){};E.prototype.updateState=function(){};E.prototype.setUpdateStateStepCount=function(){};E.prototype.supportWebSocket=function(){return this.isWebSocketSupported()};E.prototype.isWebSoketConnected=function(){return this.isConnected()&&this.connectionType==u.WebSocket};E.prototype.getPullServerStatus=function(){return this.isConnected()};E.prototype.closeConfirm=function(){if(this.notificationPopup){this.notificationPopup.destroy()}};var C=function(e){e=e||{};this.storage=e.storage||new R;this.ttl=24*60*60;this.lsKeys={websocketBlocked:"bx-pull-websocket-blocked"};this.callbacks={onWebSocketBlockChanged:L.isFunction(e.onWebSocketBlockChanged)?e.onWebSocketBlockChanged:function(){}};window.addEventListener("storage",this.onLocalStorageSet.bind(this))};C.prototype.onLocalStorageSet=function(e){if(this.storage.compareKey(e.key,this.lsKeys.websocketBlocked)&&e.newValue!=e.oldValue){this.callbacks.onWebSocketBlockChanged({isWebSocketBlocked:this.isWebSocketBlocked()})}};C.prototype.isWebSocketBlocked=function(){return this.storage.get(this.lsKeys.websocketBlocked,0)>L.getTimestamp()};C.prototype.setWebSocketBlocked=function(e){this.storage.set(this.lsKeys.websocketBlocked,e?L.getTimestamp()+this.ttl:0)};var I=function(e,t){var n=function(){};n.prototype=t.prototype;e.prototype=new n;e.prototype.constructor=e;e.superclass=t.prototype;if(t.prototype.constructor==Object.prototype.constructor){t.prototype.constructor=t}};var w=function(e){this.parent=e.parent;this.callbacks={onOpen:L.isFunction(e.onOpen)?e.onOpen:function(){},onDisconnect:L.isFunction(e.onDisconnect)?e.onDisconnect:function(){},onError:L.isFunction(e.onError)?e.onError:function(){},onMessage:L.isFunction(e.onMessage)?e.onMessage:function(){}};this._connected=false;this.connectionType="";this.disconnectCode="";this.disconnectReason="";Object.defineProperty(this,"connected",{get:function(){return this._connected},set:function(e){if(e==this._connected)return;this._connected=e;if(this._connected){this.callbacks.onOpen()}else{this.callbacks.onDisconnect({code:this.disconnectCode,reason:this.disconnectReason})}}});Object.defineProperty(this,"path",{get:function(){return this.parent.getConnectionPath(this.connectionType)}})};var P=function(e){P.superclass.constructor.apply(this,arguments);this.connectionType=u.WebSocket;this.socket=null;this.onSocketOpenHandler=this.onSocketOpen.bind(this);this.onSocketCloseHandler=this.onSocketClose.bind(this);this.onSocketErrorHandler=this.onSocketError.bind(this);this.onSocketMessageHandler=this.onSocketMessage.bind(this)};I(P,w);P.prototype.connect=function(){if(this.socket){if(this.socket.readyState===1){return true}else{this.socket.removeEventListener("open",this.onSocketOpenHandler);this.socket.removeEventListener("close",this.onSocketCloseHandler);this.socket.removeEventListener("error",this.onSocketErrorHandler);this.socket.removeEventListener("message",this.onSocketMessageHandler);this.socket.close();this.socket=null}}this.createSocket()};P.prototype.disconnect=function(e,t){if(this.socket!==null){this.socket.removeEventListener("open",this.onSocketOpenHandler);this.socket.removeEventListener("close",this.onSocketCloseHandler);this.socket.removeEventListener("error",this.onSocketErrorHandler);this.socket.removeEventListener("message",this.onSocketMessageHandler);this.socket.close(e,t)}this.socket=null;this.disconnectCode=e;this.disconnectReason=t;this.connected=false};P.prototype.createSocket=function(){if(this.socket){throw new Error("Socket already exists")}if(!this.path){throw new Error("Websocket connection path is not defined")}this.socket=new WebSocket(this.path);this.socket.binaryType="arraybuffer";this.socket.addEventListener("open",this.onSocketOpenHandler);this.socket.addEventListener("close",this.onSocketCloseHandler);this.socket.addEventListener("error",this.onSocketErrorHandler);this.socket.addEventListener("message",this.onSocketMessageHandler)};P.prototype.send=function(e){if(!this.socket||this.socket.readyState!==1){console.error(L.getDateForLog()+": Pull: WebSocket is not connected");return false}this.socket.send(e)};P.prototype.onSocketOpen=function(){this.connected=true};P.prototype.onSocketClose=function(e){this.socket=null;this.disconnectCode=e.code;this.disconnectReason=e.reason;this.connected=false};P.prototype.onSocketError=function(e){this.callbacks.onError(e)};P.prototype.onSocketMessage=function(e){this.callbacks.onMessage(e.data)};P.prototype.destroy=function(){if(this.socket){this.socket.close();this.socket=null}};var T=function(e){T.superclass.constructor.apply(this,arguments);this.active=false;this.connectionType=u.LongPolling;this.requestTimeout=null;this.failureTimeout=null;this.xhr=this.createXhr();this.requestAborted=false};I(T,w);T.prototype.createXhr=function(){var e=new XMLHttpRequest;if(this.parent.isProtobufSupported()){e.responseType="arraybuffer"}e.addEventListener("readystatechange",this.onXhrReadyStateChange.bind(this));return e};T.prototype.connect=function(){this.active=true;this.performRequest()};T.prototype.disconnect=function(e,t){this.active=false;if(this.failureTimeout){clearTimeout(this.failureTimeout);this.failureTimeout=null}if(this.requestTimeout){clearTimeout(this.requestTimeout);this.requestTimeout=null}if(this.xhr){this.requestAborted=true;this.xhr.abort()}this.disconnectCode=e;this.disconnectReason=t;this.connected=false};T.prototype.performRequest=function(){var e=this;if(!this.active)return;if(!this.path){throw new Error("Long polling connection path is not defined")}if(this.xhr.readyState!==0&&this.xhr.readyState!==4){return}clearTimeout(this.failureTimeout);clearTimeout(this.requestTimeout);this.failureTimeout=setTimeout(function(){e.connected=true},5e3);this.requestTimeout=setTimeout(this.onRequestTimeout.bind(this),o*1e3);this.xhr.open("GET",this.path);this.xhr.send()};T.prototype.onRequestTimeout=function(){this.requestAborted=true;this.xhr.abort();this.performRequest()};T.prototype.onXhrReadyStateChange=function(e){if(this.xhr.readyState===4){if(!this.requestAborted||this.xhr.status==200){this.onResponse(this.xhr.response)}this.requestAborted=false}};T.prototype.send=function(e){var t=this.parent.getPublicationPath();if(!t){console.error(L.getDateForLog()+": Pull: publication path is empty");return false}var n=new XMLHttpRequest;n.open("POST",t);n.send(e)};T.prototype.onResponse=function(e){if(this.failureTimeout){clearTimeout(this.failureTimeout);this.failureTimeout=0}if(this.requestTimeout){clearTimeout(this.requestTimeout);this.requestTimeout=0}if(this.xhr.status==200){this.connected=true;if(L.isNotEmptyString(e)||e instanceof ArrayBuffer){this.callbacks.onMessage(e)}else{this.parent.session.mid=null}this.performRequest()}else if(this.xhr.status==304){this.connected=true;if(this.xhr.getResponseHeader("Expires")==="Thu, 01 Jan 1973 11:11:01 GMT"){var t=this.xhr.getResponseHeader("Last-Message-Id");if(L.isNotEmptyString(t)){this.parent.setLastMessageId(t)}}this.performRequest()}else{this.callbacks.onError("Could not connect to the server");this.connected=false}};var _=function(t){this.publicIds={};this.restClient=typeof t.restClient!=="undefined"?t.restClient:e.rest};_.prototype.getPublicIds=function(t){var n=new e.Promise;var o={};var i=new Date;var s=[];for(var r=0;r<t.length;r++){var c=t[r];if(this.publicIds[c]&&this.publicIds[c]["end"]>i){o[c]=this.publicIds[c]}else{s.push(c)}}if(s.length===0){n.resolve(o);return n}this.restClient.callMethod("pull.channel.public.list",{users:s}).then(function(e){var t=e.data();this.setPublicIds(L.objectValues(t));s.forEach(function(t){e[t]=this.publicIds[t]},this);n.resolve(e)}.bind(this));return n};_.prototype.setPublicIds=function(e){for(var t=0;t<e.length;t++){var n=e[t];var o=n.user_id;this.publicIds[o]={userId:o,publicId:n.public_id,signature:n.signature,start:new Date(n.start),end:new Date(n.end)}}};var R=function(t){t=t||{};this.userId=t.userId?t.userId:typeof e.message!=="undefined"&&e.message.USER_ID?e.message.USER_ID:0;this.siteId=t.siteId?t.siteId:typeof e.message!=="undefined"&&e.message.SITE_ID?e.message.SITE_ID:"none"};R.prototype.set=function(e,t){if(typeof window.localStorage==="undefined"){return false}if(typeof t!="string"){if(t){t=JSON.stringify(t)}}return window.localStorage.setItem(this.getKey(e),t)};R.prototype.get=function(e,t){if(typeof window.localStorage==="undefined"){return t||null}var n=window.localStorage.getItem(this.getKey(e));if(n===null){return t||null}return JSON.parse(n)};R.prototype.remove=function(e){if(typeof window.localStorage==="undefined"){return false}return window.localStorage.removeItem(this.getKey(e))};R.prototype.getKey=function(e){return"bx-pull-"+this.userId+"-"+this.siteId+"-"+e};R.prototype.compareKey=function(e,t){return e===this.getKey(t)};var L={browser:{IsChrome:function(){return navigator.userAgent.toLowerCase().indexOf("chrome")!=-1},IsFirefox:function(){return navigator.userAgent.toLowerCase().indexOf("firefox")!=-1},IsIe:function(){return navigator.userAgent.match(/(Trident\/|MSIE\/)/)!==null}},getTimestamp:function(){return(new Date).getTime()},errorsToString:function(e){if(!this.isArray(e)){return""}else{return e.reduce(function(e,t){if(e!=""){e+="; "}return e+t.code+": "+t.message},"")}},isString:function(e){return e===""?true:e?typeof e=="string"||e instanceof String:false},isArray:function(e){return e&&Object.prototype.toString.call(e)=="[object Array]"},isFunction:function(e){return e===null?false:typeof e=="function"||e instanceof Function},isDomNode:function(e){return e&&typeof e=="object"&&"nodeType"in e},isDate:function(e){return e&&Object.prototype.toString.call(e)=="[object Date]"},isPlainObject:function(e){if(!e||typeof e!=="object"||e.nodeType){return false}var t=Object.prototype.hasOwnProperty;try{if(e.constructor&&!t.call(e,"constructor")&&!t.call(e.constructor.prototype,"isPrototypeOf")){return false}}catch(e){return false}var n;for(n in e){}return typeof n==="undefined"||t.call(e,n)},isNotEmptyString:function(e){return this.isString(e)?e.length>0:false},buildQueryString:function(e){var t="";for(var n in e){if(!e.hasOwnProperty(n)){continue}var o=e[n];if(L.isArray(o)){o.forEach(function(e,o){t+=encodeURIComponent(n+"["+o+"]")+"="+encodeURIComponent(e)+"&"})}else{t+=encodeURIComponent(n)+"="+encodeURIComponent(o)+"&"}}if(t.length>0){t=t.substr(0,t.length-1)}return t},objectValues:function e(t){var n=[];for(var o in t){if(t.hasOwnProperty(o)&&t.propertyIsEnumerable(o)){n.push(t[o])}}return n},clone:function(e,t){var n,o,i;if(t!==false)t=true;if(e===null)return null;if(this.isDomNode(e)){n=e.cloneNode(t)}else if(typeof e=="object"){if(this.isArray(e)){n=[];for(o=0,i=e.length;o<i;o++){if(typeof e[o]=="object"&&t)n[o]=this.clone(e[o],t);else n[o]=e[o]}}else{n={};if(e.constructor){if(this.isDate(e))n=new Date(e);else n=new e.constructor}for(o in e){if(!e.hasOwnProperty(o)){continue}if(typeof e[o]=="object"&&t)n[o]=this.clone(e[o],t);else n[o]=e[o]}}}else{n=e}return n},getDateForLog:function(){var e=new Date;return e.getFullYear()+"-"+L.lpad(e.getMonth(),2,"0")+"-"+L.lpad(e.getDate(),2,"0")+" "+L.lpad(e.getHours(),2,"0")+":"+L.lpad(e.getMinutes(),2,"0")},lpad:function(e,t,n){e=e.toString();n=n||" ";if(e.length>t){return e}var o="";for(var i=0;i<t-e.length;i++){o+=n}return o+e}};if(typeof e.namespace!=="undefined"&&typeof e.PULL==="undefined"){e.PULL=new E}e.PullClient=E;e.PullClient.PullStatus=l;e.PullClient.SubscriptionType=f;e.PullClient.CloseReasons=d})();
/* End */
;
//# sourceMappingURL=kernel_im.map.js